"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1],[,function(e,t){function i(e,t){s(e,t),t.add(e)}function n(e,t,i){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t,i){s(e,t),t.set(e,i)}function s(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function o(e,t){return e.get(l(e,t))}function a(e,t,i){return e.set(l(e,t),i),i}function l(e,t,i){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:i;throw new TypeError("Private element is not present on this object")}t.isMOBI=t.MOBI=void 0;const c=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},u={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},h={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},d={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},f={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},g={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},p={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},m={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},w={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},b={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},v={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},y={magic:[0,4,"string"],numEntries:[8,4,"uint"]},M={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},x={1252:"windows-1252",65001:"utf-8"},R={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},k={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},S=(e,t)=>{const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},A=(e,t,i)=>{const n=new e.constructor(e.length+t.length+i.length);return n.set(e),n.set(t,e.length),n.set(i,e.length+t.length),n},T=new TextDecoder,E=e=>T.decode(e),L=e=>{if(!e)return;const t=e.byteLength,i=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[i](0)},C=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map((e=>{let[i,[n,r,s]]=e;return[i,("string"===s?E:L)(t.slice(n,n+r))]}))),I=e=>new TextDecoder(x[e]),U=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0,n=0;for(const r of e.subarray(t,t+4))if(i=i<<7|(127&r)>>>0,n++,128&r)break;return{value:i,length:n}},B=e=>{let t=0;for(const i of e.subarray(-4))128&i&&(t=0),t=t<<7|127&i;return t},O=e=>{let t=0;for(;e>0;e>>=1)1&~e||t++;return t},F=e=>{let t=0;for(;!(1&e);)e>>=1,t++;return t},W=e=>{let t=[];for(let i=0;i<e.length;i++){const n=e[i];if(0===n)t.push(0);else if(n<=8)for(const r of e.subarray(i+1,(i+=n)+1))t.push(r);else if(n<=127)t.push(n);else if(n<=191){const r=n<<8|e[1+i++],s=(16383&r)>>>3,o=3+(7&r);for(let e=0;e<o;e++)t.push(t[t.length-s])}else t.push(32,128^n)}return Uint8Array.from(t)},D=(e,t)=>{const i=t+32,n=i>>3;let r=0n;for(let i=t>>3;i<=n;i++)r=r<<8n|BigInt(e[i]??0);return r>>8n-BigInt(7&i)&0xffffffffn},z=async(e,t)=>{const i=await t(e),n=C(m,i);if("INDX"!==n.magic)throw new Error("Invalid INDX record");const r=I(n.encoding),s=i.slice(n.length),o=C(w,s);if("TAGX"!==o.magic)throw new Error("Invalid TAGX section");const a=(o.length-12)/4,l=Array.from({length:a},((e,t)=>new Uint8Array(s.slice(12+4*t,12+4*t+4)))),c={};let u=0;for(let i=0;i<n.numCncx;i++){const s=await t(e+n.numRecords+i+1),o=new Uint8Array(s);for(let e=0;e<o.byteLength;){const t=e,{value:i,length:n}=U(o,e);e+=n;const a=s.slice(e,e+i);e+=i,c[u+t]=r.decode(a)}u+=65536}const h=[];for(let i=0;i<n.numRecords;i++){const n=await t(e+1+i),r=new Uint8Array(n),s=C(m,n);if("INDX"!==s.magic)throw new Error("Invalid INDX record");for(let e=0;e<s.numRecords;e++){const t=s.idxt+4+2*e,i=L(n.slice(t,t+2)),a=L(n.slice(i,i+1)),c=E(n.slice(i+1,i+1+a)),u=[],d=i+1+a;let f=0,g=d+o.numControlBytes;for(const[e,t,i,s]of l){if(1&s){f++;continue}const o=d+f,a=L(n.slice(o,o+1))&i;if(a===i)if(O(i)>1){const{value:i,length:n}=U(r,g);u.push([e,null,i,t]),g+=n}else u.push([e,1,null,t]);else u.push([e,a>>F(i),null,t])}const p={};for(const[e,t,i,n]of u){const s=[];if(null!=t)for(let e=0;e<t*n;e++){const{value:e,length:t}=U(r,g);s.push(e),g+=t}else{let e=0;for(;e<i;){const{value:t,length:i}=U(r,g);s.push(t),g+=i,e+=i}}p[e]=s}h.push({name:c,tagMap:p})}}return{table:h,cncx:c}};t.isMOBI=async e=>"BOOKMOBI"===E(await e.slice(60,68).arrayBuffer());var H=new WeakMap,N=new WeakMap;class j{constructor(){r(this,H,void 0),r(this,N,void 0),n(this,"pdb",void 0)}async open(e){a(H,this,e);const t=C(h,await e.slice(0,78).arrayBuffer());this.pdb=t;const i=await e.slice(78,78+8*t.numRecords).arrayBuffer();a(N,this,Array.from({length:t.numRecords},((e,t)=>L(i.slice(8*t,8*t+4)))).map(((e,t,i)=>[e,i[t+1]])))}loadRecord(e){const t=o(N,this)[e];if(!t)throw new RangeError("Record index out of bounds");return o(H,this).slice(...t).arrayBuffer()}async loadMagic(e){const t=o(N,this)[e][0];return E(await o(H,this).slice(t,t+4).arrayBuffer())}}var X=new WeakMap,G=new WeakMap,P=new WeakMap,q=new WeakMap,$=new WeakMap,V=new WeakMap,Z=new WeakSet;function Y(e){const t=C(d,e),i=C(f,e);if("MOBI"!==i.magic)throw new Error("Missing MOBI header");const{titleOffset:n,titleLength:r,localeLanguage:s,localeRegion:o}=i;i.title=e.slice(n,n+r);const a=k[s];i.language=(null==a?void 0:a[o>>2])??(null==a?void 0:a[0]);const l=64&i.exthFlag?((e,t)=>{const{magic:i,count:n}=C(p,e);if("EXTH"!==i)throw new Error("Invalid EXTH header");const r=I(t),s={};let o=12;for(let t=0;t<n;t++){const t=L(e.slice(o,o+4)),i=L(e.slice(o+4,o+8));if(t in R){const[n,a,l]=R[t],c=e.slice(o+8,o+i),u="uint"===a?L(c):r.decode(c);l?(s[n]??(s[n]=[]),s[n].push(u)):s[n]=u}o+=i}return s})(e.slice(i.length+16),i.encoding):null;return{palmdoc:t,mobi:i,exth:l,kf8:i.version>=8?C(g,e):null}}async function K(){const{palmdoc:e,mobi:t}=this.headers;a(P,this,I(t.encoding)),a(q,this,new TextEncoder);const{compression:i}=e;if(a($,this,1===i?e=>e:2===i?W:17480===i?await(async(e,t)=>{const i=await t(e.huffcdic),{magic:n,offset1:r,offset2:s}=C(b,i);if("HUFF"!==n)throw new Error("Invalid HUFF record");const o=Array.from({length:256},((e,t)=>r+4*t)).map((e=>L(i.slice(e,e+4)))).map((e=>[128&e,31&e,e>>>8])),a=[null].concat(Array.from({length:32},((e,t)=>s+8*t)).map((e=>[L(i.slice(e,e+4)),L(i.slice(e+4,e+8))]))),l=[];for(let i=1;i<e.numHuffcdic;i++){const n=await t(e.huffcdic+i),r=C(v,n);if("CDIC"!==r.magic)throw new Error("Invalid CDIC record");const s=Math.min(1<<r.codeLength,r.numEntries-l.length),o=n.slice(r.length);for(let e=0;e<s;e++){const t=L(o.slice(2*e,2*e+2)),i=L(o.slice(t,t+2)),n=32767&i,r=32768&i,s=new Uint8Array(o.slice(t+2,t+2+n));l.push([s,r])}}const c=e=>{let t=new Uint8Array;const i=8*e.byteLength;for(let n=0;n<i;){const r=Number(D(e,n));let[s,u,h]=o[r>>>24];if(!s){for(;r>>>32-u<a[u][0];)u+=1;h=a[u][1]}if((n+=u)>i)break;const d=h-(r>>>32-u);let[f,g]=l[d];g||(f=c(f),l[d]=[f,!0]),t=S(t,f)}return t};return c})(t,this.loadRecord.bind(this)):null),!o($,this))throw new Error("Unknown compression type");const{trailingFlags:n}=t,r=1&n,s=O(n>>>1);a(V,this,(e=>{for(let t=0;t<s;t++){const t=B(e);e=e.subarray(0,-t)}if(r){const t=1+(3&e[e.length-1]);e=e.subarray(0,-t)}return e}))}t.MOBI=class extends j{constructor(e){let{unzlib:t}=e;super(),i(this,Z),r(this,X,0),r(this,G,void 0),r(this,P,void 0),r(this,q,void 0),r(this,$,void 0),r(this,V,void 0),this.unzlib=t}async open(e){await super.open(e),this.headers=l(Z,this,Y).call(this,await super.loadRecord(0)),a(G,this,this.headers.mobi.resourceStart);let t=this.headers.mobi.version>=8;if(!t){var i;const e=null===(i=this.headers.exth)||void 0===i?void 0:i.boundary;if(e<4294967295)try{this.headers=l(Z,this,Y).call(this,await super.loadRecord(e)),a(X,this,e),t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await l(Z,this,K).call(this),t?new Se(this).init():new se(this).init()}decode(){return o(P,this).decode(...arguments)}encode(){return o(q,this).encode(...arguments)}loadRecord(e){return super.loadRecord(o(X,this)+e)}loadMagic(e){return super.loadMagic(o(X,this)+e)}loadText(e){return this.loadRecord(e+1).then((e=>new Uint8Array(e))).then(o(V,this)).then(o($,this))}async loadResource(e){const t=await super.loadRecord(o(G,this)+e),i=E(t.slice(0,4));return"FONT"===i?(async(e,t)=>{const{flags:i,dataStart:n,keyLength:r,keyStart:s}=C(M,e),o=new Uint8Array(e.slice(n));if(2&i){const t=16===r?1024:1040,i=new Uint8Array(e.slice(s,s+r)),n=Math.min(t,o.length);for(var a=0;a<n;a++)o[a]=o[a]^i[a%i.length]}if(1&i)try{return await t(o)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return o})(t,this.unzlib):"VIDE"===i||"AUDI"===i?t.slice(12):t}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return(async(e,t)=>{const{table:i,cncx:n}=await z(e,t),r=i.map(((e,t)=>{var i,r,s,o,a,l;let{tagMap:c}=e;return{index:t,offset:null===(i=c[1])||void 0===i?void 0:i[0],size:null===(r=c[2])||void 0===r?void 0:r[0],label:n[c[3]]??"",headingLevel:null===(s=c[4])||void 0===s?void 0:s[0],pos:c[6],parent:null===(o=c[21])||void 0===o?void 0:o[0],firstChild:null===(a=c[22])||void 0===a?void 0:a[0],lastChild:null===(l=c[23])||void 0===l?void 0:l[0]}})),s=e=>(null==e.firstChild||(e.children=r.filter((t=>t.parent===e.index)).map(s)),e);return r.filter((e=>0===e.headingLevel)).map(s)})(e,this.loadRecord.bind(this))}getMetadata(){var e,t;const{mobi:i,exth:n}=this.headers;return{identifier:i.uid.toString(),title:c((null==n?void 0:n.title)||this.decode(i.title)),author:null==n||null===(e=n.creator)||void 0===e?void 0:e.map(c),publisher:c(null==n?void 0:n.publisher),language:(null==n?void 0:n.language)??i.language,published:null==n?void 0:n.date,description:c(null==n?void 0:n.description),subject:null==n||null===(t=n.subject)||void 0===t?void 0:t.map(c),rights:c(null==n?void 0:n.rights),contributor:null==n?void 0:n.contributor}}async getCover(){const{exth:e}=this.headers,t=(null==e?void 0:e.coverOffset)<4294967295?null==e?void 0:e.coverOffset:(null==e?void 0:e.thumbnailOffset)<4294967295?null==e?void 0:e.thumbnailOffset:null;if(null!=t){const e=await this.loadResource(t);return new Blob([e])}}};const J=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,Q=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;var _=new WeakMap,ee=new WeakMap,te=new WeakMap,ie=new WeakMap,ne=new WeakMap,re=new WeakMap;class se{constructor(e){n(this,"parser",new DOMParser),n(this,"serializer",new XMLSerializer),r(this,_,new Map),r(this,ee,new Map),r(this,te,new Map),r(this,ie,void 0),r(this,ne,[]),r(this,re,u.HTML),this.mobi=e}async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=S(e,await this.mobi.loadText(t));const t=Array.from(new Uint8Array(e),(e=>String.fromCharCode(e))).join("");a(ie,this,[0].concat(Array.from(t.matchAll(J),(e=>e.index))).map(((e,i,n)=>t.slice(e,n[i+1]))).map((e=>Uint8Array.from(e,(e=>e.charCodeAt(0))))).map((e=>({book:this,raw:e}))).reduce(((e,t)=>{const i=e[e.length-1];return t.start=(null==i?void 0:i.end)??0,t.end=t.start+t.raw.byteLength,e.concat(t)}),[])),this.sections=o(ie,this).map(((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start})));try{var i;this.landmarks=await this.getGuide();const e=null===(i=this.landmarks.find((e=>{let{type:t}=e;return null==t?void 0:t.includes("toc")})))||void 0===i?void 0:i.href;if(e){const{index:t}=this.resolveHref(e),i=await this.sections[t].createDocument();let n,r=0,s=0;const o=new Map,a=new Map;this.toc=Array.from(i.querySelectorAll("a[filepos]")).reduce(((e,t)=>{var i;const l=(e=>{let t=0;for(;e;){const i=e.parentElement;if(i){const e=i.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=i}return t})(t),c={label:(null===(i=t.innerText)||void 0===i?void 0:i.trim())??"",href:`filepos:${t.getAttribute("filepos")}`},u=l>s?r+1:l===s?r:o.get(l)??Math.max(0,r-1);if(u>r){var h;n?((h=n).subitems??(h.subitems=[]),n.subitems.push(c),a.set(u,n)):e.push(c)}else{const t=a.get(u);t?t.subitems.push(c):e.push(c)}return n=c,r=u,s=l,o.set(l,u),e}),[])}}catch(e){console.warn(e)}return a(ne,this,[...new Set(Array.from(t.matchAll(Q),(e=>e[1])))].map((e=>({filepos:e,number:Number(e)}))).sort(((e,t)=>e.number-t.number))),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(o(ie,this)[0]);return Array.from(e.getElementsByTagName("reference"),(e=>{var t;return{label:e.getAttribute("title"),type:null===(t=e.getAttribute("type"))||void 0===t?void 0:t.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}}))}async loadResource(e){if(o(_,this).has(e))return o(_,this).get(e);const t=await this.mobi.loadResource(e),i=URL.createObjectURL(new Blob([t]));return o(_,this).set(e,i),i}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const t of e.querySelectorAll("img[recindex]")){const e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch{console.warn(`Failed to load image ${e}`)}}for(const t of e.querySelectorAll("[mediarecindex]")){const e=t.getAttribute("mediarecindex"),i=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),i&&(t.poster=await this.loadRecindex(i))}catch{console.warn(`Failed to load media ${e}`)}}for(const t of e.querySelectorAll("[filepos]")){const e=t.getAttribute("filepos");t.href=`filepos:${e}`}}async loadText(e){if(o(ee,this).has(e))return o(ee,this).get(e);const{raw:t}=e,i=o(ne,this).filter((t=>{let{number:i}=t;return i>=e.start&&i<e.end})).map((t=>({...t,offset:t.number-e.start})));let n=t;i.length&&(n=t.subarray(0,i[0].offset),i.forEach(((e,r)=>{let{filepos:s,offset:o}=e;const a=i[r+1],l=this.mobi.encode(`<a id="filepos${s}"></a>`);n=A(n,l,t.subarray(o,null==a?void 0:a.offset))})));const r=this.mobi.decode(n).replaceAll(J,"");return o(ee,this).set(e,r),r}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,o(re,this))}async loadSection(e){if(o(te,this).has(e))return o(te,this).get(e);const t=await this.createDocument(e),i=t.createElement("style");t.head.append(i),i.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);const n=this.serializer.serializeToString(t),r=URL.createObjectURL(new Blob([n],{type:o(re,this)}));return o(te,this).set(e,r),r}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return{index:o(ie,this).findIndex((e=>e.end>i)),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return[o(ie,this).findIndex((e=>e.end>i)),`filepos${t}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of o(_,this).values())URL.revokeObjectURL(e);for(const e of o(te,this).values())URL.revokeObjectURL(e)}}const oe=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,ae=/kindle:pos:fid:(\w+):off:(\w+)/,le=e=>{const[t,i]=e.match(ae).slice(1);return{fid:parseInt(t,32),off:parseInt(i,32)}},ce=function(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return`kindle:pos:fid:${(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0).toString(32).toUpperCase().padStart(4,"0")}:off:${e.toString(32).toUpperCase().padStart(10,"0")}`},ue=e=>{const t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,i,n]=t;return`[${i}="${CSS.escape(n)}"]`},he=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};var de=new WeakMap,fe=new WeakMap,ge=new WeakMap,pe=new WeakMap,me=new WeakMap,we=new WeakMap,be=new WeakMap,ve=new WeakMap,ye=new WeakMap,Me=new WeakMap,xe=new WeakMap,Re=new WeakMap,ke=new WeakSet;class Se{constructor(e){i(this,ke),n(this,"parser",new DOMParser),n(this,"serializer",new XMLSerializer),r(this,de,new Map),r(this,fe,new Map),r(this,ge,new Map),r(this,pe,{}),r(this,me,void 0),r(this,we,void 0),r(this,be,new Uint8Array),r(this,ve,new Uint8Array),r(this,ye,-1),r(this,Me,-1),r(this,xe,u.XHTML),r(this,Re,new Map),this.mobi=e}async init(){var e,t,i;const n=this.mobi.loadRecord.bind(this.mobi),{kf8:r}=this.mobi.headers;try{const e=await n(r.fdst),t=C(y,e);if("FDST"!==t.magic)throw new Error("Missing FDST record");const i=Array.from({length:t.numEntries},((e,t)=>12+8*t)).map((t=>[L(e.slice(t,t+4)),L(e.slice(t+4,t+8))]));o(pe,this).fdstTable=i,a(we,this,i[i.length-1][1])}catch{}const s=(await z(r.skel,n)).table.map(((e,t)=>{let{name:i,tagMap:n}=e;return{index:t,name:i,numFrag:n[1][0],offset:n[6][0],length:n[6][1]}})),l=await z(r.frag,n),h=l.table.map((e=>{let{name:t,tagMap:i}=e;return{insertOffset:parseInt(t),selector:l.cncx[i[2][0]],index:i[4][0],offset:i[6][0],length:i[6][1]}}));o(pe,this).skelTable=s,o(pe,this).fragTable=h,a(me,this,s.reduce(((e,t)=>{const i=e[e.length-1],n=(null==i?void 0:i.fragEnd)??0,r=n+t.numFrag,s=h.slice(n,r),o=t.length+s.map((e=>e.length)).reduce(((e,t)=>e+t)),a=((null==i?void 0:i.totalLength)??0)+o;return e.concat({skel:t,frags:s,fragEnd:r,length:o,totalLength:a})}),[]));const d=await this.getResourcesByMagic(["RESC","PAGE"]),f=new Map;if(d.RESC){const e=await this.mobi.loadRecord(d.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),i=t.search(/\?>/),n=`<package>${t.slice(i)}</package>`,r=this.parser.parseFromString(n,u.XML);for(const e of r.querySelectorAll("spine > itemref")){var g;const t=parseInt(e.getAttribute("skelid"));f.set(t,he((null===(g=e.getAttribute("properties"))||void 0===g?void 0:g.split(" "))??[]))}}this.sections=o(me,this).map(((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:f.get(t)}:{linear:"no"}));try{const e=await this.mobi.getNCX(),t=e=>{let{label:i,pos:n,children:r}=e;const[s,a]=n,l=ce(s,a),u=o(fe,this).get(s);return u?u.push(a):o(fe,this).set(s,[a]),{label:c(i),href:l,subitems:null==r?void 0:r.map(t)}};this.toc=null==e?void 0:e.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const{exth:p}=this.mobi.headers;return this.dir=p.pageProgressionDirection,Object.fromEntries((null===(e=p.originalResolution)||void 0===e||null===(t=e.split("x"))||void 0===t||null===(i=t.slice(0,2))||void 0===i?void 0:i.map(((e,t)=>[t?"height":"width",e])))??[]),this.rendition={layout:"true"===p.fixedLayout?"pre-paginated":"reflowable",viewport:null},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){const t={},i=this.mobi.headers.kf8.resourceStart,n=this.mobi.pdb.numRecords;for(let r=i;r<n;r++)try{const i=await this.mobi.loadMagic(r),n=e.find((e=>e===i));n&&(t[n]=r)}catch{}return t}async getGuide(){const e=this.mobi.headers.kf8.guide;if(e<4294967295){const t=this.mobi.loadRecord.bind(this.mobi),{table:i,cncx:n}=await z(e,t);return i.map((e=>{var t,i;let{name:r,tagMap:s}=e;return{label:n[s[1][0]]??"",type:null==r?void 0:r.split(/\s/),href:ce((null===(t=s[6])||void 0===t?void 0:t[0])??(null===(i=s[3])||void 0===i?void 0:i[0]))}}))}}async loadResourceBlob(e){var t;const{resourceType:i,id:n,type:r}=(e=>{const[t,i,n]=e.match(oe).slice(1);return{resourceType:t,id:parseInt(i,32),type:n}})(e),s="flow"===i?await this.loadFlow(n):await this.mobi.loadResource(n-1),o=[u.XHTML,u.HTML,u.CSS,u.SVG].includes(r)?await this.replaceResources(this.mobi.decode(s)):s,a=r===u.SVG?this.parser.parseFromString(o,r):null;return[new Blob([o],{type:r}),null!=a&&null!==(t=a.getElementsByTagNameNS("http://www.w3.org/2000/svg","image"))&&void 0!==t&&t.length?a.documentElement:null]}async loadResource(e){if(o(de,this).has(e))return o(de,this).get(e);const[t,i]=await this.loadResourceBlob(e),n=i?e:URL.createObjectURL(t);return i&&o(Re,this).set(n,i),o(de,this).set(e,n),n}async replaceResources(e){return(async(e,t,i)=>{const n=[];e.replace(t,(function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return n.push(t),null}));const r=[];for(const e of n)r.push(await i(...e));return e.replace(t,(()=>r.shift()))})(e,new RegExp(oe,"g"),this.loadResource.bind(this))}async loadRaw(e,t){const i=t-o(be,this).length,n=null==o(we,this)?1/0:o(we,this)-o(ve,this).length-e;if(i<0||i<n){for(;o(be,this).length<t;){var r;const e=a(ye,this,(r=o(ye,this),++r)),t=await this.mobi.loadText(e);a(be,this,S(o(be,this),t))}return o(be,this).slice(e,t)}for(;o(we,this)-o(ve,this).length>e;){var s;const e=this.mobi.headers.palmdoc.numTextRecords-1-a(Me,this,(s=o(Me,this),++s)),t=await this.mobi.loadText(e);a(ve,this,S(t,o(ve,this)))}const l=o(we,this)-o(ve,this).length;return o(ve,this).slice(e-l,t-l)}loadFlow(e){if(e<4294967295)return this.loadRaw(...o(pe,this).fdstTable[e])}async loadText(e){const{skel:t,frags:i,length:n}=e,r=await this.loadRaw(t.offset,t.offset+n);let s=r.slice(0,t.length);for(const e of i){const i=e.insertOffset-t.offset,n=t.length+e.offset,a=r.slice(n,n+e.length);s=A(s.slice(0,i),a,s.slice(i));const c=o(fe,this).get(e.index);if(c)for(const t of c){const i=this.mobi.decode(a).slice(t),n=ue(i);l(ke,this,Ae).call(this,e.index,t,n)}}return this.mobi.decode(s)}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,o(xe,this))}async loadSection(e){var t;if(o(de,this).has(e))return o(de,this).get(e);const i=await this.loadText(e),n=await this.replaceResources(i);let r=this.parser.parseFromString(n,o(xe,this));for(const e of r.querySelectorAll("img"))if(e.style.position="relative",e.style.objectFit="contain",e.style.maxWidth="98%",e.style.maxHeight="98%",e.parentNode){let t=e.parentNode;t.style.width="auto",t.style.height="auto"}!r.querySelector("parsererror")&&null!==(t=r.documentElement)&&void 0!==t&&t.namespaceURI||(a(xe,this,u.HTML),r=this.parser.parseFromString(n,o(xe,this)));for(const[e,t]of o(Re,this))for(const i of r.querySelectorAll(`img[src="${e}"]`))i.replaceWith(t);const s=URL.createObjectURL(new Blob([this.serializer.serializeToString(r)],{type:o(xe,this)}));return o(de,this).set(e,s),s}getIndexByFID(e){return o(me,this).findIndex((t=>t.frags.some((t=>t.index===e))))}async resolveHref(e){var t;const{fid:i,off:n}=le(e),r=this.getIndexByFID(i);if(r<0)return;const s=null===(t=o(ge,this).get(i))||void 0===t?void 0:t.get(n);if(s)return{index:r,anchor:e=>e.querySelector(s)};const{skel:a,frags:c}=o(me,this)[r],u=c.find((e=>e.index===i)),h=a.offset+a.length+u.offset,d=await this.loadRaw(h,h+u.length),f=this.mobi.decode(d).slice(n),g=ue(f);return l(ke,this,Ae).call(this,i,n,g),{index:r,anchor:e=>e.querySelector(g)}}splitTOCHref(e){const t=le(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,t){var i;let{fid:n,off:r}=t;const s=null===(i=o(ge,this).get(n))||void 0===i?void 0:i.get(r);return e.querySelector(s)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of o(de,this).values())URL.revokeObjectURL(e)}}function Ae(e,t,i){const n=o(ge,this).get(e);if(n)n.set(t,i);else{const n=new Map;o(ge,this).set(e,n),n.set(t,i)}}}]]);