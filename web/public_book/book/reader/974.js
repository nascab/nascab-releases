"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[974],{974:function(t,e,i){e.EPUB=void 0;var r=function(t){if("function"==typeof WeakMap){var e=new WeakMap;new WeakMap}return function(t){if(t&&t.__esModule)return t;var i,r,n={__proto__:null,default:t};if(null===t||"object"!=typeof t&&"function"!=typeof t)return n;if(i=e){if(i.has(t))return i.get(t);i.set(t,n)}for(const e in t)"default"!==e&&{}.hasOwnProperty.call(t,e)&&((r=(i=Object.defineProperty)&&Object.getOwnPropertyDescriptor(t,e))&&(r.get||r.set)?i(n,e,r):n[e]=t[e]);return n}(t)}(i(596));function n(t,e,i){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function s(t,e){o(t,e),e.add(t)}function a(t,e,i){o(t,e),e.set(t,i)}function o(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function l(t,e,i){return i(h(t,e))}function c(t,e,i){return t.set(h(t,e),i),i}function u(t,e){return t.get(h(t,e))}function h(t,e,i){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:i;throw new TypeError("Private element is not present on this object")}const d="http://www.idpf.org/2007/opf",p="http://www.idpf.org/2007/ops",f="http://purl.org/dc/elements/1.1/",m="http://www.w3.org/2001/04/xmlenc#",v="http://www.w3.org/1999/xlink",g={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},y=t=>t.toLowerCase().replace(/[-:](.)/g,((t,e)=>e.toUpperCase())),w=(t,e,i)=>i?i=>{var r,n;return null===(r=i.getAttribute(t))||void 0===r||null===(n=r.split(/\s/))||void 0===n?void 0:n.includes(e)}:"function"==typeof e?i=>e(i.getAttribute(t)):i=>i.getAttribute(t)===e,b=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return t=>t?Object.fromEntries(e.map((e=>[y(e),t.getAttribute(e)]))):null},S=t=>{return(e=null==t?void 0:t.textContent)?e.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"";var e},A=(t,e)=>{const i=t.lookupNamespaceURI(null)===e||t.lookupPrefix(e),r=i?(t,i)=>t=>t.namespaceURI===e&&t.localName===i:(t,e)=>t=>t.localName===e;return{$:(t,e)=>[...t.children].find(r(t,e)),$$:(t,e)=>[...t.children].filter(r(t,e)),$$$:i?(t,i)=>[...t.getElementsByTagNameNS(e,i)]:(t,e)=>[...t.getElementsByTagName(e)]}},k=(t,e)=>{try{if(e.includes(":"))return new URL(t,e);const i="https://invalid.invalid/",r=new URL(t,i+e);return r.search="",decodeURI(r.href.replace(i,""))}catch(e){return console.warn(e),t}},T=t=>/^(?!blob)\w+:/i.test(t),E=async(t,e,i)=>{const r=[];t.replace(e,(function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return r.push(e),null}));const n=[];for(const t of r)n.push(await i(...t));return t.replace(e,(()=>n.shift()))},x=t=>t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),L={attrs:["dir","xml:lang"]},M={name:"alternate-script",many:!0,...L,props:["file-as"]},I={many:!0,...L,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",M],setLegacyAttrs:(t,e)=>{var i;if(null===(i=t.role)||void 0===i||!i.length){const i=e.getAttributeNS(d,"role");i&&(t.role=[{value:i}])}t.fileAs??(t.fileAs=e.getAttributeNS(d,"file-as"))}},$=[{name:"title",many:!0,...L,props:["title-type","display-seq","file-as",M]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}],setLegacyAttrs:(t,e)=>{if(!t.identifierType){const i=e.getAttributeNS(d,"scheme");i&&(t.identifierType={value:i})}}},{name:"language",many:!0},{name:"creator",...I},{name:"contributor",...I},{name:"publisher",...L,props:["file-as",M]},{name:"description",...L,props:[M]},{name:"rights",...L,props:[M]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...L,props:["term","authority",M],setLegacyAttrs:(t,e)=>{t.term??(t.term=e.getAttributeNS(d,"term")),t.authority??(t.authority=e.getAttributeNS(d,"authority"))}},{name:"source",many:!0},{name:"belongs-to-collection",type:"meta",many:!0,...L,props:["collection-type","group-position","dcterms:identifier","file-as",M,{name:"belongs-to-collection",recursive:!0}]}],B=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>t;const{$:i,$$:r,$$$:n}=A(t,"http://www.w3.org/1999/xhtml"),s=(t,n)=>t?r(t,"li").map((t=>r=>{var n;const a=i(r,"a")??i(r,"span"),o=i(r,"ol"),l=(t=>t?decodeURI(e(t)):null)(null==a?void 0:a.getAttribute("href")),c={label:S(a)||(null==a?void 0:a.getAttribute("title")),href:l,subitems:s(o)};return t&&(c.type=null==a||null===(n=a.getAttributeNS(p,"type"))||void 0===n?void 0:n.split(/\s/)),c})(n)):null,a=(t,e)=>s(i(t,"ol"),e),o=n(t,"nav");let l=null,c=null,u=null,h=[];for(const t of o){var d;const e=(null===(d=t.getAttributeNS(p,"type"))||void 0===d?void 0:d.split(/\s/))??[];e.includes("toc")?l??(l=a(t)):e.includes("page-list")?c??(c=a(t)):e.includes("landmarks")?u??(u=a(t,!0)):h.push({label:S(t.firstElementChild),type:e,list:a(t)})}return{toc:l,pageList:c,landmarks:u,others:h}},N=t=>{if(!t)return;const e=t.split(":").map((t=>parseFloat(t)));if(3===e.length){const[t,i,r]=e;return 60*t*60+60*i+r}if(2===e.length){const[t,i]=e;return 60*t+i}const[i,r]=t.split(/(?=[^\d.])/);return parseFloat(i)*("h"===r?3600:"min"===r?60:"ms"===r?.001:1)};var R=new WeakMap,C=new WeakMap,U=new WeakMap,P=new WeakMap,O=new WeakMap,j=new WeakMap,H=new WeakMap,W=new WeakMap,F=new WeakSet;class D extends EventTarget{constructor(t,e){super(),s(this,F),a(this,R,void 0),a(this,C,void 0),a(this,U,void 0),a(this,P,void 0),a(this,O,void 0),a(this,j,void 0),a(this,H,1),a(this,W,1),this.book=t,this.loadXML=e}async start(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>!0;null===(e=u(j,this))||void 0===e||e.pause();const r=this.book.sections[t],n=null==r?void 0:r.id;if(!n)return;const{mediaOverlay:s}=r;if(!s)return this.start(t+1);c(U,this,t),await h(F,this,q).call(this,s);for(let t=0;t<u(R,this).length;t++){const{items:e}=u(R,this)[t];for(let r=0;r<e.length;r++)if(e[r].text.split("#")[0]===n&&i(e[r],r,e))return h(F,this,J).call(this,t,r).catch((t=>h(F,this,_).call(this,t)))}}pause(){var t;null===(t=u(j,this))||void 0===t||t.pause()}resume(){var t;null===(t=u(j,this))||void 0===t||t.play().catch((t=>h(F,this,_).call(this,t)))}prev(){u(O,this)>0?h(F,this,J).call(this,u(P,this),u(O,this)-1):u(P,this)>0?h(F,this,J).call(this,u(P,this)-1,u(R,this)[u(P,this)-1].items.length-1):u(U,this)>0&&this.start(u(U,this)-1,((t,e,i)=>e===i.length-1))}next(){h(F,this,J).call(this,u(P,this),u(O,this)+1)}setVolume(t){c(H,this,t),u(j,this)&&(u(j,this).volume=t)}setRate(t){c(W,this,t),u(j,this)&&(u(j,this).playbackRate=t)}}async function q(t){if(u(C,this)===t)return;const e=await this.loadXML(t.href),i=e=>e?k(e,t.href):null,{$:r,$$$:n}=A(e,"http://www.w3.org/ns/SMIL");c(P,this,-1),c(O,this,-1),c(R,this,n(e,"par").reduce(((t,e)=>{var n;const s=i(null===(n=r(e,"text"))||void 0===n?void 0:n.getAttribute("src")),a=r(e,"audio");if(!s||!a)return t;const o=i(a.getAttribute("src")),l=N(a.getAttribute("clipBegin")),c=N(a.getAttribute("clipEnd")),u=t.at(-1);return(null==u?void 0:u.src)===o?u.items.push({text:s,begin:l,end:c}):t.push({src:o,items:[{text:s,begin:l,end:c}]}),t}),[])),c(C,this,t)}function X(t){return u(R,t)[u(P,t)]}function z(t){var e,i;return null===(e=l(F,t,X))||void 0===e||null===(i=e.items)||void 0===i?void 0:i[u(O,t)]}function _(t){console.error(t),this.dispatchEvent(new CustomEvent("error",{detail:t}))}function V(){this.dispatchEvent(new CustomEvent("highlight",{detail:l(F,this,z)}))}function G(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:l(F,this,z)}))}async function J(t,e){var i;u(j,this)&&(u(j,this).pause(),URL.revokeObjectURL(u(j,this).src),c(j,this,null)),c(P,this,t),c(O,this,e);const r=null===(i=l(F,this,X))||void 0===i?void 0:i.src;if(!r||!l(F,this,z))return this.start(u(U,this)+1);const n=URL.createObjectURL(await this.book.loadBlob(r)),s=new Audio(n);c(j,this,s),s.addEventListener("timeupdate",(()=>{var t;if(s.paused)return;const e=s.currentTime,{items:i}=l(F,this,X);if(e>(null===(t=l(F,this,z))||void 0===t?void 0:t.end)&&(h(F,this,G).call(this),u(O,this)===i.length-1))return void h(F,this,J).call(this,u(P,this)+1,0).catch((t=>h(F,this,_).call(this,t)));const r=u(O,this);for(;(null===(a=i[u(O,this)+1])||void 0===a?void 0:a.begin)<=e;){var n,a;c(O,this,(n=u(O,this),++n))}u(O,this)!==r&&h(F,this,V).call(this)})),s.addEventListener("error",(()=>h(F,this,_).call(this,new Error(`Failed to load ${r}`)))),s.addEventListener("playing",(()=>h(F,this,V).call(this))),s.addEventListener("pause",(()=>h(F,this,G).call(this))),s.addEventListener("ended",(()=>{h(F,this,G).call(this),URL.revokeObjectURL(n),c(j,this,null),h(F,this,J).call(this,t+1,0).catch((t=>h(F,this,_).call(this,t)))})),s.addEventListener("canplaythrough",(()=>{s.currentTime=l(F,this,z).begin??0,s.volume=u(H,this),s.playbackRate=u(W,this),s.play().catch((t=>h(F,this,_).call(this,t)))}))}const K=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,Q=t=>S(t.getElementById(t.documentElement.getAttribute("unique-identifier"))??t.getElementsByTagNameNS(f,"identifier")[0]),Y=async(t,e,i)=>{const r=new Uint8Array(await i.slice(0,e).arrayBuffer());e=Math.min(e,r.length);for(var n=0;n<e;n++)r[n]=r[n]^t[n%t.length];return new Blob([r,i.slice(e)],{type:i.type})},Z=async t=>{const e=(new TextEncoder).encode(t),i=await globalThis.crypto.subtle.digest("SHA-1",e);return new Uint8Array(i)};var tt=new WeakMap,et=new WeakMap,it=new WeakMap;class rt{constructor(t){a(this,tt,new Map),a(this,et,new Map),a(this,it,void 0),c(it,this,t)}async init(t,e){if(!t)return;const i=Array.from(t.getElementsByTagNameNS(m,"EncryptedData"),(t=>{var e,i;return{algorithm:null===(e=t.getElementsByTagNameNS(m,"EncryptionMethod")[0])||void 0===e?void 0:e.getAttribute("Algorithm"),uri:null===(i=t.getElementsByTagNameNS(m,"CipherReference")[0])||void 0===i?void 0:i.getAttribute("URI")}}));for(const{algorithm:t,uri:r}of i){if(!u(et,this).has(t)){const i=u(it,this)[t];if(!i){console.warn("Unknown encryption algorithm");continue}const r=await i.key(e);u(et,this).set(t,(t=>i.decode(r,t)))}u(tt,this).set(r,t)}}getDecoder(t){return u(et,this).get(u(tt,this).get(t))??(t=>t)}}class nt{constructor(t){var e,i,n,s,a;let{opf:o,resolveHref:l}=t;this.opf=o;const{$:c,$$:u,$$$:h}=A(o,d),p=c(o.documentElement,"manifest"),f=c(o.documentElement,"spine"),m=u(f,"itemref");this.manifest=u(p,"item").map(b("href","id","media-type","properties","media-overlay")).map((t=>{var e;return t.href=l(t.href),t.properties=null===(e=t.properties)||void 0===e?void 0:e.split(/\s/),t})),this.spine=m.map(b("idref","id","linear","properties")).map((t=>{var e;return t.properties=null===(e=t.properties)||void 0===e?void 0:e.split(/\s/),t})),this.pageProgressionDirection=f.getAttribute("page-progression-direction"),this.navPath=null===(e=this.getItemByProperty("nav"))||void 0===e?void 0:e.href,this.ncxPath=null===(i=this.getItemByID(f.getAttribute("toc"))??this.manifest.find((t=>t.mediaType===g.NCX)))||void 0===i?void 0:i.href;const v=c(o.documentElement,"guide");v&&(this.guide=u(v,"reference").map(b("type","title","href")).map((t=>{let{type:e,title:i,href:r}=t;return{label:i,type:e.split(/\s/),href:l(r)}}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(null===(n=h(o,"meta").find(w("name","cover")))||void 0===n?void 0:n.getAttribute("content"))??this.getItemByHref(null===(s=this.guide)||void 0===s||null===(a=s.find((t=>t.type.includes("cover"))))||void 0===a?void 0:a.href),this.cfis=r.fromElements(m)}getItemByID(t){return this.manifest.find((e=>e.id===t))}getItemByHref(t){return this.manifest.find((e=>e.href===t))}getItemByProperty(t){return this.manifest.find((e=>{var i;return null===(i=e.properties)||void 0===i?void 0:i.includes(t)}))}resolveCFI(t){var e;const i=r.parse(t),n=(i.parent??i).shift();let s=r.toElement(this.opf,n);s&&"idref"!==s.nodeName&&(n.at(-1).id=null,s=r.toElement(this.opf,n));const a=null===(e=s)||void 0===e?void 0:e.getAttribute("idref");return{index:this.spine.findIndex((t=>t.idref===a)),anchor:t=>r.toRange(t,i)}}}var st=new WeakMap,at=new WeakMap,ot=new WeakMap;class lt{constructor(t){let{loadText:e,loadBlob:i,resources:r}=t;a(this,st,new Map),a(this,at,new Map),a(this,ot,new Map),n(this,"allowScript",!1),this.loadText=e,this.loadBlob=i,this.manifest=r.manifest,this.assets=r.manifest}createURL(t,e,i,r){if(!e)return"";const n=URL.createObjectURL(new Blob([e],{type:i}));if(u(st,this).set(t,n),u(ot,this).set(t,1),r){const e=u(at,this).get(r);e?e.push(t):u(at,this).set(r,[t])}return n}ref(t,e){const i=u(at,this).get(e);return null!=i&&i.includes(t)||(u(ot,this).set(t,u(ot,this).get(t)+1),i?i.push(t):u(at,this).set(e,[t])),u(st,this).get(t)}unref(t){if(!u(ot,this).has(t))return;const e=u(ot,this).get(t)-1;if(e<1){URL.revokeObjectURL(u(st,this).get(t)),u(st,this).delete(t),u(ot,this).delete(t);const e=u(at,this).get(t);if(e)for(;e.length;)this.unref(e.pop());u(at,this).delete(t)}else u(ot,this).set(t,e)}async loadItem(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!t)return null;const{href:i,mediaType:r}=t,n=g.JS.test(t.mediaType);if(n&&!this.allowScript)return null;const s=e.at(-1);return u(st,this).has(i)?this.ref(i,s):(n||[g.XHTML,g.HTML,g.CSS,g.SVG].includes(r))&&e.every((t=>t!==i))?this.loadReplaced(t,e):this.createURL(i,await this.loadBlob(i),r,s)}async loadHref(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(T(t))return t;const r=k(t,e),n=this.manifest.find((t=>t.href===r));return n?this.loadItem(n,i.concat(e)):t}async loadReplaced(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const{href:i,mediaType:r}=t,n=e.at(-1),s=await this.loadText(i);if(!s)return null;if([g.XHTML,g.HTML,g.SVG].includes(r)){var a;let l=(new DOMParser).parseFromString(s,r);var o;if(r!==g.XHTML||!l.querySelector("parsererror")&&null!==(a=l.documentElement)&&void 0!==a&&a.namespaceURI||(console.warn((null===(o=l.querySelector("parsererror"))||void 0===o?void 0:o.innerText)??"Invalid XHTML"),t.mediaType=g.HTML,l=(new DOMParser).parseFromString(s,t.mediaType)),[g.XHTML,g.SVG].includes(t.mediaType)){let t=l.firstChild;for(;t instanceof ProcessingInstruction;){if(t.data){const r=await E(t.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,((t,r,n,s)=>this.loadHref(n,i,e).then((t=>`${r}${t}${s}`))));t.replaceWith(l.createProcessingInstruction(t.target,r))}t=t.nextSibling}}const c=async(t,r)=>t.setAttribute(r,await this.loadHref(t.getAttribute(r),i,e));for(const t of l.querySelectorAll("link[href]"))await c(t,"href");for(const t of l.querySelectorAll("[src]"))await c(t,"src");for(const t of l.querySelectorAll("[poster]"))await c(t,"poster");for(const t of l.querySelectorAll("object[data]"))await c(t,"data");for(const t of l.querySelectorAll("[*|href]:not([href])"))t.setAttributeNS(v,"href",await this.loadHref(t.getAttributeNS(v,"href"),i,e));for(const t of l.querySelectorAll("style"))t.textContent&&(t.textContent=await this.replaceCSS(t.textContent,i,e));for(const t of l.querySelectorAll("[style]"))t.setAttribute("style",await this.replaceCSS(t.getAttribute("style"),i,e));const u=(new XMLSerializer).serializeToString(l);return this.createURL(i,u,t.mediaType,n)}const l=r===g.CSS?await this.replaceCSS(s,i,e):await this.replaceString(s,i,e);return this.createURL(i,l,r,n)}async replaceCSS(t,e){var i,r;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const s=await E(t,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,((t,i)=>this.loadHref(i,e,n).then((t=>`url("${t}")`)))),a=await E(s,/@import\s*["']([^"'\n]*?)["']/gi,((t,i)=>this.loadHref(i,e,n).then((t=>`@import "${t}"`)))),o=(null===(i=window)||void 0===i?void 0:i.innerWidth)??800,l=(null===(r=window)||void 0===r?void 0:r.innerHeight)??600;return a.replace(/(?<=[{\s;])-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,((t,e)=>parseFloat(e)*o/100+"px")).replace(/(\d*\.?\d+)vh/gi,((t,e)=>parseFloat(e)*l/100+"px")).replace(/page-break-(after|before|inside)\s*:/gi,((t,e)=>`-webkit-column-break-${e}:`)).replace(/break-(after|before|inside)\s*:\s*(avoid-)?page/gi,((t,e,i)=>`break-${e}: ${i??""}column`))}replaceString(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const r=new Map,n=this.assets.map((t=>{if(t.href===e)return;const i=((t,e)=>{if(!t)return e;const i=t.replace(/\/$/,"").split("/"),r=e.replace(/\/$/,"").split("/"),n=(i.length>r.length?i:r).findIndex(((t,e)=>i[e]!==r[e]));return n<0?"":Array(i.length-n).fill("..").concat(r.slice(n)).join("/")})((t=>t.slice(0,t.lastIndexOf("/")+1))(e),t.href),n=encodeURI(i),s="/"+t.href,a=encodeURI(s),o=new Set([i,n,s,a]);for(const e of o)r.set(e,t);return Array.from(o)})).flat().filter((t=>t));if(!n.length)return t;const s=new RegExp(n.map(x).join("|"),"g");return E(t,s,(async t=>this.loadItem(r.get(t.replace(/^\//,"")),i.concat(e))))}unloadItem(t){this.unref(null==t?void 0:t.href)}destroy(){for(const t of u(st,this).values())URL.revokeObjectURL(t)}}const ct=t=>{for(const e of t){if("page-spread-left"===e||"rendition:page-spread-left"===e)return"left";if("page-spread-right"===e||"rendition:page-spread-right"===e)return"right";if("rendition:page-spread-center"===e)return"center"}};var ut=new WeakMap,ht=new WeakMap,dt=new WeakSet;async function pt(t){const e=await this.loadText(t);if(!e)return null;const i=this.parser.parseFromString(e,g.XML);if(i.querySelector("parsererror"))throw new Error(`XML parsing error: ${t}${i.querySelector("parsererror").innerText}`);return i}e.EPUB=class{constructor(t){let{loadText:e,loadBlob:i,getSize:r,sha1:o}=t;s(this,dt),n(this,"parser",new DOMParser),a(this,ut,void 0),a(this,ht,void 0),this.loadText=e,this.loadBlob=i,this.getSize=r,c(ht,this,new rt(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Z;return{"http://www.idpf.org/2008/embedding":{key:e=>t(Q(e).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(t,e)=>Y(t,1040,e)},"http://ns.adobe.com/pdf/enc#RC":{key:t=>{const e=(t=>{for(const e of t.getElementsByTagNameNS(f,"identifier")){const[t]=S(e).split(":").slice(-1);if(K.test(t))return t}return""})(t).replaceAll("-","");return Uint8Array.from({length:16},((t,i)=>parseInt(e.slice(2*i,2*i+2),16)))},decode:(t,e)=>Y(t,1024,e)}}}(o)))}async init(){var t,e,i,r,n,s,a,o,l,p,m,v,g;const T=await h(dt,this,pt).call(this,"META-INF/container.xml");if(!T)throw new Error("Failed to load container file");const E=Array.from(T.getElementsByTagNameNS("urn:oasis:names:tc:opendocument:xmlns:container","rootfile"),b("full-path","media-type")).filter((t=>"application/oebps-package+xml"===t.mediaType));if(!E.length)throw new Error("No package document defined in container");const x=E[0].fullPath,L=await h(dt,this,pt).call(this,x);if(!L)throw new Error("Failed to load package document");const M=await h(dt,this,pt).call(this,"META-INF/encryption.xml");await u(ht,this).init(M,L),this.resources=new nt({opf:L,resolveHref:t=>k(t,x)}),c(ut,this,new lt({loadText:this.loadText,loadBlob:t=>Promise.resolve(this.loadBlob(t)).then(u(ht,this).getDecoder(t)),resources:this.resources})),this.sections=this.resources.spine.map(((t,e)=>{const{idref:i,linear:r,properties:n=[]}=t,s=this.resources.getItemByID(i);return s?{id:s.href,load:()=>u(ut,this).loadItem(s),unload:()=>u(ut,this).unloadItem(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[e],linear:r,pageSpread:ct(n),resolveHref:t=>k(t,s.href),mediaOverlay:s.mediaOverlay?this.resources.getItemByID(s.mediaOverlay):null}:(console.warn(`Could not find item with ID "${i}" in manifest`),null)})).filter((t=>t));const{navPath:I,ncxPath:R}=this.resources;if(I)try{const t=t=>k(t,I),e=B(await h(dt,this,pt).call(this,I),t);this.toc=e.toc,this.pageList=e.pageList,this.landmarks=e.landmarks}catch(t){console.warn(t)}if(!this.toc&&R)try{const t=t=>k(t,R),e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>t;const{$:i,$$:r}=A(t,"http://www.daisy.org/z3986/2005/ncx/"),n=t=>{const s=i(t,"navLabel"),a=i(t,"content"),o=S(s),l=(t=>t?decodeURI(e(t)):null)(a.getAttribute("src"));if("navPoint"===t.localName){const e=r(t,"navPoint");return{label:o,href:l,subitems:e.length?e.map(n):null}}return{label:o,href:l}},s=(t,e)=>r(t,e).map(n),a=(e,r)=>{const n=i(t.documentElement,e);return n?s(n,r):null};return{toc:a("navMap","navPoint"),pageList:a("pageList","pageTarget"),others:r(t.documentElement,"navList").map((t=>({label:S(i(t,"navLabel")),list:s(t,"navTarget")})))}}(await h(dt,this,pt).call(this,R),t);this.toc=e.toc,this.pageList=e.pageList}catch(t){console.warn(t)}this.landmarks??(this.landmarks=this.resources.guide);const{metadata:C,rendition:U,media:P}=(t=>{const{$:e,$$:i}=A(t,d),r=e(t.documentElement,"metadata"),n=Array.from(r.children),s=(t,e)=>{var i;if(!e)return null;const{props:r=[],attrs:a=[]}=t,o=S(e);if(!r.length&&!a.length)return o;const l=e.getAttribute("id"),c=l?n.filter(w("refines","#"+l)):[],u=Object.fromEntries([["value",o]].concat(r.map((e=>{const{many:i,recursive:r}=e,n="string"==typeof e?e:e.name,a=w("property",n),o=r?t:e;return[y(n),i?c.filter(a).map((t=>s(o,t))):s(o,c.find(a))]}))).concat(a.map((t=>[y(t),e.getAttribute(t)]))));return null===(i=t.setLegacyAttrs)||void 0===i||i.call(t,u,e),u},a=n.filter(w("refines",null)),o=Object.fromEntries($.map((t=>{const{type:e,name:i,many:r}=t,n="meta"===e?t=>t.namespaceURI===d&&t.getAttribute("property")===i:t=>t.namespaceURI===f&&t.localName===i;return[y(i),r?a.filter(n).map((e=>s(t,e))):s(t,a.find(n))]}))),l=i(r,"meta"),c=t=>l.filter(w("property",(e=>null==e?void 0:e.startsWith(t)))).map((e=>[e.getAttribute("property").replace(t,""),e])),u=Object.fromEntries(c("rendition:").map((t=>{let[e,i]=t;return[e,S(i)]}))),h={narrator:[],duration:{}};for(const[t,e]of c("media:")){var p,m;const i=S(e);"duration"===t?h.duration[(null===(p=e.getAttribute("refines"))||void 0===p||null===(m=p.split("#"))||void 0===m?void 0:m[1])??""]=N(i):"active-class"===t?h.activeClass=i:"narrator"===t?h.narrator.push(i):"playback-active-class"===t&&(h.playbackActiveClass=i)}return{metadata:o,rendition:u,media:h}})(L);this.rendition=U,this.media=P,this.dir=this.resources.pageProgressionDirection;const O=(j=await h(dt,this,pt).call(this,"META-INF/com.apple.ibooks.display-options.xml")??await h(dt,this,pt).call(this,"META-INF/com.kobobooks.display-options.xml"))?{fixedLayout:S(j.querySelector('option[name="fixed-layout"]')),openToSpread:S(j.querySelector('option[name="open-to-spread"]'))}:null;var j,H,W;O&&("true"===O.fixedLayout&&((H=this.rendition).layout??(H.layout="pre-paginated")),"false"===O.openToSpread&&((W=this.sections.find((t=>"no"!==t.linear))).pageSpread??(W.pageSpread="rtl"===this.dir?"left":"right"))),this.parsedMetadata=C;const F=null==C||null===(t=C.title)||void 0===t?void 0:t[0];this.metadata={title:null==F?void 0:F.value,subtitle:null==C||null===(e=C.title)||void 0===e||null===(i=e.find((t=>"subtitle"===t.titleType)))||void 0===i?void 0:i.value,sortAs:null==F?void 0:F.fileAs,language:null==C?void 0:C.language,identifier:Q(L),description:null==C||null===(r=C.description)||void 0===r?void 0:r.value,publisher:null==C||null===(n=C.publisher)||void 0===n?void 0:n.value,published:null==C?void 0:C.date,modified:null==C?void 0:C.dctermsModified,subject:null==C||null===(s=C.subject)||void 0===s||null===(a=s.filter((t=>{let{value:e,term:i}=t;return e||i})))||void 0===a?void 0:a.map((t=>{let{value:e,term:i,authority:r}=t;return{name:e,code:i,scheme:r}})),rights:null==C||null===(o=C.rights)||void 0===o?void 0:o.value};const D={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},q=t=>e=>{var i;const r=[...new Set(null===(i=e.role)||void 0===i?void 0:i.map((e=>{let{value:i,scheme:r}=e;return(r&&"marc:relators"!==r?null:D[i])??t})))],n={name:e.value,sortAs:e.fileAs};return[null!=r&&r.length?r:[t],n]};return null==C||null===(l=C.creator)||void 0===l||null===(p=l.map(q("author")))||void 0===p||null===(m=p.concat(null==C||null===(v=C.contributor)||void 0===v||null===(g=v.map)||void 0===g?void 0:g.call(v,q("contributor"))))||void 0===m||m.forEach((t=>{let[e,i]=t;return e.forEach((t=>{this.metadata[t]?this.metadata[t].push(i):this.metadata[t]=[i]}))})),this}async loadDocument(t){const e=await this.loadText(t.href);return this.parser.parseFromString(e,t.mediaType)}getMediaOverlay(){return new D(this,h(dt,this,pt).bind(this))}resolveCFI(t){return this.resources.resolveCFI(t)}resolveHref(t){const[e,i]=t.split("#"),r=this.resources.getItemByHref(decodeURI(e));return r?{index:this.resources.spine.findIndex((t=>{let{idref:e}=t;return e===r.id})),anchor:i?t=>((t,e)=>t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`))(t,i):()=>0}:null}splitTOCHref(t){return(null==t?void 0:t.split("#"))??[]}getTOCFragment(t,e){return t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`)}isExternal(t){return T(t)}async getCover(){var t;const e=null===(t=this.resources)||void 0===t?void 0:t.cover;return null!=e&&e.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const t=await this.loadText("META-INF/calibre_bookmarks.txt");if(null!=t&&t.startsWith("encoding=json+base64:")){const e=atob(t.slice(21));return JSON.parse(e)}}destroy(){var t;null===(t=u(ut,this))||void 0===t||t.destroy()}}}}]);