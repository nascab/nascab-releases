(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-314f3d12"],{"0bd4":function(e,t,o){o.r(t),o("d81d"),o("b0c0"),o("e9f5"),o("ab43"),o("d3b7");o("99af"),o("4e82"),o("e9c4"),o("e25e"),o("4d90");var r=o("e11e"),m=o.n(r),u=(o("6cc5"),o("be3b")),r=o("8fad"),r={name:"photoMap",props:{borderRadius:{default:"15px",type:String},albumId:{default:"",Type:String},libraryId:{default:"",Type:String},ordinaryAlbumId:{default:"",Type:String}},components:{albumDetail:r.default},data:function(){return{showAddServerModal:!1,newTileServer:{name:"",server:"",coordinate:"WGS-84",maxLevel:18},coordinateOptions:[{value:"WGS-84",label:"WGS-84"},{value:"GCJ-02",label:"GCJ-02"},{value:"BD-09",label:"BD-09"}],showSwitchMapModal:!1,tileServerList:[],currentTilesServer:"",albumFirstPhoto:null,showPhotoGeo:!1,map:null,markerGroup:null,clickGeohash:null,selectPositionStr:"",currentMaxZoom:8,moveTimer:null}},mounted:function(){this.getZoomInfo()},beforeDestroy:function(){},methods:{openAddServer:function(){this.newTileServer={name:"",server:"",coordinate:"WGS-84",maxLevel:18},this.showAddServerModal=!0},handleDeleteServer:function(e){var t=this;this.$Modal.confirm({title:this.$t("common.alert"),content:this.$t("common.deleteSure"),onOk:function(){t.api.post("/api/mapApi/deleteTileServer",{tileServerJson:JSON.stringify(e)}).then(function(e){e.code||(t.$Message.success(t.$t("common.operationSuccess")),t.goToSwitchMap())}).catch(function(e){console.error(e),t.$Message.error(t.$t("common.operationFail"))})}})},handleAddServer:function(){var t=this;!this.newTileServer.name||!this.newTileServer.server||!this.newTileServer.coordinate||this.newTileServer.maxLevel<2||18<this.newTileServer.maxLevel||this.api.post("/api/mapApi/addTileServer",{tileServerJson:JSON.stringify(this.newTileServer)}).then(function(e){e.code||(t.$Message.success(t.$t("common.operationSuccess")),t.showAddServerModal=!1,t.goToSwitchMap())}).catch(function(e){console.error(e),t.$Message.error(t.$t("common.operationFail"))})},goToSwitchMap:function(){var t=this;this.api.post("/api/mapApi/getTileServerList").then(function(e){!e.code&&e.tileServerList?(t.tileServerList=e.tileServerList.sort(function(e,t){return t.current-e.current}),t.showSwitchMapModal=!0):t.showVsNotification(t.$t("common.operationFail"))}).catch(function(e){console.error(e),t.showVsNotification(t.$t("common.operationFail"))})},switchMapApi:function(e){var t=this;this.$Modal.confirm({title:this.$t("common.alert"),content:this.$t("mapSwitchAlert"),onOk:function(){t.api.post("/api/mapApi/setTileServer",{tileServerJson:JSON.stringify(e)}).then(function(e){e.code||location.reload()}).catch(function(e){console.error(e),t.showVsNotification(t.$t("common.operationFail"))})}})},getZoomInfo:function(){var t=this;this.api.get("/api/mapApi/getZoom",{}).then(function(e){e.code||(t.currentMaxZoom=parseInt(e.zoomInfo.maxZoom),e.tileServer&&(t.currentTilesServer=e.tileServer),t.initMap(parseInt(e.zoomInfo.minZoom),parseInt(e.zoomInfo.maxZoom)))}).catch(function(e){})},initMap:function(e,t){var o=this,r=u.a.mapUrl(),r=new m.a.TileLayer(r,{minZoom:e=e<2?2:e,maxZoom:t,attribution:"NORMAL"}),e=(r.setZIndex(1),localStorage.getItem("map-center-lat")),t=localStorage.getItem("map-center-lng"),a=38.8225909761771,i=105.380859375,e=(e&&t&&(a=e,i=t),new m.a.LatLng(a,i)),t=m.a.latLng(-90,-360),a=m.a.latLng(90,360),i=m.a.latLngBounds(t,a);this.map=new m.a.Map("mainmap",{maxBounds:i,center:e,zoom:5,attributionControl:!1,layers:[r]}),this.albumId||this.ordinaryAlbumId||this.libraryId?this.getAlbumPhotoList():(this.map.on("moveend",function(t){o.moveTimer&&clearTimeout(o.moveTimer),o.moveTimer=setTimeout(function(){var e=o.map.getCenter();localStorage.setItem("map-center-lat",e.lat),localStorage.setItem("map-center-lng",e.lng),o.getHashBox(t)},600)}),this.map.zoomIn()),this.markerGroup=m.a.layerGroup().addTo(this.map)},onModalShow:function(e){if(e)for(var t=document.getElementsByClassName("ivu-modal-body"),o=0;o<t.length;o++)t[o]&&t[o].style&&(t[o].style.padding=0)},formatTimestampToYearMonth:function(e){var e=new Date(e),t=e.getFullYear(),e=String(e.getMonth()+1).padStart(2,"0");return"".concat(t,"/").concat(e)},dealPhotoMap:function(n,l){var s=this;this.markerGroup.clearLayers();var c,d,e;for(d in l)(()=>{var e,t=l[d],o=document.createElement("div"),r=(o.style="display:inline-block;position:relative; width: 100%;height: 100%; object-fit: cover;padding:2%",document.createElement("img"));if(r.src=u.a.getImgFullPath(t.id,!0),r.style="width: 100%;height: 100%; object-fit: cover",o.appendChild(r),(r=75<(r=9*n)?75:r)<35&&(r=35),t.original_time&&((e=document.createElement("p")).textContent=s.formatTimestampToYearMonth(t.original_time),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.right="0",e.style.fontSize="8px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.color="white",e.style.overflow="hidden",e.style.textAlign="center",o.appendChild(e)),c=m.a.divIcon({iconSize:[r,r],html:o}),0==t.latitude&&0==t.longitude)return;if("undefined"==t.latitude||"undefined"==t.longitude)return;s.albumFirstPhoto=t;try{var a=s.utils.transCoordinateForShow(s.currentTilesServer,t.longitude,t.latitude),i=m.a.marker([a[1],a[0]],{icon:c,indexId:t.id});i.on("click",function(e){s.api.post("/api/mapApi/getLocationStr",{indexId:t.id}).then(function(e){e.code||(s.selectPositionStr=e.geo.name+" "+e.geo.cn_name,s.clickGeohash=t.geohash,s.showPhotoGeo=!0,s.addModalToList(s.$refs.refModalPhotoAlbum))}).catch(function(e){})}),i.addTo(s.markerGroup)}catch(e){}})();(this.albumId||this.ordinaryAlbumId)&&this.albumFirstPhoto&&(e=new m.a.LatLng(this.albumFirstPhoto.latitude,this.albumFirstPhoto.longitude),this.map.flyTo(e))},getAlbumPhotoList:function(){var t=this,e={};this.albumId?e.albumId=this.albumId:this.ordinaryAlbumId?e.ordinaryAlbumId=this.ordinaryAlbumId:this.libraryId&&(e.libraryId=this.libraryId),this.api.post("/api/photoApi/getAlbumPhotoForMap",e).then(function(e){e.code||t.dealPhotoMap(2,e.mapPhoto)}).catch(function(e){t.showVsNotification(JSON.stringify(e))})},getHashBox:function(e){var t=this,o=(this.map._zoom,e.target._zoom),e=this.map.getBounds(),r=e._southWest,e=e._northEast,a=(r.lat<e.lat?r:e).lat,i=(r.lat<e.lat?e:r).lat,n=(r.lng<e.lng?r:e).lng,e=(r.lng<e.lng?e:r).lng;this.api.post("/api/photoApi/getBoundsPhoto",{hideLoading:!0,minLat:a,minLng:n,maxLat:i,maxLng:e,zoom:o}).then(function(e){e.code||t.dealPhotoMap(o,e.mapPhoto)}).catch(function(e){})}}},o=(o("7b06"),o("2877")),o=Object(o.a)(r,function(){var o=this,r=o._self._c;return r("div",{staticClass:"map-root"},[r("div",o.isMobile?{staticClass:"map-content",attrs:{id:"mainmap"}}:{staticClass:"map-content",style:{"border-top-left-radius":o.borderRadius,"border-top-right-radius":o.borderRadius},attrs:{id:"mainmap"}}),o.map&&o.map._zoom&&!o.ordinaryAlbumId&&!o.albumId?r("div",{staticClass:"zoom-title-root"},[r("a",{staticStyle:{"margin-right":"5px","font-size":"12px"},on:{click:function(e){return o.goToSwitchMap()}}},[o.currentTilesServer&&o.currentTilesServer.name?r("span",{staticStyle:{"margin-right":"5px"}},[o._v(o._s(o.currentTilesServer.name))]):o._e(),o._v(o._s(o.$t("switchMap")))]),r("p",{staticStyle:{"font-size":"12px"}},[o._v(" "+o._s(o.$t("map.currentZoomLevel",{zoom:Math.ceil(o.map._zoom)}))+" "),o.currentMaxZoom?r("span",{staticStyle:{"margin-left":"3px"}},[o._v("(2-"+o._s(o.currentMaxZoom)+")")]):o._e()])]):o._e(),r("Modal",{ref:"refModalPhotoAlbum",attrs:{"footer-hide":"",fullscreen:"",closable:!1},on:{"on-visible-change":o.onModalShow},model:{value:o.showPhotoGeo,callback:function(e){o.showPhotoGeo=e},expression:"showPhotoGeo"}},[o.showPhotoGeo?r("album-detail",{attrs:{propsNearMode:!0,propsShowSearchBtn:!1,propsTitle:o.selectPositionStr,propsGeoHash:o.clickGeohash},on:{onClose:function(e){return o.historyBack()}}}):o._e()],1),r("Modal",{attrs:{"footer-hide":""},scopedSlots:o._u([{key:"header",fn:function(){return[r("div",{staticClass:"ivu-modal-header-inner"},[o._v(o._s(o.$t("switchMap")))]),r("Button",{staticStyle:{position:"absolute",right:"40px",top:"8px"},attrs:{type:"primary",ghost:""},on:{click:o.openAddServer}},[o._v(" "+o._s(o.$t("addMapServer"))+" ")])]},proxy:!0}]),model:{value:o.showSwitchMapModal,callback:function(e){o.showSwitchMapModal=e},expression:"showSwitchMapModal"}},o._l(o.tileServerList,function(t,e){return r("div",{key:e,staticClass:"map-server-card ivu-card ivu-card-bordered"},[r("div",{staticClass:"ivu-card-body"},[r("h4",[o._v(o._s(o.$t("common.name"))+": "+o._s(t.name)),1==t.current?r("a",{staticStyle:{"margin-left":"5px"}},[o._v(o._s(o.$t("currentUsing")))]):o._e()]),1==t.isCustom?r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("tileServerUrl"))+": "+o._s(t.server))]):o._e(),r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("coordinate"))+": "+o._s(t.coordinate))]),r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("maxZoom"))+": "+o._s(t.maxLevel))]),r("Button",{attrs:{type:"primary",ghost:""},on:{click:function(e){return o.switchMapApi(t)}}},[o._v(" "+o._s(o.$t("switch"))+" ")]),1==t.isCustom?r("Button",{staticStyle:{"margin-left":"5px"},attrs:{type:"error",ghost:""},on:{click:function(e){return o.handleDeleteServer(t)}}},[o._v(" "+o._s(o.$t("common.delete"))+" ")]):o._e()],1)])}),0),r("Modal",{attrs:{title:o.$t("addMapServer")},model:{value:o.showAddServerModal,callback:function(e){o.showAddServerModal=e},expression:"showAddServerModal"}},[r("Form",{attrs:{model:o.newTileServer,"label-position":"top"}},[r("FormItem",{attrs:{label:o.$t("common.name"),prop:"name"}},[r("Input",{model:{value:o.newTileServer.name,callback:function(e){o.$set(o.newTileServer,"name",e)},expression:"newTileServer.name"}})],1),r("FormItem",{attrs:{label:o.$t("tileServerUrl")+"(http/https)",prop:"server"}},[r("Input",{attrs:{placeholder:"https://xxx.xxx/{z}/{y}/{x}/tile.png"},model:{value:o.newTileServer.server,callback:function(e){o.$set(o.newTileServer,"server",e)},expression:"newTileServer.server"}})],1),r("FormItem",{attrs:{label:o.$t("coordinate"),prop:"coordinate"}},[r("Select",{model:{value:o.newTileServer.coordinate,callback:function(e){o.$set(o.newTileServer,"coordinate",e)},expression:"newTileServer.coordinate"}},o._l(o.coordinateOptions,function(e){return r("Option",{key:e.value,attrs:{value:e.value}},[o._v(o._s(e.label))])}),1)],1),r("FormItem",{attrs:{label:o.$t("maxZoom"),prop:"maxLevel"}},[r("InputNumber",{attrs:{min:2,max:18},model:{value:o.newTileServer.maxLevel,callback:function(e){o.$set(o.newTileServer,"maxLevel",e)},expression:"newTileServer.maxLevel"}})],1)],1),r("div",{attrs:{slot:"footer"},slot:"footer"},[r("Button",{on:{click:function(e){o.showAddServerModal=!1}}},[o._v(o._s(o.$t("common.cancel")))]),r("Button",{attrs:{type:"primary"},on:{click:o.handleAddServer}},[o._v(o._s(o.$t("common.commit")))])],1)],1)],1)},[],!1,null,"7efdfefc",null);t.default=o.exports},"0ccb":function(e,t,o){function r(a){return function(e,t,o){var e=n(s(e)),t=i(t),r=e.length,o=void 0===o?" ":n(o);return t<=r||""===o?e:((r=c(o,m((t=t-r)/o.length))).length>t&&(r=d(r,0,t)),a?e+r:r+e)}}var a=o("e330"),i=o("50c4"),n=o("577e"),l=o("1148"),s=o("1d80"),c=a(l),d=a("".slice),m=Math.ceil;e.exports={start:r(!1),end:r(!0)}},"4b1c":function(e,t,o){},"4d90":function(e,t,o){var r=o("23e7"),a=o("0ccb").start;r({target:"String",proto:!0,forced:o("9a0c")},{padStart:function(e){return a(this,e,1<arguments.length?arguments[1]:void 0)}})},"7b06":function(e,t,o){o("4b1c")},"9a0c":function(e,t,o){o=o("b5db");e.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(o)}}]);