(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-ddb87040"],{"0bd4":function(e,t,o){"use strict";o.r(t);var r=o("e11e"),h=o.n(r),c=(o("6cc5"),o("be3b")),r=o("8fad"),r={name:"photoMap",props:{borderRadius:{default:"15px",type:String},albumId:{default:"",Type:String},libraryId:{default:"",Type:String},ordinaryAlbumId:{default:"",Type:String}},components:{albumDetail:r.default},data(){return{showAddServerModal:!1,newTileServer:{name:"",server:"",coordinate:"WGS-84",maxLevel:18},coordinateOptions:[{value:"WGS-84",label:"WGS-84"},{value:"GCJ-02",label:"GCJ-02"},{value:"BD-09",label:"BD-09"}],showSwitchMapModal:!1,tileServerList:[],currentTilesServer:"",albumFirstPhoto:null,showPhotoGeo:!1,map:null,markerGroup:null,clickGeohash:null,selectPositionStr:"",currentMaxZoom:8,moveTimer:null}},mounted(){this.getZoomInfo(),window.addEventListener("popstate",this.onPopstate)},beforeDestroy(){window.removeEventListener("popstate",this.onPopstate)},methods:{openAddServer(){this.newTileServer={name:"",server:"",coordinate:"WGS-84",maxLevel:18},this.showAddServerModal=!0},handleDeleteServer(e){this.$Modal.confirm({title:this.$t("common.alert"),content:this.$t("common.deleteSure"),onOk:()=>{this.api.post("/api/mapApi/deleteTileServer",{tileServerJson:JSON.stringify(e)}).then(e=>{e.code||(this.$Message.success(this.$t("common.operationSuccess")),this.goToSwitchMap())}).catch(e=>{console.error(e),this.$Message.error(this.$t("common.operationFail"))})}})},handleAddServer(){!this.newTileServer.name||!this.newTileServer.server||!this.newTileServer.coordinate||this.newTileServer.maxLevel<2||18<this.newTileServer.maxLevel||this.api.post("/api/mapApi/addTileServer",{tileServerJson:JSON.stringify(this.newTileServer)}).then(e=>{e.code||(this.$Message.success(this.$t("common.operationSuccess")),this.showAddServerModal=!1,this.goToSwitchMap())}).catch(e=>{console.error(e),this.$Message.error(this.$t("common.operationFail"))})},goToSwitchMap(){this.api.post("/api/mapApi/getTileServerList").then(e=>{!e.code&&e.tileServerList?(this.tileServerList=e.tileServerList.sort((e,t)=>t.current-e.current),this.showSwitchMapModal=!0):this.showVsNotification(this.$t("common.operationFail"))}).catch(e=>{console.error(e),this.showVsNotification(this.$t("common.operationFail"))})},switchMapApi(e){this.$Modal.confirm({title:this.$t("common.alert"),content:this.$t("mapSwitchAlert"),onOk:()=>{this.api.post("/api/mapApi/setTileServer",{tileServerJson:JSON.stringify(e)}).then(e=>{e.code||location.reload()}).catch(e=>{console.error(e),this.showVsNotification(this.$t("common.operationFail"))})}})},onPopstate(){this.showPhotoGeo?(this.showPhotoGeo=!1,this.$bus.$emit("closePhotoGallery")):this.$router.go(-1)},getZoomInfo(){this.api.get("/api/mapApi/getZoom",{}).then(e=>{e.code||(this.currentMaxZoom=parseInt(e.zoomInfo.maxZoom),e.tileServer&&(this.currentTilesServer=e.tileServer),this.initMap(parseInt(e.zoomInfo.minZoom),parseInt(e.zoomInfo.maxZoom)))}).catch(e=>{})},initMap(e,t){var o=c.a.mapUrl(),o=new h.a.TileLayer(o,{minZoom:e=e<2?2:e,maxZoom:t,attribution:"NORMAL"});o.setZIndex(1);let r=localStorage.getItem("map-center-lat"),a=localStorage.getItem("map-center-lng"),i=38.8225909761771,s=105.380859375;r&&a&&(i=r,s=a);var e=new h.a.LatLng(i,s),t=h.a.latLng(-90,-360),n=h.a.latLng(90,360),t=h.a.latLngBounds(t,n);this.map=new h.a.Map("mainmap",{maxBounds:t,center:e,zoom:5,attributionControl:!1,layers:[o]}),this.albumId||this.ordinaryAlbumId||this.libraryId?this.getAlbumPhotoList():(this.map.on("moveend",t=>{this.moveTimer&&clearTimeout(this.moveTimer),this.moveTimer=setTimeout(()=>{var e=this.map.getCenter();localStorage.setItem("map-center-lat",e.lat),localStorage.setItem("map-center-lng",e.lng),this.getHashBox(t)},600)}),this.map.zoomIn()),this.markerGroup=h.a.layerGroup().addTo(this.map)},onModalShow(e){if(e){var t=document.getElementsByClassName("ivu-modal-body");for(let e=0;e<t.length;e++)t[e]&&t[e].style&&(t[e].style.padding=0)}},formatTimestampToYearMonth(e){e=new Date(e);return e.getFullYear()+"/"+String(e.getMonth()+1).padStart(2,"0")},dealPhotoMap(r,a){for(var i in this.markerGroup.clearLayers(),a){let t=a[i];var i=document.createElement("div"),s=(i.style="display:inline-block;position:relative; width: 100%;height: 100%; object-fit: cover;padding:2%",document.createElement("img"));s.src=c.a.getImgFullPath(t.id,!0),s.style="width: 100%;height: 100%; object-fit: cover",i.appendChild(s);let e,o=9*r;(o=75<o?75:o)<35&&(o=35),t.original_time&&((e=document.createElement("p")).textContent=this.formatTimestampToYearMonth(t.original_time),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.right="0",e.style.fontSize="8px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.color="white",e.style.overflow="hidden",e.style.textAlign="center",i.appendChild(e));s=h.a.divIcon({iconSize:[o,o],html:i});if((0!=t.latitude||0!=t.longitude)&&"undefined"!=t.latitude&&"undefined"!=t.longitude){this.albumFirstPhoto=t;try{var n=this.utils.transCoordinateForShow(this.currentTilesServer,t.longitude,t.latitude),l=h.a.marker([n[1],n[0]],{icon:s,indexId:t.id});l.on("click",e=>{this.api.post("/api/mapApi/getLocationStr",{indexId:t.id}).then(e=>{e.code||(this.selectPositionStr=e.geo.name+" "+e.geo.cn_name,this.clickGeohash=t.geohash,this.showPhotoGeo=!0,this.pushState())}).catch(e=>{})}),l.addTo(this.markerGroup)}catch(e){}}}var e;(this.albumId||this.ordinaryAlbumId)&&this.albumFirstPhoto&&(e=new h.a.LatLng(this.albumFirstPhoto.latitude,this.albumFirstPhoto.longitude),this.map.flyTo(e))},getAlbumPhotoList(){var e={};this.albumId?e.albumId=this.albumId:this.ordinaryAlbumId?e.ordinaryAlbumId=this.ordinaryAlbumId:this.libraryId&&(e.libraryId=this.libraryId),this.api.post("/api/photoApi/getAlbumPhotoForMap",e).then(e=>{e.code||this.dealPhotoMap(2,e.mapPhoto)}).catch(e=>{this.showVsNotification(JSON.stringify(e))})},getHashBox(e){this.map._zoom;let t=e.target._zoom,o=this.map.getBounds(),r=o._southWest,a=o._northEast,i=(r.lat<a.lat?r:a).lat,s=(a.lat>r.lat?a:r).lat,n=(r.lng<a.lng?r:a).lng,l=(a.lng>r.lng?a:r).lng,h={hideLoading:!0,minLat:i,minLng:n,maxLat:s,maxLng:l,zoom:t};this.api.post("/api/photoApi/getBoundsPhoto",h).then(e=>{e.code||this.dealPhotoMap(t,e.mapPhoto)}).catch(e=>{})}}},o=(o("99f7"),o("2877")),o=Object(o.a)(r,function(){var o=this,e=o.$createElement,r=o._self._c||e;return r("div",{staticClass:"map-root"},[o.isMobile?r("div",{staticClass:"map-content",attrs:{id:"mainmap"}}):r("div",{staticClass:"map-content",style:{"border-top-left-radius":o.borderRadius,"border-top-right-radius":o.borderRadius},attrs:{id:"mainmap"}}),o.map&&o.map._zoom&&!o.ordinaryAlbumId&&!o.albumId?r("div",{staticClass:"zoom-title-root"},[r("a",{staticStyle:{"margin-right":"5px","font-size":"12px"},on:{click:function(e){return o.goToSwitchMap()}}},[o.currentTilesServer&&o.currentTilesServer.name?r("span",{staticStyle:{"margin-right":"5px"}},[o._v(o._s(o.currentTilesServer.name))]):o._e(),o._v(o._s(o.$t("switchMap")))]),r("p",{staticStyle:{"font-size":"12px"}},[o._v(" "+o._s(o.$t("map.currentZoomLevel",{zoom:Math.ceil(o.map._zoom)}))+" "),o.currentMaxZoom?r("span",{staticStyle:{"margin-left":"3px"}},[o._v("(2-"+o._s(o.currentMaxZoom)+")")]):o._e()])]):o._e(),r("Modal",{ref:"myModal",attrs:{"footer-hide":"",fullscreen:"",closable:!1},on:{"on-visible-change":o.onModalShow},model:{value:o.showPhotoGeo,callback:function(e){o.showPhotoGeo=e},expression:"showPhotoGeo"}},[o.showPhotoGeo?r("album-detail",{attrs:{propsNearMode:!0,propsShowSearchBtn:!1,propsTitle:o.selectPositionStr,propsGeoHash:o.clickGeohash},on:{onClose:function(e){o.showPhotoGeo=!1}}}):o._e()],1),r("Modal",{attrs:{"footer-hide":""},scopedSlots:o._u([{key:"header",fn:function(){return[r("div",{staticClass:"ivu-modal-header-inner"},[o._v(o._s(o.$t("switchMap")))]),r("Button",{staticStyle:{position:"absolute",right:"40px",top:"8px"},attrs:{type:"primary",ghost:""},on:{click:o.openAddServer}},[o._v(" "+o._s(o.$t("addMapServer"))+" ")])]},proxy:!0}]),model:{value:o.showSwitchMapModal,callback:function(e){o.showSwitchMapModal=e},expression:"showSwitchMapModal"}},o._l(o.tileServerList,function(t,e){return r("div",{key:e,staticClass:"map-server-card ivu-card ivu-card-bordered"},[r("div",{staticClass:"ivu-card-body"},[r("h4",[o._v(o._s(o.$t("common.name"))+": "+o._s(t.name)),1==t.current?r("a",{staticStyle:{"margin-left":"5px"}},[o._v(o._s(o.$t("currentUsing")))]):o._e()]),1==t.isCustom?r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("tileServerUrl"))+": "+o._s(t.server))]):o._e(),r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("coordinate"))+": "+o._s(t.coordinate))]),r("p",{staticStyle:{"word-break":"break-all"}},[o._v(o._s(o.$t("maxZoom"))+": "+o._s(t.maxLevel))]),r("Button",{attrs:{type:"primary",ghost:""},on:{click:function(e){return o.switchMapApi(t)}}},[o._v(" "+o._s(o.$t("switch"))+" ")]),1==t.isCustom?r("Button",{staticStyle:{"margin-left":"5px"},attrs:{type:"error",ghost:""},on:{click:function(e){return o.handleDeleteServer(t)}}},[o._v(" "+o._s(o.$t("common.delete"))+" ")]):o._e()],1)])}),0),r("Modal",{attrs:{title:o.$t("addMapServer")},model:{value:o.showAddServerModal,callback:function(e){o.showAddServerModal=e},expression:"showAddServerModal"}},[r("Form",{attrs:{model:o.newTileServer,"label-position":"top"}},[r("FormItem",{attrs:{label:o.$t("common.name"),prop:"name"}},[r("Input",{model:{value:o.newTileServer.name,callback:function(e){o.$set(o.newTileServer,"name",e)},expression:"newTileServer.name"}})],1),r("FormItem",{attrs:{label:o.$t("tileServerUrl")+"(http/https)",prop:"server"}},[r("Input",{attrs:{placeholder:"https://xxx.xxx/{z}/{y}/{x}/tile.png"},model:{value:o.newTileServer.server,callback:function(e){o.$set(o.newTileServer,"server",e)},expression:"newTileServer.server"}})],1),r("FormItem",{attrs:{label:o.$t("coordinate"),prop:"coordinate"}},[r("Select",{model:{value:o.newTileServer.coordinate,callback:function(e){o.$set(o.newTileServer,"coordinate",e)},expression:"newTileServer.coordinate"}},o._l(o.coordinateOptions,function(e){return r("Option",{key:e.value,attrs:{value:e.value}},[o._v(o._s(e.label))])}),1)],1),r("FormItem",{attrs:{label:o.$t("maxZoom"),prop:"maxLevel"}},[r("InputNumber",{attrs:{min:2,max:18},model:{value:o.newTileServer.maxLevel,callback:function(e){o.$set(o.newTileServer,"maxLevel",e)},expression:"newTileServer.maxLevel"}})],1)],1),r("div",{attrs:{slot:"footer"},slot:"footer"},[r("Button",{on:{click:function(e){o.showAddServerModal=!1}}},[o._v(o._s(o.$t("common.cancel")))]),r("Button",{attrs:{type:"primary"},on:{click:o.handleAddServer}},[o._v(o._s(o.$t("common.commit")))])],1)],1)],1)},[],!1,null,"266a7041",null);t.default=o.exports},"208d":function(e,t,o){},"99f7":function(e,t,o){"use strict";o("208d")}}]);