const _0x427b98=_0x22ac;function _0x22ac(_0x67530f,_0x11faae){const _0x4989fd=_0x4989();return _0x22ac=function(_0x22ac75,_0x1cbaa2){_0x22ac75=_0x22ac75-0xf5;let _0x50ab7e=_0x4989fd[_0x22ac75];return _0x50ab7e;},_0x22ac(_0x67530f,_0x11faae);}(function(_0x502c1e,_0x1445e2){const _0x3d11f9=_0x22ac,_0x1352b6=_0x502c1e();while(!![]){try{const _0x2b8e34=parseInt(_0x3d11f9(0x15d))/0x1*(parseInt(_0x3d11f9(0x135))/0x2)+parseInt(_0x3d11f9(0x12f))/0x3+-parseInt(_0x3d11f9(0x128))/0x4+parseInt(_0x3d11f9(0x14b))/0x5*(parseInt(_0x3d11f9(0x163))/0x6)+parseInt(_0x3d11f9(0x13f))/0x7+-parseInt(_0x3d11f9(0x14f))/0x8+-parseInt(_0x3d11f9(0x168))/0x9;if(_0x2b8e34===_0x1445e2)break;else _0x1352b6['push'](_0x1352b6['shift']());}catch(_0x42cefd){_0x1352b6['push'](_0x1352b6['shift']());}}}(_0x4989,0x3bafa));let path=require(_0x427b98(0x139)),fs=require('fs');function _0x4989(){const _0x4811d7=['codec_type','undefined','tokenPwdEncryptKey','ultrafast','p010le','high\x20efficiency\x20video\x20coding','vaapi_vld','findByTitle','sep','stat','getIndexTableNameByType','decryptString','parseSubtitle','slow','../libs/nasTrans','h264_qsv','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','decoderType','h264','gray','input','filename','space\x20does\x20not\x20exist','cuda','yuv444p10le','pix_fmt','yuv420p','streams','serverType','H264','veryfast','stream\x20info\x20is\x20null','getReadRate','d3d11','spaceToken','join','nvenc_h264','transCodeParams-CoderNameHevc','codec_name','scale=','stream读取失败','1774944iUbgNn','getFps','dxva2_vld','getScaleOption','spaceId','getPrivateDbPath','p016le','217341vpdedW','decodePath','win32','pwd','y210le','../db/dbFileIndexTable','8PoLBgN','getCoderConfig','parse','../db/dbPrivateSpaceTable','path','get',':-2','pragma','yuv444p16le','ffprobe','3240685BvARii','spaceIndexId','includes','bgr0','nv20le','superfast','medium','parseVideoWH','toLowerCase','getPixFmt','fast','filePath','670TmlDjR','hevc','yuv420p10le','HEVC','567000McoYua','nv21','../db/dbConfigTable','value','r_frame_rate','../express-server/utils/fileUtils','nv12','error','yuv422p10le','length','then','../myConfig/config','folder_path','N/A','60337dBDBzB','codec_long_name','indexId','indexOf','type','ceil','6414EbKOaj','token\x20expired','journal_mode\x20=\x20WAL','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','sha256','1448199IyQPPF','nv16','exports','h.264','getTranscodeSpeed','parseVideoFullPath','index\x20does\x20not\x20exist','bit_rate','avg_frame_rate','close','gray10le','h264_nvenc','yuv444p','duration','qsv','transCodeParams-CoderNameH264','\x5c\x5c?\x5c','log','dealFFmpegPath','decoderSupportPixFormat','err','platform','split','stream_info'];_0x4989=function(){return _0x4811d7;};return _0x4989();}const Database=require('better-sqlite3');let transCodeUtil={};const config=require(_0x427b98(0x15a));let fileUtil=require(_0x427b98(0x154));const dbConfigTable=require(_0x427b98(0x151)),chldProcess=require('child_process');let nasTrans=require(_0x427b98(0x10d)),FFmpeg=nasTrans['FFmpeg'];const dbFileIndexTable=require(_0x427b98(0x134));let dbPrivateSpaceTable=require(_0x427b98(0x138)),sha256=require(_0x427b98(0x167)),cryptoUtils=require('../express-server/utils/cryptoUtils');const os=require('os');let platform=os[_0x427b98(0xfc)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require('./videoStreamUtil');let pixFormatList={'h264_nvenc':['yuv420p',_0x427b98(0x155),_0x427b98(0x103),_0x427b98(0x174),_0x427b98(0x12e),_0x427b98(0x13d),_0x427b98(0x142),'rgb0',_0x427b98(0x116),_0x427b98(0x120)],'nvenc_h264':[_0x427b98(0x119),_0x427b98(0x155),_0x427b98(0x103),_0x427b98(0x174),_0x427b98(0x12e),'yuv444p16le',_0x427b98(0x142),'rgb0',_0x427b98(0x116),_0x427b98(0x120)],'h264_qsv':[_0x427b98(0x155),_0x427b98(0x103),_0x427b98(0xf5),_0x427b98(0x119)],'hevc_qsv':[_0x427b98(0x155),_0x427b98(0x103),'yuyv422',_0x427b98(0x133),_0x427b98(0xf5)],'h264_mf':[_0x427b98(0x155),_0x427b98(0x119)],'h264_amf':[_0x427b98(0x155),'yuv420p',_0x427b98(0x120),_0x427b98(0x12a)],'libopenh264':[_0x427b98(0x119)],'libx264':[_0x427b98(0x119),'yuv422p','yuvj422p',_0x427b98(0x174),'yuvj444p','nv12',_0x427b98(0x169),_0x427b98(0x150),_0x427b98(0x14d),_0x427b98(0x157),_0x427b98(0x117),_0x427b98(0x143),_0x427b98(0x112),_0x427b98(0x172)],'h264_vaapi':[_0x427b98(0x105),_0x427b98(0x119)],'h264_cuvid':[_0x427b98(0x116),_0x427b98(0x155),_0x427b98(0x103),_0x427b98(0x12e)],'hevc_cuvid':[_0x427b98(0x116),_0x427b98(0x155),'p010le',_0x427b98(0x12e)]};function getPwdFromToken(_0x42dd4e,_0x3ca72e,_0x236e33){const _0xb00bec=_0x427b98;let _0xfff8f6=dbPrivateSpaceTable['getTokenObjByToken'](_0x3ca72e,_0x42dd4e);!_0xfff8f6&&_0x236e33(_0xb00bec(0x164),pwd);let _0x17ea71=_0xfff8f6[_0xb00bec(0x132)];cryptoUtils[_0xb00bec(0x10a)](config[_0xb00bec(0x101)],_0x17ea71)[_0xb00bec(0x159)](_0xc6b359=>{_0x236e33(![],_0xc6b359);});}transCodeUtil[_0x427b98(0xf9)]=function(_0x4473af){const _0x224c80=_0x427b98;if(typeof _0x4473af!=='string')return _0x4473af;return platform==_0x224c80(0x131)&&_0x4473af[_0x224c80(0x158)]>0x103?_0x224c80(0xf7)+_0x4473af:_0x4473af;},transCodeUtil[_0x427b98(0x16d)]=function(_0x90cb0,_0x35607c,_0x41ae43){return new Promise((_0xa69271,_0x382e12)=>{const _0x4540ad=_0x22ac;if(_0x41ae43['indexId']&&!_0x41ae43[_0x4540ad(0x12c)]){let _0x555258=dbFileIndexTable[_0x4540ad(0x109)](_0x41ae43[_0x4540ad(0x11b)]),_0x327f17=dbFileIndexTable['getById'](_0x90cb0,_0x41ae43[_0x4540ad(0x15f)],_0x555258);if(!_0x327f17)return _0x382e12(_0x4540ad(0x16e));if(_0x327f17[_0x4540ad(0x161)]!=0x2)return _0x382e12('index\x20isn\x27t\x20video');if(_0x327f17[_0x4540ad(0xfe)]==_0x4540ad(0x100))return _0x382e12(_0x4540ad(0x11e));let _0x17e720=JSON['parse'](_0x327f17[_0x4540ad(0xfe)]),_0x2a9965=_0x327f17[_0x4540ad(0x139)]+path[_0x4540ad(0x107)]+_0x327f17[_0x4540ad(0x114)];return _0xa69271({'fullpath':_0x2a9965,'streamList':_0x17e720,'duration':_0x327f17['duration']});}else{if(_0x41ae43['filePath']&&!_0x41ae43[_0x4540ad(0x12c)]){let _0x57d167=fileUtil[_0x4540ad(0x130)](_0x41ae43[_0x4540ad(0x14a)]);fs[_0x4540ad(0x108)](_0x57d167,(_0x13fca7,_0x2c32a8)=>{const _0x80a8f8=_0x4540ad;if(_0x13fca7)return _0x382e12('file\x20does\x20not\x20exist');else FFmpeg()[_0x80a8f8(0x113)](transCodeUtil[_0x80a8f8(0xf9)](_0x57d167))[_0x80a8f8(0x13e)]((_0x416ea0,_0xe1164)=>{const _0x47cb5b=_0x80a8f8;if(_0x416ea0)return console['log'](_0x416ea0),_0x382e12(_0x47cb5b(0x127));else{let _0xa969da=videoStreamUtil['getDurationFromStream'](_0xe1164),_0x377a67=_0xe1164[_0x47cb5b(0x11a)];return _0xa69271({'fullpath':_0x57d167,'streamList':_0x377a67,'duration':_0xa969da});}});});}else{if(_0x41ae43[_0x4540ad(0x12c)]){let _0x4a17c9=_0x41ae43[_0x4540ad(0x12c)],_0x9717fa=dbPrivateSpaceTable['getById'](_0x35607c,_0x4a17c9);if(!_0x9717fa)return _0x382e12(_0x4540ad(0x115));let _0x1722f8=path[_0x4540ad(0x122)](_0x9717fa[_0x4540ad(0x15b)],fileUtil[_0x4540ad(0x130)](_0x41ae43['filePath']));fs[_0x4540ad(0x108)](_0x1722f8,(_0x207ed0,_0x5e45d6)=>{const _0x57a037=_0x4540ad;if(_0x207ed0)return _0x382e12('file\x20does\x20not\x20exist');getPwdFromToken(_0x41ae43[_0x57a037(0x121)],_0x35607c,(_0x552db5,_0x5c3f4c)=>{const _0xe611e1=_0x57a037;if(_0x552db5)return _0x382e12(_0xe611e1(0xfb));let _0x506add=config[_0xe611e1(0x12d)](_0x9717fa[_0xe611e1(0x15b)]),_0x3af63d=new Database(_0x506add,{});_0x3af63d[_0xe611e1(0x13c)](_0xe611e1(0x165));let _0x555a1b=_0x3af63d['prepare']('SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?')[_0xe611e1(0x13a)](_0x41ae43[_0xe611e1(0x140)]);if(!_0x555a1b||!_0x555a1b[_0xe611e1(0xfe)])return _0x382e12('index\x20id\x20does\x20not\x20exist');_0x3af63d[_0xe611e1(0x171)]();let _0x4c3b2d=JSON[_0xe611e1(0x137)](_0x555a1b['stream_info']);return _0xa69271({'fullpath':_0x1722f8,'streamList':_0x4c3b2d,'needDecrypt':!![],'pwd':_0x5c3f4c,'duration':_0x555a1b[_0xe611e1(0x175)]});});});}}}});},transCodeUtil[_0x427b98(0x129)]=function(_0x2eec0f){const _0xf88545=_0x427b98;let _0xbe5bbd=0x1e,_0x133ac1=![];try{if(_0x2eec0f[_0xf88545(0x153)]){let _0x2c986c=_0x2eec0f[_0xf88545(0x153)]['split']('/');(_0x2c986c[_0xf88545(0x158)]=0x2)&&(_0x133ac1=Math['ceil'](parseInt(_0x2c986c[0x0])/parseInt(_0x2c986c[0x1])));}if(!_0x133ac1){if(_0x2eec0f[_0xf88545(0x170)]){let _0x1ef3a8=_0x2eec0f[_0xf88545(0x170)][_0xf88545(0xfd)]('/');(_0x1ef3a8[_0xf88545(0x158)]=0x2)&&(_0x133ac1=Math[_0xf88545(0x162)](parseInt(_0x1ef3a8[0x0])/parseInt(_0x1ef3a8[0x1])));}}}catch(_0x3729d5){console[_0xf88545(0xf8)](_0xf88545(0x156),_0x3729d5);}return _0x133ac1&&_0x133ac1<=0x3c&&(_0xbe5bbd=_0x133ac1),_0xbe5bbd;},transCodeUtil[_0x427b98(0x10b)]=function(_0x433bf9,_0x172538){const _0x3b9582=_0x427b98;let _0x9bc17d=[];for(let _0x1b159e=0x0;_0x1b159e<_0x433bf9[_0x3b9582(0x158)];_0x1b159e++){let _0x42998d=_0x433bf9[_0x1b159e];_0x42998d[_0x3b9582(0xff)]=='subtitle'&&_0x9bc17d['push'](_0x42998d);}if(_0x9bc17d[_0x3b9582(0x158)]>_0x172538)return _0x9bc17d[_0x172538];return null;},transCodeUtil['parseStreamList']=function(_0x54327a){const _0x65d0e6=_0x427b98;let _0x341d8f=videoStreamUtil[_0x65d0e6(0x146)](_0x54327a);return _0x341d8f;},transCodeUtil[_0x427b98(0x12b)]=function(_0x492b31,_0x18ce58,_0x53d2ba){const _0x6fcff4=_0x427b98;let _0x12ea51=null;if(_0x18ce58&&_0x53d2ba&&_0x492b31)_0x492b31>_0x18ce58&&_0x492b31>_0x53d2ba&&(_0x492b31=_0x18ce58>_0x53d2ba?_0x18ce58:_0x53d2ba),_0x18ce58>_0x53d2ba?_0x12ea51=_0x6fcff4(0x126)+_0x492b31+_0x6fcff4(0x13b):_0x12ea51='scale=-2:'+_0x492b31;else{}return _0x12ea51;},transCodeUtil['getVideoBitrate']=function(_0x467338,_0xaeb340){const _0x5a1c43=_0x427b98;return _0xaeb340==-0x1&&(_0x467338&&_0x467338['bit_rate']&&_0x467338[_0x5a1c43(0x16f)]>0xf4240&&_0x467338['bit_rate']!=_0x5a1c43(0x15c)?(_0xaeb340=_0x467338[_0x5a1c43(0x16f)]/0x3e8,_0xaeb340>BITRATE_MAX&&(_0xaeb340=BITRATE_MAX)):_0xaeb340=BITRATE_DEFAULT),_0xaeb340;},transCodeUtil['getCrf']=function(_0x86d264){const _0x3a12f6=_0x427b98;let _0x58285d=0x17,_0x501801=dbConfigTable[_0x3a12f6(0x106)](_0x86d264,'crf');return _0x501801&&(_0x501801[_0x3a12f6(0x152)]>=0x1&&_0x501801['value']<=0x33&&(_0x58285d=_0x501801[_0x3a12f6(0x152)])),_0x58285d;},transCodeUtil[_0x427b98(0x16c)]=function(_0x834f1e,_0x1d3947){const _0x4ce355=_0x427b98;let _0x24e8fa=dbConfigTable[_0x4ce355(0x106)](_0x834f1e,'transcodeSpeed'),_0x480464=[_0x4ce355(0x102),_0x4ce355(0x149),_0x4ce355(0x145),_0x4ce355(0x10c)];function _0x28210c(_0x53b779){const _0x294a15=_0x4ce355;if((_0x1d3947==_0x294a15(0x173)||_0x1d3947==_0x294a15(0x123))&&_0x53b779==_0x294a15(0x102))return'p1';if(_0x1d3947==_0x294a15(0x10e)&&(_0x53b779=='ultrafast'||_0x53b779==_0x294a15(0x144)))return _0x294a15(0x11d);return _0x53b779;}return _0x24e8fa&&_0x24e8fa['value']&&_0x480464[_0x4ce355(0x141)](_0x24e8fa['value'])?_0x28210c(_0x24e8fa['value']):_0x4ce355(0x145);},transCodeUtil[_0x427b98(0x136)]=function(_0x4d4c8d,_0x4b491c){const _0x540392=_0x427b98;let _0x424b72='';if(_0x4b491c){if(_0x4b491c[_0x540392(0x125)]){let _0x3b0a86=_0x4b491c[_0x540392(0x125)][_0x540392(0x147)]();(_0x3b0a86[_0x540392(0x160)](_0x540392(0x111))!=-0x1||_0x3b0a86[_0x540392(0x160)]('h.264')!=-0x1)&&(_0x424b72=_0x540392(0x11c)),_0x3b0a86[_0x540392(0x160)](_0x540392(0x14c))!=-0x1&&(_0x424b72=_0x540392(0x14e));}if(!_0x424b72&&_0x4b491c[_0x540392(0x15e)]){let _0x35f10a=_0x4b491c[_0x540392(0x15e)][_0x540392(0x147)]();(_0x35f10a[_0x540392(0x160)](_0x540392(0x111))!=-0x1||_0x35f10a[_0x540392(0x160)](_0x540392(0x16b))!=-0x1)&&(_0x424b72='H264'),(_0x35f10a[_0x540392(0x160)](_0x540392(0x14c))!=-0x1||_0x35f10a[_0x540392(0x160)](_0x540392(0x104))!=-0x1)&&(_0x424b72='HEVC');}}!_0x424b72&&(console[_0x540392(0xf8)](_0x540392(0x10f)),_0x424b72=_0x540392(0x14e));let _0x4378cd={'decoderCommand':'','encoderName':'libx264','coderName':'CPU'},_0x41cc7d=dbConfigTable[_0x540392(0x106)](_0x4d4c8d,'transCodeParams-coderList'),_0x570228='';if(_0x424b72==_0x540392(0x14e)){let _0x3f48d2=dbConfigTable['findByTitle'](_0x4d4c8d,_0x540392(0x124));_0x3f48d2&&_0x3f48d2['value']&&(_0x570228=_0x3f48d2[_0x540392(0x152)]);}else{if(_0x424b72==_0x540392(0x11c)){let _0x13f357=dbConfigTable[_0x540392(0x106)](_0x4d4c8d,_0x540392(0xf6));_0x13f357&&_0x13f357[_0x540392(0x152)]&&(_0x570228=_0x13f357[_0x540392(0x152)]);}}if(_0x41cc7d&&_0x41cc7d[_0x540392(0x152)])try{let _0x8581ae=[];_0x41cc7d=JSON[_0x540392(0x137)](_0x41cc7d['value']);for(let _0x164f3d of _0x41cc7d){_0x164f3d[_0x540392(0x110)]==_0x424b72&&_0x8581ae['push'](_0x164f3d);}if(_0x8581ae[_0x540392(0x158)]>0x0){if(!_0x570228)_0x4378cd=_0x8581ae[0x0];else{let _0x42ee36=![];for(let _0x50fe3a of _0x8581ae){if(_0x50fe3a['coderName']==_0x570228){_0x4378cd=_0x50fe3a,_0x42ee36=!![];break;}}!_0x42ee36&&(console[_0x540392(0xf8)](_0x540392(0x166),_0x8581ae[0x0]),_0x4378cd=_0x8581ae[0x0]);}}}catch(_0x32369d){console[_0x540392(0xf8)](_0x32369d);}return _0x4378cd;},transCodeUtil[_0x427b98(0x11f)]=function(_0x5623cd){const _0x401895=_0x427b98;let _0x827871=0x5,_0x2319ad=_0x827871,_0x299d71=dbConfigTable['findByTitle'](_0x5623cd,'transCodeParams-readrate');if(_0x299d71&&_0x299d71[_0x401895(0x152)])try{_0x2319ad=parseInt(_0x299d71[_0x401895(0x152)]),(_0x2319ad<0x2||_0x2319ad>0x1e)&&(_0x2319ad=_0x827871);}catch(_0x333f54){return _0x827871;}return _0x2319ad;},transCodeUtil[_0x427b98(0x148)]=function(_0x4140ff,_0x329144){const _0x25e2f9=_0x427b98;return _0x25e2f9(0x119);},transCodeUtil[_0x427b98(0xfa)]=function(_0x117a00,_0x241a87){const _0x596af5=_0x427b98;let _0x56e63e=_0x117a00[_0x596af5(0x118)];if(_0x56e63e){_0x56e63e=_0x56e63e['trim']();if(pixFormatList[_0x241a87]){if(!pixFormatList[_0x241a87][_0x596af5(0x141)](_0x56e63e))return![];}}return!![];},module[_0x427b98(0x16a)]=transCodeUtil;