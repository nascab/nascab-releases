const _0x47301d=_0x5f48;(function(_0xc2cfbc,_0x2cf6b3){const _0x156b48=_0x5f48,_0x3181a7=_0xc2cfbc();while(!![]){try{const _0xd5d2e2=-parseInt(_0x156b48(0x116))/0x1*(-parseInt(_0x156b48(0x16a))/0x2)+parseInt(_0x156b48(0x15b))/0x3+-parseInt(_0x156b48(0x15e))/0x4*(-parseInt(_0x156b48(0x172))/0x5)+parseInt(_0x156b48(0x130))/0x6*(-parseInt(_0x156b48(0x197))/0x7)+parseInt(_0x156b48(0x154))/0x8*(parseInt(_0x156b48(0x132))/0x9)+parseInt(_0x156b48(0x16c))/0xa+-parseInt(_0x156b48(0x134))/0xb;if(_0xd5d2e2===_0x2cf6b3)break;else _0x3181a7['push'](_0x3181a7['shift']());}catch(_0x962774){_0x3181a7['push'](_0x3181a7['shift']());}}}(_0xa89b,0x87391));let path=require(_0x47301d(0x15f)),fs=require('fs');const Database=require(_0x47301d(0x18a));let transCodeUtil={};const config=require('../myConfig/config');let fileUtil=require(_0x47301d(0x13d));const dbConfigTable=require('../db/dbConfigTable'),chldProcess=require(_0x47301d(0x156));let nasTrans=require(_0x47301d(0x14e)),FFmpeg=nasTrans[_0x47301d(0x118)];function _0x5f48(_0x1b833f,_0x15750b){const _0xa89b9b=_0xa89b();return _0x5f48=function(_0x5f48c6,_0x3a0865){_0x5f48c6=_0x5f48c6-0x113;let _0x54fd6b=_0xa89b9b[_0x5f48c6];return _0x54fd6b;},_0x5f48(_0x1b833f,_0x15750b);}const dbFileIndexTable=require(_0x47301d(0x15c));let dbPrivateSpaceTable=require('../db/dbPrivateSpaceTable'),sha256=require('sha256'),cryptoUtils=require(_0x47301d(0x11f));const os=require('os');function _0xa89b(){const _0x3a5c22=['value','6477009CcVYsz','parseVideoWH','dealFFmpegPath','medium','h264_qsv','scale=-2:','dxva2_vld','findByTitle','toLowerCase','../express-server/utils/fileUtils','tokenPwdEncryptKey','yuv420p','p016le','hevc','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','stream\x20info\x20is\x20null','spaceId','yuyv422','parse','yuv420p10le','ffprobe','error','file\x20does\x20not\x20exist','then','getVideoBitrate','./videoStreamUtil','../libs/nasTrans','duration','high\x20efficiency\x20video\x20coding','stat','yuvj422p','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','2448ctqyXN','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','child_process','pix_fmt','space\x20does\x20not\x20exist','CPU','fast','1126956hnqghL','../db/dbFileIndexTable','ultrafast','12NkxUbt','path','crf','parseSubtitle','\x5c\x5c?\x5c','input','index\x20id\x20does\x20not\x20exist','superfast','h264','yuv422p','rgb0','getTokenObjByToken','418Fcwazw','d3d11','5717110PSGVEk','h.264','decoderSupportPixFormat','gray','stream读取失败',':-2','376060bfSaeL','indexOf','p010le','H264','yuv444p','vaapi_vld','r_frame_rate','transCodeParams-CoderNameH264','join','getById','ceil','nv20le','libx264','nv12','decoderType','filePath','nv16','push','transCodeParams-CoderNameHevc','token\x20expired','yuv444p16le','y210le','cuda','bit_rate','better-sqlite3','parseStreamList','get','transcodeSpeed','nvenc_h264','streams','codec_name','win32','stream_info','subtitle','length','getPrivateDbPath','sep','7neFrgx','index\x20does\x20not\x20exist','transCodeParams-coderList','includes','3515tRPHpG','codec_long_name','FFmpeg','err','nv21','h264_nvenc','parseVideoFullPath','pragma','log','../express-server/utils/cryptoUtils','close','filename','avg_frame_rate','getTranscodeSpeed','folder_path','getScaleOption','bgr0','indexId','yuvj444p','decryptString','spaceIndexId','exports','scale=','decodePath','index\x20isn\x27t\x20video','serverType','4789776JcsbvZ','HEVC','981hDxnce'];_0xa89b=function(){return _0x3a5c22;};return _0xa89b();}let platform=os['platform']();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x47301d(0x14d));let pixFormatList={'h264_nvenc':[_0x47301d(0x13f),_0x47301d(0x17f),_0x47301d(0x174),_0x47301d(0x176),_0x47301d(0x140),_0x47301d(0x186),_0x47301d(0x126),'rgb0',_0x47301d(0x188),'d3d11'],'nvenc_h264':[_0x47301d(0x13f),_0x47301d(0x17f),_0x47301d(0x174),_0x47301d(0x176),_0x47301d(0x140),_0x47301d(0x186),'bgr0',_0x47301d(0x168),_0x47301d(0x188),_0x47301d(0x16b)],'h264_qsv':[_0x47301d(0x17f),'p010le','qsv',_0x47301d(0x13f)],'hevc_qsv':[_0x47301d(0x17f),_0x47301d(0x174),_0x47301d(0x145),_0x47301d(0x187),'qsv'],'h264_mf':[_0x47301d(0x17f),_0x47301d(0x13f)],'h264_amf':['nv12',_0x47301d(0x13f),_0x47301d(0x16b),_0x47301d(0x13a)],'libopenh264':[_0x47301d(0x13f)],'libx264':[_0x47301d(0x13f),_0x47301d(0x167),_0x47301d(0x152),_0x47301d(0x176),_0x47301d(0x128),_0x47301d(0x17f),_0x47301d(0x182),_0x47301d(0x11a),_0x47301d(0x147),'yuv422p10le','yuv444p10le',_0x47301d(0x17d),_0x47301d(0x16f),'gray10le'],'h264_vaapi':[_0x47301d(0x177),_0x47301d(0x13f)],'h264_cuvid':['cuda',_0x47301d(0x17f),_0x47301d(0x174),_0x47301d(0x140)],'hevc_cuvid':[_0x47301d(0x188),_0x47301d(0x17f),_0x47301d(0x174),_0x47301d(0x140)]};function getPwdFromToken(_0x282fc4,_0x45e003,_0x4e1110){const _0xf5c7a=_0x47301d;let _0x190024=dbPrivateSpaceTable[_0xf5c7a(0x169)](_0x45e003,_0x282fc4);if(!_0x190024){_0x4e1110(_0xf5c7a(0x185),''),console[_0xf5c7a(0x11e)](_0xf5c7a(0x185),_0x282fc4);return;}let _0x4d963c=_0x190024['pwd'];cryptoUtils[_0xf5c7a(0x129)](config[_0xf5c7a(0x13e)],_0x4d963c)[_0xf5c7a(0x14b)](_0x2ede74=>{_0x4e1110(![],_0x2ede74);});}transCodeUtil[_0x47301d(0x136)]=function(_0x1365be){const _0x3787c7=_0x47301d;if(typeof _0x1365be!=='string')return _0x1365be;return platform==_0x3787c7(0x191)&&_0x1365be[_0x3787c7(0x194)]>0x103?_0x3787c7(0x162)+_0x1365be:_0x1365be;},transCodeUtil[_0x47301d(0x11c)]=function(_0x4d7e14,_0x5dc57e,_0xa1390){return new Promise((_0x24c2ac,_0x1dade1)=>{const _0x5f46ca=_0x5f48;if(_0xa1390[_0x5f46ca(0x127)]&&!_0xa1390[_0x5f46ca(0x144)]){let _0x4069f0=dbFileIndexTable['getIndexTableNameByType'](_0xa1390[_0x5f46ca(0x12f)]),_0xe64318=dbFileIndexTable['getById'](_0x4d7e14,_0xa1390[_0x5f46ca(0x127)],_0x4069f0);if(!_0xe64318)return _0x1dade1(_0x5f46ca(0x113));if(_0xe64318['type']!=0x2)return _0x1dade1(_0x5f46ca(0x12e));if(_0xe64318[_0x5f46ca(0x192)]=='undefined')return _0x1dade1(_0x5f46ca(0x143));let _0x5502bc=JSON[_0x5f46ca(0x146)](_0xe64318[_0x5f46ca(0x192)]),_0x13836c=_0xe64318[_0x5f46ca(0x15f)]+path[_0x5f46ca(0x196)]+_0xe64318[_0x5f46ca(0x121)];return _0x24c2ac({'fullpath':_0x13836c,'streamList':_0x5502bc,'duration':_0xe64318[_0x5f46ca(0x14f)]});}else{if(_0xa1390[_0x5f46ca(0x181)]&&!_0xa1390['spaceId']){let _0x427dc3=fileUtil[_0x5f46ca(0x12d)](_0xa1390[_0x5f46ca(0x181)]);fs['stat'](_0x427dc3,(_0x384165,_0x32803a)=>{const _0x2e9932=_0x5f46ca;if(_0x384165)return _0x1dade1(_0x2e9932(0x14a));else FFmpeg()[_0x2e9932(0x163)](transCodeUtil[_0x2e9932(0x136)](_0x427dc3))[_0x2e9932(0x148)]((_0x24a40d,_0x371b28)=>{const _0x2dba2a=_0x2e9932;if(_0x24a40d)return console[_0x2dba2a(0x11e)](_0x24a40d),_0x1dade1(_0x2dba2a(0x170));else{let _0x47a215=videoStreamUtil['getDurationFromStream'](_0x371b28),_0x381ca0=_0x371b28[_0x2dba2a(0x18f)];return _0x24c2ac({'fullpath':_0x427dc3,'streamList':_0x381ca0,'duration':_0x47a215});}});});}else{if(_0xa1390['spaceId']){let _0xfb6c6=_0xa1390[_0x5f46ca(0x144)],_0x9f959=dbPrivateSpaceTable[_0x5f46ca(0x17b)](_0x5dc57e,_0xfb6c6);if(!_0x9f959)return _0x1dade1(_0x5f46ca(0x158));let _0x296456=path[_0x5f46ca(0x17a)](_0x9f959['folder_path'],fileUtil[_0x5f46ca(0x12d)](_0xa1390[_0x5f46ca(0x181)]));fs[_0x5f46ca(0x151)](_0x296456,(_0x3ffbe6,_0x22c3ba)=>{if(_0x3ffbe6)return _0x1dade1('file\x20does\x20not\x20exist');getPwdFromToken(_0xa1390['spaceToken'],_0x5dc57e,(_0x52b694,_0x260674)=>{const _0x27d107=_0x5f48;if(_0x52b694)return _0x1dade1(_0x27d107(0x119));let _0x54834b=config[_0x27d107(0x195)](_0x9f959[_0x27d107(0x124)]),_0x12b685=new Database(_0x54834b,{});_0x12b685[_0x27d107(0x11d)]('journal_mode\x20=\x20WAL');let _0xe030ba=_0x12b685['prepare'](_0x27d107(0x155))[_0x27d107(0x18c)](_0xa1390[_0x27d107(0x12a)]);if(!_0xe030ba||!_0xe030ba[_0x27d107(0x192)])return _0x1dade1(_0x27d107(0x164));_0x12b685[_0x27d107(0x120)]();let _0x14fab3=JSON[_0x27d107(0x146)](_0xe030ba[_0x27d107(0x192)]);return _0x24c2ac({'fullpath':_0x296456,'streamList':_0x14fab3,'needDecrypt':!![],'pwd':_0x260674,'duration':_0xe030ba[_0x27d107(0x14f)]});});});}}}});},transCodeUtil['getFps']=function(_0x28c380){const _0x46be48=_0x47301d;let _0x3b4d09=0x1e,_0x59606b=![];try{if(_0x28c380[_0x46be48(0x178)]){let _0x2ee3bb=_0x28c380[_0x46be48(0x178)]['split']('/');(_0x2ee3bb[_0x46be48(0x194)]=0x2)&&(_0x59606b=Math[_0x46be48(0x17c)](parseInt(_0x2ee3bb[0x0])/parseInt(_0x2ee3bb[0x1])));}if(!_0x59606b){if(_0x28c380[_0x46be48(0x122)]){let _0x3e4582=_0x28c380[_0x46be48(0x122)]['split']('/');(_0x3e4582['length']=0x2)&&(_0x59606b=Math[_0x46be48(0x17c)](parseInt(_0x3e4582[0x0])/parseInt(_0x3e4582[0x1])));}}}catch(_0x39f17d){console['log'](_0x46be48(0x149),_0x39f17d);}return _0x59606b&&_0x59606b<=0x3c&&(_0x3b4d09=_0x59606b),_0x3b4d09;},transCodeUtil[_0x47301d(0x161)]=function(_0x296770,_0x1fc27a){const _0x5ad96a=_0x47301d;let _0xc8a6f=[];for(let _0x4ad2da=0x0;_0x4ad2da<_0x296770[_0x5ad96a(0x194)];_0x4ad2da++){let _0x1f5c6a=_0x296770[_0x4ad2da];_0x1f5c6a['codec_type']==_0x5ad96a(0x193)&&_0xc8a6f[_0x5ad96a(0x183)](_0x1f5c6a);}if(_0xc8a6f[_0x5ad96a(0x194)]>_0x1fc27a)return _0xc8a6f[_0x1fc27a];return null;},transCodeUtil[_0x47301d(0x18b)]=function(_0x4946cd){const _0x13dd86=_0x47301d;let _0x23d1ea=videoStreamUtil[_0x13dd86(0x135)](_0x4946cd);return _0x23d1ea;},transCodeUtil[_0x47301d(0x125)]=function(_0x5de9fa,_0xa8f703,_0x5bbd8f){const _0x3c61b6=_0x47301d;let _0x15b55d=null;if(_0xa8f703&&_0x5bbd8f&&_0x5de9fa)_0x5de9fa>_0xa8f703&&_0x5de9fa>_0x5bbd8f&&(_0x5de9fa=_0xa8f703>_0x5bbd8f?_0xa8f703:_0x5bbd8f),_0xa8f703>_0x5bbd8f?_0x15b55d=_0x3c61b6(0x12c)+_0x5de9fa+_0x3c61b6(0x171):_0x15b55d=_0x3c61b6(0x139)+_0x5de9fa;else{}return _0x15b55d;},transCodeUtil[_0x47301d(0x14c)]=function(_0x5144a6,_0x1d2dec){const _0x484af8=_0x47301d;return _0x1d2dec==-0x1&&(_0x5144a6&&_0x5144a6['bit_rate']&&_0x5144a6['bit_rate']>0xf4240&&_0x5144a6[_0x484af8(0x189)]!='N/A'?(_0x1d2dec=_0x5144a6[_0x484af8(0x189)]/0x3e8,_0x1d2dec>BITRATE_MAX&&(_0x1d2dec=BITRATE_MAX)):_0x1d2dec=BITRATE_DEFAULT),_0x1d2dec;},transCodeUtil['getCrf']=function(_0x71079e){const _0x16b8c9=_0x47301d;let _0x32bf9a=0x17,_0x30506a=dbConfigTable[_0x16b8c9(0x13b)](_0x71079e,_0x16b8c9(0x160));return _0x30506a&&(_0x30506a[_0x16b8c9(0x133)]>=0x1&&_0x30506a[_0x16b8c9(0x133)]<=0x33&&(_0x32bf9a=_0x30506a['value'])),_0x32bf9a;},transCodeUtil[_0x47301d(0x123)]=function(_0x136ef8,_0x37d046){const _0x165597=_0x47301d;let _0x15365e=dbConfigTable[_0x165597(0x13b)](_0x136ef8,_0x165597(0x18d)),_0x39886=[_0x165597(0x15d),_0x165597(0x15a),'medium','slow'];function _0x3c64f5(_0x41a83e){const _0x195bc5=_0x165597;if((_0x37d046==_0x195bc5(0x11b)||_0x37d046==_0x195bc5(0x18e))&&_0x41a83e==_0x195bc5(0x15d))return'p1';if(_0x37d046==_0x195bc5(0x138)&&(_0x41a83e==_0x195bc5(0x15d)||_0x41a83e==_0x195bc5(0x165)))return'veryfast';return _0x41a83e;}return _0x15365e&&_0x15365e[_0x165597(0x133)]&&_0x39886[_0x165597(0x115)](_0x15365e[_0x165597(0x133)])?_0x3c64f5(_0x15365e[_0x165597(0x133)]):_0x165597(0x137);},transCodeUtil['getCoderConfig']=function(_0x26c7bc,_0x2be891){const _0x570b6a=_0x47301d;let _0x421041='';if(_0x2be891){if(_0x2be891[_0x570b6a(0x190)]){let _0x332d42=_0x2be891['codec_name']['toLowerCase']();(_0x332d42[_0x570b6a(0x173)](_0x570b6a(0x166))!=-0x1||_0x332d42[_0x570b6a(0x173)]('h.264')!=-0x1)&&(_0x421041='H264'),_0x332d42['indexOf'](_0x570b6a(0x141))!=-0x1&&(_0x421041=_0x570b6a(0x131));}if(!_0x421041&&_0x2be891[_0x570b6a(0x117)]){let _0x247066=_0x2be891[_0x570b6a(0x117)][_0x570b6a(0x13c)]();(_0x247066['indexOf'](_0x570b6a(0x166))!=-0x1||_0x247066[_0x570b6a(0x173)](_0x570b6a(0x16d))!=-0x1)&&(_0x421041=_0x570b6a(0x175)),(_0x247066[_0x570b6a(0x173)]('hevc')!=-0x1||_0x247066['indexOf'](_0x570b6a(0x150))!=-0x1)&&(_0x421041=_0x570b6a(0x131));}}!_0x421041&&(console[_0x570b6a(0x11e)](_0x570b6a(0x142)),_0x421041='HEVC');let _0x1ea58d={'decoderCommand':'','encoderName':_0x570b6a(0x17e),'coderName':_0x570b6a(0x159)},_0x44660b=dbConfigTable[_0x570b6a(0x13b)](_0x26c7bc,_0x570b6a(0x114)),_0x58efa4='';if(_0x421041==_0x570b6a(0x131)){let _0x5035fd=dbConfigTable['findByTitle'](_0x26c7bc,_0x570b6a(0x184));_0x5035fd&&_0x5035fd[_0x570b6a(0x133)]&&(_0x58efa4=_0x5035fd[_0x570b6a(0x133)]);}else{if(_0x421041=='H264'){let _0x2ef5d2=dbConfigTable[_0x570b6a(0x13b)](_0x26c7bc,_0x570b6a(0x179));_0x2ef5d2&&_0x2ef5d2['value']&&(_0x58efa4=_0x2ef5d2[_0x570b6a(0x133)]);}}if(_0x44660b&&_0x44660b[_0x570b6a(0x133)])try{let _0x2c0b02=[];_0x44660b=JSON['parse'](_0x44660b[_0x570b6a(0x133)]);for(let _0x25b03b of _0x44660b){_0x25b03b[_0x570b6a(0x180)]==_0x421041&&_0x2c0b02[_0x570b6a(0x183)](_0x25b03b);}if(_0x2c0b02[_0x570b6a(0x194)]>0x0){if(!_0x58efa4)_0x1ea58d=_0x2c0b02[0x0];else{let _0x19f9e1=![];for(let _0x5ac869 of _0x2c0b02){if(_0x5ac869['coderName']==_0x58efa4){_0x1ea58d=_0x5ac869,_0x19f9e1=!![];break;}}!_0x19f9e1&&(console[_0x570b6a(0x11e)](_0x570b6a(0x153),_0x2c0b02[0x0]),_0x1ea58d=_0x2c0b02[0x0]);}}}catch(_0x4827e7){console[_0x570b6a(0x11e)](_0x4827e7);}return _0x1ea58d;},transCodeUtil['getReadRate']=function(_0x1304d7){const _0x22ff28=_0x47301d;let _0xc4930e=0x5,_0x5040e0=_0xc4930e,_0x29c0d8=dbConfigTable[_0x22ff28(0x13b)](_0x1304d7,'transCodeParams-readrate');if(_0x29c0d8&&_0x29c0d8[_0x22ff28(0x133)])try{_0x5040e0=parseInt(_0x29c0d8[_0x22ff28(0x133)]),(_0x5040e0<0x2||_0x5040e0>0x1e)&&(_0x5040e0=_0xc4930e);}catch(_0x31efeb){return _0xc4930e;}return _0x5040e0;},transCodeUtil['getPixFmt']=function(_0x96d720,_0x298ef5){return'yuv420p';},transCodeUtil[_0x47301d(0x16e)]=function(_0x148909,_0x524eb2){const _0x29858e=_0x47301d;let _0x24ab88=_0x148909[_0x29858e(0x157)];if(_0x24ab88){_0x24ab88=_0x24ab88['trim']();if(pixFormatList[_0x524eb2]){if(!pixFormatList[_0x524eb2][_0x29858e(0x115)](_0x24ab88))return![];}}return!![];},module[_0x47301d(0x12b)]=transCodeUtil;