const _0x13d5db=_0x43a7;(function(_0x4c7241,_0x4ebeb1){const _0x59e0bc=_0x43a7,_0x468f04=_0x4c7241();while(!![]){try{const _0x35640c=-parseInt(_0x59e0bc(0x13b))/0x1+parseInt(_0x59e0bc(0x15c))/0x2*(parseInt(_0x59e0bc(0x1a0))/0x3)+parseInt(_0x59e0bc(0x15d))/0x4*(-parseInt(_0x59e0bc(0x11b))/0x5)+parseInt(_0x59e0bc(0x198))/0x6*(parseInt(_0x59e0bc(0x197))/0x7)+-parseInt(_0x59e0bc(0x185))/0x8+parseInt(_0x59e0bc(0x131))/0x9*(parseInt(_0x59e0bc(0x14d))/0xa)+parseInt(_0x59e0bc(0x120))/0xb*(-parseInt(_0x59e0bc(0x135))/0xc);if(_0x35640c===_0x4ebeb1)break;else _0x468f04['push'](_0x468f04['shift']());}catch(_0x516c9f){_0x468f04['push'](_0x468f04['shift']());}}}(_0xc24d,0x4f92d));let path=require(_0x13d5db(0x136)),fs=require('fs');const Database=require(_0x13d5db(0x16b));function _0xc24d(){const _0x22c9cc=['getPrivateDbPath','../db/dbFileIndexTable','codec_long_name','string','gray10le','../express-server/utils/fileUtils','decoderType','120051HztMnz','parse','superfast','yuyv422','973572fiIHuT','path','yuvj444p','hevc','getTokenObjByToken','../libs/nasTrans','374231TwIOcc','filename','then','medium','getTranscodeSpeed','getScaleOption','err','yuv444p16le','duration','CPU','yuv420p','index\x20id\x20does\x20not\x20exist','h.264','getIndexTableNameByType','getDurationFromStream','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','yuv444p10le','sha256','320QvfJQE','decryptString','log','dealFFmpegPath','streams','dxva2_vld','filePath','r_frame_rate','spaceId','codec_name','toLowerCase','input','yuv420p10le','findByTitle','../db/dbConfigTable','1766OMcvcn','116IJCfAI','yuv444p','H264','trim','ultrafast','nv12','index\x20isn\x27t\x20video','platform','codec_type','child_process','slow','transCodeParams-CoderNameHevc','push','yuv422p','better-sqlite3','index\x20does\x20not\x20exist','prepare','transcodeSpeed','space\x20does\x20not\x20exist','p010le','parseVideoWH','type','h264_qsv','indexOf','coderName','stat','y210le','p016le','includes','getCrf','getCoderConfig','bgr0','libx264','crf','nv16','cuda','length','undefined','split','pix_fmt','673984aZnEmb','subtitle','ceil','stream_info','h264','bit_rate','getReadRate','scale=-2:','getVideoBitrate','exports',':-2','scale=','HEVC','../express-server/utils/cryptoUtils','avg_frame_rate','nvenc_h264','pragma','folder_path','114107ZdkMBT','174uIFYdG','qsv','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','get','file\x20does\x20not\x20exist','error','getFps','value','1209JfASjI','win32','39245upHoRM','high\x20efficiency\x20video\x20coding','transCodeParams-coderList','indexId','spaceIndexId','33gmJDpB','parseSubtitle','decodePath','decoderSupportPixFormat','tokenPwdEncryptKey','join','d3d11','journal_mode\x20=\x20WAL','ffprobe','veryfast'];_0xc24d=function(){return _0x22c9cc;};return _0xc24d();}let transCodeUtil={};const config=require('../myConfig/config');let fileUtil=require(_0x13d5db(0x12f));const dbConfigTable=require(_0x13d5db(0x15b)),chldProcess=require(_0x13d5db(0x166));let nasTrans=require(_0x13d5db(0x13a)),FFmpeg=nasTrans['FFmpeg'];const dbFileIndexTable=require(_0x13d5db(0x12b));let dbPrivateSpaceTable=require('../db/dbPrivateSpaceTable'),sha256=require(_0x13d5db(0x14c)),cryptoUtils=require(_0x13d5db(0x192));const os=require('os');let platform=os[_0x13d5db(0x164)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require('./videoStreamUtil');let pixFormatList={'h264_nvenc':[_0x13d5db(0x145),'nv12',_0x13d5db(0x170),_0x13d5db(0x15e),_0x13d5db(0x178),'yuv444p16le',_0x13d5db(0x17c),'rgb0',_0x13d5db(0x180),_0x13d5db(0x126)],'nvenc_h264':[_0x13d5db(0x145),'nv12',_0x13d5db(0x170),_0x13d5db(0x15e),'p016le',_0x13d5db(0x142),_0x13d5db(0x17c),'rgb0',_0x13d5db(0x180),'d3d11'],'h264_qsv':[_0x13d5db(0x162),'p010le',_0x13d5db(0x199),_0x13d5db(0x145)],'hevc_qsv':['nv12',_0x13d5db(0x170),_0x13d5db(0x134),_0x13d5db(0x177),_0x13d5db(0x199)],'h264_mf':['nv12',_0x13d5db(0x145)],'h264_amf':['nv12',_0x13d5db(0x145),_0x13d5db(0x126),_0x13d5db(0x152)],'libopenh264':[_0x13d5db(0x145)],'libx264':[_0x13d5db(0x145),_0x13d5db(0x16a),'yuvj422p',_0x13d5db(0x15e),_0x13d5db(0x137),_0x13d5db(0x162),_0x13d5db(0x17f),'nv21',_0x13d5db(0x159),'yuv422p10le',_0x13d5db(0x14b),'nv20le','gray',_0x13d5db(0x12e)],'h264_vaapi':['vaapi_vld','yuv420p'],'h264_cuvid':[_0x13d5db(0x180),_0x13d5db(0x162),_0x13d5db(0x170),_0x13d5db(0x178)],'hevc_cuvid':[_0x13d5db(0x180),_0x13d5db(0x162),_0x13d5db(0x170),_0x13d5db(0x178)]};function _0x43a7(_0x2a93a4,_0x4c41c5){const _0xc24d4b=_0xc24d();return _0x43a7=function(_0x43a7fe,_0x376dc3){_0x43a7fe=_0x43a7fe-0x11b;let _0x36f495=_0xc24d4b[_0x43a7fe];return _0x36f495;},_0x43a7(_0x2a93a4,_0x4c41c5);}function getPwdFromToken(_0x4c2856,_0xc8608b,_0x5beb4c){const _0x371ed3=_0x13d5db;let _0x3d6efc=dbPrivateSpaceTable[_0x371ed3(0x139)](_0xc8608b,_0x4c2856);if(!_0x3d6efc){_0x5beb4c('token\x20expired',''),console[_0x371ed3(0x14f)]('token\x20expired',_0x4c2856);return;}let _0x20a894=_0x3d6efc['pwd'];cryptoUtils[_0x371ed3(0x14e)](config[_0x371ed3(0x124)],_0x20a894)[_0x371ed3(0x13d)](_0xf46776=>{_0x5beb4c(![],_0xf46776);});}transCodeUtil[_0x13d5db(0x150)]=function(_0x203900){const _0x5c7219=_0x13d5db;if(typeof _0x203900!==_0x5c7219(0x12d))return _0x203900;return platform==_0x5c7219(0x1a1)&&_0x203900[_0x5c7219(0x181)]>0x103?'\x5c\x5c?\x5c'+_0x203900:_0x203900;},transCodeUtil['parseVideoFullPath']=function(_0x4039ee,_0x3f8915,_0x3548f3){return new Promise((_0xe3926c,_0x44281b)=>{const _0x3eb057=_0x43a7;if(_0x3548f3['indexId']&&!_0x3548f3[_0x3eb057(0x155)]){let _0x13f48a=dbFileIndexTable[_0x3eb057(0x148)](_0x3548f3['serverType']),_0x1ccfe9=dbFileIndexTable['getById'](_0x4039ee,_0x3548f3[_0x3eb057(0x11e)],_0x13f48a);if(!_0x1ccfe9)return _0x44281b(_0x3eb057(0x16c));if(_0x1ccfe9[_0x3eb057(0x172)]!=0x2)return _0x44281b(_0x3eb057(0x163));if(_0x1ccfe9[_0x3eb057(0x188)]==_0x3eb057(0x182))return _0x44281b('stream\x20info\x20is\x20null');let _0x3f3e00=JSON['parse'](_0x1ccfe9[_0x3eb057(0x188)]),_0x2a6355=_0x1ccfe9['path']+path['sep']+_0x1ccfe9[_0x3eb057(0x13c)];return _0xe3926c({'fullpath':_0x2a6355,'streamList':_0x3f3e00,'duration':_0x1ccfe9[_0x3eb057(0x143)]});}else{if(_0x3548f3[_0x3eb057(0x153)]&&!_0x3548f3['spaceId']){let _0x3e7403=fileUtil['decodePath'](_0x3548f3[_0x3eb057(0x153)]);fs['stat'](_0x3e7403,(_0x426aff,_0x54516b)=>{const _0x2df2f2=_0x3eb057;if(_0x426aff)return _0x44281b(_0x2df2f2(0x19c));else FFmpeg()[_0x2df2f2(0x158)](transCodeUtil[_0x2df2f2(0x150)](_0x3e7403))[_0x2df2f2(0x128)]((_0x141ffd,_0xe5e63)=>{const _0x3b7b94=_0x2df2f2;if(_0x141ffd)return console[_0x3b7b94(0x14f)](_0x141ffd),_0x44281b('stream读取失败');else{let _0x51c354=videoStreamUtil[_0x3b7b94(0x149)](_0xe5e63),_0x12005f=_0xe5e63[_0x3b7b94(0x151)];return _0xe3926c({'fullpath':_0x3e7403,'streamList':_0x12005f,'duration':_0x51c354});}});});}else{if(_0x3548f3['spaceId']){let _0x417dae=_0x3548f3[_0x3eb057(0x155)],_0x4157b0=dbPrivateSpaceTable['getById'](_0x3f8915,_0x417dae);if(!_0x4157b0)return _0x44281b(_0x3eb057(0x16f));let _0x52948f=path[_0x3eb057(0x125)](_0x4157b0[_0x3eb057(0x196)],fileUtil[_0x3eb057(0x122)](_0x3548f3[_0x3eb057(0x153)]));fs[_0x3eb057(0x176)](_0x52948f,(_0x4d6787,_0x337747)=>{const _0x21ab50=_0x3eb057;if(_0x4d6787)return _0x44281b(_0x21ab50(0x19c));getPwdFromToken(_0x3548f3['spaceToken'],_0x3f8915,(_0x168701,_0x3162da)=>{const _0x3dc562=_0x21ab50;if(_0x168701)return _0x44281b(_0x3dc562(0x141));let _0x5e1d8b=config[_0x3dc562(0x12a)](_0x4157b0[_0x3dc562(0x196)]),_0x2d284f=new Database(_0x5e1d8b,{});_0x2d284f[_0x3dc562(0x195)](_0x3dc562(0x127));let _0x345066=_0x2d284f[_0x3dc562(0x16d)](_0x3dc562(0x19a))[_0x3dc562(0x19b)](_0x3548f3[_0x3dc562(0x11f)]);if(!_0x345066||!_0x345066[_0x3dc562(0x188)])return _0x44281b(_0x3dc562(0x146));_0x2d284f['close']();let _0x326965=JSON['parse'](_0x345066[_0x3dc562(0x188)]);return _0xe3926c({'fullpath':_0x52948f,'streamList':_0x326965,'needDecrypt':!![],'pwd':_0x3162da,'duration':_0x345066[_0x3dc562(0x143)]});});});}}}});},transCodeUtil[_0x13d5db(0x19e)]=function(_0x3f6cca){const _0x33bd3f=_0x13d5db;let _0x159e68=0x1e,_0x3468ef=![];try{if(_0x3f6cca[_0x33bd3f(0x154)]){let _0x4d113f=_0x3f6cca[_0x33bd3f(0x154)][_0x33bd3f(0x183)]('/');(_0x4d113f[_0x33bd3f(0x181)]=0x2)&&(_0x3468ef=Math[_0x33bd3f(0x187)](parseInt(_0x4d113f[0x0])/parseInt(_0x4d113f[0x1])));}if(!_0x3468ef){if(_0x3f6cca[_0x33bd3f(0x193)]){let _0x5c5512=_0x3f6cca[_0x33bd3f(0x193)][_0x33bd3f(0x183)]('/');(_0x5c5512[_0x33bd3f(0x181)]=0x2)&&(_0x3468ef=Math[_0x33bd3f(0x187)](parseInt(_0x5c5512[0x0])/parseInt(_0x5c5512[0x1])));}}}catch(_0x292e92){console['log'](_0x33bd3f(0x19d),_0x292e92);}return _0x3468ef&&_0x3468ef<=0x3c&&(_0x159e68=_0x3468ef),_0x159e68;},transCodeUtil[_0x13d5db(0x121)]=function(_0x1b1d2a,_0x1261e3){const _0x5e38b9=_0x13d5db;let _0x4e4ca2=[];for(let _0xb454c3=0x0;_0xb454c3<_0x1b1d2a[_0x5e38b9(0x181)];_0xb454c3++){let _0x3a4911=_0x1b1d2a[_0xb454c3];_0x3a4911[_0x5e38b9(0x165)]==_0x5e38b9(0x186)&&_0x4e4ca2[_0x5e38b9(0x169)](_0x3a4911);}if(_0x4e4ca2[_0x5e38b9(0x181)]>_0x1261e3)return _0x4e4ca2[_0x1261e3];return null;},transCodeUtil['parseStreamList']=function(_0x171842){const _0x9cdd7d=_0x13d5db;let _0x811242=videoStreamUtil[_0x9cdd7d(0x171)](_0x171842);return _0x811242;},transCodeUtil[_0x13d5db(0x140)]=function(_0x33f247,_0x3d661c,_0x3cb4f3){const _0x194ecb=_0x13d5db;let _0x24ac6a=null;if(_0x3d661c&&_0x3cb4f3&&_0x33f247)_0x33f247>_0x3d661c&&_0x33f247>_0x3cb4f3&&(_0x33f247=_0x3d661c>_0x3cb4f3?_0x3d661c:_0x3cb4f3),_0x3d661c>_0x3cb4f3?_0x24ac6a=_0x194ecb(0x190)+_0x33f247+_0x194ecb(0x18f):_0x24ac6a=_0x194ecb(0x18c)+_0x33f247;else{}return _0x24ac6a;},transCodeUtil[_0x13d5db(0x18d)]=function(_0x2f3060,_0x22d00c){const _0x5e3fe8=_0x13d5db;return _0x22d00c==-0x1&&(_0x2f3060&&_0x2f3060[_0x5e3fe8(0x18a)]&&_0x2f3060[_0x5e3fe8(0x18a)]>0xf4240&&_0x2f3060[_0x5e3fe8(0x18a)]!='N/A'?(_0x22d00c=_0x2f3060[_0x5e3fe8(0x18a)]/0x3e8,_0x22d00c>BITRATE_MAX&&(_0x22d00c=BITRATE_MAX)):_0x22d00c=BITRATE_DEFAULT),_0x22d00c;},transCodeUtil[_0x13d5db(0x17a)]=function(_0x452689){const _0xf6ae31=_0x13d5db;let _0x3d82b9=0x17,_0x5388e3=dbConfigTable[_0xf6ae31(0x15a)](_0x452689,_0xf6ae31(0x17e));return _0x5388e3&&(_0x5388e3[_0xf6ae31(0x19f)]>=0x1&&_0x5388e3[_0xf6ae31(0x19f)]<=0x33&&(_0x3d82b9=_0x5388e3[_0xf6ae31(0x19f)])),_0x3d82b9;},transCodeUtil[_0x13d5db(0x13f)]=function(_0x4fb47a,_0x14d9cc){const _0x5a3267=_0x13d5db;let _0x2aa519=dbConfigTable['findByTitle'](_0x4fb47a,_0x5a3267(0x16e)),_0x290c61=[_0x5a3267(0x161),'fast',_0x5a3267(0x13e),_0x5a3267(0x167)];function _0x82f687(_0x59d7ab){const _0x204779=_0x5a3267;if((_0x14d9cc=='h264_nvenc'||_0x14d9cc==_0x204779(0x194))&&_0x59d7ab==_0x204779(0x161))return'p1';if(_0x14d9cc==_0x204779(0x173)&&(_0x59d7ab==_0x204779(0x161)||_0x59d7ab==_0x204779(0x133)))return _0x204779(0x129);return _0x59d7ab;}return _0x2aa519&&_0x2aa519['value']&&_0x290c61[_0x5a3267(0x179)](_0x2aa519[_0x5a3267(0x19f)])?_0x82f687(_0x2aa519[_0x5a3267(0x19f)]):_0x5a3267(0x13e);},transCodeUtil[_0x13d5db(0x17b)]=function(_0x9999d1,_0x88a0a1){const _0x802ab=_0x13d5db;let _0x28bdb6='';if(_0x88a0a1){if(_0x88a0a1[_0x802ab(0x156)]){let _0xb192e8=_0x88a0a1[_0x802ab(0x156)][_0x802ab(0x157)]();(_0xb192e8[_0x802ab(0x174)](_0x802ab(0x189))!=-0x1||_0xb192e8['indexOf'](_0x802ab(0x147))!=-0x1)&&(_0x28bdb6=_0x802ab(0x15f)),_0xb192e8[_0x802ab(0x174)](_0x802ab(0x138))!=-0x1&&(_0x28bdb6=_0x802ab(0x191));}if(!_0x28bdb6&&_0x88a0a1['codec_long_name']){let _0x26acac=_0x88a0a1[_0x802ab(0x12c)][_0x802ab(0x157)]();(_0x26acac[_0x802ab(0x174)](_0x802ab(0x189))!=-0x1||_0x26acac['indexOf']('h.264')!=-0x1)&&(_0x28bdb6=_0x802ab(0x15f)),(_0x26acac[_0x802ab(0x174)](_0x802ab(0x138))!=-0x1||_0x26acac[_0x802ab(0x174)](_0x802ab(0x11c))!=-0x1)&&(_0x28bdb6=_0x802ab(0x191));}}!_0x28bdb6&&(console['log']('video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc'),_0x28bdb6=_0x802ab(0x191));let _0x4520a1={'decoderCommand':'','encoderName':_0x802ab(0x17d),'coderName':_0x802ab(0x144)},_0x487a8a=dbConfigTable[_0x802ab(0x15a)](_0x9999d1,_0x802ab(0x11d)),_0x2f9e44='';if(_0x28bdb6=='HEVC'){let _0x30f98b=dbConfigTable[_0x802ab(0x15a)](_0x9999d1,_0x802ab(0x168));_0x30f98b&&_0x30f98b[_0x802ab(0x19f)]&&(_0x2f9e44=_0x30f98b[_0x802ab(0x19f)]);}else{if(_0x28bdb6==_0x802ab(0x15f)){let _0x1feb25=dbConfigTable[_0x802ab(0x15a)](_0x9999d1,'transCodeParams-CoderNameH264');_0x1feb25&&_0x1feb25[_0x802ab(0x19f)]&&(_0x2f9e44=_0x1feb25['value']);}}if(_0x487a8a&&_0x487a8a[_0x802ab(0x19f)])try{let _0x1d0968=[];_0x487a8a=JSON[_0x802ab(0x132)](_0x487a8a[_0x802ab(0x19f)]);for(let _0x394e24 of _0x487a8a){_0x394e24[_0x802ab(0x130)]==_0x28bdb6&&_0x1d0968[_0x802ab(0x169)](_0x394e24);}if(_0x1d0968[_0x802ab(0x181)]>0x0){if(!_0x2f9e44)_0x4520a1=_0x1d0968[0x0];else{let _0x144565=![];for(let _0x1326b8 of _0x1d0968){if(_0x1326b8[_0x802ab(0x175)]==_0x2f9e44){_0x4520a1=_0x1326b8,_0x144565=!![];break;}}!_0x144565&&(console[_0x802ab(0x14f)](_0x802ab(0x14a),_0x1d0968[0x0]),_0x4520a1=_0x1d0968[0x0]);}}}catch(_0x2eeddd){console[_0x802ab(0x14f)](_0x2eeddd);}return _0x4520a1;},transCodeUtil[_0x13d5db(0x18b)]=function(_0x4bb41f){const _0x114a18=_0x13d5db;let _0x344814=0x5,_0x4e7a78=_0x344814,_0x49e057=dbConfigTable['findByTitle'](_0x4bb41f,'transCodeParams-readrate');if(_0x49e057&&_0x49e057[_0x114a18(0x19f)])try{_0x4e7a78=parseInt(_0x49e057[_0x114a18(0x19f)]),(_0x4e7a78<0x2||_0x4e7a78>0x1e)&&(_0x4e7a78=_0x344814);}catch(_0xe4c2ca){return _0x344814;}return _0x4e7a78;},transCodeUtil['getPixFmt']=function(_0x41d7fd,_0x296a19){return'yuv420p';},transCodeUtil[_0x13d5db(0x123)]=function(_0x3b0101,_0x3a8ec9){const _0x2b2f13=_0x13d5db;let _0x3dc69f=_0x3b0101[_0x2b2f13(0x184)];if(_0x3dc69f){_0x3dc69f=_0x3dc69f[_0x2b2f13(0x160)]();if(pixFormatList[_0x3a8ec9]){if(!pixFormatList[_0x3a8ec9]['includes'](_0x3dc69f))return![];}}return!![];},module[_0x13d5db(0x18e)]=transCodeUtil;