const _0x22baff=_0x1b9a;(function(_0x5f50ee,_0xd2c3e3){const _0x17100c=_0x1b9a,_0xd4b256=_0x5f50ee();while(!![]){try{const _0x15d928=-parseInt(_0x17100c(0x158))/0x1*(parseInt(_0x17100c(0x13b))/0x2)+parseInt(_0x17100c(0x12d))/0x3+-parseInt(_0x17100c(0x183))/0x4*(-parseInt(_0x17100c(0x170))/0x5)+-parseInt(_0x17100c(0x15f))/0x6+parseInt(_0x17100c(0x19a))/0x7+parseInt(_0x17100c(0x14b))/0x8*(-parseInt(_0x17100c(0x16c))/0x9)+parseInt(_0x17100c(0x17a))/0xa*(parseInt(_0x17100c(0x17e))/0xb);if(_0x15d928===_0xd2c3e3)break;else _0xd4b256['push'](_0xd4b256['shift']());}catch(_0x20a73b){_0xd4b256['push'](_0xd4b256['shift']());}}}(_0x127f,0xb4e17));let path=require('path'),fs=require('fs');const Database=require(_0x22baff(0x17d));let transCodeUtil={};const config=require(_0x22baff(0x120));let fileUtil=require('../express-server/utils/fileUtils');const dbConfigTable=require(_0x22baff(0x187)),chldProcess=require('child_process');let nasTrans=require(_0x22baff(0x17f)),FFmpeg=nasTrans['FFmpeg'];const dbFileIndexTable=require('../db/dbFileIndexTable');let dbPrivateSpaceTable=require(_0x22baff(0x14d)),sha256=require(_0x22baff(0x123)),cryptoUtils=require('../express-server/utils/cryptoUtils');function _0x1b9a(_0x424060,_0x343e24){const _0x127f26=_0x127f();return _0x1b9a=function(_0x1b9a66,_0x24d44b){_0x1b9a66=_0x1b9a66-0x118;let _0x211d95=_0x127f26[_0x1b9a66];return _0x211d95;},_0x1b9a(_0x424060,_0x343e24);}const os=require('os');function _0x127f(){const _0x33d1b5=['getPixFmt','stream\x20info\x20is\x20null','22272JqLaUB','bit_rate','../db/dbPrivateSpaceTable','filename','space\x20does\x20not\x20exist','medium','yuv422p10le','getScaleOption','avg_frame_rate','yuv420p','sep','token\x20expired','codec_name','21QBaWeh','nv12','getDurationFromStream','getCrf','split','yuvj422p','codec_long_name','8256480yAWRXf','veryfast','yuv444p10le','gray10le','parseVideoWH','pwd','folder_path','getTranscodeSpeed','high\x20efficiency\x20video\x20coding','undefined','rgb0','ceil','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','3555BWSdqC','h.264','stream_info','pix_fmt','5FqcKtn','journal_mode\x20=\x20WAL','err','duration','transCodeParams-CoderNameH264','nv20le','error','getIndexTableNameByType','stat','parse','20ntTrUJ','parseSubtitle','h264','better-sqlite3','1834195NHLuIN','../libs/nasTrans','value','includes','yuvj444p','4105744zQSUPv','y210le','p010le','gray','../db/dbConfigTable','r_frame_rate','type','indexOf','p016le','findByTitle','dxva2_vld','superfast','close','qsv','transCodeParams-readrate','\x5c\x5c?\x5c','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','CPU','d3d11','scale=','serverType','./videoStreamUtil','vaapi_vld','8563632SDLFlu','dealFFmpegPath','yuv420p10le','nv21','fast','getFps','decryptString','filePath','nvenc_h264','decodePath','get','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','ultrafast','../myConfig/config','platform','file\x20does\x20not\x20exist','sha256','getCoderConfig','index\x20id\x20does\x20not\x20exist','nv16','length','yuv444p','yuyv422','tokenPwdEncryptKey','then','toLowerCase','2127402hfMFDn','getReadRate','N/A','log','yuv444p16le','subtitle','transCodeParams-coderList','ffprobe','trim','bgr0','codec_type','parseStreamList','cuda','transcodeSpeed','7218vtcnpL','input','push','decoderType','indexId','h264_qsv','spaceId',':-2','prepare','spaceIndexId','getById','H264','spaceToken','HEVC'];_0x127f=function(){return _0x33d1b5;};return _0x127f();}let platform=os[_0x22baff(0x121)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x22baff(0x198));let pixFormatList={'h264_nvenc':[_0x22baff(0x154),_0x22baff(0x159),_0x22baff(0x185),_0x22baff(0x128),'p016le',_0x22baff(0x131),_0x22baff(0x136),_0x22baff(0x169),_0x22baff(0x139),_0x22baff(0x195)],'nvenc_h264':[_0x22baff(0x154),_0x22baff(0x159),'p010le',_0x22baff(0x128),_0x22baff(0x18b),_0x22baff(0x131),_0x22baff(0x136),_0x22baff(0x169),_0x22baff(0x139),_0x22baff(0x195)],'h264_qsv':[_0x22baff(0x159),'p010le',_0x22baff(0x190),'yuv420p'],'hevc_qsv':[_0x22baff(0x159),_0x22baff(0x185),_0x22baff(0x129),_0x22baff(0x184),_0x22baff(0x190)],'h264_mf':[_0x22baff(0x159),_0x22baff(0x154)],'h264_amf':['nv12',_0x22baff(0x154),_0x22baff(0x195),_0x22baff(0x18d)],'libopenh264':[_0x22baff(0x154)],'libx264':[_0x22baff(0x154),'yuv422p',_0x22baff(0x15d),'yuv444p',_0x22baff(0x182),_0x22baff(0x159),_0x22baff(0x126),_0x22baff(0x19d),_0x22baff(0x19c),_0x22baff(0x151),_0x22baff(0x161),_0x22baff(0x175),_0x22baff(0x186),_0x22baff(0x162)],'h264_vaapi':[_0x22baff(0x199),_0x22baff(0x154)],'h264_cuvid':['cuda',_0x22baff(0x159),_0x22baff(0x185),_0x22baff(0x18b)],'hevc_cuvid':['cuda',_0x22baff(0x159),_0x22baff(0x185),'p016le']};function getPwdFromToken(_0x22ead9,_0x1fd780,_0x29cda3){const _0x4304af=_0x22baff;let _0x39654c=dbPrivateSpaceTable['getTokenObjByToken'](_0x1fd780,_0x22ead9);if(!_0x39654c){_0x29cda3(_0x4304af(0x156),''),console[_0x4304af(0x130)]('token\x20expired',_0x22ead9);return;}let _0x48f156=_0x39654c[_0x4304af(0x164)];cryptoUtils[_0x4304af(0x119)](config[_0x4304af(0x12a)],_0x48f156)[_0x4304af(0x12b)](_0x3cbde1=>{_0x29cda3(![],_0x3cbde1);});}transCodeUtil[_0x22baff(0x19b)]=function(_0x2613df){const _0x45acbb=_0x22baff;if(typeof _0x2613df!=='string')return _0x2613df;return platform=='win32'&&_0x2613df['length']>0x103?_0x45acbb(0x192)+_0x2613df:_0x2613df;},transCodeUtil['parseVideoFullPath']=function(_0x454b39,_0x1374d8,_0x8e79bb){return new Promise((_0xae7a0c,_0x580434)=>{const _0x477769=_0x1b9a;if(_0x8e79bb[_0x477769(0x13f)]&&!_0x8e79bb[_0x477769(0x141)]){let _0x564b9f=dbFileIndexTable[_0x477769(0x177)](_0x8e79bb[_0x477769(0x197)]),_0x38307b=dbFileIndexTable['getById'](_0x454b39,_0x8e79bb['indexId'],_0x564b9f);if(!_0x38307b)return _0x580434('index\x20does\x20not\x20exist');if(_0x38307b[_0x477769(0x189)]!=0x2)return _0x580434('index\x20isn\x27t\x20video');if(_0x38307b[_0x477769(0x16e)]==_0x477769(0x168))return _0x580434(_0x477769(0x14a));let _0x452f42=JSON[_0x477769(0x179)](_0x38307b[_0x477769(0x16e)]),_0xf536a2=_0x38307b['path']+path[_0x477769(0x155)]+_0x38307b[_0x477769(0x14e)];return _0xae7a0c({'fullpath':_0xf536a2,'streamList':_0x452f42,'duration':_0x38307b[_0x477769(0x173)]});}else{if(_0x8e79bb[_0x477769(0x11a)]&&!_0x8e79bb[_0x477769(0x141)]){let _0x4341f3=fileUtil[_0x477769(0x11c)](_0x8e79bb[_0x477769(0x11a)]);fs[_0x477769(0x178)](_0x4341f3,(_0x3f263d,_0x2acada)=>{const _0x57b49e=_0x477769;if(_0x3f263d)return _0x580434(_0x57b49e(0x122));else FFmpeg()[_0x57b49e(0x13c)](transCodeUtil[_0x57b49e(0x19b)](_0x4341f3))[_0x57b49e(0x134)]((_0x4abd76,_0x42c189)=>{const _0x366fe1=_0x57b49e;if(_0x4abd76)return console[_0x366fe1(0x130)](_0x4abd76),_0x580434('stream读取失败');else{let _0x154857=videoStreamUtil[_0x366fe1(0x15a)](_0x42c189),_0x19ff60=_0x42c189['streams'];return _0xae7a0c({'fullpath':_0x4341f3,'streamList':_0x19ff60,'duration':_0x154857});}});});}else{if(_0x8e79bb[_0x477769(0x141)]){let _0x20867d=_0x8e79bb[_0x477769(0x141)],_0x2a0c52=dbPrivateSpaceTable[_0x477769(0x145)](_0x1374d8,_0x20867d);if(!_0x2a0c52)return _0x580434(_0x477769(0x14f));let _0x17aff9=path['join'](_0x2a0c52[_0x477769(0x165)],fileUtil[_0x477769(0x11c)](_0x8e79bb[_0x477769(0x11a)]));fs[_0x477769(0x178)](_0x17aff9,(_0x4d9381,_0x146c9d)=>{const _0x45c9f0=_0x477769;if(_0x4d9381)return _0x580434(_0x45c9f0(0x122));getPwdFromToken(_0x8e79bb[_0x45c9f0(0x147)],_0x1374d8,(_0xb86e18,_0x2ee5aa)=>{const _0x179063=_0x45c9f0;if(_0xb86e18)return _0x580434(_0x179063(0x172));let _0x5a3ff5=config['getPrivateDbPath'](_0x2a0c52[_0x179063(0x165)]),_0x585caf=new Database(_0x5a3ff5,{});_0x585caf['pragma'](_0x179063(0x171));let _0x42438d=_0x585caf[_0x179063(0x143)](_0x179063(0x16b))[_0x179063(0x11d)](_0x8e79bb[_0x179063(0x144)]);if(!_0x42438d||!_0x42438d[_0x179063(0x16e)])return _0x580434(_0x179063(0x125));_0x585caf[_0x179063(0x18f)]();let _0x224584=JSON[_0x179063(0x179)](_0x42438d['stream_info']);return _0xae7a0c({'fullpath':_0x17aff9,'streamList':_0x224584,'needDecrypt':!![],'pwd':_0x2ee5aa,'duration':_0x42438d[_0x179063(0x173)]});});});}}}});},transCodeUtil[_0x22baff(0x118)]=function(_0x4b0516){const _0x419687=_0x22baff;let _0x146027=0x1e,_0x49b536=![];try{if(_0x4b0516[_0x419687(0x188)]){let _0xc496b1=_0x4b0516[_0x419687(0x188)][_0x419687(0x15c)]('/');(_0xc496b1[_0x419687(0x127)]=0x2)&&(_0x49b536=Math[_0x419687(0x16a)](parseInt(_0xc496b1[0x0])/parseInt(_0xc496b1[0x1])));}if(!_0x49b536){if(_0x4b0516[_0x419687(0x153)]){let _0x1a6a5e=_0x4b0516['avg_frame_rate'][_0x419687(0x15c)]('/');(_0x1a6a5e['length']=0x2)&&(_0x49b536=Math[_0x419687(0x16a)](parseInt(_0x1a6a5e[0x0])/parseInt(_0x1a6a5e[0x1])));}}}catch(_0xe3e0bf){console[_0x419687(0x130)](_0x419687(0x176),_0xe3e0bf);}return _0x49b536&&_0x49b536<=0x3c&&(_0x146027=_0x49b536),_0x146027;},transCodeUtil[_0x22baff(0x17b)]=function(_0x2bad38,_0x594370){const _0x10edf1=_0x22baff;let _0xa466e=[];for(let _0x39fcf0=0x0;_0x39fcf0<_0x2bad38[_0x10edf1(0x127)];_0x39fcf0++){let _0x1ac464=_0x2bad38[_0x39fcf0];_0x1ac464[_0x10edf1(0x137)]==_0x10edf1(0x132)&&_0xa466e[_0x10edf1(0x13d)](_0x1ac464);}if(_0xa466e[_0x10edf1(0x127)]>_0x594370)return _0xa466e[_0x594370];return null;},transCodeUtil[_0x22baff(0x138)]=function(_0x425d3f){const _0x136eeb=_0x22baff;let _0x48d318=videoStreamUtil[_0x136eeb(0x163)](_0x425d3f);return _0x48d318;},transCodeUtil[_0x22baff(0x152)]=function(_0x1d5be1,_0x8a1aa0,_0x15f9f8){const _0x509ae2=_0x22baff;let _0xfd1be8=null;if(_0x8a1aa0&&_0x15f9f8&&_0x1d5be1)_0x1d5be1>_0x8a1aa0&&_0x1d5be1>_0x15f9f8&&(_0x1d5be1=_0x8a1aa0>_0x15f9f8?_0x8a1aa0:_0x15f9f8),_0x8a1aa0>_0x15f9f8?_0xfd1be8=_0x509ae2(0x196)+_0x1d5be1+_0x509ae2(0x142):_0xfd1be8='scale=-2:'+_0x1d5be1;else{}return _0xfd1be8;},transCodeUtil['getVideoBitrate']=function(_0x3878f9,_0x2362b8){const _0x36259e=_0x22baff;return _0x2362b8==-0x1&&(_0x3878f9&&_0x3878f9[_0x36259e(0x14c)]&&_0x3878f9[_0x36259e(0x14c)]>0xf4240&&_0x3878f9['bit_rate']!=_0x36259e(0x12f)?(_0x2362b8=_0x3878f9[_0x36259e(0x14c)]/0x3e8,_0x2362b8>BITRATE_MAX&&(_0x2362b8=BITRATE_MAX)):_0x2362b8=BITRATE_DEFAULT),_0x2362b8;},transCodeUtil[_0x22baff(0x15b)]=function(_0x1e35f3){const _0x4c35a0=_0x22baff;let _0x2f4f3b=0x17,_0x538620=dbConfigTable['findByTitle'](_0x1e35f3,'crf');return _0x538620&&(_0x538620['value']>=0x1&&_0x538620[_0x4c35a0(0x180)]<=0x33&&(_0x2f4f3b=_0x538620[_0x4c35a0(0x180)])),_0x2f4f3b;},transCodeUtil[_0x22baff(0x166)]=function(_0x211553,_0x11c6d6){const _0x2e87df=_0x22baff;let _0x563655=dbConfigTable[_0x2e87df(0x18c)](_0x211553,_0x2e87df(0x13a)),_0xc9a151=[_0x2e87df(0x11f),_0x2e87df(0x19e),_0x2e87df(0x150),'slow'];function _0x5bae18(_0x2af29c){const _0xa2acd5=_0x2e87df;if((_0x11c6d6=='h264_nvenc'||_0x11c6d6==_0xa2acd5(0x11b))&&_0x2af29c==_0xa2acd5(0x11f))return'p1';if(_0x11c6d6==_0xa2acd5(0x140)&&(_0x2af29c==_0xa2acd5(0x11f)||_0x2af29c==_0xa2acd5(0x18e)))return _0xa2acd5(0x160);return _0x2af29c;}return _0x563655&&_0x563655[_0x2e87df(0x180)]&&_0xc9a151['includes'](_0x563655['value'])?_0x5bae18(_0x563655[_0x2e87df(0x180)]):_0x2e87df(0x150);},transCodeUtil[_0x22baff(0x124)]=function(_0x49b3ff,_0x1b8978){const _0x12ac2a=_0x22baff;let _0x24a333='';if(_0x1b8978){if(_0x1b8978[_0x12ac2a(0x157)]){let _0x28a87f=_0x1b8978[_0x12ac2a(0x157)][_0x12ac2a(0x12c)]();(_0x28a87f['indexOf'](_0x12ac2a(0x17c))!=-0x1||_0x28a87f[_0x12ac2a(0x18a)](_0x12ac2a(0x16d))!=-0x1)&&(_0x24a333='H264'),_0x28a87f[_0x12ac2a(0x18a)]('hevc')!=-0x1&&(_0x24a333='HEVC');}if(!_0x24a333&&_0x1b8978[_0x12ac2a(0x15e)]){let _0x3bc8ff=_0x1b8978[_0x12ac2a(0x15e)][_0x12ac2a(0x12c)]();(_0x3bc8ff['indexOf'](_0x12ac2a(0x17c))!=-0x1||_0x3bc8ff[_0x12ac2a(0x18a)](_0x12ac2a(0x16d))!=-0x1)&&(_0x24a333='H264'),(_0x3bc8ff[_0x12ac2a(0x18a)]('hevc')!=-0x1||_0x3bc8ff[_0x12ac2a(0x18a)](_0x12ac2a(0x167))!=-0x1)&&(_0x24a333=_0x12ac2a(0x148));}}!_0x24a333&&(console[_0x12ac2a(0x130)](_0x12ac2a(0x193)),_0x24a333=_0x12ac2a(0x148));let _0x1545ce={'decoderCommand':'','encoderName':'libx264','coderName':_0x12ac2a(0x194)},_0x1b7880=dbConfigTable[_0x12ac2a(0x18c)](_0x49b3ff,_0x12ac2a(0x133)),_0x43e60b='';if(_0x24a333==_0x12ac2a(0x148)){let _0x2d925c=dbConfigTable['findByTitle'](_0x49b3ff,'transCodeParams-CoderNameHevc');_0x2d925c&&_0x2d925c[_0x12ac2a(0x180)]&&(_0x43e60b=_0x2d925c[_0x12ac2a(0x180)]);}else{if(_0x24a333==_0x12ac2a(0x146)){let _0x3522af=dbConfigTable[_0x12ac2a(0x18c)](_0x49b3ff,_0x12ac2a(0x174));_0x3522af&&_0x3522af[_0x12ac2a(0x180)]&&(_0x43e60b=_0x3522af[_0x12ac2a(0x180)]);}}if(_0x1b7880&&_0x1b7880[_0x12ac2a(0x180)])try{let _0x30b189=[];_0x1b7880=JSON[_0x12ac2a(0x179)](_0x1b7880[_0x12ac2a(0x180)]);for(let _0x207712 of _0x1b7880){_0x207712[_0x12ac2a(0x13e)]==_0x24a333&&_0x30b189['push'](_0x207712);}if(_0x30b189[_0x12ac2a(0x127)]>0x0){if(!_0x43e60b)_0x1545ce=_0x30b189[0x0];else{let _0x3bfc59=![];for(let _0x47094a of _0x30b189){if(_0x47094a['coderName']==_0x43e60b){_0x1545ce=_0x47094a,_0x3bfc59=!![];break;}}!_0x3bfc59&&(console[_0x12ac2a(0x130)](_0x12ac2a(0x11e),_0x30b189[0x0]),_0x1545ce=_0x30b189[0x0]);}}}catch(_0x520e20){console[_0x12ac2a(0x130)](_0x520e20);}return _0x1545ce;},transCodeUtil[_0x22baff(0x12e)]=function(_0xb5e851){const _0x477323=_0x22baff;let _0x2dddfb=0x5,_0x26f64c=_0x2dddfb,_0x2c2582=dbConfigTable['findByTitle'](_0xb5e851,_0x477323(0x191));if(_0x2c2582&&_0x2c2582[_0x477323(0x180)])try{_0x26f64c=parseInt(_0x2c2582['value']),(_0x26f64c<0x2||_0x26f64c>0x1e)&&(_0x26f64c=_0x2dddfb);}catch(_0x3bf8d3){return _0x2dddfb;}return _0x26f64c;},transCodeUtil[_0x22baff(0x149)]=function(_0x48eb7b,_0x581803){const _0x4bbab2=_0x22baff;return _0x4bbab2(0x154);},transCodeUtil['decoderSupportPixFormat']=function(_0x310388,_0x321db7){const _0x1e3d0b=_0x22baff;let _0xf36d06=_0x310388[_0x1e3d0b(0x16f)];if(_0xf36d06){_0xf36d06=_0xf36d06[_0x1e3d0b(0x135)]();if(pixFormatList[_0x321db7]){if(!pixFormatList[_0x321db7][_0x1e3d0b(0x181)](_0xf36d06))return![];}}return!![];},module['exports']=transCodeUtil;