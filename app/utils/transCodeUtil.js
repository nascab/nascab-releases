const _0x4e69e9=_0x3cd5;function _0x3cd5(_0x5313f4,_0x246884){const _0x10e87d=_0x10e8();return _0x3cd5=function(_0x3cd5f5,_0x5106bb){_0x3cd5f5=_0x3cd5f5-0x6c;let _0x54649b=_0x10e87d[_0x3cd5f5];return _0x54649b;},_0x3cd5(_0x5313f4,_0x246884);}(function(_0x21316c,_0x27ee2f){const _0x371ee8=_0x3cd5,_0x4d014d=_0x21316c();while(!![]){try{const _0x4a714e=-parseInt(_0x371ee8(0xf2))/0x1*(parseInt(_0x371ee8(0xc6))/0x2)+-parseInt(_0x371ee8(0xb4))/0x3+parseInt(_0x371ee8(0x8c))/0x4*(-parseInt(_0x371ee8(0xe2))/0x5)+parseInt(_0x371ee8(0x9f))/0x6+parseInt(_0x371ee8(0x7d))/0x7+-parseInt(_0x371ee8(0x75))/0x8*(parseInt(_0x371ee8(0xc1))/0x9)+parseInt(_0x371ee8(0x90))/0xa*(parseInt(_0x371ee8(0xda))/0xb);if(_0x4a714e===_0x27ee2f)break;else _0x4d014d['push'](_0x4d014d['shift']());}catch(_0xfbe613){_0x4d014d['push'](_0x4d014d['shift']());}}}(_0x10e8,0x3481b));let path=require(_0x4e69e9(0xe3)),fs=require('fs');const Database=require(_0x4e69e9(0xc9));let transCodeUtil={};const config=require(_0x4e69e9(0x7f));let fileUtil=require(_0x4e69e9(0x9c));const dbConfigTable=require(_0x4e69e9(0xad)),chldProcess=require(_0x4e69e9(0x91));let nasTrans=require(_0x4e69e9(0xb9)),FFmpeg=nasTrans[_0x4e69e9(0xbb)];function _0x10e8(){const _0x597d71=['getById','toLowerCase','\x5c\x5c?\x5c','parseVideoFullPath','getReadRate','1422370gSpIVG','path','parseSubtitle','pragma','getVideoBitrate','p016le','stat','dxva2_vld','bgr0','serverType','close','platform','stream读取失败','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','nv12','prepare','33207YGAEVB','p010le','getFps','decodePath','yuv444p10le','push','medium','parseVideoWH','subtitle','getTranscodeSpeed','pwd','yuv420p','parse','2920552xlkiyP','log','codec_name','pix_fmt','coderName','sha256','string','ceil','45003NifyYl','transCodeParams-CoderNameHevc','../myConfig/config','h264_nvenc','bit_rate','hevc','sep','slow','yuv420p10le','then','transCodeParams-CoderNameH264','filePath','trim','streams','stream_info','4tNHAFX','ultrafast','getPrivateDbPath','index\x20isn\x27t\x20video','14375540Tmqhpq','child_process','file\x20does\x20not\x20exist','folder_path','includes','H264','decoderType','parseStreamList','error','yuv444p','qsv','veryfast','../express-server/utils/fileUtils','h264','findByTitle','300198CtceNF','vaapi_vld','y210le','value','spaceId','token\x20expired','getPixFmt','transCodeParams-coderList','../express-server/utils/cryptoUtils','../db/dbFileIndexTable','length','codec_long_name','cuda','h264_qsv','../db/dbConfigTable','high\x20efficiency\x20video\x20coding','yuv444p16le','nv16','../db/dbPrivateSpaceTable','input','decoderSupportPixFormat','991629HQSLin','type','d3d11','yuvj444p','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','../libs/nasTrans','dealFFmpegPath','FFmpeg','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','crf','yuvj422p','filename','exports','9yJyrwg','transcodeSpeed','./videoStreamUtil','codec_type','yuv422p10le','18rkvkzI','win32','join','better-sqlite3','nv21','journal_mode\x20=\x20WAL','indexOf','fast','tokenPwdEncryptKey','HEVC','err','indexId','gray','split','rgb0','scale=-2:','yuv422p','transCodeParams-readrate','avg_frame_rate','duration','11txVwXU','spaceIndexId','scale='];_0x10e8=function(){return _0x597d71;};return _0x10e8();}const dbFileIndexTable=require(_0x4e69e9(0xa8));let dbPrivateSpaceTable=require(_0x4e69e9(0xb1)),sha256=require(_0x4e69e9(0x7a)),cryptoUtils=require(_0x4e69e9(0xa7));const os=require('os');let platform=os[_0x4e69e9(0xed)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x4e69e9(0xc3));let pixFormatList={'h264_nvenc':[_0x4e69e9(0x73),_0x4e69e9(0xf0),_0x4e69e9(0xf3),_0x4e69e9(0x99),'p016le',_0x4e69e9(0xaf),_0x4e69e9(0xea),_0x4e69e9(0xd4),'cuda',_0x4e69e9(0xb6)],'nvenc_h264':['yuv420p',_0x4e69e9(0xf0),_0x4e69e9(0xf3),'yuv444p',_0x4e69e9(0xe7),_0x4e69e9(0xaf),_0x4e69e9(0xea),_0x4e69e9(0xd4),'cuda',_0x4e69e9(0xb6)],'h264_qsv':[_0x4e69e9(0xf0),_0x4e69e9(0xf3),_0x4e69e9(0x9a),_0x4e69e9(0x73)],'hevc_qsv':[_0x4e69e9(0xf0),_0x4e69e9(0xf3),'yuyv422',_0x4e69e9(0xa1),'qsv'],'h264_mf':[_0x4e69e9(0xf0),_0x4e69e9(0x73)],'h264_amf':['nv12',_0x4e69e9(0x73),'d3d11',_0x4e69e9(0xe9)],'libopenh264':['yuv420p'],'libx264':[_0x4e69e9(0x73),_0x4e69e9(0xd6),_0x4e69e9(0xbe),_0x4e69e9(0x99),_0x4e69e9(0xb7),_0x4e69e9(0xf0),_0x4e69e9(0xb0),_0x4e69e9(0xca),_0x4e69e9(0x85),_0x4e69e9(0xc5),_0x4e69e9(0x6c),'nv20le',_0x4e69e9(0xd2),'gray10le'],'h264_vaapi':[_0x4e69e9(0xa0),'yuv420p'],'h264_cuvid':[_0x4e69e9(0xab),_0x4e69e9(0xf0),'p010le',_0x4e69e9(0xe7)],'hevc_cuvid':['cuda',_0x4e69e9(0xf0),_0x4e69e9(0xf3),_0x4e69e9(0xe7)]};function getPwdFromToken(_0x97f76a,_0x3110aa,_0x1f521b){const _0x27708e=_0x4e69e9;let _0x4795bd=dbPrivateSpaceTable['getTokenObjByToken'](_0x3110aa,_0x97f76a);!_0x4795bd&&_0x1f521b(_0x27708e(0xa4),pwd);let _0x574339=_0x4795bd[_0x27708e(0x72)];cryptoUtils['decryptString'](config[_0x27708e(0xce)],_0x574339)[_0x27708e(0x86)](_0x1c7b04=>{_0x1f521b(![],_0x1c7b04);});}transCodeUtil['dealFFmpegPath']=function(_0x6d17a7){const _0xadde3=_0x4e69e9;if(typeof _0x6d17a7!==_0xadde3(0x7b))return _0x6d17a7;return platform==_0xadde3(0xc7)&&_0x6d17a7[_0xadde3(0xa9)]>0x103?_0xadde3(0xdf)+_0x6d17a7:_0x6d17a7;},transCodeUtil[_0x4e69e9(0xe0)]=function(_0x1bf14f,_0x543101,_0x13c80f){return new Promise((_0x2668bf,_0x3e576c)=>{const _0x3b00b4=_0x3cd5;if(_0x13c80f[_0x3b00b4(0xd1)]&&!_0x13c80f[_0x3b00b4(0xa3)]){let _0x4a28b6=dbFileIndexTable['getIndexTableNameByType'](_0x13c80f[_0x3b00b4(0xeb)]),_0x5a96eb=dbFileIndexTable[_0x3b00b4(0xdd)](_0x1bf14f,_0x13c80f[_0x3b00b4(0xd1)],_0x4a28b6);if(!_0x5a96eb)return _0x3e576c('index\x20does\x20not\x20exist');if(_0x5a96eb[_0x3b00b4(0xb5)]!=0x2)return _0x3e576c(_0x3b00b4(0x8f));if(_0x5a96eb[_0x3b00b4(0x8b)]=='undefined')return _0x3e576c('stream\x20info\x20is\x20null');let _0x2205a0=JSON[_0x3b00b4(0x74)](_0x5a96eb[_0x3b00b4(0x8b)]),_0x2a45f7=_0x5a96eb['path']+path[_0x3b00b4(0x83)]+_0x5a96eb[_0x3b00b4(0xbf)];return _0x2668bf({'fullpath':_0x2a45f7,'streamList':_0x2205a0,'duration':_0x5a96eb['duration']});}else{if(_0x13c80f[_0x3b00b4(0x88)]&&!_0x13c80f['spaceId']){let _0x32b1e9=fileUtil[_0x3b00b4(0xf5)](_0x13c80f[_0x3b00b4(0x88)]);fs[_0x3b00b4(0xe8)](_0x32b1e9,(_0x55b4cf,_0x1254a0)=>{const _0x3bdb6f=_0x3b00b4;if(_0x55b4cf)return _0x3e576c(_0x3bdb6f(0x92));else FFmpeg()[_0x3bdb6f(0xb2)](transCodeUtil[_0x3bdb6f(0xba)](_0x32b1e9))['ffprobe']((_0x33aa47,_0x4048bb)=>{const _0x5e0775=_0x3bdb6f;if(_0x33aa47)return console['log'](_0x33aa47),_0x3e576c(_0x5e0775(0xee));else{let _0x3d566e=videoStreamUtil['getDurationFromStream'](_0x4048bb),_0x2c3665=_0x4048bb[_0x5e0775(0x8a)];return _0x2668bf({'fullpath':_0x32b1e9,'streamList':_0x2c3665,'duration':_0x3d566e});}});});}else{if(_0x13c80f[_0x3b00b4(0xa3)]){let _0x13f595=_0x13c80f[_0x3b00b4(0xa3)],_0x289e5f=dbPrivateSpaceTable[_0x3b00b4(0xdd)](_0x543101,_0x13f595);if(!_0x289e5f)return _0x3e576c('space\x20does\x20not\x20exist');let _0x3c95ab=path[_0x3b00b4(0xc8)](_0x289e5f['folder_path'],fileUtil[_0x3b00b4(0xf5)](_0x13c80f[_0x3b00b4(0x88)]));fs[_0x3b00b4(0xe8)](_0x3c95ab,(_0x554ced,_0x5c4714)=>{const _0x4d3166=_0x3b00b4;if(_0x554ced)return _0x3e576c(_0x4d3166(0x92));getPwdFromToken(_0x13c80f['spaceToken'],_0x543101,(_0x23ed48,_0x1640de)=>{const _0xed0ea4=_0x4d3166;if(_0x23ed48)return _0x3e576c(_0xed0ea4(0xd0));let _0x525e08=config[_0xed0ea4(0x8e)](_0x289e5f[_0xed0ea4(0x93)]),_0x5a1675=new Database(_0x525e08,{});_0x5a1675[_0xed0ea4(0xe5)](_0xed0ea4(0xcb));let _0x1bdee6=_0x5a1675[_0xed0ea4(0xf1)](_0xed0ea4(0xef))['get'](_0x13c80f[_0xed0ea4(0xdb)]);if(!_0x1bdee6||!_0x1bdee6[_0xed0ea4(0x8b)])return _0x3e576c('index\x20id\x20does\x20not\x20exist');_0x5a1675[_0xed0ea4(0xec)]();let _0x228628=JSON[_0xed0ea4(0x74)](_0x1bdee6[_0xed0ea4(0x8b)]);return _0x2668bf({'fullpath':_0x3c95ab,'streamList':_0x228628,'needDecrypt':!![],'pwd':_0x1640de,'duration':_0x1bdee6[_0xed0ea4(0xd9)]});});});}}}});},transCodeUtil[_0x4e69e9(0xf4)]=function(_0x1f05db){const _0x51f97c=_0x4e69e9;let _0x20c714=0x1e,_0x1aa753=![];try{if(_0x1f05db['r_frame_rate']){let _0x3d6cbf=_0x1f05db['r_frame_rate'][_0x51f97c(0xd3)]('/');(_0x3d6cbf[_0x51f97c(0xa9)]=0x2)&&(_0x1aa753=Math['ceil'](parseInt(_0x3d6cbf[0x0])/parseInt(_0x3d6cbf[0x1])));}if(!_0x1aa753){if(_0x1f05db[_0x51f97c(0xd8)]){let _0x4dc543=_0x1f05db[_0x51f97c(0xd8)]['split']('/');(_0x4dc543[_0x51f97c(0xa9)]=0x2)&&(_0x1aa753=Math[_0x51f97c(0x7c)](parseInt(_0x4dc543[0x0])/parseInt(_0x4dc543[0x1])));}}}catch(_0x466c92){console[_0x51f97c(0x76)](_0x51f97c(0x98),_0x466c92);}return _0x1aa753&&_0x1aa753<=0x3c&&(_0x20c714=_0x1aa753),_0x20c714;},transCodeUtil[_0x4e69e9(0xe4)]=function(_0x48181e,_0x37e83d){const _0x29f7b2=_0x4e69e9;let _0xf1e1f5=[];for(let _0x42f79f=0x0;_0x42f79f<_0x48181e[_0x29f7b2(0xa9)];_0x42f79f++){let _0x4489ad=_0x48181e[_0x42f79f];_0x4489ad[_0x29f7b2(0xc4)]==_0x29f7b2(0x70)&&_0xf1e1f5[_0x29f7b2(0x6d)](_0x4489ad);}if(_0xf1e1f5[_0x29f7b2(0xa9)]>_0x37e83d)return _0xf1e1f5[_0x37e83d];return null;},transCodeUtil[_0x4e69e9(0x97)]=function(_0x39a939){const _0x51792c=_0x4e69e9;let _0x511562=videoStreamUtil[_0x51792c(0x6f)](_0x39a939);return _0x511562;},transCodeUtil['getScaleOption']=function(_0x2c3abe,_0x83eb3f,_0x470f7f){const _0x28b41b=_0x4e69e9;let _0x5bdfa1=null;if(_0x83eb3f&&_0x470f7f&&_0x2c3abe)_0x2c3abe>_0x83eb3f&&_0x2c3abe>_0x470f7f&&(_0x2c3abe=_0x83eb3f>_0x470f7f?_0x83eb3f:_0x470f7f),_0x83eb3f>_0x470f7f?_0x5bdfa1=_0x28b41b(0xdc)+_0x2c3abe+':-2':_0x5bdfa1=_0x28b41b(0xd5)+_0x2c3abe;else{}return _0x5bdfa1;},transCodeUtil[_0x4e69e9(0xe6)]=function(_0x2fc33c,_0x546e37){const _0x1511fd=_0x4e69e9;return _0x546e37==-0x1&&(_0x2fc33c&&_0x2fc33c[_0x1511fd(0x81)]&&_0x2fc33c[_0x1511fd(0x81)]>0xf4240&&_0x2fc33c[_0x1511fd(0x81)]!='N/A'?(_0x546e37=_0x2fc33c[_0x1511fd(0x81)]/0x3e8,_0x546e37>BITRATE_MAX&&(_0x546e37=BITRATE_MAX)):_0x546e37=BITRATE_DEFAULT),_0x546e37;},transCodeUtil['getCrf']=function(_0x168e76){const _0x44d5d8=_0x4e69e9;let _0x48d9ba=0x17,_0x197868=dbConfigTable[_0x44d5d8(0x9e)](_0x168e76,_0x44d5d8(0xbd));return _0x197868&&(_0x197868['value']>=0x1&&_0x197868[_0x44d5d8(0xa2)]<=0x33&&(_0x48d9ba=_0x197868[_0x44d5d8(0xa2)])),_0x48d9ba;},transCodeUtil[_0x4e69e9(0x71)]=function(_0xe85475,_0x32077a){const _0x4aa65b=_0x4e69e9;let _0x20af19=dbConfigTable['findByTitle'](_0xe85475,_0x4aa65b(0xc2)),_0x349187=[_0x4aa65b(0x8d),_0x4aa65b(0xcd),_0x4aa65b(0x6e),_0x4aa65b(0x84)];function _0x4792a2(_0xc5c52a){const _0x71753d=_0x4aa65b;if((_0x32077a==_0x71753d(0x80)||_0x32077a=='nvenc_h264')&&_0xc5c52a==_0x71753d(0x8d))return'p1';if(_0x32077a==_0x71753d(0xac)&&(_0xc5c52a==_0x71753d(0x8d)||_0xc5c52a=='superfast'))return _0x71753d(0x9b);return _0xc5c52a;}return _0x20af19&&_0x20af19[_0x4aa65b(0xa2)]&&_0x349187[_0x4aa65b(0x94)](_0x20af19[_0x4aa65b(0xa2)])?_0x4792a2(_0x20af19[_0x4aa65b(0xa2)]):_0x4aa65b(0x6e);},transCodeUtil['getCoderConfig']=function(_0x3dda5a,_0x53e001){const _0x277404=_0x4e69e9;let _0x2894a1='';if(_0x53e001){if(_0x53e001['codec_name']){let _0xc43490=_0x53e001[_0x277404(0x77)][_0x277404(0xde)]();(_0xc43490[_0x277404(0xcc)]('h264')!=-0x1||_0xc43490[_0x277404(0xcc)]('h.264')!=-0x1)&&(_0x2894a1=_0x277404(0x95)),_0xc43490[_0x277404(0xcc)](_0x277404(0x82))!=-0x1&&(_0x2894a1=_0x277404(0xcf));}if(!_0x2894a1&&_0x53e001[_0x277404(0xaa)]){let _0x261bb9=_0x53e001['codec_long_name'][_0x277404(0xde)]();(_0x261bb9[_0x277404(0xcc)](_0x277404(0x9d))!=-0x1||_0x261bb9[_0x277404(0xcc)]('h.264')!=-0x1)&&(_0x2894a1='H264'),(_0x261bb9[_0x277404(0xcc)](_0x277404(0x82))!=-0x1||_0x261bb9[_0x277404(0xcc)](_0x277404(0xae))!=-0x1)&&(_0x2894a1=_0x277404(0xcf));}}!_0x2894a1&&(console['log'](_0x277404(0xb8)),_0x2894a1=_0x277404(0xcf));let _0x54a9c5={'decoderCommand':'','encoderName':'libx264','coderName':'CPU'},_0x4dc8f1=dbConfigTable['findByTitle'](_0x3dda5a,_0x277404(0xa6)),_0x3ee3c7='';if(_0x2894a1=='HEVC'){let _0xd097b1=dbConfigTable[_0x277404(0x9e)](_0x3dda5a,_0x277404(0x7e));_0xd097b1&&_0xd097b1[_0x277404(0xa2)]&&(_0x3ee3c7=_0xd097b1[_0x277404(0xa2)]);}else{if(_0x2894a1=='H264'){let _0x197eab=dbConfigTable[_0x277404(0x9e)](_0x3dda5a,_0x277404(0x87));_0x197eab&&_0x197eab['value']&&(_0x3ee3c7=_0x197eab[_0x277404(0xa2)]);}}if(_0x4dc8f1&&_0x4dc8f1[_0x277404(0xa2)])try{let _0x22a11f=[];_0x4dc8f1=JSON[_0x277404(0x74)](_0x4dc8f1[_0x277404(0xa2)]);for(let _0x1b301e of _0x4dc8f1){_0x1b301e[_0x277404(0x96)]==_0x2894a1&&_0x22a11f[_0x277404(0x6d)](_0x1b301e);}if(_0x22a11f[_0x277404(0xa9)]>0x0){if(!_0x3ee3c7)_0x54a9c5=_0x22a11f[0x0];else{let _0x159b1c=![];for(let _0x2ad7a5 of _0x22a11f){if(_0x2ad7a5[_0x277404(0x79)]==_0x3ee3c7){_0x54a9c5=_0x2ad7a5,_0x159b1c=!![];break;}}!_0x159b1c&&(console[_0x277404(0x76)](_0x277404(0xbc),_0x22a11f[0x0]),_0x54a9c5=_0x22a11f[0x0]);}}}catch(_0x1db5ec){console['log'](_0x1db5ec);}return _0x54a9c5;},transCodeUtil[_0x4e69e9(0xe1)]=function(_0x1b5faf){const _0x26ca21=_0x4e69e9;let _0x4e47ba=0x5,_0x571c82=_0x4e47ba,_0x4cac74=dbConfigTable['findByTitle'](_0x1b5faf,_0x26ca21(0xd7));if(_0x4cac74&&_0x4cac74[_0x26ca21(0xa2)])try{_0x571c82=parseInt(_0x4cac74[_0x26ca21(0xa2)]),(_0x571c82<0x2||_0x571c82>0x1e)&&(_0x571c82=_0x4e47ba);}catch(_0x5a8d85){return _0x4e47ba;}return _0x571c82;},transCodeUtil[_0x4e69e9(0xa5)]=function(_0x478d5e,_0x9640c2){const _0x39b319=_0x4e69e9;return _0x39b319(0x73);},transCodeUtil[_0x4e69e9(0xb3)]=function(_0xb57f76,_0x31d163){const _0x1d4c36=_0x4e69e9;let _0x29abf1=_0xb57f76[_0x1d4c36(0x78)];if(_0x29abf1){_0x29abf1=_0x29abf1[_0x1d4c36(0x89)]();if(pixFormatList[_0x31d163]){if(!pixFormatList[_0x31d163][_0x1d4c36(0x94)](_0x29abf1))return![];}}return!![];},module[_0x4e69e9(0xc0)]=transCodeUtil;