const _0x5562b1=_0x59c7;(function(_0x203801,_0x23ce7e){const _0x6fdbbb=_0x59c7,_0x3a88a9=_0x203801();while(!![]){try{const _0x56ea07=-parseInt(_0x6fdbbb(0x1b9))/0x1+parseInt(_0x6fdbbb(0x1ba))/0x2+-parseInt(_0x6fdbbb(0x1a5))/0x3*(-parseInt(_0x6fdbbb(0x1e6))/0x4)+parseInt(_0x6fdbbb(0x1c0))/0x5+parseInt(_0x6fdbbb(0x1de))/0x6+-parseInt(_0x6fdbbb(0x1c8))/0x7*(parseInt(_0x6fdbbb(0x1cc))/0x8)+parseInt(_0x6fdbbb(0x17c))/0x9*(-parseInt(_0x6fdbbb(0x188))/0xa);if(_0x56ea07===_0x23ce7e)break;else _0x3a88a9['push'](_0x3a88a9['shift']());}catch(_0x55f037){_0x3a88a9['push'](_0x3a88a9['shift']());}}}(_0x5393,0x85d63));let path=require(_0x5562b1(0x177)),fs=require('fs');function _0x59c7(_0x3c1d83,_0x18f8e0){const _0x5393f1=_0x5393();return _0x59c7=function(_0x59c700,_0x3fc6c1){_0x59c700=_0x59c700-0x163;let _0x3d2713=_0x5393f1[_0x59c700];return _0x3d2713;},_0x59c7(_0x3c1d83,_0x18f8e0);}const Database=require(_0x5562b1(0x1e2));let transCodeUtil={};const config=require(_0x5562b1(0x181));let fileUtil=require(_0x5562b1(0x16e));const dbConfigTable=require(_0x5562b1(0x174)),chldProcess=require('child_process');let nasTrans=require(_0x5562b1(0x1a9)),FFmpeg=nasTrans[_0x5562b1(0x195)];const dbFileIndexTable=require('../db/dbFileIndexTable');let dbPrivateSpaceTable=require(_0x5562b1(0x198)),sha256=require(_0x5562b1(0x180)),cryptoUtils=require(_0x5562b1(0x1bd));function _0x5393(){const _0x3f3cfd=['d3d11','yuv444p','nv16','spaceToken','fast','codec_long_name','crf','avg_frame_rate','value','veryfast','index\x20id\x20does\x20not\x20exist','superfast','../express-server/utils/fileUtils','cuda','stream_info','log','then','p016le','../db/dbConfigTable','bgr0','yuv422p10le','path','pwd','parseVideoFullPath','error','coderName','225FZsCLX','gray10le','transCodeParams-readrate','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','sha256','../myConfig/config','streams','findByTitle','r_frame_rate','platform','h264_nvenc','split','503270SzSHJG','transcodeSpeed','CPU','spaceId','scale=','parseSubtitle','h264','dxva2_vld','parse','getIndexTableNameByType','HEVC','gray','win32','FFmpeg','vaapi_vld','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','../db/dbPrivateSpaceTable','string','h.264','join','getTokenObjByToken','p010le','getCoderConfig','stream读取失败','ceil','bit_rate','token\x20expired','ffprobe','tokenPwdEncryptKey','6498KNcGTc','indexId','err','medium','../libs/nasTrans','getCrf','getFps','serverType','subtitle','push','codec_name','transCodeParams-CoderNameH264','trim','input','nvenc_h264','yuvj422p','N/A','scale=-2:','sep','type','24212LXYZZk','177320QhfFtU','./videoStreamUtil','nv12','../express-server/utils/cryptoUtils','yuv444p10le','yuv420p','5174495VQTSpu','ultrafast','hevc','decodePath','folder_path','close','stat','index\x20does\x20not\x20exist','1923593yIJtvi','index\x20isn\x27t\x20video','filename','\x5c\x5c?\x5c','8HJnAzf','space\x20does\x20not\x20exist','pix_fmt','duration','get','indexOf','pragma','file\x20does\x20not\x20exist','length','qsv','filePath','getDurationFromStream','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','H264','high\x20efficiency\x20video\x20coding','journal_mode\x20=\x20WAL',':-2','codec_type','2992824NBBDpW','h264_qsv','yuv444p16le','rgb0','better-sqlite3','yuvj444p','y210le','toLowerCase','892NIuzlE','prepare','getScaleOption'];_0x5393=function(){return _0x3f3cfd;};return _0x5393();}const os=require('os');let platform=os[_0x5562b1(0x185)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x5562b1(0x1bb));let pixFormatList={'h264_nvenc':[_0x5562b1(0x1bf),_0x5562b1(0x1bc),_0x5562b1(0x19d),_0x5562b1(0x163),_0x5562b1(0x173),_0x5562b1(0x1e0),'bgr0',_0x5562b1(0x1e1),_0x5562b1(0x16f),_0x5562b1(0x1e9)],'nvenc_h264':['yuv420p',_0x5562b1(0x1bc),'p010le',_0x5562b1(0x163),'p016le',_0x5562b1(0x1e0),_0x5562b1(0x175),_0x5562b1(0x1e1),_0x5562b1(0x16f),_0x5562b1(0x1e9)],'h264_qsv':[_0x5562b1(0x1bc),_0x5562b1(0x19d),_0x5562b1(0x1d5),_0x5562b1(0x1bf)],'hevc_qsv':[_0x5562b1(0x1bc),_0x5562b1(0x19d),'yuyv422',_0x5562b1(0x1e4),_0x5562b1(0x1d5)],'h264_mf':[_0x5562b1(0x1bc),_0x5562b1(0x1bf)],'h264_amf':[_0x5562b1(0x1bc),_0x5562b1(0x1bf),'d3d11',_0x5562b1(0x18f)],'libopenh264':[_0x5562b1(0x1bf)],'libx264':[_0x5562b1(0x1bf),'yuv422p',_0x5562b1(0x1b4),_0x5562b1(0x163),_0x5562b1(0x1e3),_0x5562b1(0x1bc),_0x5562b1(0x164),'nv21','yuv420p10le',_0x5562b1(0x176),_0x5562b1(0x1be),'nv20le',_0x5562b1(0x193),_0x5562b1(0x17d)],'h264_vaapi':[_0x5562b1(0x196),'yuv420p'],'h264_cuvid':[_0x5562b1(0x16f),_0x5562b1(0x1bc),_0x5562b1(0x19d),_0x5562b1(0x173)],'hevc_cuvid':[_0x5562b1(0x16f),_0x5562b1(0x1bc),_0x5562b1(0x19d),'p016le']};function getPwdFromToken(_0x1f836e,_0x1b111e,_0x3557e7){const _0x5f2a52=_0x5562b1;let _0x2acb55=dbPrivateSpaceTable[_0x5f2a52(0x19c)](_0x1b111e,_0x1f836e);!_0x2acb55&&_0x3557e7(_0x5f2a52(0x1a2),pwd);let _0x2bae37=_0x2acb55[_0x5f2a52(0x178)];cryptoUtils['decryptString'](config[_0x5f2a52(0x1a4)],_0x2bae37)[_0x5f2a52(0x172)](_0x170544=>{_0x3557e7(![],_0x170544);});}transCodeUtil['dealFFmpegPath']=function(_0x518087){const _0xa94f05=_0x5562b1;if(typeof _0x518087!==_0xa94f05(0x199))return _0x518087;return platform==_0xa94f05(0x194)&&_0x518087['length']>0x103?_0xa94f05(0x1cb)+_0x518087:_0x518087;},transCodeUtil[_0x5562b1(0x179)]=function(_0x464366,_0x4b4e4b,_0x2b3d16){return new Promise((_0x3fa3c4,_0x2fe748)=>{const _0x5bb3d6=_0x59c7;if(_0x2b3d16[_0x5bb3d6(0x1a6)]&&!_0x2b3d16[_0x5bb3d6(0x18b)]){let _0x4de89a=dbFileIndexTable[_0x5bb3d6(0x191)](_0x2b3d16[_0x5bb3d6(0x1ac)]),_0x329a5d=dbFileIndexTable['getById'](_0x464366,_0x2b3d16[_0x5bb3d6(0x1a6)],_0x4de89a);if(!_0x329a5d)return _0x2fe748(_0x5bb3d6(0x1c7));if(_0x329a5d[_0x5bb3d6(0x1b8)]!=0x2)return _0x2fe748(_0x5bb3d6(0x1c9));if(_0x329a5d['stream_info']=='undefined')return _0x2fe748('stream\x20info\x20is\x20null');let _0x366176=JSON[_0x5bb3d6(0x190)](_0x329a5d['stream_info']),_0x3ab567=_0x329a5d[_0x5bb3d6(0x177)]+path[_0x5bb3d6(0x1b7)]+_0x329a5d[_0x5bb3d6(0x1ca)];return _0x3fa3c4({'fullpath':_0x3ab567,'streamList':_0x366176,'duration':_0x329a5d[_0x5bb3d6(0x1cf)]});}else{if(_0x2b3d16[_0x5bb3d6(0x1d6)]&&!_0x2b3d16[_0x5bb3d6(0x18b)]){let _0x1b95af=fileUtil[_0x5bb3d6(0x1c3)](_0x2b3d16[_0x5bb3d6(0x1d6)]);fs[_0x5bb3d6(0x1c6)](_0x1b95af,(_0xaf43f0,_0x3c46db)=>{const _0x1f22c9=_0x5bb3d6;if(_0xaf43f0)return _0x2fe748(_0x1f22c9(0x1d3));else FFmpeg()[_0x1f22c9(0x1b2)](transCodeUtil['dealFFmpegPath'](_0x1b95af))[_0x1f22c9(0x1a3)]((_0x2c9eda,_0x8907c1)=>{const _0x4f7326=_0x1f22c9;if(_0x2c9eda)return console[_0x4f7326(0x171)](_0x2c9eda),_0x2fe748(_0x4f7326(0x19f));else{let _0x550505=videoStreamUtil[_0x4f7326(0x1d7)](_0x8907c1),_0x4d1ec3=_0x8907c1[_0x4f7326(0x182)];return _0x3fa3c4({'fullpath':_0x1b95af,'streamList':_0x4d1ec3,'duration':_0x550505});}});});}else{if(_0x2b3d16[_0x5bb3d6(0x18b)]){let _0xb43bd6=_0x2b3d16[_0x5bb3d6(0x18b)],_0x3d5a0d=dbPrivateSpaceTable['getById'](_0x4b4e4b,_0xb43bd6);if(!_0x3d5a0d)return _0x2fe748(_0x5bb3d6(0x1cd));let _0x10529a=path[_0x5bb3d6(0x19b)](_0x3d5a0d['folder_path'],fileUtil[_0x5bb3d6(0x1c3)](_0x2b3d16[_0x5bb3d6(0x1d6)]));fs[_0x5bb3d6(0x1c6)](_0x10529a,(_0x29bd2e,_0x1df35d)=>{const _0x478a2e=_0x5bb3d6;if(_0x29bd2e)return _0x2fe748(_0x478a2e(0x1d3));getPwdFromToken(_0x2b3d16[_0x478a2e(0x165)],_0x4b4e4b,(_0x52c430,_0xbafbb9)=>{const _0x2b4040=_0x478a2e;if(_0x52c430)return _0x2fe748(_0x2b4040(0x1a7));let _0x5f1094=config['getPrivateDbPath'](_0x3d5a0d[_0x2b4040(0x1c4)]),_0x1bb2aa=new Database(_0x5f1094,{});_0x1bb2aa[_0x2b4040(0x1d2)](_0x2b4040(0x1db));let _0x17ef67=_0x1bb2aa[_0x2b4040(0x1e7)](_0x2b4040(0x1d8))[_0x2b4040(0x1d0)](_0x2b3d16['spaceIndexId']);if(!_0x17ef67||!_0x17ef67[_0x2b4040(0x170)])return _0x2fe748(_0x2b4040(0x16c));_0x1bb2aa[_0x2b4040(0x1c5)]();let _0x36858a=JSON['parse'](_0x17ef67[_0x2b4040(0x170)]);return _0x3fa3c4({'fullpath':_0x10529a,'streamList':_0x36858a,'needDecrypt':!![],'pwd':_0xbafbb9,'duration':_0x17ef67[_0x2b4040(0x1cf)]});});});}}}});},transCodeUtil[_0x5562b1(0x1ab)]=function(_0x534db1){const _0x2d4b85=_0x5562b1;let _0x3f1571=0x1e,_0x53e951=![];try{if(_0x534db1[_0x2d4b85(0x184)]){let _0x125c2c=_0x534db1['r_frame_rate'][_0x2d4b85(0x187)]('/');(_0x125c2c['length']=0x2)&&(_0x53e951=Math[_0x2d4b85(0x1a0)](parseInt(_0x125c2c[0x0])/parseInt(_0x125c2c[0x1])));}if(!_0x53e951){if(_0x534db1[_0x2d4b85(0x169)]){let _0xe0d5ee=_0x534db1['avg_frame_rate'][_0x2d4b85(0x187)]('/');(_0xe0d5ee[_0x2d4b85(0x1d4)]=0x2)&&(_0x53e951=Math[_0x2d4b85(0x1a0)](parseInt(_0xe0d5ee[0x0])/parseInt(_0xe0d5ee[0x1])));}}}catch(_0x51695){console[_0x2d4b85(0x171)](_0x2d4b85(0x17a),_0x51695);}return _0x53e951&&_0x53e951<=0x3c&&(_0x3f1571=_0x53e951),_0x3f1571;},transCodeUtil[_0x5562b1(0x18d)]=function(_0x55455e,_0x517a26){const _0x2dedda=_0x5562b1;let _0x291a17=[];for(let _0x2714b5=0x0;_0x2714b5<_0x55455e[_0x2dedda(0x1d4)];_0x2714b5++){let _0x822d21=_0x55455e[_0x2714b5];_0x822d21[_0x2dedda(0x1dd)]==_0x2dedda(0x1ad)&&_0x291a17[_0x2dedda(0x1ae)](_0x822d21);}if(_0x291a17[_0x2dedda(0x1d4)]>_0x517a26)return _0x291a17[_0x517a26];return null;},transCodeUtil['parseStreamList']=function(_0x1c3bec){let _0x3dd0a2=videoStreamUtil['parseVideoWH'](_0x1c3bec);return _0x3dd0a2;},transCodeUtil[_0x5562b1(0x1e8)]=function(_0x46d019,_0x49771a,_0x958c1a){const _0x3ae45e=_0x5562b1;let _0x2df09f=null;if(_0x49771a&&_0x958c1a&&_0x46d019)_0x46d019>_0x49771a&&_0x46d019>_0x958c1a&&(_0x46d019=_0x49771a>_0x958c1a?_0x49771a:_0x958c1a),_0x49771a>_0x958c1a?_0x2df09f=_0x3ae45e(0x18c)+_0x46d019+_0x3ae45e(0x1dc):_0x2df09f=_0x3ae45e(0x1b6)+_0x46d019;else{}return _0x2df09f;},transCodeUtil['getVideoBitrate']=function(_0x182aa5,_0x533159){const _0x3bf5dd=_0x5562b1;return _0x533159==-0x1&&(_0x182aa5&&_0x182aa5[_0x3bf5dd(0x1a1)]&&_0x182aa5[_0x3bf5dd(0x1a1)]>0xf4240&&_0x182aa5['bit_rate']!=_0x3bf5dd(0x1b5)?(_0x533159=_0x182aa5[_0x3bf5dd(0x1a1)]/0x3e8,_0x533159>BITRATE_MAX&&(_0x533159=BITRATE_MAX)):_0x533159=BITRATE_DEFAULT),_0x533159;},transCodeUtil[_0x5562b1(0x1aa)]=function(_0x59c599){const _0x38384b=_0x5562b1;let _0x81dc3=0x17,_0x5192ad=dbConfigTable[_0x38384b(0x183)](_0x59c599,_0x38384b(0x168));return _0x5192ad&&(_0x5192ad[_0x38384b(0x16a)]>=0x1&&_0x5192ad[_0x38384b(0x16a)]<=0x33&&(_0x81dc3=_0x5192ad['value'])),_0x81dc3;},transCodeUtil['getTranscodeSpeed']=function(_0x89f219,_0x71f755){const _0x196226=_0x5562b1;let _0x332a91=dbConfigTable['findByTitle'](_0x89f219,_0x196226(0x189)),_0x4682c0=[_0x196226(0x1c1),_0x196226(0x166),_0x196226(0x1a8),'slow'];function _0x498d02(_0x39bd9d){const _0x247516=_0x196226;if((_0x71f755==_0x247516(0x186)||_0x71f755==_0x247516(0x1b3))&&_0x39bd9d==_0x247516(0x1c1))return'p1';if(_0x71f755==_0x247516(0x1df)&&(_0x39bd9d==_0x247516(0x1c1)||_0x39bd9d==_0x247516(0x16d)))return _0x247516(0x16b);return _0x39bd9d;}return _0x332a91&&_0x332a91['value']&&_0x4682c0['includes'](_0x332a91[_0x196226(0x16a)])?_0x498d02(_0x332a91['value']):'medium';},transCodeUtil[_0x5562b1(0x19e)]=function(_0x117328,_0x3834d5){const _0x4cb5e3=_0x5562b1;let _0x202c86='';if(_0x3834d5){if(_0x3834d5[_0x4cb5e3(0x1af)]){let _0xfc8a8f=_0x3834d5[_0x4cb5e3(0x1af)][_0x4cb5e3(0x1e5)]();(_0xfc8a8f[_0x4cb5e3(0x1d1)]('h264')!=-0x1||_0xfc8a8f[_0x4cb5e3(0x1d1)]('h.264')!=-0x1)&&(_0x202c86=_0x4cb5e3(0x1d9)),_0xfc8a8f['indexOf']('hevc')!=-0x1&&(_0x202c86=_0x4cb5e3(0x192));}if(!_0x202c86&&_0x3834d5[_0x4cb5e3(0x167)]){let _0x1a6f48=_0x3834d5[_0x4cb5e3(0x167)][_0x4cb5e3(0x1e5)]();(_0x1a6f48['indexOf'](_0x4cb5e3(0x18e))!=-0x1||_0x1a6f48[_0x4cb5e3(0x1d1)](_0x4cb5e3(0x19a))!=-0x1)&&(_0x202c86='H264'),(_0x1a6f48['indexOf'](_0x4cb5e3(0x1c2))!=-0x1||_0x1a6f48[_0x4cb5e3(0x1d1)](_0x4cb5e3(0x1da))!=-0x1)&&(_0x202c86='HEVC');}}!_0x202c86&&(console[_0x4cb5e3(0x171)](_0x4cb5e3(0x197)),_0x202c86=_0x4cb5e3(0x192));let _0x4e6563={'decoderCommand':'','encoderName':'libx264','coderName':_0x4cb5e3(0x18a)},_0xf0fd48=dbConfigTable[_0x4cb5e3(0x183)](_0x117328,'transCodeParams-coderList'),_0x300cbb='';if(_0x202c86==_0x4cb5e3(0x192)){let _0x4b5b7c=dbConfigTable['findByTitle'](_0x117328,'transCodeParams-CoderNameHevc');_0x4b5b7c&&_0x4b5b7c[_0x4cb5e3(0x16a)]&&(_0x300cbb=_0x4b5b7c[_0x4cb5e3(0x16a)]);}else{if(_0x202c86=='H264'){let _0x1ebaac=dbConfigTable[_0x4cb5e3(0x183)](_0x117328,_0x4cb5e3(0x1b0));_0x1ebaac&&_0x1ebaac[_0x4cb5e3(0x16a)]&&(_0x300cbb=_0x1ebaac[_0x4cb5e3(0x16a)]);}}if(_0xf0fd48&&_0xf0fd48[_0x4cb5e3(0x16a)])try{let _0x2b53e8=[];_0xf0fd48=JSON['parse'](_0xf0fd48[_0x4cb5e3(0x16a)]);for(let _0x215c69 of _0xf0fd48){_0x215c69['decoderType']==_0x202c86&&_0x2b53e8[_0x4cb5e3(0x1ae)](_0x215c69);}if(_0x2b53e8['length']>0x0){if(!_0x300cbb)_0x4e6563=_0x2b53e8[0x0];else{let _0x4de7e3=![];for(let _0x10dca7 of _0x2b53e8){if(_0x10dca7[_0x4cb5e3(0x17b)]==_0x300cbb){_0x4e6563=_0x10dca7,_0x4de7e3=!![];break;}}!_0x4de7e3&&(console[_0x4cb5e3(0x171)](_0x4cb5e3(0x17f),_0x2b53e8[0x0]),_0x4e6563=_0x2b53e8[0x0]);}}}catch(_0x3e880c){console['log'](_0x3e880c);}return _0x4e6563;},transCodeUtil['getReadRate']=function(_0x5cb2fd){const _0x392e8f=_0x5562b1;let _0x3eb330=0x5,_0xa97b37=_0x3eb330,_0x2e3a81=dbConfigTable[_0x392e8f(0x183)](_0x5cb2fd,_0x392e8f(0x17e));if(_0x2e3a81&&_0x2e3a81['value'])try{_0xa97b37=parseInt(_0x2e3a81[_0x392e8f(0x16a)]),(_0xa97b37<0x2||_0xa97b37>0x1e)&&(_0xa97b37=_0x3eb330);}catch(_0x4b60f8){return _0x3eb330;}return _0xa97b37;},transCodeUtil['getPixFmt']=function(_0x5ed539,_0x50c443){const _0x5d4dfe=_0x5562b1;return _0x5d4dfe(0x1bf);},transCodeUtil['decoderSupportPixFormat']=function(_0x57f4a5,_0x3dbfc3){const _0x5636bd=_0x5562b1;let _0x4851d5=_0x57f4a5[_0x5636bd(0x1ce)];if(_0x4851d5){_0x4851d5=_0x4851d5[_0x5636bd(0x1b1)]();if(pixFormatList[_0x3dbfc3]){if(!pixFormatList[_0x3dbfc3]['includes'](_0x4851d5))return![];}}return!![];},module['exports']=transCodeUtil;