const _0x102244=_0x5ba6;(function(_0x3d5339,_0x1889c0){const _0x9273e1=_0x5ba6,_0x240007=_0x3d5339();while(!![]){try{const _0x389cf3=parseInt(_0x9273e1(0xf3))/0x1+-parseInt(_0x9273e1(0x100))/0x2*(parseInt(_0x9273e1(0xe1))/0x3)+parseInt(_0x9273e1(0xf6))/0x4+-parseInt(_0x9273e1(0xfd))/0x5*(-parseInt(_0x9273e1(0x103))/0x6)+parseInt(_0x9273e1(0x117))/0x7*(parseInt(_0x9273e1(0xe2))/0x8)+-parseInt(_0x9273e1(0x114))/0x9*(parseInt(_0x9273e1(0xda))/0xa)+-parseInt(_0x9273e1(0xf7))/0xb;if(_0x389cf3===_0x1889c0)break;else _0x240007['push'](_0x240007['shift']());}catch(_0x4636ad){_0x240007['push'](_0x240007['shift']());}}}(_0x1f71,0x257fb));const config=require(_0x102244(0xf8));let fs=require('fs'),path=require('path');const dbFileIndexTable=require(_0x102244(0x113)),dbConfigTable=require('../db/dbConfigTable');let transCodeUtil=require(_0x102244(0xfe)),sha256=require(_0x102244(0x110)),FFmpeg=require('../libs/nasTrans')['FFmpeg'];process[_0x102244(0x10b)]='NasCabSubtitleWorker';const Database=require(_0x102244(0x108));let dbFileIndex=new Database(config['dbFileIndex'],{'timeout':0xea60});function _0x5ba6(_0x24aca5,_0x1932ce){const _0x1f71f9=_0x1f71();return _0x5ba6=function(_0x5ba6c2,_0x1b8079){_0x5ba6c2=_0x5ba6c2-0xda;let _0x6cecd9=_0x1f71f9[_0x5ba6c2];return _0x6cecd9;},_0x5ba6(_0x24aca5,_0x1932ce);}dbFileIndex[_0x102244(0xe4)](_0x102244(0x102));let dbOther=new Database(config[_0x102244(0x10a)],{});dbOther[_0x102244(0xe4)](_0x102244(0x102));const messageUtil=require('../utils/messageUtil');function dealFinish(_0x3abfed,_0x3c3f3f){const _0x3050eb=_0x102244;if(_0x3abfed){let _0x2382c8=_0x3050eb(0x116)+dbFileIndexTable[_0x3050eb(0xdc)]+'\x20set\x20pre_gen_subtitles=1\x20where\x20id=?';dbFileIndex[_0x3050eb(0xe0)](_0x2382c8)[_0x3050eb(0xf0)](_0x3abfed['id']);}_0x3c3f3f&&_0x3c3f3f();}function _0x1f71(){const _0x16ac38=['../db/dbFileIndexTable','27OgcBiS','subtitle','UPDATE\x20','98yRIorU','243220uWnxVl','start','INDEX_TABLE_NAME_MOVIE','lastInsertRowid','exit','\x20pre_gen_subtitles\x20=0\x20\x20and\x20is_file=1\x20and\x20type=2\x20and\x20stream_info\x20is\x20not\x20null\x20and\x20stream_info\x20!=\x27undefined\x27\x20and\x20stream_info\x20!=0\x20LIMIT\x201','prepare','167205HKIGxV','125256HSRYyD','size','pragma','existsSync','noAudio','-map\x200:s:','stack','value','findByTitle','push','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','then','saveMsg','stream_info','run','SUBTITLE_PRE_GEN','end','285338hWBrsW','noVideo','close','716140DbmlxZ','4755663OqLkba','../myConfig/config','catch','log','uncaughtException','output','15fCYVzi','../utils/transCodeUtil','error','4EIehuc','message','journal_mode\x20=\x20WAL','173586AHfrFw','kill','parse','path','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','better-sqlite3','Error\x20occurred\x20in\x20subtitles\x20gen\x20process','dbOther','title','filename','getByWhere','killed','subtitlePreGen','sha256','join','statSync'];_0x1f71=function(){return _0x16ac38;};return _0x1f71();}function genStart(){return new Promise(async(_0x4e16b9,_0x372b62)=>{const _0x3b1dd3=_0x5ba6;let _0x6c85f8=dbFileIndexTable[_0x3b1dd3(0x10d)](dbFileIndex,_0x3b1dd3(0xdf),'*',dbFileIndexTable[_0x3b1dd3(0xdc)]);if(_0x6c85f8){let _0x14e02f=_0x6c85f8[_0x3b1dd3(0xef)];if(!_0x14e02f)return dealFinish(_0x6c85f8,_0x4e16b9);let _0x38764b=path[_0x3b1dd3(0x111)](_0x6c85f8[_0x3b1dd3(0x106)],_0x6c85f8[_0x3b1dd3(0x10c)]);try{_0x14e02f=JSON[_0x3b1dd3(0x105)](_0x14e02f);}catch(_0x4ef840){return dealFinish(_0x6c85f8,_0x4e16b9);}let _0x58894e=[];for(let _0x2aa386 in _0x14e02f){let _0x214458=_0x14e02f[_0x2aa386];_0x214458['codec_type']==_0x3b1dd3(0x115)&&_0x58894e[_0x3b1dd3(0xeb)](_0x214458);}if(_0x58894e['length']<0x1)return dealFinish(_0x6c85f8,_0x4e16b9);let _0x19a2bf=0x0;function _0x4f4f39(){if(_0x19a2bf>=_0x58894e['length'])return dealFinish(_0x6c85f8,_0x4e16b9);}function _0x4eef43(_0x239ac0,_0x4879fa,_0x361ec5){const _0x1cc21b=_0x3b1dd3;try{bgTaskId&&dbOther[_0x1cc21b(0xe0)](_0x1cc21b(0x107)+bgTaskId)[_0x1cc21b(0xf0)]();}catch(_0x35980d){}return new Promise((_0x2ed12f,_0xc57ed0)=>{const _0x56ac76=_0x1cc21b;let _0x53976b=FFmpeg({'timeout':0x258});_0x53976b['input'](transCodeUtil['dealFFmpegPath'](_0x239ac0))[_0x56ac76(0xe6)]()[_0x56ac76(0xf4)]()['outputOptions']([_0x56ac76(0xe7)+_0x361ec5])[_0x56ac76(0xfc)](_0x4879fa)['on'](_0x56ac76(0xdb),function(_0x4a1288){})['on']('error',function(_0x2a917f){const _0x1af1b3=_0x56ac76;_0x2a917f[_0x1af1b3(0x101)]&&_0x2a917f[_0x1af1b3(0x101)]['indexOf'](_0x1af1b3(0x10e))==-0x1&&(fs['rm'](_0x4879fa,_0x398f83=>{}),dealFinish(_0x6c85f8,_0x2ed12f),_0x53976b[_0x1af1b3(0x104)]());})['on'](_0x56ac76(0xf2),function(){const _0x5b3347=_0x56ac76;console[_0x5b3347(0xfa)]('Subtitle\x20extraction\x20:\x20',_0x239ac0),_0x53976b[_0x5b3347(0x104)](),_0x2ed12f();}),_0x53976b['run']();});}for(let _0x5866cf in _0x58894e){let _0x5ba792=path[_0x3b1dd3(0x111)](config['subtitlePath'],sha256(_0x38764b+_0x5866cf)+'.vtt');try{let _0x4e372a=!![],_0x3c98d9=fs[_0x3b1dd3(0xe5)](_0x5ba792);if(_0x3c98d9){let _0x1f6325=fs[_0x3b1dd3(0x112)](_0x5ba792);_0x1f6325[_0x3b1dd3(0xe3)]>0x2710&&(_0x4e372a=![]);}if(_0x4e372a)await _0x4eef43(_0x38764b,_0x5ba792,_0x5866cf),_0x19a2bf+=0x1,_0x4f4f39();else{_0x19a2bf+=0x1,_0x4f4f39();continue;}}catch(_0x32a78a){_0x19a2bf+=0x1,_0x4f4f39();}}}else exitProcess();});}let bgTaskId;try{let info=dbOther[_0x102244(0xe0)]('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')['run'](_0x102244(0xf1));bgTaskId=info[_0x102244(0xdd)];}catch(_0x3d89da){}function exitProcess(){const _0x274f7b=_0x102244;try{bgTaskId&&dbOther['prepare'](_0x274f7b(0xec)+bgTaskId)['run']();}catch(_0x8f9772){}return process['send']({'type':_0x274f7b(0xf5)}),process['exit']();}async function runGen(){const _0x40e4bd=_0x102244;let _0x2024be=dbConfigTable[_0x40e4bd(0xea)](dbOther,_0x40e4bd(0x10f));!_0x2024be||_0x2024be&&_0x2024be[_0x40e4bd(0xe9)]=='1'?genStart(dbFileIndexTable['INDEX_TABLE_NAME_MOVIE'])[_0x40e4bd(0xed)](()=>{runGen();})[_0x40e4bd(0xf9)](()=>{runGen();}):exitProcess();}process['on'](_0x102244(0xfb),(_0x3dbf11,_0x5a3232)=>{const _0x35c9c0=_0x102244;console[_0x35c9c0(0xfa)](_0x3dbf11),messageUtil[_0x35c9c0(0xee)](dbOther,_0x35c9c0(0x109),_0x35c9c0(0xff),_0x3dbf11[_0x35c9c0(0xe8)]||_0x3dbf11[_0x35c9c0(0x101)]);}),process['on'](_0x102244(0xde),(_0x1b57e0,_0x1aad0)=>{const _0x3e34ed=_0x102244;process['send']({'type':_0x3e34ed(0xf5)});}),runGen();