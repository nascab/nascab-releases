const _0x159c6a=_0x5b96;(function(_0x331e1b,_0x4fcf59){const _0x322821=_0x5b96,_0x5e1766=_0x331e1b();while(!![]){try{const _0x16a86b=-parseInt(_0x322821(0x184))/0x1*(parseInt(_0x322821(0x15e))/0x2)+-parseInt(_0x322821(0x164))/0x3*(-parseInt(_0x322821(0x18d))/0x4)+parseInt(_0x322821(0x179))/0x5+-parseInt(_0x322821(0x156))/0x6+parseInt(_0x322821(0x199))/0x7*(-parseInt(_0x322821(0x15c))/0x8)+parseInt(_0x322821(0x155))/0x9*(-parseInt(_0x322821(0x16c))/0xa)+parseInt(_0x322821(0x1af))/0xb;if(_0x16a86b===_0x4fcf59)break;else _0x5e1766['push'](_0x5e1766['shift']());}catch(_0x22dcb8){_0x5e1766['push'](_0x5e1766['shift']());}}}(_0x5829,0xdf89e));const path=require('path'),fs=require('fs'),config=require(_0x159c6a(0x1aa)),transCodeUtil=require(_0x159c6a(0x1ab)),Database=require('better-sqlite3'),dbOther=new Database(config['dbOther'],{}),dbFileIndex=new Database(config[_0x159c6a(0x1b0)],{'timeout':0xea60});dbOther['pragma'](_0x159c6a(0x18e)),dbFileIndex[_0x159c6a(0x19d)](_0x159c6a(0x18e));const FFmpeg=require('../libs/nasTrans')['FFmpeg'],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x159c6a(0x1a7));function _0x5b96(_0xa2f07f,_0x2cc5cb){const _0x582963=_0x5829();return _0x5b96=function(_0x5b96cc,_0x495222){_0x5b96cc=_0x5b96cc-0x148;let _0x3f7a7c=_0x582963[_0x5b96cc];return _0x3f7a7c;},_0x5b96(_0xa2f07f,_0x2cc5cb);}const chokidar=require('chokidar'),platform=require('os')[_0x159c6a(0x193)];process[_0x159c6a(0x18a)]='NasCabHlsWorker';function setLastReqTime(_0x311b0d){const _0xd3244f=_0x159c6a;for(let _0x21d0d7 in ffmpList){let _0x1a31dc=ffmpList[_0x21d0d7];if(_0x1a31dc[_0xd3244f(0x154)]==_0x311b0d)return ffmpList[_0x21d0d7][_0xd3244f(0x1bf)]=new Date()[_0xd3244f(0x15d)]();}}function addFfmpToList(_0x43e884,_0x82a7a6,_0x51bdbc){ffmpList['push']({'ffmp':_0x43e884,'playId':_0x82a7a6,'dirWatcher':_0x51bdbc,'lastTsReqTime':new Date()['getTime']()});}function killFfmpByPlayId(_0x40e0a9,_0x301813=!![]){const _0x43c34c=_0x159c6a;console[_0x43c34c(0x160)](_0x43c34c(0x189),_0x40e0a9);for(let _0x58a078 in startedPlayIdList){let _0x2f41d5=startedPlayIdList[_0x58a078];if(_0x2f41d5==_0x40e0a9){startedPlayIdList[_0x43c34c(0x151)](_0x58a078,0x1);break;}}for(let _0x5ec4f0 in ffmpList){let _0xe66dac=ffmpList[_0x5ec4f0];if(_0xe66dac[_0x43c34c(0x154)]==_0x40e0a9){ffmpList[_0x43c34c(0x151)](_0x5ec4f0,0x1);let _0x9d9511=_0xe66dac['ffmp'][_0x43c34c(0x19c)]();_0x301813&&setTimeout(()=>{const _0x3203eb=_0x43c34c;_0xe66dac[_0x3203eb(0x1c0)]['close']()[_0x3203eb(0x16b)](()=>{});},0x7d0);return;}}}function _0x5829(){const _0x4ab854=['-c:v\x20','log','parseVideoFullPath','end','stream.m3u8','1383267elKkUL','-filter:v\x20','qsv\x20cannot\x20deal,restart\x20ffmpeg','constants','decryptFileGetStream','decoderSupportPixFormat','-hls_time\x20','then','10dvzlGB','close','-start_number\x20','getTranscodeSpeed','dvdsub','indexOf','message','addOption','-ac\x202','pgssub','hls','output','mkdir','5641715MbHgng','[0:v:0]','addInputOption','change','-crf\x20','m3u8segmentDuration','.m3u8','stat','error','hdmv_pgs_subtitle','format','35WaoLrr','Play\x20ID\x20has\x20started','prepare','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','subtitleIndex','Stop\x20transcode\x20','title','R_OK','start','12kLUIsf','journal_mode\x20=\x20WAL','-map\x200:a:','stderr','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','.tmp','platform','get','vobsub','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','stop','-pix_fmt\x20','1085YwpdbY','join','-bufsize\x20','kill','pragma','audioIndex','encoderName','videobit','gen','ready','burn','push','[0:s:','getCrf','../express-server/utils/cryptoUtils','includes','replace','../myConfig/config','../utils/transCodeUtil','basename','-r\x20','killed','37806043qsINKX','dbFileIndex','dvb_subtitle','[vs]','[ref][sub]overlay[vss]','dirname','More\x20data\x20is\x20required\x20to\x20decode\x20header','add','codec_name','size','getScaleOption','seekInput','send','endsWith','watch','getPixFmt','lastTsReqTime','dirWatcher','][vs]scale2ref[sub][ref]','m3u8TmpPath','parseStreamList','-map\x200:v:0?','hwaccel','dealFFmpegPath','seq','access','-ac\x20','addOutputOption','splice','-map\x20[vss]','run','playId','11883033ZbSohh','7849212sqkqtP','getVideoBitrate','audioCodec','decoderCommand','videoBitrate','-preset\x20','35752GZOziU','getTime','97810UzIwYB'];_0x5829=function(){return _0x4ab854;};return _0x5829();}function startPlay(_0x209897){const _0x12dea9=_0x159c6a;let {playId:_0x5e12ff,args:_0x36e49e,action:_0xd61c10}=_0x209897;if(!_0x5e12ff)return;if(_0xd61c10==_0x12dea9(0x197)){killFfmpByPlayId(_0x5e12ff);return;}for(let _0x471bde in ffmpList){let _0x6ce5ca=ffmpList[_0x471bde];if(_0x6ce5ca['playId']==_0x5e12ff){setLastReqTime(_0x5e12ff);return;}}if(startedPlayIdList[_0x12dea9(0x1a8)](_0x5e12ff)){console['log'](_0x12dea9(0x185));return;}startedPlayIdList[_0x12dea9(0x1a4)](_0x5e12ff);let _0x5b2fa6=dbOther[_0x12dea9(0x186)](_0x12dea9(0x196))[_0x12dea9(0x194)](_0x5e12ff);if(!_0x5b2fa6)return;let _0x16588=path[_0x12dea9(0x19a)](config[_0x12dea9(0x148)],_0x5e12ff);function _0xbd26f7(){const _0x235020=_0x12dea9;transCodeUtil[_0x235020(0x161)](dbFileIndex,dbOther,_0x36e49e)[_0x235020(0x16b)](_0x1369a9=>{const _0x401387=_0x235020;let {fullpath:_0x3773c6,streamList:_0x5101fe,needDecrypt:_0x252f86,pwd:_0x4155ea,duration:_0x426081}=_0x1369a9;fs[_0x401387(0x14e)](_0x3773c6,fs[_0x401387(0x167)][_0x401387(0x18b)],_0x304659=>{const _0x205f0e=_0x401387;if(_0x304659)return;let _0x2b530a=chokidar[_0x205f0e(0x1bd)](_0x16588,{'ignored':'*.m3u8','ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x2b530a['on'](_0x205f0e(0x1b6),_0x1332d8=>{const _0x58434=_0x205f0e;if(_0x1332d8['endsWith'](_0x58434(0x192))||_0x1332d8['endsWith'](_0x58434(0x17f)))return;let _0x453ffa=path['basename'](_0x1332d8),_0x47c76f=dbOther['prepare'](_0x58434(0x191))[_0x58434(0x153)](_0x5e12ff);if(!_0x47c76f)return killFfmpByPlayId(_0x5e12ff);else dbOther[_0x58434(0x186)](_0x58434(0x187))[_0x58434(0x153)](_0x5e12ff,_0x453ffa,'gen');}),_0x2b530a['on'](_0x205f0e(0x181),_0x48e108=>{}),_0x2b530a['on'](_0x205f0e(0x17c),_0x5863fc=>{const _0x5dc509=_0x205f0e;if(_0x5863fc['endsWith'](_0x5dc509(0x192))||_0x5863fc[_0x5dc509(0x1bc)](_0x5dc509(0x17f)))return;let _0x374760=path[_0x5dc509(0x1ac)](_0x5863fc);dbOther[_0x5dc509(0x186)](_0x5dc509(0x187))['run'](_0x5e12ff,_0x374760,_0x5dc509(0x1a1));}),_0x2b530a['on'](_0x205f0e(0x1a2),()=>{m3u8FfmpegTrans(_0x2b530a,_0x5e12ff,_0x36e49e,_0x3773c6,_0x5101fe,_0x252f86,_0x4155ea);});});})['catch'](_0x25e484=>{});}fs[_0x12dea9(0x180)](_0x16588,(_0x45114e,_0xdd0501)=>{_0x45114e?fs['mkdir'](_0x16588,{'recursive':!![]},_0x38e1a6=>{!_0x38e1a6&&_0xbd26f7();}):_0xbd26f7();});}function m3u8FfmpegTrans(_0x6b05d8,_0x313c93,_0x97a0e1,_0x461148,_0x21e73f,_0x598d6e,_0x144606,_0x273242=!![]){const _0xe8de2f=_0x159c6a;try{let _0x3bea41=_0x97a0e1[_0xe8de2f(0x1b8)]&&_0x97a0e1['size']>0xf0?_0x97a0e1[_0xe8de2f(0x1b8)]:0x2d0,{videoStream:_0xddb245,videoWidth:_0x307856,videoHeight:_0x3873a7}=transCodeUtil[_0xe8de2f(0x149)](_0x21e73f),_0x4adcbd=_0x598d6e?cryptoUtils[_0xe8de2f(0x168)](_0x144606,_0x461148):_0x461148;_0x4adcbd=transCodeUtil[_0xe8de2f(0x14c)](_0x4adcbd);let _0x3d400b=FFmpeg(_0x4adcbd),_0x54544a=transCodeUtil['getCoderConfig'](dbOther,_0xddb245);_0x273242&&_0x54544a[_0xe8de2f(0x14b)]&&_0x3d400b[_0xe8de2f(0x17b)](_0x54544a[_0xe8de2f(0x14b)]);if(_0x273242&&_0x54544a['decoderCommand']){let _0x308e4f=transCodeUtil[_0xe8de2f(0x169)](_0xddb245,_0x54544a[_0xe8de2f(0x159)][_0xe8de2f(0x1a9)](_0xe8de2f(0x15f),''));_0x308e4f&&_0x3d400b[_0xe8de2f(0x17b)](_0x54544a[_0xe8de2f(0x159)]);}_0x3d400b['inputOption']('-readrate\x20'+transCodeUtil['getReadRate'](dbOther));let _0x354284=_0x97a0e1[_0xe8de2f(0x14d)]*config[_0xe8de2f(0x17e)];_0x354284&&!_0x598d6e&&_0x3d400b[_0xe8de2f(0x1ba)](''+parseInt(_0x354284));_0x3d400b[_0xe8de2f(0x158)]('aac');_0x54544a[_0xe8de2f(0x19f)]&&_0x3d400b['videoCodec'](_0x54544a[_0xe8de2f(0x19f)]);let _0x1a982f=transCodeUtil[_0xe8de2f(0x157)](_0xddb245,_0x97a0e1[_0xe8de2f(0x1a0)]);_0x3d400b[_0xe8de2f(0x15a)](''+_0x1a982f),_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x19b)+_0x1a982f/0x2+'k');let _0x4f75fa=transCodeUtil[_0xe8de2f(0x1b9)](_0x3bea41,_0x307856,_0x3873a7),_0x53a5fc=null;_0x97a0e1[_0xe8de2f(0x1a3)]==0x1&&_0x97a0e1[_0xe8de2f(0x188)]>-0x1&&(_0x53a5fc=transCodeUtil['parseSubtitle'](_0x21e73f,_0x97a0e1['subtitleIndex']));_0x53a5fc&&(_0x53a5fc[_0xe8de2f(0x1b7)]==_0xe8de2f(0x175)||_0x53a5fc[_0xe8de2f(0x1b7)]==_0xe8de2f(0x182)||_0x53a5fc[_0xe8de2f(0x1b7)]==_0xe8de2f(0x195)||_0x53a5fc['codec_name']=='dvd_subtitle'||_0x53a5fc[_0xe8de2f(0x1b7)]==_0xe8de2f(0x170)||_0x53a5fc[_0xe8de2f(0x1b7)]==_0xe8de2f(0x1b1))?(_0x3d400b['complexFilter']([_0xe8de2f(0x17a)+_0x4f75fa+_0xe8de2f(0x1b2),_0xe8de2f(0x1a5)+_0x97a0e1[_0xe8de2f(0x188)]+_0xe8de2f(0x1c1),_0xe8de2f(0x1b3)]),_0x3d400b[_0xe8de2f(0x150)](_0xe8de2f(0x152))):(_0x4f75fa&&_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x165)+_0x4f75fa),_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x14a)));_0x3d400b['addOption'](_0xe8de2f(0x18f)+(_0x97a0e1[_0xe8de2f(0x19e)]?_0x97a0e1[_0xe8de2f(0x19e)]:0x0)+'?');let _0xd90c66=transCodeUtil['getFps'](_0xddb245);_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x1ad)+_0xd90c66),_0x3d400b[_0xe8de2f(0x173)]('-g\x20'+_0xd90c66);let _0x218d9f=transCodeUtil[_0xe8de2f(0x16f)](dbOther,_0x54544a[_0xe8de2f(0x19f)]);_0x218d9f!='medium'&&_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x15b)+_0x218d9f);let _0x1c096a=transCodeUtil[_0xe8de2f(0x1be)](_0xddb245,_0x54544a[_0xe8de2f(0x19f)]);_0x1c096a&&_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x198)+_0x1c096a);_0x3d400b['addOption']('-copyts');_0x97a0e1['ac']&&_0x97a0e1['ac']>0x0&&_0x97a0e1['ac']<=0x18?_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x14f)+_0x97a0e1['ac']):_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x174));let _0x35eb86=transCodeUtil[_0xe8de2f(0x1a6)](dbOther);_0x3d400b['addOption'](_0xe8de2f(0x17d)+_0x35eb86),_0x3d400b[_0xe8de2f(0x183)](_0xe8de2f(0x176)),_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x16a)+config[_0xe8de2f(0x17e)]),_0x3d400b[_0xe8de2f(0x173)]('-hls_list_size\x200');let _0x75a435=_0x97a0e1['seq'];_0x75a435&&_0x354284&&!_0x598d6e&&_0x3d400b[_0xe8de2f(0x173)](_0xe8de2f(0x16e)+_0x75a435);let _0x3204f7=path[_0xe8de2f(0x19a)](config['m3u8TmpPath'],_0x313c93,_0xe8de2f(0x163));_0x3204f7=transCodeUtil[_0xe8de2f(0x14c)](_0x3204f7),_0x3d400b[_0xe8de2f(0x177)](''+_0x3204f7);let _0x3e630d=path[_0xe8de2f(0x1b4)](_0x3204f7);fs[_0xe8de2f(0x180)](_0x3e630d,(_0xefce6e,_0x9924f3)=>{const _0x900550=_0xe8de2f;if(_0xefce6e){fs[_0x900550(0x178)](_0x3e630d,{'recursive':!![]},_0x10b10e=>{if(_0x10b10e)return;_0xa801d(_0x3d400b);});return;}_0xa801d(_0x3d400b);});function _0x4eb289(){const _0x497d0a=_0xe8de2f;_0x273242&&(console[_0x497d0a(0x160)]('!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!'),killFfmpByPlayId(_0x313c93,![]),m3u8FfmpegTrans(_0x6b05d8,_0x313c93,_0x97a0e1,_0x461148,_0x21e73f,_0x598d6e,_0x144606,![]));}function _0xa801d(){const _0x5f3e94=_0xe8de2f;_0x3d400b['run'](),addFfmpToList(_0x3d400b,_0x313c93,_0x6b05d8),_0x3d400b['on'](_0x5f3e94(0x18c),function(_0x5de409){const _0x5cece1=_0x5f3e94;console[_0x5cece1(0x160)](_0x5de409);})['on'](_0x5f3e94(0x190),function(_0x2f27d3){const _0x52c192=_0x5f3e94;_0x273242&&_0x54544a&&_0x2f27d3&&_0x2f27d3[_0x52c192(0x171)](_0x52c192(0x1b5))!=-0x1&&(console['log'](_0x52c192(0x166)),_0x4eb289());})['on'](_0x5f3e94(0x181),function(_0x43bca9){const _0x1fa829=_0x5f3e94;_0x43bca9[_0x1fa829(0x172)]&&_0x43bca9[_0x1fa829(0x172)][_0x1fa829(0x171)](_0x1fa829(0x1ae))==-0x1&&(console['log'](_0x43bca9),_0x4eb289());})['on'](_0x5f3e94(0x162),function(_0x36a22c){const _0xba34fd=_0x5f3e94;console[_0xba34fd(0x160)](_0x36a22c);});}}catch(_0x2cc505){console[_0xe8de2f(0x160)](_0x2cc505),_0x6b05d8[_0xe8de2f(0x16d)]();}}setInterval(()=>{const _0x35f1e7=_0x159c6a;let _0xe00425=new Date()[_0x35f1e7(0x15d)](),_0x1f2e40=0xea60;for(let _0x30bfe3 in ffmpList){let _0x1bdc80=ffmpList[_0x30bfe3],_0x777c25=_0xe00425-_0x1bdc80[_0x35f1e7(0x1bf)];_0x1bdc80[_0x35f1e7(0x1bf)]&&_0x777c25>_0x1f2e40&&(console['log']('No\x20request\x20timeout\x20'),killFfmpByPlayId(_0x1bdc80['playId']));}},0x2710),process['on'](_0x159c6a(0x172),_0x26afb4=>{startPlay(_0x26afb4);}),process['on']('exit',(_0x245119,_0x5d30d9)=>{const _0x38d55e=_0x159c6a;process[_0x38d55e(0x1bb)]({'type':_0x38d55e(0x16d)});});