const _0x5c7d79=_0x56cc;(function(_0x467bd7,_0x15e8eb){const _0x51bb9c=_0x56cc,_0x2983a9=_0x467bd7();while(!![]){try{const _0x2ad086=-parseInt(_0x51bb9c(0xf6))/0x1*(-parseInt(_0x51bb9c(0x119))/0x2)+parseInt(_0x51bb9c(0x14c))/0x3*(parseInt(_0x51bb9c(0x12c))/0x4)+parseInt(_0x51bb9c(0x14b))/0x5*(parseInt(_0x51bb9c(0x11d))/0x6)+-parseInt(_0x51bb9c(0x143))/0x7*(-parseInt(_0x51bb9c(0x13e))/0x8)+-parseInt(_0x51bb9c(0x12e))/0x9+-parseInt(_0x51bb9c(0x13d))/0xa*(parseInt(_0x51bb9c(0x15d))/0xb)+-parseInt(_0x51bb9c(0x138))/0xc;if(_0x2ad086===_0x15e8eb)break;else _0x2983a9['push'](_0x2983a9['shift']());}catch(_0x271243){_0x2983a9['push'](_0x2983a9['shift']());}}}(_0x2197,0xd0d54));const path=require(_0x5c7d79(0x11f)),fs=require('fs'),config=require(_0x5c7d79(0x146)),transCodeUtil=require(_0x5c7d79(0x153)),Database=require(_0x5c7d79(0x145)),dbOther=new Database(config[_0x5c7d79(0x135)],{}),dbFileIndex=new Database(config[_0x5c7d79(0x12a)],{'timeout':0xea60});dbOther['pragma']('journal_mode\x20=\x20WAL'),dbFileIndex[_0x5c7d79(0x159)](_0x5c7d79(0x160));const FFmpeg=require(_0x5c7d79(0x112))[_0x5c7d79(0xfd)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require('../express-server/utils/cryptoUtils');function _0x56cc(_0x3e6977,_0x1a3d8d){const _0x2197d4=_0x2197();return _0x56cc=function(_0x56ccd3,_0x4cb841){_0x56ccd3=_0x56ccd3-0xde;let _0xefa551=_0x2197d4[_0x56ccd3];return _0xefa551;},_0x56cc(_0x3e6977,_0x1a3d8d);}function _0x2197(){const _0x282aa=['169030bSyKBY','896NmyaMD','catch','error','-map\x200:a:','watch','95823SmmHCl','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','better-sqlite3','../myConfig/config','-readrate\x20','hls','-start_number\x20','More\x20data\x20is\x20required\x20to\x20decode\x20header','5tYsTNr','3oztSgB','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','][vs]scale2ref[sub][ref]','videobit','dvd_subtitle','hdmv_pgs_subtitle','chokidar','../utils/transCodeUtil','platform','endsWith','-preset\x20','videoBitrate','getVideoBitrate','pragma','title','basename','[vs]','737wUbZOW','getCrf','close','journal_mode\x20=\x20WAL','constants','getReadRate','-map\x200:v:0?','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','addOption','indexOf','subtitleIndex','[0:v:0]','parseVideoFullPath','complexFilter','stop','ffmp','killed','Stop\x20transcode\x20','stat','add','send','burn','dvdsub','stderr','output','change','dealFFmpegPath','lastTsReqTime','mkdir','-crf\x20','dirWatcher','getFps','1wetVxv','NasCabHlsWorker','-hls_list_size\x200','getTime','hwaccel','splice','seq','FFmpeg','-copyts','log','exit','join','pgssub','qsv\x20cannot\x20deal,restart\x20ffmpeg','format','getScaleOption','start','gen','end','m3u8TmpPath','-ac\x202','decryptFileGetStream','audioIndex','medium','encoderName','-hls_time\x20','-c:v\x20','message','../libs/nasTrans','codec_name','[ref][sub]overlay[vss]','get','getCoderConfig','run','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','1001836LcQFdw','stream.m3u8','-pix_fmt\x20','dvb_subtitle','10127946iiPKMS','replace','path','addInputOption','m3u8segmentDuration','ready','push','.tmp','-bufsize\x20','getTranscodeSpeed','videoCodec','vobsub','aac','dbFileIndex','access','6809884HXaHmJ','then','10099008vwInRH','inputOption','-filter:v\x20','decoderCommand','decoderSupportPixFormat','size','playId','dbOther','.m3u8','prepare','27774660iPSzNE','[0:s:','audioCodec','*.m3u8','includes'];_0x2197=function(){return _0x282aa;};return _0x2197();}const chokidar=require(_0x5c7d79(0x152)),platform=require('os')[_0x5c7d79(0x154)];process[_0x5c7d79(0x15a)]=_0x5c7d79(0xf7);function setLastReqTime(_0x343b8d){const _0x6e2059=_0x5c7d79;for(let _0x2a4079 in ffmpList){let _0x20bfa4=ffmpList[_0x2a4079];if(_0x20bfa4[_0x6e2059(0x134)]==_0x343b8d)return ffmpList[_0x2a4079][_0x6e2059(0xf1)]=new Date()[_0x6e2059(0xf9)]();}}function addFfmpToList(_0x2a3813,_0x2f383b,_0xb6d404){const _0x468750=_0x5c7d79;ffmpList[_0x468750(0x123)]({'ffmp':_0x2a3813,'playId':_0x2f383b,'dirWatcher':_0xb6d404,'lastTsReqTime':new Date()['getTime']()});}function killFfmpByPlayId(_0x47651d,_0x46b99d=!![]){const _0x1cd5c7=_0x5c7d79;console['log'](_0x1cd5c7(0xe7),_0x47651d);for(let _0x2613ed in startedPlayIdList){let _0x5de02c=startedPlayIdList[_0x2613ed];if(_0x5de02c==_0x47651d){startedPlayIdList['splice'](_0x2613ed,0x1);break;}}for(let _0x2591ce in ffmpList){let _0x5ab875=ffmpList[_0x2591ce];if(_0x5ab875[_0x1cd5c7(0x134)]==_0x47651d){ffmpList[_0x1cd5c7(0xfb)](_0x2591ce,0x1);let _0x16a76f=_0x5ab875[_0x1cd5c7(0xe5)]['kill']();_0x46b99d&&setTimeout(()=>{const _0x21e5b6=_0x1cd5c7;_0x5ab875[_0x21e5b6(0xf4)][_0x21e5b6(0x15f)]()[_0x21e5b6(0x12d)](()=>{});},0x7d0);return;}}}function startPlay(_0x4ee492){const _0x23456=_0x5c7d79;let {playId:_0x425751,args:_0xd86bda,action:_0x29d230}=_0x4ee492;if(!_0x425751)return;if(_0x29d230==_0x23456(0xe4)){killFfmpByPlayId(_0x425751);return;}for(let _0x566a70 in ffmpList){let _0x224c7a=ffmpList[_0x566a70];if(_0x224c7a[_0x23456(0x134)]==_0x425751){setLastReqTime(_0x425751);return;}}if(startedPlayIdList[_0x23456(0x13c)](_0x425751)){console[_0x23456(0xff)]('Play\x20ID\x20has\x20started');return;}startedPlayIdList[_0x23456(0x123)](_0x425751);let _0x5e7cbf=dbOther[_0x23456(0x137)](_0x23456(0x14d))[_0x23456(0x115)](_0x425751);if(!_0x5e7cbf)return;let _0x3fc92d=path[_0x23456(0x101)](config[_0x23456(0x109)],_0x425751);function _0x2dd791(){const _0x1c246a=_0x23456;transCodeUtil[_0x1c246a(0xe2)](dbFileIndex,dbOther,_0xd86bda)[_0x1c246a(0x12d)](_0xfa0b9b=>{const _0x5d018f=_0x1c246a;let {fullpath:_0x114a75,streamList:_0x573636,needDecrypt:_0x11b6ef,pwd:_0x22a1b5,duration:_0xf478dd}=_0xfa0b9b;fs[_0x5d018f(0x12b)](_0x114a75,fs[_0x5d018f(0x161)]['R_OK'],_0x413c7b=>{const _0x5544e8=_0x5d018f;if(_0x413c7b)return;let _0x3efa5b=chokidar[_0x5544e8(0x142)](_0x3fc92d,{'ignored':_0x5544e8(0x13b),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x3efa5b['on'](_0x5544e8(0xe9),_0x15c381=>{const _0x3d551e=_0x5544e8;if(_0x15c381['endsWith'](_0x3d551e(0x124))||_0x15c381[_0x3d551e(0x155)](_0x3d551e(0x136)))return;let _0x3fd68a=path[_0x3d551e(0x15b)](_0x15c381),_0xbda01a=dbOther[_0x3d551e(0x137)](_0x3d551e(0x164))['run'](_0x425751);if(!_0xbda01a)return killFfmpByPlayId(_0x425751);else dbOther[_0x3d551e(0x137)](_0x3d551e(0x144))[_0x3d551e(0x117)](_0x425751,_0x3fd68a,_0x3d551e(0x107));}),_0x3efa5b['on'](_0x5544e8(0x140),_0x4f5388=>{}),_0x3efa5b['on'](_0x5544e8(0xef),_0x4efa5f=>{const _0x24ce2d=_0x5544e8;if(_0x4efa5f[_0x24ce2d(0x155)](_0x24ce2d(0x124))||_0x4efa5f[_0x24ce2d(0x155)](_0x24ce2d(0x136)))return;let _0xfd6740=path[_0x24ce2d(0x15b)](_0x4efa5f);dbOther['prepare'](_0x24ce2d(0x144))[_0x24ce2d(0x117)](_0x425751,_0xfd6740,'gen');}),_0x3efa5b['on'](_0x5544e8(0x122),()=>{m3u8FfmpegTrans(_0x3efa5b,_0x425751,_0xd86bda,_0x114a75,_0x573636,_0x11b6ef,_0x22a1b5);});});})[_0x1c246a(0x13f)](_0x548627=>{});}fs[_0x23456(0xe8)](_0x3fc92d,(_0x1e561b,_0x48494a)=>{_0x1e561b?fs['mkdir'](_0x3fc92d,{'recursive':!![]},_0x114e22=>{!_0x114e22&&_0x2dd791();}):_0x2dd791();});}function m3u8FfmpegTrans(_0x331a6f,_0x21ecb7,_0x19641b,_0x354784,_0x10cdd9,_0x5c1ea5,_0x12b7ec,_0x203470=!![]){const _0x3c4362=_0x5c7d79;try{let _0x57b645=_0x19641b[_0x3c4362(0x133)]&&_0x19641b['size']>0xf0?_0x19641b[_0x3c4362(0x133)]:0x2d0,{videoStream:_0x39495f,videoWidth:_0x39a936,videoHeight:_0x2a21c9}=transCodeUtil['parseStreamList'](_0x10cdd9),_0x4988e9=_0x5c1ea5?cryptoUtils[_0x3c4362(0x10b)](_0x12b7ec,_0x354784):_0x354784;_0x4988e9=transCodeUtil[_0x3c4362(0xf0)](_0x4988e9);let _0x5d854e=FFmpeg(_0x4988e9),_0x530429=transCodeUtil[_0x3c4362(0x116)](dbOther,_0x39495f);_0x203470&&_0x530429[_0x3c4362(0xfa)]&&_0x5d854e[_0x3c4362(0x120)](_0x530429[_0x3c4362(0xfa)]);if(_0x203470&&_0x530429[_0x3c4362(0x131)]){let _0xf3df64=transCodeUtil[_0x3c4362(0x132)](_0x39495f,_0x530429[_0x3c4362(0x131)][_0x3c4362(0x11e)](_0x3c4362(0x110),''));_0xf3df64&&_0x5d854e[_0x3c4362(0x120)](_0x530429[_0x3c4362(0x131)]);}_0x5d854e[_0x3c4362(0x12f)](_0x3c4362(0x147)+transCodeUtil[_0x3c4362(0x162)](dbOther));let _0x1d625d=_0x19641b[_0x3c4362(0xfc)]*config[_0x3c4362(0x121)];_0x1d625d&&!_0x5c1ea5&&_0x5d854e['seekInput'](''+parseInt(_0x1d625d));_0x5d854e[_0x3c4362(0x13a)](_0x3c4362(0x129));_0x530429[_0x3c4362(0x10e)]&&_0x5d854e[_0x3c4362(0x127)](_0x530429[_0x3c4362(0x10e)]);let _0x5dd8fd=transCodeUtil[_0x3c4362(0x158)](_0x39495f,_0x19641b[_0x3c4362(0x14f)]);_0x5d854e[_0x3c4362(0x157)](''+_0x5dd8fd),_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x125)+_0x5dd8fd/0x2+'k');let _0x284cba=transCodeUtil[_0x3c4362(0x105)](_0x57b645,_0x39a936,_0x2a21c9),_0x40b73b=null;_0x19641b[_0x3c4362(0xeb)]==0x1&&_0x19641b[_0x3c4362(0xe0)]>-0x1&&(_0x40b73b=transCodeUtil['parseSubtitle'](_0x10cdd9,_0x19641b['subtitleIndex']));_0x40b73b&&(_0x40b73b[_0x3c4362(0x113)]==_0x3c4362(0x102)||_0x40b73b['codec_name']==_0x3c4362(0x151)||_0x40b73b[_0x3c4362(0x113)]==_0x3c4362(0x128)||_0x40b73b['codec_name']==_0x3c4362(0x150)||_0x40b73b[_0x3c4362(0x113)]==_0x3c4362(0xec)||_0x40b73b['codec_name']==_0x3c4362(0x11c))?(_0x5d854e[_0x3c4362(0xe3)]([_0x3c4362(0xe1)+_0x284cba+_0x3c4362(0x15c),_0x3c4362(0x139)+_0x19641b[_0x3c4362(0xe0)]+_0x3c4362(0x14e),_0x3c4362(0x114)]),_0x5d854e['addOutputOption']('-map\x20[vss]')):(_0x284cba&&_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x130)+_0x284cba),_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x163)));_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x141)+(_0x19641b[_0x3c4362(0x10c)]?_0x19641b['audioIndex']:0x0)+'?');let _0x137243=transCodeUtil[_0x3c4362(0xf5)](_0x39495f);_0x5d854e[_0x3c4362(0xde)]('-r\x20'+_0x137243),_0x5d854e['addOption']('-g\x20'+_0x137243);let _0x1d2233=transCodeUtil[_0x3c4362(0x126)](dbOther,_0x530429[_0x3c4362(0x10e)]);_0x1d2233!=_0x3c4362(0x10d)&&_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x156)+_0x1d2233);let _0x559382=transCodeUtil['getPixFmt'](_0x39495f,_0x530429[_0x3c4362(0x10e)]);_0x559382&&_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x11b)+_0x559382);_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0xfe));_0x19641b['ac']&&_0x19641b['ac']>0x0&&_0x19641b['ac']<=0x18?_0x5d854e[_0x3c4362(0xde)]('-ac\x20'+_0x19641b['ac']):_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x10a));let _0x547dd6=transCodeUtil[_0x3c4362(0x15e)](dbOther);_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0xf3)+_0x547dd6),_0x5d854e[_0x3c4362(0x104)](_0x3c4362(0x148)),_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0x10f)+config[_0x3c4362(0x121)]),_0x5d854e[_0x3c4362(0xde)](_0x3c4362(0xf8));let _0x48ef20=_0x19641b['seq'];_0x48ef20&&_0x1d625d&&!_0x5c1ea5&&_0x5d854e['addOption'](_0x3c4362(0x149)+_0x48ef20);let _0x496570=path['join'](config[_0x3c4362(0x109)],_0x21ecb7,_0x3c4362(0x11a));_0x496570=transCodeUtil[_0x3c4362(0xf0)](_0x496570),_0x5d854e[_0x3c4362(0xee)](''+_0x496570);let _0x4bfc86=path['dirname'](_0x496570);fs[_0x3c4362(0xe8)](_0x4bfc86,(_0x1ec7e3,_0x523ca8)=>{const _0x186e41=_0x3c4362;if(_0x1ec7e3){fs[_0x186e41(0xf2)](_0x4bfc86,{'recursive':!![]},_0xe61729=>{if(_0xe61729)return;_0x9ba1a1(_0x5d854e);});return;}_0x9ba1a1(_0x5d854e);});function _0x5006fa(){const _0x1fae2c=_0x3c4362;_0x203470&&(console[_0x1fae2c(0xff)](_0x1fae2c(0x118)),killFfmpByPlayId(_0x21ecb7,![]),m3u8FfmpegTrans(_0x331a6f,_0x21ecb7,_0x19641b,_0x354784,_0x10cdd9,_0x5c1ea5,_0x12b7ec,![]));}function _0x9ba1a1(){const _0x4e703f=_0x3c4362;_0x5d854e[_0x4e703f(0x117)](),addFfmpToList(_0x5d854e,_0x21ecb7,_0x331a6f),_0x5d854e['on'](_0x4e703f(0x106),function(_0x54a1e4){const _0x54cd44=_0x4e703f;console[_0x54cd44(0xff)](_0x54a1e4);})['on'](_0x4e703f(0xed),function(_0x2ee05f){const _0x1c4aab=_0x4e703f;_0x203470&&_0x530429&&_0x2ee05f&&_0x2ee05f[_0x1c4aab(0xdf)](_0x1c4aab(0x14a))!=-0x1&&(console['log'](_0x1c4aab(0x103)),_0x5006fa());})['on']('error',function(_0x5f2eab){const _0x4b9d80=_0x4e703f;_0x5f2eab[_0x4b9d80(0x111)]&&_0x5f2eab['message'][_0x4b9d80(0xdf)](_0x4b9d80(0xe6))==-0x1&&(console[_0x4b9d80(0xff)](_0x5f2eab),_0x5006fa());})['on'](_0x4e703f(0x108),function(_0x39da65){const _0x2c3d37=_0x4e703f;console[_0x2c3d37(0xff)](_0x39da65);});}}catch(_0x530b40){console[_0x3c4362(0xff)](_0x530b40),_0x331a6f[_0x3c4362(0x15f)]();}}setInterval(()=>{const _0x2287b0=_0x5c7d79;let _0x56104c=new Date()[_0x2287b0(0xf9)](),_0x254c55=0xea60;for(let _0x23e7cf in ffmpList){let _0x2037dd=ffmpList[_0x23e7cf],_0x1ffb12=_0x56104c-_0x2037dd[_0x2287b0(0xf1)];_0x2037dd['lastTsReqTime']&&_0x1ffb12>_0x254c55&&(console['log']('No\x20request\x20timeout\x20'),killFfmpByPlayId(_0x2037dd[_0x2287b0(0x134)]));}},0x2710),process['on']('message',_0x1c7b46=>{startPlay(_0x1c7b46);}),process['on'](_0x5c7d79(0x100),(_0x10d0c6,_0x349f83)=>{const _0x5d4985=_0x5c7d79;process[_0x5d4985(0xea)]({'type':_0x5d4985(0x15f)});});