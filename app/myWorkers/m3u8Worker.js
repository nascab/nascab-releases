const _0x1faf50=_0x3996;(function(_0x333912,_0xdbda52){const _0x20caf6=_0x3996,_0x3b6451=_0x333912();while(!![]){try{const _0x2bd9c3=-parseInt(_0x20caf6(0x215))/0x1+parseInt(_0x20caf6(0x230))/0x2+parseInt(_0x20caf6(0x1f1))/0x3*(parseInt(_0x20caf6(0x250))/0x4)+parseInt(_0x20caf6(0x249))/0x5*(-parseInt(_0x20caf6(0x235))/0x6)+-parseInt(_0x20caf6(0x229))/0x7+-parseInt(_0x20caf6(0x209))/0x8*(parseInt(_0x20caf6(0x210))/0x9)+parseInt(_0x20caf6(0x23d))/0xa;if(_0x2bd9c3===_0xdbda52)break;else _0x3b6451['push'](_0x3b6451['shift']());}catch(_0x31c88f){_0x3b6451['push'](_0x3b6451['shift']());}}}(_0x13e0,0xe067d));const path=require(_0x1faf50(0x252)),fs=require('fs'),config=require(_0x1faf50(0x1f5)),transCodeUtil=require(_0x1faf50(0x243)),Database=require(_0x1faf50(0x237)),dbOther=new Database(config['dbOther'],{}),dbFileIndex=new Database(config[_0x1faf50(0x220)],{'timeout':0xea60});dbOther[_0x1faf50(0x242)](_0x1faf50(0x214)),dbFileIndex[_0x1faf50(0x242)](_0x1faf50(0x214));function _0x13e0(){const _0x5036f4=['../libs/nasTrans','run','log','-start_number\x20','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','340dbGvzr','error','path','codec_name','complexFilter','getVideoBitrate','getCrf','-copyts','R_OK','ready','NasCabHlsWorker','[ref][sub]overlay[vss]','-r\x20','getTranscodeSpeed','encoderName','*.m3u8','No\x20request\x20timeout\x20','playId','Stop\x20transcode\x20','includes','change','stream.m3u8','][vs]scale2ref[sub][ref]','watch','get','stat','videobit','videoCodec','add','22023lntzPr','seq','start','-c:v\x20','../myConfig/config','.m3u8','hdmv_pgs_subtitle','-ac\x20','prepare','constants','getFps','access','-g\x20','FFmpeg','addOption','hls','lastTsReqTime','audioIndex','seekInput','[0:v:0]','close','platform','-preset\x20','-filter:v\x20','1297040Qotcmo','output','-map\x200:a:','qsv\x20cannot\x20deal,restart\x20ffmpeg','getPixFmt','basename','push','27Izfbyx','size','More\x20data\x20is\x20required\x20to\x20decode\x20header','exit','journal_mode\x20=\x20WAL','197589kikeKq','dvdsub','title','-bufsize\x20','vobsub','end','.tmp','addInputOption','send','inputOption','-map\x20[vss]','dbFileIndex','catch','splice','../express-server/utils/cryptoUtils','videoBitrate','decoderCommand','ffmp','getTime','then','11307247fQrdlN','addOutputOption','endsWith','replace','hwaccel','m3u8TmpPath','indexOf','3131862WxSVXf','mkdir','message','decoderSupportPixFormat','killed','24TgnKZc','-readrate\x20','better-sqlite3','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','gen','subtitleIndex','aac','join','21661530ORjokx','dirWatcher','m3u8segmentDuration','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','pragma','../utils/transCodeUtil','medium','format','-crf\x20','parseSubtitle','decryptFileGetStream','1422005ZqVAzw','parseStreamList'];_0x13e0=function(){return _0x5036f4;};return _0x13e0();}const FFmpeg=require(_0x1faf50(0x24b))[_0x1faf50(0x1fe)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x1faf50(0x223));function _0x3996(_0x5add17,_0x4496b4){const _0x13e05d=_0x13e0();return _0x3996=function(_0x39962f,_0x5095f6){_0x39962f=_0x39962f-0x1ee;let _0x1fa36c=_0x13e05d[_0x39962f];return _0x1fa36c;},_0x3996(_0x5add17,_0x4496b4);}const chokidar=require('chokidar'),platform=require('os')[_0x1faf50(0x206)];process[_0x1faf50(0x217)]=_0x1faf50(0x25a);function setLastReqTime(_0x1ceadc){const _0x263323=_0x1faf50;for(let _0x3a681a in ffmpList){let _0x21e089=ffmpList[_0x3a681a];if(_0x21e089['playId']==_0x1ceadc)return ffmpList[_0x3a681a][_0x263323(0x201)]=new Date()[_0x263323(0x227)]();}}function addFfmpToList(_0x29bef8,_0x4312d7,_0x16f90d){const _0x19b9dd=_0x1faf50;ffmpList[_0x19b9dd(0x20f)]({'ffmp':_0x29bef8,'playId':_0x4312d7,'dirWatcher':_0x16f90d,'lastTsReqTime':new Date()[_0x19b9dd(0x227)]()});}function killFfmpByPlayId(_0x194c6d,_0x363355=!![]){const _0x23b595=_0x1faf50;console[_0x23b595(0x24d)](_0x23b595(0x262),_0x194c6d);for(let _0x2d5ab6 in startedPlayIdList){let _0x392c03=startedPlayIdList[_0x2d5ab6];if(_0x392c03==_0x194c6d){startedPlayIdList['splice'](_0x2d5ab6,0x1);break;}}for(let _0x223e7f in ffmpList){let _0x9dca1a=ffmpList[_0x223e7f];if(_0x9dca1a['playId']==_0x194c6d){ffmpList[_0x23b595(0x222)](_0x223e7f,0x1);let _0x5c2216=_0x9dca1a[_0x23b595(0x226)]['kill']();_0x363355&&setTimeout(()=>{const _0x215eac=_0x23b595;_0x9dca1a[_0x215eac(0x23e)][_0x215eac(0x205)]()[_0x215eac(0x228)](()=>{});},0x7d0);return;}}}function startPlay(_0x3f874b){const _0x40e3d8=_0x1faf50;let {playId:_0x3991e0,args:_0x2d5afd,action:_0x5bcc9d}=_0x3f874b;if(!_0x3991e0)return;if(_0x5bcc9d=='stop'){killFfmpByPlayId(_0x3991e0);return;}for(let _0x10dd17 in ffmpList){let _0x1b3d5e=ffmpList[_0x10dd17];if(_0x1b3d5e[_0x40e3d8(0x261)]==_0x3991e0){setLastReqTime(_0x3991e0);return;}}if(startedPlayIdList[_0x40e3d8(0x263)](_0x3991e0)){console['log']('Play\x20ID\x20has\x20started');return;}startedPlayIdList['push'](_0x3991e0);let _0x37bbfb=dbOther[_0x40e3d8(0x1f9)](_0x40e3d8(0x241))[_0x40e3d8(0x268)](_0x3991e0);if(!_0x37bbfb)return;let _0x2374d0=path[_0x40e3d8(0x23c)](config[_0x40e3d8(0x22e)],_0x3991e0);function _0x54cf4f(){const _0x2aa395=_0x40e3d8;transCodeUtil['parseVideoFullPath'](dbFileIndex,dbOther,_0x2d5afd)[_0x2aa395(0x228)](_0x21807f=>{const _0x2886bf=_0x2aa395;let {fullpath:_0x2771bf,streamList:_0x314ea4,needDecrypt:_0x43fb74,pwd:_0x23f730,duration:_0xefb58a}=_0x21807f;fs[_0x2886bf(0x1fc)](_0x2771bf,fs[_0x2886bf(0x1fa)][_0x2886bf(0x258)],_0x5c6a62=>{const _0x3d4fd8=_0x2886bf;if(_0x5c6a62)return;let _0xb3d4d2=chokidar[_0x3d4fd8(0x267)](_0x2374d0,{'ignored':_0x3d4fd8(0x25f),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0xb3d4d2['on'](_0x3d4fd8(0x1f0),_0x45aa8e=>{const _0x483dd0=_0x3d4fd8;if(_0x45aa8e['endsWith'](_0x483dd0(0x21b))||_0x45aa8e['endsWith'](_0x483dd0(0x1f6)))return;let _0x2026b8=path[_0x483dd0(0x20e)](_0x45aa8e),_0xc30882=dbOther[_0x483dd0(0x1f9)](_0x483dd0(0x238))[_0x483dd0(0x24c)](_0x3991e0);if(!_0xc30882)return killFfmpByPlayId(_0x3991e0);else dbOther['prepare'](_0x483dd0(0x240))[_0x483dd0(0x24c)](_0x3991e0,_0x2026b8,_0x483dd0(0x239));}),_0xb3d4d2['on']('error',_0x154ae0=>{}),_0xb3d4d2['on'](_0x3d4fd8(0x264),_0x5c5c63=>{const _0x43c3f6=_0x3d4fd8;if(_0x5c5c63[_0x43c3f6(0x22b)](_0x43c3f6(0x21b))||_0x5c5c63[_0x43c3f6(0x22b)]('.m3u8'))return;let _0x53aea6=path[_0x43c3f6(0x20e)](_0x5c5c63);dbOther[_0x43c3f6(0x1f9)](_0x43c3f6(0x240))[_0x43c3f6(0x24c)](_0x3991e0,_0x53aea6,_0x43c3f6(0x239));}),_0xb3d4d2['on'](_0x3d4fd8(0x259),()=>{m3u8FfmpegTrans(_0xb3d4d2,_0x3991e0,_0x2d5afd,_0x2771bf,_0x314ea4,_0x43fb74,_0x23f730);});});})[_0x2aa395(0x221)](_0x3afdb5=>{});}fs[_0x40e3d8(0x269)](_0x2374d0,(_0x343491,_0x290ab6)=>{_0x343491?fs['mkdir'](_0x2374d0,{'recursive':!![]},_0x503c98=>{!_0x503c98&&_0x54cf4f();}):_0x54cf4f();});}function m3u8FfmpegTrans(_0x17f1c4,_0x55fdbe,_0xcb12d8,_0x47e5cd,_0x4069db,_0x59031d,_0x32f458,_0x420e17=!![]){const _0x443352=_0x1faf50;try{let _0x5c0ae2=_0xcb12d8[_0x443352(0x211)]&&_0xcb12d8[_0x443352(0x211)]>0xf0?_0xcb12d8['size']:0x2d0,{videoStream:_0x1d3d3d,videoWidth:_0x3d82bf,videoHeight:_0x2bcfbd}=transCodeUtil[_0x443352(0x24a)](_0x4069db),_0x3a1b60=_0x59031d?cryptoUtils[_0x443352(0x248)](_0x32f458,_0x47e5cd):_0x47e5cd;_0x3a1b60=transCodeUtil['dealFFmpegPath'](_0x3a1b60);let _0x12c75=FFmpeg(_0x3a1b60),_0x59274f=transCodeUtil['getCoderConfig'](dbOther,_0x1d3d3d);_0x420e17&&_0x59274f['hwaccel']&&_0x12c75[_0x443352(0x21c)](_0x59274f[_0x443352(0x22d)]);if(_0x420e17&&_0x59274f['decoderCommand']){let _0x2470d3=transCodeUtil[_0x443352(0x233)](_0x1d3d3d,_0x59274f[_0x443352(0x225)][_0x443352(0x22c)](_0x443352(0x1f4),''));_0x2470d3&&_0x12c75[_0x443352(0x21c)](_0x59274f['decoderCommand']);}_0x12c75[_0x443352(0x21e)](_0x443352(0x236)+transCodeUtil['getReadRate'](dbOther));let _0x11eb06=_0xcb12d8['seq']*config[_0x443352(0x23f)];_0x11eb06&&!_0x59031d&&_0x12c75[_0x443352(0x203)](''+parseInt(_0x11eb06));_0x12c75['audioCodec'](_0x443352(0x23b));_0x59274f['encoderName']&&_0x12c75[_0x443352(0x1ef)](_0x59274f['encoderName']);let _0x5873d5=transCodeUtil[_0x443352(0x255)](_0x1d3d3d,_0xcb12d8[_0x443352(0x1ee)]);_0x12c75[_0x443352(0x224)](''+_0x5873d5),_0x12c75['addOption'](_0x443352(0x218)+_0x5873d5/0x2+'k');let _0x469bf4=transCodeUtil['getScaleOption'](_0x5c0ae2,_0x3d82bf,_0x2bcfbd),_0x4b663e=null;_0xcb12d8['burn']==0x1&&_0xcb12d8['subtitleIndex']>-0x1&&(_0x4b663e=transCodeUtil[_0x443352(0x247)](_0x4069db,_0xcb12d8[_0x443352(0x23a)]));_0x4b663e&&(_0x4b663e[_0x443352(0x253)]=='pgssub'||_0x4b663e['codec_name']==_0x443352(0x1f7)||_0x4b663e[_0x443352(0x253)]==_0x443352(0x219)||_0x4b663e[_0x443352(0x253)]=='dvd_subtitle'||_0x4b663e[_0x443352(0x253)]==_0x443352(0x216)||_0x4b663e[_0x443352(0x253)]=='dvb_subtitle')?(_0x12c75[_0x443352(0x254)]([_0x443352(0x204)+_0x469bf4+'[vs]','[0:s:'+_0xcb12d8[_0x443352(0x23a)]+_0x443352(0x266),_0x443352(0x25b)]),_0x12c75[_0x443352(0x22a)](_0x443352(0x21f))):(_0x469bf4&&_0x12c75['addOption'](_0x443352(0x208)+_0x469bf4),_0x12c75['addOption']('-map\x200:v:0?'));_0x12c75[_0x443352(0x1ff)](_0x443352(0x20b)+(_0xcb12d8[_0x443352(0x202)]?_0xcb12d8[_0x443352(0x202)]:0x0)+'?');let _0x3c96c3=transCodeUtil[_0x443352(0x1fb)](_0x1d3d3d);_0x12c75[_0x443352(0x1ff)](_0x443352(0x25c)+_0x3c96c3),_0x12c75[_0x443352(0x1ff)](_0x443352(0x1fd)+_0x3c96c3);let _0x3631c9=transCodeUtil[_0x443352(0x25d)](dbOther,_0x59274f['encoderName']);_0x3631c9!=_0x443352(0x244)&&_0x12c75[_0x443352(0x1ff)](_0x443352(0x207)+_0x3631c9);let _0x1bf834=transCodeUtil[_0x443352(0x20d)](_0x1d3d3d,_0x59274f[_0x443352(0x25e)]);_0x1bf834&&_0x12c75[_0x443352(0x1ff)]('-pix_fmt\x20'+_0x1bf834);_0x12c75['addOption'](_0x443352(0x257));_0xcb12d8['ac']&&_0xcb12d8['ac']>0x0&&_0xcb12d8['ac']<=0x18?_0x12c75[_0x443352(0x1ff)](_0x443352(0x1f8)+_0xcb12d8['ac']):_0x12c75[_0x443352(0x1ff)]('-ac\x202');let _0x38bd23=transCodeUtil[_0x443352(0x256)](dbOther);_0x12c75[_0x443352(0x1ff)](_0x443352(0x246)+_0x38bd23),_0x12c75[_0x443352(0x245)](_0x443352(0x200)),_0x12c75[_0x443352(0x1ff)]('-hls_time\x20'+config[_0x443352(0x23f)]),_0x12c75[_0x443352(0x1ff)]('-hls_list_size\x200');let _0x5d6c16=_0xcb12d8[_0x443352(0x1f2)];_0x5d6c16&&_0x11eb06&&!_0x59031d&&_0x12c75[_0x443352(0x1ff)](_0x443352(0x24e)+_0x5d6c16);let _0x12c55d=path[_0x443352(0x23c)](config[_0x443352(0x22e)],_0x55fdbe,_0x443352(0x265));_0x12c55d=transCodeUtil['dealFFmpegPath'](_0x12c55d),_0x12c75[_0x443352(0x20a)](''+_0x12c55d);let _0x4a2a8=path['dirname'](_0x12c55d);fs['stat'](_0x4a2a8,(_0x4455ea,_0x5b3d87)=>{const _0xc5191d=_0x443352;if(_0x4455ea){fs[_0xc5191d(0x231)](_0x4a2a8,{'recursive':!![]},_0x4745a8=>{if(_0x4745a8)return;_0x39e5d3(_0x12c75);});return;}_0x39e5d3(_0x12c75);});function _0x3e8e23(){const _0x3cc374=_0x443352;_0x420e17&&(console[_0x3cc374(0x24d)](_0x3cc374(0x24f)),killFfmpByPlayId(_0x55fdbe,![]),m3u8FfmpegTrans(_0x17f1c4,_0x55fdbe,_0xcb12d8,_0x47e5cd,_0x4069db,_0x59031d,_0x32f458,![]));}function _0x39e5d3(){const _0x3f29ec=_0x443352;_0x12c75[_0x3f29ec(0x24c)](),addFfmpToList(_0x12c75,_0x55fdbe,_0x17f1c4),_0x12c75['on'](_0x3f29ec(0x1f3),function(_0x4fe86c){console['log'](_0x4fe86c);})['on']('stderr',function(_0x3e3eb4){const _0x46999d=_0x3f29ec;_0x420e17&&_0x59274f&&_0x3e3eb4&&_0x3e3eb4[_0x46999d(0x22f)](_0x46999d(0x212))!=-0x1&&(console['log'](_0x46999d(0x20c)),_0x3e8e23());})['on'](_0x3f29ec(0x251),function(_0x21b210){const _0x526dd4=_0x3f29ec;_0x21b210[_0x526dd4(0x232)]&&_0x21b210[_0x526dd4(0x232)][_0x526dd4(0x22f)](_0x526dd4(0x234))==-0x1&&(console[_0x526dd4(0x24d)](_0x21b210),_0x3e8e23());})['on'](_0x3f29ec(0x21a),function(_0x34e62d){const _0x653fcb=_0x3f29ec;console[_0x653fcb(0x24d)](_0x34e62d);});}}catch(_0x1c5d40){console[_0x443352(0x24d)](_0x1c5d40),_0x17f1c4[_0x443352(0x205)]();}}setInterval(()=>{const _0x5233c1=_0x1faf50;let _0x2ca285=new Date()[_0x5233c1(0x227)](),_0x449569=0xea60;for(let _0x11b797 in ffmpList){let _0x5d4e1d=ffmpList[_0x11b797],_0x441e64=_0x2ca285-_0x5d4e1d[_0x5233c1(0x201)];_0x5d4e1d[_0x5233c1(0x201)]&&_0x441e64>_0x449569&&(console[_0x5233c1(0x24d)](_0x5233c1(0x260)),killFfmpByPlayId(_0x5d4e1d[_0x5233c1(0x261)]));}},0x2710),process['on']('message',_0x1db597=>{startPlay(_0x1db597);}),process['on'](_0x1faf50(0x213),(_0x1f6709,_0x2e15d5)=>{const _0x6a1cf=_0x1faf50;process[_0x6a1cf(0x21d)]({'type':_0x6a1cf(0x205)});});