const _0x1bffc1=_0x5bdd;(function(_0x2e8171,_0x269201){const _0x50f1cc=_0x5bdd,_0x2b7cd0=_0x2e8171();while(!![]){try{const _0x53f158=-parseInt(_0x50f1cc(0x148))/0x1*(parseInt(_0x50f1cc(0x119))/0x2)+parseInt(_0x50f1cc(0x10f))/0x3*(parseInt(_0x50f1cc(0x135))/0x4)+parseInt(_0x50f1cc(0x147))/0x5*(-parseInt(_0x50f1cc(0xfa))/0x6)+parseInt(_0x50f1cc(0x13f))/0x7*(parseInt(_0x50f1cc(0xfd))/0x8)+parseInt(_0x50f1cc(0x126))/0x9+parseInt(_0x50f1cc(0xfc))/0xa*(-parseInt(_0x50f1cc(0x115))/0xb)+parseInt(_0x50f1cc(0x16b))/0xc;if(_0x53f158===_0x269201)break;else _0x2b7cd0['push'](_0x2b7cd0['shift']());}catch(_0xcc5330){_0x2b7cd0['push'](_0x2b7cd0['shift']());}}}(_0x4c7b,0xc73f3));function _0x5bdd(_0x1b2e3e,_0x5c1f8a){const _0x4c7b84=_0x4c7b();return _0x5bdd=function(_0x5bdd4a,_0x537dbf){_0x5bdd4a=_0x5bdd4a-0xf5;let _0x8b1b7c=_0x4c7b84[_0x5bdd4a];return _0x8b1b7c;},_0x5bdd(_0x1b2e3e,_0x5c1f8a);}const path=require(_0x1bffc1(0x144)),fs=require('fs'),config=require(_0x1bffc1(0x106)),transCodeUtil=require(_0x1bffc1(0x108)),Database=require(_0x1bffc1(0x117)),dbOther=new Database(config[_0x1bffc1(0x122)],{}),dbFileIndex=new Database(config[_0x1bffc1(0xf6)],{'timeout':0xea60});function _0x4c7b(){const _0x31f810=['../utils/transCodeUtil','access','dvd_subtitle','ready','parseSubtitle','codec_name','decoderCommand','116268MgCdpM','ffmp','m3u8TmpPath','-start_number\x20','-g\x20','dirname','11oWZdBc','FFmpeg','better-sqlite3','audioCodec','2eONWzL','kill','[0:s:','prepare','log','Stop\x20transcode\x20','replace','R_OK','killed','dbOther','addInputOption','endsWith','pragma','5282127klNijO','hls','dvdsub','title','then','indexOf','-crf\x20','stat','output','constants','.m3u8','[ref][sub]overlay[vss]','getCoderConfig','-ac\x202','run','52YMgmRt','-preset\x20','watch','-copyts','close','getPixFmt','complexFilter','lastTsReqTime','*.m3u8','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','5132645AKKHXg','-c:v\x20','decoderSupportPixFormat','videoCodec','gen','path','[0:v:0]','addOption','98055eCqwDD','405179ksmDie','-map\x200:v:0?','-map\x20[vss]','-hls_time\x20','.tmp','stderr','inputOption','splice','join','seq','NasCabHlsWorker','hdmv_pgs_subtitle','subtitleIndex','chokidar','playId','videoBitrate','getScaleOption','decryptFileGetStream','parseVideoFullPath','size','platform','change','][vs]scale2ref[sub][ref]','audioIndex','error','medium','-ac\x20','qsv\x20cannot\x20deal,restart\x20ffmpeg','m3u8segmentDuration','dvb_subtitle','-hls_list_size\x200','message','-r\x20','send','burn','4664016DVxpkh','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','No\x20request\x20timeout\x20','dbFileIndex','journal_mode\x20=\x20WAL','stream.m3u8','aac','102Qdoboy','getTranscodeSpeed','6579530bsuCvw','8wUvfiS','encoderName','pgssub','basename','dealFFmpegPath','getReadRate','push','../express-server/utils/cryptoUtils','get','../myConfig/config','getTime'];_0x4c7b=function(){return _0x31f810;};return _0x4c7b();}dbOther[_0x1bffc1(0x125)]('journal_mode\x20=\x20WAL'),dbFileIndex['pragma'](_0x1bffc1(0xf7));const FFmpeg=require('../libs/nasTrans')[_0x1bffc1(0x116)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x1bffc1(0x104));const chokidar=require(_0x1bffc1(0x155)),platform=require('os')[_0x1bffc1(0x15c)];process[_0x1bffc1(0x129)]=_0x1bffc1(0x152);function setLastReqTime(_0x29d4dd){const _0x2b21e4=_0x1bffc1;for(let _0x17a91e in ffmpList){let _0x4bb4fd=ffmpList[_0x17a91e];if(_0x4bb4fd[_0x2b21e4(0x156)]==_0x29d4dd)return ffmpList[_0x17a91e][_0x2b21e4(0x13c)]=new Date()[_0x2b21e4(0x107)]();}}function addFfmpToList(_0x10c523,_0x5ad08c,_0x540408){const _0x23782f=_0x1bffc1;ffmpList[_0x23782f(0x103)]({'ffmp':_0x10c523,'playId':_0x5ad08c,'dirWatcher':_0x540408,'lastTsReqTime':new Date()[_0x23782f(0x107)]()});}function killFfmpByPlayId(_0x172524,_0x36b8f8=!![]){const _0x4350c1=_0x1bffc1;console[_0x4350c1(0x11d)](_0x4350c1(0x11e),_0x172524);for(let _0x434fc7 in startedPlayIdList){let _0x54bbf2=startedPlayIdList[_0x434fc7];if(_0x54bbf2==_0x172524){startedPlayIdList['splice'](_0x434fc7,0x1);break;}}for(let _0x290766 in ffmpList){let _0x120385=ffmpList[_0x290766];if(_0x120385[_0x4350c1(0x156)]==_0x172524){ffmpList[_0x4350c1(0x14f)](_0x290766,0x1);let _0x26f999=_0x120385[_0x4350c1(0x110)][_0x4350c1(0x11a)]();_0x36b8f8&&setTimeout(()=>{const _0x3631ae=_0x4350c1;_0x120385['dirWatcher'][_0x3631ae(0x139)]()[_0x3631ae(0x12a)](()=>{});},0x7d0);return;}}}function startPlay(_0x17c32c){const _0x30d361=_0x1bffc1;let {playId:_0x4d8444,args:_0x508cb5,action:_0x1ab52b}=_0x17c32c;if(!_0x4d8444)return;if(_0x1ab52b=='stop'){killFfmpByPlayId(_0x4d8444);return;}for(let _0x259bc4 in ffmpList){let _0xb9487=ffmpList[_0x259bc4];if(_0xb9487[_0x30d361(0x156)]==_0x4d8444){setLastReqTime(_0x4d8444);return;}}if(startedPlayIdList['includes'](_0x4d8444)){console[_0x30d361(0x11d)]('Play\x20ID\x20has\x20started');return;}startedPlayIdList[_0x30d361(0x103)](_0x4d8444);let _0x224080=dbOther[_0x30d361(0x11c)]('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')[_0x30d361(0x105)](_0x4d8444);if(!_0x224080)return;let _0x28148b=path['join'](config[_0x30d361(0x111)],_0x4d8444);function _0x38832f(){const _0x8551c8=_0x30d361;transCodeUtil[_0x8551c8(0x15a)](dbFileIndex,dbOther,_0x508cb5)['then'](_0x3447e7=>{const _0x44b597=_0x8551c8;let {fullpath:_0x50cd1a,streamList:_0x278ba8,needDecrypt:_0x1a5b6c,pwd:_0xe2351b,duration:_0x471787}=_0x3447e7;fs[_0x44b597(0x109)](_0x50cd1a,fs[_0x44b597(0x12f)][_0x44b597(0x120)],_0x3e260a=>{const _0x15a385=_0x44b597;if(_0x3e260a)return;let _0x4ac06c=chokidar[_0x15a385(0x137)](_0x28148b,{'ignored':_0x15a385(0x13d),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x4ac06c['on']('add',_0x2f7a5e=>{const _0x137a37=_0x15a385;if(_0x2f7a5e[_0x137a37(0x124)](_0x137a37(0x14c))||_0x2f7a5e['endsWith'](_0x137a37(0x130)))return;let _0x443375=path[_0x137a37(0x100)](_0x2f7a5e),_0x3463e7=dbOther[_0x137a37(0x11c)](_0x137a37(0x16c))['run'](_0x4d8444);if(!_0x3463e7)return killFfmpByPlayId(_0x4d8444);else dbOther[_0x137a37(0x11c)](_0x137a37(0x13e))[_0x137a37(0x134)](_0x4d8444,_0x443375,_0x137a37(0x143));}),_0x4ac06c['on'](_0x15a385(0x160),_0xd51a2=>{}),_0x4ac06c['on'](_0x15a385(0x15d),_0x47f783=>{const _0x3662aa=_0x15a385;if(_0x47f783[_0x3662aa(0x124)]('.tmp')||_0x47f783['endsWith'](_0x3662aa(0x130)))return;let _0x15bea7=path['basename'](_0x47f783);dbOther[_0x3662aa(0x11c)](_0x3662aa(0x13e))[_0x3662aa(0x134)](_0x4d8444,_0x15bea7,'gen');}),_0x4ac06c['on'](_0x15a385(0x10b),()=>{m3u8FfmpegTrans(_0x4ac06c,_0x4d8444,_0x508cb5,_0x50cd1a,_0x278ba8,_0x1a5b6c,_0xe2351b);});});})['catch'](_0x3e8837=>{});}fs[_0x30d361(0x12d)](_0x28148b,(_0x35bd56,_0x515cc4)=>{_0x35bd56?fs['mkdir'](_0x28148b,{'recursive':!![]},_0x36b845=>{!_0x36b845&&_0x38832f();}):_0x38832f();});}function m3u8FfmpegTrans(_0x29e40a,_0x297d93,_0x2d77a8,_0x5e1c1d,_0x3f0250,_0x1eee4d,_0xc35b3e,_0xc6ad6d=!![]){const _0x5a0723=_0x1bffc1;try{let _0x527c4d=_0x2d77a8[_0x5a0723(0x15b)]&&_0x2d77a8[_0x5a0723(0x15b)]>0xf0?_0x2d77a8[_0x5a0723(0x15b)]:0x2d0,{videoStream:_0x9115e0,videoWidth:_0x8bf44e,videoHeight:_0x2c2700}=transCodeUtil['parseStreamList'](_0x3f0250),_0x3b74a4=_0x1eee4d?cryptoUtils[_0x5a0723(0x159)](_0xc35b3e,_0x5e1c1d):_0x5e1c1d;_0x3b74a4=transCodeUtil[_0x5a0723(0x101)](_0x3b74a4);let _0x25040a=FFmpeg(_0x3b74a4),_0xf09200=transCodeUtil[_0x5a0723(0x132)](dbOther,_0x9115e0);_0xc6ad6d&&_0xf09200['hwaccel']&&_0x25040a[_0x5a0723(0x123)](_0xf09200['hwaccel']);if(_0xc6ad6d&&_0xf09200[_0x5a0723(0x10e)]){let _0x224c13=transCodeUtil[_0x5a0723(0x141)](_0x9115e0,_0xf09200['decoderCommand'][_0x5a0723(0x11f)](_0x5a0723(0x140),''));_0x224c13&&_0x25040a[_0x5a0723(0x123)](_0xf09200[_0x5a0723(0x10e)]);}_0x25040a[_0x5a0723(0x14e)]('-readrate\x20'+transCodeUtil[_0x5a0723(0x102)](dbOther));let _0x2a4a89=_0x2d77a8[_0x5a0723(0x151)]*config[_0x5a0723(0x164)];_0x2a4a89&&!_0x1eee4d&&_0x25040a['seekInput'](''+parseInt(_0x2a4a89));_0x25040a[_0x5a0723(0x118)](_0x5a0723(0xf9));_0xf09200['encoderName']&&_0x25040a[_0x5a0723(0x142)](_0xf09200['encoderName']);let _0x77e67b=transCodeUtil['getVideoBitrate'](_0x9115e0,_0x2d77a8['videobit']);_0x25040a[_0x5a0723(0x157)](''+_0x77e67b),_0x25040a[_0x5a0723(0x146)]('-bufsize\x20'+_0x77e67b/0x2+'k');let _0xb491c2=transCodeUtil[_0x5a0723(0x158)](_0x527c4d,_0x8bf44e,_0x2c2700),_0x227f67=null;_0x2d77a8[_0x5a0723(0x16a)]==0x1&&_0x2d77a8[_0x5a0723(0x154)]>-0x1&&(_0x227f67=transCodeUtil[_0x5a0723(0x10c)](_0x3f0250,_0x2d77a8[_0x5a0723(0x154)]));_0x227f67&&(_0x227f67[_0x5a0723(0x10d)]==_0x5a0723(0xff)||_0x227f67[_0x5a0723(0x10d)]==_0x5a0723(0x153)||_0x227f67[_0x5a0723(0x10d)]=='vobsub'||_0x227f67[_0x5a0723(0x10d)]==_0x5a0723(0x10a)||_0x227f67[_0x5a0723(0x10d)]==_0x5a0723(0x128)||_0x227f67['codec_name']==_0x5a0723(0x165))?(_0x25040a[_0x5a0723(0x13b)]([_0x5a0723(0x145)+_0xb491c2+'[vs]',_0x5a0723(0x11b)+_0x2d77a8[_0x5a0723(0x154)]+_0x5a0723(0x15e),_0x5a0723(0x131)]),_0x25040a['addOutputOption'](_0x5a0723(0x14a))):(_0xb491c2&&_0x25040a[_0x5a0723(0x146)]('-filter:v\x20'+_0xb491c2),_0x25040a['addOption'](_0x5a0723(0x149)));_0x25040a[_0x5a0723(0x146)]('-map\x200:a:'+(_0x2d77a8[_0x5a0723(0x15f)]?_0x2d77a8[_0x5a0723(0x15f)]:0x0)+'?');let _0x37f208=transCodeUtil['getFps'](_0x9115e0);_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x168)+_0x37f208),_0x25040a['addOption'](_0x5a0723(0x113)+_0x37f208);let _0x1ee867=transCodeUtil[_0x5a0723(0xfb)](dbOther,_0xf09200[_0x5a0723(0xfe)]);_0x1ee867!=_0x5a0723(0x161)&&_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x136)+_0x1ee867);let _0x475e24=transCodeUtil[_0x5a0723(0x13a)](_0x9115e0,_0xf09200[_0x5a0723(0xfe)]);_0x475e24&&_0x25040a[_0x5a0723(0x146)]('-pix_fmt\x20'+_0x475e24);_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x138));_0x2d77a8['ac']&&_0x2d77a8['ac']>0x0&&_0x2d77a8['ac']<=0x18?_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x162)+_0x2d77a8['ac']):_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x133));let _0x3c5414=transCodeUtil['getCrf'](dbOther);_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x12c)+_0x3c5414),_0x25040a['format'](_0x5a0723(0x127)),_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x14b)+config[_0x5a0723(0x164)]),_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x166));let _0x4a3632=_0x2d77a8[_0x5a0723(0x151)];_0x4a3632&&_0x2a4a89&&!_0x1eee4d&&_0x25040a[_0x5a0723(0x146)](_0x5a0723(0x112)+_0x4a3632);let _0xccab2b=path[_0x5a0723(0x150)](config[_0x5a0723(0x111)],_0x297d93,_0x5a0723(0xf8));_0xccab2b=transCodeUtil['dealFFmpegPath'](_0xccab2b),_0x25040a[_0x5a0723(0x12e)](''+_0xccab2b);let _0x14766b=path[_0x5a0723(0x114)](_0xccab2b);fs[_0x5a0723(0x12d)](_0x14766b,(_0x26f741,_0x30ca15)=>{if(_0x26f741){fs['mkdir'](_0x14766b,{'recursive':!![]},_0x55b88f=>{if(_0x55b88f)return;_0x2cf334(_0x25040a);});return;}_0x2cf334(_0x25040a);});function _0x495473(){_0xc6ad6d&&(console['log']('!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!'),killFfmpByPlayId(_0x297d93,![]),m3u8FfmpegTrans(_0x29e40a,_0x297d93,_0x2d77a8,_0x5e1c1d,_0x3f0250,_0x1eee4d,_0xc35b3e,![]));}function _0x2cf334(){const _0xe75640=_0x5a0723;_0x25040a[_0xe75640(0x134)](),addFfmpToList(_0x25040a,_0x297d93,_0x29e40a),_0x25040a['on']('start',function(_0x35cf18){const _0x118110=_0xe75640;console[_0x118110(0x11d)](_0x35cf18);})['on'](_0xe75640(0x14d),function(_0x3a63ac){const _0x20cdab=_0xe75640;_0xc6ad6d&&_0xf09200&&_0x3a63ac&&_0x3a63ac[_0x20cdab(0x12b)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console[_0x20cdab(0x11d)](_0x20cdab(0x163)),_0x495473());})['on'](_0xe75640(0x160),function(_0x34b4bf){const _0x1da1a3=_0xe75640;_0x34b4bf[_0x1da1a3(0x167)]&&_0x34b4bf[_0x1da1a3(0x167)][_0x1da1a3(0x12b)](_0x1da1a3(0x121))==-0x1&&(console['log'](_0x34b4bf),_0x495473());})['on']('end',function(_0xffa407){const _0x258d3c=_0xe75640;console[_0x258d3c(0x11d)](_0xffa407);});}}catch(_0x2b52e5){console[_0x5a0723(0x11d)](_0x2b52e5),_0x29e40a[_0x5a0723(0x139)]();}}setInterval(()=>{const _0x450c49=_0x1bffc1;let _0xc68e8f=new Date()[_0x450c49(0x107)](),_0x58566f=0xea60;for(let _0x335115 in ffmpList){let _0x48b356=ffmpList[_0x335115],_0x4512f8=_0xc68e8f-_0x48b356[_0x450c49(0x13c)];_0x48b356['lastTsReqTime']&&_0x4512f8>_0x58566f&&(console[_0x450c49(0x11d)](_0x450c49(0xf5)),killFfmpByPlayId(_0x48b356[_0x450c49(0x156)]));}},0x2710),process['on'](_0x1bffc1(0x167),_0x9c2d94=>{startPlay(_0x9c2d94);}),process['on']('exit',(_0x243729,_0x425a50)=>{const _0x45eebd=_0x1bffc1;process[_0x45eebd(0x169)]({'type':_0x45eebd(0x139)});});