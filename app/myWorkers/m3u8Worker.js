const _0x5d7035=_0x44b9;(function(_0x289d18,_0x1b630b){const _0x4f9328=_0x44b9,_0x5f5b1f=_0x289d18();while(!![]){try{const _0x5821cb=parseInt(_0x4f9328(0xe2))/0x1+parseInt(_0x4f9328(0xd8))/0x2*(-parseInt(_0x4f9328(0xee))/0x3)+-parseInt(_0x4f9328(0xea))/0x4*(-parseInt(_0x4f9328(0xb6))/0x5)+parseInt(_0x4f9328(0xeb))/0x6*(parseInt(_0x4f9328(0xc9))/0x7)+-parseInt(_0x4f9328(0xc6))/0x8+-parseInt(_0x4f9328(0xef))/0x9*(-parseInt(_0x4f9328(0x8c))/0xa)+parseInt(_0x4f9328(0xb9))/0xb;if(_0x5821cb===_0x1b630b)break;else _0x5f5b1f['push'](_0x5f5b1f['shift']());}catch(_0x40480b){_0x5f5b1f['push'](_0x5f5b1f['shift']());}}}(_0x18ed,0x4e1b3));const path=require(_0x5d7035(0xa6)),fs=require('fs'),config=require(_0x5d7035(0xfa)),transCodeUtil=require(_0x5d7035(0x8d)),Database=require(_0x5d7035(0xa0)),dbOther=new Database(config['dbOther'],{}),dbFileIndex=new Database(config[_0x5d7035(0xe9)],{'timeout':0xea60});function _0x44b9(_0x111495,_0x2e71ec){const _0x18ed7e=_0x18ed();return _0x44b9=function(_0x44b983,_0x425dd4){_0x44b983=_0x44b983-0x7c;let _0x574501=_0x18ed7e[_0x44b983];return _0x574501;},_0x44b9(_0x111495,_0x2e71ec);}dbOther[_0x5d7035(0xa1)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x5d7035(0xa1)]('journal_mode\x20=\x20WAL');const FFmpeg=require(_0x5d7035(0xdc))[_0x5d7035(0xad)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x5d7035(0x90));const chokidar=require(_0x5d7035(0xe7)),platform=require('os')[_0x5d7035(0x9e)];process[_0x5d7035(0xbe)]=_0x5d7035(0xac);function setLastReqTime(_0x2aa76b){const _0x6c68c4=_0x5d7035;for(let _0x5e4d60 in ffmpList){let _0x416301=ffmpList[_0x5e4d60];if(_0x416301[_0x6c68c4(0x85)]==_0x2aa76b)return ffmpList[_0x5e4d60]['lastTsReqTime']=new Date()[_0x6c68c4(0x82)]();}}function addFfmpToList(_0x5a70f8,_0x4dffc8,_0x2c18a3){const _0x1d8199=_0x5d7035;ffmpList[_0x1d8199(0x8b)]({'ffmp':_0x5a70f8,'playId':_0x4dffc8,'dirWatcher':_0x2c18a3,'lastTsReqTime':new Date()[_0x1d8199(0x82)]()});}function killFfmpByPlayId(_0x3c6c2d,_0x2dcefe=!![]){const _0x460d9d=_0x5d7035;console[_0x460d9d(0xb0)](_0x460d9d(0xd6),_0x3c6c2d);for(let _0x54b980 in startedPlayIdList){let _0x222163=startedPlayIdList[_0x54b980];if(_0x222163==_0x3c6c2d){startedPlayIdList[_0x460d9d(0xf4)](_0x54b980,0x1);break;}}for(let _0x4e2e3e in ffmpList){let _0x2b19a1=ffmpList[_0x4e2e3e];if(_0x2b19a1[_0x460d9d(0x85)]==_0x3c6c2d){ffmpList[_0x460d9d(0xf4)](_0x4e2e3e,0x1);let _0x55d501=_0x2b19a1['ffmp']['kill']();_0x2dcefe&&setTimeout(()=>{const _0x37dee8=_0x460d9d;_0x2b19a1[_0x37dee8(0xb4)]['close']()[_0x37dee8(0xec)](()=>{});},0x7d0);return;}}}function _0x18ed(){const _0x4b146e=['decoderSupportPixFormat','parseVideoFullPath','join','parseSubtitle','getVideoBitrate','stop','-filter:v\x20','4621080Eopgvb','videoBitrate','killed','7kJnovJ','message','complexFilter','-g\x20','add','gen','replace','-ac\x202','endsWith','dirname','-bufsize\x20','.tmp','exit','Stop\x20transcode\x20','stream.m3u8','6eZBdDj','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','-hls_list_size\x200','includes','../libs/nasTrans','-c:v\x20','pgssub','videobit','addInputOption','stat','446104rLpepJ','videoCodec','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','-hls_time\x20','addOutputOption','chokidar','-pix_fmt\x20','dbFileIndex','698824NRcSwM','217146BIWenz','then','hls','555981PWIhCV','771633oUzRtj','lastTsReqTime','seekInput','getPixFmt','parseStreamList','splice','encoderName','-preset\x20','getCoderConfig','indexOf','audioIndex','../myConfig/config','R_OK','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','basename','dealFFmpegPath','catch','constants','addOption','hdmv_pgs_subtitle','getTime','getFps','burn','playId','close','change','medium','getScaleOption','-map\x200:a:','push','60BNEBkB','../utils/transCodeUtil','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','size','../express-server/utils/cryptoUtils','.m3u8','decoderCommand','getReadRate','audioCodec','-r\x20','*.m3u8','Play\x20ID\x20has\x20started','-crf\x20','m3u8TmpPath','][vs]scale2ref[sub][ref]','-map\x200:v:0?','[ref][sub]overlay[vss]','run','platform','hwaccel','better-sqlite3','pragma','getTranscodeSpeed','prepare','error','-map\x20[vss]','path','subtitleIndex','codec_name','More\x20data\x20is\x20required\x20to\x20decode\x20header','vobsub','[0:v:0]','NasCabHlsWorker','FFmpeg','seq','get','log','stderr','access','getCrf','dirWatcher','[vs]','5ciMKxm','[0:s:','start','3103276kVFoDD','send','inputOption','-ac\x20','-readrate\x20','title'];_0x18ed=function(){return _0x4b146e;};return _0x18ed();}function startPlay(_0xc44b55){const _0x10f15c=_0x5d7035;let {playId:_0x1a424d,args:_0x3b5585,action:_0x195ae6}=_0xc44b55;if(!_0x1a424d)return;if(_0x195ae6==_0x10f15c(0xc4)){killFfmpByPlayId(_0x1a424d);return;}for(let _0x1f0cd4 in ffmpList){let _0x1d6de8=ffmpList[_0x1f0cd4];if(_0x1d6de8[_0x10f15c(0x85)]==_0x1a424d){setLastReqTime(_0x1a424d);return;}}if(startedPlayIdList[_0x10f15c(0xdb)](_0x1a424d)){console[_0x10f15c(0xb0)](_0x10f15c(0x97));return;}startedPlayIdList['push'](_0x1a424d);let _0x2dbd54=dbOther[_0x10f15c(0xa3)](_0x10f15c(0xfc))[_0x10f15c(0xaf)](_0x1a424d);if(!_0x2dbd54)return;let _0x4d0167=path[_0x10f15c(0xc1)](config[_0x10f15c(0x99)],_0x1a424d);function _0x5919ee(){const _0x5db532=_0x10f15c;transCodeUtil[_0x5db532(0xc0)](dbFileIndex,dbOther,_0x3b5585)[_0x5db532(0xec)](_0x5cc9eb=>{const _0x326053=_0x5db532;let {fullpath:_0xa1cfe,streamList:_0x44d9d6,needDecrypt:_0xfdccc3,pwd:_0x1a8a23,duration:_0x47f73e}=_0x5cc9eb;fs[_0x326053(0xb2)](_0xa1cfe,fs[_0x326053(0x7f)][_0x326053(0xfb)],_0x336b86=>{const _0xcb85c=_0x326053;if(_0x336b86)return;let _0x53a0ed=chokidar['watch'](_0x4d0167,{'ignored':_0xcb85c(0x96),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x53a0ed['on'](_0xcb85c(0xcd),_0x101411=>{const _0x2163cb=_0xcb85c;if(_0x101411[_0x2163cb(0xd1)](_0x2163cb(0xd4))||_0x101411[_0x2163cb(0xd1)]('.m3u8'))return;let _0x573830=path[_0x2163cb(0x7c)](_0x101411),_0x2e2733=dbOther['prepare'](_0x2163cb(0x8e))[_0x2163cb(0x9d)](_0x1a424d);if(!_0x2e2733)return killFfmpByPlayId(_0x1a424d);else dbOther[_0x2163cb(0xa3)](_0x2163cb(0xe4))[_0x2163cb(0x9d)](_0x1a424d,_0x573830,_0x2163cb(0xce));}),_0x53a0ed['on'](_0xcb85c(0xa4),_0x455c8a=>{}),_0x53a0ed['on'](_0xcb85c(0x87),_0x468613=>{const _0x4d2fbf=_0xcb85c;if(_0x468613['endsWith'](_0x4d2fbf(0xd4))||_0x468613[_0x4d2fbf(0xd1)](_0x4d2fbf(0x91)))return;let _0x5412bc=path[_0x4d2fbf(0x7c)](_0x468613);dbOther['prepare']('REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)')[_0x4d2fbf(0x9d)](_0x1a424d,_0x5412bc,_0x4d2fbf(0xce));}),_0x53a0ed['on']('ready',()=>{m3u8FfmpegTrans(_0x53a0ed,_0x1a424d,_0x3b5585,_0xa1cfe,_0x44d9d6,_0xfdccc3,_0x1a8a23);});});})[_0x5db532(0x7e)](_0x563c5c=>{});}fs[_0x10f15c(0xe1)](_0x4d0167,(_0x8e91e0,_0xb112a5)=>{_0x8e91e0?fs['mkdir'](_0x4d0167,{'recursive':!![]},_0x101b19=>{!_0x101b19&&_0x5919ee();}):_0x5919ee();});}function m3u8FfmpegTrans(_0x2a0d17,_0x46fc64,_0x249f84,_0x3a250e,_0x380fc7,_0x5d8369,_0x41ba88,_0x28a7d7=!![]){const _0x3acf3c=_0x5d7035;try{let _0x3f2ea0=_0x249f84['size']&&_0x249f84[_0x3acf3c(0x8f)]>0xf0?_0x249f84['size']:0x2d0,{videoStream:_0x555dc9,videoWidth:_0x314021,videoHeight:_0x7a7749}=transCodeUtil[_0x3acf3c(0xf3)](_0x380fc7),_0x1dc469=_0x5d8369?cryptoUtils['decryptFileGetStream'](_0x41ba88,_0x3a250e):_0x3a250e;_0x1dc469=transCodeUtil[_0x3acf3c(0x7d)](_0x1dc469);let _0x4750a2=FFmpeg(_0x1dc469),_0x44b274=transCodeUtil[_0x3acf3c(0xf7)](dbOther,_0x555dc9);_0x28a7d7&&_0x44b274[_0x3acf3c(0x9f)]&&_0x4750a2[_0x3acf3c(0xe0)](_0x44b274['hwaccel']);if(_0x28a7d7&&_0x44b274[_0x3acf3c(0x92)]){let _0x18710e=transCodeUtil[_0x3acf3c(0xbf)](_0x555dc9,_0x44b274[_0x3acf3c(0x92)][_0x3acf3c(0xcf)](_0x3acf3c(0xdd),''));_0x18710e&&_0x4750a2['addInputOption'](_0x44b274['decoderCommand']);}_0x4750a2[_0x3acf3c(0xbb)](_0x3acf3c(0xbd)+transCodeUtil[_0x3acf3c(0x93)](dbOther));let _0x108235=_0x249f84[_0x3acf3c(0xae)]*config['m3u8segmentDuration'];_0x108235&&!_0x5d8369&&_0x4750a2[_0x3acf3c(0xf1)](''+parseInt(_0x108235));_0x4750a2[_0x3acf3c(0x94)]('aac');_0x44b274[_0x3acf3c(0xf5)]&&_0x4750a2[_0x3acf3c(0xe3)](_0x44b274[_0x3acf3c(0xf5)]);let _0x33b0d5=transCodeUtil[_0x3acf3c(0xc3)](_0x555dc9,_0x249f84[_0x3acf3c(0xdf)]);_0x4750a2[_0x3acf3c(0xc7)](''+_0x33b0d5),_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0xd3)+_0x33b0d5/0x2+'k');let _0x528bbe=transCodeUtil[_0x3acf3c(0x89)](_0x3f2ea0,_0x314021,_0x7a7749),_0x2d1df8=null;_0x249f84[_0x3acf3c(0x84)]==0x1&&_0x249f84['subtitleIndex']>-0x1&&(_0x2d1df8=transCodeUtil[_0x3acf3c(0xc2)](_0x380fc7,_0x249f84[_0x3acf3c(0xa7)]));_0x2d1df8&&(_0x2d1df8['codec_name']==_0x3acf3c(0xde)||_0x2d1df8[_0x3acf3c(0xa8)]==_0x3acf3c(0x81)||_0x2d1df8[_0x3acf3c(0xa8)]==_0x3acf3c(0xaa)||_0x2d1df8['codec_name']=='dvd_subtitle'||_0x2d1df8['codec_name']=='dvdsub'||_0x2d1df8[_0x3acf3c(0xa8)]=='dvb_subtitle')?(_0x4750a2[_0x3acf3c(0xcb)]([_0x3acf3c(0xab)+_0x528bbe+_0x3acf3c(0xb5),_0x3acf3c(0xb7)+_0x249f84[_0x3acf3c(0xa7)]+_0x3acf3c(0x9a),_0x3acf3c(0x9c)]),_0x4750a2[_0x3acf3c(0xe6)](_0x3acf3c(0xa5))):(_0x528bbe&&_0x4750a2['addOption'](_0x3acf3c(0xc5)+_0x528bbe),_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0x9b)));_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0x8a)+(_0x249f84[_0x3acf3c(0xf9)]?_0x249f84[_0x3acf3c(0xf9)]:0x0)+'?');let _0x580c85=transCodeUtil[_0x3acf3c(0x83)](_0x555dc9);_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0x95)+_0x580c85),_0x4750a2['addOption'](_0x3acf3c(0xcc)+_0x580c85);let _0x5cb04e=transCodeUtil[_0x3acf3c(0xa2)](dbOther,_0x44b274[_0x3acf3c(0xf5)]);_0x5cb04e!=_0x3acf3c(0x88)&&_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0xf6)+_0x5cb04e);let _0x4337ab=transCodeUtil[_0x3acf3c(0xf2)](_0x555dc9,_0x44b274[_0x3acf3c(0xf5)]);_0x4337ab&&_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0xe8)+_0x4337ab);_0x4750a2[_0x3acf3c(0x80)]('-copyts');_0x249f84['ac']&&_0x249f84['ac']>0x0&&_0x249f84['ac']<=0x18?_0x4750a2['addOption'](_0x3acf3c(0xbc)+_0x249f84['ac']):_0x4750a2['addOption'](_0x3acf3c(0xd0));let _0x5aad82=transCodeUtil[_0x3acf3c(0xb3)](dbOther);_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0x98)+_0x5aad82),_0x4750a2['format'](_0x3acf3c(0xed)),_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0xe5)+config['m3u8segmentDuration']),_0x4750a2[_0x3acf3c(0x80)](_0x3acf3c(0xda));let _0xeac31c=_0x249f84[_0x3acf3c(0xae)];_0xeac31c&&_0x108235&&!_0x5d8369&&_0x4750a2[_0x3acf3c(0x80)]('-start_number\x20'+_0xeac31c);let _0x14a27f=path[_0x3acf3c(0xc1)](config['m3u8TmpPath'],_0x46fc64,_0x3acf3c(0xd7));_0x14a27f=transCodeUtil[_0x3acf3c(0x7d)](_0x14a27f),_0x4750a2['output'](''+_0x14a27f);let _0x27b663=path[_0x3acf3c(0xd2)](_0x14a27f);fs[_0x3acf3c(0xe1)](_0x27b663,(_0x11afc8,_0x46cb8e)=>{if(_0x11afc8){fs['mkdir'](_0x27b663,{'recursive':!![]},_0x24419e=>{if(_0x24419e)return;_0x407c68(_0x4750a2);});return;}_0x407c68(_0x4750a2);});function _0x1ae380(){const _0x2dfbbe=_0x3acf3c;_0x28a7d7&&(console['log'](_0x2dfbbe(0xd9)),killFfmpByPlayId(_0x46fc64,![]),m3u8FfmpegTrans(_0x2a0d17,_0x46fc64,_0x249f84,_0x3a250e,_0x380fc7,_0x5d8369,_0x41ba88,![]));}function _0x407c68(){const _0x2ed17a=_0x3acf3c;_0x4750a2[_0x2ed17a(0x9d)](),addFfmpToList(_0x4750a2,_0x46fc64,_0x2a0d17),_0x4750a2['on'](_0x2ed17a(0xb8),function(_0x1d9b6e){const _0x44e6f6=_0x2ed17a;console[_0x44e6f6(0xb0)](_0x1d9b6e);})['on'](_0x2ed17a(0xb1),function(_0x33fe5d){const _0x246907=_0x2ed17a;_0x28a7d7&&_0x44b274&&_0x33fe5d&&_0x33fe5d[_0x246907(0xf8)](_0x246907(0xa9))!=-0x1&&(console[_0x246907(0xb0)]('qsv\x20cannot\x20deal,restart\x20ffmpeg'),_0x1ae380());})['on']('error',function(_0x3ee9ac){const _0x4f5167=_0x2ed17a;_0x3ee9ac[_0x4f5167(0xca)]&&_0x3ee9ac[_0x4f5167(0xca)][_0x4f5167(0xf8)](_0x4f5167(0xc8))==-0x1&&(console['log'](_0x3ee9ac),_0x1ae380());})['on']('end',function(_0x124a07){const _0x452a04=_0x2ed17a;console[_0x452a04(0xb0)](_0x124a07);});}}catch(_0x5d19d5){console[_0x3acf3c(0xb0)](_0x5d19d5),_0x2a0d17['close']();}}setInterval(()=>{const _0x26aa1c=_0x5d7035;let _0x202a8e=new Date()[_0x26aa1c(0x82)](),_0x24ec83=0xea60;for(let _0x5e9b86 in ffmpList){let _0x360387=ffmpList[_0x5e9b86],_0x5ae0d8=_0x202a8e-_0x360387[_0x26aa1c(0xf0)];_0x360387['lastTsReqTime']&&_0x5ae0d8>_0x24ec83&&(console[_0x26aa1c(0xb0)]('No\x20request\x20timeout\x20'),killFfmpByPlayId(_0x360387[_0x26aa1c(0x85)]));}},0x2710),process['on'](_0x5d7035(0xca),_0x32f9cb=>{startPlay(_0x32f9cb);}),process['on'](_0x5d7035(0xd5),(_0x32c837,_0x4749df)=>{const _0x28630b=_0x5d7035;process[_0x28630b(0xba)]({'type':_0x28630b(0x86)});});