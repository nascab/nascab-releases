const _0x4a892b=_0x4b47;(function(_0x8d46d8,_0x984a59){const _0x3c089c=_0x4b47,_0x68b1df=_0x8d46d8();while(!![]){try{const _0x5e4ddc=parseInt(_0x3c089c(0x14e))/0x1+parseInt(_0x3c089c(0x13c))/0x2+-parseInt(_0x3c089c(0x12e))/0x3*(parseInt(_0x3c089c(0x121))/0x4)+parseInt(_0x3c089c(0x119))/0x5+parseInt(_0x3c089c(0x143))/0x6*(-parseInt(_0x3c089c(0x114))/0x7)+parseInt(_0x3c089c(0x111))/0x8*(-parseInt(_0x3c089c(0x16e))/0x9)+parseInt(_0x3c089c(0x101))/0xa;if(_0x5e4ddc===_0x984a59)break;else _0x68b1df['push'](_0x68b1df['shift']());}catch(_0x44da99){_0x68b1df['push'](_0x68b1df['shift']());}}}(_0x4409,0x2aef7));const path=require(_0x4a892b(0x110)),fs=require('fs'),config=require(_0x4a892b(0x148)),transCodeUtil=require(_0x4a892b(0x14f)),Database=require(_0x4a892b(0x134)),dbOther=new Database(config[_0x4a892b(0x108)],{}),dbFileIndex=new Database(config[_0x4a892b(0x10b)],{'timeout':0xea60});dbOther[_0x4a892b(0x153)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x4a892b(0x153)](_0x4a892b(0x15c));const FFmpeg=require('../libs/nasTrans')[_0x4a892b(0xfa)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require('../express-server/utils/cryptoUtils');const chokidar=require('chokidar'),platform=require('os')[_0x4a892b(0x13f)];process[_0x4a892b(0x107)]='NasCabHlsWorker';function setLastReqTime(_0x3606ac){const _0xde9f8f=_0x4a892b;for(let _0x1791d6 in ffmpList){let _0xee5d11=ffmpList[_0x1791d6];if(_0xee5d11[_0xde9f8f(0x132)]==_0x3606ac)return ffmpList[_0x1791d6][_0xde9f8f(0x151)]=new Date()[_0xde9f8f(0x16d)]();}}function addFfmpToList(_0x32d590,_0x416ea4,_0x253bf2){const _0x52fb21=_0x4a892b;ffmpList[_0x52fb21(0xf8)]({'ffmp':_0x32d590,'playId':_0x416ea4,'dirWatcher':_0x253bf2,'lastTsReqTime':new Date()['getTime']()});}function killFfmpByPlayId(_0x4294c9,_0x4f9368=!![]){const _0xb872a8=_0x4a892b;console[_0xb872a8(0xfe)](_0xb872a8(0x137),_0x4294c9);for(let _0x490435 in startedPlayIdList){let _0x5f33e4=startedPlayIdList[_0x490435];if(_0x5f33e4==_0x4294c9){startedPlayIdList[_0xb872a8(0x10a)](_0x490435,0x1);break;}}for(let _0x2aa34c in ffmpList){let _0x482b37=ffmpList[_0x2aa34c];if(_0x482b37[_0xb872a8(0x132)]==_0x4294c9){ffmpList[_0xb872a8(0x10a)](_0x2aa34c,0x1);let _0xbca2e9=_0x482b37['ffmp'][_0xb872a8(0x158)]();_0x4f9368&&setTimeout(()=>{const _0x622676=_0xb872a8;_0x482b37[_0x622676(0x100)][_0x622676(0x16f)]()[_0x622676(0x145)](()=>{});},0x7d0);return;}}}function startPlay(_0x2e2c40){const _0x22d08b=_0x4a892b;let {playId:_0x2c5fc4,args:_0x16acc3,action:_0x25b1ae}=_0x2e2c40;if(!_0x2c5fc4)return;if(_0x25b1ae=='stop'){killFfmpByPlayId(_0x2c5fc4);return;}for(let _0x4ea22c in ffmpList){let _0x1b62c5=ffmpList[_0x4ea22c];if(_0x1b62c5[_0x22d08b(0x132)]==_0x2c5fc4){setLastReqTime(_0x2c5fc4);return;}}if(startedPlayIdList[_0x22d08b(0x11f)](_0x2c5fc4)){console['log'](_0x22d08b(0xf9));return;}startedPlayIdList[_0x22d08b(0xf8)](_0x2c5fc4);let _0x44a06f=dbOther[_0x22d08b(0x124)](_0x22d08b(0x14c))[_0x22d08b(0x122)](_0x2c5fc4);if(!_0x44a06f)return;let _0x19ec2e=path[_0x22d08b(0x129)](config['m3u8TmpPath'],_0x2c5fc4);function _0x54a0f9(){const _0xc06426=_0x22d08b;transCodeUtil[_0xc06426(0x120)](dbFileIndex,dbOther,_0x16acc3)[_0xc06426(0x145)](_0x4dc11f=>{const _0x65f4b5=_0xc06426;let {fullpath:_0x565f15,streamList:_0x25f813,needDecrypt:_0xb74c84,pwd:_0x36f6e4,duration:_0x23b8b9}=_0x4dc11f;fs[_0x65f4b5(0x135)](_0x565f15,fs['constants'][_0x65f4b5(0x103)],_0xbd8c0c=>{const _0x299720=_0x65f4b5;if(_0xbd8c0c)return;let _0x166114=chokidar[_0x299720(0x102)](_0x19ec2e,{'ignored':_0x299720(0x168),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x166114['on'](_0x299720(0x167),_0xf38aa1=>{const _0x4009ce=_0x299720;if(_0xf38aa1[_0x4009ce(0x139)](_0x4009ce(0x14b))||_0xf38aa1['endsWith'](_0x4009ce(0x12d)))return;let _0x4509c1=path[_0x4009ce(0x12b)](_0xf38aa1),_0x252452=dbOther[_0x4009ce(0x124)](_0x4009ce(0x166))[_0x4009ce(0x126)](_0x2c5fc4);if(!_0x252452)return killFfmpByPlayId(_0x2c5fc4);else dbOther[_0x4009ce(0x124)](_0x4009ce(0x138))[_0x4009ce(0x126)](_0x2c5fc4,_0x4509c1,_0x4009ce(0x152));}),_0x166114['on'](_0x299720(0x157),_0x3cbd42=>{}),_0x166114['on'](_0x299720(0x116),_0xae19cf=>{const _0x3568bd=_0x299720;if(_0xae19cf['endsWith'](_0x3568bd(0x14b))||_0xae19cf[_0x3568bd(0x139)](_0x3568bd(0x12d)))return;let _0x723fb9=path[_0x3568bd(0x12b)](_0xae19cf);dbOther[_0x3568bd(0x124)](_0x3568bd(0x138))[_0x3568bd(0x126)](_0x2c5fc4,_0x723fb9,_0x3568bd(0x152));}),_0x166114['on'](_0x299720(0x11c),()=>{m3u8FfmpegTrans(_0x166114,_0x2c5fc4,_0x16acc3,_0x565f15,_0x25f813,_0xb74c84,_0x36f6e4);});});})['catch'](_0x1d1afc=>{});}fs[_0x22d08b(0x14a)](_0x19ec2e,(_0x559afa,_0x4ee02c)=>{const _0x53e9e7=_0x22d08b;_0x559afa?fs[_0x53e9e7(0xfc)](_0x19ec2e,{'recursive':!![]},_0x4999e5=>{!_0x4999e5&&_0x54a0f9();}):_0x54a0f9();});}function _0x4b47(_0x18e37e,_0xebc58d){const _0x440984=_0x4409();return _0x4b47=function(_0x4b4793,_0x2adac6){_0x4b4793=_0x4b4793-0xf7;let _0x23ead5=_0x440984[_0x4b4793];return _0x23ead5;},_0x4b47(_0x18e37e,_0xebc58d);}function m3u8FfmpegTrans(_0x44fb92,_0x5e2242,_0x227bc7,_0x286d61,_0x14cd94,_0x53b835,_0x1e0a5e,_0x54b069=!![]){const _0xc31019=_0x4a892b;try{let _0x1839c8=_0x227bc7['size']&&_0x227bc7[_0xc31019(0x13a)]>0xf0?_0x227bc7[_0xc31019(0x13a)]:0x2d0,{videoStream:_0x1b9cc3,videoWidth:_0x2fd37b,videoHeight:_0x4fce8f}=transCodeUtil[_0xc31019(0x141)](_0x14cd94),_0x3775b5=_0x53b835?cryptoUtils['decryptFileGetStream'](_0x1e0a5e,_0x286d61):_0x286d61;_0x3775b5=transCodeUtil[_0xc31019(0x14d)](_0x3775b5);let _0x384b44=FFmpeg(_0x3775b5),_0x92b86c=transCodeUtil[_0xc31019(0x136)](dbOther,_0x1b9cc3);_0x54b069&&_0x92b86c['hwaccel']&&_0x384b44[_0xc31019(0x10d)](_0x92b86c[_0xc31019(0x117)]);if(_0x54b069&&_0x92b86c[_0xc31019(0x162)]){let _0x5d8c7d=transCodeUtil['decoderSupportPixFormat'](_0x1b9cc3,_0x92b86c[_0xc31019(0x162)]['replace']('-c:v\x20',''));_0x5d8c7d&&_0x384b44[_0xc31019(0x10d)](_0x92b86c[_0xc31019(0x162)]);}_0x384b44[_0xc31019(0x10f)](_0xc31019(0x15b)+transCodeUtil[_0xc31019(0x11d)](dbOther));let _0x34befe=_0x227bc7[_0xc31019(0x10e)]*config[_0xc31019(0x164)];_0x34befe&&!_0x53b835&&_0x384b44[_0xc31019(0x105)](''+parseInt(_0x34befe));_0x384b44['audioCodec'](_0xc31019(0x113));_0x92b86c[_0xc31019(0x106)]&&_0x384b44['videoCodec'](_0x92b86c[_0xc31019(0x106)]);let _0x15e705=transCodeUtil['getVideoBitrate'](_0x1b9cc3,_0x227bc7[_0xc31019(0x140)]);_0x384b44[_0xc31019(0x118)](''+_0x15e705),_0x384b44[_0xc31019(0x142)](_0xc31019(0x155)+_0x15e705/0x2+'k');let _0x57a8fd=transCodeUtil[_0xc31019(0x144)](_0x1839c8,_0x2fd37b,_0x4fce8f),_0x48772d=null;_0x227bc7[_0xc31019(0x12a)]==0x1&&_0x227bc7[_0xc31019(0x16a)]>-0x1&&(_0x48772d=transCodeUtil[_0xc31019(0x147)](_0x14cd94,_0x227bc7[_0xc31019(0x16a)]));_0x48772d&&(_0x48772d[_0xc31019(0x13e)]==_0xc31019(0x13b)||_0x48772d[_0xc31019(0x13e)]=='hdmv_pgs_subtitle'||_0x48772d[_0xc31019(0x13e)]=='vobsub'||_0x48772d['codec_name']==_0xc31019(0x156)||_0x48772d[_0xc31019(0x13e)]==_0xc31019(0x15f)||_0x48772d[_0xc31019(0x13e)]=='dvb_subtitle')?(_0x384b44[_0xc31019(0xfb)]([_0xc31019(0x10c)+_0x57a8fd+_0xc31019(0x15a),_0xc31019(0xf7)+_0x227bc7[_0xc31019(0x16a)]+'][vs]scale2ref[sub][ref]',_0xc31019(0x109)]),_0x384b44[_0xc31019(0x149)](_0xc31019(0x159))):(_0x57a8fd&&_0x384b44[_0xc31019(0x142)](_0xc31019(0x125)+_0x57a8fd),_0x384b44[_0xc31019(0x142)](_0xc31019(0x154)));_0x384b44[_0xc31019(0x142)](_0xc31019(0x130)+(_0x227bc7[_0xc31019(0x170)]?_0x227bc7[_0xc31019(0x170)]:0x0)+'?');let _0x4d12f7=transCodeUtil[_0xc31019(0xff)](_0x1b9cc3);_0x384b44[_0xc31019(0x142)]('-r\x20'+_0x4d12f7),_0x384b44[_0xc31019(0x142)](_0xc31019(0x128)+_0x4d12f7);let _0x4ba39b=transCodeUtil[_0xc31019(0x127)](dbOther,_0x92b86c[_0xc31019(0x106)]);_0x4ba39b!=_0xc31019(0x15e)&&_0x384b44[_0xc31019(0x142)](_0xc31019(0x11a)+_0x4ba39b);let _0x259427=transCodeUtil[_0xc31019(0x12f)](_0x1b9cc3,_0x92b86c[_0xc31019(0x106)]);_0x259427&&_0x384b44[_0xc31019(0x142)](_0xc31019(0x133)+_0x259427);_0x384b44[_0xc31019(0x142)](_0xc31019(0x11b));_0x227bc7['ac']&&_0x227bc7['ac']>0x0&&_0x227bc7['ac']<=0x18?_0x384b44[_0xc31019(0x142)]('-ac\x20'+_0x227bc7['ac']):_0x384b44[_0xc31019(0x142)](_0xc31019(0x115));let _0x1e3797=transCodeUtil[_0xc31019(0xfd)](dbOther);_0x384b44['addOption'](_0xc31019(0x104)+_0x1e3797),_0x384b44[_0xc31019(0x131)](_0xc31019(0x163)),_0x384b44[_0xc31019(0x142)](_0xc31019(0x165)+config[_0xc31019(0x164)]),_0x384b44['addOption'](_0xc31019(0x160));let _0x37b0d8=_0x227bc7[_0xc31019(0x10e)];_0x37b0d8&&_0x34befe&&!_0x53b835&&_0x384b44[_0xc31019(0x142)](_0xc31019(0x15d)+_0x37b0d8);let _0x110d8b=path[_0xc31019(0x129)](config['m3u8TmpPath'],_0x5e2242,_0xc31019(0x169));_0x110d8b=transCodeUtil[_0xc31019(0x14d)](_0x110d8b),_0x384b44[_0xc31019(0x13d)](''+_0x110d8b);let _0x59f3a3=path['dirname'](_0x110d8b);fs[_0xc31019(0x14a)](_0x59f3a3,(_0x599446,_0x23e2ac)=>{const _0x111b22=_0xc31019;if(_0x599446){fs[_0x111b22(0xfc)](_0x59f3a3,{'recursive':!![]},_0x17f6a7=>{if(_0x17f6a7)return;_0x4ec58a(_0x384b44);});return;}_0x4ec58a(_0x384b44);});function _0x36c120(){const _0x229ecf=_0xc31019;_0x54b069&&(console[_0x229ecf(0xfe)]('!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!'),killFfmpByPlayId(_0x5e2242,![]),m3u8FfmpegTrans(_0x44fb92,_0x5e2242,_0x227bc7,_0x286d61,_0x14cd94,_0x53b835,_0x1e0a5e,![]));}function _0x4ec58a(){const _0x43967c=_0xc31019;_0x384b44['run'](),addFfmpToList(_0x384b44,_0x5e2242,_0x44fb92),_0x384b44['on'](_0x43967c(0x112),function(_0x4dbc87){const _0x44f988=_0x43967c;console[_0x44f988(0xfe)](_0x4dbc87);})['on'](_0x43967c(0x150),function(_0x4c629d){const _0x499b68=_0x43967c;_0x54b069&&_0x92b86c&&_0x4c629d&&_0x4c629d[_0x499b68(0x16c)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console[_0x499b68(0xfe)](_0x499b68(0x161)),_0x36c120());})['on'](_0x43967c(0x157),function(_0x132ca0){const _0x2c3a38=_0x43967c;_0x132ca0['message']&&_0x132ca0[_0x2c3a38(0x11e)][_0x2c3a38(0x16c)](_0x2c3a38(0x16b))==-0x1&&(console[_0x2c3a38(0xfe)](_0x132ca0),_0x36c120());})['on']('end',function(_0x19feeb){const _0x1f395a=_0x43967c;console[_0x1f395a(0xfe)](_0x19feeb);});}}catch(_0x475479){console[_0xc31019(0xfe)](_0x475479),_0x44fb92[_0xc31019(0x16f)]();}}setInterval(()=>{const _0x196686=_0x4a892b;let _0xe0c91a=new Date()[_0x196686(0x16d)](),_0x4e6a36=0xea60;for(let _0x1a649a in ffmpList){let _0xd2984c=ffmpList[_0x1a649a],_0x126c61=_0xe0c91a-_0xd2984c[_0x196686(0x151)];_0xd2984c[_0x196686(0x151)]&&_0x126c61>_0x4e6a36&&(console[_0x196686(0xfe)](_0x196686(0x123)),killFfmpByPlayId(_0xd2984c[_0x196686(0x132)]));}},0x2710),process['on'](_0x4a892b(0x11e),_0x4804a0=>{startPlay(_0x4804a0);}),process['on'](_0x4a892b(0x146),(_0x41bd21,_0x4ce3fc)=>{const _0x1d773d=_0x4a892b;process[_0x1d773d(0x12c)]({'type':_0x1d773d(0x16f)});});function _0x4409(){const _0x2643fc=['lastTsReqTime','gen','pragma','-map\x200:v:0?','-bufsize\x20','dvd_subtitle','error','kill','-map\x20[vss]','[vs]','-readrate\x20','journal_mode\x20=\x20WAL','-start_number\x20','medium','dvdsub','-hls_list_size\x200','qsv\x20cannot\x20deal,restart\x20ffmpeg','decoderCommand','hls','m3u8segmentDuration','-hls_time\x20','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','add','*.m3u8','stream.m3u8','subtitleIndex','killed','indexOf','getTime','18wgsrwb','close','audioIndex','[0:s:','push','Play\x20ID\x20has\x20started','FFmpeg','complexFilter','mkdir','getCrf','log','getFps','dirWatcher','364750lLvkit','watch','R_OK','-crf\x20','seekInput','encoderName','title','dbOther','[ref][sub]overlay[vss]','splice','dbFileIndex','[0:v:0]','addInputOption','seq','inputOption','path','708920mpRTNQ','start','aac','805yWtOkb','-ac\x202','change','hwaccel','videoBitrate','1582715EhVuUk','-preset\x20','-copyts','ready','getReadRate','message','includes','parseVideoFullPath','3088kMSvrC','get','No\x20request\x20timeout\x20','prepare','-filter:v\x20','run','getTranscodeSpeed','-g\x20','join','burn','basename','send','.m3u8','615WFklAB','getPixFmt','-map\x200:a:','format','playId','-pix_fmt\x20','better-sqlite3','access','getCoderConfig','Stop\x20transcode\x20','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','endsWith','size','pgssub','285418MrMyAk','output','codec_name','platform','videobit','parseStreamList','addOption','16890mKJjXA','getScaleOption','then','exit','parseSubtitle','../myConfig/config','addOutputOption','stat','.tmp','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','dealFFmpegPath','339351uSHcpV','../utils/transCodeUtil','stderr'];_0x4409=function(){return _0x2643fc;};return _0x4409();}