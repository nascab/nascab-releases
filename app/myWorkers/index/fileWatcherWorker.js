const _0xb74ac2=_0x43a1;(function(_0x393c5a,_0xcf6498){const _0x5e3b92=_0x43a1,_0x4f1087=_0x393c5a();while(!![]){try{const _0x3d3963=-parseInt(_0x5e3b92(0x178))/0x1+parseInt(_0x5e3b92(0x15a))/0x2+-parseInt(_0x5e3b92(0x156))/0x3+parseInt(_0x5e3b92(0x172))/0x4*(-parseInt(_0x5e3b92(0x189))/0x5)+parseInt(_0x5e3b92(0x191))/0x6*(parseInt(_0x5e3b92(0x15b))/0x7)+parseInt(_0x5e3b92(0x177))/0x8+parseInt(_0x5e3b92(0x18b))/0x9*(parseInt(_0x5e3b92(0x17d))/0xa);if(_0x3d3963===_0xcf6498)break;else _0x4f1087['push'](_0x4f1087['shift']());}catch(_0x2244e9){_0x4f1087['push'](_0x4f1087['shift']());}}}(_0xfe17,0x7ac11));let fs=require('fs'),path=require(_0xb74ac2(0x196));const config=require(_0xb74ac2(0x19e)),Database=require('better-sqlite3');let dbOther=new Database(config[_0xb74ac2(0x167)],{}),dbFileIndex=new Database(config[_0xb74ac2(0x186)],{});dbFileIndex[_0xb74ac2(0x188)](_0xb74ac2(0x17c)),dbOther[_0xb74ac2(0x188)](_0xb74ac2(0x17c));const dbSourceFolderTable=require(_0xb74ac2(0x163)),dbFileIndexTable=require(_0xb74ac2(0x15e));var nsfw=require(_0xb74ac2(0x17b));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0xb74ac2(0x183));const messageUtil=require('../../utils/messageUtil');process[_0xb74ac2(0x192)]=_0xb74ac2(0x16c);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require(_0xb74ac2(0x19b)),photoIndexUtil=require(_0xb74ac2(0x19a)),movieIndexUtil=require(_0xb74ac2(0x190));let allWatcherList=[],waitDealFileList=[];process['on'](_0xb74ac2(0x16d),_0x53b725=>{const _0x2eca60=_0xb74ac2;if(_0x53b725[_0x2eca60(0x17e)]=='startScanPath')_0x53b725[_0x2eca60(0x155)]!=_0x2eca60(0x164)&&(console[_0x2eca60(0x171)](_0x2eca60(0x1a0)),setSourceFolderWatcher());else _0x53b725['type']==_0x2eca60(0x19f)&&closeAllWatcher();});function _0x43a1(_0x11ec2c,_0x18049a){const _0xfe17d1=_0xfe17();return _0x43a1=function(_0x43a1fd,_0x4c8600){_0x43a1fd=_0x43a1fd-0x155;let _0x57d0a7=_0xfe17d1[_0x43a1fd];return _0x57d0a7;},_0x43a1(_0x11ec2c,_0x18049a);}async function dealFileChange(_0x2bda94,_0x15ab8d){const _0x1d4d8b=_0xb74ac2;if(!_0x2bda94||!_0x15ab8d)return;if(indexUtil['checkPathIsInPrivateSpace'](dbOther,_0x15ab8d))return![];if(indexUtil[_0x1d4d8b(0x179)](config,_0x15ab8d))return![];if(indexUtil['isForbiddenFilename'](path[_0x1d4d8b(0x181)](_0x15ab8d)))return![];for(let _0xbc608f=0x0;_0xbc608f<waitDealFileList[_0x1d4d8b(0x19c)];_0xbc608f++){if(waitDealFileList[_0xbc608f][_0x1d4d8b(0x18e)]==_0x15ab8d)return![];}waitDealFileList[_0x1d4d8b(0x15d)]({'watchPath':_0x2bda94,'fullPath':_0x15ab8d,'filePath':path['dirname'](_0x15ab8d),'fileName':path[_0x1d4d8b(0x181)](_0x15ab8d)});}async function startOneWatcher(_0x590030){const _0x475ff7=_0xb74ac2;try{let _0x3a1345=fs['statSync'](_0x590030);if(!_0x3a1345['isDirectory']())return null;let _0x3023f4=await nsfw(_0x590030,function(_0x293a92){const _0x5439d2=_0x43a1;for(let _0x34c29c in _0x293a92){let _0x3b0fc5=_0x293a92[_0x34c29c];if(_0x3b0fc5[_0x5439d2(0x17f)]==_0x5439d2(0x199))continue;if(_0x3b0fc5[_0x5439d2(0x18d)]==nsfw[_0x5439d2(0x15f)][_0x5439d2(0x161)]){let _0x1afcf9=path[_0x5439d2(0x1a1)](_0x3b0fc5[_0x5439d2(0x197)],_0x3b0fc5[_0x5439d2(0x176)]),_0x4d2e1c=path['join'](_0x3b0fc5[_0x5439d2(0x173)],_0x3b0fc5[_0x5439d2(0x16b)]);dealFileChange(_0x590030,_0x1afcf9),dealFileChange(_0x590030,_0x4d2e1c);}else{let _0x6a7745=path[_0x5439d2(0x1a1)](_0x3b0fc5['directory'],_0x3b0fc5[_0x5439d2(0x17f)]);dealFileChange(_0x590030,_0x6a7745);}}},{'errorCallback'(_0x4b0645){}});return _0x3023f4['start'](),{'watcher':_0x3023f4,'watchPathState':_0x3a1345};}catch(_0x5b6cc0){return console['log'](_0x475ff7(0x16f),_0x590030),null;}}function _0xfe17(){const _0x1d4c97=['push','../../db/dbFileIndexTable','actions','error','RENAMED','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','../../db/dbSourceFolderTable','delete','scan_when_change','未开启变动自动处理\x20跳过','dbOther','stack','music','电影来源变动:','newFile','FileChangingWatchWorker','message','startsWith','The\x20source\x20folder\x20no\x20exists\x20:\x20','close','log','85872MEehuL','newDirectory','dealTvDrama','NEW_PHOTO_INDEX','oldFile','4198512HjGWGt','672039QkXwoO','isForbiddenPath','then','nsfw','journal_mode\x20=\x20WAL','586240nLdiea','type','file','exit','basename','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','./indexUtil','stop','movie','dbFileIndex','getById','pragma','160uaHlBo','watcher','144jxRvBD','dealFileChange','action','fullPath','filter','./movieIndexUtil','1058370exqpqX','title','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','NEW_MOVIE_INDEX','图书来源变动:','path','directory','saveMsg','.DS_Store','./photoIndexUtil','./musicIndexUtil','length','变动检测列表中已包含父目录','../../myConfig/config','closeWatcher','重设文件变动检测','join','operate','735930edpgrx','sep','uncaughtException','send','583076hPegia','14gqhQxh','splice'];_0xfe17=function(){return _0x1d4c97;};return _0xfe17();}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x6db9ef=_0xb74ac2;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x298d56(){const _0x43c3ec=_0x43a1;let _0x552511=[];for(let _0x1775ac=0x0;_0x1775ac<finalWatchFolderList[_0x43c3ec(0x19c)];_0x1775ac++){let _0x38b48f=finalWatchFolderList[_0x1775ac]['path'];try{let _0x1b9374=await startOneWatcher(_0x38b48f);_0x1b9374?(console[_0x43c3ec(0x171)](_0x43c3ec(0x162),_0x38b48f),_0x552511[_0x43c3ec(0x15d)]({'path':_0x38b48f,'watcher':_0x1b9374[_0x43c3ec(0x18a)]})):(console[_0x43c3ec(0x171)](_0x43c3ec(0x193),_0x38b48f),_0x552511[_0x43c3ec(0x15d)]({'path':_0x38b48f,'watcher':null,'stop':0x1}));}catch(_0x267110){console['log'](_0x267110);}}return _0x552511;}let _0xa2c5e6=[];for(let _0x142ec2 in finalWatchFolderList){_0xa2c5e6[_0x6db9ef(0x15d)](finalWatchFolderList[_0x142ec2][_0x6db9ef(0x196)]);}closeAllWatcher(),allWatcherList=await _0x298d56(_0xa2c5e6,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],'photo'),isSettingWatcher=![];}function ifNeedDealChange(_0x54b6d3,_0x70e20e){const _0xb3b917=_0xb74ac2;for(let _0x20db95 in _0x54b6d3){let _0x5489a0=_0x54b6d3[_0x20db95];if(_0x70e20e[_0xb3b917(0x16e)](_0x5489a0[_0xb3b917(0x196)]+path[_0xb3b917(0x157)])||_0x70e20e==_0x5489a0[_0xb3b917(0x196)]){let _0x1b6dad=dbSourceFolderTable[_0xb3b917(0x187)](dbOther,_0x5489a0['id']);return _0x54b6d3[_0x20db95]=_0x1b6dad,_0x1b6dad||_0x1b6dad['scan_when_change']==0x1?!![]:(console[_0xb3b917(0x171)](_0xb3b917(0x166),_0x70e20e),![]);}}return![];}function initSourceFolderList(){const _0x29a5e6=_0xb74ac2;let _0x1fe466=dbSourceFolderTable['getAll'](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x5905fc of _0x1fe466){if(_0x5905fc[_0x29a5e6(0x165)]!=0x1)continue;if(_0x5905fc[_0x29a5e6(0x17e)]=='photo')photoSourceFolderList[_0x29a5e6(0x15d)](_0x5905fc);else{if(_0x5905fc[_0x29a5e6(0x17e)]==_0x29a5e6(0x185))movieSourceFolderList[_0x29a5e6(0x15d)](_0x5905fc);else{if(_0x5905fc[_0x29a5e6(0x17e)]==_0x29a5e6(0x169))musicSourceFolderList[_0x29a5e6(0x15d)](_0x5905fc);else _0x5905fc['type']=='book'&&bookSourceFolderList[_0x29a5e6(0x15d)](_0x5905fc);}}let _0x338f12=!![];for(let _0x31285c of finalWatchFolderList){let _0x567abb=path[_0x29a5e6(0x1a1)](_0x31285c[_0x29a5e6(0x196)]),_0xf4c6c6=path[_0x29a5e6(0x1a1)](_0x5905fc[_0x29a5e6(0x196)]);if(_0x567abb==_0xf4c6c6)_0x338f12=![];else{if(_0xf4c6c6[_0x29a5e6(0x16e)](_0x567abb+path[_0x29a5e6(0x157)]))console[_0x29a5e6(0x171)](_0x29a5e6(0x19d),_0x567abb),_0x338f12=![];else _0x567abb[_0x29a5e6(0x16e)](_0xf4c6c6+path[_0x29a5e6(0x157)])&&(console[_0x29a5e6(0x171)]('变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：',_0xf4c6c6),finalWatchFolderList=finalWatchFolderList[_0x29a5e6(0x18f)](_0x2a1c47=>_0x2a1c47[_0x29a5e6(0x196)]!=_0x567abb));}}_0x338f12&&finalWatchFolderList[_0x29a5e6(0x15d)](_0x5905fc);}}async function closeAllWatcher(){const _0x2661e8=_0xb74ac2;for(let _0x2ac7fd=0x0;_0x2ac7fd<allWatcherList['length'];_0x2ac7fd++){try{allWatcherList[_0x2ac7fd]['watcher']&&await allWatcherList[_0x2ac7fd][_0x2661e8(0x18a)][_0x2661e8(0x184)]();}catch(_0x46789c){}}}function dealNewFilePromise(){return new Promise(async(_0x4047e7,_0x232429)=>{const _0x14f6f5=_0x43a1;if(waitDealFileList[_0x14f6f5(0x19c)]>0x0){let _0x2a346b=waitDealFileList[0x0],_0x5b852f=![],_0x543d09=![];return ifNeedDealChange(photoSourceFolderList,_0x2a346b[_0x14f6f5(0x18e)])&&(console[_0x14f6f5(0x171)]('照片来源变动:',_0x2a346b[_0x14f6f5(0x18e)]),_0x5b852f=!![],await photoIndexUtil[_0x14f6f5(0x18c)](dbFileIndex,dbOther,_0x2a346b)),ifNeedDealChange(movieSourceFolderList,_0x2a346b[_0x14f6f5(0x18e)])&&(console['log'](_0x14f6f5(0x16a),_0x2a346b[_0x14f6f5(0x18e)]),_0x543d09=!![],await movieIndexUtil[_0x14f6f5(0x18c)](dbFileIndex,dbOther,_0x2a346b)),ifNeedDealChange(musicSourceFolderList,_0x2a346b[_0x14f6f5(0x18e)])&&(console[_0x14f6f5(0x171)]('音乐来源变动:',_0x2a346b['fullPath']),await musicIndexUtil[_0x14f6f5(0x18c)](dbFileIndex,dbOther,_0x2a346b)),ifNeedDealChange(bookSourceFolderList,_0x2a346b[_0x14f6f5(0x18e)])&&(console[_0x14f6f5(0x171)](_0x14f6f5(0x195),_0x2a346b[_0x14f6f5(0x18e)]),await bookIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x2a346b)),waitDealFileList[_0x14f6f5(0x15c)](0x0,0x1),waitDealFileList[_0x14f6f5(0x19c)]<0x1&&(_0x5b852f&&process[_0x14f6f5(0x159)]({'type':_0x14f6f5(0x175)}),_0x543d09&&(movieIndexUtil[_0x14f6f5(0x174)](dbFileIndex),process[_0x14f6f5(0x159)]({'type':_0x14f6f5(0x194)}))),_0x4047e7();}else setTimeout(()=>{return _0x4047e7();},0x1388);});}function dealNewFileRun(){const _0x158a46=_0xb74ac2;dealNewFilePromise()[_0x158a46(0x17a)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0xb74ac2(0x158),(_0x4ce2fb,_0x5e693f)=>{const _0x1e1bf5=_0xb74ac2;console[_0x1e1bf5(0x171)]('Error\x20occurred\x20in\x20photo\x20watcher\x20process',_0x4ce2fb),messageUtil[_0x1e1bf5(0x198)](dbOther,_0x1e1bf5(0x182),_0x1e1bf5(0x160),_0x4ce2fb[_0x1e1bf5(0x168)]||_0x4ce2fb[_0x1e1bf5(0x16d)]),closeAllWatcher(),process[_0x1e1bf5(0x159)]({'type':_0x1e1bf5(0x170)}),process[_0x1e1bf5(0x180)]();});