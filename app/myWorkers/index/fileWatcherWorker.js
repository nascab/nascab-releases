const _0xd0d4dd=_0x2bea;(function(_0x5c7a77,_0x65c118){const _0x143eeb=_0x2bea,_0xa116f6=_0x5c7a77();while(!![]){try{const _0x25446a=parseInt(_0x143eeb(0xb9))/0x1*(parseInt(_0x143eeb(0xc4))/0x2)+parseInt(_0x143eeb(0xc8))/0x3+-parseInt(_0x143eeb(0xeb))/0x4*(-parseInt(_0x143eeb(0xe2))/0x5)+-parseInt(_0x143eeb(0xdc))/0x6+parseInt(_0x143eeb(0xd6))/0x7+-parseInt(_0x143eeb(0xd7))/0x8*(parseInt(_0x143eeb(0xcc))/0x9)+parseInt(_0x143eeb(0xe8))/0xa*(parseInt(_0x143eeb(0xbf))/0xb);if(_0x25446a===_0x65c118)break;else _0xa116f6['push'](_0xa116f6['shift']());}catch(_0x43dba3){_0xa116f6['push'](_0xa116f6['shift']());}}}(_0x5990,0x32e38));let fs=require('fs'),path=require('path');const config=require(_0xd0d4dd(0xcf)),Database=require(_0xd0d4dd(0xbb));let dbOther=new Database(config[_0xd0d4dd(0xce)],{}),dbFileIndex=new Database(config[_0xd0d4dd(0xbd)],{});dbFileIndex[_0xd0d4dd(0xea)](_0xd0d4dd(0xd9)),dbOther['pragma'](_0xd0d4dd(0xd9));const dbSourceFolderTable=require(_0xd0d4dd(0xdb)),dbFileIndexTable=require(_0xd0d4dd(0xb8));var nsfw=require(_0xd0d4dd(0xec));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0xd0d4dd(0xaf));const messageUtil=require(_0xd0d4dd(0xc2));process['title']='FileChangingWatchWorker';const bookIndexUtil=require(_0xd0d4dd(0xd2)),musicIndexUtil=require(_0xd0d4dd(0xda)),photoIndexUtil=require('./photoIndexUtil'),movieIndexUtil=require(_0xd0d4dd(0xb3));let allWatcherList=[],waitDealFileList=[];function _0x2bea(_0x6e1119,_0x5ea96d){const _0x5990cf=_0x5990();return _0x2bea=function(_0x2beaa7,_0x412d03){_0x2beaa7=_0x2beaa7-0xac;let _0x3f55b2=_0x5990cf[_0x2beaa7];return _0x3f55b2;},_0x2bea(_0x6e1119,_0x5ea96d);}process['on']('message',_0x8a23a2=>{const _0x1884f5=_0xd0d4dd;if(_0x8a23a2[_0x1884f5(0xb4)]==_0x1884f5(0xdf))_0x8a23a2[_0x1884f5(0xae)]!=_0x1884f5(0xd1)&&(console[_0x1884f5(0xe3)](_0x1884f5(0xf7)),setSourceFolderWatcher());else _0x8a23a2['type']=='closeWatcher'&&closeAllWatcher();});async function dealFileChange(_0x216cef,_0x479f1c){const _0x2972d5=_0xd0d4dd;if(!_0x216cef||!_0x479f1c)return;if(indexUtil[_0x2972d5(0xc5)](dbOther,_0x479f1c))return![];if(indexUtil['isForbiddenPath'](config,_0x479f1c))return![];if(indexUtil[_0x2972d5(0xe1)](path[_0x2972d5(0xc7)](_0x479f1c)))return![];for(let _0x165601=0x0;_0x165601<waitDealFileList[_0x2972d5(0xd0)];_0x165601++){if(waitDealFileList[_0x165601][_0x2972d5(0xf8)]==_0x479f1c)return![];}waitDealFileList[_0x2972d5(0xd3)]({'watchPath':_0x216cef,'fullPath':_0x479f1c,'filePath':path[_0x2972d5(0xbe)](_0x479f1c),'fileName':path[_0x2972d5(0xc7)](_0x479f1c)});}async function startOneWatcher(_0x3de1c5){const _0x2199e9=_0xd0d4dd;try{let _0x389d55=fs['statSync'](_0x3de1c5);if(!_0x389d55['isDirectory']())return null;let _0x11b697=await nsfw(_0x3de1c5,function(_0x4dd7e0){const _0x189cac=_0x2bea;for(let _0x21befd in _0x4dd7e0){let _0x5a9d99=_0x4dd7e0[_0x21befd];if(_0x5a9d99[_0x189cac(0xf0)]==_0x189cac(0xcb))continue;if(_0x5a9d99['action']==nsfw[_0x189cac(0xac)][_0x189cac(0xf5)]){let _0x561ede=path[_0x189cac(0xc1)](_0x5a9d99[_0x189cac(0xb0)],_0x5a9d99[_0x189cac(0xca)]),_0x1f37dc=path['join'](_0x5a9d99[_0x189cac(0xd8)],_0x5a9d99['newFile']);dealFileChange(_0x3de1c5,_0x561ede),dealFileChange(_0x3de1c5,_0x1f37dc);}else{let _0x34c14b=path[_0x189cac(0xc1)](_0x5a9d99[_0x189cac(0xb0)],_0x5a9d99[_0x189cac(0xf0)]);dealFileChange(_0x3de1c5,_0x34c14b);}}},{'errorCallback'(_0x42ef93){}});return _0x11b697[_0x2199e9(0xe7)](),{'watcher':_0x11b697,'watchPathState':_0x389d55};}catch(_0x150726){return console[_0x2199e9(0xe3)](_0x2199e9(0xf6),_0x3de1c5),null;}}function _0x5990(){const _0x499d09=['12617xHHnKv','movie','join','../../utils/messageUtil','NEW_MOVIE_INDEX','374jvSzqs','checkPathIsInPrivateSpace','path','basename','729384lQnRDs','getAll','oldFile','.DS_Store','3701520KbWAcv','INDEX_TABLE_NAME_PHOTO','dbOther','../../myConfig/config','length','delete','./bookIndexUtil','push','sep','scan_when_change','743400ZvWqsw','8nEBMXW','newDirectory','journal_mode\x20=\x20WAL','./musicIndexUtil','../../db/dbSourceFolderTable','1796010PgBPWh','close','startsWith','startScanPath','photo','isForbiddenFilename','5rvRMCI','log','NEW_PHOTO_INDEX','saveMsg','exit','start','3530FrXYAB','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','pragma','413252QOxYpZ','nsfw','send','图书来源变动:','变动检测列表中已包含父目录','file','splice','dealFileChange','watcher','music','RENAMED','The\x20source\x20folder\x20no\x20exists\x20:\x20','重设文件变动检测','fullPath','error','uncaughtException','actions','filter','operate','./indexUtil','directory','Error\x20occurred\x20in\x20photo\x20watcher\x20process','照片来源变动:','./movieIndexUtil','type','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','音乐来源变动:','getById','../../db/dbFileIndexTable','329GShVEH','未开启变动自动处理\x20跳过','better-sqlite3','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','dbFileIndex','dirname'];_0x5990=function(){return _0x499d09;};return _0x5990();}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x3b5f26=_0xd0d4dd;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x5bc53d(){const _0x45abc8=_0x2bea;let _0x23b16b=[];for(let _0x169677=0x0;_0x169677<finalWatchFolderList[_0x45abc8(0xd0)];_0x169677++){let _0x331580=finalWatchFolderList[_0x169677][_0x45abc8(0xc6)];try{let _0x2b1a2c=await startOneWatcher(_0x331580);_0x2b1a2c?(console['log']('文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success',_0x331580),_0x23b16b[_0x45abc8(0xd3)]({'path':_0x331580,'watcher':_0x2b1a2c[_0x45abc8(0xf3)]})):(console[_0x45abc8(0xe3)](_0x45abc8(0xb5),_0x331580),_0x23b16b[_0x45abc8(0xd3)]({'path':_0x331580,'watcher':null,'stop':0x1}));}catch(_0x9c37ef){console[_0x45abc8(0xe3)](_0x9c37ef);}}return _0x23b16b;}let _0x391507=[];for(let _0x3db054 in finalWatchFolderList){_0x391507[_0x3b5f26(0xd3)](finalWatchFolderList[_0x3db054][_0x3b5f26(0xc6)]);}closeAllWatcher(),allWatcherList=await _0x5bc53d(_0x391507,dbFileIndexTable[_0x3b5f26(0xcd)],_0x3b5f26(0xe0)),isSettingWatcher=![];}function ifNeedDealChange(_0x29a11f,_0x140f45){const _0x244d62=_0xd0d4dd;for(let _0x20f9ea in _0x29a11f){let _0x43320c=_0x29a11f[_0x20f9ea];if(_0x140f45[_0x244d62(0xde)](_0x43320c[_0x244d62(0xc6)]+path['sep'])||_0x140f45==_0x43320c['path']){let _0x7192d9=dbSourceFolderTable[_0x244d62(0xb7)](dbOther,_0x43320c['id']);return _0x29a11f[_0x20f9ea]=_0x7192d9,_0x7192d9||_0x7192d9[_0x244d62(0xd5)]==0x1?!![]:(console[_0x244d62(0xe3)](_0x244d62(0xba),_0x140f45),![]);}}return![];}function initSourceFolderList(){const _0x110424=_0xd0d4dd;let _0x17e0eb=dbSourceFolderTable[_0x110424(0xc9)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x1ddcd8 of _0x17e0eb){if(_0x1ddcd8['scan_when_change']!=0x1)continue;if(_0x1ddcd8['type']==_0x110424(0xe0))photoSourceFolderList['push'](_0x1ddcd8);else{if(_0x1ddcd8[_0x110424(0xb4)]==_0x110424(0xc0))movieSourceFolderList[_0x110424(0xd3)](_0x1ddcd8);else{if(_0x1ddcd8[_0x110424(0xb4)]==_0x110424(0xf4))musicSourceFolderList[_0x110424(0xd3)](_0x1ddcd8);else _0x1ddcd8['type']=='book'&&bookSourceFolderList['push'](_0x1ddcd8);}}let _0x8d3974=!![];for(let _0x138c4b of finalWatchFolderList){let _0x2ac8ca=path['join'](_0x138c4b[_0x110424(0xc6)]),_0x8585a0=path['join'](_0x1ddcd8['path']);if(_0x2ac8ca==_0x8585a0)_0x8d3974=![];else{if(_0x8585a0[_0x110424(0xde)](_0x2ac8ca+path['sep']))console[_0x110424(0xe3)](_0x110424(0xef),_0x2ac8ca),_0x8d3974=![];else _0x2ac8ca[_0x110424(0xde)](_0x8585a0+path[_0x110424(0xd4)])&&(console[_0x110424(0xe3)](_0x110424(0xbc),_0x8585a0),finalWatchFolderList=finalWatchFolderList[_0x110424(0xad)](_0x5e047e=>_0x5e047e[_0x110424(0xc6)]!=_0x2ac8ca));}}_0x8d3974&&finalWatchFolderList[_0x110424(0xd3)](_0x1ddcd8);}}async function closeAllWatcher(){const _0x464dea=_0xd0d4dd;for(let _0x16aa3e=0x0;_0x16aa3e<allWatcherList['length'];_0x16aa3e++){try{allWatcherList[_0x16aa3e]['watcher']&&await allWatcherList[_0x16aa3e][_0x464dea(0xf3)]['stop']();}catch(_0x4ffad2){}}}function dealNewFilePromise(){return new Promise(async(_0x25766d,_0x2d5365)=>{const _0x314f21=_0x2bea;if(waitDealFileList[_0x314f21(0xd0)]>0x0){let _0x97aa34=waitDealFileList[0x0],_0x13012f=![],_0x1bfbd2=![];return ifNeedDealChange(photoSourceFolderList,_0x97aa34['fullPath'])&&(console[_0x314f21(0xe3)](_0x314f21(0xb2),_0x97aa34['fullPath']),_0x13012f=!![],await photoIndexUtil[_0x314f21(0xf2)](dbFileIndex,dbOther,_0x97aa34)),ifNeedDealChange(movieSourceFolderList,_0x97aa34[_0x314f21(0xf8)])&&(console[_0x314f21(0xe3)]('电影来源变动:',_0x97aa34['fullPath']),_0x1bfbd2=!![],await movieIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x97aa34)),ifNeedDealChange(musicSourceFolderList,_0x97aa34[_0x314f21(0xf8)])&&(console['log'](_0x314f21(0xb6),_0x97aa34[_0x314f21(0xf8)]),await musicIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x97aa34)),ifNeedDealChange(bookSourceFolderList,_0x97aa34['fullPath'])&&(console[_0x314f21(0xe3)](_0x314f21(0xee),_0x97aa34[_0x314f21(0xf8)]),await bookIndexUtil[_0x314f21(0xf2)](dbFileIndex,dbOther,_0x97aa34)),waitDealFileList[_0x314f21(0xf1)](0x0,0x1),waitDealFileList[_0x314f21(0xd0)]<0x1&&(_0x13012f&&process[_0x314f21(0xed)]({'type':_0x314f21(0xe4)}),_0x1bfbd2&&(movieIndexUtil['dealTvDrama'](dbFileIndex),process[_0x314f21(0xed)]({'type':_0x314f21(0xc3)}))),_0x25766d();}else setTimeout(()=>{return _0x25766d();},0x1388);});}function dealNewFileRun(){dealNewFilePromise()['then'](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0xd0d4dd(0xfa),(_0x2a9c0e,_0x5f5464)=>{const _0x436528=_0xd0d4dd;console[_0x436528(0xe3)](_0x436528(0xb1),_0x2a9c0e),messageUtil[_0x436528(0xe5)](dbOther,_0x436528(0xe9),_0x436528(0xf9),_0x2a9c0e['stack']||_0x2a9c0e['message']),closeAllWatcher(),process[_0x436528(0xed)]({'type':_0x436528(0xdd)}),process[_0x436528(0xe6)]();});