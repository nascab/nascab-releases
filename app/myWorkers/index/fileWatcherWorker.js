const _0x3aabce=_0x593d;function _0x11c8(){const _0x2a2112=['message','movie','watcher','nsfw','type','dealFileChange','uncaughtException','.DS_Store','NEW_MOVIE_INDEX','closeWatcher','startScanPath','directory','journal_mode\x20=\x20WAL','未开启变动自动处理\x20跳过','NEW_PHOTO_INDEX','action','length','delete','../../db/dbSourceFolderTable','splice','../../myConfig/config','oldFile','getById','send','2912cViYCi','path','scan_when_change','./photoIndexUtil','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','stack','重设文件变动检测','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','INDEX_TABLE_NAME_PHOTO','then','6520401JCTcpz','3131457CWSRKQ','dbOther','电影来源变动:','photo','fullPath','RENAMED','1744616Wrootg','startsWith','isDirectory','../../db/dbFileIndexTable','newDirectory','log','title','start','music','error','dirname','照片来源变动:','checkPathIsInPrivateSpace','operate','3639424aZKPpl','35288100IXFNdw','isForbiddenFilename','stop','sep','447fikruO','The\x20source\x20folder\x20no\x20exists\x20:\x20','图书来源变动:','basename','24VvivXI','join','FileChangingWatchWorker','push','better-sqlite3','close','isForbiddenPath','exit','book','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','6AEowhr','1043225MIbbLH','变动检测列表中已包含父目录'];_0x11c8=function(){return _0x2a2112;};return _0x11c8();}(function(_0x1b6e50,_0x12c8a9){const _0x2d4786=_0x593d,_0x30b799=_0x1b6e50();while(!![]){try{const _0x49e1e5=-parseInt(_0x2d4786(0xbd))/0x1*(parseInt(_0x2d4786(0xe6))/0x2)+-parseInt(_0x2d4786(0xcb))/0x3*(parseInt(_0x2d4786(0xf7))/0x4)+parseInt(_0x2d4786(0xcc))/0x5*(-parseInt(_0x2d4786(0xc1))/0x6)+parseInt(_0x2d4786(0xf1))/0x7+-parseInt(_0x2d4786(0xb8))/0x8+-parseInt(_0x2d4786(0xf0))/0x9+parseInt(_0x2d4786(0xb9))/0xa;if(_0x49e1e5===_0x12c8a9)break;else _0x30b799['push'](_0x30b799['shift']());}catch(_0x46b6e3){_0x30b799['push'](_0x30b799['shift']());}}}(_0x11c8,0x6b2f0));let fs=require('fs'),path=require(_0x3aabce(0xe7));const config=require(_0x3aabce(0xe2)),Database=require(_0x3aabce(0xc5));let dbOther=new Database(config[_0x3aabce(0xf2)],{}),dbFileIndex=new Database(config['dbFileIndex'],{});dbFileIndex['pragma'](_0x3aabce(0xda)),dbOther['pragma']('journal_mode\x20=\x20WAL');const dbSourceFolderTable=require(_0x3aabce(0xe0)),dbFileIndexTable=require(_0x3aabce(0xfa));var nsfw=require(_0x3aabce(0xd1));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require('./indexUtil');const messageUtil=require('../../utils/messageUtil');process[_0x3aabce(0xfd)]=_0x3aabce(0xc3);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require('./musicIndexUtil'),photoIndexUtil=require(_0x3aabce(0xe9)),movieIndexUtil=require('./movieIndexUtil');let allWatcherList=[],waitDealFileList=[];function _0x593d(_0x3c1ff8,_0x54d0f6){const _0x11c810=_0x11c8();return _0x593d=function(_0x593d56,_0x3c7112){_0x593d56=_0x593d56-0xb1;let _0x7a47d5=_0x11c810[_0x593d56];return _0x7a47d5;},_0x593d(_0x3c1ff8,_0x54d0f6);}process['on'](_0x3aabce(0xce),_0x44b65b=>{const _0x1c2414=_0x3aabce;if(_0x44b65b['type']==_0x1c2414(0xd8))_0x44b65b[_0x1c2414(0xb7)]!=_0x1c2414(0xdf)&&(console[_0x1c2414(0xfc)](_0x1c2414(0xec)),setSourceFolderWatcher());else _0x44b65b[_0x1c2414(0xd2)]==_0x1c2414(0xd7)&&closeAllWatcher();});async function dealFileChange(_0xaa2cbd,_0xd3c70b){const _0x3bce26=_0x3aabce;if(!_0xaa2cbd||!_0xd3c70b)return;if(indexUtil[_0x3bce26(0xb6)](dbOther,_0xd3c70b))return![];if(indexUtil[_0x3bce26(0xc7)](config,_0xd3c70b))return![];if(indexUtil[_0x3bce26(0xba)](path[_0x3bce26(0xc0)](_0xd3c70b)))return![];for(let _0x3ba3f9=0x0;_0x3ba3f9<waitDealFileList[_0x3bce26(0xde)];_0x3ba3f9++){if(waitDealFileList[_0x3ba3f9][_0x3bce26(0xf5)]==_0xd3c70b)return![];}waitDealFileList[_0x3bce26(0xc4)]({'watchPath':_0xaa2cbd,'fullPath':_0xd3c70b,'filePath':path[_0x3bce26(0xb4)](_0xd3c70b),'fileName':path[_0x3bce26(0xc0)](_0xd3c70b)});}async function startOneWatcher(_0x19a7f7){const _0x3dfe05=_0x3aabce;try{let _0x4d7cd9=fs['statSync'](_0x19a7f7);if(!_0x4d7cd9[_0x3dfe05(0xf9)]())return null;let _0x313762=await nsfw(_0x19a7f7,function(_0x48f021){const _0x2b2812=_0x3dfe05;for(let _0x391411 in _0x48f021){let _0x2be15d=_0x48f021[_0x391411];if(_0x2be15d['file']==_0x2b2812(0xd5))continue;if(_0x2be15d[_0x2b2812(0xdd)]==nsfw['actions'][_0x2b2812(0xf6)]){let _0x1dfaea=path['join'](_0x2be15d[_0x2b2812(0xd9)],_0x2be15d[_0x2b2812(0xe3)]),_0xc2dab7=path['join'](_0x2be15d[_0x2b2812(0xfb)],_0x2be15d['newFile']);dealFileChange(_0x19a7f7,_0x1dfaea),dealFileChange(_0x19a7f7,_0xc2dab7);}else{let _0x9d5e03=path[_0x2b2812(0xc2)](_0x2be15d[_0x2b2812(0xd9)],_0x2be15d['file']);dealFileChange(_0x19a7f7,_0x9d5e03);}}},{'errorCallback'(_0x14f9db){}});return _0x313762[_0x3dfe05(0xb1)](),{'watcher':_0x313762,'watchPathState':_0x4d7cd9};}catch(_0x501693){return console['log'](_0x3dfe05(0xbe),_0x19a7f7),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x138908=_0x3aabce;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x4dc5df(){const _0x7879c1=_0x593d;let _0x48c879=[];for(let _0x207fc6=0x0;_0x207fc6<finalWatchFolderList[_0x7879c1(0xde)];_0x207fc6++){let _0xea7fd0=finalWatchFolderList[_0x207fc6][_0x7879c1(0xe7)];try{let _0x4b09ff=await startOneWatcher(_0xea7fd0);_0x4b09ff?(console['log']('文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success',_0xea7fd0),_0x48c879[_0x7879c1(0xc4)]({'path':_0xea7fd0,'watcher':_0x4b09ff[_0x7879c1(0xd0)]})):(console[_0x7879c1(0xfc)](_0x7879c1(0xed),_0xea7fd0),_0x48c879[_0x7879c1(0xc4)]({'path':_0xea7fd0,'watcher':null,'stop':0x1}));}catch(_0x214c79){console['log'](_0x214c79);}}return _0x48c879;}let _0x111a7d=[];for(let _0x4dc6bb in finalWatchFolderList){_0x111a7d['push'](finalWatchFolderList[_0x4dc6bb]['path']);}closeAllWatcher(),allWatcherList=await _0x4dc5df(_0x111a7d,dbFileIndexTable[_0x138908(0xee)],_0x138908(0xf4)),isSettingWatcher=![];}function ifNeedDealChange(_0x5e9916,_0x2601a4){const _0x412856=_0x3aabce;for(let _0x3ca1cf in _0x5e9916){let _0x1cf816=_0x5e9916[_0x3ca1cf];if(_0x1cf816){if(_0x2601a4[_0x412856(0xf8)](_0x1cf816['path']+path[_0x412856(0xbc)])||_0x2601a4==_0x1cf816[_0x412856(0xe7)]){let _0x5502cf=dbSourceFolderTable[_0x412856(0xe4)](dbOther,_0x1cf816['id']);return _0x5e9916[_0x3ca1cf]=_0x5502cf,_0x5502cf||_0x5502cf&&_0x5502cf[_0x412856(0xe8)]==0x1?!![]:(console[_0x412856(0xfc)](_0x412856(0xdb),_0x2601a4),![]);}}}return![];}function initSourceFolderList(){const _0x59d28d=_0x3aabce;let _0x4998f0=dbSourceFolderTable['getAll'](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0xfd121d of _0x4998f0){if(_0xfd121d[_0x59d28d(0xe8)]!=0x1)continue;if(_0xfd121d[_0x59d28d(0xd2)]=='photo')photoSourceFolderList[_0x59d28d(0xc4)](_0xfd121d);else{if(_0xfd121d[_0x59d28d(0xd2)]==_0x59d28d(0xcf))movieSourceFolderList['push'](_0xfd121d);else{if(_0xfd121d[_0x59d28d(0xd2)]==_0x59d28d(0xb2))musicSourceFolderList[_0x59d28d(0xc4)](_0xfd121d);else _0xfd121d[_0x59d28d(0xd2)]==_0x59d28d(0xc9)&&bookSourceFolderList['push'](_0xfd121d);}}let _0x1d2831=!![];for(let _0xd6e028 of finalWatchFolderList){let _0x1ca177=path['join'](_0xd6e028[_0x59d28d(0xe7)]),_0x453833=path[_0x59d28d(0xc2)](_0xfd121d[_0x59d28d(0xe7)]);if(_0x1ca177==_0x453833)_0x1d2831=![];else{if(_0x453833[_0x59d28d(0xf8)](_0x1ca177+path[_0x59d28d(0xbc)]))console[_0x59d28d(0xfc)](_0x59d28d(0xcd),_0x1ca177),_0x1d2831=![];else _0x1ca177[_0x59d28d(0xf8)](_0x453833+path[_0x59d28d(0xbc)])&&(console[_0x59d28d(0xfc)](_0x59d28d(0xea),_0x453833),finalWatchFolderList=finalWatchFolderList['filter'](_0x271321=>_0x271321[_0x59d28d(0xe7)]!=_0x1ca177));}}_0x1d2831&&finalWatchFolderList[_0x59d28d(0xc4)](_0xfd121d);}}async function closeAllWatcher(){const _0x331961=_0x3aabce;for(let _0x3b5402=0x0;_0x3b5402<allWatcherList[_0x331961(0xde)];_0x3b5402++){try{allWatcherList[_0x3b5402][_0x331961(0xd0)]&&await allWatcherList[_0x3b5402][_0x331961(0xd0)][_0x331961(0xbb)]();}catch(_0x27eb54){}}}function dealNewFilePromise(){return new Promise(async(_0x13037a,_0x21aa91)=>{const _0x3da7a1=_0x593d;if(waitDealFileList[_0x3da7a1(0xde)]>0x0){let _0x5bb8cb=waitDealFileList[0x0],_0x53c95f=![],_0x31bf81=![];return ifNeedDealChange(photoSourceFolderList,_0x5bb8cb[_0x3da7a1(0xf5)])&&(console[_0x3da7a1(0xfc)](_0x3da7a1(0xb5),_0x5bb8cb[_0x3da7a1(0xf5)]),_0x53c95f=!![],await photoIndexUtil[_0x3da7a1(0xd3)](dbFileIndex,dbOther,_0x5bb8cb)),ifNeedDealChange(movieSourceFolderList,_0x5bb8cb[_0x3da7a1(0xf5)])&&(console[_0x3da7a1(0xfc)](_0x3da7a1(0xf3),_0x5bb8cb['fullPath']),_0x31bf81=!![],await movieIndexUtil[_0x3da7a1(0xd3)](dbFileIndex,dbOther,_0x5bb8cb)),ifNeedDealChange(musicSourceFolderList,_0x5bb8cb[_0x3da7a1(0xf5)])&&(console['log']('音乐来源变动:',_0x5bb8cb[_0x3da7a1(0xf5)]),await musicIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x5bb8cb)),ifNeedDealChange(bookSourceFolderList,_0x5bb8cb['fullPath'])&&(console[_0x3da7a1(0xfc)](_0x3da7a1(0xbf),_0x5bb8cb[_0x3da7a1(0xf5)]),await bookIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x5bb8cb)),waitDealFileList[_0x3da7a1(0xe1)](0x0,0x1),waitDealFileList['length']<0x1&&(_0x53c95f&&process[_0x3da7a1(0xe5)]({'type':_0x3da7a1(0xdc)}),_0x31bf81&&(movieIndexUtil['dealTvDrama'](dbFileIndex),process['send']({'type':_0x3da7a1(0xd6)}))),_0x13037a();}else setTimeout(()=>{return _0x13037a();},0x1388);});}function dealNewFileRun(){const _0x61b807=_0x3aabce;dealNewFilePromise()[_0x61b807(0xef)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x3aabce(0xd4),(_0x588088,_0x35ce30)=>{const _0x52335e=_0x3aabce;console[_0x52335e(0xfc)]('Error\x20occurred\x20in\x20photo\x20watcher\x20process',_0x588088),messageUtil['saveMsg'](dbOther,_0x52335e(0xca),_0x52335e(0xb3),_0x588088[_0x52335e(0xeb)]||_0x588088['message']),closeAllWatcher(),process[_0x52335e(0xe5)]({'type':_0x52335e(0xc6)}),process[_0x52335e(0xc8)]();});