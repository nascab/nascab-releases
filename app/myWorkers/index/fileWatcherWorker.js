const _0x21debd=_0x33dc;(function(_0x517cad,_0x5266e1){const _0x2da850=_0x33dc,_0x355155=_0x517cad();while(!![]){try{const _0x297265=-parseInt(_0x2da850(0x1df))/0x1+-parseInt(_0x2da850(0x203))/0x2*(-parseInt(_0x2da850(0x1dc))/0x3)+parseInt(_0x2da850(0x1d7))/0x4+parseInt(_0x2da850(0x20d))/0x5*(-parseInt(_0x2da850(0x207))/0x6)+parseInt(_0x2da850(0x205))/0x7+-parseInt(_0x2da850(0x1ce))/0x8+parseInt(_0x2da850(0x1de))/0x9;if(_0x297265===_0x5266e1)break;else _0x355155['push'](_0x355155['shift']());}catch(_0xeb8a8e){_0x355155['push'](_0x355155['shift']());}}}(_0x38b9,0x53460));let fs=require('fs'),path=require('path');const config=require('../../myConfig/config'),Database=require(_0x21debd(0x1d4));let dbOther=new Database(config[_0x21debd(0x1e3)],{}),dbFileIndex=new Database(config[_0x21debd(0x1d3)],{});dbFileIndex[_0x21debd(0x1fb)](_0x21debd(0x1d5)),dbOther[_0x21debd(0x1fb)]('journal_mode\x20=\x20WAL');const dbSourceFolderTable=require(_0x21debd(0x1e4)),dbFileIndexTable=require(_0x21debd(0x204));var nsfw=require(_0x21debd(0x1ea));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x21debd(0x1db));const messageUtil=require(_0x21debd(0x1e0));process['title']=_0x21debd(0x1f9);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require('./musicIndexUtil'),photoIndexUtil=require(_0x21debd(0x1da)),movieIndexUtil=require(_0x21debd(0x1fe));let allWatcherList=[],waitDealFileList=[];process['on'](_0x21debd(0x1c5),_0x37fa51=>{const _0x5d102e=_0x21debd;if(_0x37fa51[_0x5d102e(0x20e)]==_0x5d102e(0x1d2))_0x37fa51[_0x5d102e(0x20f)]!=_0x5d102e(0x1c9)&&(console[_0x5d102e(0x20a)]('重设文件变动检测'),setSourceFolderWatcher());else _0x37fa51['type']==_0x5d102e(0x1ef)&&closeAllWatcher();});async function dealFileChange(_0x5f2b5e,_0x14859f){const _0x1a50a4=_0x21debd;if(!_0x5f2b5e||!_0x14859f)return;if(indexUtil[_0x1a50a4(0x211)](dbOther,_0x14859f))return![];if(indexUtil[_0x1a50a4(0x1e5)](config,_0x14859f))return![];if(indexUtil['isForbiddenFilename'](path[_0x1a50a4(0x1c6)](_0x14859f)))return![];for(let _0x471f24=0x0;_0x471f24<waitDealFileList[_0x1a50a4(0x1cb)];_0x471f24++){if(waitDealFileList[_0x471f24][_0x1a50a4(0x20b)]==_0x14859f)return![];}waitDealFileList[_0x1a50a4(0x1d1)]({'watchPath':_0x5f2b5e,'fullPath':_0x14859f,'filePath':path[_0x1a50a4(0x1e6)](_0x14859f),'fileName':path[_0x1a50a4(0x1c6)](_0x14859f)});}async function startOneWatcher(_0x2fe0a2){const _0x335324=_0x21debd;try{let _0x3ff08a=fs[_0x335324(0x202)](_0x2fe0a2);if(!_0x3ff08a['isDirectory']())return null;let _0x3106b1=await nsfw(_0x2fe0a2,function(_0x345562){const _0x323a97=_0x335324;for(let _0x11264b in _0x345562){let _0x5f0fe4=_0x345562[_0x11264b];if(_0x5f0fe4['file']==_0x323a97(0x1eb))continue;if(_0x5f0fe4['action']==nsfw[_0x323a97(0x1d6)][_0x323a97(0x1f4)]){let _0x565789=path[_0x323a97(0x1d0)](_0x5f0fe4[_0x323a97(0x1c8)],_0x5f0fe4[_0x323a97(0x208)]),_0x5068ca=path[_0x323a97(0x1d0)](_0x5f0fe4[_0x323a97(0x1e2)],_0x5f0fe4[_0x323a97(0x1f2)]);dealFileChange(_0x2fe0a2,_0x565789),dealFileChange(_0x2fe0a2,_0x5068ca);}else{let _0x2d3152=path[_0x323a97(0x1d0)](_0x5f0fe4[_0x323a97(0x1c8)],_0x5f0fe4[_0x323a97(0x1c4)]);dealFileChange(_0x2fe0a2,_0x2d3152);}}},{'errorCallback'(_0x566509){}});return _0x3106b1[_0x335324(0x1fd)](),{'watcher':_0x3106b1,'watchPathState':_0x3ff08a};}catch(_0x49e33b){return console[_0x335324(0x20a)]('The\x20source\x20folder\x20no\x20exists\x20:\x20',_0x2fe0a2),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x2e02cf=_0x21debd;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x2ae929(){const _0x438e3f=_0x33dc;let _0x10de61=[];for(let _0x455356=0x0;_0x455356<finalWatchFolderList['length'];_0x455356++){let _0x191b65=finalWatchFolderList[_0x455356][_0x438e3f(0x210)];try{let _0x4d241e=await startOneWatcher(_0x191b65);_0x4d241e?(console[_0x438e3f(0x20a)]('文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success',_0x191b65),_0x10de61[_0x438e3f(0x1d1)]({'path':_0x191b65,'watcher':_0x4d241e[_0x438e3f(0x1f6)]})):(console[_0x438e3f(0x20a)](_0x438e3f(0x1d8),_0x191b65),_0x10de61[_0x438e3f(0x1d1)]({'path':_0x191b65,'watcher':null,'stop':0x1}));}catch(_0xd7804b){console[_0x438e3f(0x20a)](_0xd7804b);}}return _0x10de61;}let _0x3b4e47=[];for(let _0x3dac06 in finalWatchFolderList){_0x3b4e47[_0x2e02cf(0x1d1)](finalWatchFolderList[_0x3dac06][_0x2e02cf(0x210)]);}closeAllWatcher(),allWatcherList=await _0x2ae929(_0x3b4e47,dbFileIndexTable[_0x2e02cf(0x1cf)],_0x2e02cf(0x1e8)),isSettingWatcher=![];}function ifNeedDealChange(_0x360aff,_0x50b36d){const _0x3487fe=_0x21debd;for(let _0x43c4f1 in _0x360aff){let _0x7f5a7c=_0x360aff[_0x43c4f1];if(_0x50b36d[_0x3487fe(0x1e7)](_0x7f5a7c[_0x3487fe(0x210)]+path['sep'])||_0x50b36d==_0x7f5a7c[_0x3487fe(0x210)]){let _0x5a5285=dbSourceFolderTable[_0x3487fe(0x1e1)](dbOther,_0x7f5a7c['id']);return _0x360aff[_0x43c4f1]=_0x5a5285,_0x5a5285||_0x5a5285[_0x3487fe(0x206)]==0x1?!![]:(console[_0x3487fe(0x20a)](_0x3487fe(0x1ff),_0x50b36d),![]);}}return![];}function initSourceFolderList(){const _0x498c41=_0x21debd;let _0x2434ab=dbSourceFolderTable[_0x498c41(0x1ec)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x2ade1a of _0x2434ab){if(_0x2ade1a[_0x498c41(0x206)]!=0x1)continue;if(_0x2ade1a[_0x498c41(0x20e)]=='photo')photoSourceFolderList[_0x498c41(0x1d1)](_0x2ade1a);else{if(_0x2ade1a[_0x498c41(0x20e)]==_0x498c41(0x1dd))movieSourceFolderList[_0x498c41(0x1d1)](_0x2ade1a);else{if(_0x2ade1a[_0x498c41(0x20e)]==_0x498c41(0x1fa))musicSourceFolderList[_0x498c41(0x1d1)](_0x2ade1a);else _0x2ade1a[_0x498c41(0x20e)]==_0x498c41(0x1ed)&&bookSourceFolderList['push'](_0x2ade1a);}}let _0xf10834=!![];for(let _0x4940ca of finalWatchFolderList){let _0xb82c82=path[_0x498c41(0x1d0)](_0x4940ca[_0x498c41(0x210)]),_0x20e789=path[_0x498c41(0x1d0)](_0x2ade1a[_0x498c41(0x210)]);if(_0xb82c82==_0x20e789)_0xf10834=![];else{if(_0x20e789[_0x498c41(0x1e7)](_0xb82c82+path[_0x498c41(0x209)]))console[_0x498c41(0x20a)](_0x498c41(0x1fc),_0xb82c82),_0xf10834=![];else _0xb82c82[_0x498c41(0x1e7)](_0x20e789+path[_0x498c41(0x209)])&&(console[_0x498c41(0x20a)](_0x498c41(0x1f5),_0x20e789),finalWatchFolderList=finalWatchFolderList['filter'](_0x1add38=>_0x1add38[_0x498c41(0x210)]!=_0xb82c82));}}_0xf10834&&finalWatchFolderList[_0x498c41(0x1d1)](_0x2ade1a);}}async function closeAllWatcher(){const _0x1b9019=_0x21debd;for(let _0x536ac2=0x0;_0x536ac2<allWatcherList[_0x1b9019(0x1cb)];_0x536ac2++){try{allWatcherList[_0x536ac2][_0x1b9019(0x1f6)]&&await allWatcherList[_0x536ac2][_0x1b9019(0x1f6)]['stop']();}catch(_0x39c103){}}}function dealNewFilePromise(){return new Promise(async(_0x1de45b,_0x13b5b2)=>{const _0x52b4f3=_0x33dc;if(waitDealFileList[_0x52b4f3(0x1cb)]>0x0){let _0x3b95a7=waitDealFileList[0x0],_0x333590=![],_0x591817=![];return ifNeedDealChange(photoSourceFolderList,_0x3b95a7[_0x52b4f3(0x20b)])&&(console[_0x52b4f3(0x20a)](_0x52b4f3(0x201),_0x3b95a7[_0x52b4f3(0x20b)]),_0x333590=!![],await photoIndexUtil[_0x52b4f3(0x1f3)](dbFileIndex,dbOther,_0x3b95a7)),ifNeedDealChange(movieSourceFolderList,_0x3b95a7[_0x52b4f3(0x20b)])&&(console['log'](_0x52b4f3(0x20c),_0x3b95a7['fullPath']),_0x591817=!![],await movieIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x3b95a7)),ifNeedDealChange(musicSourceFolderList,_0x3b95a7[_0x52b4f3(0x20b)])&&(console[_0x52b4f3(0x20a)](_0x52b4f3(0x1f8),_0x3b95a7[_0x52b4f3(0x20b)]),await musicIndexUtil[_0x52b4f3(0x1f3)](dbFileIndex,dbOther,_0x3b95a7)),ifNeedDealChange(bookSourceFolderList,_0x3b95a7['fullPath'])&&(console[_0x52b4f3(0x20a)](_0x52b4f3(0x1cd),_0x3b95a7['fullPath']),await bookIndexUtil[_0x52b4f3(0x1f3)](dbFileIndex,dbOther,_0x3b95a7)),waitDealFileList[_0x52b4f3(0x1f7)](0x0,0x1),waitDealFileList[_0x52b4f3(0x1cb)]<0x1&&(_0x333590&&process[_0x52b4f3(0x1e9)]({'type':'NEW_PHOTO_INDEX'}),_0x591817&&(movieIndexUtil[_0x52b4f3(0x1f1)](dbFileIndex),process[_0x52b4f3(0x1e9)]({'type':'NEW_MOVIE_INDEX'}))),_0x1de45b();}else setTimeout(()=>{return _0x1de45b();},0x1388);});}function _0x38b9(){const _0x14dea0=['movie','9502407tCqIwi','589102Cmmfvh','../../utils/messageUtil','getById','newDirectory','dbOther','../../db/dbSourceFolderTable','isForbiddenPath','dirname','startsWith','photo','send','nsfw','.DS_Store','getAll','book','stack','closeWatcher','uncaughtException','dealTvDrama','newFile','dealFileChange','RENAMED','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','watcher','splice','音乐来源变动:','FileChangingWatchWorker','music','pragma','变动检测列表中已包含父目录','start','./movieIndexUtil','未开启变动自动处理\x20跳过','error','照片来源变动:','statSync','5558iwpRIs','../../db/dbFileIndexTable','2215122GzFgio','scan_when_change','246zDFzga','oldFile','sep','log','fullPath','电影来源变动:','63445cEsEOE','type','operate','path','checkPathIsInPrivateSpace','file','message','basename','exit','directory','delete','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','length','saveMsg','图书来源变动:','2437568vdIGSF','INDEX_TABLE_NAME_PHOTO','join','push','startScanPath','dbFileIndex','better-sqlite3','journal_mode\x20=\x20WAL','actions','108616SpSltO','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','Error\x20occurred\x20in\x20photo\x20watcher\x20process','./photoIndexUtil','./indexUtil','384KtQtRb'];_0x38b9=function(){return _0x14dea0;};return _0x38b9();}function _0x33dc(_0x5def69,_0x31d266){const _0x38b965=_0x38b9();return _0x33dc=function(_0x33dc7f,_0x259ccf){_0x33dc7f=_0x33dc7f-0x1c4;let _0x31d3e9=_0x38b965[_0x33dc7f];return _0x31d3e9;},_0x33dc(_0x5def69,_0x31d266);}function dealNewFileRun(){dealNewFilePromise()['then'](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x21debd(0x1f0),(_0x422451,_0x16fdbe)=>{const _0x3503be=_0x21debd;console[_0x3503be(0x20a)](_0x3503be(0x1d9),_0x422451),messageUtil[_0x3503be(0x1cc)](dbOther,_0x3503be(0x1ca),_0x3503be(0x200),_0x422451[_0x3503be(0x1ee)]||_0x422451['message']),closeAllWatcher(),process['send']({'type':'close'}),process[_0x3503be(0x1c7)]();});