const _0x59484d=_0x28f8;(function(_0x5ea930,_0x36d307){const _0x2b19a3=_0x28f8,_0x379cf5=_0x5ea930();while(!![]){try{const _0x2f7451=parseInt(_0x2b19a3(0x1ad))/0x1+-parseInt(_0x2b19a3(0x1b6))/0x2*(parseInt(_0x2b19a3(0x17a))/0x3)+parseInt(_0x2b19a3(0x192))/0x4+-parseInt(_0x2b19a3(0x19b))/0x5+-parseInt(_0x2b19a3(0x182))/0x6*(parseInt(_0x2b19a3(0x16f))/0x7)+-parseInt(_0x2b19a3(0x199))/0x8+parseInt(_0x2b19a3(0x17c))/0x9*(parseInt(_0x2b19a3(0x1a2))/0xa);if(_0x2f7451===_0x36d307)break;else _0x379cf5['push'](_0x379cf5['shift']());}catch(_0x4283cd){_0x379cf5['push'](_0x379cf5['shift']());}}}(_0x4eef,0x2a926));let fs=require('fs'),path=require(_0x59484d(0x1ab));const config=require('../../myConfig/config'),Database=require(_0x59484d(0x1a4));let dbOther=new Database(config[_0x59484d(0x1af)],{}),dbFileIndex=new Database(config[_0x59484d(0x18d)],{});dbFileIndex[_0x59484d(0x19c)]('journal_mode\x20=\x20WAL'),dbOther[_0x59484d(0x19c)](_0x59484d(0x1ac));const dbSourceFolderTable=require(_0x59484d(0x1a5)),dbFileIndexTable=require(_0x59484d(0x195));var nsfw=require('nsfw');let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x59484d(0x175));function _0x28f8(_0x1e9038,_0x30f33a){const _0x4eef42=_0x4eef();return _0x28f8=function(_0x28f878,_0x186042){_0x28f878=_0x28f878-0x169;let _0x568f4e=_0x4eef42[_0x28f878];return _0x568f4e;},_0x28f8(_0x1e9038,_0x30f33a);}const messageUtil=require('../../utils/messageUtil');process[_0x59484d(0x185)]=_0x59484d(0x170);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require(_0x59484d(0x171)),photoIndexUtil=require(_0x59484d(0x176)),movieIndexUtil=require(_0x59484d(0x17e));let allWatcherList=[],waitDealFileList=[];process['on'](_0x59484d(0x177),_0x1e4810=>{const _0x2a1ca2=_0x59484d;if(_0x1e4810[_0x2a1ca2(0x1a3)]==_0x2a1ca2(0x187))_0x1e4810['operate']!=_0x2a1ca2(0x1b1)&&(console['log'](_0x2a1ca2(0x1b2)),setSourceFolderWatcher());else _0x1e4810[_0x2a1ca2(0x1a3)]==_0x2a1ca2(0x173)&&closeAllWatcher();});async function dealFileChange(_0x2ce72f,_0x34b1d7){const _0x4c00ff=_0x59484d;if(!_0x2ce72f||!_0x34b1d7)return;if(indexUtil[_0x4c00ff(0x191)](dbOther,_0x34b1d7))return![];if(indexUtil[_0x4c00ff(0x1a7)](config,_0x34b1d7))return![];if(indexUtil[_0x4c00ff(0x1bc)](path[_0x4c00ff(0x180)](_0x34b1d7)))return![];for(let _0x1ad6e8=0x0;_0x1ad6e8<waitDealFileList[_0x4c00ff(0x19e)];_0x1ad6e8++){if(waitDealFileList[_0x1ad6e8][_0x4c00ff(0x198)]==_0x34b1d7)return![];}waitDealFileList[_0x4c00ff(0x19a)]({'watchPath':_0x2ce72f,'fullPath':_0x34b1d7,'filePath':path[_0x4c00ff(0x1ba)](_0x34b1d7),'fileName':path['basename'](_0x34b1d7)});}async function startOneWatcher(_0x49b18d){const _0x2f944f=_0x59484d;try{let _0x1341eb=fs[_0x2f944f(0x181)](_0x49b18d);if(!_0x1341eb['isDirectory']())return null;let _0x54302=await nsfw(_0x49b18d,function(_0x390540){const _0x5f35f2=_0x2f944f;for(let _0x225325 in _0x390540){let _0x58d2f6=_0x390540[_0x225325];if(_0x58d2f6[_0x5f35f2(0x19d)]=='.DS_Store')continue;if(_0x58d2f6[_0x5f35f2(0x1b5)]==nsfw[_0x5f35f2(0x16b)][_0x5f35f2(0x1a6)]){let _0x500ac8=path[_0x5f35f2(0x190)](_0x58d2f6[_0x5f35f2(0x1b4)],_0x58d2f6[_0x5f35f2(0x16e)]),_0x1f92d9=path[_0x5f35f2(0x190)](_0x58d2f6[_0x5f35f2(0x193)],_0x58d2f6['newFile']);dealFileChange(_0x49b18d,_0x500ac8),dealFileChange(_0x49b18d,_0x1f92d9);}else{let _0x4808b0=path['join'](_0x58d2f6[_0x5f35f2(0x1b4)],_0x58d2f6[_0x5f35f2(0x19d)]);dealFileChange(_0x49b18d,_0x4808b0);}}},{'errorCallback'(_0x56be62){}});return _0x54302[_0x2f944f(0x178)](),{'watcher':_0x54302,'watchPathState':_0x1341eb};}catch(_0x1d6c66){return console[_0x2f944f(0x1bb)](_0x2f944f(0x1b9),_0x49b18d),null;}}let isSettingWatcher=![];function _0x4eef(){const _0xf2d61b=['1590820dJsyZU','pragma','file','length','splice','book','INDEX_TABLE_NAME_PHOTO','10ILUedq','type','better-sqlite3','../../db/dbSourceFolderTable','RENAMED','isForbiddenPath','startsWith','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','getAll','path','journal_mode\x20=\x20WAL','271201gwNbkj','exit','dbOther','dealTvDrama','delete','重设文件变动检测','movie','directory','action','125202UrsqFN','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','dealFileChange','The\x20source\x20folder\x20no\x20exists\x20:\x20','dirname','log','isForbiddenFilename','photo','电影来源变动:','actions','send','saveMsg','oldFile','56602ncmGgc','FileChangingWatchWorker','./musicIndexUtil','close','closeWatcher','error','./indexUtil','./photoIndexUtil','message','start','变动检测列表中已包含父目录','6RriAYU','filter','6651963ApeHwa','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','./movieIndexUtil','getById','basename','statSync','228BWtCgA','stop','scan_when_change','title','音乐来源变动:','startScanPath','sep','图书来源变动:','stack','watcher','NEW_PHOTO_INDEX','dbFileIndex','未开启变动自动处理\x20跳过','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','join','checkPathIsInPrivateSpace','141988bAqGhZ','newDirectory','NEW_MOVIE_INDEX','../../db/dbFileIndexTable','uncaughtException','music','fullPath','966376MlWwUn','push'];_0x4eef=function(){return _0xf2d61b;};return _0x4eef();}async function setSourceFolderWatcher(){const _0x10583c=_0x59484d;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x55b4f1(){const _0xab32f8=_0x28f8;let _0x1705a1=[];for(let _0x32bbf8=0x0;_0x32bbf8<finalWatchFolderList[_0xab32f8(0x19e)];_0x32bbf8++){let _0x3ece5b=finalWatchFolderList[_0x32bbf8][_0xab32f8(0x1ab)];try{let _0x4f7e8f=await startOneWatcher(_0x3ece5b);_0x4f7e8f?(console[_0xab32f8(0x1bb)](_0xab32f8(0x18f),_0x3ece5b),_0x1705a1[_0xab32f8(0x19a)]({'path':_0x3ece5b,'watcher':_0x4f7e8f[_0xab32f8(0x18b)]})):(console['log'](_0xab32f8(0x1b7),_0x3ece5b),_0x1705a1[_0xab32f8(0x19a)]({'path':_0x3ece5b,'watcher':null,'stop':0x1}));}catch(_0x366e93){console['log'](_0x366e93);}}return _0x1705a1;}let _0x56ed3d=[];for(let _0x2b118c in finalWatchFolderList){_0x56ed3d['push'](finalWatchFolderList[_0x2b118c][_0x10583c(0x1ab)]);}closeAllWatcher(),allWatcherList=await _0x55b4f1(_0x56ed3d,dbFileIndexTable[_0x10583c(0x1a1)],'photo'),isSettingWatcher=![];}function ifNeedDealChange(_0x5e501f,_0x394d23){const _0x10d95f=_0x59484d;for(let _0x7f332f in _0x5e501f){let _0xa2771a=_0x5e501f[_0x7f332f];if(_0x394d23[_0x10d95f(0x1a8)](_0xa2771a[_0x10d95f(0x1ab)]+path[_0x10d95f(0x188)])||_0x394d23==_0xa2771a[_0x10d95f(0x1ab)]){let _0x25c87d=dbSourceFolderTable[_0x10d95f(0x17f)](dbOther,_0xa2771a['id']);return _0x5e501f[_0x7f332f]=_0x25c87d,_0x25c87d||_0x25c87d[_0x10d95f(0x184)]==0x1?!![]:(console[_0x10d95f(0x1bb)](_0x10d95f(0x18e),_0x394d23),![]);}}return![];}function initSourceFolderList(){const _0xa04a4c=_0x59484d;let _0x8d0e=dbSourceFolderTable[_0xa04a4c(0x1aa)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x56f145 of _0x8d0e){if(_0x56f145[_0xa04a4c(0x184)]!=0x1)continue;if(_0x56f145[_0xa04a4c(0x1a3)]==_0xa04a4c(0x169))photoSourceFolderList[_0xa04a4c(0x19a)](_0x56f145);else{if(_0x56f145['type']==_0xa04a4c(0x1b3))movieSourceFolderList['push'](_0x56f145);else{if(_0x56f145[_0xa04a4c(0x1a3)]==_0xa04a4c(0x197))musicSourceFolderList[_0xa04a4c(0x19a)](_0x56f145);else _0x56f145[_0xa04a4c(0x1a3)]==_0xa04a4c(0x1a0)&&bookSourceFolderList['push'](_0x56f145);}}let _0x51733c=!![];for(let _0x1ae397 of finalWatchFolderList){let _0x298b5f=path[_0xa04a4c(0x190)](_0x1ae397[_0xa04a4c(0x1ab)]),_0x40462f=path[_0xa04a4c(0x190)](_0x56f145[_0xa04a4c(0x1ab)]);if(_0x298b5f==_0x40462f)_0x51733c=![];else{if(_0x40462f[_0xa04a4c(0x1a8)](_0x298b5f+path[_0xa04a4c(0x188)]))console['log'](_0xa04a4c(0x179),_0x298b5f),_0x51733c=![];else _0x298b5f['startsWith'](_0x40462f+path['sep'])&&(console[_0xa04a4c(0x1bb)](_0xa04a4c(0x1a9),_0x40462f),finalWatchFolderList=finalWatchFolderList[_0xa04a4c(0x17b)](_0x29c19b=>_0x29c19b[_0xa04a4c(0x1ab)]!=_0x298b5f));}}_0x51733c&&finalWatchFolderList[_0xa04a4c(0x19a)](_0x56f145);}}async function closeAllWatcher(){const _0x1305c0=_0x59484d;for(let _0x30b3b1=0x0;_0x30b3b1<allWatcherList[_0x1305c0(0x19e)];_0x30b3b1++){try{allWatcherList[_0x30b3b1]['watcher']&&await allWatcherList[_0x30b3b1]['watcher'][_0x1305c0(0x183)]();}catch(_0xe76d40){}}}function dealNewFilePromise(){return new Promise(async(_0x379c30,_0x12d478)=>{const _0x5840ed=_0x28f8;if(waitDealFileList[_0x5840ed(0x19e)]>0x0){let _0x474f38=waitDealFileList[0x0],_0x30fd6f=![],_0x4583c0=![];return ifNeedDealChange(photoSourceFolderList,_0x474f38[_0x5840ed(0x198)])&&(console['log']('照片来源变动:',_0x474f38[_0x5840ed(0x198)]),_0x30fd6f=!![],await photoIndexUtil[_0x5840ed(0x1b8)](dbFileIndex,dbOther,_0x474f38)),ifNeedDealChange(movieSourceFolderList,_0x474f38[_0x5840ed(0x198)])&&(console[_0x5840ed(0x1bb)](_0x5840ed(0x16a),_0x474f38['fullPath']),_0x4583c0=!![],await movieIndexUtil[_0x5840ed(0x1b8)](dbFileIndex,dbOther,_0x474f38)),ifNeedDealChange(musicSourceFolderList,_0x474f38[_0x5840ed(0x198)])&&(console[_0x5840ed(0x1bb)](_0x5840ed(0x186),_0x474f38[_0x5840ed(0x198)]),await musicIndexUtil[_0x5840ed(0x1b8)](dbFileIndex,dbOther,_0x474f38)),ifNeedDealChange(bookSourceFolderList,_0x474f38[_0x5840ed(0x198)])&&(console[_0x5840ed(0x1bb)](_0x5840ed(0x189),_0x474f38[_0x5840ed(0x198)]),await bookIndexUtil[_0x5840ed(0x1b8)](dbFileIndex,dbOther,_0x474f38)),waitDealFileList[_0x5840ed(0x19f)](0x0,0x1),waitDealFileList[_0x5840ed(0x19e)]<0x1&&(_0x30fd6f&&process[_0x5840ed(0x16c)]({'type':_0x5840ed(0x18c)}),_0x4583c0&&(movieIndexUtil[_0x5840ed(0x1b0)](dbFileIndex),process[_0x5840ed(0x16c)]({'type':_0x5840ed(0x194)}))),_0x379c30();}else setTimeout(()=>{return _0x379c30();},0x1388);});}function dealNewFileRun(){dealNewFilePromise()['then'](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x59484d(0x196),(_0x39375d,_0x4239be)=>{const _0x533f8d=_0x59484d;console[_0x533f8d(0x1bb)]('Error\x20occurred\x20in\x20photo\x20watcher\x20process',_0x39375d),messageUtil[_0x533f8d(0x16d)](dbOther,_0x533f8d(0x17d),_0x533f8d(0x174),_0x39375d[_0x533f8d(0x18a)]||_0x39375d['message']),closeAllWatcher(),process[_0x533f8d(0x16c)]({'type':_0x533f8d(0x172)}),process[_0x533f8d(0x1ae)]();});