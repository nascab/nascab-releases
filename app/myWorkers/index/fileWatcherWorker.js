const _0x9aeb1=_0x2a2d;(function(_0x2f08aa,_0x330f07){const _0x3887a2=_0x2a2d,_0x22556e=_0x2f08aa();while(!![]){try{const _0x545932=-parseInt(_0x3887a2(0x135))/0x1*(parseInt(_0x3887a2(0x12a))/0x2)+-parseInt(_0x3887a2(0x136))/0x3*(parseInt(_0x3887a2(0x15c))/0x4)+parseInt(_0x3887a2(0x151))/0x5*(-parseInt(_0x3887a2(0x129))/0x6)+parseInt(_0x3887a2(0x13d))/0x7*(parseInt(_0x3887a2(0x148))/0x8)+parseInt(_0x3887a2(0x12c))/0x9+parseInt(_0x3887a2(0x160))/0xa*(-parseInt(_0x3887a2(0x14d))/0xb)+parseInt(_0x3887a2(0x13f))/0xc;if(_0x545932===_0x330f07)break;else _0x22556e['push'](_0x22556e['shift']());}catch(_0x339251){_0x22556e['push'](_0x22556e['shift']());}}}(_0x3e4b,0xb1014));let fs=require('fs'),path=require(_0x9aeb1(0x15e));const config=require(_0x9aeb1(0x150)),Database=require(_0x9aeb1(0x175));let dbOther=new Database(config[_0x9aeb1(0x168)],{}),dbFileIndex=new Database(config[_0x9aeb1(0x14e)],{});dbFileIndex[_0x9aeb1(0x170)](_0x9aeb1(0x164)),dbOther[_0x9aeb1(0x170)](_0x9aeb1(0x164));const dbSourceFolderTable=require('../../db/dbSourceFolderTable'),dbFileIndexTable=require(_0x9aeb1(0x172));var nsfw=require(_0x9aeb1(0x15d));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x9aeb1(0x125));const messageUtil=require('../../utils/messageUtil');process[_0x9aeb1(0x144)]=_0x9aeb1(0x162);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require(_0x9aeb1(0x165)),photoIndexUtil=require(_0x9aeb1(0x174)),movieIndexUtil=require(_0x9aeb1(0x12b));let allWatcherList=[],waitDealFileList=[];process['on'](_0x9aeb1(0x13c),_0x215145=>{const _0x1cb223=_0x9aeb1;if(_0x215145[_0x1cb223(0x16e)]=='startScanPath')_0x215145[_0x1cb223(0x157)]!=_0x1cb223(0x138)&&(console[_0x1cb223(0x16b)](_0x1cb223(0x141)),setSourceFolderWatcher());else _0x215145[_0x1cb223(0x16e)]==_0x1cb223(0x131)&&closeAllWatcher();});async function dealFileChange(_0x336000,_0x5d27c4){const _0x1589a3=_0x9aeb1;if(!_0x336000||!_0x5d27c4)return;if(indexUtil[_0x1589a3(0x15a)](dbOther,_0x5d27c4))return![];if(indexUtil[_0x1589a3(0x159)](config,_0x5d27c4))return![];if(indexUtil['isForbiddenFilename'](path[_0x1589a3(0x16d)](_0x5d27c4)))return![];for(let _0x55fad1=0x0;_0x55fad1<waitDealFileList[_0x1589a3(0x13a)];_0x55fad1++){if(waitDealFileList[_0x55fad1]['fullPath']==_0x5d27c4)return![];}waitDealFileList['push']({'watchPath':_0x336000,'fullPath':_0x5d27c4,'filePath':path[_0x1589a3(0x166)](_0x5d27c4),'fileName':path[_0x1589a3(0x16d)](_0x5d27c4)});}async function startOneWatcher(_0x1535b1){const _0x3c1184=_0x9aeb1;try{let _0x27a32b=fs[_0x3c1184(0x146)](_0x1535b1);if(!_0x27a32b[_0x3c1184(0x145)]())return null;let _0x1b49fc=await nsfw(_0x1535b1,function(_0x23be9e){const _0x5eb991=_0x3c1184;for(let _0x5d6a59 in _0x23be9e){let _0x31879c=_0x23be9e[_0x5d6a59];if(_0x31879c[_0x5eb991(0x158)]==_0x5eb991(0x156))continue;if(_0x31879c[_0x5eb991(0x127)]==nsfw[_0x5eb991(0x126)][_0x5eb991(0x169)]){let _0x475c67=path[_0x5eb991(0x14c)](_0x31879c[_0x5eb991(0x14f)],_0x31879c['oldFile']),_0x4888a1=path[_0x5eb991(0x14c)](_0x31879c[_0x5eb991(0x16f)],_0x31879c[_0x5eb991(0x16c)]);dealFileChange(_0x1535b1,_0x475c67),dealFileChange(_0x1535b1,_0x4888a1);}else{let _0x3f4690=path[_0x5eb991(0x14c)](_0x31879c[_0x5eb991(0x14f)],_0x31879c[_0x5eb991(0x158)]);dealFileChange(_0x1535b1,_0x3f4690);}}},{'errorCallback'(_0x4520ac){}});return _0x1b49fc[_0x3c1184(0x132)](),{'watcher':_0x1b49fc,'watchPathState':_0x27a32b};}catch(_0x4d6456){return console['log']('The\x20source\x20folder\x20no\x20exists\x20:\x20',_0x1535b1),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0xead4a5=_0x9aeb1;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0xe52b34(){const _0x522f1b=_0x2a2d;let _0x29b950=[];for(let _0x242c11=0x0;_0x242c11<finalWatchFolderList[_0x522f1b(0x13a)];_0x242c11++){let _0x2c02d3=finalWatchFolderList[_0x242c11][_0x522f1b(0x15e)];try{let _0x50af53=await startOneWatcher(_0x2c02d3);_0x50af53?(console[_0x522f1b(0x16b)]('文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success',_0x2c02d3),_0x29b950[_0x522f1b(0x133)]({'path':_0x2c02d3,'watcher':_0x50af53[_0x522f1b(0x147)]})):(console['log'](_0x522f1b(0x124),_0x2c02d3),_0x29b950[_0x522f1b(0x133)]({'path':_0x2c02d3,'watcher':null,'stop':0x1}));}catch(_0x36daae){console[_0x522f1b(0x16b)](_0x36daae);}}return _0x29b950;}let _0x4710fc=[];for(let _0x55b65c in finalWatchFolderList){_0x4710fc[_0xead4a5(0x133)](finalWatchFolderList[_0x55b65c][_0xead4a5(0x15e)]);}closeAllWatcher(),allWatcherList=await _0xe52b34(_0x4710fc,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],_0xead4a5(0x163)),isSettingWatcher=![];}function ifNeedDealChange(_0x1c93a2,_0x59bce9){const _0x3b3d9f=_0x9aeb1;for(let _0x59f340 in _0x1c93a2){let _0x43fa73=_0x1c93a2[_0x59f340];if(_0x43fa73){if(_0x59bce9[_0x3b3d9f(0x152)](_0x43fa73[_0x3b3d9f(0x15e)]+path['sep'])||_0x59bce9==_0x43fa73[_0x3b3d9f(0x15e)]){let _0x435e43=dbSourceFolderTable[_0x3b3d9f(0x14b)](dbOther,_0x43fa73['id']);return _0x1c93a2[_0x59f340]=_0x435e43,_0x435e43||_0x435e43&&_0x435e43[_0x3b3d9f(0x12e)]==0x1?!![]:(console['log'](_0x3b3d9f(0x140),_0x59bce9),![]);}}}return![];}function initSourceFolderList(){const _0x4c0aed=_0x9aeb1;let _0x1df748=dbSourceFolderTable[_0x4c0aed(0x139)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x3c520e of _0x1df748){if(_0x3c520e[_0x4c0aed(0x12e)]!=0x1)continue;if(_0x3c520e['type']==_0x4c0aed(0x163))photoSourceFolderList['push'](_0x3c520e);else{if(_0x3c520e['type']==_0x4c0aed(0x12f))movieSourceFolderList['push'](_0x3c520e);else{if(_0x3c520e['type']=='music')musicSourceFolderList[_0x4c0aed(0x133)](_0x3c520e);else _0x3c520e[_0x4c0aed(0x16e)]=='book'&&bookSourceFolderList['push'](_0x3c520e);}}let _0x358224=!![];for(let _0x36a341 of finalWatchFolderList){let _0x409b61=path['join'](_0x36a341[_0x4c0aed(0x15e)]),_0x4ac2c6=path[_0x4c0aed(0x14c)](_0x3c520e['path']);if(_0x409b61==_0x4ac2c6)_0x358224=![];else{if(_0x4ac2c6[_0x4c0aed(0x152)](_0x409b61+path['sep']))console[_0x4c0aed(0x16b)]('变动检测列表中已包含父目录',_0x409b61),_0x358224=![];else _0x409b61[_0x4c0aed(0x152)](_0x4ac2c6+path['sep'])&&(console[_0x4c0aed(0x16b)](_0x4c0aed(0x14a),_0x4ac2c6),finalWatchFolderList=finalWatchFolderList[_0x4c0aed(0x149)](_0x56c2a2=>_0x56c2a2[_0x4c0aed(0x15e)]!=_0x409b61));}}_0x358224&&finalWatchFolderList[_0x4c0aed(0x133)](_0x3c520e);}}async function closeAllWatcher(){const _0x21e926=_0x9aeb1;for(let _0x266dca=0x0;_0x266dca<allWatcherList[_0x21e926(0x13a)];_0x266dca++){try{allWatcherList[_0x266dca][_0x21e926(0x147)]&&await allWatcherList[_0x266dca][_0x21e926(0x147)][_0x21e926(0x13e)]();}catch(_0x1f35cc){}}}function _0x2a2d(_0x2783a1,_0x5bd3d7){const _0x3e4b15=_0x3e4b();return _0x2a2d=function(_0x2a2d3e,_0x13d01){_0x2a2d3e=_0x2a2d3e-0x124;let _0x4f6096=_0x3e4b15[_0x2a2d3e];return _0x4f6096;},_0x2a2d(_0x2783a1,_0x5bd3d7);}function _0x3e4b(){const _0x3c42d6=['dealFileChange','./photoIndexUtil','better-sqlite3','close','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','./indexUtil','actions','action','saveMsg','38418CiCmpr','395614gcXkjw','./movieIndexUtil','2804688iYyeOW','NEW_PHOTO_INDEX','scan_when_change','movie','音乐来源变动:','closeWatcher','start','push','dealTvDrama','4kZbrLN','1604991AINaEf','send','delete','getAll','length','splice','message','56NpiXli','stop','37635216uYKQwG','未开启变动自动处理\x20跳过','重设文件变动检测','uncaughtException','stack','title','isDirectory','statSync','watcher','132472UIyvJP','filter','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','getById','join','3621695ZmfmNp','dbFileIndex','directory','../../myConfig/config','5XtYvag','startsWith','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','Error\x20occurred\x20in\x20photo\x20watcher\x20process','图书来源变动:','.DS_Store','operate','file','isForbiddenPath','checkPathIsInPrivateSpace','then','8vKzWaZ','nsfw','path','error','30qrhHrN','NEW_MOVIE_INDEX','FileChangingWatchWorker','photo','journal_mode\x20=\x20WAL','./musicIndexUtil','dirname','照片来源变动:','dbOther','RENAMED','exit','log','newFile','basename','type','newDirectory','pragma','fullPath','../../db/dbFileIndexTable'];_0x3e4b=function(){return _0x3c42d6;};return _0x3e4b();}function dealNewFilePromise(){return new Promise(async(_0x49f3d8,_0xe6fdf7)=>{const _0x39e85e=_0x2a2d;if(waitDealFileList[_0x39e85e(0x13a)]>0x0){let _0xef79ec=waitDealFileList[0x0],_0x28f59d=![],_0x30576e=![];return ifNeedDealChange(photoSourceFolderList,_0xef79ec['fullPath'])&&(console['log'](_0x39e85e(0x167),_0xef79ec[_0x39e85e(0x171)]),_0x28f59d=!![],await photoIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0xef79ec)),ifNeedDealChange(movieSourceFolderList,_0xef79ec[_0x39e85e(0x171)])&&(console['log']('电影来源变动:',_0xef79ec['fullPath']),_0x30576e=!![],await movieIndexUtil[_0x39e85e(0x173)](dbFileIndex,dbOther,_0xef79ec)),ifNeedDealChange(musicSourceFolderList,_0xef79ec[_0x39e85e(0x171)])&&(console[_0x39e85e(0x16b)](_0x39e85e(0x130),_0xef79ec[_0x39e85e(0x171)]),await musicIndexUtil[_0x39e85e(0x173)](dbFileIndex,dbOther,_0xef79ec)),ifNeedDealChange(bookSourceFolderList,_0xef79ec[_0x39e85e(0x171)])&&(console[_0x39e85e(0x16b)](_0x39e85e(0x155),_0xef79ec[_0x39e85e(0x171)]),await bookIndexUtil[_0x39e85e(0x173)](dbFileIndex,dbOther,_0xef79ec)),waitDealFileList[_0x39e85e(0x13b)](0x0,0x1),waitDealFileList[_0x39e85e(0x13a)]<0x1&&(_0x28f59d&&process[_0x39e85e(0x137)]({'type':_0x39e85e(0x12d)}),_0x30576e&&(movieIndexUtil[_0x39e85e(0x134)](dbFileIndex),process[_0x39e85e(0x137)]({'type':_0x39e85e(0x161)}))),_0x49f3d8();}else setTimeout(()=>{return _0x49f3d8();},0x1388);});}function dealNewFileRun(){const _0x5e3c4c=_0x9aeb1;dealNewFilePromise()[_0x5e3c4c(0x15b)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x9aeb1(0x142),(_0x12bedf,_0x575699)=>{const _0xb62c9e=_0x9aeb1;console['log'](_0xb62c9e(0x154),_0x12bedf),messageUtil[_0xb62c9e(0x128)](dbOther,_0xb62c9e(0x153),_0xb62c9e(0x15f),_0x12bedf[_0xb62c9e(0x143)]||_0x12bedf[_0xb62c9e(0x13c)]),closeAllWatcher(),process[_0xb62c9e(0x137)]({'type':_0xb62c9e(0x176)}),process[_0xb62c9e(0x16a)]();});