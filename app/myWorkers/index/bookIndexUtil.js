const _0x5ac2f6=_0xcc64;function _0xcc64(_0x3e90ef,_0x3e8e44){const _0x58709=_0x5870();return _0xcc64=function(_0xcc6479,_0x437394){_0xcc6479=_0xcc6479-0x14f;let _0x5b8341=_0x58709[_0xcc6479];return _0x5b8341;},_0xcc64(_0x3e90ef,_0x3e8e44);}(function(_0x43097d,_0x342cbe){const _0x5a5f86=_0xcc64,_0x3d4c19=_0x43097d();while(!![]){try{const _0xbae809=-parseInt(_0x5a5f86(0x1a9))/0x1+parseInt(_0x5a5f86(0x174))/0x2*(-parseInt(_0x5a5f86(0x186))/0x3)+parseInt(_0x5a5f86(0x166))/0x4+-parseInt(_0x5a5f86(0x1a5))/0x5+parseInt(_0x5a5f86(0x16d))/0x6+parseInt(_0x5a5f86(0x154))/0x7+-parseInt(_0x5a5f86(0x17e))/0x8;if(_0xbae809===_0x342cbe)break;else _0x3d4c19['push'](_0x3d4c19['shift']());}catch(_0x51329c){_0x3d4c19['push'](_0x3d4c19['shift']());}}}(_0x5870,0xb8c28));const path=require(_0x5ac2f6(0x184)),fs=require('fs');let pinyin=require('node-pinyin');const sharp=require('sharp'),{Worker}=require('worker_threads');function _0x5870(){const _0x5c5816=['dealFirstLetterSingle','ceil','runGetBookInfoWorker','toBuffer','getDate','terminate','dealBookInfo','coverData','err\x205','message','ctimeMs','birthtime','birthtimeMs','dealFirstLetterAll','UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20','../../db/dbSourceFolderTable','getMediaCoverCachePath','book','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','all','1110375KilVmi','getById','writeFile','getBookType','149556NsbShF','getFullYear','catch','initials','total_page','ctime','8837381MHzDGA','log','Nan','getTime','mtimeMs','sharpWriteCover','extname','SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null','is_file','then','filename','Worker\x20error:','.zip','./indexUtil','处理成功','prepare','code','run','4761708eNSsCS','dealFileChange','resolve','type','length','size','artist','7930842xVBiOO','addFileIndexToDb','title','ext','Null','indexObj','lastInsertRowid','463330hSqVrS','.rar','jpeg','atimeMs','doesPathCanAddToDb','addOriginalDate','../../utils/nfoUtil','error','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','.cbr','11903880WFYlzn','exit','test','recursionFilesAddIndex','err1','coverPath','path','NaN','15XTCcBH','toLowerCase','exports','../../db/dbFileIndexTable','INDEX_TABLE_NAME_BOOK','exifMinTimeStamp','Worker\x20stopped\x20with\x20exit\x20code:','restoreBookNfo','toUpperCase','includes','resize'];_0x5870=function(){return _0x5c5816;};return _0x5870();}let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require(_0x5ac2f6(0x1a0)),dbFileIndexTable=require(_0x5ac2f6(0x189)),dbConfigTable=require('../../db/dbConfigTable'),config=require('../../myConfig/config'),indexUtil=require(_0x5ac2f6(0x161)),nfoUtil=require(_0x5ac2f6(0x17a)),indexTableName=dbFileIndexTable[_0x5ac2f6(0x18a)],bookIndexUtil={};bookIndexUtil[_0x5ac2f6(0x159)]=async function(_0x321c65,_0x57f76c){return new Promise((_0x1edd2c,_0x7ffd12)=>{const _0x22c716=_0xcc64;sharp(_0x321c65,{'failOnError':![]})[_0x22c716(0x176)]({'quality':0x4d})[_0x22c716(0x190)]({'width':0x1f4})[_0x22c716(0x194)]()[_0x22c716(0x15d)](_0x20ad67=>{const _0x4dbf10=_0x22c716;fs[_0x4dbf10(0x1a7)](_0x57f76c,_0x20ad67,_0x25ddc6=>{if(_0x25ddc6)return _0x7ffd12();return _0x1edd2c(_0x57f76c);});})[_0x22c716(0x150)](_0x4dd55a=>{const _0x5854c7=_0x22c716;return console[_0x5854c7(0x155)](_0x5854c7(0x182),_0x4dd55a),_0x7ffd12();});});},bookIndexUtil['runGetBookInfoWorker']=function(_0x387099,_0x56f554,_0x575464=![]){return new Promise((_0xc274f5,_0x5940ee)=>{const _0x9723bf=_0xcc64;let _0x1855e3=new Worker(path[_0x9723bf(0x168)](__dirname,'bookInfoWorker.js'),{'workerData':{'indexObj':_0x387099,'bookCoverCachePath':_0x56f554,'onlyGenCover':_0x575464}}),_0x1f27a1=setTimeout(()=>{_0x1855e3&&(console['log']('已超时\x20结束处理worker'),_0x1855e3['terminate'](),_0x1855e3=null,_0x5940ee());},0x7530);_0x1855e3['on'](_0x9723bf(0x19a),_0x4aee50=>{const _0x36119c=_0x9723bf;_0x4aee50[_0x36119c(0x164)]==0x0&&(_0x1f27a1&&clearTimeout(_0x1f27a1),_0xc274f5(_0x4aee50));}),_0x1855e3['on'](_0x9723bf(0x17b),_0x596130=>{const _0x476d2a=_0x9723bf;console[_0x476d2a(0x17b)](_0x476d2a(0x15f),_0x596130),_0x1855e3&&(_0x1855e3[_0x476d2a(0x196)](),_0x1855e3=null),_0x5940ee();}),_0x1855e3['on'](_0x9723bf(0x17f),_0x32ceed=>{const _0x559fcc=_0x9723bf;if(_0x32ceed!==0x0)console['error'](_0x559fcc(0x18c),_0x32ceed);else{}});});},bookIndexUtil['dealBookInfo']=async function(_0x19c232,_0x5da5f1){const _0x4c812e=_0x5ac2f6;let _0xc921d=![];if(_0x5da5f1['is_file']==0x1&&_0x5da5f1[_0x4c812e(0x170)]&&config['bookTypeList'][_0x4c812e(0x18f)](_0x5da5f1['ext'][_0x4c812e(0x187)]())){!_0x5da5f1[_0x4c812e(0x169)]&&(_0x5da5f1[_0x4c812e(0x169)]=bookIndexUtil[_0x4c812e(0x1a8)](_0x5da5f1));let _0x27224c=config[_0x4c812e(0x1a1)](_0x5da5f1);try{let _0x385fde=await bookIndexUtil[_0x4c812e(0x193)](_0x5da5f1,_0x27224c);if(_0x385fde['coverData'])try{let _0x39de25=await bookIndexUtil[_0x4c812e(0x159)](_0x385fde[_0x4c812e(0x198)],_0x27224c);_0x39de25&&(console[_0x4c812e(0x155)]('封面写入成功',_0x39de25),_0x385fde[_0x4c812e(0x172)][_0x4c812e(0x183)]=_0x39de25);}catch(_0x14b136){console[_0x4c812e(0x155)](_0x14b136);}return console[_0x4c812e(0x155)](_0x4c812e(0x162),_0x385fde[_0x4c812e(0x172)][_0x4c812e(0x15e)],_0x385fde[_0x4c812e(0x172)][_0x4c812e(0x152)]),bookIndexUtil[_0x4c812e(0x179)](_0x19c232,_0x385fde['originalTime'],_0x385fde['indexObj']);}catch(_0x145a26){return console[_0x4c812e(0x155)](_0x4c812e(0x199),_0x145a26),bookIndexUtil[_0x4c812e(0x179)](_0x19c232,_0xc921d,_0x5da5f1);}}else{if(_0x5da5f1[_0x4c812e(0x15c)]==0x1)return;return bookIndexUtil[_0x4c812e(0x179)](_0x19c232,_0xc921d,_0x5da5f1);}},bookIndexUtil[_0x5ac2f6(0x1a8)]=function(_0xa2a1d0){const _0x333e8e=_0x5ac2f6;let _0x3e60b3=['.cbz',_0x333e8e(0x17d),_0x333e8e(0x175),_0x333e8e(0x160)];return _0xa2a1d0[_0x333e8e(0x170)]&&_0x3e60b3[_0x333e8e(0x18f)](_0xa2a1d0[_0x333e8e(0x170)][_0x333e8e(0x187)]())?0x2:0x1;},bookIndexUtil['setAllBookType']=function(_0xf6164a){const _0x805d60=_0x5ac2f6;let _0x185f4c=_0x805d60(0x1a3),_0x2e4afe=_0x805d60(0x19f)+_0x185f4c;_0xf6164a[_0x805d60(0x163)](_0x2e4afe)[_0x805d60(0x165)](),_0x2e4afe='UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20'+_0x185f4c,_0xf6164a[_0x805d60(0x163)](_0x2e4afe)[_0x805d60(0x165)]();},bookIndexUtil[_0x5ac2f6(0x181)]=async function(_0x3c0bc1,_0x1370a2,_0x41cdb9){const _0x15b293=_0x5ac2f6;return await indexUtil[_0x15b293(0x181)](_0x3c0bc1,_0x1370a2,indexTableName,'book',_0x41cdb9,bookIndexUtil[_0x15b293(0x16e)]);},bookIndexUtil[_0x5ac2f6(0x16e)]=async function(_0x5cd4e7,_0x451f31,_0x78d185,_0x15585d,_0x552d27,_0x1a66ca){const _0x5ed45d=_0x5ac2f6;let _0x4274cf=indexUtil[_0x5ed45d(0x178)](_0x5cd4e7,_0x5ed45d(0x1a2),config,_0x78d185,_0x15585d);if(!_0x4274cf)return;let _0x5abf5e=_0x1a66ca[_0x5ed45d(0x19d)];_0x1a66ca[_0x5ed45d(0x158)]<_0x5abf5e&&(_0x5abf5e=_0x1a66ca[_0x5ed45d(0x158)]);_0x1a66ca[_0x5ed45d(0x177)]<_0x5abf5e&&(_0x5abf5e=_0x1a66ca[_0x5ed45d(0x177)]);_0x1a66ca[_0x5ed45d(0x19b)]<_0x5abf5e&&(_0x5abf5e=_0x1a66ca['ctimeMs']);let _0x304aec={'path':_0x78d185,'filename':_0x15585d,'is_file':_0x552d27,'ctime':_0x1a66ca['ctimeMs'],'mtime':_0x1a66ca[_0x5ed45d(0x158)],'ext':path[_0x5ed45d(0x15a)](_0x15585d),'birthtime':Math[_0x5ed45d(0x192)](_0x5abf5e),'size':_0x1a66ca[_0x5ed45d(0x16b)],'check_time':new Date()[_0x5ed45d(0x157)]()};_0x304aec=await bookIndexUtil[_0x5ed45d(0x197)](_0x451f31,_0x304aec);},bookIndexUtil[_0x5ac2f6(0x167)]=async function(_0x462a4b,_0x3c3f01,_0x5a4b64){const _0x44b2ca=_0x5ac2f6;await indexUtil[_0x44b2ca(0x167)](_0x462a4b,_0x3c3f01,_0x5a4b64,indexTableName,bookIndexUtil['addFileIndexToDb'],bookIndexUtil['recursionFilesAddIndex']);return;},bookIndexUtil['addOriginalDate']=function(_0x4572cf,_0xcc32b5,_0x1c4fd2){const _0xa509dd=_0x5ac2f6;nfoUtil[_0xa509dd(0x18d)](_0x1c4fd2)[_0xa509dd(0x15d)](_0x493af6=>{_0x25539f(_0x493af6);})[_0xa509dd(0x150)](_0x291012=>{_0x25539f(_0x1c4fd2);});function _0x25539f(_0x8e702f){const _0x2339f9=_0xa509dd;_0xcc32b5&&_0xcc32b5<config[_0x2339f9(0x18b)]&&(_0xcc32b5=![]);(!_0xcc32b5||_0xcc32b5==_0x2339f9(0x185)||_0xcc32b5==_0x2339f9(0x156)||_0xcc32b5==_0x2339f9(0x185)||_0xcc32b5==_0x2339f9(0x171))&&(_0xcc32b5=_0x8e702f[_0x2339f9(0x19c)]||_0x8e702f[_0x2339f9(0x153)]);let _0x4a2fde=new Date(_0xcc32b5);_0x8e702f['original_time']=_0x4a2fde[_0x2339f9(0x157)]();let _0x1b43d7=_0x4a2fde[_0x2339f9(0x14f)](),_0x3c24b2=_0x4a2fde['getMonth']()+0x1;_0x3c24b2=_0x3c24b2>=0xa?_0x3c24b2:'0'+_0x3c24b2;let _0x1b7efd=_0x4a2fde[_0x2339f9(0x195)]();_0x1b7efd=_0x1b7efd>=0xa?_0x1b7efd:'0'+_0x1b7efd,_0x8e702f['original_date']=_0x1b43d7+'-'+_0x3c24b2+'-'+_0x1b7efd;let _0x11e870=dbFileIndexTable['create'](_0x4572cf,_0x8e702f,indexTableName);if(_0x11e870&&_0x11e870[_0x2339f9(0x173)]){let _0xe371ac=dbFileIndexTable[_0x2339f9(0x1a6)](_0x4572cf,_0x11e870[_0x2339f9(0x173)],dbFileIndexTable[_0x2339f9(0x18a)]);_0xe371ac&&bookIndexUtil[_0x2339f9(0x191)](_0x4572cf,_0xe371ac);}}},bookIndexUtil[_0x5ac2f6(0x19e)]=function(_0x470c68){const _0x1b9202=_0x5ac2f6;let _0x1a9306=_0x1b9202(0x15b),_0x6d68ef=_0x470c68[_0x1b9202(0x163)](_0x1a9306)[_0x1b9202(0x1a4)]();for(let _0x1e5321 in _0x6d68ef){bookIndexUtil['dealFirstLetterSingle'](_0x470c68,_0x6d68ef[_0x1e5321]);}};function isChinese(_0x1c39b2){const _0x3e72df=_0x5ac2f6;var _0x5e3122=/[^\\u4e00-\\u9fa5]/;return _0x5e3122[_0x3e72df(0x180)](_0x1c39b2);}bookIndexUtil['dealFirstLetterSingle']=function(_0x55829e,_0x2e13ce){const _0x17aee4=_0x5ac2f6;function _0x8beb45(_0x51ba6f){const _0x1ef7b7=_0xcc64;if(_0x51ba6f&&_0x51ba6f['length']>0x0){let _0x469a78=_0x51ba6f[0x0];if(letterList[_0x1ef7b7(0x18f)](_0x469a78))return _0x469a78;else{if(isChinese(_0x469a78)){let _0x499f0b=pinyin(_0x469a78,{'style':_0x1ef7b7(0x151)});return _0x499f0b&&_0x499f0b[_0x1ef7b7(0x16a)]>0x0&&_0x499f0b[0x0]['length']>0x0&&_0x499f0b[0x0][0x0][_0x1ef7b7(0x16a)]>0x0?_0x499f0b[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x36840b=_0x8beb45(_0x2e13ce[_0x17aee4(0x15e)]?_0x2e13ce['filename'][_0x17aee4(0x18e)]():'')[_0x17aee4(0x18e)](),_0xca573b=_0x8beb45(_0x2e13ce[_0x17aee4(0x16c)]?_0x2e13ce[_0x17aee4(0x16c)][_0x17aee4(0x18e)]():'')[_0x17aee4(0x18e)](),_0x3dd68c=_0x8beb45(_0x2e13ce[_0x17aee4(0x16f)]?_0x2e13ce[_0x17aee4(0x16f)]['toUpperCase']():'')[_0x17aee4(0x18e)]();_0x55829e[_0x17aee4(0x163)](_0x17aee4(0x17c))[_0x17aee4(0x165)](_0x36840b,_0xca573b,_0x3dd68c,_0x2e13ce['id']);},module[_0x5ac2f6(0x188)]=bookIndexUtil;