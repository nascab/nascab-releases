const _0x215445=_0x5984;(function(_0x4404ee,_0x3c2af4){const _0x260c43=_0x5984,_0x22f87c=_0x4404ee();while(!![]){try{const _0x500fbb=parseInt(_0x260c43(0x141))/0x1*(parseInt(_0x260c43(0x150))/0x2)+parseInt(_0x260c43(0x13a))/0x3*(parseInt(_0x260c43(0x144))/0x4)+parseInt(_0x260c43(0x16d))/0x5*(-parseInt(_0x260c43(0x117))/0x6)+-parseInt(_0x260c43(0x119))/0x7*(-parseInt(_0x260c43(0x12d))/0x8)+parseInt(_0x260c43(0x114))/0x9+parseInt(_0x260c43(0x138))/0xa+-parseInt(_0x260c43(0x12a))/0xb;if(_0x500fbb===_0x3c2af4)break;else _0x22f87c['push'](_0x22f87c['shift']());}catch(_0x107fd8){_0x22f87c['push'](_0x22f87c['shift']());}}}(_0x1fb5,0xd47ac));const path=require('path'),fs=require('fs');let pinyin=require(_0x215445(0x15f));const sharp=require(_0x215445(0x146)),{Worker}=require(_0x215445(0x132));function _0x5984(_0xf8e513,_0x3e3ad3){const _0x1fb542=_0x1fb5();return _0x5984=function(_0x5984b7,_0x1aae27){_0x5984b7=_0x5984b7-0x111;let _0x15e4d7=_0x1fb542[_0x5984b7];return _0x15e4d7;},_0x5984(_0xf8e513,_0x3e3ad3);}function _0x1fb5(){const _0x305341=['title','recursionFilesAddIndex','includes','Nan','3182985cOumXx','indexObj','coverPath','318BTnZGk','./indexUtil','6084701iSZcoR','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','ctime','length','birthtimeMs','artist','resize','err\x205','getById','sharpWriteCover','prepare','addOriginalDate','terminate','filename','error','.cbr','INDEX_TABLE_NAME_BOOK','28640139QKtyQq','../../myConfig/config','ext','8WNcohw','originalTime','../../db/dbFileIndexTable','atimeMs','then','worker_threads','all','toLowerCase','initials','.rar','message','10649650qFqlPY','catch','67638nmZVCQ','setAllBookType','.cbz','ceil','addFileIndexToDb','extname','bookTypeList','185602TtYeNB','UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20','已超时\x20结束处理worker','164SOCAuX','getMediaCoverCachePath','sharp','getDate','size','封面写入成功','Null','ctimeMs','UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20','.zip','Worker\x20stopped\x20with\x20exit\x20code:','dealBookInfo','4NpxThT','exports','jpeg','err1','处理成功','test','code','original_date','writeFile','resolve','getFullYear','NaN','run','exit','../../utils/nfoUtil','node-pinyin','runGetBookInfoWorker','log','mtimeMs','exifMinTimeStamp','bookInfoWorker.js','type','toUpperCase','dealFirstLetterSingle','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','book','birthtime','getBookType','getTime','10330qzwDQW'];_0x1fb5=function(){return _0x305341;};return _0x1fb5();}let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require('../../db/dbSourceFolderTable'),dbFileIndexTable=require(_0x215445(0x12f)),dbConfigTable=require('../../db/dbConfigTable'),config=require(_0x215445(0x12b)),indexUtil=require(_0x215445(0x118)),nfoUtil=require(_0x215445(0x15e)),indexTableName=dbFileIndexTable[_0x215445(0x129)],bookIndexUtil={};bookIndexUtil[_0x215445(0x122)]=async function(_0x10feba,_0x1cbc12){return new Promise((_0x57d52e,_0x41e1e2)=>{const _0xec22dc=_0x5984;sharp(_0x10feba,{'failOnError':![]})[_0xec22dc(0x152)]({'quality':0x4d})[_0xec22dc(0x11f)]({'width':0x1f4})['toBuffer']()['then'](_0x551c54=>{const _0x12f109=_0xec22dc;fs[_0x12f109(0x158)](_0x1cbc12,_0x551c54,_0x170ced=>{if(_0x170ced)return _0x41e1e2();return _0x57d52e(_0x1cbc12);});})[_0xec22dc(0x139)](_0x26b6ac=>{const _0x5c3f6e=_0xec22dc;return console[_0x5c3f6e(0x161)](_0x5c3f6e(0x153),_0x26b6ac),_0x41e1e2();});});},bookIndexUtil[_0x215445(0x160)]=function(_0x195367,_0xcf68c4,_0x47afc7=![]){return new Promise((_0x36e2dc,_0x2c4961)=>{const _0x1dd66a=_0x5984;let _0x4ff7d2=new Worker(path[_0x1dd66a(0x159)](__dirname,_0x1dd66a(0x164)),{'workerData':{'indexObj':_0x195367,'bookCoverCachePath':_0xcf68c4,'onlyGenCover':_0x47afc7}}),_0x124116=setTimeout(()=>{const _0xf4811d=_0x1dd66a;_0x4ff7d2&&(console[_0xf4811d(0x161)](_0xf4811d(0x143)),_0x4ff7d2[_0xf4811d(0x125)](),_0x4ff7d2=null,_0x2c4961());},0x7530);_0x4ff7d2['on'](_0x1dd66a(0x137),_0x2cc09e=>{const _0x18b534=_0x1dd66a;_0x2cc09e[_0x18b534(0x156)]==0x0&&(_0x124116&&clearTimeout(_0x124116),_0x36e2dc(_0x2cc09e));}),_0x4ff7d2['on'](_0x1dd66a(0x127),_0x5ebc61=>{const _0x51356a=_0x1dd66a;console[_0x51356a(0x127)]('Worker\x20error:',_0x5ebc61),_0x4ff7d2&&(_0x4ff7d2[_0x51356a(0x125)](),_0x4ff7d2=null),_0x2c4961();}),_0x4ff7d2['on'](_0x1dd66a(0x15d),_0x38ae05=>{const _0x5b85aa=_0x1dd66a;if(_0x38ae05!==0x0)console[_0x5b85aa(0x127)](_0x5b85aa(0x14e),_0x38ae05);else{}});});},bookIndexUtil[_0x215445(0x14f)]=async function(_0x1a9567,_0x1f9be6){const _0x1b1a80=_0x215445;let _0x1e9869=![];if(_0x1f9be6['is_file']==0x1&&_0x1f9be6[_0x1b1a80(0x12c)]&&config[_0x1b1a80(0x140)][_0x1b1a80(0x112)](_0x1f9be6[_0x1b1a80(0x12c)][_0x1b1a80(0x134)]())){!_0x1f9be6[_0x1b1a80(0x165)]&&(_0x1f9be6['type']=bookIndexUtil[_0x1b1a80(0x16b)](_0x1f9be6));let _0x59c277=config[_0x1b1a80(0x145)](_0x1f9be6);try{let _0x571f59=await bookIndexUtil[_0x1b1a80(0x160)](_0x1f9be6,_0x59c277);if(_0x571f59['coverData'])try{let _0x578095=await bookIndexUtil['sharpWriteCover'](_0x571f59['coverData'],_0x59c277);_0x578095&&(console[_0x1b1a80(0x161)](_0x1b1a80(0x149),_0x578095),_0x571f59[_0x1b1a80(0x115)][_0x1b1a80(0x116)]=_0x578095);}catch(_0x23b8d8){console[_0x1b1a80(0x161)](_0x23b8d8);}return console[_0x1b1a80(0x161)](_0x1b1a80(0x154),_0x571f59['indexObj']['filename'],_0x571f59['indexObj']['total_page']),bookIndexUtil['addOriginalDate'](_0x1a9567,_0x571f59[_0x1b1a80(0x12e)],_0x571f59['indexObj']);}catch(_0x325e07){return console[_0x1b1a80(0x161)](_0x1b1a80(0x120),_0x325e07),bookIndexUtil[_0x1b1a80(0x124)](_0x1a9567,_0x1e9869,_0x1f9be6);}}else{if(_0x1f9be6['is_file']==0x1)return;return bookIndexUtil[_0x1b1a80(0x124)](_0x1a9567,_0x1e9869,_0x1f9be6);}},bookIndexUtil['getBookType']=function(_0xc06de0){const _0x1b43f8=_0x215445;let _0x58b973=[_0x1b43f8(0x13c),_0x1b43f8(0x128),_0x1b43f8(0x136),_0x1b43f8(0x14d)];return _0xc06de0['ext']&&_0x58b973[_0x1b43f8(0x112)](_0xc06de0[_0x1b43f8(0x12c)][_0x1b43f8(0x134)]())?0x2:0x1;},bookIndexUtil[_0x215445(0x13b)]=function(_0x32c5bb){const _0x3e9dde=_0x215445;let _0x149508=_0x3e9dde(0x11a),_0x13e851=_0x3e9dde(0x14c)+_0x149508;_0x32c5bb[_0x3e9dde(0x123)](_0x13e851)[_0x3e9dde(0x15c)](),_0x13e851=_0x3e9dde(0x142)+_0x149508,_0x32c5bb[_0x3e9dde(0x123)](_0x13e851)[_0x3e9dde(0x15c)]();},bookIndexUtil[_0x215445(0x111)]=async function(_0x1e2167,_0x18a3e6,_0x2745d7){const _0x23bf30=_0x215445;return await indexUtil[_0x23bf30(0x111)](_0x1e2167,_0x18a3e6,indexTableName,'book',_0x2745d7,bookIndexUtil['addFileIndexToDb']);},bookIndexUtil[_0x215445(0x13e)]=async function(_0x30b74d,_0x1deb79,_0x14f3bd,_0x49b056,_0x3a87f0,_0x564a6e){const _0x64174c=_0x215445;let _0x2bda6c=indexUtil['doesPathCanAddToDb'](_0x30b74d,_0x64174c(0x169),config,_0x14f3bd,_0x49b056);if(!_0x2bda6c)return;let _0x56e8e9=_0x564a6e[_0x64174c(0x11d)];_0x564a6e[_0x64174c(0x162)]<_0x56e8e9&&(_0x56e8e9=_0x564a6e[_0x64174c(0x162)]);_0x564a6e[_0x64174c(0x130)]<_0x56e8e9&&(_0x56e8e9=_0x564a6e['atimeMs']);_0x564a6e[_0x64174c(0x14b)]<_0x56e8e9&&(_0x56e8e9=_0x564a6e[_0x64174c(0x14b)]);let _0x48b419={'path':_0x14f3bd,'filename':_0x49b056,'is_file':_0x3a87f0,'ctime':_0x564a6e[_0x64174c(0x14b)],'mtime':_0x564a6e[_0x64174c(0x162)],'ext':path[_0x64174c(0x13f)](_0x49b056),'birthtime':Math[_0x64174c(0x13d)](_0x56e8e9),'size':_0x564a6e[_0x64174c(0x148)],'check_time':new Date()[_0x64174c(0x16c)]()};_0x48b419=await bookIndexUtil[_0x64174c(0x14f)](_0x1deb79,_0x48b419);},bookIndexUtil['dealFileChange']=async function(_0xf8a0ab,_0x458192,_0x230b9d){const _0x5b88d6=_0x215445;await indexUtil['dealFileChange'](_0xf8a0ab,_0x458192,_0x230b9d,indexTableName,bookIndexUtil[_0x5b88d6(0x13e)],bookIndexUtil['recursionFilesAddIndex']);return;},bookIndexUtil[_0x215445(0x124)]=function(_0x2d4a1c,_0x2eadad,_0xdff284){const _0x3720e5=_0x215445;nfoUtil['restoreBookNfo'](_0xdff284)[_0x3720e5(0x131)](_0x942ae2=>{_0x128ac3(_0x942ae2);})['catch'](_0x2b8fa9=>{_0x128ac3(_0xdff284);});function _0x128ac3(_0x144dec){const _0x2e3c16=_0x3720e5;_0x2eadad&&_0x2eadad<config[_0x2e3c16(0x163)]&&(_0x2eadad=![]);(!_0x2eadad||_0x2eadad==_0x2e3c16(0x15b)||_0x2eadad==_0x2e3c16(0x113)||_0x2eadad=='NaN'||_0x2eadad==_0x2e3c16(0x14a))&&(_0x2eadad=_0x144dec[_0x2e3c16(0x16a)]||_0x144dec[_0x2e3c16(0x11b)]);let _0x3456ec=new Date(_0x2eadad);_0x144dec['original_time']=_0x3456ec[_0x2e3c16(0x16c)]();let _0x326515=_0x3456ec[_0x2e3c16(0x15a)](),_0x405a28=_0x3456ec['getMonth']()+0x1;_0x405a28=_0x405a28>=0xa?_0x405a28:'0'+_0x405a28;let _0x266115=_0x3456ec[_0x2e3c16(0x147)]();_0x266115=_0x266115>=0xa?_0x266115:'0'+_0x266115,_0x144dec[_0x2e3c16(0x157)]=_0x326515+'-'+_0x405a28+'-'+_0x266115;let _0x26f81e=dbFileIndexTable['create'](_0x2d4a1c,_0x144dec,indexTableName);if(_0x26f81e&&_0x26f81e['lastInsertRowid']){let _0x180cdf=dbFileIndexTable[_0x2e3c16(0x121)](_0x2d4a1c,_0x26f81e['lastInsertRowid'],dbFileIndexTable[_0x2e3c16(0x129)]);_0x180cdf&&bookIndexUtil[_0x2e3c16(0x167)](_0x2d4a1c,_0x180cdf);}}},bookIndexUtil['dealFirstLetterAll']=function(_0x2f3b44){const _0x2583e0=_0x215445;let _0x50329d='SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null',_0x2f18d0=_0x2f3b44['prepare'](_0x50329d)[_0x2583e0(0x133)]();for(let _0x3c5c12 in _0x2f18d0){bookIndexUtil[_0x2583e0(0x167)](_0x2f3b44,_0x2f18d0[_0x3c5c12]);}};function isChinese(_0x4672c0){const _0x5a341d=_0x215445;var _0x638390=/[^\\u4e00-\\u9fa5]/;return _0x638390[_0x5a341d(0x155)](_0x4672c0);}bookIndexUtil['dealFirstLetterSingle']=function(_0xe41a27,_0x1f2212){const _0x402966=_0x215445;function _0x59d262(_0x56d975){const _0x473362=_0x5984;if(_0x56d975&&_0x56d975[_0x473362(0x11c)]>0x0){let _0x502766=_0x56d975[0x0];if(letterList[_0x473362(0x112)](_0x502766))return _0x502766;else{if(isChinese(_0x502766)){let _0x61a3d=pinyin(_0x502766,{'style':_0x473362(0x135)});return _0x61a3d&&_0x61a3d['length']>0x0&&_0x61a3d[0x0][_0x473362(0x11c)]>0x0&&_0x61a3d[0x0][0x0][_0x473362(0x11c)]>0x0?_0x61a3d[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x639ce7=_0x59d262(_0x1f2212[_0x402966(0x126)]?_0x1f2212[_0x402966(0x126)][_0x402966(0x166)]():'')[_0x402966(0x166)](),_0x1026ca=_0x59d262(_0x1f2212[_0x402966(0x11e)]?_0x1f2212[_0x402966(0x11e)][_0x402966(0x166)]():'')[_0x402966(0x166)](),_0x230edc=_0x59d262(_0x1f2212[_0x402966(0x16e)]?_0x1f2212[_0x402966(0x16e)]['toUpperCase']():'')[_0x402966(0x166)]();_0xe41a27[_0x402966(0x123)](_0x402966(0x168))[_0x402966(0x15c)](_0x639ce7,_0x1026ca,_0x230edc,_0x1f2212['id']);},module[_0x215445(0x151)]=bookIndexUtil;