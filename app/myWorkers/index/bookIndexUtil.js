const _0x996d5d=_0x5467;(function(_0x3d81c9,_0x582251){const _0x196ef8=_0x5467,_0x4fa8fb=_0x3d81c9();while(!![]){try{const _0x383021=-parseInt(_0x196ef8(0x1ce))/0x1*(parseInt(_0x196ef8(0x1ea))/0x2)+-parseInt(_0x196ef8(0x1d9))/0x3*(-parseInt(_0x196ef8(0x21a))/0x4)+parseInt(_0x196ef8(0x1fb))/0x5*(parseInt(_0x196ef8(0x1c0))/0x6)+parseInt(_0x196ef8(0x204))/0x7*(-parseInt(_0x196ef8(0x1f8))/0x8)+parseInt(_0x196ef8(0x1cf))/0x9*(-parseInt(_0x196ef8(0x1bb))/0xa)+-parseInt(_0x196ef8(0x1f3))/0xb*(-parseInt(_0x196ef8(0x200))/0xc)+-parseInt(_0x196ef8(0x1de))/0xd*(parseInt(_0x196ef8(0x1bf))/0xe);if(_0x383021===_0x582251)break;else _0x4fa8fb['push'](_0x4fa8fb['shift']());}catch(_0x4a6f2f){_0x4fa8fb['push'](_0x4fa8fb['shift']());}}}(_0x4f2d,0xc6652));const path=require('path'),fs=require('fs');let pinyin=require(_0x996d5d(0x21b));const sharp=require('sharp'),{Worker}=require(_0x996d5d(0x1ee));function _0x4f2d(){const _0x1548dc=['getTime','type','filename','run','atimeMs','INDEX_TABLE_NAME_BOOK','initials','addOriginalDate','jpeg','original_date','runGetBookInfoWorker','includes','1YJopaW','34929cOHNLQ','create','dealFirstLetterSingle','.zip','.rar','err\x205','coverData','title','getBookType','sharpWriteCover','78549ZMeYHZ','addFileIndexToDb','message','dealFirstLetterAll','dealFileChange','26CYHMoH','doesPathCanAddToDb','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','error','ctimeMs','setAllBookType','ceil','then','ext','ctime','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','is_file','8422hbIqIj','lastInsertRowid','code','toUpperCase','worker_threads','size','prepare','resize','writeFile','462urnnhD','toLowerCase','.cbz','../../db/dbSourceFolderTable','original_time','8URyDMU','getFullYear','book','81905LMGjYp','exit','artist','处理成功','bookTypeList','248172dfFHzj','birthtime','getDate','Nan','1153831VEJydN','coverPath','Worker\x20error:','originalTime','封面写入成功','SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null','getMediaCoverCachePath','../../db/dbFileIndexTable','./indexUtil','indexObj','test','Worker\x20stopped\x20with\x20exit\x20code:','log','NaN','resolve','mtimeMs','../../myConfig/config','recursionFilesAddIndex','length','extname','terminate','已超时\x20结束处理worker','132MiyyQq','node-pinyin','.cbr','340QPMPqT','err1','../../utils/nfoUtil','dealBookInfo','9951802BEPgds','294fkjzIZ','catch'];_0x4f2d=function(){return _0x1548dc;};return _0x4f2d();}function _0x5467(_0xc35c25,_0x170a1a){const _0x4f2dd5=_0x4f2d();return _0x5467=function(_0x54675d,_0x364821){_0x54675d=_0x54675d-0x1ba;let _0x1f8c58=_0x4f2dd5[_0x54675d];return _0x1f8c58;},_0x5467(_0xc35c25,_0x170a1a);}let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require(_0x996d5d(0x1f6)),dbFileIndexTable=require(_0x996d5d(0x20b)),dbConfigTable=require('../../db/dbConfigTable'),config=require(_0x996d5d(0x214)),indexUtil=require(_0x996d5d(0x20c)),nfoUtil=require(_0x996d5d(0x1bd)),indexTableName=dbFileIndexTable[_0x996d5d(0x1c7)],bookIndexUtil={};bookIndexUtil['sharpWriteCover']=async function(_0x337e47,_0x44ab9e){return new Promise((_0x5c5674,_0x54e09c)=>{const _0x3c41b6=_0x5467;sharp(_0x337e47,{'failOnError':![]})[_0x3c41b6(0x1ca)]({'quality':0x4d})[_0x3c41b6(0x1f1)]({'width':0x1f4})['toBuffer']()[_0x3c41b6(0x1e5)](_0x884d28=>{const _0x25de7e=_0x3c41b6;fs[_0x25de7e(0x1f2)](_0x44ab9e,_0x884d28,_0x1f2ff5=>{if(_0x1f2ff5)return _0x54e09c();return _0x5c5674(_0x44ab9e);});})['catch'](_0xf1fdee=>{const _0x16f648=_0x3c41b6;return console[_0x16f648(0x210)](_0x16f648(0x1bc),_0xf1fdee),_0x54e09c();});});},bookIndexUtil[_0x996d5d(0x1cc)]=function(_0x228cf4,_0xb7c0d0,_0x12e6b1=![]){return new Promise((_0x395016,_0x4440df)=>{const _0x384293=_0x5467;let _0x3a3468=new Worker(path[_0x384293(0x212)](__dirname,'bookInfoWorker.js'),{'workerData':{'indexObj':_0x228cf4,'bookCoverCachePath':_0xb7c0d0,'onlyGenCover':_0x12e6b1}}),_0x235065=setTimeout(()=>{const _0x436e53=_0x384293;_0x3a3468&&(console[_0x436e53(0x210)](_0x436e53(0x219)),_0x3a3468[_0x436e53(0x218)](),_0x3a3468=null,_0x4440df());},0x7530);_0x3a3468['on'](_0x384293(0x1db),_0x393fee=>{const _0x3ad42c=_0x384293;_0x393fee[_0x3ad42c(0x1ec)]==0x0&&(_0x235065&&clearTimeout(_0x235065),_0x395016(_0x393fee));}),_0x3a3468['on'](_0x384293(0x1e1),_0x3ff365=>{const _0x54fa57=_0x384293;console[_0x54fa57(0x1e1)](_0x54fa57(0x206),_0x3ff365),_0x3a3468&&(_0x3a3468['terminate'](),_0x3a3468=null),_0x4440df();}),_0x3a3468['on'](_0x384293(0x1fc),_0x15b8ae=>{const _0x588a23=_0x384293;if(_0x15b8ae!==0x0)console[_0x588a23(0x1e1)](_0x588a23(0x20f),_0x15b8ae);else{}});});},bookIndexUtil[_0x996d5d(0x1be)]=async function(_0x208646,_0x4cdb70){const _0x5a575a=_0x996d5d;let _0x34f784=![];if(_0x4cdb70[_0x5a575a(0x1e9)]==0x1&&_0x4cdb70[_0x5a575a(0x1e6)]&&config[_0x5a575a(0x1ff)][_0x5a575a(0x1cd)](_0x4cdb70[_0x5a575a(0x1e6)][_0x5a575a(0x1f4)]())){!_0x4cdb70[_0x5a575a(0x1c3)]&&(_0x4cdb70[_0x5a575a(0x1c3)]=bookIndexUtil['getBookType'](_0x4cdb70));let _0x1db948=config[_0x5a575a(0x20a)](_0x4cdb70);try{let _0x49a0e1=await bookIndexUtil[_0x5a575a(0x1cc)](_0x4cdb70,_0x1db948);if(_0x49a0e1[_0x5a575a(0x1d5)])try{let _0x17d779=await bookIndexUtil[_0x5a575a(0x1d8)](_0x49a0e1['coverData'],_0x1db948);_0x17d779&&(console[_0x5a575a(0x210)](_0x5a575a(0x208),_0x17d779),_0x49a0e1[_0x5a575a(0x20d)][_0x5a575a(0x205)]=_0x17d779);}catch(_0x1336f0){console[_0x5a575a(0x210)](_0x1336f0);}return console['log'](_0x5a575a(0x1fe),_0x49a0e1[_0x5a575a(0x20d)][_0x5a575a(0x1c4)],_0x49a0e1[_0x5a575a(0x20d)]['total_page']),bookIndexUtil[_0x5a575a(0x1c9)](_0x208646,_0x49a0e1[_0x5a575a(0x207)],_0x49a0e1[_0x5a575a(0x20d)]);}catch(_0x32d839){return console[_0x5a575a(0x210)](_0x5a575a(0x1d4),_0x32d839),bookIndexUtil[_0x5a575a(0x1c9)](_0x208646,_0x34f784,_0x4cdb70);}}else{if(_0x4cdb70[_0x5a575a(0x1e9)]==0x1)return;return bookIndexUtil['addOriginalDate'](_0x208646,_0x34f784,_0x4cdb70);}},bookIndexUtil[_0x996d5d(0x1d7)]=function(_0x543e79){const _0x1e6ea0=_0x996d5d;let _0x2cd51c=[_0x1e6ea0(0x1f5),_0x1e6ea0(0x1ba),_0x1e6ea0(0x1d3),_0x1e6ea0(0x1d2)];return _0x543e79[_0x1e6ea0(0x1e6)]&&_0x2cd51c[_0x1e6ea0(0x1cd)](_0x543e79['ext'][_0x1e6ea0(0x1f4)]())?0x2:0x1;},bookIndexUtil[_0x996d5d(0x1e3)]=function(_0x4cee73){const _0x3760db=_0x996d5d;let _0x4b6a0b=_0x3760db(0x1e8),_0x531b28='UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20'+_0x4b6a0b;_0x4cee73['prepare'](_0x531b28)['run'](),_0x531b28='UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20'+_0x4b6a0b,_0x4cee73[_0x3760db(0x1f0)](_0x531b28)[_0x3760db(0x1c5)]();},bookIndexUtil[_0x996d5d(0x215)]=async function(_0x62d65f,_0x4884d5,_0x305023){const _0x794778=_0x996d5d;return await indexUtil[_0x794778(0x215)](_0x62d65f,_0x4884d5,indexTableName,_0x794778(0x1fa),_0x305023,bookIndexUtil[_0x794778(0x1da)]);},bookIndexUtil['addFileIndexToDb']=async function(_0x2c48be,_0x2ccbc9,_0x5ac8cf,_0x1e8612,_0x150518,_0x16c561){const _0x3ce760=_0x996d5d;let _0x29ebc7=indexUtil[_0x3ce760(0x1df)](_0x2c48be,'book',config,_0x5ac8cf,_0x1e8612);if(!_0x29ebc7)return;let _0x33e395=_0x16c561['birthtimeMs'];_0x16c561['mtimeMs']<_0x33e395&&(_0x33e395=_0x16c561[_0x3ce760(0x213)]);_0x16c561['atimeMs']<_0x33e395&&(_0x33e395=_0x16c561[_0x3ce760(0x1c6)]);_0x16c561[_0x3ce760(0x1e2)]<_0x33e395&&(_0x33e395=_0x16c561[_0x3ce760(0x1e2)]);let _0xd1f7f2={'path':_0x5ac8cf,'filename':_0x1e8612,'is_file':_0x150518,'ctime':_0x16c561[_0x3ce760(0x1e2)],'mtime':_0x16c561['mtimeMs'],'ext':path[_0x3ce760(0x217)](_0x1e8612),'birthtime':Math[_0x3ce760(0x1e4)](_0x33e395),'size':_0x16c561[_0x3ce760(0x1ef)],'check_time':new Date()[_0x3ce760(0x1c2)]()};_0xd1f7f2=await bookIndexUtil[_0x3ce760(0x1be)](_0x2ccbc9,_0xd1f7f2);},bookIndexUtil[_0x996d5d(0x1dd)]=async function(_0x3fd362,_0x1c2e9a,_0x5a01e6){const _0x13dae1=_0x996d5d;await indexUtil[_0x13dae1(0x1dd)](_0x3fd362,_0x1c2e9a,_0x5a01e6,indexTableName,bookIndexUtil['addFileIndexToDb'],bookIndexUtil[_0x13dae1(0x215)]);return;},bookIndexUtil[_0x996d5d(0x1c9)]=function(_0x5d800a,_0x49a576,_0x2b071c){const _0x21a52e=_0x996d5d;nfoUtil['restoreBookNfo'](_0x2b071c)[_0x21a52e(0x1e5)](_0x5ef11a=>{_0x143159(_0x5ef11a);})[_0x21a52e(0x1c1)](_0x53ce62=>{_0x143159(_0x2b071c);});function _0x143159(_0x5076a9){const _0x1eb2a0=_0x21a52e;_0x49a576&&_0x49a576<config['exifMinTimeStamp']&&(_0x49a576=![]);(!_0x49a576||_0x49a576==_0x1eb2a0(0x211)||_0x49a576==_0x1eb2a0(0x203)||_0x49a576=='NaN'||_0x49a576=='Null')&&(_0x49a576=_0x5076a9[_0x1eb2a0(0x201)]||_0x5076a9[_0x1eb2a0(0x1e7)]);let _0x1d089e=new Date(_0x49a576);_0x5076a9[_0x1eb2a0(0x1f7)]=_0x1d089e[_0x1eb2a0(0x1c2)]();let _0xd465f3=_0x1d089e[_0x1eb2a0(0x1f9)](),_0x4da345=_0x1d089e['getMonth']()+0x1;_0x4da345=_0x4da345>=0xa?_0x4da345:'0'+_0x4da345;let _0x30a209=_0x1d089e[_0x1eb2a0(0x202)]();_0x30a209=_0x30a209>=0xa?_0x30a209:'0'+_0x30a209,_0x5076a9[_0x1eb2a0(0x1cb)]=_0xd465f3+'-'+_0x4da345+'-'+_0x30a209;let _0x1c3af6=dbFileIndexTable[_0x1eb2a0(0x1d0)](_0x5d800a,_0x5076a9,indexTableName);if(_0x1c3af6&&_0x1c3af6[_0x1eb2a0(0x1eb)]){let _0x4d1b61=dbFileIndexTable['getById'](_0x5d800a,_0x1c3af6[_0x1eb2a0(0x1eb)],dbFileIndexTable[_0x1eb2a0(0x1c7)]);_0x4d1b61&&bookIndexUtil[_0x1eb2a0(0x1d1)](_0x5d800a,_0x4d1b61);}}},bookIndexUtil[_0x996d5d(0x1dc)]=function(_0xadd495){const _0x2ed90b=_0x996d5d;let _0x3c691f=_0x2ed90b(0x209),_0x14f133=_0xadd495[_0x2ed90b(0x1f0)](_0x3c691f)['all']();for(let _0x3cf250 in _0x14f133){bookIndexUtil[_0x2ed90b(0x1d1)](_0xadd495,_0x14f133[_0x3cf250]);}};function isChinese(_0x4e5ce0){const _0x36870d=_0x996d5d;var _0x599f9c=/[^\\u4e00-\\u9fa5]/;return _0x599f9c[_0x36870d(0x20e)](_0x4e5ce0);}bookIndexUtil[_0x996d5d(0x1d1)]=function(_0x3634b0,_0x542241){const _0x168ff9=_0x996d5d;function _0x32072b(_0x21c4da){const _0x196353=_0x5467;if(_0x21c4da&&_0x21c4da[_0x196353(0x216)]>0x0){let _0x109481=_0x21c4da[0x0];if(letterList[_0x196353(0x1cd)](_0x109481))return _0x109481;else{if(isChinese(_0x109481)){let _0x31aa92=pinyin(_0x109481,{'style':_0x196353(0x1c8)});return _0x31aa92&&_0x31aa92[_0x196353(0x216)]>0x0&&_0x31aa92[0x0][_0x196353(0x216)]>0x0&&_0x31aa92[0x0][0x0][_0x196353(0x216)]>0x0?_0x31aa92[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x55c35d=_0x32072b(_0x542241['filename']?_0x542241[_0x168ff9(0x1c4)][_0x168ff9(0x1ed)]():'')[_0x168ff9(0x1ed)](),_0x4007c3=_0x32072b(_0x542241['artist']?_0x542241[_0x168ff9(0x1fd)][_0x168ff9(0x1ed)]():'')[_0x168ff9(0x1ed)](),_0xf32e9f=_0x32072b(_0x542241[_0x168ff9(0x1d6)]?_0x542241['title'][_0x168ff9(0x1ed)]():'')[_0x168ff9(0x1ed)]();_0x3634b0['prepare'](_0x168ff9(0x1e0))[_0x168ff9(0x1c5)](_0x55c35d,_0x4007c3,_0xf32e9f,_0x542241['id']);},module['exports']=bookIndexUtil;