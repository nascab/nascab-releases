const _0x5d5671=_0xe4a4;(function(_0x1dfe69,_0x10ac11){const _0x1a99d2=_0xe4a4,_0x55c8cd=_0x1dfe69();while(!![]){try{const _0x5650ca=parseInt(_0x1a99d2(0x16c))/0x1+parseInt(_0x1a99d2(0x196))/0x2+parseInt(_0x1a99d2(0x177))/0x3*(parseInt(_0x1a99d2(0x154))/0x4)+parseInt(_0x1a99d2(0x180))/0x5*(parseInt(_0x1a99d2(0x15c))/0x6)+-parseInt(_0x1a99d2(0x16b))/0x7+-parseInt(_0x1a99d2(0x157))/0x8+-parseInt(_0x1a99d2(0x17d))/0x9;if(_0x5650ca===_0x10ac11)break;else _0x55c8cd['push'](_0x55c8cd['shift']());}catch(_0x39e09d){_0x55c8cd['push'](_0x55c8cd['shift']());}}}(_0x2efd,0xd6f17));const path=require(_0x5d5671(0x189)),fs=require('fs');function _0x2efd(){const _0x1be091=['length','indexObj','size','doesPathCanAddToDb','test','.rar','artist','path','resolve','toLowerCase','UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20','all','setAllBookType','error','lastInsertRowid','recursionFilesAddIndex','initials','ext','Worker\x20error:','dealFirstLetterSingle','2143520qmyMTz','original_time','NaN','book','getFullYear','birthtimeMs','includes','SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null','coverData','sharpWriteCover','dealFirstLetterAll','mtimeMs','ctimeMs','.cbz','create','writeFile','../../utils/nfoUtil','node-pinyin','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','addFileIndexToDb','bookInfoWorker.js','5781972KTEiJl','INDEX_TABLE_NAME_BOOK','getMonth','9619312zwVYNo','toUpperCase','catch','getTime','title','100182rTcLAA','exit','filename','ceil','runGetBookInfoWorker','then','terminate','处理成功','worker_threads','birthtime','prepare','restoreBookNfo','Null','addOriginalDate','jpeg','9582692EofRsU','1110543qiIoni','exports','message','run','../../db/dbConfigTable','originalTime','.zip','is_file','../../db/dbFileIndexTable','getBookType','dealFileChange','3rmOFeY','err1','getById','./indexUtil','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','log','14357376QweBRo','atimeMs','../../myConfig/config','425NQuHAB','type'];_0x2efd=function(){return _0x1be091;};return _0x2efd();}let pinyin=require(_0x5d5671(0x1a7));const sharp=require('sharp'),{Worker}=require(_0x5d5671(0x164));let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require('../../db/dbSourceFolderTable'),dbFileIndexTable=require(_0x5d5671(0x174)),dbConfigTable=require(_0x5d5671(0x170)),config=require(_0x5d5671(0x17f)),indexUtil=require(_0x5d5671(0x17a)),nfoUtil=require(_0x5d5671(0x1a6)),indexTableName=dbFileIndexTable['INDEX_TABLE_NAME_BOOK'],bookIndexUtil={};bookIndexUtil[_0x5d5671(0x19f)]=async function(_0x403500,_0x4b9b79){return new Promise((_0x552256,_0x2c7ff9)=>{const _0x59dc5c=_0xe4a4;sharp(_0x403500,{'failOnError':![]})[_0x59dc5c(0x16a)]({'quality':0x4d})['resize']({'width':0x1f4})['toBuffer']()[_0x59dc5c(0x161)](_0x236c62=>{const _0x2c6845=_0x59dc5c;fs[_0x2c6845(0x1a5)](_0x4b9b79,_0x236c62,_0x2b69f4=>{if(_0x2b69f4)return _0x2c7ff9();return _0x552256(_0x4b9b79);});})[_0x59dc5c(0x159)](_0xb42b50=>{const _0x455b9b=_0x59dc5c;return console[_0x455b9b(0x17c)](_0x455b9b(0x178),_0xb42b50),_0x2c7ff9();});});},bookIndexUtil[_0x5d5671(0x160)]=function(_0x2c2ef5,_0x424781,_0x33cae3=![]){return new Promise((_0x45efe7,_0x19f488)=>{const _0x1b4da3=_0xe4a4;let _0x57f3ac=new Worker(path[_0x1b4da3(0x18a)](__dirname,_0x1b4da3(0x153)),{'workerData':{'indexObj':_0x2c2ef5,'bookCoverCachePath':_0x424781,'onlyGenCover':_0x33cae3}}),_0x29199b=setTimeout(()=>{const _0x8805ee=_0x1b4da3;_0x57f3ac&&(console[_0x8805ee(0x17c)]('已超时\x20结束处理worker'),_0x57f3ac[_0x8805ee(0x162)](),_0x57f3ac=null,_0x19f488());},0x7530);_0x57f3ac['on'](_0x1b4da3(0x16e),_0x209f8b=>{_0x209f8b['code']==0x0&&(_0x29199b&&clearTimeout(_0x29199b),_0x45efe7(_0x209f8b));}),_0x57f3ac['on']('error',_0x2be450=>{const _0x2cf8e4=_0x1b4da3;console[_0x2cf8e4(0x18f)](_0x2cf8e4(0x194),_0x2be450),_0x57f3ac&&(_0x57f3ac[_0x2cf8e4(0x162)](),_0x57f3ac=null),_0x19f488();}),_0x57f3ac['on'](_0x1b4da3(0x15d),_0x774f1e=>{const _0x3ee0e8=_0x1b4da3;if(_0x774f1e!==0x0)console[_0x3ee0e8(0x18f)]('Worker\x20stopped\x20with\x20exit\x20code:',_0x774f1e);else{}});});},bookIndexUtil['dealBookInfo']=async function(_0x18ffe8,_0xca8031){const _0x4d9567=_0x5d5671;let _0x4e2730=![];if(_0xca8031[_0x4d9567(0x173)]==0x1&&_0xca8031[_0x4d9567(0x193)]&&config['bookTypeList'][_0x4d9567(0x19c)](_0xca8031[_0x4d9567(0x193)]['toLowerCase']())){!_0xca8031[_0x4d9567(0x181)]&&(_0xca8031[_0x4d9567(0x181)]=bookIndexUtil['getBookType'](_0xca8031));let _0x9c1278=config['getMediaCoverCachePath'](_0xca8031);try{let _0x343850=await bookIndexUtil[_0x4d9567(0x160)](_0xca8031,_0x9c1278);if(_0x343850[_0x4d9567(0x19e)])try{let _0x1a7135=await bookIndexUtil[_0x4d9567(0x19f)](_0x343850['coverData'],_0x9c1278);_0x1a7135&&(console[_0x4d9567(0x17c)]('封面写入成功',_0x1a7135),_0x343850[_0x4d9567(0x183)]['coverPath']=_0x1a7135);}catch(_0x1988fa){console[_0x4d9567(0x17c)](_0x1988fa);}return console[_0x4d9567(0x17c)](_0x4d9567(0x163),_0x343850[_0x4d9567(0x183)][_0x4d9567(0x15e)],_0x343850[_0x4d9567(0x183)]['total_page']),bookIndexUtil[_0x4d9567(0x169)](_0x18ffe8,_0x343850[_0x4d9567(0x171)],_0x343850[_0x4d9567(0x183)]);}catch(_0x43c85){return console['log']('err\x205',_0x43c85),bookIndexUtil['addOriginalDate'](_0x18ffe8,_0x4e2730,_0xca8031);}}else{if(_0xca8031[_0x4d9567(0x173)]==0x1)return;return bookIndexUtil[_0x4d9567(0x169)](_0x18ffe8,_0x4e2730,_0xca8031);}},bookIndexUtil[_0x5d5671(0x175)]=function(_0x558a1b){const _0x32ddc7=_0x5d5671;let _0x2ebae3=[_0x32ddc7(0x1a3),'.cbr',_0x32ddc7(0x187),_0x32ddc7(0x172)];return _0x558a1b['ext']&&_0x2ebae3['includes'](_0x558a1b['ext'][_0x32ddc7(0x18b)]())?0x2:0x1;},bookIndexUtil[_0x5d5671(0x18e)]=function(_0x2b93c2){const _0x2f8040=_0x5d5671;let _0x3f5616=_0x2f8040(0x17b),_0x537eec='UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20'+_0x3f5616;_0x2b93c2[_0x2f8040(0x166)](_0x537eec)[_0x2f8040(0x16f)](),_0x537eec=_0x2f8040(0x18c)+_0x3f5616,_0x2b93c2[_0x2f8040(0x166)](_0x537eec)[_0x2f8040(0x16f)]();},bookIndexUtil[_0x5d5671(0x191)]=async function(_0x828171,_0x137932,_0x1c2265){const _0x145300=_0x5d5671;return await indexUtil[_0x145300(0x191)](_0x828171,_0x137932,indexTableName,_0x145300(0x199),_0x1c2265,bookIndexUtil[_0x145300(0x152)]);},bookIndexUtil[_0x5d5671(0x152)]=async function(_0x1f5094,_0x303ae1,_0x17b3db,_0x5aa66a,_0x1fd37d,_0x37533b){const _0x441b09=_0x5d5671;let _0x106bc6=indexUtil[_0x441b09(0x185)](_0x1f5094,_0x441b09(0x199),config,_0x17b3db,_0x5aa66a);if(!_0x106bc6)return;let _0x24507e=_0x37533b[_0x441b09(0x19b)];_0x37533b[_0x441b09(0x1a1)]<_0x24507e&&(_0x24507e=_0x37533b[_0x441b09(0x1a1)]);_0x37533b[_0x441b09(0x17e)]<_0x24507e&&(_0x24507e=_0x37533b['atimeMs']);_0x37533b['ctimeMs']<_0x24507e&&(_0x24507e=_0x37533b[_0x441b09(0x1a2)]);let _0x5abf6b={'path':_0x17b3db,'filename':_0x5aa66a,'is_file':_0x1fd37d,'ctime':_0x37533b[_0x441b09(0x1a2)],'mtime':_0x37533b[_0x441b09(0x1a1)],'ext':path['extname'](_0x5aa66a),'birthtime':Math[_0x441b09(0x15f)](_0x24507e),'size':_0x37533b[_0x441b09(0x184)],'check_time':new Date()[_0x441b09(0x15a)]()};_0x5abf6b=await bookIndexUtil['dealBookInfo'](_0x303ae1,_0x5abf6b);},bookIndexUtil['dealFileChange']=async function(_0x1b0397,_0x2e0dd2,_0x3a0128){const _0x571539=_0x5d5671;await indexUtil[_0x571539(0x176)](_0x1b0397,_0x2e0dd2,_0x3a0128,indexTableName,bookIndexUtil[_0x571539(0x152)],bookIndexUtil[_0x571539(0x191)]);return;},bookIndexUtil[_0x5d5671(0x169)]=function(_0x3fc96f,_0x149d3c,_0x5b4ca8){const _0x2458fa=_0x5d5671;nfoUtil[_0x2458fa(0x167)](_0x5b4ca8)[_0x2458fa(0x161)](_0x25788a=>{_0x1fa21b(_0x25788a);})['catch'](_0x269d7b=>{_0x1fa21b(_0x5b4ca8);});function _0x1fa21b(_0x2356ae){const _0xcf06f9=_0x2458fa;_0x149d3c&&_0x149d3c<config['exifMinTimeStamp']&&(_0x149d3c=![]);(!_0x149d3c||_0x149d3c==_0xcf06f9(0x198)||_0x149d3c=='Nan'||_0x149d3c==_0xcf06f9(0x198)||_0x149d3c==_0xcf06f9(0x168))&&(_0x149d3c=_0x2356ae[_0xcf06f9(0x165)]||_0x2356ae['ctime']);let _0x4d0b53=new Date(_0x149d3c);_0x2356ae[_0xcf06f9(0x197)]=_0x4d0b53[_0xcf06f9(0x15a)]();let _0x4bc2ea=_0x4d0b53[_0xcf06f9(0x19a)](),_0xcd879e=_0x4d0b53[_0xcf06f9(0x156)]()+0x1;_0xcd879e=_0xcd879e>=0xa?_0xcd879e:'0'+_0xcd879e;let _0x52a5f9=_0x4d0b53['getDate']();_0x52a5f9=_0x52a5f9>=0xa?_0x52a5f9:'0'+_0x52a5f9,_0x2356ae['original_date']=_0x4bc2ea+'-'+_0xcd879e+'-'+_0x52a5f9;let _0x13cb1c=dbFileIndexTable[_0xcf06f9(0x1a4)](_0x3fc96f,_0x2356ae,indexTableName);if(_0x13cb1c&&_0x13cb1c[_0xcf06f9(0x190)]){let _0x7f16be=dbFileIndexTable[_0xcf06f9(0x179)](_0x3fc96f,_0x13cb1c[_0xcf06f9(0x190)],dbFileIndexTable[_0xcf06f9(0x155)]);_0x7f16be&&bookIndexUtil[_0xcf06f9(0x195)](_0x3fc96f,_0x7f16be);}}},bookIndexUtil[_0x5d5671(0x1a0)]=function(_0xb4ab4f){const _0x460ddd=_0x5d5671;let _0x22d241=_0x460ddd(0x19d),_0x3b949e=_0xb4ab4f['prepare'](_0x22d241)[_0x460ddd(0x18d)]();for(let _0x3ee2e2 in _0x3b949e){bookIndexUtil[_0x460ddd(0x195)](_0xb4ab4f,_0x3b949e[_0x3ee2e2]);}};function isChinese(_0x4059f9){const _0x7358e3=_0x5d5671;var _0x451a38=/[^\\u4e00-\\u9fa5]/;return _0x451a38[_0x7358e3(0x186)](_0x4059f9);}function _0xe4a4(_0x3c6e9f,_0x21f9b0){const _0x2efd76=_0x2efd();return _0xe4a4=function(_0xe4a44e,_0x2e9b10){_0xe4a44e=_0xe4a44e-0x152;let _0x5f3f2c=_0x2efd76[_0xe4a44e];return _0x5f3f2c;},_0xe4a4(_0x3c6e9f,_0x21f9b0);}bookIndexUtil[_0x5d5671(0x195)]=function(_0x3e5cb0,_0x29b555){const _0x4ef3df=_0x5d5671;function _0x27d907(_0x47dbc6){const _0x13132f=_0xe4a4;if(_0x47dbc6&&_0x47dbc6[_0x13132f(0x182)]>0x0){let _0xf59bdb=_0x47dbc6[0x0];if(letterList[_0x13132f(0x19c)](_0xf59bdb))return _0xf59bdb;else{if(isChinese(_0xf59bdb)){let _0x5d1559=pinyin(_0xf59bdb,{'style':_0x13132f(0x192)});return _0x5d1559&&_0x5d1559[_0x13132f(0x182)]>0x0&&_0x5d1559[0x0][_0x13132f(0x182)]>0x0&&_0x5d1559[0x0][0x0][_0x13132f(0x182)]>0x0?_0x5d1559[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x55fc6b=_0x27d907(_0x29b555[_0x4ef3df(0x15e)]?_0x29b555[_0x4ef3df(0x15e)][_0x4ef3df(0x158)]():'')[_0x4ef3df(0x158)](),_0x2c2162=_0x27d907(_0x29b555[_0x4ef3df(0x188)]?_0x29b555['artist'][_0x4ef3df(0x158)]():'')[_0x4ef3df(0x158)](),_0x292e26=_0x27d907(_0x29b555[_0x4ef3df(0x15b)]?_0x29b555[_0x4ef3df(0x15b)][_0x4ef3df(0x158)]():'')[_0x4ef3df(0x158)]();_0x3e5cb0[_0x4ef3df(0x166)](_0x4ef3df(0x1a8))[_0x4ef3df(0x16f)](_0x55fc6b,_0x2c2162,_0x292e26,_0x29b555['id']);},module[_0x5d5671(0x16d)]=bookIndexUtil;