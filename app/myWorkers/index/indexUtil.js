const _0x30d6a7=_0x3664;(function(_0x5a2bfd,_0x2640b0){const _0x4cc6d8=_0x3664,_0x26c2c9=_0x5a2bfd();while(!![]){try{const _0x118ce1=-parseInt(_0x4cc6d8(0x1f0))/0x1*(-parseInt(_0x4cc6d8(0x1c7))/0x2)+-parseInt(_0x4cc6d8(0x1d1))/0x3+parseInt(_0x4cc6d8(0x1e8))/0x4+-parseInt(_0x4cc6d8(0x1b0))/0x5*(parseInt(_0x4cc6d8(0x1f9))/0x6)+-parseInt(_0x4cc6d8(0x1d5))/0x7*(-parseInt(_0x4cc6d8(0x1cf))/0x8)+-parseInt(_0x4cc6d8(0x1f4))/0x9*(-parseInt(_0x4cc6d8(0x1ee))/0xa)+parseInt(_0x4cc6d8(0x1c1))/0xb*(-parseInt(_0x4cc6d8(0x1f3))/0xc);if(_0x118ce1===_0x2640b0)break;else _0x26c2c9['push'](_0x26c2c9['shift']());}catch(_0x1c34e7){_0x26c2c9['push'](_0x26c2c9['shift']());}}}(_0x1004,0x8d5cd));function _0x1004(){const _0x5ae7c7=['push','prepare','948kcbluR','18jiZuKK','split','../../db/dbSourceFolderTable','length','Not\x20exist\x20','8904rPqgwY','来源目录已不存在\x20停止扫描','缓存数据目录内的变动，不处理','platform','pop','uploadTempFilePrefix','.qkdownloading','startsWith','文件夹已不存在\x20删除文件夹及文件夹下的索引','isDirectory','-indexing','filter','readdirSync','来源目录不存在了\x20不处理文件\x20','join','err','darwin','watchPath','3535KlpNXG','******New\x20folder******','exports','checkPathIsInPrivateSpace','get','FFmpeg','../../utils/transCodeUtil','ffprobeSync','/proc/','create','delete','耗时:','getByPath','linux','isForbiddenPath','code','path','59807wiLzhK','ffprobe','filename','is_file','mtime','dbnascab-journal','158hizrUn','******New\x20file******:','endsWith','sep','isFile','log','\x27\x20or\x20\x27','deleteByPathAndFileName','1832216qYBLbX','.bc!','812874pkclLv','dbnascab','SELECT\x20*\x20FROM\x20private_space\x20WHERE\x20folder_path=\x27','isPathIsInSourceFolder','14IxqweR','../../db/dbFileIndexTable','.td','replace','setIndexingState','getPathAllOnlyChild','isPathInHiddenDir','statSync','dbPath','dealFFmpegPath','../../myConfig/config','has','getTime','\x27\x20like\x20','nascabconfig','ENOENT','fileName','deletePathAll','filePath','2635540pxLRcI','`folder_path`||\x27','Not\x20in\x20source\x20folder\x20','.downloading','some','isForbiddenFilename','559960OXtyzw','getPathByType','13921rsfKcV'];_0x1004=function(){return _0x5ae7c7;};return _0x1004();}function _0x3664(_0x1a01ca,_0x17952d){const _0x10041f=_0x1004();return _0x3664=function(_0x3664a5,_0x47c3ce){_0x3664a5=_0x3664a5-0x1ad;let _0x458779=_0x10041f[_0x3664a5];return _0x458779;},_0x3664(_0x1a01ca,_0x17952d);}let indexUtil={};const currentPlatform=require('os')[_0x30d6a7(0x1fc)](),path=require('path'),dbSourceFolderTable=require(_0x30d6a7(0x1f6)),dbFileIndexTable=require(_0x30d6a7(0x1d6)),dbConfigTable=require('../../db/dbConfigTable'),config=require(_0x30d6a7(0x1df)),fs=require('fs');let FFmpeg=require('../../libs/nasTrans')[_0x30d6a7(0x1b5)];const transCodeUtil=require(_0x30d6a7(0x1b6));indexUtil['recursionFilesAddIndex']=async function(_0x3b6f98,_0x27e215,_0x57d79e,_0x16fd69,_0x17f09c,_0x5b33a0,_0x3bb779){const _0x3faa85=_0x30d6a7;let _0x5bc921=0x1,_0x177724=0x0;try{let _0x47e5c3=[{'path':_0x17f09c,'files':fs[_0x3faa85(0x205)](_0x17f09c)}];while(_0x47e5c3[_0x3faa85(0x1f7)]>0x0){let {path:_0x1a617a,files:_0x91c3da}=_0x47e5c3[_0x3faa85(0x1fd)]();if(indexUtil[_0x3faa85(0x1b3)](_0x3b6f98,_0x1a617a))continue;if(indexUtil['isPathInHiddenDir'](_0x1a617a)){console['log']('Skip\x20hidden\x20file/folder\x20'+_0x1a617a);continue;}for(let _0x40a5d8=0x0;_0x40a5d8<_0x91c3da[_0x3faa85(0x1f7)];_0x40a5d8++){let _0x35b295=_0x91c3da[_0x40a5d8];if(_0x35b295[_0x3faa85(0x200)](config[_0x3faa85(0x1fe)]))continue;if(!indexUtil[_0x3faa85(0x1d4)](_0x3b6f98,_0x16fd69,_0x17f09c))return console[_0x3faa85(0x1cc)](_0x3faa85(0x1fa),_0x17f09c),![];let _0x27e07c=path[_0x3faa85(0x207)](_0x1a617a,_0x35b295);try{let _0x15ff94=fs[_0x3faa85(0x1dc)](_0x27e07c),_0x34a42d=dbFileIndexTable[_0x3faa85(0x1bc)](_0x27e215,_0x1a617a,_0x35b295,_0x57d79e);if(_0x15ff94[_0x3faa85(0x1cb)]())!_0x34a42d&&await _0x5b33a0(_0x3b6f98,_0x27e215,_0x1a617a,_0x35b295,0x1,_0x15ff94),_0x177724+=0x1;else _0x15ff94['isDirectory']()&&(!_0x34a42d&&await _0x5b33a0(_0x3b6f98,_0x27e215,_0x1a617a,_0x35b295,0x0,_0x15ff94),_0x47e5c3['push']({'path':_0x27e07c,'files':fs['readdirSync'](_0x27e07c)}),_0x5bc921+=0x1);_0x3bb779&&_0x3bb779();}catch(_0x279873){console[_0x3faa85(0x1cc)](_0x3faa85(0x1ad),_0x279873);continue;}}}return{'checkFileCount':_0x177724,'checkPathCount':_0x5bc921};}catch(_0x547aaf){return console[_0x3faa85(0x1cc)]('error',_0x547aaf),{'checkFileCount':_0x177724,'checkPathCount':_0x5bc921};}},indexUtil['dealFileChange']=async function(_0x5262c0,_0x1e15a2,_0x3e6b79,_0x368214,_0x52660b,_0x3b99a4,_0x896611){const _0x5aa592=_0x30d6a7;let _0x36552b=_0x3e6b79[_0x5aa592(0x1af)],_0x421de2=_0x3e6b79[_0x5aa592(0x1e7)],_0x306bdb=_0x3e6b79[_0x5aa592(0x1e5)],_0x5380e7=_0x3e6b79['fullPath'];if(_0x306bdb['startsWith'](config[_0x5aa592(0x1fe)]))return;let _0x3a9fa9=dbSourceFolderTable['getByPath'](_0x1e15a2,_0x36552b);if(!_0x3a9fa9){console[_0x5aa592(0x1cc)](_0x5aa592(0x206),_0x36552b);return;}let _0x97c9be=dbFileIndexTable[_0x5aa592(0x1bc)](_0x5262c0,_0x421de2,_0x306bdb,_0x368214);try{let _0x9a2e5a=fs[_0x5aa592(0x1dc)](_0x5380e7);if(_0x9a2e5a['isFile']()&&!_0x97c9be)console['log'](_0x5aa592(0x1c8),_0x306bdb),await _0x52660b(_0x1e15a2,_0x5262c0,_0x421de2,_0x306bdb,0x1,_0x9a2e5a);else{if(_0x9a2e5a[_0x5aa592(0x202)]()&&!_0x97c9be)console[_0x5aa592(0x1cc)](_0x5aa592(0x1b1),_0x5380e7),await _0x52660b(_0x1e15a2,_0x5262c0,_0x421de2,_0x306bdb,0x0,_0x9a2e5a),await _0x3b99a4(_0x1e15a2,_0x5262c0,_0x5380e7);else{if(_0x9a2e5a&&_0x97c9be){if(_0x9a2e5a['mtimeMs']!=_0x97c9be[_0x5aa592(0x1c5)]){let _0x59e5c9=dbFileIndexTable[_0x5aa592(0x1ce)](_0x5262c0,_0x421de2,_0x306bdb,_0x368214);_0x896611&&_0x896611(_0x97c9be,_0x59e5c9),await _0x52660b(_0x1e15a2,_0x5262c0,_0x421de2,_0x306bdb,_0x9a2e5a[_0x5aa592(0x1cb)]()?0x1:0x0,_0x9a2e5a);}else{}}}}}catch(_0x5a7b87){console[_0x5aa592(0x1cc)]('文件已不存在',_0x421de2,_0x306bdb);try{if(_0x5a7b87[_0x5aa592(0x1bf)]==_0x5aa592(0x1e4)){if(_0x97c9be&&_0x97c9be[_0x5aa592(0x1c4)]==0x1){let _0x93cb8a=dbFileIndexTable[_0x5aa592(0x1ce)](_0x5262c0,_0x421de2,_0x306bdb,_0x368214);_0x896611&&_0x896611(_0x97c9be,_0x93cb8a);}else _0x97c9be&&_0x97c9be[_0x5aa592(0x1c4)]==0x0&&(dbFileIndexTable[_0x5aa592(0x1ce)](_0x5262c0,_0x421de2,_0x306bdb,_0x368214),dbFileIndexTable[_0x5aa592(0x1e6)](_0x5262c0,_0x5380e7,_0x368214));}else console[_0x5aa592(0x1cc)](_0x5a7b87);}catch(_0x3ba9ea){console[_0x5aa592(0x1cc)](_0x3ba9ea);}}return;},indexUtil[_0x30d6a7(0x1b7)]=function(_0x2a90f7){return new Promise((_0x42ede7,_0x128dca)=>{const _0x10bbf1=_0x3664;try{FFmpeg(transCodeUtil[_0x10bbf1(0x1de)](_0x2a90f7))[_0x10bbf1(0x1c2)]((_0x25dbec,_0x52318a)=>{_0x25dbec?_0x128dca(_0x25dbec):_0x42ede7(_0x52318a);});}catch(_0x1695d6){_0x128dca(_0x1695d6);}});},indexUtil[_0x30d6a7(0x1db)]=function(_0xd2bd2d){const _0x5d8879=_0x30d6a7;try{const _0x210f44=_0xd2bd2d[_0x5d8879(0x1f5)](/[\/\\]/)[_0x5d8879(0x204)](Boolean);return _0x210f44[_0x5d8879(0x1ec)](_0x207bc0=>_0x207bc0[_0x5d8879(0x200)]('.'));}catch(_0x15aa45){return![];}},indexUtil[_0x30d6a7(0x1d4)]=function(_0x105cd2,_0x497171,_0x1bdecb){const _0x289ad1=_0x30d6a7;let _0x2fa4f4=dbSourceFolderTable[_0x289ad1(0x1ef)](_0x105cd2,_0x497171);for(let _0x377d7e of _0x2fa4f4){if(_0x1bdecb==_0x377d7e['path']||_0x1bdecb['startsWith'](path[_0x289ad1(0x207)](_0x377d7e[_0x289ad1(0x1c0)],path[_0x289ad1(0x1ca)])))return _0x377d7e;}return![];},indexUtil[_0x30d6a7(0x1b3)]=function(_0xe37557,_0x5286f5){const _0x219bce=_0x30d6a7;if(_0x5286f5['endsWith'](path['join'](_0x219bce(0x1e3),path['sep'],_0x219bce(0x1c6)))||_0x5286f5[_0x219bce(0x1c9)](path[_0x219bce(0x207)](_0x219bce(0x1e3),path[_0x219bce(0x1ca)],'tiny'))||_0x5286f5[_0x219bce(0x1c9)](path[_0x219bce(0x207)]('nascabconfig',path['sep'],_0x219bce(0x1d2))))return!![];try{_0x5286f5=_0x5286f5[_0x219bce(0x1d8)](/\'/g,'\x27\x27');let _0xacfa8a=_0x219bce(0x1d3)+_0x5286f5+_0x219bce(0x1cd)+_0x5286f5+_0x219bce(0x1e2)+_0x219bce(0x1e9)+path['sep']+'%\x27',_0x50edbd=_0xe37557[_0x219bce(0x1f2)](_0xacfa8a)[_0x219bce(0x1b4)]();return _0x50edbd?!![]:![];}catch(_0x36d5ab){return![];}},indexUtil[_0x30d6a7(0x1be)]=function(_0x43e03d,_0x342ea9){const _0x56b147=_0x30d6a7;try{if(currentPlatform==_0x56b147(0x1bd)||currentPlatform==_0x56b147(0x1ae)){if(_0x342ea9['startsWith'](_0x56b147(0x1b8)))return!![];if(_0x342ea9=='/')return!![];}let _0x398203=path[_0x56b147(0x207)](_0x43e03d[_0x56b147(0x1dd)]),_0x335a57=path['join'](_0x43e03d['cacheParentPath']),_0x280de2=path[_0x56b147(0x207)](_0x335a57,path[_0x56b147(0x1ca)]),_0x3dadef=path[_0x56b147(0x207)](_0x398203);_0x342ea9=path[_0x56b147(0x207)](_0x342ea9);if(_0x342ea9==_0x398203||_0x342ea9==_0x335a57||_0x342ea9['startsWith'](_0x3dadef)||_0x342ea9['startsWith'](_0x280de2))return console['log'](_0x56b147(0x1fb),_0x342ea9),!![];return![];}catch(_0x382fc1){return console[_0x56b147(0x1cc)](_0x382fc1),![];}},indexUtil['isForbiddenFilename']=function(_0xe559f4){const _0x13f0a1=_0x30d6a7;try{if(_0xe559f4['startsWith']('.'))return!![];if(_0xe559f4[_0x13f0a1(0x1c9)]('.tmp')||_0xe559f4[_0x13f0a1(0x1c9)](_0x13f0a1(0x1d0))||_0xe559f4[_0x13f0a1(0x1c9)](_0x13f0a1(0x1d7))||_0xe559f4[_0x13f0a1(0x1c9)](_0x13f0a1(0x1ff))||_0xe559f4[_0x13f0a1(0x1c9)]('.xltd')||_0xe559f4['endsWith'](_0x13f0a1(0x1eb)))return!![];return![];}catch(_0x51db0b){return console[_0x13f0a1(0x1cc)](_0x51db0b),![];}},indexUtil[_0x30d6a7(0x1d9)]=function(_0x591bf0,_0x4e48de,_0x21897f){const _0x3746f2=_0x30d6a7;dbConfigTable[_0x3746f2(0x1b9)](_0x591bf0,{'title':_0x4e48de+_0x3746f2(0x203),'value':_0x21897f?'1':'0'});},indexUtil['doesPathCanAddToDb']=function(_0x880898,_0x3f2e98,_0x2fdf37,_0x5dbfcf,_0x1d44c4){const _0x40a3b3=_0x30d6a7;if(indexUtil[_0x40a3b3(0x1be)](_0x2fdf37,_0x5dbfcf))return![];if(indexUtil[_0x40a3b3(0x1ed)](_0x1d44c4))return![];if(!fs['existsSync'](path[_0x40a3b3(0x207)](_0x5dbfcf,_0x1d44c4)))return console[_0x40a3b3(0x1cc)](_0x40a3b3(0x1f8),_0x5dbfcf,_0x1d44c4),![];let _0xd830e9=indexUtil[_0x40a3b3(0x1d4)](_0x880898,_0x3f2e98,_0x5dbfcf);if(!_0xd830e9)return console[_0x40a3b3(0x1cc)](_0x40a3b3(0x1ea),_0x3f2e98,_0x5dbfcf,_0x1d44c4),![];return _0xd830e9;},indexUtil['recursionDeleteIndex']=async function(_0x3cba27,_0xbe9600,_0x3a41b2){const _0x2dbc1c=_0x30d6a7;let _0x2589f5=[_0x3a41b2],_0x12fc88=new Set([_0x3a41b2]),_0x5d5da6=new Date()[_0x2dbc1c(0x1e1)]();while(_0x2589f5['length']>0x0){let _0x4a8ae1=_0x2589f5[_0x2dbc1c(0x1fd)](),_0x10999b=dbFileIndexTable[_0x2dbc1c(0x1da)](_0x3cba27,_0x4a8ae1,_0xbe9600);for(let _0x4c5459=0x0;_0x4c5459<_0x10999b['length'];_0x4c5459++){let _0x1fb0bc=path[_0x2dbc1c(0x207)](_0x10999b[_0x4c5459][_0x2dbc1c(0x1c0)],_0x10999b[_0x4c5459]['filename']);try{let _0x2d5549=fs['statSync'](_0x1fb0bc);if(_0x2d5549[_0x2dbc1c(0x1cb)]()){}else _0x2d5549['isDirectory']()&&(!_0x12fc88[_0x2dbc1c(0x1e0)](_0x1fb0bc)&&(_0x2589f5[_0x2dbc1c(0x1f1)](_0x1fb0bc),_0x12fc88['add'](_0x1fb0bc)));}catch(_0xce34b5){_0xce34b5['code']==_0x2dbc1c(0x1e4)&&(_0x10999b[_0x4c5459][_0x2dbc1c(0x1c4)]==0x1?dbFileIndexTable[_0x2dbc1c(0x1ba)](_0x3cba27,_0x10999b[_0x4c5459]['id'],_0xbe9600):(console[_0x2dbc1c(0x1cc)](_0x2dbc1c(0x201),_0x1fb0bc),dbFileIndexTable[_0x2dbc1c(0x1ce)](_0x3cba27,_0x10999b[_0x4c5459][_0x2dbc1c(0x1c0)],_0x10999b[_0x4c5459][_0x2dbc1c(0x1c3)],_0xbe9600),dbFileIndexTable[_0x2dbc1c(0x1e6)](_0x3cba27,_0x1fb0bc,_0xbe9600)));}}}console['log']('索引状态比对',_0x3a41b2,_0x2dbc1c(0x1bb),new Date()[_0x2dbc1c(0x1e1)]()-_0x5d5da6,'ms');},module[_0x30d6a7(0x1b2)]=indexUtil;