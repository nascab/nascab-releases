const _0x35bc32=_0x2706;(function(_0x89508b,_0x45d8a9){const _0x5d352b=_0x2706,_0x2ef46f=_0x89508b();while(!![]){try{const _0x5c5a92=parseInt(_0x5d352b(0x1fa))/0x1+-parseInt(_0x5d352b(0x1e8))/0x2+parseInt(_0x5d352b(0x1f4))/0x3+-parseInt(_0x5d352b(0x212))/0x4+-parseInt(_0x5d352b(0x1d3))/0x5*(parseInt(_0x5d352b(0x1f2))/0x6)+parseInt(_0x5d352b(0x1dd))/0x7+-parseInt(_0x5d352b(0x20f))/0x8*(parseInt(_0x5d352b(0x219))/0x9);if(_0x5c5a92===_0x45d8a9)break;else _0x2ef46f['push'](_0x2ef46f['shift']());}catch(_0x378a11){_0x2ef46f['push'](_0x2ef46f['shift']());}}}(_0x1dc7,0xac5aa));function _0x1dc7(){const _0x120555=['exports','isForbiddenPath','../../myConfig/config','mtimeMs','get','ENOENT','isFile','prepare','10xYgnRE','uploadTempFilePrefix','join','dealFFmpegPath','recursionFilesAddIndex','filename','`folder_path`||\x27','setIndexingState','push','.downloading','7084644jBodxQ','isForbiddenFilename','pop','deleteByPathAndFileName','log','/proc/','watchPath','checkPathIsInPrivateSpace','length','nascabconfig','code','563796pgjAmT','FFmpeg','-indexing','endsWith','tiny','sep','getByPath','add','replace','\x27\x20or\x20\x27','2445648lCQqpz','startsWith','3131151DHtlPT','delete','path','platform','dbnascab-journal','isDirectory','877730qgfmeY','doesPathCanAddToDb','******New\x20file******:','getPathAllOnlyChild','readdirSync','deletePathAll','文件夹已不存在\x20删除文件夹及文件夹下的索引','err','error','.qkdownloading','来源目录不存在了\x20不处理文件\x20','../../db/dbSourceFolderTable','isPathIsInSourceFolder','is_file','Skip\x20hidden\x20file/folder\x20','mtime','statSync','../../db/dbFileIndexTable','some','.td','darwin','48PFgaKG','缓存数据目录内的变动，不处理','getTime','1322964ZDkjCW','ffprobeSync','has','recursionDeleteIndex','isPathInHiddenDir','split','../../utils/transCodeUtil','1199583yhGLEK'];_0x1dc7=function(){return _0x120555;};return _0x1dc7();}let indexUtil={};const currentPlatform=require('os')[_0x35bc32(0x1f7)](),path=require(_0x35bc32(0x1f6)),dbSourceFolderTable=require(_0x35bc32(0x205)),dbFileIndexTable=require(_0x35bc32(0x20b)),dbConfigTable=require('../../db/dbConfigTable'),config=require(_0x35bc32(0x21c)),fs=require('fs');let FFmpeg=require('../../libs/nasTrans')[_0x35bc32(0x1e9)];const transCodeUtil=require(_0x35bc32(0x218));function _0x2706(_0x2d851b,_0x23f162){const _0x1dc721=_0x1dc7();return _0x2706=function(_0x270682,_0x241a4d){_0x270682=_0x270682-0x1d2;let _0x2cc333=_0x1dc721[_0x270682];return _0x2cc333;},_0x2706(_0x2d851b,_0x23f162);}indexUtil[_0x35bc32(0x1d7)]=async function(_0x4da35e,_0x5a66f5,_0x1b2607,_0x53c151,_0x3964cc,_0x29cbdc,_0x135b94){const _0x5e241f=_0x35bc32;let _0x2004e8=0x1,_0x33e850=0x0;try{let _0x26956e=[{'path':_0x3964cc,'files':fs[_0x5e241f(0x1fe)](_0x3964cc)}];while(_0x26956e[_0x5e241f(0x1e5)]>0x0){let {path:_0x36dc06,files:_0x371fa4}=_0x26956e[_0x5e241f(0x1df)]();if(indexUtil['checkPathIsInPrivateSpace'](_0x4da35e,_0x36dc06))continue;if(indexUtil[_0x5e241f(0x216)](_0x36dc06)){console['log'](_0x5e241f(0x208)+_0x36dc06);continue;}for(let _0xfa9e12=0x0;_0xfa9e12<_0x371fa4['length'];_0xfa9e12++){let _0x4968be=_0x371fa4[_0xfa9e12];if(_0x4968be[_0x5e241f(0x1f3)](config[_0x5e241f(0x1d4)]))continue;if(!indexUtil[_0x5e241f(0x206)](_0x4da35e,_0x53c151,_0x3964cc))return console[_0x5e241f(0x1e1)]('来源目录已不存在\x20停止扫描',_0x3964cc),![];let _0xf0f7be=path['join'](_0x36dc06,_0x4968be);try{let _0x147b6a=fs[_0x5e241f(0x20a)](_0xf0f7be),_0x2c03ba=dbFileIndexTable['getByPath'](_0x5a66f5,_0x36dc06,_0x4968be,_0x1b2607);if(_0x147b6a['isFile']())!_0x2c03ba&&await _0x29cbdc(_0x4da35e,_0x5a66f5,_0x36dc06,_0x4968be,0x1,_0x147b6a),_0x33e850+=0x1;else _0x147b6a[_0x5e241f(0x1f9)]()&&(!_0x2c03ba&&await _0x29cbdc(_0x4da35e,_0x5a66f5,_0x36dc06,_0x4968be,0x0,_0x147b6a),_0x26956e[_0x5e241f(0x1db)]({'path':_0xf0f7be,'files':fs[_0x5e241f(0x1fe)](_0xf0f7be)}),_0x2004e8+=0x1);_0x135b94&&_0x135b94();}catch(_0x4f1039){console[_0x5e241f(0x1e1)](_0x5e241f(0x201),_0x4f1039);continue;}}}return{'checkFileCount':_0x33e850,'checkPathCount':_0x2004e8};}catch(_0x1e617d){return console['log'](_0x5e241f(0x202),_0x1e617d),{'checkFileCount':_0x33e850,'checkPathCount':_0x2004e8};}},indexUtil['dealFileChange']=async function(_0x34c71a,_0x47a58e,_0x109835,_0x6595fb,_0x4af742,_0x1dc60f,_0x28c2e7){const _0x2ecec4=_0x35bc32;let _0x1385af=_0x109835[_0x2ecec4(0x1e3)],_0x1d663a=_0x109835['filePath'],_0xa9c3d5=_0x109835['fileName'],_0x4b32df=_0x109835['fullPath'];if(_0xa9c3d5['startsWith'](config[_0x2ecec4(0x1d4)]))return;let _0x465111=dbSourceFolderTable[_0x2ecec4(0x1ee)](_0x47a58e,_0x1385af);if(!_0x465111){console['log'](_0x2ecec4(0x204),_0x1385af);return;}let _0x5161d6=dbFileIndexTable[_0x2ecec4(0x1ee)](_0x34c71a,_0x1d663a,_0xa9c3d5,_0x6595fb);try{let _0x1eadc2=fs[_0x2ecec4(0x20a)](_0x4b32df);if(_0x1eadc2[_0x2ecec4(0x220)]()&&!_0x5161d6)console[_0x2ecec4(0x1e1)](_0x2ecec4(0x1fc),_0xa9c3d5),await _0x4af742(_0x47a58e,_0x34c71a,_0x1d663a,_0xa9c3d5,0x1,_0x1eadc2);else{if(_0x1eadc2[_0x2ecec4(0x1f9)]()&&!_0x5161d6)console[_0x2ecec4(0x1e1)]('******New\x20folder******',_0x4b32df),await _0x4af742(_0x47a58e,_0x34c71a,_0x1d663a,_0xa9c3d5,0x0,_0x1eadc2),await _0x1dc60f(_0x47a58e,_0x34c71a,_0x4b32df);else{if(_0x1eadc2&&_0x5161d6){if(_0x1eadc2[_0x2ecec4(0x21d)]!=_0x5161d6[_0x2ecec4(0x209)]){let _0x57a8de=dbFileIndexTable[_0x2ecec4(0x1e0)](_0x34c71a,_0x1d663a,_0xa9c3d5,_0x6595fb);_0x28c2e7&&_0x28c2e7(_0x5161d6,_0x57a8de),await _0x4af742(_0x47a58e,_0x34c71a,_0x1d663a,_0xa9c3d5,_0x1eadc2[_0x2ecec4(0x220)]()?0x1:0x0,_0x1eadc2);}else{}}}}}catch(_0x59c482){console['log']('文件已不存在',_0x1d663a,_0xa9c3d5);try{if(_0x59c482[_0x2ecec4(0x1e7)]==_0x2ecec4(0x21f)){if(_0x5161d6&&_0x5161d6[_0x2ecec4(0x207)]==0x1){let _0x34ea5d=dbFileIndexTable[_0x2ecec4(0x1e0)](_0x34c71a,_0x1d663a,_0xa9c3d5,_0x6595fb);_0x28c2e7&&_0x28c2e7(_0x5161d6,_0x34ea5d);}else _0x5161d6&&_0x5161d6[_0x2ecec4(0x207)]==0x0&&(dbFileIndexTable[_0x2ecec4(0x1e0)](_0x34c71a,_0x1d663a,_0xa9c3d5,_0x6595fb),dbFileIndexTable[_0x2ecec4(0x1ff)](_0x34c71a,_0x4b32df,_0x6595fb));}else console[_0x2ecec4(0x1e1)](_0x59c482);}catch(_0xea77d9){console[_0x2ecec4(0x1e1)](_0xea77d9);}}return;},indexUtil[_0x35bc32(0x213)]=function(_0x1d30fb){return new Promise((_0x3ae942,_0xe6a19c)=>{const _0x3fc55b=_0x2706;try{FFmpeg(transCodeUtil[_0x3fc55b(0x1d6)](_0x1d30fb))['ffprobe']((_0x16bc1b,_0x1dfbbb)=>{_0x16bc1b?_0xe6a19c(_0x16bc1b):_0x3ae942(_0x1dfbbb);});}catch(_0x23b58c){_0xe6a19c(_0x23b58c);}});},indexUtil['isPathInHiddenDir']=function(_0x192a64){const _0xbc0a21=_0x35bc32;try{const _0x289569=_0x192a64[_0xbc0a21(0x217)](/[\/\\]/)['filter'](Boolean);return _0x289569[_0xbc0a21(0x20c)](_0x52db95=>_0x52db95[_0xbc0a21(0x1f3)]('.'));}catch(_0x3bca45){return![];}},indexUtil[_0x35bc32(0x206)]=function(_0x4b6123,_0x2ec04c,_0x471d33){const _0x741b1d=_0x35bc32;let _0x543e50=dbSourceFolderTable['getPathByType'](_0x4b6123,_0x2ec04c);for(let _0x4e1c11 of _0x543e50){if(_0x471d33==_0x4e1c11[_0x741b1d(0x1f6)]||_0x471d33[_0x741b1d(0x1f3)](path[_0x741b1d(0x1d5)](_0x4e1c11[_0x741b1d(0x1f6)],path[_0x741b1d(0x1ed)])))return _0x4e1c11;}return![];},indexUtil[_0x35bc32(0x1e4)]=function(_0x11b2e1,_0x16dcef){const _0xcc8fa9=_0x35bc32;if(_0x16dcef['endsWith'](path[_0xcc8fa9(0x1d5)](_0xcc8fa9(0x1e6),path[_0xcc8fa9(0x1ed)],_0xcc8fa9(0x1f8)))||_0x16dcef['endsWith'](path['join']('nascabconfig',path['sep'],_0xcc8fa9(0x1ec)))||_0x16dcef['endsWith'](path['join'](_0xcc8fa9(0x1e6),path[_0xcc8fa9(0x1ed)],'dbnascab')))return!![];try{_0x16dcef=_0x16dcef[_0xcc8fa9(0x1f0)](/\'/g,'\x27\x27');let _0x2be6b3='SELECT\x20*\x20FROM\x20private_space\x20WHERE\x20folder_path=\x27'+_0x16dcef+_0xcc8fa9(0x1f1)+_0x16dcef+'\x27\x20like\x20'+_0xcc8fa9(0x1d9)+path[_0xcc8fa9(0x1ed)]+'%\x27',_0x579dac=_0x11b2e1[_0xcc8fa9(0x1d2)](_0x2be6b3)[_0xcc8fa9(0x21e)]();return _0x579dac?!![]:![];}catch(_0x2b631b){return![];}},indexUtil['isForbiddenPath']=function(_0x22f460,_0x54fcb4){const _0x22aa9a=_0x35bc32;try{if(currentPlatform=='linux'||currentPlatform==_0x22aa9a(0x20e)){if(_0x54fcb4['startsWith'](_0x22aa9a(0x1e2)))return!![];if(_0x54fcb4=='/')return!![];}let _0x370dc6=path[_0x22aa9a(0x1d5)](_0x22f460['dbPath']),_0x93bb4a=path[_0x22aa9a(0x1d5)](_0x22f460['cacheParentPath']),_0x540c31=path[_0x22aa9a(0x1d5)](_0x93bb4a,path[_0x22aa9a(0x1ed)]),_0x522937=path['join'](_0x370dc6);_0x54fcb4=path[_0x22aa9a(0x1d5)](_0x54fcb4);if(_0x54fcb4==_0x370dc6||_0x54fcb4==_0x93bb4a||_0x54fcb4['startsWith'](_0x522937)||_0x54fcb4[_0x22aa9a(0x1f3)](_0x540c31))return console['log'](_0x22aa9a(0x210),_0x54fcb4),!![];return![];}catch(_0x57f4f4){return console[_0x22aa9a(0x1e1)](_0x57f4f4),![];}},indexUtil[_0x35bc32(0x1de)]=function(_0x32c7b5){const _0x1400d7=_0x35bc32;try{if(_0x32c7b5['startsWith']('.'))return!![];if(_0x32c7b5[_0x1400d7(0x1eb)]('.tmp')||_0x32c7b5[_0x1400d7(0x1eb)]('.bc!')||_0x32c7b5[_0x1400d7(0x1eb)](_0x1400d7(0x20d))||_0x32c7b5['endsWith'](_0x1400d7(0x203))||_0x32c7b5[_0x1400d7(0x1eb)]('.xltd')||_0x32c7b5[_0x1400d7(0x1eb)](_0x1400d7(0x1dc)))return!![];return![];}catch(_0x8e0a8b){return console[_0x1400d7(0x1e1)](_0x8e0a8b),![];}},indexUtil[_0x35bc32(0x1da)]=function(_0x5b70b0,_0x308153,_0xa943ba){const _0x43729d=_0x35bc32;dbConfigTable['create'](_0x5b70b0,{'title':_0x308153+_0x43729d(0x1ea),'value':_0xa943ba?'1':'0'});},indexUtil[_0x35bc32(0x1fb)]=function(_0x19ac79,_0x2c20c3,_0x5ea479,_0x12f639,_0x20fb8f){const _0x515b58=_0x35bc32;if(indexUtil[_0x515b58(0x21b)](_0x5ea479,_0x12f639))return![];if(indexUtil['isForbiddenFilename'](_0x20fb8f))return![];if(!fs['existsSync'](path[_0x515b58(0x1d5)](_0x12f639,_0x20fb8f)))return console[_0x515b58(0x1e1)]('Not\x20exist\x20',_0x12f639,_0x20fb8f),![];let _0x128c5d=indexUtil[_0x515b58(0x206)](_0x19ac79,_0x2c20c3,_0x12f639);if(!_0x128c5d)return console[_0x515b58(0x1e1)]('Not\x20in\x20source\x20folder\x20',_0x2c20c3,_0x12f639,_0x20fb8f),![];return _0x128c5d;},indexUtil[_0x35bc32(0x215)]=async function(_0x9c692,_0x3cc9d7,_0x2fe190){const _0x3359db=_0x35bc32;let _0x5ef6ba=[_0x2fe190],_0x1ef116=new Set([_0x2fe190]),_0x42232f=new Date()[_0x3359db(0x211)]();while(_0x5ef6ba[_0x3359db(0x1e5)]>0x0){let _0x5a1d30=_0x5ef6ba[_0x3359db(0x1df)](),_0x2d75fb=dbFileIndexTable[_0x3359db(0x1fd)](_0x9c692,_0x5a1d30,_0x3cc9d7);for(let _0x45699d=0x0;_0x45699d<_0x2d75fb['length'];_0x45699d++){let _0x62bfcb=path['join'](_0x2d75fb[_0x45699d][_0x3359db(0x1f6)],_0x2d75fb[_0x45699d][_0x3359db(0x1d8)]);try{let _0x151043=fs[_0x3359db(0x20a)](_0x62bfcb);if(_0x151043[_0x3359db(0x220)]()){}else _0x151043['isDirectory']()&&(!_0x1ef116[_0x3359db(0x214)](_0x62bfcb)&&(_0x5ef6ba[_0x3359db(0x1db)](_0x62bfcb),_0x1ef116[_0x3359db(0x1ef)](_0x62bfcb)));}catch(_0x57f795){_0x57f795['code']==_0x3359db(0x21f)&&(_0x2d75fb[_0x45699d]['is_file']==0x1?dbFileIndexTable[_0x3359db(0x1f5)](_0x9c692,_0x2d75fb[_0x45699d]['id'],_0x3cc9d7):(console[_0x3359db(0x1e1)](_0x3359db(0x200),_0x62bfcb),dbFileIndexTable[_0x3359db(0x1e0)](_0x9c692,_0x2d75fb[_0x45699d][_0x3359db(0x1f6)],_0x2d75fb[_0x45699d][_0x3359db(0x1d8)],_0x3cc9d7),dbFileIndexTable[_0x3359db(0x1ff)](_0x9c692,_0x62bfcb,_0x3cc9d7)));}}}console[_0x3359db(0x1e1)]('索引状态比对',_0x2fe190,'耗时:',new Date()['getTime']()-_0x42232f,'ms');},module[_0x35bc32(0x21a)]=indexUtil;