const _0x4ad30b=_0x4bc8;(function(_0x6147ac,_0x5c9231){const _0x1769b9=_0x4bc8,_0x390915=_0x6147ac();while(!![]){try{const _0x3fb42b=-parseInt(_0x1769b9(0xdf))/0x1*(parseInt(_0x1769b9(0x108))/0x2)+-parseInt(_0x1769b9(0xd4))/0x3+parseInt(_0x1769b9(0xf7))/0x4*(-parseInt(_0x1769b9(0xf6))/0x5)+parseInt(_0x1769b9(0x112))/0x6*(parseInt(_0x1769b9(0x114))/0x7)+-parseInt(_0x1769b9(0xdc))/0x8*(parseInt(_0x1769b9(0xe3))/0x9)+parseInt(_0x1769b9(0xfa))/0xa+-parseInt(_0x1769b9(0xd6))/0xb*(-parseInt(_0x1769b9(0xf8))/0xc);if(_0x3fb42b===_0x5c9231)break;else _0x390915['push'](_0x390915['shift']());}catch(_0x1c6c86){_0x390915['push'](_0x390915['shift']());}}}(_0x1783,0xcf223));let indexUtil={};function _0x1783(){const _0x366968=['dbnascab-journal','5570140scqMJu','recursionFilesAddIndex','.tmp','deletePathAll','code','******New\x20folder******','statSync','filename','******New\x20file******:','ENOENT','create','log','add','join','62EwtVgY','readdirSync','isForbiddenFilename','startsWith','SELECT\x20*\x20FROM\x20private_space\x20WHERE\x20folder_path=\x27','push','.downloading','has','get','.xltd','48mRzPiL','Not\x20exist\x20','528794eeFBhE','split','delete','fullPath','../../db/dbConfigTable','pop','isPathInHiddenDir','doesPathCanAddToDb','缓存数据目录内的变动，不处理','is_file','FFmpeg','cacheParentPath','isDirectory','uploadTempFilePrefix','length','filePath','来源目录已不存在\x20停止扫描','setIndexingState','some','2105619MptAWd','sep','2519CFTWMT','isFile','\x27\x20like\x20','replace','getTime','existsSync','40VfeASi','tiny','../../myConfig/config','51298wnYoOe','exports','来源目录不存在了\x20不处理文件\x20','path','628146XMiUGm','Skip\x20hidden\x20file/folder\x20','checkPathIsInPrivateSpace','mtime','deleteByPathAndFileName','getByPath','dealFFmpegPath','endsWith','\x27\x20or\x20\x27','-indexing','isPathIsInSourceFolder','isForbiddenPath','/proc/','getPathByType','../../db/dbSourceFolderTable','watchPath','ffprobeSync','.qkdownloading','nascabconfig','5quzMDg','2730052HWlLFF','157764oHyBhV'];_0x1783=function(){return _0x366968;};return _0x1783();}const currentPlatform=require('os')['platform'](),path=require('path'),dbSourceFolderTable=require(_0x4ad30b(0xf1)),dbFileIndexTable=require('../../db/dbFileIndexTable'),dbConfigTable=require(_0x4ad30b(0x118)),config=require(_0x4ad30b(0xde)),fs=require('fs');let FFmpeg=require('../../libs/nasTrans')[_0x4ad30b(0x11e)];const transCodeUtil=require('../../utils/transCodeUtil');function _0x4bc8(_0x24b3e2,_0x506015){const _0x17837e=_0x1783();return _0x4bc8=function(_0x4bc840,_0xd277ff){_0x4bc840=_0x4bc840-0xd3;let _0x3b6143=_0x17837e[_0x4bc840];return _0x3b6143;},_0x4bc8(_0x24b3e2,_0x506015);}indexUtil[_0x4ad30b(0xfb)]=async function(_0x3f6c5c,_0x13ebca,_0x55a78d,_0x481aee,_0x3b664c,_0x3821fd,_0x1a6615){const _0x1293fb=_0x4ad30b;let _0x214cf4=0x1,_0x823285=0x0;try{let _0x5e86ab=[{'path':_0x3b664c,'files':fs['readdirSync'](_0x3b664c)}];while(_0x5e86ab[_0x1293fb(0x122)]>0x0){let {path:_0x63f8d3,files:_0x2376f5}=_0x5e86ab[_0x1293fb(0x119)]();if(indexUtil[_0x1293fb(0xe5)](_0x3f6c5c,_0x63f8d3))continue;if(indexUtil[_0x1293fb(0x11a)](_0x63f8d3)){console['log'](_0x1293fb(0xe4)+_0x63f8d3);continue;}for(let _0x44e370=0x0;_0x44e370<_0x2376f5['length'];_0x44e370++){let _0x4baabd=_0x2376f5[_0x44e370];if(_0x4baabd[_0x1293fb(0x10b)](config[_0x1293fb(0x121)]))continue;if(!indexUtil[_0x1293fb(0xed)](_0x3f6c5c,_0x481aee,_0x3b664c))return console[_0x1293fb(0x105)](_0x1293fb(0x124),_0x3b664c),![];let _0xf44b=path[_0x1293fb(0x107)](_0x63f8d3,_0x4baabd);try{let _0x53a80f=fs[_0x1293fb(0x100)](_0xf44b),_0x334745=dbFileIndexTable['getByPath'](_0x13ebca,_0x63f8d3,_0x4baabd,_0x55a78d);if(_0x53a80f[_0x1293fb(0xd7)]())!_0x334745&&await _0x3821fd(_0x3f6c5c,_0x13ebca,_0x63f8d3,_0x4baabd,0x1,_0x53a80f),_0x823285+=0x1;else _0x53a80f[_0x1293fb(0x120)]()&&(!_0x334745&&await _0x3821fd(_0x3f6c5c,_0x13ebca,_0x63f8d3,_0x4baabd,0x0,_0x53a80f),_0x5e86ab[_0x1293fb(0x10d)]({'path':_0xf44b,'files':fs[_0x1293fb(0x109)](_0xf44b)}),_0x214cf4+=0x1);_0x1a6615&&_0x1a6615();}catch(_0x34f63d){console[_0x1293fb(0x105)]('err',_0x34f63d);continue;}}}return{'checkFileCount':_0x823285,'checkPathCount':_0x214cf4};}catch(_0x1eb9f4){return console[_0x1293fb(0x105)]('error',_0x1eb9f4),{'checkFileCount':_0x823285,'checkPathCount':_0x214cf4};}},indexUtil['dealFileChange']=async function(_0x2d8287,_0x4b9c67,_0x53e534,_0x24ff20,_0x1cd817,_0x17ccfa,_0x4f4364){const _0x21fbc3=_0x4ad30b;let _0x29c7ec=_0x53e534[_0x21fbc3(0xf2)],_0xb9d6e9=_0x53e534[_0x21fbc3(0x123)],_0x323f25=_0x53e534['fileName'],_0x186143=_0x53e534[_0x21fbc3(0x117)];if(_0x323f25[_0x21fbc3(0x10b)](config[_0x21fbc3(0x121)]))return;let _0x102417=dbSourceFolderTable[_0x21fbc3(0xe8)](_0x4b9c67,_0x29c7ec);if(!_0x102417){console['log'](_0x21fbc3(0xe1),_0x29c7ec);return;}let _0x4886a4=dbFileIndexTable['getByPath'](_0x2d8287,_0xb9d6e9,_0x323f25,_0x24ff20);try{let _0x13bc7a=fs[_0x21fbc3(0x100)](_0x186143);if(_0x13bc7a[_0x21fbc3(0xd7)]()&&!_0x4886a4)console[_0x21fbc3(0x105)](_0x21fbc3(0x102),_0x323f25),await _0x1cd817(_0x4b9c67,_0x2d8287,_0xb9d6e9,_0x323f25,0x1,_0x13bc7a);else{if(_0x13bc7a['isDirectory']()&&!_0x4886a4)console[_0x21fbc3(0x105)](_0x21fbc3(0xff),_0x186143),await _0x1cd817(_0x4b9c67,_0x2d8287,_0xb9d6e9,_0x323f25,0x0,_0x13bc7a),await _0x17ccfa(_0x4b9c67,_0x2d8287,_0x186143);else{if(_0x13bc7a&&_0x4886a4){if(_0x13bc7a['mtimeMs']!=_0x4886a4[_0x21fbc3(0xe6)]){let _0x3856ac=dbFileIndexTable[_0x21fbc3(0xe7)](_0x2d8287,_0xb9d6e9,_0x323f25,_0x24ff20);_0x4f4364&&_0x4f4364(_0x4886a4,_0x3856ac),await _0x1cd817(_0x4b9c67,_0x2d8287,_0xb9d6e9,_0x323f25,_0x13bc7a[_0x21fbc3(0xd7)]()?0x1:0x0,_0x13bc7a);}else{}}}}}catch(_0x14de14){console[_0x21fbc3(0x105)]('文件已不存在',_0xb9d6e9,_0x323f25);try{if(_0x14de14['code']=='ENOENT'){if(_0x4886a4&&_0x4886a4['is_file']==0x1){let _0x2b056f=dbFileIndexTable[_0x21fbc3(0xe7)](_0x2d8287,_0xb9d6e9,_0x323f25,_0x24ff20);_0x4f4364&&_0x4f4364(_0x4886a4,_0x2b056f);}else _0x4886a4&&_0x4886a4[_0x21fbc3(0x11d)]==0x0&&(dbFileIndexTable[_0x21fbc3(0xe7)](_0x2d8287,_0xb9d6e9,_0x323f25,_0x24ff20),dbFileIndexTable[_0x21fbc3(0xfd)](_0x2d8287,_0x186143,_0x24ff20));}else console[_0x21fbc3(0x105)](_0x14de14);}catch(_0x154eff){console['log'](_0x154eff);}}return;},indexUtil[_0x4ad30b(0xf3)]=function(_0x108502){return new Promise((_0x534cc0,_0x4df893)=>{const _0x1ede92=_0x4bc8;try{FFmpeg(transCodeUtil[_0x1ede92(0xe9)](_0x108502))['ffprobe']((_0xb4798b,_0x4fee2d)=>{_0xb4798b?_0x4df893(_0xb4798b):_0x534cc0(_0x4fee2d);});}catch(_0x372198){_0x4df893(_0x372198);}});},indexUtil[_0x4ad30b(0x11a)]=function(_0x4876d2){const _0x37339f=_0x4ad30b;try{const _0xcfd235=_0x4876d2[_0x37339f(0x115)](/[\/\\]/)['filter'](Boolean);return _0xcfd235[_0x37339f(0xd3)](_0x4b0e82=>_0x4b0e82[_0x37339f(0x10b)]('.'));}catch(_0x4fe10a){return![];}},indexUtil[_0x4ad30b(0xed)]=function(_0x5cf150,_0x509443,_0x13c7b9){const _0x3c4c44=_0x4ad30b;let _0x2e63cb=dbSourceFolderTable[_0x3c4c44(0xf0)](_0x5cf150,_0x509443);for(let _0x38787b of _0x2e63cb){if(_0x13c7b9==_0x38787b[_0x3c4c44(0xe2)]||_0x13c7b9['startsWith'](path[_0x3c4c44(0x107)](_0x38787b[_0x3c4c44(0xe2)],path['sep'])))return _0x38787b;}return![];},indexUtil[_0x4ad30b(0xe5)]=function(_0x59aaed,_0x49e86a){const _0x524bf3=_0x4ad30b;if(_0x49e86a[_0x524bf3(0xea)](path[_0x524bf3(0x107)](_0x524bf3(0xf5),path[_0x524bf3(0xd5)],_0x524bf3(0xf9)))||_0x49e86a[_0x524bf3(0xea)](path[_0x524bf3(0x107)](_0x524bf3(0xf5),path['sep'],_0x524bf3(0xdd)))||_0x49e86a[_0x524bf3(0xea)](path[_0x524bf3(0x107)]('nascabconfig',path['sep'],'dbnascab')))return!![];try{_0x49e86a=_0x49e86a[_0x524bf3(0xd9)](/\'/g,'\x27\x27');let _0x48e014=_0x524bf3(0x10c)+_0x49e86a+_0x524bf3(0xeb)+_0x49e86a+_0x524bf3(0xd8)+'`folder_path`||\x27'+path[_0x524bf3(0xd5)]+'%\x27',_0x2486f5=_0x59aaed['prepare'](_0x48e014)[_0x524bf3(0x110)]();return _0x2486f5?!![]:![];}catch(_0x511500){return![];}},indexUtil[_0x4ad30b(0xee)]=function(_0x179f6f,_0x38d3da){const _0x264de2=_0x4ad30b;try{if(currentPlatform=='linux'||currentPlatform=='darwin'){if(_0x38d3da[_0x264de2(0x10b)](_0x264de2(0xef)))return!![];if(_0x38d3da=='/')return!![];}let _0x58ba91=path[_0x264de2(0x107)](_0x179f6f['dbPath']),_0x354479=path[_0x264de2(0x107)](_0x179f6f[_0x264de2(0x11f)]),_0x157e0d=path[_0x264de2(0x107)](_0x354479,path['sep']),_0x500e4e=path[_0x264de2(0x107)](_0x58ba91);_0x38d3da=path['join'](_0x38d3da);if(_0x38d3da==_0x58ba91||_0x38d3da==_0x354479||_0x38d3da['startsWith'](_0x500e4e)||_0x38d3da[_0x264de2(0x10b)](_0x157e0d))return console['log'](_0x264de2(0x11c),_0x38d3da),!![];return![];}catch(_0x9ab90a){return console[_0x264de2(0x105)](_0x9ab90a),![];}},indexUtil[_0x4ad30b(0x10a)]=function(_0x4a425d){const _0x1dcf2b=_0x4ad30b;try{if(_0x4a425d['startsWith']('.'))return!![];if(_0x4a425d[_0x1dcf2b(0xea)](_0x1dcf2b(0xfc))||_0x4a425d['endsWith']('.bc!')||_0x4a425d['endsWith']('.td')||_0x4a425d[_0x1dcf2b(0xea)](_0x1dcf2b(0xf4))||_0x4a425d[_0x1dcf2b(0xea)](_0x1dcf2b(0x111))||_0x4a425d[_0x1dcf2b(0xea)](_0x1dcf2b(0x10e)))return!![];return![];}catch(_0x3d1c0e){return console['log'](_0x3d1c0e),![];}},indexUtil[_0x4ad30b(0x125)]=function(_0x35acd4,_0x171dee,_0x5134b3){const _0xec9c79=_0x4ad30b;dbConfigTable[_0xec9c79(0x104)](_0x35acd4,{'title':_0x171dee+_0xec9c79(0xec),'value':_0x5134b3?'1':'0'});},indexUtil[_0x4ad30b(0x11b)]=function(_0x15e948,_0x3b6a5d,_0x1d0326,_0x20b92b,_0x163d3f){const _0x35454b=_0x4ad30b;if(indexUtil[_0x35454b(0xee)](_0x1d0326,_0x20b92b))return![];if(indexUtil['isForbiddenFilename'](_0x163d3f))return![];if(!fs[_0x35454b(0xdb)](path[_0x35454b(0x107)](_0x20b92b,_0x163d3f)))return console[_0x35454b(0x105)](_0x35454b(0x113),_0x20b92b,_0x163d3f),![];let _0x5b69b5=indexUtil['isPathIsInSourceFolder'](_0x15e948,_0x3b6a5d,_0x20b92b);if(!_0x5b69b5)return console[_0x35454b(0x105)]('Not\x20in\x20source\x20folder\x20',_0x3b6a5d,_0x20b92b,_0x163d3f),![];return _0x5b69b5;},indexUtil['recursionDeleteIndex']=async function(_0x5c1c3b,_0x153b8e,_0x314198){const _0x3926eb=_0x4ad30b;let _0x284ee4=[_0x314198],_0x5c139d=new Set([_0x314198]),_0x205c5a=new Date()[_0x3926eb(0xda)]();while(_0x284ee4['length']>0x0){let _0x187316=_0x284ee4['pop'](),_0x45079a=dbFileIndexTable['getPathAllOnlyChild'](_0x5c1c3b,_0x187316,_0x153b8e);for(let _0x17793e=0x0;_0x17793e<_0x45079a[_0x3926eb(0x122)];_0x17793e++){let _0x31b719=path[_0x3926eb(0x107)](_0x45079a[_0x17793e]['path'],_0x45079a[_0x17793e][_0x3926eb(0x101)]);try{let _0x510e07=fs[_0x3926eb(0x100)](_0x31b719);if(_0x510e07[_0x3926eb(0xd7)]()){}else _0x510e07[_0x3926eb(0x120)]()&&(!_0x5c139d[_0x3926eb(0x10f)](_0x31b719)&&(_0x284ee4[_0x3926eb(0x10d)](_0x31b719),_0x5c139d[_0x3926eb(0x106)](_0x31b719)));}catch(_0x3f8556){_0x3f8556[_0x3926eb(0xfe)]==_0x3926eb(0x103)&&(_0x45079a[_0x17793e][_0x3926eb(0x11d)]==0x1?dbFileIndexTable[_0x3926eb(0x116)](_0x5c1c3b,_0x45079a[_0x17793e]['id'],_0x153b8e):(console[_0x3926eb(0x105)]('文件夹已不存在\x20删除文件夹及文件夹下的索引',_0x31b719),dbFileIndexTable['deleteByPathAndFileName'](_0x5c1c3b,_0x45079a[_0x17793e][_0x3926eb(0xe2)],_0x45079a[_0x17793e]['filename'],_0x153b8e),dbFileIndexTable[_0x3926eb(0xfd)](_0x5c1c3b,_0x31b719,_0x153b8e)));}}}console['log']('索引状态比对',_0x314198,'耗时:',new Date()['getTime']()-_0x205c5a,'ms');},module[_0x4ad30b(0xe0)]=indexUtil;