const _0x465d8f=_0x58b8;(function(_0x36ca42,_0x4cc0a1){const _0x3836d2=_0x58b8,_0x318d72=_0x36ca42();while(!![]){try{const _0xa9ce47=parseInt(_0x3836d2(0xa5))/0x1+-parseInt(_0x3836d2(0xae))/0x2+parseInt(_0x3836d2(0xa2))/0x3+parseInt(_0x3836d2(0xa3))/0x4+parseInt(_0x3836d2(0xb3))/0x5+-parseInt(_0x3836d2(0xaa))/0x6+parseInt(_0x3836d2(0xa0))/0x7*(-parseInt(_0x3836d2(0xb6))/0x8);if(_0xa9ce47===_0x4cc0a1)break;else _0x318d72['push'](_0x318d72['shift']());}catch(_0x5753e4){_0x318d72['push'](_0x318d72['shift']());}}}(_0x1d87,0xa4c92));const fs=require('fs'),path=require('path'),config=require(_0x465d8f(0xb4)),Database=require(_0x465d8f(0x97)),dbOther=new Database(config[_0x465d8f(0xb0)],{});dbOther[_0x465d8f(0xba)](_0x465d8f(0xb2));const dbFileIndex=new Database(config['dbFileIndex'],{'timeout':0xea60});dbFileIndex[_0x465d8f(0xba)](_0x465d8f(0xb2));function _0x58b8(_0x2a060b,_0x1b0cba){const _0x1d87a3=_0x1d87();return _0x58b8=function(_0x58b8b6,_0x145f2c){_0x58b8b6=_0x58b8b6-0x97;let _0x406bb4=_0x1d87a3[_0x58b8b6];return _0x406bb4;},_0x58b8(_0x2a060b,_0x1b0cba);}function _0x1d87(){const _0x31f3e2=['文件夹数量','影音管理:\x20开始扫描','getTime','3568668lFIhrM','UPDATE\x20source_folder\x20SET\x20last_scan_time=?\x20\x20WHERE\x20path=?\x20and\x20type=\x27movie\x27','../../express-server/utils/movieUtil','影音管理:未找到扫描任务[Movies\x20scanning\x20task\x20not\x20found]','1074732lBuPGK','耗时:','dbOther','statSync','journal_mode\x20=\x20WAL','1795910EBPksz','../../myConfig/config','./indexUtil','387176dowXkM','dealTvDrama','../../db/dbFileIndexTable','prepare','pragma','run','better-sqlite3','文件数量','scan_path','exit','SCAN_TYPE_MOVIE','log','getOnTask','send','INDEX_TABLE_NAME_MOVIE','161xNaHfg','recursionFilesAddIndex','2917980REUbGv','4659248KosfZi','./movieIndexUtil','423583ncwUjG','dealFirstLetterAll'];_0x1d87=function(){return _0x31f3e2;};return _0x1d87();}const movieUtil=require(_0x465d8f(0xac)),dbScanTaskTable=require('../../db/dbScanTaskTable'),dbFileIndexTable=require(_0x465d8f(0xb8)),indexTableName=dbFileIndexTable[_0x465d8f(0x9f)],movieIndexUtil=require(_0x465d8f(0xa4)),indexUtil=require(_0x465d8f(0xb5));process['title']='NasCabMovieIndexingWorker';async function startIndexingFolder(_0xfdd31b){return new Promise(async(_0x101345,_0x3e2bbc)=>{const _0x2e16e9=_0x58b8;try{let _0x3b5a99=new Date()[_0x2e16e9(0xa9)](),_0x565558=fs[_0x2e16e9(0xb1)](_0xfdd31b);if(!_0x565558['isDirectory']())return console['log']('要扫描的目录不是文件夹',_0xfdd31b),_0x101345();console[_0x2e16e9(0x9c)](_0x2e16e9(0xa8),_0xfdd31b),await indexUtil['recursionDeleteIndex'](dbFileIndex,indexTableName,_0xfdd31b);let {checkFileCount:_0x364c91,checkPathCount:_0xa7cb26}=await movieIndexUtil[_0x2e16e9(0xa1)](dbOther,dbFileIndex,_0xfdd31b);console[_0x2e16e9(0x9c)]('影音管理：扫描完成：'+_0xfdd31b,_0x2e16e9(0xaf),new Date()[_0x2e16e9(0xa9)]()-_0x3b5a99,'ms',_0x2e16e9(0xa7),_0xa7cb26,_0x2e16e9(0x98),_0x364c91),movieIndexUtil[_0x2e16e9(0xb7)](dbFileIndex),process[_0x2e16e9(0x9e)]({'type':'NEW_MOVIE_INDEX'}),_0x101345();}catch(_0x341419){console['log']('扫描目录已不存在\x20',_0x341419,_0xfdd31b),_0x101345();}});}async function runScanTask(){const _0x45b152=_0x465d8f;let _0x9e7271=dbScanTaskTable[_0x45b152(0x9d)](dbOther,dbScanTaskTable[_0x45b152(0x9b)]);_0x9e7271?(dbOther[_0x45b152(0xb9)](_0x45b152(0xab))[_0x45b152(0xbb)](Date['now'](),_0x9e7271['scan_path']),startIndexingFolder(_0x9e7271[_0x45b152(0x99)])['then'](()=>{const _0x14671c=_0x45b152;dbScanTaskTable['deleteTask'](dbOther,_0x9e7271['id']),movieUtil[_0x14671c(0xa6)](dbFileIndex),runScanTask();})):(console['log'](_0x45b152(0xad)),indexUtil['setIndexingState'](dbOther,indexTableName,![]),process[_0x45b152(0x9a)]());}indexUtil['setIndexingState'](dbOther,indexTableName,!![]),runScanTask();