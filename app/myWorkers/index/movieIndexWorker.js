const _0x3e615e=_0x5523;function _0x37c6(){const _0x412655=['NEW_MOVIE_INDEX','statSync','107706PbHOoC','耗时:','NasCabMovieIndexingWorker','getTime','文件夹数量','846132DcAHKg','journal_mode\x20=\x20WAL','../../db/dbFileIndexTable','prepare','now','title','../../db/dbScanTaskTable','recursionDeleteIndex','./movieIndexUtil','影音管理:未找到扫描任务[Movies\x20scanning\x20task\x20not\x20found]','5855859mIBwlb','6864728uRmMZu','pragma','SCAN_TYPE_MOVIE','then','send','41916AYZakS','log','dbFileIndex','43RMmkjE','1849278gqdXde','要扫描的目录不是文件夹','exit','deleteTask','better-sqlite3','影音管理:\x20开始扫描','4786971ZqjBeH','95jXRxUQ','./indexUtil','dbOther','isDirectory','scan_path','10zpOZoR','run','dealFirstLetterAll'];_0x37c6=function(){return _0x412655;};return _0x37c6();}(function(_0x18a2ca,_0x4f3c1a){const _0x34025b=_0x5523,_0x2a85ba=_0x18a2ca();while(!![]){try{const _0x3f3007=-parseInt(_0x34025b(0x209))/0x1*(-parseInt(_0x34025b(0x206))/0x2)+parseInt(_0x34025b(0x20a))/0x3+parseInt(_0x34025b(0x1f6))/0x4+parseInt(_0x34025b(0x1e7))/0x5*(-parseInt(_0x34025b(0x1f1))/0x6)+-parseInt(_0x34025b(0x210))/0x7+-parseInt(_0x34025b(0x201))/0x8+parseInt(_0x34025b(0x200))/0x9*(parseInt(_0x34025b(0x1ec))/0xa);if(_0x3f3007===_0x4f3c1a)break;else _0x2a85ba['push'](_0x2a85ba['shift']());}catch(_0x3cd0b5){_0x2a85ba['push'](_0x2a85ba['shift']());}}}(_0x37c6,0x79497));const fs=require('fs'),path=require('path'),config=require('../../myConfig/config'),Database=require(_0x3e615e(0x20e)),dbOther=new Database(config[_0x3e615e(0x1e9)],{});dbOther[_0x3e615e(0x202)](_0x3e615e(0x1f7));const dbFileIndex=new Database(config[_0x3e615e(0x208)],{'timeout':0xea60});dbFileIndex[_0x3e615e(0x202)](_0x3e615e(0x1f7));function _0x5523(_0x424ee2,_0x403505){const _0x37c675=_0x37c6();return _0x5523=function(_0x552369,_0x11eb81){_0x552369=_0x552369-0x1e7;let _0x4b36f1=_0x37c675[_0x552369];return _0x4b36f1;},_0x5523(_0x424ee2,_0x403505);}const movieUtil=require('../../express-server/utils/movieUtil'),dbScanTaskTable=require(_0x3e615e(0x1fc)),dbFileIndexTable=require(_0x3e615e(0x1f8)),indexTableName=dbFileIndexTable['INDEX_TABLE_NAME_MOVIE'],movieIndexUtil=require(_0x3e615e(0x1fe)),indexUtil=require(_0x3e615e(0x1e8));process[_0x3e615e(0x1fb)]=_0x3e615e(0x1f3);async function startIndexingFolder(_0x11e7ca){return new Promise(async(_0x27e4de,_0x1813fb)=>{const _0x190ec5=_0x5523;try{let _0x22f211=new Date()[_0x190ec5(0x1f4)](),_0x389df3=fs[_0x190ec5(0x1f0)](_0x11e7ca);if(!_0x389df3[_0x190ec5(0x1ea)]())return console['log'](_0x190ec5(0x20b),_0x11e7ca),_0x27e4de();console['log'](_0x190ec5(0x20f),_0x11e7ca),await indexUtil[_0x190ec5(0x1fd)](dbFileIndex,indexTableName,_0x11e7ca);let {checkFileCount:_0x72be9,checkPathCount:_0x4634bb}=await movieIndexUtil['recursionFilesAddIndex'](dbOther,dbFileIndex,_0x11e7ca);console['log']('影音管理：扫描完成：'+_0x11e7ca,_0x190ec5(0x1f2),new Date()['getTime']()-_0x22f211,'ms',_0x190ec5(0x1f5),_0x4634bb,'文件数量',_0x72be9),movieIndexUtil['dealTvDrama'](dbFileIndex),process[_0x190ec5(0x205)]({'type':_0x190ec5(0x1ef)}),_0x27e4de();}catch(_0x19c487){console[_0x190ec5(0x207)]('扫描目录已不存在\x20',_0x19c487,_0x11e7ca),_0x27e4de();}});}async function runScanTask(){const _0x372cc5=_0x3e615e;let _0xff1a1=dbScanTaskTable['getOnTask'](dbOther,dbScanTaskTable[_0x372cc5(0x203)]);_0xff1a1?(dbOther[_0x372cc5(0x1f9)]('UPDATE\x20source_folder\x20SET\x20last_scan_time=?\x20\x20WHERE\x20path=?\x20and\x20type=\x27movie\x27')[_0x372cc5(0x1ed)](Date[_0x372cc5(0x1fa)](),_0xff1a1[_0x372cc5(0x1eb)]),startIndexingFolder(_0xff1a1['scan_path'])[_0x372cc5(0x204)](()=>{const _0x1c3b5a=_0x372cc5;dbScanTaskTable[_0x1c3b5a(0x20d)](dbOther,_0xff1a1['id']),movieUtil[_0x1c3b5a(0x1ee)](dbFileIndex),runScanTask();})):(console[_0x372cc5(0x207)](_0x372cc5(0x1ff)),indexUtil['setIndexingState'](dbOther,indexTableName,![]),process[_0x372cc5(0x20c)]());}indexUtil['setIndexingState'](dbOther,indexTableName,!![]),runScanTask();