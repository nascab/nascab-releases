const _0x2a883a=_0x5eab;(function(_0x4c8c84,_0x41931e){const _0x53019a=_0x5eab,_0x45f73a=_0x4c8c84();while(!![]){try{const _0x217047=parseInt(_0x53019a(0x11d))/0x1*(parseInt(_0x53019a(0x108))/0x2)+-parseInt(_0x53019a(0x105))/0x3*(parseInt(_0x53019a(0x117))/0x4)+-parseInt(_0x53019a(0x127))/0x5*(-parseInt(_0x53019a(0xf9))/0x6)+-parseInt(_0x53019a(0xfc))/0x7*(-parseInt(_0x53019a(0x10d))/0x8)+parseInt(_0x53019a(0x115))/0x9*(parseInt(_0x53019a(0x111))/0xa)+parseInt(_0x53019a(0x100))/0xb+-parseInt(_0x53019a(0x101))/0xc;if(_0x217047===_0x41931e)break;else _0x45f73a['push'](_0x45f73a['shift']());}catch(_0x427cf2){_0x45f73a['push'](_0x45f73a['shift']());}}}(_0x2c2f,0xaeed4));function _0x5eab(_0x37387c,_0x5567e4){const _0x2c2f38=_0x2c2f();return _0x5eab=function(_0x5eab9e,_0x6a90e3){_0x5eab9e=_0x5eab9e-0xf4;let _0x26c2e0=_0x2c2f38[_0x5eab9e];return _0x26c2e0;},_0x5eab(_0x37387c,_0x5567e4);}const config=require(_0x2a883a(0xf7));let fs=require('fs'),path=require(_0x2a883a(0x114)),sharpUtil=require(_0x2a883a(0xf4));const dbFileIndexTable=require('../db/dbFileIndexTable'),Database=require(_0x2a883a(0x106));let dbOther=new Database(config[_0x2a883a(0x126)],{'timeout':0xea60});dbOther['pragma'](_0x2a883a(0x129));let dbFileIndex=new Database(config[_0x2a883a(0x11b)],{'timeout':0xea60});dbFileIndex[_0x2a883a(0x113)](_0x2a883a(0x129));const messageUtil=require(_0x2a883a(0x11c));process[_0x2a883a(0x10f)]=_0x2a883a(0x12c);function _0x2c2f(){const _0x3d7cae=['600828oYDUZQ','getByWhere','lastInsertRowid','5571629jDeGCX','run','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','ext','2897972wovwht','8053980cFFJEh','.psd','noData','exit','345HjDwcC','better-sqlite3','PSD文件过大不生成缩略图','86pKjteH','genTinyFile','cachePath','prepare','join','8vCzoaE','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','title','isFile','40mspIFS','dirname','pragma','path','956052nWBnFD','updateById','41988kbnCzL','basename','image','maxPsdSize','dbFileIndex','../utils/messageUtil','23497nLFPRZ','log','Error\x20occurred\x20in\x20thumbnail\x20process\x20','NEW_TINY_IMAGE','filename','stat','INDEX_TABLE_NAME_MOVIE','size','send','dbOther','5FVDLwY','GEN_TINY_IMAGE','journal_mode\x20=\x20WAL','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27','\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','NasCabThumbnailWorker','../express-server/utils/sharpUtils','getFileHashName','close','../myConfig/config','tiny_path'];_0x2c2f=function(){return _0x3d7cae;};return _0x2c2f();}function dealFail(_0x3aee12,_0x59baf1,_0x315035,_0x13a701,_0x3b2cf0){const _0xa6cc3f=_0x2a883a;dbFileIndexTable[_0xa6cc3f(0x116)](_0x59baf1,_0x13a701['id'],_0xa6cc3f(0xf8),'0',_0x3b2cf0),_0x3aee12();}function genTiny(_0xc0c7bc,_0x5b5f8b,_0x2fd7f4,_0x24dd15,_0x234b38,_0x2b3ebb){const _0x2ff639=_0x2a883a;let _0x3e19e8=_0x2ff639(0x119);_0x24dd15['type']==0x2&&(_0x3e19e8='video');if(_0x24dd15[_0x2ff639(0xff)]==_0x2ff639(0x102)&&_0x24dd15['size']>config[_0x2ff639(0x11a)]){console['log'](_0x2ff639(0x107),_0x2fd7f4),dealFail(_0xc0c7bc,_0x5b5f8b,_0x2fd7f4,_0x24dd15,_0x2b3ebb);return;}sharpUtil[_0x2ff639(0x109)](_0x2fd7f4,path[_0x2ff639(0x112)](_0x234b38),path[_0x2ff639(0x118)](_0x234b38),_0x3e19e8,_0x24dd15,_0x3bd5db=>{const _0x328a13=_0x2ff639;dbFileIndexTable[_0x328a13(0x116)](_0x5b5f8b,_0x24dd15['id'],_0x328a13(0xf8),_0x3bd5db,_0x2b3ebb),_0xc0c7bc();},_0x4a743a=>{dealFail(_0xc0c7bc,_0x5b5f8b,_0x2fd7f4,_0x24dd15,_0x2b3ebb);});}function genStart(_0x2e9a37){return new Promise((_0x1369c5,_0x20b592)=>{const _0x394d21=_0x5eab;let _0x46ca14=dbFileIndexTable[_0x394d21(0xfa)](dbFileIndex,_0x394d21(0x12b),'*',_0x2e9a37);!_0x46ca14&&(_0x46ca14=dbFileIndexTable[_0x394d21(0xfa)](dbFileIndex,'\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','*',_0x2e9a37));if(_0x46ca14){try{bgTaskId&&dbOther['prepare'](_0x394d21(0x10e)+bgTaskId)[_0x394d21(0xfd)]();}catch(_0x42fbeb){}let _0x383358=path[_0x394d21(0x10c)](_0x46ca14[_0x394d21(0x114)],_0x46ca14[_0x394d21(0x121)]),_0x5c0667=config[_0x394d21(0xf5)](_0x46ca14),_0x20d994=path[_0x394d21(0x10c)](config[_0x394d21(0x10a)],_0x5c0667);fs[_0x394d21(0x122)](_0x20d994,(_0x25afd7,_0x325f08)=>{const _0x80446=_0x394d21;if(_0x25afd7)return genTiny(_0x1369c5,dbFileIndex,_0x383358,_0x46ca14,_0x20d994,_0x2e9a37);_0x325f08[_0x80446(0x110)]()&&_0x325f08[_0x80446(0x124)]>0x7d0?(dbFileIndexTable['updateById'](dbFileIndex,_0x46ca14['id'],'tiny_path',_0x20d994,_0x2e9a37),_0x1369c5()):genTiny(_0x1369c5,dbFileIndex,_0x383358,_0x46ca14,_0x20d994,_0x2e9a37);});}else _0x1369c5('noData');});}let bgTaskId;try{let info=dbOther[_0x2a883a(0x10b)](_0x2a883a(0xfe))['run'](_0x2a883a(0x128));bgTaskId=info[_0x2a883a(0xfb)];}catch(_0x5777e5){}let genCount=0x0;async function runGen(){const _0x1ba074=_0x2a883a;try{let _0x3796b7=await genStart(dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']);_0x3796b7!=_0x1ba074(0x103)&&(genCount+=0x1);let _0x55dbbb=await genStart(dbFileIndexTable[_0x1ba074(0x123)]);if(_0x3796b7==_0x1ba074(0x103)&&_0x55dbbb==_0x1ba074(0x103)){try{bgTaskId&&dbOther['prepare'](_0x1ba074(0x12a))[_0x1ba074(0xfd)]();}catch(_0x170f2c){}genCount>0x0&&process[_0x1ba074(0x125)]({'type':_0x1ba074(0x120)}),process[_0x1ba074(0x125)]({'type':'close'}),process[_0x1ba074(0x104)]();}else return runGen();}catch(_0x5e0c27){return console[_0x1ba074(0x11e)](_0x5e0c27),runGen();}}runGen();function exitProcess(){const _0xe7e28e=_0x2a883a;process[_0xe7e28e(0x125)]({'type':_0xe7e28e(0xf6)}),process[_0xe7e28e(0x104)]();}process['on']('uncaughtException',(_0x2c628e,_0x12c065)=>{const _0x1bc771=_0x2a883a;console[_0x1bc771(0x11e)](_0x1bc771(0x11f),_0x2c628e),exitProcess();});