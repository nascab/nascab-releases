const _0x3073c5=_0x1522;function _0x1b6d(){const _0x15042a=['join','basename','../express-server/utils/sharpUtils','2hwjexv','prepare','pragma','28TsqgFB','dbFileIndex','getByWhere','.psd','ext','isFile','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27','size','1903730IrCEcw','updateById','getFileHashName','tiny_path','dirname','NasCabThumbnailWorker','genTinyFile','close','\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','162055ntKsPA','log','PSD文件过大不生成缩略图','18tWiWXu','INDEX_TABLE_NAME_PHOTO','Error\x20occurred\x20in\x20thumbnail\x20process\x20','\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','noData','filename','57108QowBjF','88162sTWwHo','stat','NEW_TINY_IMAGE','41517ramkmS','uncaughtException','INDEX_TABLE_NAME_MOVIE','image','../utils/messageUtil','40645ZtQBoN','send','run','108AREIKs','journal_mode\x20=\x20WAL','299944dIqFJf','title','exit','path','video','../myConfig/config','84xBrQLA'];_0x1b6d=function(){return _0x15042a;};return _0x1b6d();}(function(_0x2bccdb,_0x12b895){const _0x1df248=_0x1522,_0x682969=_0x2bccdb();while(!![]){try{const _0x3f332d=parseInt(_0x1df248(0x113))/0x1*(-parseInt(_0x1df248(0xfc))/0x2)+parseInt(_0x1df248(0xff))/0x3+parseInt(_0x1df248(0x116))/0x4*(parseInt(_0x1df248(0xf2))/0x5)+-parseInt(_0x1df248(0xfb))/0x6*(parseInt(_0x1df248(0x10f))/0x7)+parseInt(_0x1df248(0x109))/0x8*(-parseInt(_0x1df248(0xf5))/0x9)+parseInt(_0x1df248(0x11e))/0xa+parseInt(_0x1df248(0x104))/0xb*(-parseInt(_0x1df248(0x107))/0xc);if(_0x3f332d===_0x12b895)break;else _0x682969['push'](_0x682969['shift']());}catch(_0x5ba708){_0x682969['push'](_0x682969['shift']());}}}(_0x1b6d,0x1d696));const config=require(_0x3073c5(0x10e));let fs=require('fs'),path=require(_0x3073c5(0x10c)),sharpUtil=require(_0x3073c5(0x112));const dbFileIndexTable=require('../db/dbFileIndexTable'),Database=require('better-sqlite3');let dbOther=new Database(config['dbOther'],{'timeout':0xea60});dbOther[_0x3073c5(0x115)]('journal_mode\x20=\x20WAL');function _0x1522(_0xb0cea4,_0x172f0f){const _0x1b6ddb=_0x1b6d();return _0x1522=function(_0x152210,_0x412242){_0x152210=_0x152210-0xf1;let _0x378c24=_0x1b6ddb[_0x152210];return _0x378c24;},_0x1522(_0xb0cea4,_0x172f0f);}let dbFileIndex=new Database(config[_0x3073c5(0x117)],{'timeout':0xea60});dbFileIndex[_0x3073c5(0x115)](_0x3073c5(0x108));const messageUtil=require(_0x3073c5(0x103));process[_0x3073c5(0x10a)]=_0x3073c5(0x123);function dealFail(_0x55fbba,_0x25b9d2,_0x43c552,_0x42d8b5,_0x52f09b){const _0x45a57e=_0x3073c5;dbFileIndexTable['updateById'](_0x25b9d2,_0x42d8b5['id'],_0x45a57e(0x121),'0',_0x52f09b),_0x55fbba();}function genTiny(_0x3328f2,_0x1a10b0,_0x111801,_0xc858ed,_0x5af124,_0x5de2d3){const _0x1a668d=_0x3073c5;let _0x5a6cbc=_0x1a668d(0x102);_0xc858ed['type']==0x2&&(_0x5a6cbc=_0x1a668d(0x10d));if(_0xc858ed[_0x1a668d(0x11a)]==_0x1a668d(0x119)&&_0xc858ed[_0x1a668d(0x11d)]>config['maxPsdSize']){console[_0x1a668d(0xf3)](_0x1a668d(0xf4),_0x111801),dealFail(_0x3328f2,_0x1a10b0,_0x111801,_0xc858ed,_0x5de2d3);return;}sharpUtil[_0x1a668d(0x124)](_0x111801,path[_0x1a668d(0x122)](_0x5af124),path[_0x1a668d(0x111)](_0x5af124),_0x5a6cbc,_0xc858ed,_0x344b8b=>{const _0x182077=_0x1a668d;dbFileIndexTable[_0x182077(0x11f)](_0x1a10b0,_0xc858ed['id'],_0x182077(0x121),_0x344b8b,_0x5de2d3),_0x3328f2();},_0x557234=>{dealFail(_0x3328f2,_0x1a10b0,_0x111801,_0xc858ed,_0x5de2d3);});}function genStart(_0x54f1c0){return new Promise((_0xb0a396,_0x605f4c)=>{const _0x3ec9fd=_0x1522;let _0x39cd82=dbFileIndexTable[_0x3ec9fd(0x118)](dbFileIndex,_0x3ec9fd(0xf1),'*',_0x54f1c0);!_0x39cd82&&(_0x39cd82=dbFileIndexTable['getByWhere'](dbFileIndex,_0x3ec9fd(0xf8),'*',_0x54f1c0));if(_0x39cd82){try{bgTaskId&&dbOther[_0x3ec9fd(0x114)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x3ec9fd(0x106)]();}catch(_0x2cc3e9){}let _0x218e39=path[_0x3ec9fd(0x110)](_0x39cd82['path'],_0x39cd82[_0x3ec9fd(0xfa)]),_0xfe58f7=config[_0x3ec9fd(0x120)](_0x39cd82),_0x24bafb=path['join'](config['cachePath'],_0xfe58f7);fs[_0x3ec9fd(0xfd)](_0x24bafb,(_0x8dee4f,_0x4438d4)=>{const _0x3579b7=_0x3ec9fd;if(_0x8dee4f)return genTiny(_0xb0a396,dbFileIndex,_0x218e39,_0x39cd82,_0x24bafb,_0x54f1c0);_0x4438d4[_0x3579b7(0x11b)]()&&_0x4438d4[_0x3579b7(0x11d)]>0x7d0?(dbFileIndexTable[_0x3579b7(0x11f)](dbFileIndex,_0x39cd82['id'],_0x3579b7(0x121),_0x24bafb,_0x54f1c0),_0xb0a396()):genTiny(_0xb0a396,dbFileIndex,_0x218e39,_0x39cd82,_0x24bafb,_0x54f1c0);});}else _0xb0a396(_0x3ec9fd(0xf9));});}let bgTaskId;try{let info=dbOther[_0x3073c5(0x114)]('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')[_0x3073c5(0x106)]('GEN_TINY_IMAGE');bgTaskId=info['lastInsertRowid'];}catch(_0x2eba2c){}let genCount=0x0;async function runGen(){const _0x4556c6=_0x3073c5;try{let _0x53265a=await genStart(dbFileIndexTable[_0x4556c6(0xf6)]);_0x53265a!='noData'&&(genCount+=0x1);let _0x574eb0=await genStart(dbFileIndexTable[_0x4556c6(0x101)]);if(_0x53265a==_0x4556c6(0xf9)&&_0x574eb0==_0x4556c6(0xf9)){try{bgTaskId&&dbOther[_0x4556c6(0x114)](_0x4556c6(0x11c))[_0x4556c6(0x106)]();}catch(_0x3d25d3){}genCount>0x0&&process['send']({'type':_0x4556c6(0xfe)}),process[_0x4556c6(0x105)]({'type':_0x4556c6(0x125)}),process[_0x4556c6(0x10b)]();}else return runGen();}catch(_0x2638d3){return console['log'](_0x2638d3),runGen();}}runGen();function exitProcess(){const _0x4dd53c=_0x3073c5;process['send']({'type':_0x4dd53c(0x125)}),process[_0x4dd53c(0x10b)]();}process['on'](_0x3073c5(0x100),(_0x3e07e8,_0x4abf0f)=>{const _0x316299=_0x3073c5;console[_0x316299(0xf3)](_0x316299(0xf7),_0x3e07e8),exitProcess();});