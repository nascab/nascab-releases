const _0x8b6f0e=_0x2b96;(function(_0x11f5d4,_0x5f1857){const _0x57ebef=_0x2b96,_0xdf59ff=_0x11f5d4();while(!![]){try{const _0x3ec8ea=parseInt(_0x57ebef(0x133))/0x1*(-parseInt(_0x57ebef(0x126))/0x2)+parseInt(_0x57ebef(0x123))/0x3+-parseInt(_0x57ebef(0x11c))/0x4+parseInt(_0x57ebef(0x103))/0x5*(parseInt(_0x57ebef(0x119))/0x6)+parseInt(_0x57ebef(0x10b))/0x7+parseInt(_0x57ebef(0x106))/0x8*(-parseInt(_0x57ebef(0x129))/0x9)+parseInt(_0x57ebef(0x131))/0xa;if(_0x3ec8ea===_0x5f1857)break;else _0xdf59ff['push'](_0xdf59ff['shift']());}catch(_0x18461e){_0xdf59ff['push'](_0xdf59ff['shift']());}}}(_0x4491,0xa4788));const config=require(_0x8b6f0e(0x113));let fs=require('fs'),path=require(_0x8b6f0e(0x104)),sharpUtil=require(_0x8b6f0e(0x11a));function _0x2b96(_0x1bf761,_0x5e2a80){const _0x4491c7=_0x4491();return _0x2b96=function(_0x2b9623,_0x3e9bd9){_0x2b9623=_0x2b9623-0x102;let _0x47e30b=_0x4491c7[_0x2b9623];return _0x47e30b;},_0x2b96(_0x1bf761,_0x5e2a80);}const dbFileIndexTable=require(_0x8b6f0e(0x11d)),Database=require('better-sqlite3');let dbOther=new Database(config[_0x8b6f0e(0x11b)],{'timeout':0xea60});function _0x4491(){const _0x21d2d3=['3209229ZSrsWJ','exit','send','756AyxuYh','\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','getByWhere','1173861GDaypQ','title','log','join','close','tiny_path','getFileHashName','.psd','1807500fCwLEB','size','1644SYktBR','NasCabThumbnailWorker','genTinyFile','\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','updateById','stat','3819245qPqYkA','path','noData','16TElnDB','maxPsdSize','PSD文件过大不生成缩略图','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','image','2548189gGIacp','run','journal_mode\x20=\x20WAL','video','dbFileIndex','失败-缩略图生成','type','INDEX_TABLE_NAME_MOVIE','../myConfig/config','basename','filename','INDEX_TABLE_NAME_PHOTO','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27','pragma','6yBpRjp','../express-server/utils/sharpUtils','dbOther','3289628KDUlsX','../db/dbFileIndexTable','uncaughtException','lastInsertRowid','error','isFile','prepare'];_0x4491=function(){return _0x21d2d3;};return _0x4491();}dbOther[_0x8b6f0e(0x118)](_0x8b6f0e(0x10d));let dbFileIndex=new Database(config[_0x8b6f0e(0x10f)],{'timeout':0xea60});dbFileIndex[_0x8b6f0e(0x118)](_0x8b6f0e(0x10d)),process[_0x8b6f0e(0x12a)]=_0x8b6f0e(0x134);function dealFail(_0xb16074,_0x30f4cb,_0xc796ee,_0xc4d0eb,_0x4ae3ef){const _0x37867d=_0x8b6f0e;console[_0x37867d(0x120)](_0x37867d(0x110),_0xc796ee),dbFileIndexTable['updateById'](_0x30f4cb,_0xc4d0eb['id'],'tiny_path','0',_0x4ae3ef),_0xb16074();}function genTiny(_0x301aac,_0x2195b3,_0x444e49,_0x16fe66,_0xccfc2d,_0x21b761){const _0xed1c2a=_0x8b6f0e;let _0x502bf0=_0xed1c2a(0x10a);_0x16fe66[_0xed1c2a(0x111)]==0x2&&(_0x502bf0=_0xed1c2a(0x10e));if(_0x16fe66['ext']==_0xed1c2a(0x130)&&_0x16fe66[_0xed1c2a(0x132)]>config[_0xed1c2a(0x107)]){console[_0xed1c2a(0x12b)](_0xed1c2a(0x108),_0x444e49),dealFail(_0x301aac,_0x2195b3,_0x444e49,_0x16fe66,_0x21b761);return;}sharpUtil[_0xed1c2a(0x135)](_0x444e49,path['dirname'](_0xccfc2d),path[_0xed1c2a(0x114)](_0xccfc2d),_0x502bf0,_0x16fe66,_0x36916f=>{const _0xa8ec96=_0xed1c2a;dbFileIndexTable[_0xa8ec96(0x137)](_0x2195b3,_0x16fe66['id'],'tiny_path',_0x36916f,_0x21b761),_0x301aac();},_0x38b4a2=>{dealFail(_0x301aac,_0x2195b3,_0x444e49,_0x16fe66,_0x21b761);});}function genStart(_0x3abed9){return new Promise((_0x45eb43,_0x26e883)=>{const _0x50c35b=_0x2b96;let _0x20fc6b=dbFileIndexTable[_0x50c35b(0x128)](dbFileIndex,_0x50c35b(0x136),'*',_0x3abed9);!_0x20fc6b&&(_0x20fc6b=dbFileIndexTable[_0x50c35b(0x128)](dbFileIndex,_0x50c35b(0x127),'*',_0x3abed9));if(_0x20fc6b){try{bgTaskId&&dbOther[_0x50c35b(0x122)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x50c35b(0x10c)]();}catch(_0x30573b){}let _0x2009b5=path['join'](_0x20fc6b[_0x50c35b(0x104)],_0x20fc6b[_0x50c35b(0x115)]),_0x2cfba8=config[_0x50c35b(0x12f)](_0x20fc6b),_0x4164d6=path[_0x50c35b(0x12c)](config['cachePath'],_0x2cfba8);fs[_0x50c35b(0x102)](_0x4164d6,(_0x5b6f0f,_0x3ff930)=>{const _0x2c0243=_0x50c35b;if(_0x5b6f0f)return genTiny(_0x45eb43,dbFileIndex,_0x2009b5,_0x20fc6b,_0x4164d6,_0x3abed9);_0x3ff930[_0x2c0243(0x121)]()&&_0x3ff930[_0x2c0243(0x132)]>0x7d0?(dbFileIndexTable[_0x2c0243(0x137)](dbFileIndex,_0x20fc6b['id'],_0x2c0243(0x12e),_0x4164d6,_0x3abed9),_0x45eb43()):genTiny(_0x45eb43,dbFileIndex,_0x2009b5,_0x20fc6b,_0x4164d6,_0x3abed9);});}else _0x45eb43('noData');});}let bgTaskId;try{let info=dbOther[_0x8b6f0e(0x122)](_0x8b6f0e(0x109))['run']('GEN_TINY_IMAGE');bgTaskId=info[_0x8b6f0e(0x11f)];}catch(_0x473ee3){}let genCount=0x0;async function runGen(){const _0x37cde2=_0x8b6f0e;try{let _0x5675e1=await genStart(dbFileIndexTable[_0x37cde2(0x116)]);_0x5675e1!=_0x37cde2(0x105)&&(genCount+=0x1);let _0x429c1f=await genStart(dbFileIndexTable[_0x37cde2(0x112)]);if(_0x5675e1=='noData'&&_0x429c1f==_0x37cde2(0x105)){try{bgTaskId&&dbOther[_0x37cde2(0x122)](_0x37cde2(0x117))[_0x37cde2(0x10c)]();}catch(_0x883570){}genCount>0x0&&process[_0x37cde2(0x125)]({'type':'NEW_TINY_IMAGE'}),process[_0x37cde2(0x125)]({'type':_0x37cde2(0x12d)}),process[_0x37cde2(0x124)]();}else return runGen();}catch(_0x573911){return console[_0x37cde2(0x12b)](_0x573911),runGen();}}runGen();function exitProcess(){const _0x4ad850=_0x8b6f0e;process[_0x4ad850(0x125)]({'type':_0x4ad850(0x12d)}),process[_0x4ad850(0x124)]();}process['on'](_0x8b6f0e(0x11e),(_0x37b8cb,_0x4c127d)=>{const _0x9fd7df=_0x8b6f0e;console[_0x9fd7df(0x12b)]('Error\x20occurred\x20in\x20thumbnail\x20process\x20',_0x37b8cb),exitProcess();});