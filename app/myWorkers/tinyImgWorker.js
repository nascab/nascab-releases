const _0x2db4ca=_0x1b53;(function(_0x258628,_0x5b67d3){const _0x1a7888=_0x1b53,_0x4cde93=_0x258628();while(!![]){try{const _0x3c8521=parseInt(_0x1a7888(0x9c))/0x1+parseInt(_0x1a7888(0xc5))/0x2*(-parseInt(_0x1a7888(0xbc))/0x3)+-parseInt(_0x1a7888(0xbb))/0x4+-parseInt(_0x1a7888(0xb3))/0x5*(parseInt(_0x1a7888(0x9d))/0x6)+parseInt(_0x1a7888(0xad))/0x7*(-parseInt(_0x1a7888(0x98))/0x8)+parseInt(_0x1a7888(0xc3))/0x9+-parseInt(_0x1a7888(0xb1))/0xa*(-parseInt(_0x1a7888(0xaa))/0xb);if(_0x3c8521===_0x5b67d3)break;else _0x4cde93['push'](_0x4cde93['shift']());}catch(_0xde5f94){_0x4cde93['push'](_0x4cde93['shift']());}}}(_0x9726,0xe4136));const config=require(_0x2db4ca(0xb9));let fs=require('fs'),path=require(_0x2db4ca(0xb6)),sharpUtil=require(_0x2db4ca(0xa4));const dbFileIndexTable=require(_0x2db4ca(0xc9)),Database=require(_0x2db4ca(0xa2));function _0x1b53(_0x143379,_0x5ef2d5){const _0x9726b2=_0x9726();return _0x1b53=function(_0x1b53c1,_0x4c6725){_0x1b53c1=_0x1b53c1-0x95;let _0x1005dc=_0x9726b2[_0x1b53c1];return _0x1005dc;},_0x1b53(_0x143379,_0x5ef2d5);}let dbOther=new Database(config['dbOther'],{'timeout':0xea60});dbOther[_0x2db4ca(0xb2)]('journal_mode\x20=\x20WAL');let dbFileIndex=new Database(config[_0x2db4ca(0x9b)],{'timeout':0xea60});dbFileIndex[_0x2db4ca(0xb2)](_0x2db4ca(0x95)),process['title']=_0x2db4ca(0xc0);function dealFail(_0x4cf63c,_0x4d56f4,_0x3db702,_0x9cdf8f,_0x4f1b21){const _0xda71d=_0x2db4ca;console[_0xda71d(0xa1)](_0xda71d(0xbf),_0x3db702),dbFileIndexTable['updateById'](_0x4d56f4,_0x9cdf8f['id'],'tiny_path','0',_0x4f1b21),_0x4cf63c();}function genTiny(_0x2ca6d8,_0xe6275a,_0x82c5c2,_0x13eeba,_0x50a4d9,_0x16d33e){const _0x32c13c=_0x2db4ca;let _0x324519='image';_0x13eeba[_0x32c13c(0x9f)]==0x2&&(_0x324519='video');if(_0x13eeba[_0x32c13c(0xa8)]==_0x32c13c(0xb4)&&_0x13eeba[_0x32c13c(0xbe)]>config[_0x32c13c(0xa5)]){console['log'](_0x32c13c(0xb5),_0x82c5c2),dealFail(_0x2ca6d8,_0xe6275a,_0x82c5c2,_0x13eeba,_0x16d33e);return;}sharpUtil[_0x32c13c(0xc6)](_0x82c5c2,path[_0x32c13c(0xa9)](_0x50a4d9),path[_0x32c13c(0xba)](_0x50a4d9),_0x324519,_0x13eeba,_0x4e5558=>{const _0x58d745=_0x32c13c;dbFileIndexTable['updateById'](_0xe6275a,_0x13eeba['id'],_0x58d745(0xa0),_0x4e5558,_0x16d33e),_0x2ca6d8();},_0x37fd74=>{dealFail(_0x2ca6d8,_0xe6275a,_0x82c5c2,_0x13eeba,_0x16d33e);});}function _0x9726(){const _0x372c07=['run','15011064ElLmlI','noData','262IezUoW','genTinyFile','log','filename','../db/dbFileIndexTable','exit','journal_mode\x20=\x20WAL','INDEX_TABLE_NAME_MOVIE','\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','32HlFIEs','updateById','lastInsertRowid','dbFileIndex','1259814oDBkWg','2550642eLopqL','NEW_TINY_IMAGE','type','tiny_path','error','better-sqlite3','uncaughtException','../express-server/utils/sharpUtils','maxPsdSize','getByWhere','stat','ext','dirname','24449051DzOJgq','getFileHashName','prepare','1256738LbPEwo','INDEX_TABLE_NAME_PHOTO','join','send','10fzhMLS','pragma','20IcFaRg','.psd','PSD文件过大不生成缩略图','path','close','Error\x20occurred\x20in\x20thumbnail\x20process\x20','../myConfig/config','basename','6819888pWhZux','2121ackNfz','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','size','失败-缩略图生成','NasCabThumbnailWorker','isFile'];_0x9726=function(){return _0x372c07;};return _0x9726();}function genStart(_0x11aac0){return new Promise((_0x533677,_0x392c9b)=>{const _0x3d706f=_0x1b53;let _0x4bed4d=dbFileIndexTable[_0x3d706f(0xa6)](dbFileIndex,_0x3d706f(0x97),'*',_0x11aac0);!_0x4bed4d&&(_0x4bed4d=dbFileIndexTable[_0x3d706f(0xa6)](dbFileIndex,'\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','*',_0x11aac0));if(_0x4bed4d){try{bgTaskId&&dbOther[_0x3d706f(0xac)](_0x3d706f(0xbd)+bgTaskId)[_0x3d706f(0xc2)]();}catch(_0x39de67){}let _0x560316=path[_0x3d706f(0xaf)](_0x4bed4d[_0x3d706f(0xb6)],_0x4bed4d[_0x3d706f(0xc8)]),_0x3057ec=config[_0x3d706f(0xab)](_0x4bed4d),_0x164a81=path[_0x3d706f(0xaf)](config['cachePath'],_0x3057ec);fs[_0x3d706f(0xa7)](_0x164a81,(_0xa2fc6b,_0xfc1908)=>{const _0x2309af=_0x3d706f;if(_0xa2fc6b)return genTiny(_0x533677,dbFileIndex,_0x560316,_0x4bed4d,_0x164a81,_0x11aac0);_0xfc1908[_0x2309af(0xc1)]()&&_0xfc1908['size']>0x7d0?(dbFileIndexTable[_0x2309af(0x99)](dbFileIndex,_0x4bed4d['id'],_0x2309af(0xa0),_0x164a81,_0x11aac0),_0x533677()):genTiny(_0x533677,dbFileIndex,_0x560316,_0x4bed4d,_0x164a81,_0x11aac0);});}else _0x533677('noData');});}let bgTaskId;try{let info=dbOther['prepare']('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')[_0x2db4ca(0xc2)]('GEN_TINY_IMAGE');bgTaskId=info[_0x2db4ca(0x9a)];}catch(_0x4f479c){}let genCount=0x0;async function runGen(){const _0x802c7e=_0x2db4ca;try{let _0xd98f23=await genStart(dbFileIndexTable[_0x802c7e(0xae)]);_0xd98f23!=_0x802c7e(0xc4)&&(genCount+=0x1);let _0x3d9877=await genStart(dbFileIndexTable[_0x802c7e(0x96)]);if(_0xd98f23=='noData'&&_0x3d9877==_0x802c7e(0xc4)){try{bgTaskId&&dbOther[_0x802c7e(0xac)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27')[_0x802c7e(0xc2)]();}catch(_0x88fe84){}genCount>0x0&&process['send']({'type':_0x802c7e(0x9e)}),process['send']({'type':_0x802c7e(0xb7)}),process[_0x802c7e(0xca)]();}else return runGen();}catch(_0x532506){return console[_0x802c7e(0xc7)](_0x532506),runGen();}}runGen();function exitProcess(){const _0x193060=_0x2db4ca;process[_0x193060(0xb0)]({'type':_0x193060(0xb7)}),process[_0x193060(0xca)]();}process['on'](_0x2db4ca(0xa3),(_0x10cc30,_0x38e810)=>{const _0x17199b=_0x2db4ca;console[_0x17199b(0xc7)](_0x17199b(0xb8),_0x10cc30),exitProcess();});