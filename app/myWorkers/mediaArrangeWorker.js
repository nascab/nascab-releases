const _0x48d722=_0xd0d0;(function(_0x34ac2f,_0x15ce0c){const _0x220cb6=_0xd0d0,_0x14de2e=_0x34ac2f();while(!![]){try{const _0x5a5d2b=parseInt(_0x220cb6(0xee))/0x1+-parseInt(_0x220cb6(0x105))/0x2*(parseInt(_0x220cb6(0x106))/0x3)+-parseInt(_0x220cb6(0xea))/0x4*(-parseInt(_0x220cb6(0x118))/0x5)+parseInt(_0x220cb6(0xe7))/0x6+-parseInt(_0x220cb6(0x10f))/0x7*(parseInt(_0x220cb6(0xef))/0x8)+-parseInt(_0x220cb6(0x113))/0x9*(parseInt(_0x220cb6(0xfb))/0xa)+parseInt(_0x220cb6(0xf1))/0xb*(parseInt(_0x220cb6(0xf3))/0xc);if(_0x5a5d2b===_0x15ce0c)break;else _0x14de2e['push'](_0x14de2e['shift']());}catch(_0x26d716){_0x14de2e['push'](_0x14de2e['shift']());}}}(_0x131b,0xb24dd));const Database=require(_0x48d722(0xe5)),config=require(_0x48d722(0x10a));let dbOther=new Database(config[_0x48d722(0x100)],{});dbOther[_0x48d722(0x10e)](_0x48d722(0xfe));function _0x131b(){const _0x4fe814=['46370XJThkL','8wlkBQP','size','770429tCKXNJ','TASK_STATE_FAIL','336ALReya','媒体整理\x20线程异常','isFile','join','taskData','readdirSync','mkdirSync','getI18n','70FuSOEE','无读取权限','W_OK','journal_mode\x20=\x20WAL','extname','dbOther','isDirectory','log','err1','send','44TvrgEj','90471nluGiv','create_time','accessSync','constants','../myConfig/config','getMonth','../db/dbMediaTools','noWritePermission','pragma','1807057vVlRrt','TASK_STATE_SUC','length','existsSync','624465TkvqTD','basename','R_OK','targetFolderNotExist','path','413425KaIOPW','cpSync','err2','exit','uncaughtException','TASK_STATE_RUNNING','../utils/i18nUtil','statSync','getFileTime','stringify','未传递任务数据','parse','fileCopyFail','folderNotExist','任务已不存在','better-sqlite3','dirname','284916SNKLUa','message','title','4mdsEbI','updateTask','task_json','复制文件夹'];_0x131b=function(){return _0x4fe814;};return _0x131b();}let path=require(_0x48d722(0x117)),fs=require('fs'),i18nUtil=require(_0x48d722(0xdc));const dbMediaTools=require(_0x48d722(0x10c)),mediaUtils=require('../utils/mediaUtils');let i18n=i18nUtil[_0x48d722(0xfa)](dbOther);process[_0x48d722(0xe9)]='NasCabMediaArrangeWorker';let currentTaskObj=null,copyFileCount=0x0,copySize=0x0,totalSize=0x0,failCount=0x0,taskExist=!![];async function copyFile(_0x33f1c8,_0x483894){const _0x25957c=_0x48d722;try{let _0x49ecb4=fs[_0x25957c(0xdd)](_0x33f1c8);totalSize+=_0x49ecb4['size'],fs[_0x25957c(0xd7)](_0x33f1c8,_0x483894,{'preserveTimestamps':!![]}),copySize+=_0x49ecb4[_0x25957c(0xf0)],copyFileCount+=0x1,updateTask(dbMediaTools[_0x25957c(0xdb)],JSON['stringify']({'copy_size':copySize,'copy_count':copyFileCount,'fail_count':failCount}));}catch(_0x1b303e){failCount+=0x1;}}function genFilePath(_0x38937a){const _0x114cc4=_0x48d722;if(!fs[_0x114cc4(0x112)](_0x38937a))return _0x38937a;let _0x450846=path[_0x114cc4(0x114)](_0x38937a,path[_0x114cc4(0xff)](_0x38937a)),_0x342793=path[_0x114cc4(0xff)](_0x38937a),_0x58a501=0x1;while(!![]){let _0x170acb=_0x450846+'('+_0x58a501+')'+_0x342793,_0x489038=path['join'](path[_0x114cc4(0xe6)](_0x38937a),_0x170acb);if(!fs[_0x114cc4(0x112)](_0x489038))return _0x489038;_0x58a501+=0x1;}}async function copyFolder(_0x2d5ec9,_0xeec95f){const _0x2a5965=_0x48d722;console[_0x2a5965(0x102)](_0x2a5965(0xed),_0x2d5ec9);let _0x414075=checkFolderPower(_0x2d5ec9,!![]);if(!_0x414075)console[_0x2a5965(0x102)](_0x2a5965(0xfc),_0x2d5ec9),failCount+=0x1;else try{let _0x1d4f6f=fs[_0x2a5965(0xf8)](_0x2d5ec9);for(let _0x17605f=0x0;_0x17605f<_0x1d4f6f[_0x2a5965(0x111)];_0x17605f++){if(!taskExist||!currentTaskObjIsExist()){console[_0x2a5965(0x102)](_0x2a5965(0xe4));return;}let _0x4233d3=_0x1d4f6f[_0x17605f];var _0x480530=path[_0x2a5965(0xf6)](_0x2d5ec9,_0x4233d3);let _0x1b7723=fs['statSync'](_0x480530);var _0x3922b5=_0x1b7723[_0x2a5965(0xf5)](),_0x147beb=_0x1b7723[_0x2a5965(0x101)]();if(_0x3922b5){let _0x463e53=await mediaUtils[_0x2a5965(0xde)](_0x480530),_0x2c6bec=new Date(_0x463e53),_0x36f48f=_0x2c6bec['getFullYear'](),_0x1724d1=_0x2c6bec[_0x2a5965(0x10b)]()+0x1,_0x3fbde4=_0x2c6bec['getDate'](),_0x3343cb=path[_0x2a5965(0xf6)](_0xeec95f,_0x36f48f+'',_0x1724d1+'',_0x3fbde4+'');!fs[_0x2a5965(0x112)](_0x3343cb)&&fs[_0x2a5965(0xf9)](_0x3343cb,{'recursive':!![]});let _0xc0463b=path['join'](_0x3343cb,_0x4233d3);_0xc0463b=genFilePath(_0xc0463b),await copyFile(_0x480530,_0xc0463b);}else _0x147beb&&await copyFolder(_0x480530,_0xeec95f);}}catch(_0x26f370){console['log'](_0x26f370),failCount+=0x1;}}function checkFolderPower(_0x37141a,_0x2c35a6){const _0x154580=_0x48d722;try{return _0x2c35a6?fs[_0x154580(0x108)](_0x37141a,fs['constants'][_0x154580(0x115)]):fs['accessSync'](_0x37141a,fs[_0x154580(0x109)][_0x154580(0x115)]|fs[_0x154580(0x109)][_0x154580(0xfd)]),!![];}catch(_0x1bf0fe){return![];}}async function runCurrentTask(){const _0x4702df=_0x48d722;let _0x44621e=currentTaskObj[_0x4702df(0xf7)]['source_path'],_0x500877=currentTaskObj['taskData']['target_path'];if(!fs['existsSync'](_0x500877)){console[_0x4702df(0x102)](_0x4702df(0x103),i18n['__'](_0x4702df(0x116))),updateTask(dbMediaTools[_0x4702df(0xf2)],i18n['__']('targetFolderNotExist'));return;}let _0xf275dc=checkFolderPower(_0x500877);if(!_0xf275dc){console[_0x4702df(0x102)](_0x4702df(0xd8),i18n['__'](_0x4702df(0x10d))),updateTask(dbMediaTools[_0x4702df(0xf2)],i18n['__'](_0x4702df(0x10d)));return;}updateTask(dbMediaTools[_0x4702df(0xdb)],''),copyFileCount=0x0,copySize=0x0,excludeCount=0x0,totalSize=0x0;try{fs[_0x4702df(0x112)](_0x44621e)?(await copyFolder(_0x44621e,_0x500877),updateTask(dbMediaTools[_0x4702df(0x110)],JSON[_0x4702df(0xdf)]({'copy_size':copySize,'copy_count':copyFileCount,'fail_count':failCount}))):updateTask(dbMediaTools['TASK_STATE_FAIL'],i18n['__'](_0x4702df(0xe3))+':'+_0x44621e);}catch(_0x2f498a){console[_0x4702df(0x102)](_0x2f498a),updateTask(dbMediaTools[_0x4702df(0xf2)],i18n['__'](_0x4702df(0xe2))+':'+_0x44621e+':'+JSON[_0x4702df(0xdf)](_0x2f498a));}}function exitProcess(){const _0x5b8b77=_0x48d722;console[_0x5b8b77(0x102)]('结束媒体整理线程'),process[_0x5b8b77(0x104)]({'type':'close'}),process[_0x5b8b77(0xd9)]();}function updateTask(_0x256884,_0x42fe9a){const _0x7242c2=_0x48d722;dbMediaTools[_0x7242c2(0xeb)](dbOther,currentTaskObj['id'],_0x256884,_0x42fe9a);}function _0xd0d0(_0x1178e6,_0x2dda9e){const _0x131b02=_0x131b();return _0xd0d0=function(_0xd0d0d,_0x4cb2da){_0xd0d0d=_0xd0d0d-0xd7;let _0x25e21e=_0x131b02[_0xd0d0d];return _0x25e21e;},_0xd0d0(_0x1178e6,_0x2dda9e);}function currentTaskObjIsExist(){const _0x5dda83=_0x48d722;if(currentTaskObj){let _0x340c70=dbMediaTools['getByIdAndCreateTime'](dbOther,currentTaskObj['id'],currentTaskObj[_0x5dda83(0x107)]);if(_0x340c70)return!![];}return taskExist=![],console[_0x5dda83(0x102)](_0x5dda83(0xe4)),![];}process['on'](_0x48d722(0xe8),async _0xea8479=>{const _0x1f261d=_0x48d722;_0xea8479['taskObj']?(currentTaskObj=_0xea8479['taskObj'],currentTaskObj['taskData']=JSON[_0x1f261d(0xe1)](currentTaskObj[_0x1f261d(0xec)]),await runCurrentTask(),exitProcess()):(console[_0x1f261d(0x102)](_0x1f261d(0xe0)),exitProcess());}),process['on'](_0x48d722(0xda),_0x341f68=>{const _0x4144d7=_0x48d722;console[_0x4144d7(0x102)](_0x4144d7(0xf4),_0x341f68),exitProcess();});