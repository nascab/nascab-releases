const _0x1a670f=_0x4e80;(function(_0x388982,_0x598726){const _0x17f119=_0x4e80,_0x38dac0=_0x388982();while(!![]){try{const _0x3a8571=-parseInt(_0x17f119(0x1d1))/0x1*(-parseInt(_0x17f119(0x192))/0x2)+parseInt(_0x17f119(0x197))/0x3*(parseInt(_0x17f119(0x1c8))/0x4)+parseInt(_0x17f119(0x1d0))/0x5+parseInt(_0x17f119(0x198))/0x6+-parseInt(_0x17f119(0x1ce))/0x7+-parseInt(_0x17f119(0x1d8))/0x8+-parseInt(_0x17f119(0x1d7))/0x9;if(_0x3a8571===_0x598726)break;else _0x38dac0['push'](_0x38dac0['shift']());}catch(_0x2f9335){_0x38dac0['push'](_0x38dac0['shift']());}}}(_0xd97b,0xd790e));function _0x4e80(_0x4be599,_0x4d212b){const _0xd97bb=_0xd97b();return _0x4e80=function(_0x4e803f,_0x27dd87){_0x4e803f=_0x4e803f-0x183;let _0x277a8a=_0xd97bb[_0x4e803f];return _0x277a8a;},_0x4e80(_0x4be599,_0x4d212b);}let path=require(_0x1a670f(0x1ad)),fs=require('fs');const dbFileOperationRecord=require(_0x1a670f(0x1d9)),config=require('../../myConfig/config'),Database=require(_0x1a670f(0x1c7));let dbOther=new Database(config['dbOther'],{});dbOther[_0x1a670f(0x18f)]('journal_mode\x20=\x20WAL');let i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x1a670f(0x1a9)](dbOther);const compressing=require(_0x1a670f(0x1c3)),mkdirp=require('mkdirp'),fileUtils=require(_0x1a670f(0x1a7));process[_0x1a670f(0x1c0)]=_0x1a670f(0x1a3);function _0xd97b(){const _0x21dea7=['replace','../../express-server/utils/fileUtils','notSupportFileFormat','getI18n','end','type','taskIdList','path','updateRecordRemark','updateRecordState','pipe','.tar','FileStream','parse','dirname','substring','send','.gzip','createWriteStream','close','finish','isFile','task_state','STATE_FAIL','prepare','statSync','title','username','copy','compressing','size','entry','cpSync','better-sqlite3','742312MwDHnL','STATE_DOING','log','Stream','basename','sourcePath','7016835savBja','addFileOperationRecord','7312470PZUsKW','471DtjOnb','data','zip','run','isDirectory','file.cutCopySucButDeleteFail','10826037WVeJNe','7129448PrZHRG','../../db/dbFileOperationRecord','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','message','cut','sameNameFileAlreadExist','UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id=','rename','resume','existsSync','task_json','length','R_OK','targetPath','.zip','pragma','addEntry','LEVEL_MAIN_OPERATION','3774qyExCh','get','extname','file.taskCancel','STATE_SUC','15ootnJi','4201656nsXhjo','select\x20task_state\x20from\x20bg_task\x20where\x20id=','destroy','readdirSync','error','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','accessSync','mkdirSync','constants','unzip','.tgz','NasCabFileWorker','exit','join'];_0xd97b=function(){return _0x21dea7;};return _0xd97b();}let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x183cbd,_0x5c850a){const _0x2d970b=_0x1a670f;if(fs[_0x2d970b(0x189)](_0x183cbd)){let _0x369ab8=path[_0x2d970b(0x1cc)](_0x183cbd),_0x43896f=path['dirname'](_0x183cbd),_0x3538a9=path['extname'](_0x183cbd),_0x4a07a6=_0x369ab8[_0x2d970b(0x1a6)](_0x3538a9,'')+('('+_0x5c850a+')')+_0x3538a9,_0xda7a5e=path[_0x2d970b(0x1a5)](_0x43896f,_0x4a07a6);return getTargetFullPath(_0xda7a5e,_0x5c850a+0x1);}else return _0x183cbd;}function copyFile(_0x3ff019,_0x11f1d4,_0xfefcdb,_0x2e6c06){const _0x497476=_0x1a670f;try{let _0x4385fc=dbOther[_0x497476(0x1be)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+taskObj['id'])[_0x497476(0x193)]();if(!_0x4385fc||_0x4385fc[_0x497476(0x1bc)]!=0x1)return paused=!![],![];let _0x1882bb=fs[_0x497476(0x1bf)](_0x11f1d4);return _0xfefcdb=getTargetFullPath(_0xfefcdb,0x1),fs[_0x497476(0x1c6)](_0x11f1d4,_0xfefcdb),copySize+=_0x1882bb[_0x497476(0x1c4)],copyFileCount+=0x1,dbOther[_0x497476(0x1be)]('UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?')[_0x497476(0x1d4)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x3fb0ae){return console[_0x497476(0x1ca)](_0x3fb0ae),dbFileOperationRecord[_0x497476(0x1ae)](dbOther,currentFileOperationRecordId,fileUtils['getFileErrStr'](i18n,_0x3fb0ae)),![];}}function copyFolder(_0x44b1f2,_0x26a8b1,_0x163b87,_0x3ee4aa,_0x515148){const _0x3d093b=_0x1a670f;try{fs[_0x3d093b(0x19e)](_0x163b87,fs[_0x3d093b(0x1a0)][_0x3d093b(0x18c)]);let _0x2bfc01=fs[_0x3d093b(0x19b)](_0x163b87);for(let _0x3deae3=0x0;_0x3deae3<_0x2bfc01[_0x3d093b(0x18b)];_0x3deae3++){if(paused)return![];let _0x3554e9=_0x2bfc01[_0x3deae3];var _0x5b491e=path[_0x3d093b(0x1a5)](_0x163b87,_0x3554e9);let _0x399928=path[_0x3d093b(0x1a5)](_0x3ee4aa,_0x5b491e[_0x3d093b(0x1b5)](_0x26a8b1[_0x3d093b(0x18b)])),_0x349daa=fs[_0x3d093b(0x1bf)](_0x5b491e);if(_0x349daa[_0x3d093b(0x1bb)]()){let _0x3faf83=copyFile(_0x44b1f2,_0x5b491e,_0x399928,_0x515148);if(_0x3faf83===![])return paused=!![],dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__'](_0x3d093b(0x195))),![];}else _0x349daa['isDirectory']()&&(!fs[_0x3d093b(0x189)](_0x399928)&&fs[_0x3d093b(0x19f)](_0x399928,{'recursive':!![]}),copyFolder(_0x44b1f2,_0x26a8b1,_0x5b491e,_0x3ee4aa,_0x515148));}if(paused)return![];return!![];}catch(_0x2012e4){return![];}}async function doFileOperation(_0x22c813,_0x505304){const _0x1e5c17=_0x1a670f;let _0x4f744c=_0x22c813['sourcePath'],_0xfe99e1=_0x22c813[_0x1e5c17(0x18d)],_0x382ac9=_0x22c813[_0x1e5c17(0x1ab)];function _0x2bd660(_0x4e22d6,_0x62655){const _0x47e84d=_0x1e5c17;if(_0x4e22d6)taskObj=_0x4e22d6;dbOther['prepare'](_0x47e84d(0x186)+taskObj['id'])[_0x47e84d(0x1d4)](),dbFileOperationRecord[_0x47e84d(0x1af)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x47e84d(0x1bd)]),_0x62655&&dbFileOperationRecord[_0x47e84d(0x1ae)](dbOther,currentFileOperationRecordId,_0x62655),_0x505304();}function _0x2d7014(_0x24105f,_0x1b4725){const _0x1c4179=_0x1e5c17;if(_0x24105f)taskObj=_0x24105f;dbOther[_0x1c4179(0x1be)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+taskObj['id'])['run'](),_0x382ac9==_0x1c4179(0x184)&&_0x1b4725?fs['rm'](_0x4f744c,{'recursive':!![]},_0x4b2aea=>{const _0x3887f0=_0x1c4179;_0x4b2aea?(dbFileOperationRecord[_0x3887f0(0x1af)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x3887f0(0x1bd)]),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__'](_0x3887f0(0x1d6)))):dbFileOperationRecord[_0x3887f0(0x1af)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_SUC']),_0x505304();}):(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1c4179(0x196)]),_0x505304());}try{let _0x418731=fs[_0x1e5c17(0x1bf)](_0x4f744c);function _0x492edf(_0x212ae3){const _0x2987be=_0x1e5c17;if(_0x418731['isFile']()){let _0x49d93f=copyFile(_0x22c813,_0x4f744c,_0xfe99e1,_0x382ac9);_0x49d93f?_0x2d7014(_0x212ae3,!![]):_0x2bd660(_0x212ae3);}else{if(_0x418731[_0x2987be(0x1d5)]()){_0xfe99e1=getTargetFullPath(_0xfe99e1,0x1);!fs['existsSync'](_0xfe99e1)&&fs[_0x2987be(0x19f)](_0xfe99e1,{'recursive':!![]});let _0x3a2ae3=copyFolder(_0x22c813,_0x4f744c,_0x4f744c,_0xfe99e1,_0x382ac9);_0x3a2ae3?_0x2d7014(_0x212ae3,!![]):_0x2bd660(_0x212ae3);}}}if(_0x382ac9==_0x1e5c17(0x1c2))_0x492edf(taskObj);else{if(_0x382ac9==_0x1e5c17(0x184))fs[_0x1e5c17(0x187)](_0x4f744c,_0xfe99e1,_0xf6aa3e=>{if(_0xf6aa3e)return _0x492edf(taskObj);else _0x2d7014(taskObj,![]);});else{if(_0x382ac9==_0x1e5c17(0x1d3)){let _0x3f96e6=path[_0x1e5c17(0x1cc)](_0x4f744c),_0x1f3bde=path[_0x1e5c17(0x1a5)](_0xfe99e1,_0x3f96e6+_0x1e5c17(0x18e));if(fs[_0x1e5c17(0x189)](_0x1f3bde))return _0x2bd660(taskObj,i18n['__'](_0x1e5c17(0x185))+':'+_0x1f3bde);let _0x14d7dd=fs[_0x1e5c17(0x1b8)](_0x1f3bde),_0x2aec1d=taskObj,_0x4e1e0e=0x0,_0x58e319=0x0,_0x3f5fb9,_0x1a1ad2=![];if(_0x418731[_0x1e5c17(0x1bb)]())_0x3f5fb9=new compressing[(_0x1e5c17(0x1d3))][(_0x1e5c17(0x1b2))]({'source':_0x4f744c});else _0x418731[_0x1e5c17(0x1d5)]()&&(_0x3f5fb9=new compressing[(_0x1e5c17(0x1d3))][(_0x1e5c17(0x1cb))](),_0x3f5fb9[_0x1e5c17(0x190)](_0x4f744c));_0x3f5fb9['on'](_0x1e5c17(0x1d2),_0x3c2eb7=>{const _0x49673f=_0x1e5c17;_0x4e1e0e+=_0x3c2eb7[_0x49673f(0x18b)];let _0x58e422=_0x4e1e0e/0x400/0x400;if(_0x58e422>_0x58e319+0x64){_0x58e319=_0x58e422,dbOther[_0x49673f(0x1be)](_0x49673f(0x19d))[_0x49673f(0x1d4)](_0x4e1e0e,_0x2aec1d['id']);let _0x40379e=dbOther[_0x49673f(0x1be)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+_0x2aec1d['id'])[_0x49673f(0x193)]();(!_0x40379e||_0x40379e[_0x49673f(0x1bc)]!=0x1&&!_0x1a1ad2)&&(_0x14d7dd[_0x49673f(0x1b9)](),_0x3f5fb9['destroy'](),_0x2bd660(_0x2aec1d));}}),_0x3f5fb9[_0x1e5c17(0x1b0)](_0x14d7dd),_0x3f5fb9['on'](_0x1e5c17(0x19c),_0x10a7a0=>{const _0x59c22a=_0x1e5c17;_0x14d7dd[_0x59c22a(0x1b9)](),_0x2bd660(_0x2aec1d);}),_0x14d7dd['on'](_0x1e5c17(0x19c),_0x188a36=>{const _0xbd7e62=_0x1e5c17;_0x14d7dd[_0xbd7e62(0x1b9)](),_0x2bd660(_0x2aec1d);}),_0x14d7dd['on'](_0x1e5c17(0x1ba),()=>{const _0x1eea14=_0x1e5c17;_0x1a1ad2=!![],_0x14d7dd[_0x1eea14(0x1b9)](),_0x2d7014(_0x2aec1d);});}else{if(_0x382ac9==_0x1e5c17(0x1a1)){let _0x105648=taskObj,_0x4f11f3=path[_0x1e5c17(0x194)](_0x4f744c),_0x3c897d=[_0x1e5c17(0x1b1),_0x1e5c17(0x1b7),_0x1e5c17(0x1a2),'.zip'];if(!_0x4f11f3||!_0x3c897d['includes'](_0x4f11f3))return _0x2bd660(_0x105648,i18n['__'](_0x1e5c17(0x1a8)));let _0xa0416a=0x0,_0x437bb5=0x0,_0x20710f,_0x26e6f2=new compressing[(_0x4f11f3['replace']('.',''))]['UncompressStream']({'source':_0x4f744c});_0x26e6f2['on'](_0x1e5c17(0x19c),_0x238c61=>{const _0x214c85=_0x1e5c17;_0x20710f&&(_0x20710f[_0x214c85(0x1b9)](),_0x20710f=null),_0x2bd660(_0x105648);}),_0x26e6f2['on'](_0x1e5c17(0x1ba),()=>{const _0x1744ac=_0x1e5c17;_0x20710f&&(_0x20710f[_0x1744ac(0x1b9)](),_0x20710f=null),_0x2d7014(_0x105648);}),_0x26e6f2['on'](_0x1e5c17(0x1c5),(_0x2fa594,_0x1dcc13,_0x2438b5)=>{const _0x29b198=_0x1e5c17;_0x1dcc13['on'](_0x29b198(0x1aa),_0x2438b5);let _0x3673bc=path['join'](_0xfe99e1,_0x2fa594['name']),_0x4e154b=path[_0x29b198(0x1b4)](_0x3673bc);!fs[_0x29b198(0x189)](_0x4e154b)&&fs[_0x29b198(0x19f)](_0x4e154b,{'recursive':!![]}),_0x20710f=fs[_0x29b198(0x1b8)](_0x3673bc),_0x20710f['on'](_0x29b198(0x19c),_0xe01471=>{const _0x556981=_0x29b198;console[_0x556981(0x1ca)](_0xe01471);}),_0x2fa594[_0x29b198(0x1ab)]==='file'?(_0x1dcc13['on']('data',_0x233b6b=>{const _0x4061ff=_0x29b198;_0xa0416a+=_0x233b6b[_0x4061ff(0x18b)];let _0x56f4af=_0xa0416a/0x400/0x400;if(_0x56f4af>_0x437bb5+0x64){_0x437bb5=_0x56f4af,dbOther[_0x4061ff(0x1be)](_0x4061ff(0x19d))[_0x4061ff(0x1d4)](_0xa0416a,_0x105648['id']);let _0x468386=dbOther[_0x4061ff(0x1be)](_0x4061ff(0x199)+_0x105648['id'])[_0x4061ff(0x193)]();if(!_0x468386||_0x468386[_0x4061ff(0x1bc)]!=0x1&&!isFinish)return _0x20710f[_0x4061ff(0x1b9)](),_0x1dcc13['on'](_0x4061ff(0x1aa),()=>{}),_0x1dcc13[_0x4061ff(0x19a)](),_0x20710f[_0x4061ff(0x19a)](),_0x26e6f2['destroy'](),_0x2bd660(_0x105648);}}),_0x1dcc13[_0x29b198(0x1b0)](_0x20710f)):mkdirp(path['join'](_0xfe99e1,_0x2fa594['name']),_0x366d02=>{const _0x1915f6=_0x29b198;if(_0x366d02)return;_0x1dcc13[_0x1915f6(0x188)]();});});}else _0x2d7014();}}}}catch(_0xb7740c){console['log'](_0xb7740c),_0x2bd660();}}async function taskStart(_0x137176){return new Promise((_0x25a1a3,_0x3de9ac)=>{const _0x589c1b=_0x4e80;taskObj=dbOther['prepare']('SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id='+_0x137176)['get']();if(taskObj){taskParams=JSON[_0x589c1b(0x1b3)](taskObj[_0x589c1b(0x18a)]),dbOther[_0x589c1b(0x1be)](_0x589c1b(0x1da)+taskObj['id'])[_0x589c1b(0x1d4)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x3445e6=dbFileOperationRecord[_0x589c1b(0x1cf)](dbOther,{'username':taskParams[_0x589c1b(0x1c1)],'sourcePath':taskParams[_0x589c1b(0x1cd)],'targetPath':taskParams[_0x589c1b(0x18d)],'level':dbFileOperationRecord[_0x589c1b(0x191)],'type':taskParams[_0x589c1b(0x1ab)],'state':dbFileOperationRecord[_0x589c1b(0x1c9)]});_0x3445e6&&(currentFileOperationRecordId=_0x3445e6['lastInsertRowid']),doFileOperation(taskParams,_0x25a1a3);}else _0x25a1a3();});}function exitProcess(){const _0x51b7ce=_0x1a670f;process[_0x51b7ce(0x1b6)]({'type':_0x51b7ce(0x1b9)}),process[_0x51b7ce(0x1a4)]();}process['on'](_0x1a670f(0x183),async _0x4f2cf9=>{const _0x4e5c2a=_0x1a670f;try{if(_0x4f2cf9[_0x4e5c2a(0x1ac)]&&_0x4f2cf9[_0x4e5c2a(0x1ac)][_0x4e5c2a(0x18b)]>0x0){for(let _0x31e2d1 in _0x4f2cf9[_0x4e5c2a(0x1ac)]){await taskStart(_0x4f2cf9[_0x4e5c2a(0x1ac)][_0x31e2d1]);}exitProcess();}else exitProcess();}catch(_0x29d5d5){exitProcess();}});