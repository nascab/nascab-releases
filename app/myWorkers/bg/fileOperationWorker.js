const _0x454084=_0x5b41;(function(_0x36a098,_0x133b6d){const _0x72b1c2=_0x5b41,_0x170211=_0x36a098();while(!![]){try{const _0x2fd3b7=parseInt(_0x72b1c2(0x10a))/0x1*(parseInt(_0x72b1c2(0xec))/0x2)+parseInt(_0x72b1c2(0xf5))/0x3*(-parseInt(_0x72b1c2(0xd1))/0x4)+-parseInt(_0x72b1c2(0xfe))/0x5+-parseInt(_0x72b1c2(0xea))/0x6+parseInt(_0x72b1c2(0xdc))/0x7+-parseInt(_0x72b1c2(0xd5))/0x8+parseInt(_0x72b1c2(0x107))/0x9*(parseInt(_0x72b1c2(0xf4))/0xa);if(_0x2fd3b7===_0x133b6d)break;else _0x170211['push'](_0x170211['shift']());}catch(_0x5ddfbb){_0x170211['push'](_0x170211['shift']());}}}(_0x4205,0x8917f));let path=require('path'),fs=require('fs');const dbFileOperationRecord=require('../../db/dbFileOperationRecord'),config=require('../../myConfig/config'),Database=require(_0x454084(0xf7));let dbOther=new Database(config[_0x454084(0xdb)],{});function _0x5b41(_0x13b4d5,_0x5dd022){const _0x420566=_0x4205();return _0x5b41=function(_0x5b4125,_0xb14203){_0x5b4125=_0x5b4125-0xc8;let _0x57b2f0=_0x420566[_0x5b4125];return _0x57b2f0;},_0x5b41(_0x13b4d5,_0x5dd022);}dbOther[_0x454084(0x118)](_0x454084(0xe7));let i18nUtil=require(_0x454084(0xca)),i18n=i18nUtil['getI18n'](dbOther);const compressing=require(_0x454084(0x115)),mkdirp=require(_0x454084(0xcf)),fileUtils=require('../../express-server/utils/fileUtils');process['title']=_0x454084(0x11b);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x174b5e,_0xbafae3){const _0x5ceeba=_0x454084;if(fs[_0x5ceeba(0xe9)](_0x174b5e)){let _0x2eb6eb=path['basename'](_0x174b5e),_0x267d10=path[_0x5ceeba(0xd7)](_0x174b5e),_0x3b271f=path['extname'](_0x174b5e),_0x2bab11=_0x2eb6eb[_0x5ceeba(0xff)](_0x3b271f,'')+('('+_0xbafae3+')')+_0x3b271f,_0x3e2fac=path[_0x5ceeba(0xe0)](_0x267d10,_0x2bab11);return getTargetFullPath(_0x3e2fac,_0xbafae3+0x1);}else return _0x174b5e;}function copyFile(_0x3c8686,_0x469484,_0x2f6610,_0x551966){const _0x46d1f9=_0x454084;try{let _0x4980fd=dbOther[_0x46d1f9(0x102)](_0x46d1f9(0x119)+taskObj['id'])[_0x46d1f9(0x113)]();if(!_0x4980fd||_0x4980fd[_0x46d1f9(0xeb)]!=0x1)return paused=!![],![];let _0x51a2a8=fs[_0x46d1f9(0xcc)](_0x469484);return _0x2f6610=getTargetFullPath(_0x2f6610,0x1),fs[_0x46d1f9(0xd2)](_0x469484,_0x2f6610),copySize+=_0x51a2a8[_0x46d1f9(0x101)],copyFileCount+=0x1,dbOther['prepare'](_0x46d1f9(0xfc))[_0x46d1f9(0x10b)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x3fbba3){return console[_0x46d1f9(0xc9)](_0x3fbba3),dbFileOperationRecord[_0x46d1f9(0xd8)](dbOther,currentFileOperationRecordId,fileUtils['getFileErrStr'](i18n,_0x3fbba3)),![];}}function copyFolder(_0x2f24e8,_0xb15b3,_0x1313a7,_0x49bbea,_0x581228){const _0x1d215d=_0x454084;try{fs[_0x1d215d(0xe8)](_0x1313a7,fs[_0x1d215d(0xda)][_0x1d215d(0x114)]);let _0x4504a1=fs[_0x1d215d(0xcb)](_0x1313a7);for(let _0x20e55e=0x0;_0x20e55e<_0x4504a1[_0x1d215d(0xde)];_0x20e55e++){if(paused)return![];let _0x4ee5b3=_0x4504a1[_0x20e55e];var _0x5497f0=path[_0x1d215d(0xe0)](_0x1313a7,_0x4ee5b3);let _0x5bbba=path['join'](_0x49bbea,_0x5497f0[_0x1d215d(0x111)](_0xb15b3[_0x1d215d(0xde)])),_0x54ec33=fs[_0x1d215d(0xcc)](_0x5497f0);if(_0x54ec33[_0x1d215d(0x104)]()){let _0x142819=copyFile(_0x2f24e8,_0x5497f0,_0x5bbba,_0x581228);if(_0x142819===![])return paused=!![],dbFileOperationRecord[_0x1d215d(0xd8)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x54ec33[_0x1d215d(0xd6)]()&&(!fs['existsSync'](_0x5bbba)&&fs['mkdirSync'](_0x5bbba,{'recursive':!![]}),copyFolder(_0x2f24e8,_0xb15b3,_0x5497f0,_0x49bbea,_0x581228));}if(paused)return![];return!![];}catch(_0x4f8396){return![];}}async function doFileOperation(_0x1f5422,_0x1acce4){const _0x2b7626=_0x454084;let _0x43a752=_0x1f5422[_0x2b7626(0xf3)],_0x472331=_0x1f5422[_0x2b7626(0xdf)],_0x2c7a4c=_0x1f5422['type'];function _0x70db54(_0x1c233c,_0x35ae88){const _0x1db4a3=_0x2b7626;if(_0x1c233c)taskObj=_0x1c233c;dbOther[_0x1db4a3(0x102)](_0x1db4a3(0xfa)+taskObj['id'])[_0x1db4a3(0x10b)](),dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1db4a3(0xc8)]),_0x35ae88&&dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,_0x35ae88),_0x1acce4();}function _0x6b53a0(_0x11fc4d,_0x41c64b){const _0x499889=_0x2b7626;if(_0x11fc4d)taskObj=_0x11fc4d;dbOther['prepare']('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+taskObj['id'])[_0x499889(0x10b)](),_0x2c7a4c=='cut'&&_0x41c64b?fs['rm'](_0x43a752,{'recursive':!![]},_0x5d0113=>{const _0x3bb911=_0x499889;_0x5d0113?(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x3bb911(0xc8)]),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__']('file.cutCopySucButDeleteFail'))):dbFileOperationRecord[_0x3bb911(0xe5)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_SUC']),_0x1acce4();}):(dbFileOperationRecord[_0x499889(0xe5)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x499889(0xfb)]),_0x1acce4());}try{let _0x493fb8=fs['statSync'](_0x43a752);function _0x58c6d2(_0x848049){const _0x5f35f9=_0x2b7626;if(_0x493fb8['isFile']()){let _0x351c8d=copyFile(_0x1f5422,_0x43a752,_0x472331,_0x2c7a4c);_0x351c8d?_0x6b53a0(_0x848049,!![]):_0x70db54(_0x848049);}else{if(_0x493fb8[_0x5f35f9(0xd6)]()){_0x472331=getTargetFullPath(_0x472331,0x1);!fs[_0x5f35f9(0xe9)](_0x472331)&&fs[_0x5f35f9(0xce)](_0x472331,{'recursive':!![]});let _0x59411b=copyFolder(_0x1f5422,_0x43a752,_0x43a752,_0x472331,_0x2c7a4c);_0x59411b?_0x6b53a0(_0x848049,!![]):_0x70db54(_0x848049);}}}if(_0x2c7a4c==_0x2b7626(0xd0))_0x58c6d2(taskObj);else{if(_0x2c7a4c==_0x2b7626(0x109))fs['rename'](_0x43a752,_0x472331,_0x23333b=>{if(_0x23333b)return _0x58c6d2(taskObj);else _0x6b53a0(taskObj,![]);});else{if(_0x2c7a4c==_0x2b7626(0x117)){let _0x3630f7=path['basename'](_0x43a752),_0xa03088=path[_0x2b7626(0xe0)](_0x472331,_0x3630f7+_0x2b7626(0x116));if(fs[_0x2b7626(0xe9)](_0xa03088))return _0x70db54(taskObj,i18n['__'](_0x2b7626(0xd4))+':'+_0xa03088);let _0x55ff8f=fs['createWriteStream'](_0xa03088),_0xecaf65=taskObj,_0x755ec0=0x0,_0x283fd6=0x0,_0x1ff821,_0x55ab4f=![];if(_0x493fb8[_0x2b7626(0x104)]())_0x1ff821=new compressing[(_0x2b7626(0x117))][(_0x2b7626(0x10f))]({'source':_0x43a752});else _0x493fb8['isDirectory']()&&(_0x1ff821=new compressing['zip'][(_0x2b7626(0xe4))](),_0x1ff821['addEntry'](_0x43a752));_0x1ff821['on']('data',_0x5ea192=>{const _0x1a70c2=_0x2b7626;_0x755ec0+=_0x5ea192[_0x1a70c2(0xde)];let _0x2b977b=_0x755ec0/0x400/0x400;if(_0x2b977b>_0x283fd6+0x64){_0x283fd6=_0x2b977b,dbOther[_0x1a70c2(0x102)](_0x1a70c2(0xf1))[_0x1a70c2(0x10b)](_0x755ec0,_0xecaf65['id']);let _0x350c00=dbOther['prepare'](_0x1a70c2(0x119)+_0xecaf65['id'])[_0x1a70c2(0x113)]();(!_0x350c00||_0x350c00[_0x1a70c2(0xeb)]!=0x1&&!_0x55ab4f)&&(_0x55ff8f[_0x1a70c2(0xe6)](),_0x1ff821['destroy'](),_0x70db54(_0xecaf65));}}),_0x1ff821[_0x2b7626(0xe2)](_0x55ff8f),_0x1ff821['on'](_0x2b7626(0xf6),_0x48b08d=>{const _0x1466a4=_0x2b7626;_0x55ff8f[_0x1466a4(0xe6)](),_0x70db54(_0xecaf65);}),_0x55ff8f['on']('error',_0x46e633=>{const _0x46741e=_0x2b7626;_0x55ff8f[_0x46741e(0xe6)](),_0x70db54(_0xecaf65);}),_0x55ff8f['on'](_0x2b7626(0xee),()=>{const _0x15ee28=_0x2b7626;_0x55ab4f=!![],_0x55ff8f[_0x15ee28(0xe6)](),_0x6b53a0(_0xecaf65);});}else{if(_0x2c7a4c=='unzip'){let _0x12fe8e=taskObj,_0x3a5aba=path[_0x2b7626(0xf9)](_0x43a752),_0x13de9d=[_0x2b7626(0x105),_0x2b7626(0xed),_0x2b7626(0x103),_0x2b7626(0x116)];if(!_0x3a5aba||!_0x13de9d[_0x2b7626(0xf0)](_0x3a5aba))return _0x70db54(_0x12fe8e,i18n['__']('notSupportFileFormat'));let _0x459af8=0x0,_0x5ef645=0x0,_0xe96e0d,_0x19e3a8=new compressing[(_0x3a5aba[_0x2b7626(0xff)]('.',''))][(_0x2b7626(0xef))]({'source':_0x43a752});_0x19e3a8['on'](_0x2b7626(0xf6),_0x4f6734=>{const _0x30060e=_0x2b7626;_0xe96e0d&&(_0xe96e0d[_0x30060e(0xe6)](),_0xe96e0d=null),_0x70db54(_0x12fe8e);}),_0x19e3a8['on']('finish',()=>{const _0x42262d=_0x2b7626;_0xe96e0d&&(_0xe96e0d[_0x42262d(0xe6)](),_0xe96e0d=null),_0x6b53a0(_0x12fe8e);}),_0x19e3a8['on'](_0x2b7626(0xe3),(_0x251d80,_0x25a224,_0x3f3cc2)=>{const _0x183650=_0x2b7626;_0x25a224['on'](_0x183650(0xfd),_0x3f3cc2);let _0x4066b9=path[_0x183650(0xe0)](_0x472331,_0x251d80['name']),_0x18b98e=path[_0x183650(0xd7)](_0x4066b9);!fs[_0x183650(0xe9)](_0x18b98e)&&fs[_0x183650(0xce)](_0x18b98e,{'recursive':!![]}),_0xe96e0d=fs[_0x183650(0xf8)](_0x4066b9),_0xe96e0d['on'](_0x183650(0xf6),_0x2de619=>{const _0x1e2f2e=_0x183650;console[_0x1e2f2e(0xc9)](_0x2de619);}),_0x251d80[_0x183650(0x110)]==='file'?(_0x25a224['on'](_0x183650(0x100),_0xbdf64c=>{const _0x1478ba=_0x183650;_0x459af8+=_0xbdf64c[_0x1478ba(0xde)];let _0x8fd842=_0x459af8/0x400/0x400;if(_0x8fd842>_0x5ef645+0x64){_0x5ef645=_0x8fd842,dbOther['prepare'](_0x1478ba(0xf1))[_0x1478ba(0x10b)](_0x459af8,_0x12fe8e['id']);let _0xaa8e3a=dbOther[_0x1478ba(0x102)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+_0x12fe8e['id'])['get']();if(!_0xaa8e3a||_0xaa8e3a[_0x1478ba(0xeb)]!=0x1&&!isFinish)return _0xe96e0d[_0x1478ba(0xe6)](),_0x25a224['on'](_0x1478ba(0xfd),()=>{}),_0x25a224[_0x1478ba(0xe1)](),_0xe96e0d[_0x1478ba(0xe1)](),_0x19e3a8['destroy'](),_0x70db54(_0x12fe8e);}}),_0x25a224['pipe'](_0xe96e0d)):mkdirp(path[_0x183650(0xe0)](_0x472331,_0x251d80[_0x183650(0x10c)]),_0x5d18e9=>{const _0x3e7a79=_0x183650;if(_0x5d18e9)return;_0x25a224[_0x3e7a79(0xd9)]();});});}else _0x6b53a0();}}}}catch(_0x5a5993){console[_0x2b7626(0xc9)](_0x5a5993),_0x70db54();}}async function taskStart(_0x4c2ed7){return new Promise((_0x112182,_0x180738)=>{const _0x48710f=_0x5b41;taskObj=dbOther[_0x48710f(0x102)](_0x48710f(0x106)+_0x4c2ed7)[_0x48710f(0x113)]();if(taskObj){taskParams=JSON[_0x48710f(0x10e)](taskObj[_0x48710f(0x108)]),dbOther[_0x48710f(0x102)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+taskObj['id'])['run'](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x66425e=dbFileOperationRecord[_0x48710f(0x10d)](dbOther,{'username':taskParams[_0x48710f(0x11c)],'sourcePath':taskParams['sourcePath'],'targetPath':taskParams['targetPath'],'level':dbFileOperationRecord[_0x48710f(0x112)],'type':taskParams[_0x48710f(0x110)],'state':dbFileOperationRecord[_0x48710f(0xdd)]});_0x66425e&&(currentFileOperationRecordId=_0x66425e[_0x48710f(0xcd)]),doFileOperation(taskParams,_0x112182);}else _0x112182();});}function exitProcess(){const _0x29869b=_0x454084;process['send']({'type':_0x29869b(0xe6)}),process[_0x29869b(0xd3)]();}function _0x4205(){const _0x24c0de=['error','better-sqlite3','createWriteStream','extname','UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id=','STATE_SUC','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','end','835615PzGILi','replace','data','size','prepare','.tgz','isFile','.tar','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','48924MJZLsj','task_json','cut','1EcdjoH','run','name','addFileOperationRecord','parse','FileStream','type','substring','LEVEL_MAIN_OPERATION','get','R_OK','compressing','.zip','zip','pragma','select\x20task_state\x20from\x20bg_task\x20where\x20id=','message','NasCabFileWorker','username','STATE_FAIL','log','../../utils/i18nUtil','readdirSync','statSync','lastInsertRowid','mkdirSync','mkdirp','copy','632hgqzWX','cpSync','exit','sameNameFileAlreadExist','5038456crbksE','isDirectory','dirname','updateRecordRemark','resume','constants','dbOther','4821173pYwnEp','STATE_DOING','length','targetPath','join','destroy','pipe','entry','Stream','updateRecordState','close','journal_mode\x20=\x20WAL','accessSync','existsSync','4038390PYaCdD','task_state','543254hhDASP','.gzip','finish','UncompressStream','includes','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','taskIdList','sourcePath','3000yVfufx','10626ZXuIPe'];_0x4205=function(){return _0x24c0de;};return _0x4205();}process['on'](_0x454084(0x11a),async _0x1d0689=>{const _0x41cffd=_0x454084;try{if(_0x1d0689[_0x41cffd(0xf2)]&&_0x1d0689[_0x41cffd(0xf2)][_0x41cffd(0xde)]>0x0){for(let _0x5a7fbb in _0x1d0689[_0x41cffd(0xf2)]){await taskStart(_0x1d0689[_0x41cffd(0xf2)][_0x5a7fbb]);}exitProcess();}else exitProcess();}catch(_0x6d1435){exitProcess();}});