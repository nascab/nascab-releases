const _0x2f67f1=_0xc66a;(function(_0x4ea0dc,_0x22b3c3){const _0x129013=_0xc66a,_0x165462=_0x4ea0dc();while(!![]){try{const _0x6cfd8d=parseInt(_0x129013(0x169))/0x1*(-parseInt(_0x129013(0x159))/0x2)+parseInt(_0x129013(0x16d))/0x3+parseInt(_0x129013(0x18a))/0x4+-parseInt(_0x129013(0x150))/0x5*(-parseInt(_0x129013(0x166))/0x6)+-parseInt(_0x129013(0x170))/0x7+-parseInt(_0x129013(0x182))/0x8+parseInt(_0x129013(0x190))/0x9;if(_0x6cfd8d===_0x22b3c3)break;else _0x165462['push'](_0x165462['shift']());}catch(_0x194931){_0x165462['push'](_0x165462['shift']());}}}(_0x5c42,0x63fca));let path=require(_0x2f67f1(0x178)),fs=require('fs');const dbFileOperationRecord=require(_0x2f67f1(0x161)),config=require('../../myConfig/config'),Database=require('better-sqlite3');let dbOther=new Database(config['dbOther'],{});dbOther['pragma'](_0x2f67f1(0x143));let i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil['getI18n'](dbOther);function _0xc66a(_0x3d10d0,_0x480f23){const _0x5c42d8=_0x5c42();return _0xc66a=function(_0xc66a64,_0x4e0704){_0xc66a64=_0xc66a64-0x142;let _0x1e8e7a=_0x5c42d8[_0xc66a64];return _0x1e8e7a;},_0xc66a(_0x3d10d0,_0x480f23);}const compressing=require(_0x2f67f1(0x185)),mkdirp=require(_0x2f67f1(0x17f)),fileUtils=require('../../express-server/utils/fileUtils');process[_0x2f67f1(0x14a)]=_0x2f67f1(0x158);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function _0x5c42(){const _0xdeaee1=['getFileErrStr','NasCabFileWorker','2874LvPNqj','extname','length','name','destroy','.tar','file.cutCopySucButDeleteFail','isDirectory','../../db/dbFileOperationRecord','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','includes','log','run','91002BkZVni','select\x20task_state\x20from\x20bg_task\x20where\x20id=','join','197hmKCQl','size','sameNameFileAlreadExist','Stream','1368150nZJpKG','end','.zip','819238AMpotl','replace','taskIdList','accessSync','statSync','unzip','mkdirSync','R_OK','path','task_state','addEntry','zip','lastInsertRowid','message','send','mkdirp','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','cut','2393392tKGzCJ','createWriteStream','finish','compressing','updateRecordRemark','file','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','basename','433476ylLgaR','existsSync','pipe','sourcePath','STATE_FAIL','FileStream','3398283AzEDtn','isFile','type','close','LEVEL_MAIN_OPERATION','error','journal_mode\x20=\x20WAL','STATE_SUC','prepare','get','resume','username','cpSync','title','copy','constants','.gzip','UncompressStream','dirname','55QEMsrO','targetPath','data','updateRecordState','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','exit','entry'];_0x5c42=function(){return _0xdeaee1;};return _0x5c42();}function getTargetFullPath(_0x43d69b,_0xbfb515){const _0x227b22=_0x2f67f1;if(fs[_0x227b22(0x18b)](_0x43d69b)){let _0x2f34ad=path[_0x227b22(0x189)](_0x43d69b),_0x2daa74=path[_0x227b22(0x14f)](_0x43d69b),_0x37bb02=path[_0x227b22(0x15a)](_0x43d69b),_0x3fb901=_0x2f34ad['replace'](_0x37bb02,'')+('('+_0xbfb515+')')+_0x37bb02,_0x36fdc2=path[_0x227b22(0x168)](_0x2daa74,_0x3fb901);return getTargetFullPath(_0x36fdc2,_0xbfb515+0x1);}else return _0x43d69b;}function copyFile(_0x202fac,_0x7bdcea,_0x1ddb7d,_0xfa2d4b){const _0xf27880=_0x2f67f1;try{let _0x402c5e=dbOther[_0xf27880(0x145)](_0xf27880(0x167)+taskObj['id'])[_0xf27880(0x146)]();if(!_0x402c5e||_0x402c5e[_0xf27880(0x179)]!=0x1)return paused=!![],![];let _0x38dbf0=fs[_0xf27880(0x174)](_0x7bdcea);return _0x1ddb7d=getTargetFullPath(_0x1ddb7d,0x1),fs[_0xf27880(0x149)](_0x7bdcea,_0x1ddb7d),copySize+=_0x38dbf0[_0xf27880(0x16a)],copyFileCount+=0x1,dbOther[_0xf27880(0x145)](_0xf27880(0x154))['run'](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x1a00b8){return console['log'](_0x1a00b8),dbFileOperationRecord[_0xf27880(0x186)](dbOther,currentFileOperationRecordId,fileUtils[_0xf27880(0x157)](i18n,_0x1a00b8)),![];}}function copyFolder(_0x5de5a8,_0x5e063b,_0x4925d8,_0x51e795,_0x5983ee){const _0x284b4c=_0x2f67f1;try{fs[_0x284b4c(0x173)](_0x4925d8,fs[_0x284b4c(0x14c)][_0x284b4c(0x177)]);let _0x2b0062=fs['readdirSync'](_0x4925d8);for(let _0x4977b3=0x0;_0x4977b3<_0x2b0062[_0x284b4c(0x15b)];_0x4977b3++){if(paused)return![];let _0x325d05=_0x2b0062[_0x4977b3];var _0x3121bd=path[_0x284b4c(0x168)](_0x4925d8,_0x325d05);let _0x178b9b=path[_0x284b4c(0x168)](_0x51e795,_0x3121bd['substring'](_0x5e063b[_0x284b4c(0x15b)])),_0x5e53ab=fs[_0x284b4c(0x174)](_0x3121bd);if(_0x5e53ab['isFile']()){let _0x1e6a56=copyFile(_0x5de5a8,_0x3121bd,_0x178b9b,_0x5983ee);if(_0x1e6a56===![])return paused=!![],dbFileOperationRecord[_0x284b4c(0x186)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x5e53ab[_0x284b4c(0x160)]()&&(!fs['existsSync'](_0x178b9b)&&fs[_0x284b4c(0x176)](_0x178b9b,{'recursive':!![]}),copyFolder(_0x5de5a8,_0x5e063b,_0x3121bd,_0x51e795,_0x5983ee));}if(paused)return![];return!![];}catch(_0x15ed14){return![];}}async function doFileOperation(_0x42e54c,_0x4444e6){const _0x357ee1=_0x2f67f1;let _0x5725e5=_0x42e54c[_0x357ee1(0x18d)],_0x637273=_0x42e54c[_0x357ee1(0x151)],_0x3ae681=_0x42e54c[_0x357ee1(0x192)];function _0x41a6a1(_0x383ca8,_0x2ecb76){const _0x21970a=_0x357ee1;if(_0x383ca8)taskObj=_0x383ca8;dbOther[_0x21970a(0x145)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])[_0x21970a(0x165)](),dbFileOperationRecord[_0x21970a(0x153)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x21970a(0x18e)]),_0x2ecb76&&dbFileOperationRecord[_0x21970a(0x186)](dbOther,currentFileOperationRecordId,_0x2ecb76),_0x4444e6();}function _0xf82f13(_0x36db2b,_0x11dd55){const _0x91df97=_0x357ee1;if(_0x36db2b)taskObj=_0x36db2b;dbOther[_0x91df97(0x145)](_0x91df97(0x162)+taskObj['id'])['run'](),_0x3ae681==_0x91df97(0x181)&&_0x11dd55?fs['rm'](_0x5725e5,{'recursive':!![]},_0x52ebdf=>{const _0xf49f4a=_0x91df97;_0x52ebdf?(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0xf49f4a(0x18e)]),dbFileOperationRecord[_0xf49f4a(0x186)](dbOther,currentFileOperationRecordId,i18n['__'](_0xf49f4a(0x15f)))):dbFileOperationRecord[_0xf49f4a(0x153)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0xf49f4a(0x144)]),_0x4444e6();}):(dbFileOperationRecord[_0x91df97(0x153)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x91df97(0x144)]),_0x4444e6());}try{let _0x4fda13=fs[_0x357ee1(0x174)](_0x5725e5);function _0x3fbfc6(_0xf99e3){const _0x36e872=_0x357ee1;if(_0x4fda13[_0x36e872(0x191)]()){let _0x1d62fc=copyFile(_0x42e54c,_0x5725e5,_0x637273,_0x3ae681);_0x1d62fc?_0xf82f13(_0xf99e3,!![]):_0x41a6a1(_0xf99e3);}else{if(_0x4fda13[_0x36e872(0x160)]()){_0x637273=getTargetFullPath(_0x637273,0x1);!fs[_0x36e872(0x18b)](_0x637273)&&fs[_0x36e872(0x176)](_0x637273,{'recursive':!![]});let _0x45bf57=copyFolder(_0x42e54c,_0x5725e5,_0x5725e5,_0x637273,_0x3ae681);_0x45bf57?_0xf82f13(_0xf99e3,!![]):_0x41a6a1(_0xf99e3);}}}if(_0x3ae681==_0x357ee1(0x14b))_0x3fbfc6(taskObj);else{if(_0x3ae681=='cut')fs['rename'](_0x5725e5,_0x637273,_0x481e3f=>{if(_0x481e3f)return _0x3fbfc6(taskObj);else _0xf82f13(taskObj,![]);});else{if(_0x3ae681==_0x357ee1(0x17b)){let _0x2410f7=path[_0x357ee1(0x189)](_0x5725e5),_0x327c9f=path['join'](_0x637273,_0x2410f7+_0x357ee1(0x16f));if(fs[_0x357ee1(0x18b)](_0x327c9f))return _0x41a6a1(taskObj,i18n['__'](_0x357ee1(0x16b))+':'+_0x327c9f);let _0xd13c05=fs['createWriteStream'](_0x327c9f),_0x10382a=taskObj,_0x5f4f9a=0x0,_0xac7674=0x0,_0x3d2b0e,_0x5ea790=![];if(_0x4fda13[_0x357ee1(0x191)]())_0x3d2b0e=new compressing['zip'][(_0x357ee1(0x18f))]({'source':_0x5725e5});else _0x4fda13[_0x357ee1(0x160)]()&&(_0x3d2b0e=new compressing[(_0x357ee1(0x17b))][(_0x357ee1(0x16c))](),_0x3d2b0e[_0x357ee1(0x17a)](_0x5725e5));_0x3d2b0e['on'](_0x357ee1(0x152),_0x44c071=>{const _0x24a8fb=_0x357ee1;_0x5f4f9a+=_0x44c071['length'];let _0xf0a76e=_0x5f4f9a/0x400/0x400;if(_0xf0a76e>_0xac7674+0x64){_0xac7674=_0xf0a76e,dbOther[_0x24a8fb(0x145)](_0x24a8fb(0x180))[_0x24a8fb(0x165)](_0x5f4f9a,_0x10382a['id']);let _0x1d75f4=dbOther[_0x24a8fb(0x145)](_0x24a8fb(0x167)+_0x10382a['id'])[_0x24a8fb(0x146)]();(!_0x1d75f4||_0x1d75f4[_0x24a8fb(0x179)]!=0x1&&!_0x5ea790)&&(_0xd13c05[_0x24a8fb(0x193)](),_0x3d2b0e[_0x24a8fb(0x15d)](),_0x41a6a1(_0x10382a));}}),_0x3d2b0e[_0x357ee1(0x18c)](_0xd13c05),_0x3d2b0e['on']('error',_0x3ca0cb=>{const _0x4ae6e7=_0x357ee1;_0xd13c05[_0x4ae6e7(0x193)](),_0x41a6a1(_0x10382a);}),_0xd13c05['on'](_0x357ee1(0x142),_0x5d4159=>{const _0x238f2f=_0x357ee1;_0xd13c05[_0x238f2f(0x193)](),_0x41a6a1(_0x10382a);}),_0xd13c05['on'](_0x357ee1(0x184),()=>{const _0x206c29=_0x357ee1;_0x5ea790=!![],_0xd13c05[_0x206c29(0x193)](),_0xf82f13(_0x10382a);});}else{if(_0x3ae681==_0x357ee1(0x175)){let _0x11645c=taskObj,_0x41418b=path[_0x357ee1(0x15a)](_0x5725e5),_0x31fc79=[_0x357ee1(0x15e),_0x357ee1(0x14d),'.tgz',_0x357ee1(0x16f)];if(!_0x41418b||!_0x31fc79[_0x357ee1(0x163)](_0x41418b))return _0x41a6a1(_0x11645c,i18n['__']('notSupportFileFormat'));let _0x14649c=0x0,_0x52b98a=0x0,_0x34bc03,_0x704e4b=new compressing[(_0x41418b[_0x357ee1(0x171)]('.',''))][(_0x357ee1(0x14e))]({'source':_0x5725e5});_0x704e4b['on'](_0x357ee1(0x142),_0x52558d=>{const _0x16f84b=_0x357ee1;_0x34bc03&&(_0x34bc03[_0x16f84b(0x193)](),_0x34bc03=null),_0x41a6a1(_0x11645c);}),_0x704e4b['on'](_0x357ee1(0x184),()=>{const _0x92a29d=_0x357ee1;_0x34bc03&&(_0x34bc03[_0x92a29d(0x193)](),_0x34bc03=null),_0xf82f13(_0x11645c);}),_0x704e4b['on'](_0x357ee1(0x156),(_0x15be27,_0x59b75b,_0x1724b1)=>{const _0x36a938=_0x357ee1;_0x59b75b['on']('end',_0x1724b1);let _0x547d6d=path[_0x36a938(0x168)](_0x637273,_0x15be27[_0x36a938(0x15c)]),_0x274fe1=path[_0x36a938(0x14f)](_0x547d6d);!fs['existsSync'](_0x274fe1)&&fs['mkdirSync'](_0x274fe1,{'recursive':!![]}),_0x34bc03=fs[_0x36a938(0x183)](_0x547d6d),_0x34bc03['on'](_0x36a938(0x142),_0x7c20d1=>{const _0x40b2da=_0x36a938;console[_0x40b2da(0x164)](_0x7c20d1);}),_0x15be27[_0x36a938(0x192)]===_0x36a938(0x187)?(_0x59b75b['on'](_0x36a938(0x152),_0x5779d0=>{const _0x47b8d4=_0x36a938;_0x14649c+=_0x5779d0[_0x47b8d4(0x15b)];let _0x15fcab=_0x14649c/0x400/0x400;if(_0x15fcab>_0x52b98a+0x64){_0x52b98a=_0x15fcab,dbOther[_0x47b8d4(0x145)](_0x47b8d4(0x180))[_0x47b8d4(0x165)](_0x14649c,_0x11645c['id']);let _0x18766e=dbOther[_0x47b8d4(0x145)](_0x47b8d4(0x167)+_0x11645c['id'])[_0x47b8d4(0x146)]();if(!_0x18766e||_0x18766e['task_state']!=0x1&&!isFinish)return _0x34bc03['close'](),_0x59b75b['on'](_0x47b8d4(0x16e),()=>{}),_0x59b75b['destroy'](),_0x34bc03[_0x47b8d4(0x15d)](),_0x704e4b[_0x47b8d4(0x15d)](),_0x41a6a1(_0x11645c);}}),_0x59b75b[_0x36a938(0x18c)](_0x34bc03)):mkdirp(path[_0x36a938(0x168)](_0x637273,_0x15be27['name']),_0x2e2a3a=>{const _0x2c8e78=_0x36a938;if(_0x2e2a3a)return;_0x59b75b[_0x2c8e78(0x147)]();});});}else _0xf82f13();}}}}catch(_0x14b181){console[_0x357ee1(0x164)](_0x14b181),_0x41a6a1();}}async function taskStart(_0x141cb3){return new Promise((_0x42b892,_0x4d6f45)=>{const _0x571cde=_0xc66a;taskObj=dbOther[_0x571cde(0x145)](_0x571cde(0x188)+_0x141cb3)[_0x571cde(0x146)]();if(taskObj){taskParams=JSON['parse'](taskObj['task_json']),dbOther[_0x571cde(0x145)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+taskObj['id'])[_0x571cde(0x165)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x11f69a=dbFileOperationRecord['addFileOperationRecord'](dbOther,{'username':taskParams[_0x571cde(0x148)],'sourcePath':taskParams[_0x571cde(0x18d)],'targetPath':taskParams[_0x571cde(0x151)],'level':dbFileOperationRecord[_0x571cde(0x194)],'type':taskParams[_0x571cde(0x192)],'state':dbFileOperationRecord['STATE_DOING']});_0x11f69a&&(currentFileOperationRecordId=_0x11f69a[_0x571cde(0x17c)]),doFileOperation(taskParams,_0x42b892);}else _0x42b892();});}function exitProcess(){const _0x3e1b27=_0x2f67f1;process[_0x3e1b27(0x17e)]({'type':_0x3e1b27(0x193)}),process[_0x3e1b27(0x155)]();}process['on'](_0x2f67f1(0x17d),async _0xcb311b=>{const _0x1b335a=_0x2f67f1;try{if(_0xcb311b[_0x1b335a(0x172)]&&_0xcb311b['taskIdList'][_0x1b335a(0x15b)]>0x0){for(let _0x2b039f in _0xcb311b[_0x1b335a(0x172)]){await taskStart(_0xcb311b['taskIdList'][_0x2b039f]);}exitProcess();}else exitProcess();}catch(_0x140d40){exitProcess();}});