const _0x2aa28f=_0x4ffb;function _0x4ffb(_0x3c7761,_0x2a3448){const _0x1227f1=_0x1227();return _0x4ffb=function(_0x4ffb2b,_0x4dbb22){_0x4ffb2b=_0x4ffb2b-0x141;let _0x3ce5d7=_0x1227f1[_0x4ffb2b];return _0x3ce5d7;},_0x4ffb(_0x3c7761,_0x2a3448);}function _0x1227(){const _0x158cbb=['lastInsertRowid','1551312XHfLHW','exit','targetPath','pipe','better-sqlite3','isDirectory','../../myConfig/config','STATE_SUC','701496ZQbuGv','get','path','extname','../../db/dbFileOperationRecord','cpSync','join','unzip','STATE_FAIL','6716dWytIU','updateRecordRemark','.gzip','60jUFDKf','10bhhTzD','type','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','270680nhcjdE','data','cut','task_json','LEVEL_MAIN_OPERATION','length','sourcePath','size','destroy','finish','prepare','existsSync','FileStream','710560JoMBsY','../../express-server/utils/fileUtils','taskIdList','replace','substring','run','basename','5604412TuxTyt','dbOther','isFile','entry','mkdirSync','notSupportFileFormat','copy','NasCabFileWorker','11907GtwoFA','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','includes','close','select\x20task_state\x20from\x20bg_task\x20where\x20id=','14ayKMgp','Stream','getI18n','name','dirname','accessSync','R_OK','rename','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','journal_mode\x20=\x20WAL','constants','message','log','task_state','statSync','.zip','.tgz','updateRecordState','mkdirp','compressing','file','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','end','STATE_DOING','error','createWriteStream','send','8sJWzzt','.tar','zip','getFileErrStr','title'];_0x1227=function(){return _0x158cbb;};return _0x1227();}(function(_0x3f3621,_0x2ffe21){const _0x6201a8=_0x4ffb,_0x237ccd=_0x3f3621();while(!![]){try{const _0x2a264b=parseInt(_0x6201a8(0x14e))/0x1*(parseInt(_0x6201a8(0x181))/0x2)+parseInt(_0x6201a8(0x178))/0x3+-parseInt(_0x6201a8(0x16a))/0x4*(-parseInt(_0x6201a8(0x195))/0x5)+parseInt(_0x6201a8(0x184))/0x6*(parseInt(_0x6201a8(0x149))/0x7)+-parseInt(_0x6201a8(0x188))/0x8+parseInt(_0x6201a8(0x170))/0x9+parseInt(_0x6201a8(0x185))/0xa*(-parseInt(_0x6201a8(0x141))/0xb);if(_0x2a264b===_0x2ffe21)break;else _0x237ccd['push'](_0x237ccd['shift']());}catch(_0x1bacb9){_0x237ccd['push'](_0x237ccd['shift']());}}}(_0x1227,0x338af));let path=require(_0x2aa28f(0x17a)),fs=require('fs');const dbFileOperationRecord=require(_0x2aa28f(0x17c)),config=require(_0x2aa28f(0x176)),Database=require(_0x2aa28f(0x174));let dbOther=new Database(config[_0x2aa28f(0x142)],{});dbOther['pragma'](_0x2aa28f(0x158));let i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x2aa28f(0x150)](dbOther);const compressing=require(_0x2aa28f(0x162)),mkdirp=require(_0x2aa28f(0x161)),fileUtils=require(_0x2aa28f(0x196));process[_0x2aa28f(0x16e)]=_0x2aa28f(0x148);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x535010,_0x3d4466){const _0x38ca33=_0x2aa28f;if(fs[_0x38ca33(0x193)](_0x535010)){let _0x16c7d4=path[_0x38ca33(0x19b)](_0x535010),_0x44ccd4=path['dirname'](_0x535010),_0x342d52=path[_0x38ca33(0x17b)](_0x535010),_0x42f233=_0x16c7d4[_0x38ca33(0x198)](_0x342d52,'')+('('+_0x3d4466+')')+_0x342d52,_0x29917b=path[_0x38ca33(0x17e)](_0x44ccd4,_0x42f233);return getTargetFullPath(_0x29917b,_0x3d4466+0x1);}else return _0x535010;}function copyFile(_0x369ffb,_0x3a9e51,_0xb1190c,_0x44e8a4){const _0x396561=_0x2aa28f;try{let _0x4a159e=dbOther[_0x396561(0x192)](_0x396561(0x14d)+taskObj['id'])[_0x396561(0x179)]();if(!_0x4a159e||_0x4a159e[_0x396561(0x15c)]!=0x1)return paused=!![],![];let _0x3ea21b=fs['statSync'](_0x3a9e51);return _0xb1190c=getTargetFullPath(_0xb1190c,0x1),fs[_0x396561(0x17d)](_0x3a9e51,_0xb1190c),copySize+=_0x3ea21b[_0x396561(0x18f)],copyFileCount+=0x1,dbOther['prepare'](_0x396561(0x156))[_0x396561(0x19a)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x28d5e7){return console[_0x396561(0x15b)](_0x28d5e7),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,fileUtils[_0x396561(0x16d)](i18n,_0x28d5e7)),![];}}function copyFolder(_0x28836e,_0x4ddee9,_0x55b6e8,_0x2faddc,_0x216e5e){const _0x46f7ae=_0x2aa28f;try{fs[_0x46f7ae(0x153)](_0x55b6e8,fs[_0x46f7ae(0x159)][_0x46f7ae(0x154)]);let _0x25f54f=fs['readdirSync'](_0x55b6e8);for(let _0xd88b4f=0x0;_0xd88b4f<_0x25f54f[_0x46f7ae(0x18d)];_0xd88b4f++){if(paused)return![];let _0x3f1af0=_0x25f54f[_0xd88b4f];var _0x304a92=path[_0x46f7ae(0x17e)](_0x55b6e8,_0x3f1af0);let _0x6a6cb5=path[_0x46f7ae(0x17e)](_0x2faddc,_0x304a92[_0x46f7ae(0x199)](_0x4ddee9[_0x46f7ae(0x18d)])),_0x562e7d=fs[_0x46f7ae(0x15d)](_0x304a92);if(_0x562e7d[_0x46f7ae(0x143)]()){let _0x6b5ecf=copyFile(_0x28836e,_0x304a92,_0x6a6cb5,_0x216e5e);if(_0x6b5ecf===![])return paused=!![],dbFileOperationRecord[_0x46f7ae(0x182)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x562e7d['isDirectory']()&&(!fs[_0x46f7ae(0x193)](_0x6a6cb5)&&fs[_0x46f7ae(0x145)](_0x6a6cb5,{'recursive':!![]}),copyFolder(_0x28836e,_0x4ddee9,_0x304a92,_0x2faddc,_0x216e5e));}if(paused)return![];return!![];}catch(_0x50827b){return![];}}async function doFileOperation(_0x3d8e3f,_0x1920d2){const _0x32ebd5=_0x2aa28f;let _0x5d2d21=_0x3d8e3f['sourcePath'],_0x24a32c=_0x3d8e3f[_0x32ebd5(0x172)],_0x33b20d=_0x3d8e3f[_0x32ebd5(0x186)];function _0x9d429f(_0x1d34b5,_0x1b0091){const _0x412898=_0x32ebd5;if(_0x1d34b5)taskObj=_0x1d34b5;dbOther[_0x412898(0x192)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])[_0x412898(0x19a)](),dbFileOperationRecord[_0x412898(0x160)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x412898(0x180)]),_0x1b0091&&dbFileOperationRecord[_0x412898(0x182)](dbOther,currentFileOperationRecordId,_0x1b0091),_0x1920d2();}function _0x5e718f(_0x543cac,_0x39b420){const _0x4464df=_0x32ebd5;if(_0x543cac)taskObj=_0x543cac;dbOther[_0x4464df(0x192)](_0x4464df(0x14a)+taskObj['id'])[_0x4464df(0x19a)](),_0x33b20d==_0x4464df(0x18a)&&_0x39b420?fs['rm'](_0x5d2d21,{'recursive':!![]},_0x126173=>{const _0x5786fb=_0x4464df;_0x126173?(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x5786fb(0x180)]),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__']('file.cutCopySucButDeleteFail'))):dbFileOperationRecord[_0x5786fb(0x160)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x5786fb(0x177)]),_0x1920d2();}):(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_SUC']),_0x1920d2());}try{let _0x3ed0b1=fs[_0x32ebd5(0x15d)](_0x5d2d21);function _0x58555d(_0x4b0353){const _0x52f966=_0x32ebd5;if(_0x3ed0b1['isFile']()){let _0x330e11=copyFile(_0x3d8e3f,_0x5d2d21,_0x24a32c,_0x33b20d);_0x330e11?_0x5e718f(_0x4b0353,!![]):_0x9d429f(_0x4b0353);}else{if(_0x3ed0b1[_0x52f966(0x175)]()){_0x24a32c=getTargetFullPath(_0x24a32c,0x1);!fs['existsSync'](_0x24a32c)&&fs[_0x52f966(0x145)](_0x24a32c,{'recursive':!![]});let _0x54698d=copyFolder(_0x3d8e3f,_0x5d2d21,_0x5d2d21,_0x24a32c,_0x33b20d);_0x54698d?_0x5e718f(_0x4b0353,!![]):_0x9d429f(_0x4b0353);}}}if(_0x33b20d==_0x32ebd5(0x147))_0x58555d(taskObj);else{if(_0x33b20d==_0x32ebd5(0x18a))fs[_0x32ebd5(0x155)](_0x5d2d21,_0x24a32c,_0x17955f=>{if(_0x17955f)return _0x58555d(taskObj);else _0x5e718f(taskObj,![]);});else{if(_0x33b20d=='zip'){let _0x42929e=path[_0x32ebd5(0x19b)](_0x5d2d21),_0x295e95=path['join'](_0x24a32c,_0x42929e+_0x32ebd5(0x15e));if(fs[_0x32ebd5(0x193)](_0x295e95))return _0x9d429f(taskObj,i18n['__']('sameNameFileAlreadExist')+':'+_0x295e95);let _0x1298b7=fs[_0x32ebd5(0x168)](_0x295e95),_0x12737b=taskObj,_0xbcb58a=0x0,_0x222c65=0x0,_0x36a5c3,_0x5a5cce=![];if(_0x3ed0b1[_0x32ebd5(0x143)]())_0x36a5c3=new compressing[(_0x32ebd5(0x16c))][(_0x32ebd5(0x194))]({'source':_0x5d2d21});else _0x3ed0b1[_0x32ebd5(0x175)]()&&(_0x36a5c3=new compressing['zip'][(_0x32ebd5(0x14f))](),_0x36a5c3['addEntry'](_0x5d2d21));_0x36a5c3['on'](_0x32ebd5(0x189),_0x17525b=>{const _0x46f2f8=_0x32ebd5;_0xbcb58a+=_0x17525b[_0x46f2f8(0x18d)];let _0x432547=_0xbcb58a/0x400/0x400;if(_0x432547>_0x222c65+0x64){_0x222c65=_0x432547,dbOther[_0x46f2f8(0x192)](_0x46f2f8(0x187))['run'](_0xbcb58a,_0x12737b['id']);let _0x27e9a5=dbOther[_0x46f2f8(0x192)](_0x46f2f8(0x14d)+_0x12737b['id'])[_0x46f2f8(0x179)]();(!_0x27e9a5||_0x27e9a5[_0x46f2f8(0x15c)]!=0x1&&!_0x5a5cce)&&(_0x1298b7[_0x46f2f8(0x14c)](),_0x36a5c3[_0x46f2f8(0x190)](),_0x9d429f(_0x12737b));}}),_0x36a5c3[_0x32ebd5(0x173)](_0x1298b7),_0x36a5c3['on'](_0x32ebd5(0x167),_0x461826=>{const _0x498f17=_0x32ebd5;_0x1298b7[_0x498f17(0x14c)](),_0x9d429f(_0x12737b);}),_0x1298b7['on'](_0x32ebd5(0x167),_0x406f6b=>{const _0x196f36=_0x32ebd5;_0x1298b7[_0x196f36(0x14c)](),_0x9d429f(_0x12737b);}),_0x1298b7['on'](_0x32ebd5(0x191),()=>{const _0x8826e2=_0x32ebd5;_0x5a5cce=!![],_0x1298b7[_0x8826e2(0x14c)](),_0x5e718f(_0x12737b);});}else{if(_0x33b20d==_0x32ebd5(0x17f)){let _0x51858a=taskObj,_0x34e17f=path[_0x32ebd5(0x17b)](_0x5d2d21),_0x3bfd35=[_0x32ebd5(0x16b),_0x32ebd5(0x183),_0x32ebd5(0x15f),'.zip'];if(!_0x34e17f||!_0x3bfd35[_0x32ebd5(0x14b)](_0x34e17f))return _0x9d429f(_0x51858a,i18n['__'](_0x32ebd5(0x146)));let _0x7bbd25=0x0,_0x28f8c2=0x0,_0xa5726f,_0xfc4cb5=new compressing[(_0x34e17f['replace']('.',''))]['UncompressStream']({'source':_0x5d2d21});_0xfc4cb5['on'](_0x32ebd5(0x167),_0x3b254e=>{_0xa5726f&&(_0xa5726f['close'](),_0xa5726f=null),_0x9d429f(_0x51858a);}),_0xfc4cb5['on'](_0x32ebd5(0x191),()=>{const _0x3378c5=_0x32ebd5;_0xa5726f&&(_0xa5726f[_0x3378c5(0x14c)](),_0xa5726f=null),_0x5e718f(_0x51858a);}),_0xfc4cb5['on'](_0x32ebd5(0x144),(_0x8d7687,_0x351260,_0x5a6f6b)=>{const _0x50eaf7=_0x32ebd5;_0x351260['on'](_0x50eaf7(0x165),_0x5a6f6b);let _0x379e0d=path['join'](_0x24a32c,_0x8d7687[_0x50eaf7(0x151)]),_0x9c19c1=path[_0x50eaf7(0x152)](_0x379e0d);!fs['existsSync'](_0x9c19c1)&&fs['mkdirSync'](_0x9c19c1,{'recursive':!![]}),_0xa5726f=fs[_0x50eaf7(0x168)](_0x379e0d),_0xa5726f['on']('error',_0x59a344=>{console['log'](_0x59a344);}),_0x8d7687[_0x50eaf7(0x186)]===_0x50eaf7(0x163)?(_0x351260['on'](_0x50eaf7(0x189),_0x1f4fa7=>{const _0xc62c9a=_0x50eaf7;_0x7bbd25+=_0x1f4fa7[_0xc62c9a(0x18d)];let _0x3d2c35=_0x7bbd25/0x400/0x400;if(_0x3d2c35>_0x28f8c2+0x64){_0x28f8c2=_0x3d2c35,dbOther[_0xc62c9a(0x192)](_0xc62c9a(0x187))[_0xc62c9a(0x19a)](_0x7bbd25,_0x51858a['id']);let _0x15d8d9=dbOther[_0xc62c9a(0x192)](_0xc62c9a(0x14d)+_0x51858a['id'])[_0xc62c9a(0x179)]();if(!_0x15d8d9||_0x15d8d9['task_state']!=0x1&&!isFinish)return _0xa5726f[_0xc62c9a(0x14c)](),_0x351260['on'](_0xc62c9a(0x165),()=>{}),_0x351260[_0xc62c9a(0x190)](),_0xa5726f[_0xc62c9a(0x190)](),_0xfc4cb5[_0xc62c9a(0x190)](),_0x9d429f(_0x51858a);}}),_0x351260['pipe'](_0xa5726f)):mkdirp(path[_0x50eaf7(0x17e)](_0x24a32c,_0x8d7687[_0x50eaf7(0x151)]),_0x4c471a=>{if(_0x4c471a)return;_0x351260['resume']();});});}else _0x5e718f();}}}}catch(_0x379216){console[_0x32ebd5(0x15b)](_0x379216),_0x9d429f();}}async function taskStart(_0x5d8d7d){return new Promise((_0x2f989a,_0x383011)=>{const _0x15b14b=_0x4ffb;taskObj=dbOther['prepare'](_0x15b14b(0x164)+_0x5d8d7d)[_0x15b14b(0x179)]();if(taskObj){taskParams=JSON['parse'](taskObj[_0x15b14b(0x18b)]),dbOther[_0x15b14b(0x192)](_0x15b14b(0x157)+taskObj['id'])['run'](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x12c350=dbFileOperationRecord['addFileOperationRecord'](dbOther,{'username':taskParams['username'],'sourcePath':taskParams[_0x15b14b(0x18e)],'targetPath':taskParams[_0x15b14b(0x172)],'level':dbFileOperationRecord[_0x15b14b(0x18c)],'type':taskParams['type'],'state':dbFileOperationRecord[_0x15b14b(0x166)]});_0x12c350&&(currentFileOperationRecordId=_0x12c350[_0x15b14b(0x16f)]),doFileOperation(taskParams,_0x2f989a);}else _0x2f989a();});}function exitProcess(){const _0x544cda=_0x2aa28f;process[_0x544cda(0x169)]({'type':_0x544cda(0x14c)}),process[_0x544cda(0x171)]();}process['on'](_0x2aa28f(0x15a),async _0x275834=>{const _0x200fd6=_0x2aa28f;try{if(_0x275834[_0x200fd6(0x197)]&&_0x275834[_0x200fd6(0x197)]['length']>0x0){for(let _0x36214c in _0x275834[_0x200fd6(0x197)]){await taskStart(_0x275834[_0x200fd6(0x197)][_0x36214c]);}exitProcess();}else exitProcess();}catch(_0x2b6a75){exitProcess();}});