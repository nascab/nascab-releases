const _0xe29023=_0x9beb;(function(_0x10e26a,_0x56fa4a){const _0x23a786=_0x9beb,_0x38ec09=_0x10e26a();while(!![]){try{const _0x206f60=parseInt(_0x23a786(0xd1))/0x1*(parseInt(_0x23a786(0xc2))/0x2)+parseInt(_0x23a786(0xd7))/0x3*(-parseInt(_0x23a786(0xb6))/0x4)+parseInt(_0x23a786(0xed))/0x5+-parseInt(_0x23a786(0x102))/0x6+parseInt(_0x23a786(0xc7))/0x7*(parseInt(_0x23a786(0x107))/0x8)+parseInt(_0x23a786(0x111))/0x9+parseInt(_0x23a786(0xe0))/0xa;if(_0x206f60===_0x56fa4a)break;else _0x38ec09['push'](_0x38ec09['shift']());}catch(_0x56288f){_0x38ec09['push'](_0x38ec09['shift']());}}}(_0x2ebd,0xcca3e));let path=require(_0xe29023(0xbc)),fs=require('fs');const dbFileOperationRecord=require(_0xe29023(0xfb)),config=require(_0xe29023(0x108)),Database=require(_0xe29023(0xe3));let dbOther=new Database(config[_0xe29023(0xcd)],{});dbOther[_0xe29023(0x100)](_0xe29023(0x110));let i18nUtil=require(_0xe29023(0xd5)),i18n=i18nUtil[_0xe29023(0xb9)](dbOther);function _0x2ebd(){const _0x15cc5f=['.zip','STATE_SUC','join','.gzip','dirname','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','../../db/dbFileOperationRecord','createWriteStream','mkdirSync','taskIdList','title','pragma','entry','6475362nOmaeb','file','mkdirp','type','rename','5048JctyTh','../../myConfig/config','select\x20task_state\x20from\x20bg_task\x20where\x20id=','UncompressStream','readdirSync','isDirectory','run','existsSync','task_json','journal_mode\x20=\x20WAL','2175345rVulhQ','sourcePath','5268GytHqo','accessSync','getFileErrStr','getI18n','end','../../express-server/utils/fileUtils','path','UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id=','prepare','updateRecordState','cut','STATE_FAIL','2vNlGpZ','R_OK','data','zip','send','6335HAxaNP','constants','close','notSupportFileFormat','file.cutCopySucButDeleteFail','task_state','dbOther','extname','NasCabFileWorker','message','1464622RiGXWe','replace','finish','compressing','../../utils/i18nUtil','.tgz','2931QlGoKB','Stream','length','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','basename','unzip','get','STATE_DOING','error','446250ixZryM','exit','cpSync','better-sqlite3','resume','includes','updateRecordRemark','addEntry','statSync','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','addFileOperationRecord','destroy','username','4410675GAfEIR','pipe','parse','targetPath','lastInsertRowid','name','log','isFile'];_0x2ebd=function(){return _0x15cc5f;};return _0x2ebd();}const compressing=require(_0xe29023(0xd4)),mkdirp=require(_0xe29023(0x104)),fileUtils=require(_0xe29023(0xbb));process[_0xe29023(0xff)]=_0xe29023(0xcf);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x5a7708,_0x1f2162){const _0x4f646c=_0xe29023;if(fs[_0x4f646c(0x10e)](_0x5a7708)){let _0x4c1b5f=path[_0x4f646c(0xdb)](_0x5a7708),_0x4c9c26=path[_0x4f646c(0xf9)](_0x5a7708),_0x14c7eb=path[_0x4f646c(0xce)](_0x5a7708),_0x30faa9=_0x4c1b5f[_0x4f646c(0xd2)](_0x14c7eb,'')+('('+_0x1f2162+')')+_0x14c7eb,_0x1ca4ea=path['join'](_0x4c9c26,_0x30faa9);return getTargetFullPath(_0x1ca4ea,_0x1f2162+0x1);}else return _0x5a7708;}function copyFile(_0x26fbf0,_0x40c9f8,_0x24aee1,_0x4cb773){const _0x4ed9ec=_0xe29023;try{let _0x5f1726=dbOther[_0x4ed9ec(0xbe)](_0x4ed9ec(0x109)+taskObj['id'])[_0x4ed9ec(0xdd)]();if(!_0x5f1726||_0x5f1726[_0x4ed9ec(0xcc)]!=0x1)return paused=!![],![];let _0x536351=fs[_0x4ed9ec(0xe8)](_0x40c9f8);return _0x24aee1=getTargetFullPath(_0x24aee1,0x1),fs[_0x4ed9ec(0xe2)](_0x40c9f8,_0x24aee1),copySize+=_0x536351['size'],copyFileCount+=0x1,dbOther[_0x4ed9ec(0xbe)](_0x4ed9ec(0xe9))[_0x4ed9ec(0x10d)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x5709c1){return console[_0x4ed9ec(0xf3)](_0x5709c1),dbFileOperationRecord[_0x4ed9ec(0xe6)](dbOther,currentFileOperationRecordId,fileUtils[_0x4ed9ec(0xb8)](i18n,_0x5709c1)),![];}}function _0x9beb(_0xa37de3,_0x3a28d0){const _0x2ebd8a=_0x2ebd();return _0x9beb=function(_0x9beb0,_0x1fe30a){_0x9beb0=_0x9beb0-0xb6;let _0x21269c=_0x2ebd8a[_0x9beb0];return _0x21269c;},_0x9beb(_0xa37de3,_0x3a28d0);}function copyFolder(_0x11895b,_0x5bf27f,_0x4ad72c,_0x56ffb0,_0x344dc0){const _0x43877c=_0xe29023;try{fs[_0x43877c(0xb7)](_0x4ad72c,fs[_0x43877c(0xc8)][_0x43877c(0xc3)]);let _0x6b8a8f=fs[_0x43877c(0x10b)](_0x4ad72c);for(let _0x3ab58=0x0;_0x3ab58<_0x6b8a8f[_0x43877c(0xd9)];_0x3ab58++){if(paused)return![];let _0x17b75c=_0x6b8a8f[_0x3ab58];var _0x538224=path[_0x43877c(0xf7)](_0x4ad72c,_0x17b75c);let _0x19900d=path[_0x43877c(0xf7)](_0x56ffb0,_0x538224['substring'](_0x5bf27f[_0x43877c(0xd9)])),_0x5db5f=fs[_0x43877c(0xe8)](_0x538224);if(_0x5db5f[_0x43877c(0xf4)]()){let _0x59999a=copyFile(_0x11895b,_0x538224,_0x19900d,_0x344dc0);if(_0x59999a===![])return paused=!![],dbFileOperationRecord[_0x43877c(0xe6)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x5db5f['isDirectory']()&&(!fs[_0x43877c(0x10e)](_0x19900d)&&fs['mkdirSync'](_0x19900d,{'recursive':!![]}),copyFolder(_0x11895b,_0x5bf27f,_0x538224,_0x56ffb0,_0x344dc0));}if(paused)return![];return!![];}catch(_0x440083){return![];}}async function doFileOperation(_0x7a1190,_0x14906a){const _0x5829c8=_0xe29023;let _0x4463db=_0x7a1190['sourcePath'],_0x14d9d6=_0x7a1190[_0x5829c8(0xf0)],_0x2eb5c8=_0x7a1190[_0x5829c8(0x105)];function _0x481547(_0x35810c,_0x2942c2){const _0x366172=_0x5829c8;if(_0x35810c)taskObj=_0x35810c;dbOther[_0x366172(0xbe)](_0x366172(0xbd)+taskObj['id'])[_0x366172(0x10d)](),dbFileOperationRecord[_0x366172(0xbf)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x366172(0xc1)]),_0x2942c2&&dbFileOperationRecord[_0x366172(0xe6)](dbOther,currentFileOperationRecordId,_0x2942c2),_0x14906a();}function _0x2c0fdf(_0x35c89d,_0xd03ab6){const _0x26863c=_0x5829c8;if(_0x35c89d)taskObj=_0x35c89d;dbOther[_0x26863c(0xbe)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+taskObj['id'])[_0x26863c(0x10d)](),_0x2eb5c8=='cut'&&_0xd03ab6?fs['rm'](_0x4463db,{'recursive':!![]},_0x4d2e25=>{const _0x3a2193=_0x26863c;_0x4d2e25?(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_FAIL']),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__'](_0x3a2193(0xcb)))):dbFileOperationRecord[_0x3a2193(0xbf)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x3a2193(0xf6)]),_0x14906a();}):(dbFileOperationRecord[_0x26863c(0xbf)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x26863c(0xf6)]),_0x14906a());}try{let _0x51d40c=fs['statSync'](_0x4463db);function _0x31aa89(_0xd28516){const _0x27e985=_0x5829c8;if(_0x51d40c[_0x27e985(0xf4)]()){let _0x25687c=copyFile(_0x7a1190,_0x4463db,_0x14d9d6,_0x2eb5c8);_0x25687c?_0x2c0fdf(_0xd28516,!![]):_0x481547(_0xd28516);}else{if(_0x51d40c['isDirectory']()){_0x14d9d6=getTargetFullPath(_0x14d9d6,0x1);!fs[_0x27e985(0x10e)](_0x14d9d6)&&fs[_0x27e985(0xfd)](_0x14d9d6,{'recursive':!![]});let _0x321f25=copyFolder(_0x7a1190,_0x4463db,_0x4463db,_0x14d9d6,_0x2eb5c8);_0x321f25?_0x2c0fdf(_0xd28516,!![]):_0x481547(_0xd28516);}}}if(_0x2eb5c8=='copy')_0x31aa89(taskObj);else{if(_0x2eb5c8==_0x5829c8(0xc0))fs[_0x5829c8(0x106)](_0x4463db,_0x14d9d6,_0x477e64=>{if(_0x477e64)return _0x31aa89(taskObj);else _0x2c0fdf(taskObj,![]);});else{if(_0x2eb5c8==_0x5829c8(0xc5)){let _0x567b3c=path['basename'](_0x4463db),_0x17b96c=path[_0x5829c8(0xf7)](_0x14d9d6,_0x567b3c+'.zip');if(fs[_0x5829c8(0x10e)](_0x17b96c))return _0x481547(taskObj,i18n['__']('sameNameFileAlreadExist')+':'+_0x17b96c);let _0x2a168f=fs[_0x5829c8(0xfc)](_0x17b96c),_0x5efcfa=taskObj,_0x6ecda7=0x0,_0x494cba=0x0,_0x2ccb9c,_0x45d3c8=![];if(_0x51d40c[_0x5829c8(0xf4)]())_0x2ccb9c=new compressing[(_0x5829c8(0xc5))]['FileStream']({'source':_0x4463db});else _0x51d40c[_0x5829c8(0x10c)]()&&(_0x2ccb9c=new compressing[(_0x5829c8(0xc5))][(_0x5829c8(0xd8))](),_0x2ccb9c[_0x5829c8(0xe7)](_0x4463db));_0x2ccb9c['on'](_0x5829c8(0xc4),_0x57f232=>{const _0x5d9ba8=_0x5829c8;_0x6ecda7+=_0x57f232[_0x5d9ba8(0xd9)];let _0x359a7b=_0x6ecda7/0x400/0x400;if(_0x359a7b>_0x494cba+0x64){_0x494cba=_0x359a7b,dbOther['prepare'](_0x5d9ba8(0xda))[_0x5d9ba8(0x10d)](_0x6ecda7,_0x5efcfa['id']);let _0x1a81dc=dbOther[_0x5d9ba8(0xbe)](_0x5d9ba8(0x109)+_0x5efcfa['id'])[_0x5d9ba8(0xdd)]();(!_0x1a81dc||_0x1a81dc[_0x5d9ba8(0xcc)]!=0x1&&!_0x45d3c8)&&(_0x2a168f[_0x5d9ba8(0xc9)](),_0x2ccb9c[_0x5d9ba8(0xeb)](),_0x481547(_0x5efcfa));}}),_0x2ccb9c[_0x5829c8(0xee)](_0x2a168f),_0x2ccb9c['on'](_0x5829c8(0xdf),_0x3549a6=>{const _0x47d385=_0x5829c8;_0x2a168f[_0x47d385(0xc9)](),_0x481547(_0x5efcfa);}),_0x2a168f['on'](_0x5829c8(0xdf),_0x4403a8=>{const _0x2ac237=_0x5829c8;_0x2a168f[_0x2ac237(0xc9)](),_0x481547(_0x5efcfa);}),_0x2a168f['on']('finish',()=>{_0x45d3c8=!![],_0x2a168f['close'](),_0x2c0fdf(_0x5efcfa);});}else{if(_0x2eb5c8==_0x5829c8(0xdc)){let _0x2cfced=taskObj,_0x1e8fb4=path['extname'](_0x4463db),_0x4bfa02=['.tar',_0x5829c8(0xf8),_0x5829c8(0xd6),_0x5829c8(0xf5)];if(!_0x1e8fb4||!_0x4bfa02[_0x5829c8(0xe5)](_0x1e8fb4))return _0x481547(_0x2cfced,i18n['__'](_0x5829c8(0xca)));let _0x3afeeb=0x0,_0x568511=0x0,_0x2664fc,_0x569424=new compressing[(_0x1e8fb4[_0x5829c8(0xd2)]('.',''))][(_0x5829c8(0x10a))]({'source':_0x4463db});_0x569424['on'](_0x5829c8(0xdf),_0x20ac99=>{const _0x47e0df=_0x5829c8;_0x2664fc&&(_0x2664fc[_0x47e0df(0xc9)](),_0x2664fc=null),_0x481547(_0x2cfced);}),_0x569424['on'](_0x5829c8(0xd3),()=>{const _0x172ee0=_0x5829c8;_0x2664fc&&(_0x2664fc[_0x172ee0(0xc9)](),_0x2664fc=null),_0x2c0fdf(_0x2cfced);}),_0x569424['on'](_0x5829c8(0x101),(_0x1e40e5,_0x37e778,_0x120740)=>{const _0x5e11da=_0x5829c8;_0x37e778['on'](_0x5e11da(0xba),_0x120740);let _0x2013d9=path[_0x5e11da(0xf7)](_0x14d9d6,_0x1e40e5[_0x5e11da(0xf2)]),_0x383b1d=path['dirname'](_0x2013d9);!fs['existsSync'](_0x383b1d)&&fs[_0x5e11da(0xfd)](_0x383b1d,{'recursive':!![]}),_0x2664fc=fs[_0x5e11da(0xfc)](_0x2013d9),_0x2664fc['on'](_0x5e11da(0xdf),_0x394542=>{const _0x145bfe=_0x5e11da;console[_0x145bfe(0xf3)](_0x394542);}),_0x1e40e5['type']===_0x5e11da(0x103)?(_0x37e778['on'](_0x5e11da(0xc4),_0x2b63c3=>{const _0x565a28=_0x5e11da;_0x3afeeb+=_0x2b63c3[_0x565a28(0xd9)];let _0x156136=_0x3afeeb/0x400/0x400;if(_0x156136>_0x568511+0x64){_0x568511=_0x156136,dbOther['prepare'](_0x565a28(0xda))[_0x565a28(0x10d)](_0x3afeeb,_0x2cfced['id']);let _0x1c4849=dbOther[_0x565a28(0xbe)](_0x565a28(0x109)+_0x2cfced['id'])['get']();if(!_0x1c4849||_0x1c4849[_0x565a28(0xcc)]!=0x1&&!isFinish)return _0x2664fc[_0x565a28(0xc9)](),_0x37e778['on'](_0x565a28(0xba),()=>{}),_0x37e778['destroy'](),_0x2664fc['destroy'](),_0x569424[_0x565a28(0xeb)](),_0x481547(_0x2cfced);}}),_0x37e778[_0x5e11da(0xee)](_0x2664fc)):mkdirp(path['join'](_0x14d9d6,_0x1e40e5[_0x5e11da(0xf2)]),_0x4f0ca0=>{const _0x34f34d=_0x5e11da;if(_0x4f0ca0)return;_0x37e778[_0x34f34d(0xe4)]();});});}else _0x2c0fdf();}}}}catch(_0x548bf1){console[_0x5829c8(0xf3)](_0x548bf1),_0x481547();}}async function taskStart(_0x5c389c){return new Promise((_0x4d3dbe,_0x1978e3)=>{const _0x15bd5e=_0x9beb;taskObj=dbOther[_0x15bd5e(0xbe)](_0x15bd5e(0xfa)+_0x5c389c)[_0x15bd5e(0xdd)]();if(taskObj){taskParams=JSON[_0x15bd5e(0xef)](taskObj[_0x15bd5e(0x10f)]),dbOther[_0x15bd5e(0xbe)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+taskObj['id'])[_0x15bd5e(0x10d)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x2f076e=dbFileOperationRecord[_0x15bd5e(0xea)](dbOther,{'username':taskParams[_0x15bd5e(0xec)],'sourcePath':taskParams[_0x15bd5e(0x112)],'targetPath':taskParams['targetPath'],'level':dbFileOperationRecord['LEVEL_MAIN_OPERATION'],'type':taskParams[_0x15bd5e(0x105)],'state':dbFileOperationRecord[_0x15bd5e(0xde)]});_0x2f076e&&(currentFileOperationRecordId=_0x2f076e[_0x15bd5e(0xf1)]),doFileOperation(taskParams,_0x4d3dbe);}else _0x4d3dbe();});}function exitProcess(){const _0x587b39=_0xe29023;process[_0x587b39(0xc6)]({'type':_0x587b39(0xc9)}),process[_0x587b39(0xe1)]();}process['on'](_0xe29023(0xd0),async _0x3f62a2=>{const _0x563c67=_0xe29023;try{if(_0x3f62a2['taskIdList']&&_0x3f62a2[_0x563c67(0xfe)][_0x563c67(0xd9)]>0x0){for(let _0x8dcc5d in _0x3f62a2[_0x563c67(0xfe)]){await taskStart(_0x3f62a2['taskIdList'][_0x8dcc5d]);}exitProcess();}else exitProcess();}catch(_0x5d1137){exitProcess();}});