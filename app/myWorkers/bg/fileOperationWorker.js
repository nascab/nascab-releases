const _0x1fab2f=_0x23f0;(function(_0x2a02dc,_0x4e523b){const _0x354e19=_0x23f0,_0x4bddf2=_0x2a02dc();while(!![]){try{const _0x7d05b8=parseInt(_0x354e19(0x91))/0x1+parseInt(_0x354e19(0xa5))/0x2*(-parseInt(_0x354e19(0xaf))/0x3)+-parseInt(_0x354e19(0x92))/0x4+parseInt(_0x354e19(0xab))/0x5+-parseInt(_0x354e19(0x6d))/0x6+parseInt(_0x354e19(0xa2))/0x7+-parseInt(_0x354e19(0x73))/0x8*(-parseInt(_0x354e19(0xad))/0x9);if(_0x7d05b8===_0x4e523b)break;else _0x4bddf2['push'](_0x4bddf2['shift']());}catch(_0x8afa7f){_0x4bddf2['push'](_0x4bddf2['shift']());}}}(_0x24cf,0x70b37));let path=require(_0x1fab2f(0x81)),fs=require('fs');function _0x23f0(_0x51a2ad,_0x12404f){const _0x24cf80=_0x24cf();return _0x23f0=function(_0x23f0d5,_0x262547){_0x23f0d5=_0x23f0d5-0x6c;let _0x2dfd2d=_0x24cf80[_0x23f0d5];return _0x2dfd2d;},_0x23f0(_0x51a2ad,_0x12404f);}const dbFileOperationRecord=require(_0x1fab2f(0x6c)),config=require(_0x1fab2f(0x76)),Database=require(_0x1fab2f(0xbb));let dbOther=new Database(config[_0x1fab2f(0x95)],{});dbOther[_0x1fab2f(0x83)]('journal_mode\x20=\x20WAL');let i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x1fab2f(0xb6)](dbOther);const compressing=require('compressing'),mkdirp=require(_0x1fab2f(0xa7)),fileUtils=require(_0x1fab2f(0xb8));function _0x24cf(){const _0x18c139=['better-sqlite3','unzip','data','destroy','.zip','STATE_FAIL','../../db/dbFileOperationRecord','3442704zxACtf','mkdirSync','copy','zip','task_state','updateRecordRemark','5692208zDepbS','Stream','addFileOperationRecord','../../myConfig/config','FileStream','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','file.taskCancel','prepare','statSync','end','LEVEL_MAIN_OPERATION','message','resume','get','path','substring','pragma','STATE_DOING','sourcePath','log','length','UncompressStream','error','select\x20task_state\x20from\x20bg_task\x20where\x20id=','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','isDirectory','readdirSync','finish','exit','run','292477agqRqE','3348284aVhABy','join','accessSync','dbOther','isFile','targetPath','extname','replace','close','basename','pipe','cut','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','R_OK','username','existsSync','2691612sbsgKj','sameNameFileAlreadExist','updateRecordState','2554protMU','name','mkdirp','lastInsertRowid','entry','createWriteStream','2986875bODvTV','size','18bpaINt','rename','1938KDBPqt','constants','type','.tgz','taskIdList','parse','.gzip','getI18n','getFileErrStr','../../express-server/utils/fileUtils','dirname','STATE_SUC'];_0x24cf=function(){return _0x18c139;};return _0x24cf();}process['title']='NasCabFileWorker';let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0xcaeea9,_0x4f1fd0){const _0x339c69=_0x1fab2f;if(fs[_0x339c69(0xa1)](_0xcaeea9)){let _0x57aa6a=path[_0x339c69(0x9b)](_0xcaeea9),_0x19f16b=path[_0x339c69(0xb9)](_0xcaeea9),_0x467e6a=path[_0x339c69(0x98)](_0xcaeea9),_0x3aea5e=_0x57aa6a[_0x339c69(0x99)](_0x467e6a,'')+('('+_0x4f1fd0+')')+_0x467e6a,_0x1d9665=path[_0x339c69(0x93)](_0x19f16b,_0x3aea5e);return getTargetFullPath(_0x1d9665,_0x4f1fd0+0x1);}else return _0xcaeea9;}function copyFile(_0x4d4712,_0xc10502,_0x3a9753,_0x45c5dc){const _0x2063d9=_0x1fab2f;try{let _0x2c6f56=dbOther[_0x2063d9(0x7a)](_0x2063d9(0x8a)+taskObj['id'])['get']();if(!_0x2c6f56||_0x2c6f56[_0x2063d9(0x71)]!=0x1)return paused=!![],![];let _0x100f73=fs['statSync'](_0xc10502);return _0x3a9753=getTargetFullPath(_0x3a9753,0x1),fs['cpSync'](_0xc10502,_0x3a9753),copySize+=_0x100f73[_0x2063d9(0xac)],copyFileCount+=0x1,dbOther[_0x2063d9(0x7a)]('UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?')[_0x2063d9(0x90)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x3a703a){return console[_0x2063d9(0x86)](_0x3a703a),dbFileOperationRecord[_0x2063d9(0x72)](dbOther,currentFileOperationRecordId,fileUtils[_0x2063d9(0xb7)](i18n,_0x3a703a)),![];}}function copyFolder(_0x1b02c3,_0x2b4702,_0x360afb,_0xa2265e,_0xbc186b){const _0xaac2e9=_0x1fab2f;try{fs[_0xaac2e9(0x94)](_0x360afb,fs[_0xaac2e9(0xb0)][_0xaac2e9(0x9f)]);let _0xcd264a=fs[_0xaac2e9(0x8d)](_0x360afb);for(let _0x4ccd4f=0x0;_0x4ccd4f<_0xcd264a['length'];_0x4ccd4f++){if(paused)return![];let _0xa126f0=_0xcd264a[_0x4ccd4f];var _0x2fa509=path[_0xaac2e9(0x93)](_0x360afb,_0xa126f0);let _0x3c9a14=path[_0xaac2e9(0x93)](_0xa2265e,_0x2fa509[_0xaac2e9(0x82)](_0x2b4702[_0xaac2e9(0x87)])),_0x34c22b=fs[_0xaac2e9(0x7b)](_0x2fa509);if(_0x34c22b['isFile']()){let _0x4c9aa0=copyFile(_0x1b02c3,_0x2fa509,_0x3c9a14,_0xbc186b);if(_0x4c9aa0===![])return paused=!![],dbFileOperationRecord[_0xaac2e9(0x72)](dbOther,currentFileOperationRecordId,i18n['__'](_0xaac2e9(0x79))),![];}else _0x34c22b[_0xaac2e9(0x8c)]()&&(!fs[_0xaac2e9(0xa1)](_0x3c9a14)&&fs[_0xaac2e9(0x6e)](_0x3c9a14,{'recursive':!![]}),copyFolder(_0x1b02c3,_0x2b4702,_0x2fa509,_0xa2265e,_0xbc186b));}if(paused)return![];return!![];}catch(_0x428fe8){return![];}}async function doFileOperation(_0x20eb68,_0x451c6c){const _0x23123f=_0x1fab2f;let _0x550a56=_0x20eb68[_0x23123f(0x85)],_0x5c5a0f=_0x20eb68[_0x23123f(0x97)],_0x5c9306=_0x20eb68[_0x23123f(0xb1)];function _0x3fe88c(_0x167b62,_0x113f0e){const _0x398f06=_0x23123f;if(_0x167b62)taskObj=_0x167b62;dbOther[_0x398f06(0x7a)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])['run'](),dbFileOperationRecord[_0x398f06(0xa4)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x398f06(0xc0)]),_0x113f0e&&dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,_0x113f0e),_0x451c6c();}function _0x50d6e1(_0x419c58,_0x342df5){const _0x2b19ec=_0x23123f;if(_0x419c58)taskObj=_0x419c58;dbOther[_0x2b19ec(0x7a)](_0x2b19ec(0x9e)+taskObj['id'])[_0x2b19ec(0x90)](),_0x5c9306==_0x2b19ec(0x9d)&&_0x342df5?fs['rm'](_0x550a56,{'recursive':!![]},_0x1b3789=>{const _0x53248b=_0x2b19ec;_0x1b3789?(dbFileOperationRecord[_0x53248b(0xa4)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_FAIL']),dbFileOperationRecord[_0x53248b(0x72)](dbOther,currentFileOperationRecordId,i18n['__']('file.cutCopySucButDeleteFail'))):dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x53248b(0xba)]),_0x451c6c();}):(dbFileOperationRecord[_0x2b19ec(0xa4)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x2b19ec(0xba)]),_0x451c6c());}try{let _0x4077a3=fs[_0x23123f(0x7b)](_0x550a56);function _0x4c8d5c(_0x1d0364){const _0x1c7550=_0x23123f;if(_0x4077a3['isFile']()){let _0x4406cb=copyFile(_0x20eb68,_0x550a56,_0x5c5a0f,_0x5c9306);_0x4406cb?_0x50d6e1(_0x1d0364,!![]):_0x3fe88c(_0x1d0364);}else{if(_0x4077a3[_0x1c7550(0x8c)]()){_0x5c5a0f=getTargetFullPath(_0x5c5a0f,0x1);!fs['existsSync'](_0x5c5a0f)&&fs[_0x1c7550(0x6e)](_0x5c5a0f,{'recursive':!![]});let _0x258e7f=copyFolder(_0x20eb68,_0x550a56,_0x550a56,_0x5c5a0f,_0x5c9306);_0x258e7f?_0x50d6e1(_0x1d0364,!![]):_0x3fe88c(_0x1d0364);}}}if(_0x5c9306==_0x23123f(0x6f))_0x4c8d5c(taskObj);else{if(_0x5c9306==_0x23123f(0x9d))fs[_0x23123f(0xae)](_0x550a56,_0x5c5a0f,_0xfb1b67=>{if(_0xfb1b67)return _0x4c8d5c(taskObj);else _0x50d6e1(taskObj,![]);});else{if(_0x5c9306==_0x23123f(0x70)){let _0x3e2c9a=path[_0x23123f(0x9b)](_0x550a56),_0x4056fc=path[_0x23123f(0x93)](_0x5c5a0f,_0x3e2c9a+'.zip');if(fs[_0x23123f(0xa1)](_0x4056fc))return _0x3fe88c(taskObj,i18n['__'](_0x23123f(0xa3))+':'+_0x4056fc);let _0x2e58e8=fs[_0x23123f(0xaa)](_0x4056fc),_0x41cbf7=taskObj,_0x29aaff=0x0,_0x160fc9=0x0,_0x252f66,_0x5e9746=![];if(_0x4077a3[_0x23123f(0x96)]())_0x252f66=new compressing[(_0x23123f(0x70))][(_0x23123f(0x77))]({'source':_0x550a56});else _0x4077a3['isDirectory']()&&(_0x252f66=new compressing['zip'][(_0x23123f(0x74))](),_0x252f66['addEntry'](_0x550a56));_0x252f66['on'](_0x23123f(0xbd),_0x5a0386=>{const _0x266b48=_0x23123f;_0x29aaff+=_0x5a0386[_0x266b48(0x87)];let _0x478f7e=_0x29aaff/0x400/0x400;if(_0x478f7e>_0x160fc9+0x64){_0x160fc9=_0x478f7e,dbOther[_0x266b48(0x7a)](_0x266b48(0x78))[_0x266b48(0x90)](_0x29aaff,_0x41cbf7['id']);let _0x21b187=dbOther[_0x266b48(0x7a)](_0x266b48(0x8a)+_0x41cbf7['id'])[_0x266b48(0x80)]();(!_0x21b187||_0x21b187[_0x266b48(0x71)]!=0x1&&!_0x5e9746)&&(_0x2e58e8[_0x266b48(0x9a)](),_0x252f66['destroy'](),_0x3fe88c(_0x41cbf7));}}),_0x252f66['pipe'](_0x2e58e8),_0x252f66['on'](_0x23123f(0x89),_0x42f26d=>{_0x2e58e8['close'](),_0x3fe88c(_0x41cbf7);}),_0x2e58e8['on'](_0x23123f(0x89),_0x5a1f23=>{const _0x3f8858=_0x23123f;_0x2e58e8[_0x3f8858(0x9a)](),_0x3fe88c(_0x41cbf7);}),_0x2e58e8['on'](_0x23123f(0x8e),()=>{const _0x303de8=_0x23123f;_0x5e9746=!![],_0x2e58e8[_0x303de8(0x9a)](),_0x50d6e1(_0x41cbf7);});}else{if(_0x5c9306==_0x23123f(0xbc)){let _0xef653b=taskObj,_0x3730f4=path[_0x23123f(0x98)](_0x550a56),_0x10b119=['.tar',_0x23123f(0xb5),_0x23123f(0xb2),_0x23123f(0xbf)];if(!_0x3730f4||!_0x10b119['includes'](_0x3730f4))return _0x3fe88c(_0xef653b,i18n['__']('notSupportFileFormat'));let _0x4f261c=0x0,_0xf87af2=0x0,_0x1c90da,_0x87f85b=new compressing[(_0x3730f4[_0x23123f(0x99)]('.',''))][(_0x23123f(0x88))]({'source':_0x550a56});_0x87f85b['on']('error',_0x4f6f07=>{const _0x62a529=_0x23123f;_0x1c90da&&(_0x1c90da[_0x62a529(0x9a)](),_0x1c90da=null),_0x3fe88c(_0xef653b);}),_0x87f85b['on'](_0x23123f(0x8e),()=>{_0x1c90da&&(_0x1c90da['close'](),_0x1c90da=null),_0x50d6e1(_0xef653b);}),_0x87f85b['on'](_0x23123f(0xa9),(_0x3bea15,_0x287b74,_0x546995)=>{const _0x2d6fd5=_0x23123f;_0x287b74['on'](_0x2d6fd5(0x7c),_0x546995);let _0x4e0592=path[_0x2d6fd5(0x93)](_0x5c5a0f,_0x3bea15[_0x2d6fd5(0xa6)]),_0x21d2fc=path['dirname'](_0x4e0592);!fs[_0x2d6fd5(0xa1)](_0x21d2fc)&&fs[_0x2d6fd5(0x6e)](_0x21d2fc,{'recursive':!![]}),_0x1c90da=fs[_0x2d6fd5(0xaa)](_0x4e0592),_0x1c90da['on'](_0x2d6fd5(0x89),_0x229224=>{const _0x56d3de=_0x2d6fd5;console[_0x56d3de(0x86)](_0x229224);}),_0x3bea15[_0x2d6fd5(0xb1)]==='file'?(_0x287b74['on'](_0x2d6fd5(0xbd),_0x2980a1=>{const _0x2e3a38=_0x2d6fd5;_0x4f261c+=_0x2980a1[_0x2e3a38(0x87)];let _0xe5fd88=_0x4f261c/0x400/0x400;if(_0xe5fd88>_0xf87af2+0x64){_0xf87af2=_0xe5fd88,dbOther[_0x2e3a38(0x7a)](_0x2e3a38(0x78))[_0x2e3a38(0x90)](_0x4f261c,_0xef653b['id']);let _0x5e18ca=dbOther[_0x2e3a38(0x7a)](_0x2e3a38(0x8a)+_0xef653b['id'])[_0x2e3a38(0x80)]();if(!_0x5e18ca||_0x5e18ca[_0x2e3a38(0x71)]!=0x1&&!isFinish)return _0x1c90da[_0x2e3a38(0x9a)](),_0x287b74['on'](_0x2e3a38(0x7c),()=>{}),_0x287b74[_0x2e3a38(0xbe)](),_0x1c90da['destroy'](),_0x87f85b[_0x2e3a38(0xbe)](),_0x3fe88c(_0xef653b);}}),_0x287b74[_0x2d6fd5(0x9c)](_0x1c90da)):mkdirp(path[_0x2d6fd5(0x93)](_0x5c5a0f,_0x3bea15['name']),_0x4a0ed9=>{const _0x25838c=_0x2d6fd5;if(_0x4a0ed9)return;_0x287b74[_0x25838c(0x7f)]();});});}else _0x50d6e1();}}}}catch(_0x490512){console[_0x23123f(0x86)](_0x490512),_0x3fe88c();}}async function taskStart(_0x4f7e3d){return new Promise((_0x5c5714,_0xe5fbf)=>{const _0x20a58d=_0x23f0;taskObj=dbOther[_0x20a58d(0x7a)]('SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id='+_0x4f7e3d)['get']();if(taskObj){taskParams=JSON[_0x20a58d(0xb4)](taskObj['task_json']),dbOther['prepare'](_0x20a58d(0x8b)+taskObj['id'])[_0x20a58d(0x90)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x516da8=dbFileOperationRecord[_0x20a58d(0x75)](dbOther,{'username':taskParams[_0x20a58d(0xa0)],'sourcePath':taskParams[_0x20a58d(0x85)],'targetPath':taskParams[_0x20a58d(0x97)],'level':dbFileOperationRecord[_0x20a58d(0x7d)],'type':taskParams[_0x20a58d(0xb1)],'state':dbFileOperationRecord[_0x20a58d(0x84)]});_0x516da8&&(currentFileOperationRecordId=_0x516da8[_0x20a58d(0xa8)]),doFileOperation(taskParams,_0x5c5714);}else _0x5c5714();});}function exitProcess(){const _0x36a92e=_0x1fab2f;process['send']({'type':'close'}),process[_0x36a92e(0x8f)]();}process['on'](_0x1fab2f(0x7e),async _0x17e390=>{const _0x7fc76a=_0x1fab2f;try{if(_0x17e390['taskIdList']&&_0x17e390['taskIdList']['length']>0x0){for(let _0x17bf50 in _0x17e390['taskIdList']){await taskStart(_0x17e390[_0x7fc76a(0xb3)][_0x17bf50]);}exitProcess();}else exitProcess();}catch(_0x3fe246){exitProcess();}});