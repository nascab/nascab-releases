const _0x2ee34e=_0x3edc;(function(_0x3cc264,_0x233d6e){const _0x36bc89=_0x3edc,_0x3d5b85=_0x3cc264();while(!![]){try{const _0x376321=parseInt(_0x36bc89(0x10b))/0x1+-parseInt(_0x36bc89(0x111))/0x2+-parseInt(_0x36bc89(0x13b))/0x3*(parseInt(_0x36bc89(0x10d))/0x4)+-parseInt(_0x36bc89(0x107))/0x5*(-parseInt(_0x36bc89(0x102))/0x6)+parseInt(_0x36bc89(0xfb))/0x7*(parseInt(_0x36bc89(0x116))/0x8)+parseInt(_0x36bc89(0x132))/0x9*(parseInt(_0x36bc89(0x118))/0xa)+-parseInt(_0x36bc89(0x124))/0xb*(parseInt(_0x36bc89(0x14c))/0xc);if(_0x376321===_0x233d6e)break;else _0x3d5b85['push'](_0x3d5b85['shift']());}catch(_0x5a4a92){_0x3d5b85['push'](_0x3d5b85['shift']());}}}(_0x3dd1,0xeb0ec));const Database=require(_0x2ee34e(0x104)),config=require(_0x2ee34e(0x143));function _0x3dd1(){const _0x2f77c7=['fileCopyFail','substring','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27','test','R_OK','cpSync','\x20WHERE\x20id=','dbOther','REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)','rmdirSync','22658537HkNtSb','format','exec','statSync','isDirectory','NasCabBackupWorker','target_path','includes','status=\x27running\x27','status','accessSync','mtimeMs','isFile','ERROR','460656PkSvez','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','split','getDate','readdirSync','getFullYear','getMonth','constants','folderNotExist','6MCyroH','W_OK','YYYY-MM-DD\x20HH:mm:ss',',status=\x27done\x27,fail_count=','getDay','run','\x20and\x20(start_time>=\x27','prepare','../../myConfig/config','UPDATE\x20backup_task_record\x20SET\x20',',copy_count=',',total_size=','ReadFolderFail','count','exclude_list','size','then','12txsVPB','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27','pragma','journal_mode\x20=\x20WAL',',end_time=\x27','existsSync','\x5c$1','moment','%\x27)','7FhBxVl','noWritePermission','stringify','map','parse','getHours','basename','384726smIRds','rmSync','better-sqlite3','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','replace','65QCtDEO','length','path','exit','1736007ILCeju','running','912848APsDRq','get','getTime',',files_count=','2040484abqaiO','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','source_list','getMinutes','5201192tFcGNP','join','250VYAFwi','\x27,\x20\x27waiting\x27,\x27'];_0x3dd1=function(){return _0x2f77c7;};return _0x3dd1();}function _0x3edc(_0x494633,_0x77441f){const _0x3dd15c=_0x3dd1();return _0x3edc=function(_0x3edc5c,_0x293daf){_0x3edc5c=_0x3edc5c-0xf4;let _0x505396=_0x3dd15c[_0x3edc5c];return _0x505396;},_0x3edc(_0x494633,_0x77441f);}let dbOther=new Database(config[_0x2ee34e(0x121)],{});dbOther[_0x2ee34e(0xf4)](_0x2ee34e(0xf5));let moment=require(_0x2ee34e(0xf9)),path=require(_0x2ee34e(0x109)),fs=require('fs'),i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil['getI18n'](dbOther);process['title']=_0x2ee34e(0x129);let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x308a09,_0x2666d3,_0x4f1c90,_0x1b4189){const _0x2c02a6=_0x2ee34e;try{let _0x2a3b46=dbOther[_0x2c02a6(0x142)]('select\x20status\x20from\x20backup_task_record\x20where\x20id='+_0x2666d3)[_0x2c02a6(0x10e)]();if(_0x2a3b46[_0x2c02a6(0x12d)]!=_0x2c02a6(0x10c))return paused=!![],![];let _0x12f679=fs[_0x2c02a6(0x127)](_0x4f1c90);filesCount+=0x1,totalSize+=_0x12f679['size'];let _0x35d4f0=!![];if(!fs['existsSync'](_0x1b4189))fs[_0x2c02a6(0x11f)](_0x4f1c90,_0x1b4189,{'preserveTimestamps':!![]}),copySize+=_0x12f679[_0x2c02a6(0x14a)],copyFileCount+=0x1;else{let _0x321680=fs['statSync'](_0x1b4189);_0x12f679[_0x2c02a6(0x14a)]==_0x321680[_0x2c02a6(0x14a)]&&Math['abs'](_0x12f679[_0x2c02a6(0x12f)]-_0x321680[_0x2c02a6(0x12f)])<=0x3e8?_0x35d4f0=![]:(fs[_0x2c02a6(0x11f)](_0x4f1c90,_0x1b4189,{'preserveTimestamps':!![]}),copySize+=_0x12f679['size'],copyFileCount+=0x1);}return _0x35d4f0&&updateTaskRecord(_0x2666d3,'copy_size='+copySize+_0x2c02a6(0x145)+copyFileCount),!![];}catch(_0x395e15){return addTaskMsg(_0x308a09,_0x2666d3,_0x2c02a6(0x131),_0x4f1c90+':'+i18n['__'](_0x2c02a6(0x11a))+'\x20ERROR:'+JSON['stringify'](_0x395e15)),!![];}}function matchRuleShort(_0x23b07e,_0x2bc070){const _0x824ad4=_0x2ee34e;var _0xadc249=_0x9b52e3=>_0x9b52e3[_0x824ad4(0x106)](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x824ad4(0xf8));return new RegExp('^'+_0x2bc070[_0x824ad4(0x134)]('*')[_0x824ad4(0xfe)](_0xadc249)['join']('.*')+'$')[_0x824ad4(0x11d)](_0x23b07e);}function copyFolder(_0x5d4714,_0x53c1ce,_0x174775,_0x38ddb5,_0x484072){const _0x51bfab=_0x2ee34e;let _0x59b181=_0x5d4714['id'],_0x25fee1=checkFolderPower(_0x38ddb5,!![]);if(!_0x25fee1)addTaskMsg(_0x59b181,_0x53c1ce,_0x51bfab(0x131),i18n['__'](_0x51bfab(0xfc))+':'+_0x38ddb5);else try{let _0x1c6bd2=fs[_0x51bfab(0x136)](_0x38ddb5);for(let _0x3a8b8c=0x0;_0x3a8b8c<_0x1c6bd2[_0x51bfab(0x108)];_0x3a8b8c++){let _0x165d44=_0x1c6bd2[_0x3a8b8c];var _0x290f54=path[_0x51bfab(0x117)](_0x38ddb5,_0x165d44);let _0x4e473c=fs['statSync'](_0x290f54);var _0x37155b=_0x4e473c[_0x51bfab(0x130)](),_0x5ece51=_0x4e473c[_0x51bfab(0x128)]();if(_0x37155b){if(excludeList[_0x51bfab(0x12b)](_0x165d44))continue;if(_0x5d4714['exclude_list']&&_0x5d4714[_0x51bfab(0x149)]['length']>0x0){let _0x5f5a5e=JSON[_0x51bfab(0xff)](_0x5d4714[_0x51bfab(0x149)]),_0x3cf691=!![];for(let _0x19a6a6 in _0x5f5a5e){if(_0x5f5a5e[_0x19a6a6][_0x51bfab(0x12b)]('*')){if(matchRuleShort(_0x165d44,_0x5f5a5e[_0x19a6a6])){_0x3cf691=![];break;}}else{if(_0x5f5a5e[_0x19a6a6]==_0x165d44){_0x3cf691=![];break;}}}if(!_0x3cf691){excludeCount+=0x1;continue;}}let _0x28aad0=path[_0x51bfab(0x117)](_0x484072,path[_0x51bfab(0x101)](_0x174775),_0x290f54[_0x51bfab(0x11b)](_0x174775[_0x51bfab(0x108)])),_0x55c24d=copyFile(_0x59b181,_0x53c1ce,_0x290f54,_0x28aad0);if(_0x55c24d===![])return![];}else _0x5ece51&&copyFolder(_0x5d4714,_0x53c1ce,_0x174775,_0x290f54,_0x484072);}}catch(_0x1e56e1){addTaskMsg(_0x59b181,_0x53c1ce,_0x51bfab(0x131),i18n['__'](_0x51bfab(0x147))+':'+_0x38ddb5);}}function reverseCheck(_0x19da3f,_0x5cd01f,_0x1632b1,_0x514d04,_0xf2bc9f){const _0x47ac0b=_0x2ee34e;try{if(!fs[_0x47ac0b(0xf7)](_0xf2bc9f))return;let _0x2474b5=fs['readdirSync'](_0xf2bc9f);for(let _0x13c0ef=0x0;_0x13c0ef<_0x2474b5[_0x47ac0b(0x108)];_0x13c0ef++){let _0x471f19=_0x2474b5[_0x13c0ef];var _0x428b04=path[_0x47ac0b(0x117)](_0xf2bc9f,_0x471f19);let _0x1ccce9=fs[_0x47ac0b(0x127)](_0x428b04);var _0x5c412f=_0x1ccce9[_0x47ac0b(0x130)](),_0x42ae8d=_0x1ccce9[_0x47ac0b(0x128)]();let _0x5d8e4c=path[_0x47ac0b(0x117)](_0x514d04,_0x428b04[_0x47ac0b(0x11b)](_0x1632b1[_0x47ac0b(0x108)]));if(_0x5c412f)!fs[_0x47ac0b(0xf7)](_0x5d8e4c)&&fs[_0x47ac0b(0x103)](_0x428b04,{'force':!![],'maxRetries':0xa});else _0x42ae8d&&(!fs[_0x47ac0b(0xf7)](_0x5d8e4c)?fs[_0x47ac0b(0x123)](_0x428b04,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x19da3f,_0x5cd01f,_0x1632b1,_0x514d04,_0x428b04));}}catch(_0x81f11a){addTaskMsg(_0x19da3f,_0x5cd01f,_0x47ac0b(0x131),i18n['__'](_0x47ac0b(0x147))+':'+_0x514d04);}}function updateTaskRecord(_0x1ea3d1,_0x4bd2cc){const _0x1ce1e7=_0x2ee34e;let _0x451688=_0x1ce1e7(0x144);_0x451688+=_0x4bd2cc,_0x451688+=_0x1ce1e7(0x120)+_0x1ea3d1,dbOther[_0x1ce1e7(0x126)](_0x451688);}function setTaskOver(_0xda02e0){const _0xff5815=_0x2ee34e;let _0x833f9d=dbOther[_0xff5815(0x142)]('select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id='+_0xda02e0['id'])[_0xff5815(0x10e)](),_0x5b9bab=moment()[_0xff5815(0x125)](_0xff5815(0x13d));updateTaskRecord(_0xda02e0['id'],'copy_size='+copySize+_0xff5815(0x145)+copyFileCount+',exclude_count='+excludeCount+_0xff5815(0x13e)+_0x833f9d[_0xff5815(0x148)]+_0xff5815(0x110)+filesCount+_0xff5815(0x146)+totalSize+_0xff5815(0xf6)+_0x5b9bab+'\x27');}function addTaskMsg(_0x5b3225,_0x2a2d26,_0x49ec33,_0x5264a1){const _0x1e5d77=_0x2ee34e,_0x38a118=_0x1e5d77(0x122);return dbOther['prepare'](_0x38a118)[_0x1e5d77(0x140)](''+_0x5b3225,''+_0x2a2d26,''+_0x49ec33,''+_0x5264a1);}function checkFolderPower(_0x5ccb7e,_0xdaa9ab){const _0x6e449d=_0x2ee34e;try{return _0xdaa9ab?fs[_0x6e449d(0x12e)](_0x5ccb7e,fs[_0x6e449d(0x139)]['R_OK']):fs[_0x6e449d(0x12e)](_0x5ccb7e,fs['constants'][_0x6e449d(0x11e)]|fs[_0x6e449d(0x139)][_0x6e449d(0x13c)]),!![];}catch(_0x2263db){return![];}}function exeTask(_0x14ce32){const _0x5f060d=_0x2ee34e;let _0x346c30=_0x5f060d(0x133),_0x2838ba=dbOther[_0x5f060d(0x142)](_0x346c30)['get']();if(_0x2838ba){let _0x2fdc92='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20'+_0x2838ba['task_id'],_0x1acf27=dbOther['prepare'](_0x2fdc92)[_0x5f060d(0x10e)]();if(!fs[_0x5f060d(0xf7)](_0x1acf27[_0x5f060d(0x12a)]))return addTaskMsg(_0x1acf27['id'],_0x2838ba['id'],_0x5f060d(0x131),i18n['__']('targetFolderNotExist')+':'+_0x1acf27['target_path']),setTaskOver(_0x2838ba),_0x14ce32();let _0x4990c6=checkFolderPower(_0x1acf27['target_path']);if(!_0x4990c6)return addTaskMsg(_0x1acf27['id'],_0x2838ba['id'],_0x5f060d(0x131),i18n['__'](_0x5f060d(0xfc))+':'+_0x1acf27[_0x5f060d(0x12a)]),setTaskOver(_0x2838ba),_0x14ce32();updateTaskRecord(_0x2838ba['id'],_0x5f060d(0x12c));let _0x24d4dd=JSON['parse'](_0x1acf27[_0x5f060d(0x114)]);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0x146fe3 in _0x24d4dd){try{if(fs[_0x5f060d(0xf7)](_0x24d4dd[_0x146fe3])){copyFolder(_0x1acf27,_0x2838ba['id'],_0x24d4dd[_0x146fe3],_0x24d4dd[_0x146fe3],_0x1acf27[_0x5f060d(0x12a)]);if(!paused){let _0x244209=path[_0x5f060d(0x117)](_0x1acf27[_0x5f060d(0x12a)],path['basename'](_0x24d4dd[_0x146fe3]));reverseCheck(_0x1acf27['id'],_0x2838ba['id'],_0x244209,_0x24d4dd[_0x146fe3],_0x244209);}}else addTaskMsg(_0x1acf27['id'],_0x2838ba['id'],'ERROR',i18n['__'](_0x5f060d(0x13a))+':'+_0x24d4dd[_0x146fe3]);}catch(_0x136c43){addTaskMsg(_0x1acf27['id'],_0x2838ba['id'],_0x5f060d(0x131),i18n['__'](_0x5f060d(0x11a))+':'+_0x24d4dd[_0x146fe3]+':'+JSON[_0x5f060d(0xfd)](_0x136c43));}}!paused&&setTaskOver(_0x2838ba),_0x14ce32();}else setTimeout(()=>{_0x14ce32();},0x2710);}function runInfinit(){return new Promise(_0x536155=>{exeTask(_0x536155);});}async function runBacupExe(){const _0x48eb7e=_0x2ee34e;runInfinit()[_0x48eb7e(0x14b)](()=>{runBacupExe();});}dbOther['exec'](_0x2ee34e(0x112)),runBacupExe();function addTask(_0x3e2bb1){const _0x1415a7=_0x2ee34e;let _0x1a5ee5=dbOther[_0x1415a7(0x142)](_0x3e2bb1)['all']();if(_0x1a5ee5['length']>0x0)for(let _0x2ab426=0x0;_0x2ab426<_0x1a5ee5['length'];_0x2ab426++){let _0xe1ea70=_0x1a5ee5[_0x2ab426],_0x2fcc0e=moment(new Date()[_0x1415a7(0x10f)]()-0xea60)['format'](_0x1415a7(0x13d)),_0x1cc280='select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id='+_0xe1ea70['id']+_0x1415a7(0x141)+_0x2fcc0e+'\x27\x20or\x20status!=\x27done\x27)',_0x519a09=dbOther['prepare'](_0x1cc280)[_0x1415a7(0x10e)]();if(_0x519a09[_0x1415a7(0x148)]<0x1){let _0x5b1dbc=moment()[_0x1415a7(0x125)](_0x1415a7(0x13d));const _0xd9b2a1=_0x1415a7(0x105)+_0xe1ea70['id']+_0x1415a7(0x119)+_0x5b1dbc+'\x27)';return dbOther['exec'](_0xd9b2a1);}else{}}}function add0(_0x1b2e43){return _0x1b2e43<0xa?'0'+_0x1b2e43:_0x1b2e43;}function getYmd(_0xf8d8f7){const _0x3f1d13=_0x2ee34e;var _0x4c29c9=_0xf8d8f7[_0x3f1d13(0x137)](),_0x31c340=_0xf8d8f7[_0x3f1d13(0x138)]()+0x1,_0x4d64e5=_0xf8d8f7[_0x3f1d13(0x135)]();return _0x4c29c9+'-'+add0(_0x31c340)+'-'+add0(_0x4d64e5);}function runBackupCheck(){setInterval(()=>{const _0x44322a=_0x3edc;let _0x1309f9=new Date(),_0x3eeaca=_0x1309f9[_0x44322a(0x13f)](),_0x3b6a8d=_0x1309f9['getDate'](),_0x29267b=add0(_0x1309f9[_0x44322a(0x100)]()),_0x1215ba=add0(_0x1309f9[_0x44322a(0x115)]()),_0x3cdfb4=getYmd(_0x1309f9),_0x4483a3=_0x44322a(0x113)+_0x3cdfb4+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x29267b+':'+_0x1215ba+_0x44322a(0xfa);addTask(_0x4483a3);let _0x539484='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x29267b+':'+_0x1215ba+'%\x27)';addTask(_0x539484);let _0x4ea764=_0x44322a(0x14d)+_0x3eeaca+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x29267b+':'+_0x1215ba+'%\x27)';addTask(_0x4ea764);let _0x19c37b=_0x44322a(0x11c)+_0x3b6a8d+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x29267b+':'+_0x1215ba+_0x44322a(0xfa);addTask(_0x19c37b);},0x3a98);}runBackupCheck(),process['on'](_0x2ee34e(0x10a),(_0x32c078,_0x4fbcb0)=>{process['send']({'type':'close'});});