const _0xc25678=_0x799f;(function(_0x571792,_0x36d867){const _0x2c92dd=_0x799f,_0x3684e6=_0x571792();while(!![]){try{const _0x5dcd3f=parseInt(_0x2c92dd(0xe0))/0x1*(-parseInt(_0x2c92dd(0x132))/0x2)+-parseInt(_0x2c92dd(0xd8))/0x3+parseInt(_0x2c92dd(0xe1))/0x4+-parseInt(_0x2c92dd(0x12d))/0x5*(parseInt(_0x2c92dd(0xdd))/0x6)+parseInt(_0x2c92dd(0x111))/0x7*(parseInt(_0x2c92dd(0xf4))/0x8)+parseInt(_0x2c92dd(0x10a))/0x9+parseInt(_0x2c92dd(0x11a))/0xa*(parseInt(_0x2c92dd(0x116))/0xb);if(_0x5dcd3f===_0x36d867)break;else _0x3684e6['push'](_0x3684e6['shift']());}catch(_0xe0cb28){_0x3684e6['push'](_0x3684e6['shift']());}}}(_0x5202,0xb2641));const Database=require(_0xc25678(0x11c)),config=require(_0xc25678(0x113));let dbOther=new Database(config[_0xc25678(0xdb)],{});dbOther[_0xc25678(0xf7)](_0xc25678(0xef));let moment=require('moment'),path=require(_0xc25678(0xfa)),fs=require('fs'),i18nUtil=require(_0xc25678(0x107)),i18n=i18nUtil[_0xc25678(0x119)](dbOther);process[_0xc25678(0xd4)]=_0xc25678(0xda);function _0x799f(_0x51e24b,_0x225aa8){const _0x5202c2=_0x5202();return _0x799f=function(_0x799f2,_0x2a06e1){_0x799f2=_0x799f2-0xd4;let _0x805ea5=_0x5202c2[_0x799f2];return _0x805ea5;},_0x799f(_0x51e24b,_0x225aa8);}let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x55652a,_0x4b95a3,_0x205de9,_0x3aa2c7){const _0x20c667=_0xc25678;try{let _0x231d54=dbOther['prepare']('select\x20status\x20from\x20backup_task_record\x20where\x20id='+_0x4b95a3)[_0x20c667(0x12a)]();if(_0x231d54[_0x20c667(0x120)]!='running')return paused=!![],![];let _0x11f46a=fs['statSync'](_0x205de9);filesCount+=0x1,totalSize+=_0x11f46a[_0x20c667(0x101)];let _0x21cf9=!![];if(!fs[_0x20c667(0xd5)](_0x3aa2c7))fs[_0x20c667(0x11b)](_0x205de9,_0x3aa2c7,{'preserveTimestamps':!![]}),copySize+=_0x11f46a[_0x20c667(0x101)],copyFileCount+=0x1;else{let _0x3edbe9=fs['statSync'](_0x3aa2c7);_0x11f46a[_0x20c667(0x101)]==_0x3edbe9['size']&&Math[_0x20c667(0x127)](_0x11f46a[_0x20c667(0x10c)]-_0x3edbe9['mtimeMs'])<=0x3e8?_0x21cf9=![]:(fs[_0x20c667(0x11b)](_0x205de9,_0x3aa2c7,{'preserveTimestamps':!![]}),copySize+=_0x11f46a[_0x20c667(0x101)],copyFileCount+=0x1);}return _0x21cf9&&updateTaskRecord(_0x4b95a3,_0x20c667(0x103)+copySize+_0x20c667(0xf0)+copyFileCount),!![];}catch(_0x50cceb){return addTaskMsg(_0x55652a,_0x4b95a3,'ERROR',_0x205de9+':'+i18n['__'](_0x20c667(0xe7))+'\x20ERROR:'+JSON[_0x20c667(0xe4)](_0x50cceb)),!![];}}function matchRuleShort(_0x1a4064,_0x571f84){const _0x26ad85=_0xc25678;var _0x3507b6=_0x417112=>_0x417112['replace'](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x26ad85(0xf9));return new RegExp('^'+_0x571f84[_0x26ad85(0x11d)]('*')[_0x26ad85(0xeb)](_0x3507b6)[_0x26ad85(0x110)]('.*')+'$')[_0x26ad85(0xfb)](_0x1a4064);}function copyFolder(_0xe4ef9f,_0x3a858a,_0x1248b9,_0x1fb419,_0xff849d){const _0x4e2691=_0xc25678;let _0x3ee7f3=_0xe4ef9f['id'],_0x267471=checkFolderPower(_0x1fb419,!![]);if(!_0x267471)addTaskMsg(_0x3ee7f3,_0x3a858a,_0x4e2691(0x11f),i18n['__'](_0x4e2691(0xf3))+':'+_0x1fb419);else try{let _0x5c54f6=fs['readdirSync'](_0x1fb419);for(let _0xfab733=0x0;_0xfab733<_0x5c54f6[_0x4e2691(0xe2)];_0xfab733++){let _0x5339b8=_0x5c54f6[_0xfab733];var _0x271b9d=path['join'](_0x1fb419,_0x5339b8);let _0xc3bc84=fs[_0x4e2691(0x10b)](_0x271b9d);var _0x16205f=_0xc3bc84[_0x4e2691(0xe6)](),_0x4bdbf8=_0xc3bc84[_0x4e2691(0x104)]();if(_0x16205f){if(excludeList[_0x4e2691(0x112)](_0x5339b8))continue;if(_0xe4ef9f[_0x4e2691(0x12e)]&&_0xe4ef9f[_0x4e2691(0x12e)][_0x4e2691(0xe2)]>0x0){let _0x1ac700=JSON[_0x4e2691(0xf6)](_0xe4ef9f['exclude_list']),_0x59e2fa=!![];for(let _0x43f959 in _0x1ac700){if(_0x1ac700[_0x43f959][_0x4e2691(0x112)]('*')){if(matchRuleShort(_0x5339b8,_0x1ac700[_0x43f959])){_0x59e2fa=![];break;}}else{if(_0x1ac700[_0x43f959]==_0x5339b8){_0x59e2fa=![];break;}}}if(!_0x59e2fa){excludeCount+=0x1;continue;}}let _0x48b423=path['join'](_0xff849d,path['basename'](_0x1248b9),_0x271b9d[_0x4e2691(0xfc)](_0x1248b9[_0x4e2691(0xe2)])),_0x56f016=copyFile(_0x3ee7f3,_0x3a858a,_0x271b9d,_0x48b423);if(_0x56f016===![])return![];}else _0x4bdbf8&&copyFolder(_0xe4ef9f,_0x3a858a,_0x1248b9,_0x271b9d,_0xff849d);}}catch(_0x36c8e6){addTaskMsg(_0x3ee7f3,_0x3a858a,_0x4e2691(0x11f),i18n['__'](_0x4e2691(0x117))+':'+_0x1fb419);}}function reverseCheck(_0x1a89ae,_0x4e37ff,_0x749073,_0x19ac98,_0x249bab){const _0xc887a6=_0xc25678;try{if(!fs[_0xc887a6(0xd5)](_0x249bab))return;let _0x5bf225=fs[_0xc887a6(0x122)](_0x249bab);for(let _0x3c2631=0x0;_0x3c2631<_0x5bf225[_0xc887a6(0xe2)];_0x3c2631++){let _0x2cfc16=_0x5bf225[_0x3c2631];var _0x40eae0=path[_0xc887a6(0x110)](_0x249bab,_0x2cfc16);let _0x5ab35e=fs[_0xc887a6(0x10b)](_0x40eae0);var _0x5abc67=_0x5ab35e[_0xc887a6(0xe6)](),_0x2fb774=_0x5ab35e['isDirectory']();let _0x1c8d30=path['join'](_0x19ac98,_0x40eae0[_0xc887a6(0xfc)](_0x749073[_0xc887a6(0xe2)]));if(_0x5abc67)!fs[_0xc887a6(0xd5)](_0x1c8d30)&&fs[_0xc887a6(0xd7)](_0x40eae0,{'force':!![],'maxRetries':0xa});else _0x2fb774&&(!fs[_0xc887a6(0xd5)](_0x1c8d30)?fs[_0xc887a6(0x100)](_0x40eae0,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x1a89ae,_0x4e37ff,_0x749073,_0x19ac98,_0x40eae0));}}catch(_0x1f1d07){addTaskMsg(_0x1a89ae,_0x4e37ff,'ERROR',i18n['__'](_0xc887a6(0x117))+':'+_0x19ac98);}}function updateTaskRecord(_0x149941,_0x17951b){const _0x41bdf8=_0xc25678;let _0x568994=_0x41bdf8(0xe8);_0x568994+=_0x17951b,_0x568994+='\x20WHERE\x20id='+_0x149941,dbOther[_0x41bdf8(0xea)](_0x568994);}function setTaskOver(_0x9d09bc){const _0x57fd2a=_0xc25678;let _0x181cc4=dbOther[_0x57fd2a(0xf5)](_0x57fd2a(0x12c)+_0x9d09bc['id'])[_0x57fd2a(0x12a)](),_0x52aad4=moment()['format'](_0x57fd2a(0x115));updateTaskRecord(_0x9d09bc['id'],'copy_size='+copySize+',copy_count='+copyFileCount+_0x57fd2a(0x129)+excludeCount+_0x57fd2a(0x105)+_0x181cc4[_0x57fd2a(0x131)]+_0x57fd2a(0xee)+filesCount+_0x57fd2a(0xfd)+totalSize+_0x57fd2a(0x123)+_0x52aad4+'\x27');}function addTaskMsg(_0x4d0cb6,_0x58b15e,_0xeb2fb0,_0x44ed43){const _0x4e1ddd=_0xc25678,_0x59f2ec=_0x4e1ddd(0x11e);return dbOther[_0x4e1ddd(0xf5)](_0x59f2ec)['run'](''+_0x4d0cb6,''+_0x58b15e,''+_0xeb2fb0,''+_0x44ed43);}function checkFolderPower(_0x1d6083,_0x32c6e6){const _0x4eb6de=_0xc25678;try{return _0x32c6e6?fs['accessSync'](_0x1d6083,fs[_0x4eb6de(0xe3)]['R_OK']):fs['accessSync'](_0x1d6083,fs[_0x4eb6de(0xe3)][_0x4eb6de(0xed)]|fs[_0x4eb6de(0xe3)][_0x4eb6de(0x130)]),!![];}catch(_0x38f334){return![];}}function exeTask(_0x3a25eb){const _0x1bde43=_0xc25678;let _0x5e318b=_0x1bde43(0x108),_0x11e642=dbOther[_0x1bde43(0xf5)](_0x5e318b)[_0x1bde43(0x12a)]();if(_0x11e642){let _0x5f913e=_0x1bde43(0x126)+_0x11e642[_0x1bde43(0x109)],_0x4a269a=dbOther[_0x1bde43(0xf5)](_0x5f913e)[_0x1bde43(0x12a)]();if(!fs['existsSync'](_0x4a269a[_0x1bde43(0xe9)]))return addTaskMsg(_0x4a269a['id'],_0x11e642['id'],_0x1bde43(0x11f),i18n['__'](_0x1bde43(0x125))+':'+_0x4a269a[_0x1bde43(0xe9)]),setTaskOver(_0x11e642),_0x3a25eb();let _0x10d3a1=checkFolderPower(_0x4a269a[_0x1bde43(0xe9)]);if(!_0x10d3a1)return addTaskMsg(_0x4a269a['id'],_0x11e642['id'],'ERROR',i18n['__'](_0x1bde43(0xf3))+':'+_0x4a269a[_0x1bde43(0xe9)]),setTaskOver(_0x11e642),_0x3a25eb();updateTaskRecord(_0x11e642['id'],_0x1bde43(0xd9));let _0x48c44b=JSON['parse'](_0x4a269a[_0x1bde43(0xf1)]);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0xa5313c in _0x48c44b){try{if(fs['existsSync'](_0x48c44b[_0xa5313c])){copyFolder(_0x4a269a,_0x11e642['id'],_0x48c44b[_0xa5313c],_0x48c44b[_0xa5313c],_0x4a269a[_0x1bde43(0xe9)]);if(!paused){let _0x4ca6b8=path[_0x1bde43(0x110)](_0x4a269a[_0x1bde43(0xe9)],path[_0x1bde43(0x12b)](_0x48c44b[_0xa5313c]));reverseCheck(_0x4a269a['id'],_0x11e642['id'],_0x4ca6b8,_0x48c44b[_0xa5313c],_0x4ca6b8);}}else addTaskMsg(_0x4a269a['id'],_0x11e642['id'],_0x1bde43(0x11f),i18n['__']('folderNotExist')+':'+_0x48c44b[_0xa5313c]);}catch(_0x3d1884){addTaskMsg(_0x4a269a['id'],_0x11e642['id'],_0x1bde43(0x11f),i18n['__'](_0x1bde43(0xe7))+':'+_0x48c44b[_0xa5313c]+':'+JSON[_0x1bde43(0xe4)](_0x3d1884));}}!paused&&setTaskOver(_0x11e642),_0x3a25eb();}else setTimeout(()=>{_0x3a25eb();},0x2710);}function runInfinit(){return new Promise(_0x234207=>{exeTask(_0x234207);});}async function runBacupExe(){const _0x11cd56=_0xc25678;runInfinit()[_0x11cd56(0x121)](()=>{runBacupExe();});}dbOther[_0xc25678(0xea)](_0xc25678(0x114)),runBacupExe();function addTask(_0x299cfa){const _0x7b3815=_0xc25678;let _0x2dbe3d=dbOther['prepare'](_0x299cfa)[_0x7b3815(0x106)]();if(_0x2dbe3d[_0x7b3815(0xe2)]>0x0)for(let _0x355a1e=0x0;_0x355a1e<_0x2dbe3d['length'];_0x355a1e++){let _0x20157a=_0x2dbe3d[_0x355a1e],_0x2bd5e4=moment(new Date()[_0x7b3815(0xd6)]()-0xea60)[_0x7b3815(0x128)](_0x7b3815(0x115)),_0xc75b25=_0x7b3815(0xde)+_0x20157a['id']+'\x20and\x20(start_time>=\x27'+_0x2bd5e4+_0x7b3815(0xe5),_0x27d500=dbOther[_0x7b3815(0xf5)](_0xc75b25)[_0x7b3815(0x12a)]();if(_0x27d500['count']<0x1){let _0x101346=moment()[_0x7b3815(0x128)](_0x7b3815(0x115));const _0x3f7f6e=_0x7b3815(0x118)+_0x20157a['id']+_0x7b3815(0x12f)+_0x101346+'\x27)';return dbOther[_0x7b3815(0xea)](_0x3f7f6e);}else{}}}function add0(_0xee0161){return _0xee0161<0xa?'0'+_0xee0161:_0xee0161;}function _0x5202(){const _0x535475=['../../utils/i18nUtil','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','task_id','10683117NFYDiR','statSync','mtimeMs','exit','\x27\x20AND\x20task_time\x20LIKE\x20\x27','%\x27)','join','2812929aGycLF','includes','../../myConfig/config','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','YYYY-MM-DD\x20HH:mm:ss','533016TpmCLt','ReadFolderFail','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','getI18n','60Uzftef','cpSync','better-sqlite3','split','REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)','ERROR','status','then','readdirSync',',end_time=\x27','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','targetFolderNotExist','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20','abs','format',',exclude_count=','get','basename','select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id=','3550STgKHy','exclude_list','\x27,\x20\x27waiting\x27,\x27','W_OK','count','39908JIdBpk','title','existsSync','getTime','rmSync','2437380hrEYmg','status=\x27running\x27','NasCabBackupWorker','dbOther','getHours','7074EEBYAi','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27','66LbNdPX','5663040jkHxHm','length','constants','stringify','\x27\x20or\x20status!=\x27done\x27)','isFile','fileCopyFail','UPDATE\x20backup_task_record\x20SET\x20','target_path','exec','map','send','R_OK',',files_count=','journal_mode\x20=\x20WAL',',copy_count=','source_list','getMinutes','noWritePermission','16OiZMZF','prepare','parse','pragma','getDate','\x5c$1','path','test','substring',',total_size=','close','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27','rmdirSync','size','getFullYear','copy_size=','isDirectory',',status=\x27done\x27,fail_count=','all'];_0x5202=function(){return _0x535475;};return _0x5202();}function getYmd(_0x4d6c95){const _0x228e9e=_0xc25678;var _0x451224=_0x4d6c95[_0x228e9e(0x102)](),_0x569558=_0x4d6c95['getMonth']()+0x1,_0x498084=_0x4d6c95[_0x228e9e(0xf8)]();return _0x451224+'-'+add0(_0x569558)+'-'+add0(_0x498084);}function runBackupCheck(){setInterval(()=>{const _0x3768d5=_0x799f;let _0x57bce6=new Date(),_0x371191=_0x57bce6['getDay'](),_0x233ac8=_0x57bce6[_0x3768d5(0xf8)](),_0x46ffab=add0(_0x57bce6[_0x3768d5(0xdc)]()),_0x4ad6b3=add0(_0x57bce6[_0x3768d5(0xf2)]()),_0xfb1917=getYmd(_0x57bce6),_0x4fed39=_0x3768d5(0x124)+_0xfb1917+_0x3768d5(0x10e)+_0x46ffab+':'+_0x4ad6b3+_0x3768d5(0x10f);addTask(_0x4fed39);let _0x284291='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x46ffab+':'+_0x4ad6b3+_0x3768d5(0x10f);addTask(_0x284291);let _0xb05f1f=_0x3768d5(0xff)+_0x371191+_0x3768d5(0x10e)+_0x46ffab+':'+_0x4ad6b3+_0x3768d5(0x10f);addTask(_0xb05f1f);let _0xf65799=_0x3768d5(0xdf)+_0x233ac8+_0x3768d5(0x10e)+_0x46ffab+':'+_0x4ad6b3+_0x3768d5(0x10f);addTask(_0xf65799);},0x3a98);}runBackupCheck(),process['on'](_0xc25678(0x10d),(_0x250c4b,_0x4c6a9f)=>{const _0x292f81=_0xc25678;process[_0x292f81(0xec)]({'type':_0x292f81(0xfe)});});