const _0x92eaa0=_0x17b3;(function(_0x599094,_0x5d6e0c){const _0x2798d7=_0x17b3,_0x45a305=_0x599094();while(!![]){try{const _0x47bab8=-parseInt(_0x2798d7(0x121))/0x1*(-parseInt(_0x2798d7(0xf8))/0x2)+parseInt(_0x2798d7(0xd5))/0x3*(parseInt(_0x2798d7(0x125))/0x4)+-parseInt(_0x2798d7(0x11b))/0x5+-parseInt(_0x2798d7(0x106))/0x6*(parseInt(_0x2798d7(0x112))/0x7)+-parseInt(_0x2798d7(0xf5))/0x8+parseInt(_0x2798d7(0xfc))/0x9+-parseInt(_0x2798d7(0x100))/0xa*(-parseInt(_0x2798d7(0xe1))/0xb);if(_0x47bab8===_0x5d6e0c)break;else _0x45a305['push'](_0x45a305['shift']());}catch(_0x46b4ac){_0x45a305['push'](_0x45a305['shift']());}}}(_0x2933,0x3492d));function _0x2933(){const _0xdd6d70=['targetFolderNotExist','exit','length','join','basename','exclude_list','existsSync','fileCopyFail',',files_count=','cpSync','parse','%\x27)',',total_size=','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','\x5c$1','count','run','REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)','includes','434240gRuroK','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27',',status=\x27done\x27,fail_count=','733780OaluwZ','all','status','W_OK','220482FtHMQq','YYYY-MM-DD\x20HH:mm:ss','getDate','journal_mode\x20=\x20WAL','7570zvHLdD','moment','constants','prepare','readdirSync','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','206436TIDazh','format',',exclude_count=','ERROR','send','task_id','\x27\x20or\x20status!=\x27done\x27)','folderNotExist','noWritePermission','accessSync','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27','\x27,\x20\x27waiting\x27,\x27','77BxXnnU','getI18n','running','getDay','test','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','getMonth','status=\x27running\x27','substring','354340TnQZHq','rmSync','stringify','\x20ERROR:','isFile','path','1YJSiCt','isDirectory','size','getHours','4ttvBxu','select\x20status\x20from\x20backup_task_record\x20where\x20id=','getTime','source_list','select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id=','R_OK','\x27\x20AND\x20task_time\x20LIKE\x20\x27','get','ReadFolderFail','\x20WHERE\x20id=','copy_size=','getMinutes','399054hDlEON','replace','dbOther','statSync','exec','pragma','target_path','abs','title','mtimeMs','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','../../myConfig/config','2827VfAslq'];_0x2933=function(){return _0xdd6d70;};return _0x2933();}const Database=require('better-sqlite3'),config=require(_0x92eaa0(0xe0));let dbOther=new Database(config[_0x92eaa0(0xd7)],{});dbOther[_0x92eaa0(0xda)](_0x92eaa0(0xff));let moment=require(_0x92eaa0(0x101)),path=require(_0x92eaa0(0x120)),fs=require('fs'),i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x92eaa0(0x113)](dbOther);process[_0x92eaa0(0xdd)]='NasCabBackupWorker';let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x2ab8e5,_0x4d1c0b,_0x126f78,_0x44bc4d){const _0xe07c95=_0x92eaa0;try{let _0x45b0e1=dbOther[_0xe07c95(0x103)](_0xe07c95(0x126)+_0x4d1c0b)[_0xe07c95(0x12c)]();if(_0x45b0e1[_0xe07c95(0xfa)]!=_0xe07c95(0x114))return paused=!![],![];let _0xb75343=fs[_0xe07c95(0xd8)](_0x126f78);filesCount+=0x1,totalSize+=_0xb75343[_0xe07c95(0x123)];let _0xeab640=!![];if(!fs[_0xe07c95(0xe8)](_0x44bc4d))fs[_0xe07c95(0xeb)](_0x126f78,_0x44bc4d,{'preserveTimestamps':!![]}),copySize+=_0xb75343[_0xe07c95(0x123)],copyFileCount+=0x1;else{let _0x52474f=fs[_0xe07c95(0xd8)](_0x44bc4d);_0xb75343[_0xe07c95(0x123)]==_0x52474f['size']&&Math[_0xe07c95(0xdc)](_0xb75343[_0xe07c95(0xde)]-_0x52474f[_0xe07c95(0xde)])<=0x3e8?_0xeab640=![]:(fs['cpSync'](_0x126f78,_0x44bc4d,{'preserveTimestamps':!![]}),copySize+=_0xb75343[_0xe07c95(0x123)],copyFileCount+=0x1);}return _0xeab640&&updateTaskRecord(_0x4d1c0b,_0xe07c95(0x12f)+copySize+',copy_count='+copyFileCount),!![];}catch(_0x1247a5){return addTaskMsg(_0x2ab8e5,_0x4d1c0b,_0xe07c95(0x109),_0x126f78+':'+i18n['__']('fileCopyFail')+_0xe07c95(0x11e)+JSON[_0xe07c95(0x11d)](_0x1247a5)),!![];}}function matchRuleShort(_0x1541ea,_0x594c5c){const _0x4a6b23=_0x92eaa0;var _0x27dfbd=_0xdf2a48=>_0xdf2a48[_0x4a6b23(0xd6)](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x4a6b23(0xf0));return new RegExp('^'+_0x594c5c['split']('*')['map'](_0x27dfbd)[_0x4a6b23(0xe5)]('.*')+'$')[_0x4a6b23(0x116)](_0x1541ea);}function _0x17b3(_0x4d5ae0,_0x3f7cd6){const _0x293392=_0x2933();return _0x17b3=function(_0x17b377,_0x50de1a){_0x17b377=_0x17b377-0xd5;let _0x2d1ec3=_0x293392[_0x17b377];return _0x2d1ec3;},_0x17b3(_0x4d5ae0,_0x3f7cd6);}function copyFolder(_0x2e649a,_0x1be756,_0x20ad5f,_0x2ccc99,_0x58f4f0){const _0xf55205=_0x92eaa0;let _0x260db5=_0x2e649a['id'],_0x46f099=checkFolderPower(_0x2ccc99,!![]);if(!_0x46f099)addTaskMsg(_0x260db5,_0x1be756,_0xf55205(0x109),i18n['__'](_0xf55205(0x10e))+':'+_0x2ccc99);else try{let _0xe57c4e=fs[_0xf55205(0x104)](_0x2ccc99);for(let _0x1fb80e=0x0;_0x1fb80e<_0xe57c4e['length'];_0x1fb80e++){let _0x29621a=_0xe57c4e[_0x1fb80e];var _0x25c7b6=path[_0xf55205(0xe5)](_0x2ccc99,_0x29621a);let _0x2ae7fb=fs['statSync'](_0x25c7b6);var _0x52f2e7=_0x2ae7fb[_0xf55205(0x11f)](),_0x34d1b6=_0x2ae7fb['isDirectory']();if(_0x52f2e7){if(excludeList['includes'](_0x29621a))continue;if(_0x2e649a[_0xf55205(0xe7)]&&_0x2e649a[_0xf55205(0xe7)][_0xf55205(0xe4)]>0x0){let _0x394979=JSON['parse'](_0x2e649a[_0xf55205(0xe7)]),_0x3ddab0=!![];for(let _0x1bb953 in _0x394979){if(_0x394979[_0x1bb953][_0xf55205(0xf4)]('*')){if(matchRuleShort(_0x29621a,_0x394979[_0x1bb953])){_0x3ddab0=![];break;}}else{if(_0x394979[_0x1bb953]==_0x29621a){_0x3ddab0=![];break;}}}if(!_0x3ddab0){excludeCount+=0x1;continue;}}let _0x183f68=path['join'](_0x58f4f0,path[_0xf55205(0xe6)](_0x20ad5f),_0x25c7b6[_0xf55205(0x11a)](_0x20ad5f[_0xf55205(0xe4)])),_0x97f6ae=copyFile(_0x260db5,_0x1be756,_0x25c7b6,_0x183f68);if(_0x97f6ae===![])return![];}else _0x34d1b6&&copyFolder(_0x2e649a,_0x1be756,_0x20ad5f,_0x25c7b6,_0x58f4f0);}}catch(_0x20b76e){addTaskMsg(_0x260db5,_0x1be756,_0xf55205(0x109),i18n['__']('ReadFolderFail')+':'+_0x2ccc99);}}function reverseCheck(_0x404f11,_0x41a019,_0x303414,_0x3664e4,_0x4304c2){const _0x1db584=_0x92eaa0;try{if(!fs[_0x1db584(0xe8)](_0x4304c2))return;let _0x3ba444=fs[_0x1db584(0x104)](_0x4304c2);for(let _0x181a15=0x0;_0x181a15<_0x3ba444['length'];_0x181a15++){let _0x35cf74=_0x3ba444[_0x181a15];var _0x2b4696=path[_0x1db584(0xe5)](_0x4304c2,_0x35cf74);let _0x389a6e=fs[_0x1db584(0xd8)](_0x2b4696);var _0x381f84=_0x389a6e[_0x1db584(0x11f)](),_0x19a0ba=_0x389a6e[_0x1db584(0x122)]();let _0x43787e=path[_0x1db584(0xe5)](_0x3664e4,_0x2b4696['substring'](_0x303414[_0x1db584(0xe4)]));if(_0x381f84)!fs[_0x1db584(0xe8)](_0x43787e)&&fs[_0x1db584(0x11c)](_0x2b4696,{'force':!![],'maxRetries':0xa});else _0x19a0ba&&(!fs[_0x1db584(0xe8)](_0x43787e)?fs['rmdirSync'](_0x2b4696,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x404f11,_0x41a019,_0x303414,_0x3664e4,_0x2b4696));}}catch(_0xe97785){addTaskMsg(_0x404f11,_0x41a019,_0x1db584(0x109),i18n['__'](_0x1db584(0x12d))+':'+_0x3664e4);}}function updateTaskRecord(_0x4443b1,_0x219a3d){const _0x1a7a32=_0x92eaa0;let _0x3630e0='UPDATE\x20backup_task_record\x20SET\x20';_0x3630e0+=_0x219a3d,_0x3630e0+=_0x1a7a32(0x12e)+_0x4443b1,dbOther[_0x1a7a32(0xd9)](_0x3630e0);}function setTaskOver(_0x33e1bf){const _0x222a22=_0x92eaa0;let _0x375e35=dbOther['prepare'](_0x222a22(0x129)+_0x33e1bf['id'])[_0x222a22(0x12c)](),_0x1fb79a=moment()[_0x222a22(0x107)](_0x222a22(0xfd));updateTaskRecord(_0x33e1bf['id'],_0x222a22(0x12f)+copySize+',copy_count='+copyFileCount+_0x222a22(0x108)+excludeCount+_0x222a22(0xf7)+_0x375e35[_0x222a22(0xf1)]+_0x222a22(0xea)+filesCount+_0x222a22(0xee)+totalSize+',end_time=\x27'+_0x1fb79a+'\x27');}function addTaskMsg(_0x282a2f,_0x5d3d6b,_0x305d09,_0x126040){const _0x588776=_0x92eaa0,_0x59a23b=_0x588776(0xf3);return dbOther[_0x588776(0x103)](_0x59a23b)[_0x588776(0xf2)](''+_0x282a2f,''+_0x5d3d6b,''+_0x305d09,''+_0x126040);}function checkFolderPower(_0x2c84db,_0x3e2c2f){const _0x2870fc=_0x92eaa0;try{return _0x3e2c2f?fs[_0x2870fc(0x10f)](_0x2c84db,fs[_0x2870fc(0x102)][_0x2870fc(0x12a)]):fs['accessSync'](_0x2c84db,fs[_0x2870fc(0x102)][_0x2870fc(0x12a)]|fs[_0x2870fc(0x102)][_0x2870fc(0xfb)]),!![];}catch(_0xbcd55a){return![];}}function exeTask(_0x47a4ff){const _0x1a4cb8=_0x92eaa0;let _0x3b8f2f='SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20',_0x2b0acd=dbOther[_0x1a4cb8(0x103)](_0x3b8f2f)['get']();if(_0x2b0acd){let _0x12a0f6='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20'+_0x2b0acd[_0x1a4cb8(0x10b)],_0x55f1a4=dbOther[_0x1a4cb8(0x103)](_0x12a0f6)[_0x1a4cb8(0x12c)]();if(!fs[_0x1a4cb8(0xe8)](_0x55f1a4[_0x1a4cb8(0xdb)]))return addTaskMsg(_0x55f1a4['id'],_0x2b0acd['id'],'ERROR',i18n['__'](_0x1a4cb8(0xe2))+':'+_0x55f1a4[_0x1a4cb8(0xdb)]),setTaskOver(_0x2b0acd),_0x47a4ff();let _0x37e436=checkFolderPower(_0x55f1a4['target_path']);if(!_0x37e436)return addTaskMsg(_0x55f1a4['id'],_0x2b0acd['id'],'ERROR',i18n['__'](_0x1a4cb8(0x10e))+':'+_0x55f1a4['target_path']),setTaskOver(_0x2b0acd),_0x47a4ff();updateTaskRecord(_0x2b0acd['id'],_0x1a4cb8(0x119));let _0x30a0bc=JSON[_0x1a4cb8(0xec)](_0x55f1a4[_0x1a4cb8(0x128)]);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0x10002b in _0x30a0bc){try{if(fs[_0x1a4cb8(0xe8)](_0x30a0bc[_0x10002b])){copyFolder(_0x55f1a4,_0x2b0acd['id'],_0x30a0bc[_0x10002b],_0x30a0bc[_0x10002b],_0x55f1a4[_0x1a4cb8(0xdb)]);if(!paused){let _0x4fd762=path[_0x1a4cb8(0xe5)](_0x55f1a4[_0x1a4cb8(0xdb)],path[_0x1a4cb8(0xe6)](_0x30a0bc[_0x10002b]));reverseCheck(_0x55f1a4['id'],_0x2b0acd['id'],_0x4fd762,_0x30a0bc[_0x10002b],_0x4fd762);}}else addTaskMsg(_0x55f1a4['id'],_0x2b0acd['id'],_0x1a4cb8(0x109),i18n['__'](_0x1a4cb8(0x10d))+':'+_0x30a0bc[_0x10002b]);}catch(_0x3368a8){addTaskMsg(_0x55f1a4['id'],_0x2b0acd['id'],'ERROR',i18n['__'](_0x1a4cb8(0xe9))+':'+_0x30a0bc[_0x10002b]+':'+JSON[_0x1a4cb8(0x11d)](_0x3368a8));}}!paused&&setTaskOver(_0x2b0acd),_0x47a4ff();}else setTimeout(()=>{_0x47a4ff();},0x2710);}function runInfinit(){return new Promise(_0x5de0cc=>{exeTask(_0x5de0cc);});}async function runBacupExe(){runInfinit()['then'](()=>{runBacupExe();});}dbOther['exec'](_0x92eaa0(0xdf)),runBacupExe();function addTask(_0x1afe92){const _0x53bc61=_0x92eaa0;let _0x39005e=dbOther[_0x53bc61(0x103)](_0x1afe92)[_0x53bc61(0xf9)]();if(_0x39005e[_0x53bc61(0xe4)]>0x0)for(let _0x5e0bcc=0x0;_0x5e0bcc<_0x39005e[_0x53bc61(0xe4)];_0x5e0bcc++){let _0x376737=_0x39005e[_0x5e0bcc],_0x35ba27=moment(new Date()[_0x53bc61(0x127)]()-0xea60)[_0x53bc61(0x107)](_0x53bc61(0xfd)),_0x3e85c7=_0x53bc61(0x105)+_0x376737['id']+'\x20and\x20(start_time>=\x27'+_0x35ba27+_0x53bc61(0x10c),_0x4facf5=dbOther[_0x53bc61(0x103)](_0x3e85c7)['get']();if(_0x4facf5[_0x53bc61(0xf1)]<0x1){let _0x5ee1bb=moment()[_0x53bc61(0x107)]('YYYY-MM-DD\x20HH:mm:ss');const _0x10b519=_0x53bc61(0x117)+_0x376737['id']+_0x53bc61(0x111)+_0x5ee1bb+'\x27)';return dbOther['exec'](_0x10b519);}else{}}}function add0(_0x3b902b){return _0x3b902b<0xa?'0'+_0x3b902b:_0x3b902b;}function getYmd(_0x497cd0){const _0x3df47a=_0x92eaa0;var _0x37f944=_0x497cd0['getFullYear'](),_0x38e4f9=_0x497cd0[_0x3df47a(0x118)]()+0x1,_0x1b9e2e=_0x497cd0[_0x3df47a(0xfe)]();return _0x37f944+'-'+add0(_0x38e4f9)+'-'+add0(_0x1b9e2e);}function runBackupCheck(){setInterval(()=>{const _0x204fae=_0x17b3;let _0x45587a=new Date(),_0x5c20e0=_0x45587a[_0x204fae(0x115)](),_0x3f74fb=_0x45587a[_0x204fae(0xfe)](),_0x4f3219=add0(_0x45587a[_0x204fae(0x124)]()),_0x2e6bce=add0(_0x45587a[_0x204fae(0x130)]()),_0x180694=getYmd(_0x45587a),_0x1536bb=_0x204fae(0xef)+_0x180694+_0x204fae(0x12b)+_0x4f3219+':'+_0x2e6bce+_0x204fae(0xed);addTask(_0x1536bb);let _0x15c009=_0x204fae(0x110)+_0x4f3219+':'+_0x2e6bce+_0x204fae(0xed);addTask(_0x15c009);let _0x1a41aa='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27'+_0x5c20e0+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x4f3219+':'+_0x2e6bce+_0x204fae(0xed);addTask(_0x1a41aa);let _0x1f490c=_0x204fae(0xf6)+_0x3f74fb+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x4f3219+':'+_0x2e6bce+_0x204fae(0xed);addTask(_0x1f490c);},0x3a98);}runBackupCheck(),process['on'](_0x92eaa0(0xe3),(_0x297a9f,_0x5d7d5b)=>{const _0x523ee9=_0x92eaa0;process[_0x523ee9(0x10a)]({'type':'close'});});