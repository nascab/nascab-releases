const _0x327dc4=_0x28ff;(function(_0xcf6d03,_0x56b39e){const _0xb6c09e=_0x28ff,_0x5153e6=_0xcf6d03();while(!![]){try{const _0x1db2ef=parseInt(_0xb6c09e(0x17d))/0x1*(parseInt(_0xb6c09e(0x14e))/0x2)+-parseInt(_0xb6c09e(0x15c))/0x3+parseInt(_0xb6c09e(0x17f))/0x4+-parseInt(_0xb6c09e(0x178))/0x5*(-parseInt(_0xb6c09e(0x16a))/0x6)+-parseInt(_0xb6c09e(0x160))/0x7+-parseInt(_0xb6c09e(0x177))/0x8*(-parseInt(_0xb6c09e(0x139))/0x9)+-parseInt(_0xb6c09e(0x179))/0xa;if(_0x1db2ef===_0x56b39e)break;else _0x5153e6['push'](_0x5153e6['shift']());}catch(_0x7aec9a){_0x5153e6['push'](_0x5153e6['shift']());}}}(_0x10ca,0x61fe4));const Database=require(_0x327dc4(0x138)),config=require('../../myConfig/config');function _0x28ff(_0x185920,_0x39b367){const _0x10ca25=_0x10ca();return _0x28ff=function(_0x28ffb7,_0x268c43){_0x28ffb7=_0x28ffb7-0x132;let _0x3535a7=_0x10ca25[_0x28ffb7];return _0x3535a7;},_0x28ff(_0x185920,_0x39b367);}let dbOther=new Database(config[_0x327dc4(0x151)],{});dbOther[_0x327dc4(0x161)]('journal_mode\x20=\x20WAL');let moment=require(_0x327dc4(0x176)),path=require('path'),fs=require('fs'),i18nUtil=require(_0x327dc4(0x144)),i18n=i18nUtil[_0x327dc4(0x148)](dbOther);process[_0x327dc4(0x175)]=_0x327dc4(0x133);let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x365eec,_0x29447a,_0x381f57,_0x38ff89){const _0x4ba8df=_0x327dc4;try{let _0x10234f=dbOther[_0x4ba8df(0x15a)](_0x4ba8df(0x134)+_0x29447a)[_0x4ba8df(0x14c)]();if(_0x10234f[_0x4ba8df(0x16c)]!='running')return paused=!![],![];let _0x210f53=fs[_0x4ba8df(0x13c)](_0x381f57);filesCount+=0x1,totalSize+=_0x210f53[_0x4ba8df(0x13e)];let _0xfac097=!![];if(!fs['existsSync'](_0x38ff89))fs[_0x4ba8df(0x154)](_0x381f57,_0x38ff89,{'preserveTimestamps':!![]}),copySize+=_0x210f53[_0x4ba8df(0x13e)],copyFileCount+=0x1;else{let _0xa1a826=fs[_0x4ba8df(0x13c)](_0x38ff89);_0x210f53[_0x4ba8df(0x13e)]==_0xa1a826['size']&&Math['abs'](_0x210f53['mtimeMs']-_0xa1a826[_0x4ba8df(0x146)])<=0x3e8?_0xfac097=![]:(fs[_0x4ba8df(0x154)](_0x381f57,_0x38ff89,{'preserveTimestamps':!![]}),copySize+=_0x210f53['size'],copyFileCount+=0x1);}return _0xfac097&&updateTaskRecord(_0x29447a,'copy_size='+copySize+_0x4ba8df(0x188)+copyFileCount),!![];}catch(_0x3dd3b1){return addTaskMsg(_0x365eec,_0x29447a,_0x4ba8df(0x169),_0x381f57+':'+i18n['__']('fileCopyFail')+_0x4ba8df(0x15f)+JSON['stringify'](_0x3dd3b1)),!![];}}function matchRuleShort(_0x156816,_0x32fec1){const _0x1597ae=_0x327dc4;var _0x4f279f=_0x467618=>_0x467618[_0x1597ae(0x14f)](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x1597ae(0x145));return new RegExp('^'+_0x32fec1[_0x1597ae(0x14d)]('*')[_0x1597ae(0x184)](_0x4f279f)[_0x1597ae(0x158)]('.*')+'$')[_0x1597ae(0x13d)](_0x156816);}function copyFolder(_0x30fef5,_0x384388,_0x5d7581,_0x2c0703,_0x5bbf3a){const _0x2ae5bf=_0x327dc4;let _0x346435=_0x30fef5['id'],_0x296036=checkFolderPower(_0x2c0703,!![]);if(!_0x296036)addTaskMsg(_0x346435,_0x384388,'ERROR',i18n['__']('noWritePermission')+':'+_0x2c0703);else try{let _0x59d6f6=fs['readdirSync'](_0x2c0703);for(let _0x11f3e0=0x0;_0x11f3e0<_0x59d6f6['length'];_0x11f3e0++){let _0x53e18b=_0x59d6f6[_0x11f3e0];var _0x5d74d4=path['join'](_0x2c0703,_0x53e18b);let _0x1aee15=fs[_0x2ae5bf(0x13c)](_0x5d74d4);var _0x5f2326=_0x1aee15['isFile'](),_0x40dde2=_0x1aee15[_0x2ae5bf(0x13b)]();if(_0x5f2326){if(excludeList['includes'](_0x53e18b))continue;if(_0x30fef5['exclude_list']&&_0x30fef5['exclude_list'][_0x2ae5bf(0x173)]>0x0){let _0x1d45b1=JSON[_0x2ae5bf(0x168)](_0x30fef5[_0x2ae5bf(0x152)]),_0x513cbf=!![];for(let _0x4645cb in _0x1d45b1){if(_0x1d45b1[_0x4645cb][_0x2ae5bf(0x13f)]('*')){if(matchRuleShort(_0x53e18b,_0x1d45b1[_0x4645cb])){_0x513cbf=![];break;}}else{if(_0x1d45b1[_0x4645cb]==_0x53e18b){_0x513cbf=![];break;}}}if(!_0x513cbf){excludeCount+=0x1;continue;}}let _0x19e0b2=path[_0x2ae5bf(0x158)](_0x5bbf3a,path[_0x2ae5bf(0x155)](_0x5d7581),_0x5d74d4[_0x2ae5bf(0x17a)](_0x5d7581[_0x2ae5bf(0x173)])),_0x4569b5=copyFile(_0x346435,_0x384388,_0x5d74d4,_0x19e0b2);if(_0x4569b5===![])return![];}else _0x40dde2&&copyFolder(_0x30fef5,_0x384388,_0x5d7581,_0x5d74d4,_0x5bbf3a);}}catch(_0x555790){addTaskMsg(_0x346435,_0x384388,'ERROR',i18n['__'](_0x2ae5bf(0x174))+':'+_0x2c0703);}}function reverseCheck(_0x111731,_0x2334a7,_0x1d1044,_0x10f96f,_0x4e5f95){const _0x5d9535=_0x327dc4;try{if(!fs[_0x5d9535(0x149)](_0x4e5f95))return;let _0x39636e=fs[_0x5d9535(0x157)](_0x4e5f95);for(let _0x96bffd=0x0;_0x96bffd<_0x39636e[_0x5d9535(0x173)];_0x96bffd++){let _0x6d6fb6=_0x39636e[_0x96bffd];var _0x38d147=path[_0x5d9535(0x158)](_0x4e5f95,_0x6d6fb6);let _0x31aeb0=fs[_0x5d9535(0x13c)](_0x38d147);var _0x1d8f90=_0x31aeb0[_0x5d9535(0x172)](),_0x3df5c6=_0x31aeb0[_0x5d9535(0x13b)]();let _0x4ae15a=path[_0x5d9535(0x158)](_0x10f96f,_0x38d147[_0x5d9535(0x17a)](_0x1d1044[_0x5d9535(0x173)]));if(_0x1d8f90)!fs['existsSync'](_0x4ae15a)&&fs[_0x5d9535(0x166)](_0x38d147,{'force':!![],'maxRetries':0xa});else _0x3df5c6&&(!fs[_0x5d9535(0x149)](_0x4ae15a)?fs[_0x5d9535(0x143)](_0x38d147,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x111731,_0x2334a7,_0x1d1044,_0x10f96f,_0x38d147));}}catch(_0x45c88e){addTaskMsg(_0x111731,_0x2334a7,_0x5d9535(0x169),i18n['__'](_0x5d9535(0x174))+':'+_0x10f96f);}}function _0x10ca(){const _0x12296c=['copy_size=','noWritePermission','map','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27',',files_count=','YYYY-MM-DD\x20HH:mm:ss',',copy_count=','select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id=','status=\x27running\x27','\x27\x20AND\x20task_time\x20LIKE\x20\x27','all','\x27\x20or\x20status!=\x27done\x27)','NasCabBackupWorker','select\x20status\x20from\x20backup_task_record\x20where\x20id=','%\x27)','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27','exec','better-sqlite3','1554669PVpKGi','\x20WHERE\x20id=','isDirectory','statSync','test','size','includes','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','task_id','exit','rmdirSync','../../utils/i18nUtil','\x5c$1','mtimeMs','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','getI18n','existsSync',',status=\x27done\x27,fail_count=','\x27,\x20\x27waiting\x27,\x27','get','split','546862EuGEya','replace',',total_size=','dbOther','exclude_list','REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)','cpSync','basename','R_OK','readdirSync','join','run','prepare','constants','1480926acLxGz','UPDATE\x20backup_task_record\x20SET\x20','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','\x20ERROR:','137928PWcHYz','pragma','W_OK',',end_time=\x27','getHours','format','rmSync','folderNotExist','parse','ERROR','6uQwBoz','getDate','status','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','target_path','targetFolderNotExist','getFullYear','count','isFile','length','ReadFolderFail','title','moment','16gqvKZp','2668720PgedQZ','9187700XcWHdU','substring','close','getDay','2KsDZRK','then','1629632NZfbvk','accessSync','getMinutes'];_0x10ca=function(){return _0x12296c;};return _0x10ca();}function updateTaskRecord(_0x52d758,_0xf5f567){const _0x30c136=_0x327dc4;let _0x2f19c7=_0x30c136(0x15d);_0x2f19c7+=_0xf5f567,_0x2f19c7+=_0x30c136(0x13a)+_0x52d758,dbOther[_0x30c136(0x137)](_0x2f19c7);}function setTaskOver(_0x53a444){const _0x593946=_0x327dc4;let _0x340e5e=dbOther[_0x593946(0x15a)](_0x593946(0x189)+_0x53a444['id'])[_0x593946(0x14c)](),_0x5c7d3d=moment()[_0x593946(0x165)]('YYYY-MM-DD\x20HH:mm:ss');updateTaskRecord(_0x53a444['id'],_0x593946(0x182)+copySize+_0x593946(0x188)+copyFileCount+',exclude_count='+excludeCount+_0x593946(0x14a)+_0x340e5e[_0x593946(0x171)]+_0x593946(0x186)+filesCount+_0x593946(0x150)+totalSize+_0x593946(0x163)+_0x5c7d3d+'\x27');}function addTaskMsg(_0x2605b7,_0x41cc0f,_0x2672fa,_0xbfe72c){const _0x1cd6a9=_0x327dc4,_0xc040d3=_0x1cd6a9(0x153);return dbOther[_0x1cd6a9(0x15a)](_0xc040d3)[_0x1cd6a9(0x159)](''+_0x2605b7,''+_0x41cc0f,''+_0x2672fa,''+_0xbfe72c);}function checkFolderPower(_0x130de5,_0x26e835){const _0x1a3313=_0x327dc4;try{return _0x26e835?fs[_0x1a3313(0x180)](_0x130de5,fs[_0x1a3313(0x15b)][_0x1a3313(0x156)]):fs['accessSync'](_0x130de5,fs[_0x1a3313(0x15b)]['R_OK']|fs[_0x1a3313(0x15b)][_0x1a3313(0x162)]),!![];}catch(_0x482979){return![];}}function exeTask(_0x33a998){const _0x939377=_0x327dc4;let _0x32b282=_0x939377(0x16d),_0x5dd7ea=dbOther['prepare'](_0x32b282)[_0x939377(0x14c)]();if(_0x5dd7ea){let _0x29eb64='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20'+_0x5dd7ea[_0x939377(0x141)],_0x58d3c8=dbOther['prepare'](_0x29eb64)['get']();if(!fs['existsSync'](_0x58d3c8[_0x939377(0x16e)]))return addTaskMsg(_0x58d3c8['id'],_0x5dd7ea['id'],_0x939377(0x169),i18n['__'](_0x939377(0x16f))+':'+_0x58d3c8[_0x939377(0x16e)]),setTaskOver(_0x5dd7ea),_0x33a998();let _0x192e0f=checkFolderPower(_0x58d3c8[_0x939377(0x16e)]);if(!_0x192e0f)return addTaskMsg(_0x58d3c8['id'],_0x5dd7ea['id'],_0x939377(0x169),i18n['__'](_0x939377(0x183))+':'+_0x58d3c8[_0x939377(0x16e)]),setTaskOver(_0x5dd7ea),_0x33a998();updateTaskRecord(_0x5dd7ea['id'],_0x939377(0x18a));let _0x334aca=JSON[_0x939377(0x168)](_0x58d3c8['source_list']);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0x7aa67f in _0x334aca){try{if(fs['existsSync'](_0x334aca[_0x7aa67f])){copyFolder(_0x58d3c8,_0x5dd7ea['id'],_0x334aca[_0x7aa67f],_0x334aca[_0x7aa67f],_0x58d3c8[_0x939377(0x16e)]);if(!paused){let _0x1f65bc=path[_0x939377(0x158)](_0x58d3c8[_0x939377(0x16e)],path[_0x939377(0x155)](_0x334aca[_0x7aa67f]));reverseCheck(_0x58d3c8['id'],_0x5dd7ea['id'],_0x1f65bc,_0x334aca[_0x7aa67f],_0x1f65bc);}}else addTaskMsg(_0x58d3c8['id'],_0x5dd7ea['id'],'ERROR',i18n['__'](_0x939377(0x167))+':'+_0x334aca[_0x7aa67f]);}catch(_0x5ebc37){addTaskMsg(_0x58d3c8['id'],_0x5dd7ea['id'],_0x939377(0x169),i18n['__']('fileCopyFail')+':'+_0x334aca[_0x7aa67f]+':'+JSON['stringify'](_0x5ebc37));}}!paused&&setTaskOver(_0x5dd7ea),_0x33a998();}else setTimeout(()=>{_0x33a998();},0x2710);}function runInfinit(){return new Promise(_0x375c95=>{exeTask(_0x375c95);});}async function runBacupExe(){const _0x43bb96=_0x327dc4;runInfinit()[_0x43bb96(0x17e)](()=>{runBacupExe();});}dbOther['exec'](_0x327dc4(0x140)),runBacupExe();function addTask(_0x2281cc){const _0x145e1a=_0x327dc4;let _0x288d99=dbOther[_0x145e1a(0x15a)](_0x2281cc)[_0x145e1a(0x18c)]();if(_0x288d99[_0x145e1a(0x173)]>0x0)for(let _0x10dba0=0x0;_0x10dba0<_0x288d99['length'];_0x10dba0++){let _0x58b1b1=_0x288d99[_0x10dba0],_0x1adf93=moment(new Date()['getTime']()-0xea60)[_0x145e1a(0x165)](_0x145e1a(0x187)),_0x2c07f4=_0x145e1a(0x147)+_0x58b1b1['id']+'\x20and\x20(start_time>=\x27'+_0x1adf93+_0x145e1a(0x132),_0x11b51f=dbOther['prepare'](_0x2c07f4)['get']();if(_0x11b51f['count']<0x1){let _0x2838c9=moment()[_0x145e1a(0x165)]('YYYY-MM-DD\x20HH:mm:ss');const _0x5eadbc='REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27'+_0x58b1b1['id']+_0x145e1a(0x14b)+_0x2838c9+'\x27)';return dbOther[_0x145e1a(0x137)](_0x5eadbc);}else{}}}function add0(_0x1fc691){return _0x1fc691<0xa?'0'+_0x1fc691:_0x1fc691;}function getYmd(_0x4268b4){const _0xd2487e=_0x327dc4;var _0x50597f=_0x4268b4[_0xd2487e(0x170)](),_0x110468=_0x4268b4['getMonth']()+0x1,_0x7fbea0=_0x4268b4[_0xd2487e(0x16b)]();return _0x50597f+'-'+add0(_0x110468)+'-'+add0(_0x7fbea0);}function runBackupCheck(){setInterval(()=>{const _0x502741=_0x28ff;let _0x5b2a41=new Date(),_0xda87a7=_0x5b2a41[_0x502741(0x17c)](),_0x141fab=_0x5b2a41[_0x502741(0x16b)](),_0x550def=add0(_0x5b2a41[_0x502741(0x164)]()),_0x547070=add0(_0x5b2a41[_0x502741(0x181)]()),_0x4bf15f=getYmd(_0x5b2a41),_0xf74e6b=_0x502741(0x15e)+_0x4bf15f+_0x502741(0x18b)+_0x550def+':'+_0x547070+_0x502741(0x135);addTask(_0xf74e6b);let _0x50983a=_0x502741(0x136)+_0x550def+':'+_0x547070+_0x502741(0x135);addTask(_0x50983a);let _0x599ccc=_0x502741(0x185)+_0xda87a7+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x550def+':'+_0x547070+_0x502741(0x135);addTask(_0x599ccc);let _0x3fcccf='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27'+_0x141fab+_0x502741(0x18b)+_0x550def+':'+_0x547070+_0x502741(0x135);addTask(_0x3fcccf);},0x3a98);}runBackupCheck(),process['on'](_0x327dc4(0x142),(_0xe651a,_0x539508)=>{const _0x455668=_0x327dc4;process['send']({'type':_0x455668(0x17b)});});