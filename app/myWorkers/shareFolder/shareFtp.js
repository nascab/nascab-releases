const _0x3fc6a7=_0x458a;function _0x142a(){const _0x4f6035=['dbOther','length','login','FTP','NasCabFtpWorker','isPortFree','../../db/dbFileShare','Restart\x20FTP','\x20server_type=\x27FTP\x27','1084689hIQdhL','then','error','better-sqlite3','FTP\x20Start\x20failed','Invalid\x20username\x20or\x20password','../../db/dbNoticeCenterTable','listen','closed','value','encryptString','type','../../myConfig/config','log','../../db/dbConfigTable','run','create','3309632SgYeXF','242732zURMtM','title','FTPServer','1312864GQJBpB','findByTitle','stringify','close','fileShareRestart','catch','7gKGnjs','pragma','FTPPort','47214rClQun','557608EIAHQH','userHasFtp','1695830KjWHzE','path'];_0x142a=function(){return _0x4f6035;};return _0x142a();}(function(_0x42af89,_0x31dc58){const _0x2e6851=_0x458a,_0x383ae6=_0x42af89();while(!![]){try{const _0x230eda=-parseInt(_0x2e6851(0x150))/0x1+-parseInt(_0x2e6851(0x15d))/0x2+parseInt(_0x2e6851(0x16a))/0x3+parseInt(_0x2e6851(0x153))/0x4+-parseInt(_0x2e6851(0x15f))/0x5+-parseInt(_0x2e6851(0x15c))/0x6*(-parseInt(_0x2e6851(0x159))/0x7)+parseInt(_0x2e6851(0x14f))/0x8;if(_0x230eda===_0x31dc58)break;else _0x383ae6['push'](_0x383ae6['shift']());}catch(_0x7bfb2c){_0x383ae6['push'](_0x383ae6['shift']());}}}(_0x142a,0x3d31a));const config=require(_0x3fc6a7(0x14a)),Database=require(_0x3fc6a7(0x141));let dbOther=new Database(config[_0x3fc6a7(0x161)],{});dbOther[_0x3fc6a7(0x15a)]('journal_mode\x20=\x20WAL');function _0x458a(_0x3a803d,_0x7cdec0){const _0x142a9d=_0x142a();return _0x458a=function(_0x458a39,_0x42a36a){_0x458a39=_0x458a39-0x140;let _0x25650c=_0x142a9d[_0x458a39];return _0x25650c;},_0x458a(_0x3a803d,_0x7cdec0);}const dbConfigTable=require(_0x3fc6a7(0x14c)),dbFileShare=require(_0x3fc6a7(0x167)),dbUserTable=require('../../db/dbUserTable'),FtpSrv=require('ftp-srv');process[_0x3fc6a7(0x151)]=_0x3fc6a7(0x165);let cryptoUtils=require('../../express-server/utils/cryptoUtils'),myFtpServer=null;const dbNoticeCenterTable=require(_0x3fc6a7(0x144));let netUtils=require('../../express-server/utils/netUtils');function saveMsg(_0x19f8fe,_0x5a0919,_0xac00ab){const _0x3d6b49=_0x3fc6a7;dbNoticeCenterTable[_0x3d6b49(0x14e)](dbOther,{'title':_0x19f8fe,'level':_0x5a0919,'content':_0xac00ab});}function ftpListenNew(_0x167d17){const _0x4556de=_0x3fc6a7;myFtpServer=new FtpSrv({'url':'ftp://0.0.0.0:'+_0x167d17});let _0xc8604f=dbFileShare['getAllByWhere'](dbOther,_0x4556de(0x169),[]);_0xc8604f&&_0xc8604f[_0x4556de(0x162)]>0x0?(myFtpServer['on'](_0x4556de(0x163),({connection:_0x4087c6,username:_0x453a80,password:_0x50d4c0},_0x58f3a0,_0x250286)=>{const _0xf4dfcf=_0x4556de;cryptoUtils[_0xf4dfcf(0x148)](config['passwordKey'],_0x50d4c0)[_0xf4dfcf(0x16b)](_0x37aaa3=>{const _0x20d1d8=_0xf4dfcf;let _0x446863=dbUserTable[_0x20d1d8(0x163)](dbOther,_0x453a80,_0x37aaa3);if(!_0x446863)return _0x250286(new errors['GeneralError'](_0x20d1d8(0x143),0x191));let _0xffa14e=dbFileShare[_0x20d1d8(0x15e)](dbOther,_0x446863['id'],_0x20d1d8(0x164));return _0xffa14e?_0x58f3a0({'root':_0xffa14e[_0x20d1d8(0x160)]}):_0x250286(0x191);})[_0xf4dfcf(0x158)](_0x2bfb18=>{return console['log']('error',_0x2bfb18),_0x250286(0x191);});}),myFtpServer[_0x4556de(0x145)]()[_0x4556de(0x16b)](()=>{const _0x2589ed=_0x4556de;console[_0x2589ed(0x14b)]('FTP\x20start\x20running\x20on\x20:'+_0x167d17),dbConfigTable['create'](dbOther,{'title':_0x2589ed(0x152),'value':JSON[_0x2589ed(0x155)]({'state':_0x2589ed(0x14d),'port':_0x167d17})});})[_0x4556de(0x158)](_0x33246c=>{const _0x14357c=_0x4556de;console['log'](_0x14357c(0x140),_0x33246c),_0x33246c['code']=='EADDRINUSE'?initFtpShare(_0x167d17+0x1):(dbConfigTable['create'](dbOther,{'title':'FTPServer','value':JSON[_0x14357c(0x155)]({'state':'stop','port':_0x167d17})}),saveMsg(_0x14357c(0x142),_0x14357c(0x140),_0x33246c['code']));})):dbConfigTable[_0x4556de(0x14e)](dbOther,{'title':'FTPServer','value':JSON['stringify']({'state':'stop','port':_0x167d17})});}async function initFtpShare(_0x1264c1){const _0x184c06=_0x3fc6a7;myFtpServer?(myFtpServer[_0x184c06(0x156)](),myFtpServer['on'](_0x184c06(0x146),({})=>{ftpListenNew(_0x1264c1);})):ftpListenNew(_0x1264c1);}let getFreePort=function(_0x7c9f17,_0x329426){const _0x1c717d=_0x3fc6a7;netUtils[_0x1c717d(0x166)](_0x7c9f17)[_0x1c717d(0x16b)](_0x222617=>{_0x222617?_0x329426(_0x7c9f17):(_0x7c9f17+=0x1,getFreePort(_0x7c9f17,_0x329426));});};function getFtpSetPort(_0x4966b9){const _0x379429=_0x3fc6a7;let _0x1e023a=config[_0x379429(0x15b)],_0x208760=_0x379429(0x15b),_0x4df3af=dbConfigTable[_0x379429(0x154)](dbOther,_0x208760);if(_0x4df3af){let _0x17a1a6=parseInt(_0x4df3af[_0x379429(0x147)]);if(_0x17a1a6<=0x0||_0x17a1a6>0xffff){}else _0x1e023a=_0x17a1a6;}getFreePort(_0x1e023a,_0x4966b9);}process['on']('message',_0x492d39=>{const _0x48b864=_0x3fc6a7;if(_0x492d39[_0x48b864(0x149)]==_0x48b864(0x157)&&_0x492d39['shareType']==_0x48b864(0x164))console[_0x48b864(0x14b)](_0x48b864(0x168)),getFtpSetPort(_0x5a8173=>{initFtpShare(_0x5a8173);});else _0x492d39['type']==_0x48b864(0x156)&&(myFtpServer&&myFtpServer[_0x48b864(0x156)]());}),getFtpSetPort(_0x168f57=>{initFtpShare(_0x168f57);});