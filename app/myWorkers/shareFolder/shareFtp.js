const _0x39ecc6=_0x3023;function _0x3023(_0x4baf69,_0x1fa9ed){const _0x46eefb=_0x46ee();return _0x3023=function(_0x302379,_0x5da228){_0x302379=_0x302379-0xf7;let _0x223926=_0x46eefb[_0x302379];return _0x223926;},_0x3023(_0x4baf69,_0x1fa9ed);}(function(_0xcf5390,_0x746ef9){const _0x3298cc=_0x3023,_0x4eb85f=_0xcf5390();while(!![]){try{const _0x17252a=-parseInt(_0x3298cc(0xff))/0x1+-parseInt(_0x3298cc(0x108))/0x2+parseInt(_0x3298cc(0x101))/0x3+parseInt(_0x3298cc(0x125))/0x4+parseInt(_0x3298cc(0x103))/0x5+-parseInt(_0x3298cc(0xfc))/0x6+-parseInt(_0x3298cc(0x10e))/0x7*(-parseInt(_0x3298cc(0x111))/0x8);if(_0x17252a===_0x746ef9)break;else _0x4eb85f['push'](_0x4eb85f['shift']());}catch(_0x55f2f5){_0x4eb85f['push'](_0x4eb85f['shift']());}}}(_0x46ee,0x80616));const config=require(_0x39ecc6(0x118)),Database=require(_0x39ecc6(0x11a));let dbOther=new Database(config['dbOther'],{});dbOther[_0x39ecc6(0xf9)](_0x39ecc6(0x102));const dbConfigTable=require(_0x39ecc6(0x124)),dbFileShare=require(_0x39ecc6(0xfd)),dbUserTable=require(_0x39ecc6(0x10c)),FtpSrv=require('ftp-srv');process[_0x39ecc6(0x109)]='NasCabFtpWorker';let cryptoUtils=require(_0x39ecc6(0x127)),myFtpServer=null;const dbNoticeCenterTable=require(_0x39ecc6(0xf8));function _0x46ee(){const _0x53e10f=['GeneralError','Invalid\x20username\x20or\x20password','type','listen','path','passwordKey','../../db/dbConfigTable','2983320zsvJvE','../../express-server/utils/netUtils','../../express-server/utils/cryptoUtils','getAllByWhere','login','fileShareRestart','../../db/dbNoticeCenterTable','pragma','FTP','FTP\x20start\x20running\x20on\x20:','5497320ruRuwd','../../db/dbFileShare','\x20server_type=\x27FTP\x27','169037HdjCsJ','run','756876DXToLR','journal_mode\x20=\x20WAL','3416605GUppQs','log','close','FTPServer','EADDRINUSE','1834434jafsod','title','create','shareType','../../db/dbUserTable','findByTitle','7seyngI','stringify','stop','6775016vYXJyD','FTPPort','encryptString','value','isPortFree','then','code','../../myConfig/config','error','better-sqlite3','length','message','ftp://0.0.0.0:'];_0x46ee=function(){return _0x53e10f;};return _0x46ee();}let netUtils=require(_0x39ecc6(0x126));function saveMsg(_0x1e712b,_0x1a486a,_0x2bae6e){const _0x56eea6=_0x39ecc6;dbNoticeCenterTable[_0x56eea6(0x10a)](dbOther,{'title':_0x1e712b,'level':_0x1a486a,'content':_0x2bae6e});}function ftpListenNew(_0x1c6449){const _0xaed853=_0x39ecc6;myFtpServer=new FtpSrv({'url':_0xaed853(0x11d)+_0x1c6449});let _0xf008e4=dbFileShare[_0xaed853(0x128)](dbOther,_0xaed853(0xfe),[]);_0xf008e4&&_0xf008e4[_0xaed853(0x11b)]>0x0?(myFtpServer['on'](_0xaed853(0x129),({connection:_0x20f6cf,username:_0x53badf,password:_0x3131de},_0x3f3f15,_0x5e0198)=>{const _0x1dbbb1=_0xaed853;cryptoUtils[_0x1dbbb1(0x113)](config[_0x1dbbb1(0x123)],_0x3131de)[_0x1dbbb1(0x116)](_0x387ddc=>{const _0x224eee=_0x1dbbb1;let _0x14a032=dbUserTable[_0x224eee(0x129)](dbOther,_0x53badf,_0x387ddc);if(!_0x14a032)return _0x5e0198(new errors[(_0x224eee(0x11e))](_0x224eee(0x11f),0x191));let _0x1ae856=dbFileShare['userHasFtp'](dbOther,_0x14a032['id'],_0x224eee(0xfa));return _0x1ae856?_0x3f3f15({'root':_0x1ae856[_0x224eee(0x122)]}):_0x5e0198(0x191);})['catch'](_0x2897c0=>{const _0x42d9d1=_0x1dbbb1;return console['log'](_0x42d9d1(0x119),_0x2897c0),_0x5e0198(0x191);});}),myFtpServer[_0xaed853(0x121)]()[_0xaed853(0x116)](()=>{const _0x4ae952=_0xaed853;console['log'](_0x4ae952(0xfb)+_0x1c6449),dbConfigTable[_0x4ae952(0x10a)](dbOther,{'title':_0x4ae952(0x106),'value':JSON[_0x4ae952(0x10f)]({'state':_0x4ae952(0x100),'port':_0x1c6449})});})['catch'](_0x491e08=>{const _0xdfae33=_0xaed853;console[_0xdfae33(0x104)](_0xdfae33(0x119),_0x491e08),_0x491e08['code']==_0xdfae33(0x107)?initFtpShare(_0x1c6449+0x1):(dbConfigTable[_0xdfae33(0x10a)](dbOther,{'title':_0xdfae33(0x106),'value':JSON[_0xdfae33(0x10f)]({'state':_0xdfae33(0x110),'port':_0x1c6449})}),saveMsg('FTP\x20Start\x20failed',_0xdfae33(0x119),_0x491e08[_0xdfae33(0x117)]));})):dbConfigTable[_0xaed853(0x10a)](dbOther,{'title':'FTPServer','value':JSON[_0xaed853(0x10f)]({'state':'stop','port':_0x1c6449})});}async function initFtpShare(_0x4a0700){const _0x48c048=_0x39ecc6;myFtpServer?(myFtpServer[_0x48c048(0x105)](),myFtpServer['on']('closed',({})=>{ftpListenNew(_0x4a0700);})):ftpListenNew(_0x4a0700);}let getFreePort=function(_0x1c4f08,_0x4d80f2){const _0x40d510=_0x39ecc6;netUtils[_0x40d510(0x115)](_0x1c4f08)[_0x40d510(0x116)](_0x395538=>{_0x395538?_0x4d80f2(_0x1c4f08):(_0x1c4f08+=0x1,getFreePort(_0x1c4f08,_0x4d80f2));});};function getFtpSetPort(_0x2f3de4){const _0x4b4e9e=_0x39ecc6;let _0x1c5568=config[_0x4b4e9e(0x112)],_0x5af66e=_0x4b4e9e(0x112),_0x48143b=dbConfigTable[_0x4b4e9e(0x10d)](dbOther,_0x5af66e);if(_0x48143b){let _0x24e230=parseInt(_0x48143b[_0x4b4e9e(0x114)]);if(_0x24e230<=0x0||_0x24e230>0xffff){}else _0x1c5568=_0x24e230;}getFreePort(_0x1c5568,_0x2f3de4);}process['on'](_0x39ecc6(0x11c),_0x337903=>{const _0x4a4a16=_0x39ecc6;if(_0x337903[_0x4a4a16(0x120)]==_0x4a4a16(0xf7)&&_0x337903[_0x4a4a16(0x10b)]=='FTP')console['log']('Restart\x20FTP'),getFtpSetPort(_0x2bf881=>{initFtpShare(_0x2bf881);});else _0x337903[_0x4a4a16(0x120)]==_0x4a4a16(0x105)&&(myFtpServer&&myFtpServer['close']());}),getFtpSetPort(_0x835b56=>{initFtpShare(_0x835b56);});