const _0x180665=_0x34de;(function(_0x4b5bd2,_0x3244d8){const _0x3d0963=_0x34de,_0x5282f8=_0x4b5bd2();while(!![]){try{const _0x419bbc=parseInt(_0x3d0963(0xb4))/0x1+parseInt(_0x3d0963(0xbf))/0x2*(-parseInt(_0x3d0963(0xa7))/0x3)+parseInt(_0x3d0963(0x74))/0x4+parseInt(_0x3d0963(0xbd))/0x5+-parseInt(_0x3d0963(0x88))/0x6+parseInt(_0x3d0963(0x69))/0x7+-parseInt(_0x3d0963(0xbc))/0x8*(parseInt(_0x3d0963(0xc2))/0x9);if(_0x419bbc===_0x3244d8)break;else _0x5282f8['push'](_0x5282f8['shift']());}catch(_0x593958){_0x5282f8['push'](_0x5282f8['shift']());}}}(_0x5bcb,0x9ee6b));function _0x34de(_0x555b98,_0x3eb0fa){const _0x5bcb32=_0x5bcb();return _0x34de=function(_0x34decf,_0x2ddf61){_0x34decf=_0x34decf-0x64;let _0x313c53=_0x5bcb32[_0x34decf];return _0x313c53;},_0x34de(_0x555b98,_0x3eb0fa);}let webdav=require(_0x180665(0xb5))['v2'],express=require('express');const config=require(_0x180665(0x7f)),path=require(_0x180665(0x8c)),fs=require('fs'),Database=require(_0x180665(0x7d));let dbOther=new Database(config[_0x180665(0x9c)],{});process[_0x180665(0x84)]=_0x180665(0xa8),dbOther['pragma'](_0x180665(0x6a));let dbConfigTable=require(_0x180665(0x67)),dbFileShare=require(_0x180665(0xb9)),dbUserTable=require(_0x180665(0x71)),cryptoUtils=require(_0x180665(0xb3)),app=null,myWebDavServer=null,userManager=new webdav[(_0x180665(0x8d))](),privilegeManager=new webdav[(_0x180665(0x81))](),dbNoticeCenterTable=require(_0x180665(0x6f)),netUtils=require(_0x180665(0x76));const messageUtil=require(_0x180665(0xa9));function _0x5bcb(){const _0x5e08f9=['1620039GgSdZU','NasCabWebDavWorker','../../utils/messageUtil','Starting\x20WebDav\x20http\x20on\x20port','listen','stack','username','readFileSync','shareType','path_sign','WebDav\x20start\x20listen','express','../../express-server/utils/cryptoUtils','1132205vgGbAK','webdav-server','WebDav','uncaughtException','webDavPortHttps','../../db/dbFileShare','WebDav\x20https\x20error\x20','all','13838312DJAJjk','2477420zdRlGW','createServer','2TfLWlF','then','\x20server_type=\x27WebDav\x27','9NHYwIT','HTTPS\x20certs\x20not\x20exist','error','log','stop','appRootPath','../../db/dbConfigTable','code','8004297qnpEPd','journal_mode\x20=\x20WAL','webDavHttpsServer','join','toString','Default\x20realm','../../db/dbNoticeCenterTable','webdav使用和api相同的证书','../../db/dbUserTable','WebDAVServer','extensions','5079608JdkCpb','close','../../express-server/utils/netUtils','key.pem','webdav使用自己设置的证书','user_id','PhysicalFileSystem','webDavServer','length','better-sqlite3','certs','../../myConfig/config','WebDav\x20Start\x20failed','SimplePathPrivilegeManager','tls','addUser','title','message','run','decryptString','6722406lYFnln','setRights','webdav\x20https\x20已关闭','WebDav\x20https\x20error','path','SimpleUserManager','cert.pem','WebDav\x20https\x20service\x20is\x20running,port:','is_admin','findByTitle','startsWith','nasZs987bac','isPortFree','webdav使用默认证书','https','passwordKey','httpsKey','value','type','HTTPDigestAuthentication','dbOther','stringify','use','password','fileShareRestart','getAdmin','saveMsg','create','existsSync','-----','getSharesUserByShareId'];_0x5bcb=function(){return _0x5e08f9;};return _0x5bcb();}let httpsServer;const https=require(_0x180665(0x96));let tls=require(_0x180665(0x82));function testCertAndKeyMatch(_0x3a837f,_0x371ecb){try{return tls['createSecureContext']({'cert':_0x3a837f,'key':_0x371ecb}),!![];}catch(_0x4e0df1){return![];}}function saveMsg(_0x27f370,_0x4b538d,_0x355d95){const _0x5eb823=_0x180665;dbNoticeCenterTable[_0x5eb823(0xa3)](dbOther,{'title':_0x27f370,'level':_0x4b538d,'content':_0x355d95});}let getFreePort=function(_0x300ef4,_0x1da7db){const _0x57d84a=_0x180665;netUtils[_0x57d84a(0x94)](_0x300ef4)[_0x57d84a(0xc0)](_0x1be059=>{_0x1be059?_0x1da7db(_0x300ef4):(_0x300ef4=parseInt(_0x300ef4)+0x1,getFreePort(_0x300ef4,_0x1da7db));})['catch'](_0x578db8=>{const _0x48990f=_0x57d84a;console[_0x48990f(0x64)](_0x578db8),_0x1da7db(_0x300ef4);});};async function startHttps(_0x43d286){const _0x2ed091=_0x180665;try{let _0x33c4a9=config[_0x2ed091(0xb8)],_0x58ab8c=dbConfigTable[_0x2ed091(0x91)](dbOther,_0x2ed091(0xb8));_0x58ab8c&&_0x58ab8c[_0x2ed091(0x99)]&&_0x58ab8c[_0x2ed091(0x99)]>0x0&&_0x58ab8c[_0x2ed091(0x99)]<0xffff&&(_0x33c4a9=_0x58ab8c[_0x2ed091(0x99)]);let _0x2e3a22='',_0x5b9970='';getFreePort(_0x33c4a9,async _0x27152d=>{const _0x4072ca=_0x2ed091;try{console[_0x4072ca(0x64)](_0x4072ca(0xaa),_0x27152d),_0x33c4a9=_0x27152d;let _0x18fc86=dbConfigTable[_0x4072ca(0x91)](dbOther,'webDavUseApiCert');if(_0x18fc86&&_0x18fc86[_0x4072ca(0x99)]==0x1){console[_0x4072ca(0x64)](_0x4072ca(0x70));let _0x3dd5ef=dbConfigTable[_0x4072ca(0x91)](dbOther,'httpsCert');_0x3dd5ef&&_0x3dd5ef[_0x4072ca(0x99)]&&(_0x2e3a22=_0x3dd5ef[_0x4072ca(0x99)]);let _0x399c6a=dbConfigTable[_0x4072ca(0x91)](dbOther,_0x4072ca(0x98));_0x399c6a&&_0x399c6a['value']&&(_0x5b9970=_0x399c6a[_0x4072ca(0x99)]);}else{console[_0x4072ca(0x64)](_0x4072ca(0x78));let _0x3d5e33=dbConfigTable[_0x4072ca(0x91)](dbOther,'webDavHttpsCert');_0x3d5e33&&_0x3d5e33[_0x4072ca(0x99)]&&(_0x2e3a22=_0x3d5e33[_0x4072ca(0x99)]);let _0x44eea1=dbConfigTable[_0x4072ca(0x91)](dbOther,'webDavHttpsKey');_0x44eea1&&_0x44eea1['value']&&(_0x5b9970=_0x44eea1['value']);}if(!_0x2e3a22){console['log'](_0x4072ca(0x95));let _0x527376=path[_0x4072ca(0x6c)](config[_0x4072ca(0x66)],_0x4072ca(0x7e),_0x4072ca(0x8e));if(!fs['existsSync'](_0x527376))return messageUtil[_0x4072ca(0xa2)](dbOther,_0x4072ca(0x8b),'error',_0x4072ca(0xc3));_0x2e3a22=fs[_0x4072ca(0xae)](_0x527376)[_0x4072ca(0x6d)]();}if(!_0x5b9970){let _0x21d331=path['join'](config['appRootPath'],_0x4072ca(0x7e),_0x4072ca(0x77));if(!fs[_0x4072ca(0xa4)](_0x21d331))return messageUtil[_0x4072ca(0xa2)](dbOther,_0x4072ca(0x8b),'error',_0x4072ca(0xc3));_0x5b9970=fs[_0x4072ca(0xae)](_0x21d331)[_0x4072ca(0x6d)]();}if(!_0x2e3a22[_0x4072ca(0x92)](_0x4072ca(0xa5)))try{_0x2e3a22=await cryptoUtils[_0x4072ca(0x87)](_0x4072ca(0x93),_0x2e3a22),_0x5b9970=await cryptoUtils[_0x4072ca(0x87)](_0x4072ca(0x93),_0x5b9970);}catch(_0x2e422c){console[_0x4072ca(0x64)](_0x2e422c);}const _0x1251b1=testCertAndKeyMatch(_0x2e3a22,_0x5b9970);if(!_0x1251b1)return messageUtil['saveMsg'](dbOther,_0x4072ca(0x8b),'error','HTTPS\x20certs\x20not\x20exist');const _0x432f24={'cert':_0x2e3a22,'key':_0x5b9970};httpsServer=https[_0x4072ca(0xbe)](_0x432f24,_0x43d286),httpsServer[_0x4072ca(0xab)](_0x33c4a9,_0x11ac04=>{const _0x38b866=_0x4072ca;console['log'](_0x11ac04),console[_0x38b866(0x64)](_0x38b866(0x8f),_0x33c4a9),dbConfigTable[_0x38b866(0xa3)](dbOther,{'title':_0x38b866(0x6b),'value':JSON[_0x38b866(0x9d)]({'state':'run','port':_0x33c4a9})});}),httpsServer['on'](_0x4072ca(0xc4),_0x493f1b=>{const _0x2f91a7=_0x4072ca;return console['log'](_0x2f91a7(0xba),_0x493f1b),dbConfigTable[_0x2f91a7(0xa3)](dbOther,{'title':'webDavHttpsServer','value':JSON[_0x2f91a7(0x9d)]({'state':_0x2f91a7(0x65),'port':_0x33c4a9})}),messageUtil[_0x2f91a7(0xa2)](dbOther,_0x2f91a7(0x8b),_0x2f91a7(0xc4),_0x493f1b[_0x2f91a7(0xac)]||_0x493f1b[_0x2f91a7(0x85)]);});}catch(_0x35e814){return console['log'](_0x35e814),messageUtil[_0x4072ca(0xa2)](dbOther,'WebDav\x20https\x20error','error',_0x35e814['stack']||_0x35e814[_0x4072ca(0x85)]);}});}catch(_0x2ae47a){return console[_0x2ed091(0x64)](_0x2ae47a),messageUtil['saveMsg'](dbOther,_0x2ed091(0x8b),_0x2ed091(0xc4),_0x2ae47a[_0x2ed091(0xac)]||_0x2ae47a[_0x2ed091(0x85)]);}}function initWebDavShare(){const _0x2625b4=_0x180665;let _0x40277b=dbFileShare['getAllByWhere'](dbOther,_0x2625b4(0xc1),[]),_0x589a98='webDavPort',_0x1da94e=config['webDavPort'],_0x5f0fed=dbConfigTable['findByTitle'](dbOther,_0x589a98);if(_0x5f0fed){let _0x51e786=parseInt(_0x5f0fed[_0x2625b4(0x99)]);if(_0x51e786<=0x0||_0x51e786>0xffff){}else _0x1da94e=_0x51e786;}function _0x4eb402(){getFreePort(_0x1da94e,async _0x28396a=>{const _0x5bfcfb=_0x34de;if(_0x40277b&&_0x40277b[_0x5bfcfb(0x7c)]>0x0){app=express();for(let _0x3d41c7=0x0;_0x3d41c7<_0x40277b[_0x5bfcfb(0x7c)];_0x3d41c7++){let _0x35fe4f=_0x40277b[_0x3d41c7],_0x41f534=dbFileShare[_0x5bfcfb(0xa6)](dbOther,_0x35fe4f['id']);if(_0x41f534&&_0x41f534[_0x5bfcfb(0x7c)]>0x0)for(let _0x1629b7=0x0;_0x1629b7<_0x41f534[_0x5bfcfb(0x7c)];_0x1629b7++){let _0x4cce50=dbUserTable['find'](dbOther,_0x41f534[_0x1629b7][_0x5bfcfb(0x79)]);if(_0x4cce50){let _0x5e203d=await cryptoUtils[_0x5bfcfb(0x87)](config[_0x5bfcfb(0x97)],_0x4cce50['password']),_0x528e1a=userManager[_0x5bfcfb(0x83)](_0x4cce50[_0x5bfcfb(0xad)],_0x5e203d,parseInt(_0x4cce50[_0x5bfcfb(0x90)])==0x1);privilegeManager['setRights'](_0x528e1a,'/'+_0x40277b[_0x3d41c7]['path_sign'],[_0x5bfcfb(0xbb)]);}}}let _0x466d18=dbUserTable[_0x5bfcfb(0xa1)](dbOther);if(!_0x466d18)return;let _0x3c0e58=await cryptoUtils[_0x5bfcfb(0x87)](config[_0x5bfcfb(0x97)],_0x466d18[_0x5bfcfb(0x9f)]),_0x12f48f=userManager[_0x5bfcfb(0x83)](_0x466d18[_0x5bfcfb(0xad)],_0x3c0e58,!![]);privilegeManager[_0x5bfcfb(0x89)](_0x12f48f,'/',[_0x5bfcfb(0xbb)]);const _0x5bd180=new webdav[(_0x5bfcfb(0x72))]({'httpAuthentication':new webdav[(_0x5bfcfb(0x9b))](userManager,_0x5bfcfb(0x6e)),'privilegeManager':privilegeManager});for(let _0x54bf45=0x0;_0x54bf45<_0x40277b[_0x5bfcfb(0x7c)];_0x54bf45++){_0x5bd180['setFileSystem']('/'+_0x40277b[_0x54bf45][_0x5bfcfb(0xb0)],new webdav[(_0x5bfcfb(0x7a))](_0x40277b[_0x54bf45][_0x5bfcfb(0x8c)]));}app[_0x5bfcfb(0x9e)](webdav[_0x5bfcfb(0x73)][_0x5bfcfb(0xb2)]('/',_0x5bd180));function _0x24c6f5(_0x1797b5){myWebDavServer=app['listen'](_0x1797b5,()=>{const _0x293ef9=_0x34de;console['log'](_0x293ef9(0xb1)),startHttps(app),dbConfigTable[_0x293ef9(0xa3)](dbOther,{'title':'webDavServer','value':JSON[_0x293ef9(0x9d)]({'state':_0x293ef9(0x86),'port':_0x1797b5})});});}process['on'](_0x5bfcfb(0xb7),function(_0x14236a){const _0x5658d2=_0x5bfcfb;saveMsg(_0x5658d2(0x80),'error',_0x14236a[_0x5658d2(0x68)]),initWebDavShare();}),_0x24c6f5(_0x28396a);}else dbConfigTable['create'](dbOther,{'title':_0x5bfcfb(0x7b),'value':JSON[_0x5bfcfb(0x9d)]({'state':'stop','port':_0x28396a})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x2625b4(0x8d))](),privilegeManager=new webdav[(_0x2625b4(0x81))](),httpsServer[_0x2625b4(0x75)](_0x31a072=>{const _0x47e086=_0x2625b4;console[_0x47e086(0x64)](_0x47e086(0x8a)),myWebDavServer[_0x47e086(0x75)](_0x427e61=>{myWebDavServer=null,_0x4eb402();});})):_0x4eb402();}process['on']('message',_0x23fa0d=>{const _0x5e024c=_0x180665;_0x23fa0d[_0x5e024c(0x9a)]==_0x5e024c(0xa0)&&_0x23fa0d[_0x5e024c(0xaf)]==_0x5e024c(0xb6)&&initWebDavShare();}),initWebDavShare();