const _0x8ce3df=_0x29ca;(function(_0x5e0233,_0x275708){const _0x10ff43=_0x29ca,_0x24cd68=_0x5e0233();while(!![]){try{const _0x2c6613=parseInt(_0x10ff43(0x10e))/0x1+-parseInt(_0x10ff43(0x15d))/0x2+-parseInt(_0x10ff43(0x138))/0x3+-parseInt(_0x10ff43(0x12a))/0x4+-parseInt(_0x10ff43(0x15a))/0x5+parseInt(_0x10ff43(0x122))/0x6*(-parseInt(_0x10ff43(0x143))/0x7)+parseInt(_0x10ff43(0x148))/0x8;if(_0x2c6613===_0x275708)break;else _0x24cd68['push'](_0x24cd68['shift']());}catch(_0xe39ac0){_0x24cd68['push'](_0x24cd68['shift']());}}}(_0x2e04,0x2bdea));let webdav=require(_0x8ce3df(0x13d))['v2'],express=require(_0x8ce3df(0x12c));const config=require(_0x8ce3df(0x134)),path=require(_0x8ce3df(0x133)),fs=require('fs'),Database=require('better-sqlite3');let dbOther=new Database(config['dbOther'],{});function _0x2e04(){const _0x566b76=['WebDav','626004rybigS','type','user_id','getSharesUserByShareId','../../db/dbConfigTable','webdav-server','createServer','password','../../utils/messageUtil','length','WebDav\x20https\x20service\x20is\x20running,port:','79065vlVEkP','all','webDavServer','getAdmin','stop','10163800qyVwXn','../../db/dbFileShare','httpsKey','close','create','existsSync','readFileSync','HTTPS\x20certs\x20not\x20exist','listen','title','message','WebDav\x20https\x20error\x20','tls','saveMsg','webDavUseApiCert','error','\x20server_type=\x27WebDav\x27','use','1735595huMpkk','value','nasZs987bac','413048mSXOMx','webdav使用和api相同的证书','toString','decryptString','certs','run','pragma','webdav\x20https\x20已关闭','setRights','webdav使用自己设置的证书','18240ODibgL','SimpleUserManager','then','setFileSystem','httpsCert','../../db/dbUserTable','username','WebDav\x20start\x20listen','webDavPort','getAllByWhere','PhysicalFileSystem','webDavHttpsServer','stringify','key.pem','log','addUser','journal_mode\x20=\x20WAL','appRootPath','../../db/dbNoticeCenterTable','WebDav\x20https\x20error','108QBgdOT','uncaughtException','-----','startsWith','Default\x20realm','passwordKey','../../express-server/utils/netUtils','join','573616WBKtjx','WebDav\x20Start\x20failed','express','catch','webDavPortHttps','path_sign','find','findByTitle','webDavHttpsCert','path','../../myConfig/config','extensions','stack'];_0x2e04=function(){return _0x566b76;};return _0x2e04();}function _0x29ca(_0x173b1f,_0x420fb0){const _0x2e0433=_0x2e04();return _0x29ca=function(_0x29caf4,_0x50b95a){_0x29caf4=_0x29caf4-0x10d;let _0x2c3bcd=_0x2e0433[_0x29caf4];return _0x2c3bcd;},_0x29ca(_0x173b1f,_0x420fb0);}process[_0x8ce3df(0x151)]='NasCabWebDavWorker',dbOther[_0x8ce3df(0x163)](_0x8ce3df(0x11e));let dbConfigTable=require(_0x8ce3df(0x13c)),dbFileShare=require(_0x8ce3df(0x149)),dbUserTable=require(_0x8ce3df(0x113)),cryptoUtils=require('../../express-server/utils/cryptoUtils'),app=null,myWebDavServer=null,userManager=new webdav[(_0x8ce3df(0x10f))](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),dbNoticeCenterTable=require(_0x8ce3df(0x120)),netUtils=require(_0x8ce3df(0x128));const messageUtil=require(_0x8ce3df(0x140));let httpsServer;const https=require('https');let tls=require(_0x8ce3df(0x154));function testCertAndKeyMatch(_0x4d2e13,_0x963f60){try{return tls['createSecureContext']({'cert':_0x4d2e13,'key':_0x963f60}),!![];}catch(_0x57ed5d){return![];}}function saveMsg(_0x27f77c,_0x5303b3,_0x2f1953){const _0x398158=_0x8ce3df;dbNoticeCenterTable[_0x398158(0x14c)](dbOther,{'title':_0x27f77c,'level':_0x5303b3,'content':_0x2f1953});}let getFreePort=function(_0x5183f2,_0x1fa12e){const _0x2766f1=_0x8ce3df;netUtils['isPortFree'](_0x5183f2)[_0x2766f1(0x110)](_0x5e1e26=>{_0x5e1e26?_0x1fa12e(_0x5183f2):(_0x5183f2=parseInt(_0x5183f2)+0x1,getFreePort(_0x5183f2,_0x1fa12e));})[_0x2766f1(0x12d)](_0x3229e8=>{const _0x3286e6=_0x2766f1;console[_0x3286e6(0x11c)](_0x3229e8),_0x1fa12e(_0x5183f2);});};async function startHttps(_0x12136e){const _0x24115c=_0x8ce3df;try{let _0x5dc817=config[_0x24115c(0x12e)],_0x2bed72=dbConfigTable['findByTitle'](dbOther,_0x24115c(0x12e));_0x2bed72&&_0x2bed72[_0x24115c(0x15b)]&&_0x2bed72['value']>0x0&&_0x2bed72[_0x24115c(0x15b)]<0xffff&&(_0x5dc817=_0x2bed72[_0x24115c(0x15b)]);let _0x54bb3b='',_0x2603ed='';getFreePort(_0x5dc817,async _0x28f485=>{const _0x1ab506=_0x24115c;try{console[_0x1ab506(0x11c)]('Starting\x20WebDav\x20http\x20on\x20port',_0x28f485),_0x5dc817=_0x28f485;let _0xee7542=dbConfigTable[_0x1ab506(0x131)](dbOther,_0x1ab506(0x156));if(_0xee7542&&_0xee7542[_0x1ab506(0x15b)]==0x1){console[_0x1ab506(0x11c)](_0x1ab506(0x15e));let _0x2ae37b=dbConfigTable['findByTitle'](dbOther,_0x1ab506(0x112));_0x2ae37b&&_0x2ae37b[_0x1ab506(0x15b)]&&(_0x54bb3b=_0x2ae37b['value']);let _0x2ee494=dbConfigTable[_0x1ab506(0x131)](dbOther,_0x1ab506(0x14a));_0x2ee494&&_0x2ee494[_0x1ab506(0x15b)]&&(_0x2603ed=_0x2ee494[_0x1ab506(0x15b)]);}else{console['log'](_0x1ab506(0x10d));let _0x505b50=dbConfigTable[_0x1ab506(0x131)](dbOther,_0x1ab506(0x132));_0x505b50&&_0x505b50['value']&&(_0x54bb3b=_0x505b50['value']);let _0x5689d7=dbConfigTable[_0x1ab506(0x131)](dbOther,'webDavHttpsKey');_0x5689d7&&_0x5689d7['value']&&(_0x2603ed=_0x5689d7[_0x1ab506(0x15b)]);}if(!_0x54bb3b){console['log']('webdav使用默认证书');let _0x15d203=path['join'](config[_0x1ab506(0x11f)],_0x1ab506(0x161),'cert.pem');if(!fs[_0x1ab506(0x14d)](_0x15d203))return messageUtil[_0x1ab506(0x155)](dbOther,_0x1ab506(0x121),_0x1ab506(0x157),_0x1ab506(0x14f));_0x54bb3b=fs[_0x1ab506(0x14e)](_0x15d203)[_0x1ab506(0x15f)]();}if(!_0x2603ed){let _0x1d2203=path[_0x1ab506(0x129)](config['appRootPath'],_0x1ab506(0x161),_0x1ab506(0x11b));if(!fs[_0x1ab506(0x14d)](_0x1d2203))return messageUtil[_0x1ab506(0x155)](dbOther,_0x1ab506(0x121),_0x1ab506(0x157),_0x1ab506(0x14f));_0x2603ed=fs[_0x1ab506(0x14e)](_0x1d2203)[_0x1ab506(0x15f)]();}if(!_0x54bb3b[_0x1ab506(0x125)](_0x1ab506(0x124)))try{_0x54bb3b=await cryptoUtils[_0x1ab506(0x160)](_0x1ab506(0x15c),_0x54bb3b),_0x2603ed=await cryptoUtils[_0x1ab506(0x160)](_0x1ab506(0x15c),_0x2603ed);}catch(_0x46df8b){console['log'](_0x46df8b);}const _0x305be1=testCertAndKeyMatch(_0x54bb3b,_0x2603ed);if(!_0x305be1)return messageUtil[_0x1ab506(0x155)](dbOther,_0x1ab506(0x121),_0x1ab506(0x157),_0x1ab506(0x14f));const _0x131282={'cert':_0x54bb3b,'key':_0x2603ed};httpsServer=https[_0x1ab506(0x13e)](_0x131282,_0x12136e),httpsServer[_0x1ab506(0x150)](_0x5dc817,_0x3da383=>{const _0x45c4ec=_0x1ab506;console[_0x45c4ec(0x11c)](_0x3da383),console['log'](_0x45c4ec(0x142),_0x5dc817),dbConfigTable[_0x45c4ec(0x14c)](dbOther,{'title':_0x45c4ec(0x119),'value':JSON[_0x45c4ec(0x11a)]({'state':_0x45c4ec(0x162),'port':_0x5dc817})});}),httpsServer['on'](_0x1ab506(0x157),_0x5e42d8=>{const _0x58dbac=_0x1ab506;return console[_0x58dbac(0x11c)](_0x58dbac(0x153),_0x5e42d8),dbConfigTable['create'](dbOther,{'title':'webDavHttpsServer','value':JSON['stringify']({'state':_0x58dbac(0x147),'port':_0x5dc817})}),messageUtil[_0x58dbac(0x155)](dbOther,_0x58dbac(0x121),_0x58dbac(0x157),_0x5e42d8[_0x58dbac(0x136)]||_0x5e42d8['message']);});}catch(_0x2b8e78){return console[_0x1ab506(0x11c)](_0x2b8e78),messageUtil[_0x1ab506(0x155)](dbOther,_0x1ab506(0x121),_0x1ab506(0x157),_0x2b8e78[_0x1ab506(0x136)]||_0x2b8e78[_0x1ab506(0x152)]);}});}catch(_0xede3e){return console[_0x24115c(0x11c)](_0xede3e),messageUtil[_0x24115c(0x155)](dbOther,_0x24115c(0x121),'error',_0xede3e[_0x24115c(0x136)]||_0xede3e[_0x24115c(0x152)]);}}function initWebDavShare(){const _0x89488e=_0x8ce3df;let _0x18c2cf=dbFileShare[_0x89488e(0x117)](dbOther,_0x89488e(0x158),[]),_0x1b09f1=_0x89488e(0x116),_0xf30cd5=config[_0x89488e(0x116)],_0x171842=dbConfigTable[_0x89488e(0x131)](dbOther,_0x1b09f1);if(_0x171842){let _0x2d5cbb=parseInt(_0x171842[_0x89488e(0x15b)]);if(_0x2d5cbb<=0x0||_0x2d5cbb>0xffff){}else _0xf30cd5=_0x2d5cbb;}function _0x2c2033(){getFreePort(_0xf30cd5,async _0x1b7421=>{const _0x31fedd=_0x29ca;if(_0x18c2cf&&_0x18c2cf['length']>0x0){app=express();for(let _0x48aaa2=0x0;_0x48aaa2<_0x18c2cf[_0x31fedd(0x141)];_0x48aaa2++){let _0x4d601c=_0x18c2cf[_0x48aaa2],_0x1a0d1d=dbFileShare[_0x31fedd(0x13b)](dbOther,_0x4d601c['id']);if(_0x1a0d1d&&_0x1a0d1d[_0x31fedd(0x141)]>0x0)for(let _0x3d7c1b=0x0;_0x3d7c1b<_0x1a0d1d['length'];_0x3d7c1b++){let _0x2baee4=dbUserTable[_0x31fedd(0x130)](dbOther,_0x1a0d1d[_0x3d7c1b][_0x31fedd(0x13a)]);if(_0x2baee4){let _0x2f2dc1=await cryptoUtils['decryptString'](config['passwordKey'],_0x2baee4[_0x31fedd(0x13f)]),_0x224301=userManager[_0x31fedd(0x11d)](_0x2baee4['username'],_0x2f2dc1,parseInt(_0x2baee4['is_admin'])==0x1);privilegeManager[_0x31fedd(0x165)](_0x224301,'/'+_0x18c2cf[_0x48aaa2][_0x31fedd(0x12f)],['all']);}}}let _0x53e301=dbUserTable[_0x31fedd(0x146)](dbOther);if(!_0x53e301)return;let _0x3fa0e2=await cryptoUtils[_0x31fedd(0x160)](config[_0x31fedd(0x127)],_0x53e301[_0x31fedd(0x13f)]),_0x2fc1a5=userManager['addUser'](_0x53e301[_0x31fedd(0x114)],_0x3fa0e2,!![]);privilegeManager[_0x31fedd(0x165)](_0x2fc1a5,'/',[_0x31fedd(0x144)]);const _0xf5ee77=new webdav['WebDAVServer']({'httpAuthentication':new webdav['HTTPDigestAuthentication'](userManager,_0x31fedd(0x126)),'privilegeManager':privilegeManager});for(let _0x4e22e1=0x0;_0x4e22e1<_0x18c2cf[_0x31fedd(0x141)];_0x4e22e1++){_0xf5ee77[_0x31fedd(0x111)]('/'+_0x18c2cf[_0x4e22e1][_0x31fedd(0x12f)],new webdav[(_0x31fedd(0x118))](_0x18c2cf[_0x4e22e1]['path']));}app[_0x31fedd(0x159)](webdav[_0x31fedd(0x135)][_0x31fedd(0x12c)]('/',_0xf5ee77));function _0x220564(_0x12cae0){myWebDavServer=app['listen'](_0x12cae0,()=>{const _0x2561ec=_0x29ca;console[_0x2561ec(0x11c)](_0x2561ec(0x115)),startHttps(app),dbConfigTable['create'](dbOther,{'title':_0x2561ec(0x145),'value':JSON[_0x2561ec(0x11a)]({'state':_0x2561ec(0x162),'port':_0x12cae0})});});}process['on'](_0x31fedd(0x123),function(_0x40c1f0){const _0x3fb4ae=_0x31fedd;saveMsg(_0x3fb4ae(0x12b),_0x3fb4ae(0x157),_0x40c1f0['code']),initWebDavShare();}),_0x220564(_0x1b7421);}else dbConfigTable[_0x31fedd(0x14c)](dbOther,{'title':_0x31fedd(0x145),'value':JSON[_0x31fedd(0x11a)]({'state':_0x31fedd(0x147),'port':_0x1b7421})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x89488e(0x10f))](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),httpsServer['close'](_0x374eba=>{const _0x2a0748=_0x89488e;console[_0x2a0748(0x11c)](_0x2a0748(0x164)),myWebDavServer[_0x2a0748(0x14b)](_0x16c48a=>{myWebDavServer=null,_0x2c2033();});})):_0x2c2033();}process['on'](_0x8ce3df(0x152),_0x5a66ac=>{const _0x30ed2c=_0x8ce3df;_0x5a66ac[_0x30ed2c(0x139)]=='fileShareRestart'&&_0x5a66ac['shareType']==_0x30ed2c(0x137)&&initWebDavShare();}),initWebDavShare();