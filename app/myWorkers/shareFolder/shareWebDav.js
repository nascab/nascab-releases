const _0x13ae6d=_0x3131;(function(_0x5baab8,_0x32161a){const _0x36b126=_0x3131,_0x9d71f6=_0x5baab8();while(!![]){try{const _0xf88f02=parseInt(_0x36b126(0x13d))/0x1+-parseInt(_0x36b126(0x138))/0x2+parseInt(_0x36b126(0x124))/0x3*(parseInt(_0x36b126(0x10d))/0x4)+parseInt(_0x36b126(0x114))/0x5+-parseInt(_0x36b126(0x128))/0x6*(-parseInt(_0x36b126(0x149))/0x7)+parseInt(_0x36b126(0x14d))/0x8*(parseInt(_0x36b126(0x14a))/0x9)+-parseInt(_0x36b126(0x111))/0xa;if(_0xf88f02===_0x32161a)break;else _0x9d71f6['push'](_0x9d71f6['shift']());}catch(_0x1c9063){_0x9d71f6['push'](_0x9d71f6['shift']());}}}(_0x3972,0x8ea82));let webdav=require(_0x13ae6d(0x11e))['v2'],express=require('express');const config=require(_0x13ae6d(0x126)),path=require(_0x13ae6d(0x123)),fs=require('fs'),Database=require(_0x13ae6d(0x157));let dbOther=new Database(config['dbOther'],{});process[_0x13ae6d(0x161)]=_0x13ae6d(0x148),dbOther[_0x13ae6d(0x135)](_0x13ae6d(0x15d));let dbConfigTable=require(_0x13ae6d(0x14f)),dbFileShare=require(_0x13ae6d(0x160)),dbUserTable=require(_0x13ae6d(0x16c)),cryptoUtils=require(_0x13ae6d(0x156)),app=null,myWebDavServer=null,userManager=new webdav[(_0x13ae6d(0x131))](),privilegeManager=new webdav[(_0x13ae6d(0x14c))](),dbNoticeCenterTable=require(_0x13ae6d(0x133)),netUtils=require('../../express-server/utils/netUtils');function _0x3131(_0x9c401b,_0x74134e){const _0x397212=_0x3972();return _0x3131=function(_0x313156,_0x54f0b8){_0x313156=_0x313156-0x10d;let _0x4a6bd9=_0x397212[_0x313156];return _0x4a6bd9;},_0x3131(_0x9c401b,_0x74134e);}const messageUtil=require(_0x13ae6d(0x165));let httpsServer;const https=require(_0x13ae6d(0x15c));let tls=require(_0x13ae6d(0x121));function testCertAndKeyMatch(_0x40b472,_0x7b31e7){const _0x3cad22=_0x13ae6d;try{return tls[_0x3cad22(0x13e)]({'cert':_0x40b472,'key':_0x7b31e7}),!![];}catch(_0x406a65){return![];}}function _0x3972(){const _0x3415b6=['../../express-server/utils/cryptoUtils','better-sqlite3','webDavPortHttps','passwordKey','WebDav\x20https\x20error\x20','webDavHttpsKey','https','journal_mode\x20=\x20WAL','saveMsg','decryptString','../../db/dbFileShare','title','path_sign','findByTitle','user_id','../../utils/messageUtil','log','webDavHttpsServer','toString','password','webdav使用和api相同的证书','webDavPort','../../db/dbUserTable','\x20server_type=\x27WebDav\x27','setFileSystem','1971844kfLedl','webDavServer','WebDav\x20Start\x20failed','all','13422830joyHVP','error','length','1553140xWGhCu','key.pem','WebDav\x20https\x20error','stack','HTTPS\x20certs\x20not\x20exist','certs','use','webdav\x20https\x20已关闭','close','createServer','webdav-server','addUser','getAllByWhere','tls','message','path','3hInqxL','create','../../myConfig/config','extensions','4482YCMnDS','HTTPDigestAuthentication','webDavHttpsCert','fileShareRestart','PhysicalFileSystem','run','stringify','value','-----','SimpleUserManager','nasZs987bac','../../db/dbNoticeCenterTable','listen','pragma','uncaughtException','username','1758798zYyxcV','cert.pem','appRootPath','express','stop','1049610DoLcyx','createSecureContext','code','find','startsWith','existsSync','WebDav','isPortFree','catch','shareType','type','NasCabWebDavWorker','8365CPfvqx','108252VJeFgJ','WebDav\x20https\x20service\x20is\x20running,port:','SimplePathPrivilegeManager','40LRAsLY','webDavUseApiCert','../../db/dbConfigTable','join','webdav使用默认证书','getAdmin','Starting\x20WebDav\x20http\x20on\x20port','WebDAVServer','httpsKey'];_0x3972=function(){return _0x3415b6;};return _0x3972();}function saveMsg(_0xc44b76,_0x5c4225,_0x13648d){const _0x10d5d4=_0x13ae6d;dbNoticeCenterTable[_0x10d5d4(0x125)](dbOther,{'title':_0xc44b76,'level':_0x5c4225,'content':_0x13648d});}let getFreePort=function(_0xd60ff8,_0x216e8d){const _0x3ab4e4=_0x13ae6d;netUtils[_0x3ab4e4(0x144)](_0xd60ff8)['then'](_0x16d424=>{_0x16d424?_0x216e8d(_0xd60ff8):(_0xd60ff8=parseInt(_0xd60ff8)+0x1,getFreePort(_0xd60ff8,_0x216e8d));})[_0x3ab4e4(0x145)](_0xe3f1c0=>{console['log'](_0xe3f1c0),_0x216e8d(_0xd60ff8);});};async function startHttps(_0xf0cf9e){const _0x47777b=_0x13ae6d;try{let _0x439c43=config[_0x47777b(0x158)],_0x113897=dbConfigTable[_0x47777b(0x163)](dbOther,_0x47777b(0x158));_0x113897&&_0x113897[_0x47777b(0x12f)]&&_0x113897['value']>0x0&&_0x113897['value']<0xffff&&(_0x439c43=_0x113897['value']);let _0x1abbf0='',_0x136a3b='';getFreePort(_0x439c43,async _0x1a23b6=>{const _0x188c0a=_0x47777b;try{console['log'](_0x188c0a(0x153),_0x1a23b6),_0x439c43=_0x1a23b6;let _0x888945=dbConfigTable[_0x188c0a(0x163)](dbOther,_0x188c0a(0x14e));if(_0x888945&&_0x888945[_0x188c0a(0x12f)]==0x1){console['log'](_0x188c0a(0x16a));let _0x227e07=dbConfigTable[_0x188c0a(0x163)](dbOther,'httpsCert');_0x227e07&&_0x227e07['value']&&(_0x1abbf0=_0x227e07[_0x188c0a(0x12f)]);let _0x108d4e=dbConfigTable[_0x188c0a(0x163)](dbOther,_0x188c0a(0x155));_0x108d4e&&_0x108d4e[_0x188c0a(0x12f)]&&(_0x136a3b=_0x108d4e[_0x188c0a(0x12f)]);}else{console[_0x188c0a(0x166)]('webdav使用自己设置的证书');let _0x1fe560=dbConfigTable[_0x188c0a(0x163)](dbOther,_0x188c0a(0x12a));_0x1fe560&&_0x1fe560['value']&&(_0x1abbf0=_0x1fe560[_0x188c0a(0x12f)]);let _0x3bad42=dbConfigTable[_0x188c0a(0x163)](dbOther,_0x188c0a(0x15b));_0x3bad42&&_0x3bad42[_0x188c0a(0x12f)]&&(_0x136a3b=_0x3bad42[_0x188c0a(0x12f)]);}if(!_0x1abbf0){console['log'](_0x188c0a(0x151));let _0x3b302b=path[_0x188c0a(0x150)](config[_0x188c0a(0x13a)],_0x188c0a(0x119),_0x188c0a(0x139));if(!fs['existsSync'](_0x3b302b))return messageUtil[_0x188c0a(0x15e)](dbOther,_0x188c0a(0x116),_0x188c0a(0x112),_0x188c0a(0x118));_0x1abbf0=fs['readFileSync'](_0x3b302b)[_0x188c0a(0x168)]();}if(!_0x136a3b){let _0x398ae5=path['join'](config[_0x188c0a(0x13a)],_0x188c0a(0x119),_0x188c0a(0x115));if(!fs[_0x188c0a(0x142)](_0x398ae5))return messageUtil['saveMsg'](dbOther,_0x188c0a(0x116),'error','HTTPS\x20certs\x20not\x20exist');_0x136a3b=fs['readFileSync'](_0x398ae5)[_0x188c0a(0x168)]();}if(!_0x1abbf0[_0x188c0a(0x141)](_0x188c0a(0x130)))try{_0x1abbf0=await cryptoUtils['decryptString']('nasZs987bac',_0x1abbf0),_0x136a3b=await cryptoUtils[_0x188c0a(0x15f)](_0x188c0a(0x132),_0x136a3b);}catch(_0x23fc8f){console[_0x188c0a(0x166)](_0x23fc8f);}const _0x151ca4=testCertAndKeyMatch(_0x1abbf0,_0x136a3b);if(!_0x151ca4)return messageUtil['saveMsg'](dbOther,_0x188c0a(0x116),_0x188c0a(0x112),_0x188c0a(0x118));const _0x64b4b8={'cert':_0x1abbf0,'key':_0x136a3b};httpsServer=https[_0x188c0a(0x11d)](_0x64b4b8,_0xf0cf9e),httpsServer[_0x188c0a(0x134)](_0x439c43,_0x5184f2=>{const _0x103d75=_0x188c0a;console[_0x103d75(0x166)](_0x5184f2),console[_0x103d75(0x166)](_0x103d75(0x14b),_0x439c43),dbConfigTable[_0x103d75(0x125)](dbOther,{'title':_0x103d75(0x167),'value':JSON[_0x103d75(0x12e)]({'state':_0x103d75(0x12d),'port':_0x439c43})});}),httpsServer['on']('error',_0x4ca2ca=>{const _0x387393=_0x188c0a;return console[_0x387393(0x166)](_0x387393(0x15a),_0x4ca2ca),dbConfigTable[_0x387393(0x125)](dbOther,{'title':_0x387393(0x167),'value':JSON[_0x387393(0x12e)]({'state':'stop','port':_0x439c43})}),messageUtil['saveMsg'](dbOther,'WebDav\x20https\x20error','error',_0x4ca2ca[_0x387393(0x117)]||_0x4ca2ca[_0x387393(0x122)]);});}catch(_0x4771e3){return console[_0x188c0a(0x166)](_0x4771e3),messageUtil[_0x188c0a(0x15e)](dbOther,_0x188c0a(0x116),_0x188c0a(0x112),_0x4771e3[_0x188c0a(0x117)]||_0x4771e3['message']);}});}catch(_0x17ae43){return console[_0x47777b(0x166)](_0x17ae43),messageUtil[_0x47777b(0x15e)](dbOther,'WebDav\x20https\x20error','error',_0x17ae43[_0x47777b(0x117)]||_0x17ae43['message']);}}function initWebDavShare(){const _0x12a192=_0x13ae6d;let _0x47741f=dbFileShare[_0x12a192(0x120)](dbOther,_0x12a192(0x16d),[]),_0x544392='webDavPort',_0x1f1890=config[_0x12a192(0x16b)],_0x48bb13=dbConfigTable[_0x12a192(0x163)](dbOther,_0x544392);if(_0x48bb13){let _0x452246=parseInt(_0x48bb13[_0x12a192(0x12f)]);if(_0x452246<=0x0||_0x452246>0xffff){}else _0x1f1890=_0x452246;}function _0x3ba490(){getFreePort(_0x1f1890,async _0x12129c=>{const _0x30a274=_0x3131;if(_0x47741f&&_0x47741f[_0x30a274(0x113)]>0x0){app=express();for(let _0x2e2e6f=0x0;_0x2e2e6f<_0x47741f[_0x30a274(0x113)];_0x2e2e6f++){let _0x33a596=_0x47741f[_0x2e2e6f],_0x5d716a=dbFileShare['getSharesUserByShareId'](dbOther,_0x33a596['id']);if(_0x5d716a&&_0x5d716a[_0x30a274(0x113)]>0x0)for(let _0x4d01e4=0x0;_0x4d01e4<_0x5d716a[_0x30a274(0x113)];_0x4d01e4++){let _0x57555c=dbUserTable[_0x30a274(0x140)](dbOther,_0x5d716a[_0x4d01e4][_0x30a274(0x164)]);if(_0x57555c){let _0x360462=await cryptoUtils[_0x30a274(0x15f)](config[_0x30a274(0x159)],_0x57555c[_0x30a274(0x169)]),_0x5ea97e=userManager[_0x30a274(0x11f)](_0x57555c[_0x30a274(0x137)],_0x360462,parseInt(_0x57555c['is_admin'])==0x1);privilegeManager['setRights'](_0x5ea97e,'/'+_0x47741f[_0x2e2e6f][_0x30a274(0x162)],[_0x30a274(0x110)]);}}}let _0x3cb6f7=dbUserTable[_0x30a274(0x152)](dbOther);if(!_0x3cb6f7)return;let _0x32d7db=await cryptoUtils[_0x30a274(0x15f)](config[_0x30a274(0x159)],_0x3cb6f7['password']),_0x29c97f=userManager['addUser'](_0x3cb6f7[_0x30a274(0x137)],_0x32d7db,!![]);privilegeManager['setRights'](_0x29c97f,'/',['all']);const _0x56a9ec=new webdav[(_0x30a274(0x154))]({'httpAuthentication':new webdav[(_0x30a274(0x129))](userManager,'Default\x20realm'),'privilegeManager':privilegeManager});for(let _0x2e96e1=0x0;_0x2e96e1<_0x47741f['length'];_0x2e96e1++){_0x56a9ec[_0x30a274(0x16e)]('/'+_0x47741f[_0x2e96e1][_0x30a274(0x162)],new webdav[(_0x30a274(0x12c))](_0x47741f[_0x2e96e1][_0x30a274(0x123)]));}app[_0x30a274(0x11a)](webdav[_0x30a274(0x127)][_0x30a274(0x13b)]('/',_0x56a9ec));function _0x59f6f6(_0x320e2e){const _0x2c2b25=_0x30a274;myWebDavServer=app[_0x2c2b25(0x134)](_0x320e2e,()=>{const _0x3c5610=_0x2c2b25;console[_0x3c5610(0x166)]('WebDav\x20start\x20listen'),startHttps(app),dbConfigTable[_0x3c5610(0x125)](dbOther,{'title':_0x3c5610(0x10e),'value':JSON['stringify']({'state':_0x3c5610(0x12d),'port':_0x320e2e})});});}process['on'](_0x30a274(0x136),function(_0x221067){const _0x89e81f=_0x30a274;saveMsg(_0x89e81f(0x10f),_0x89e81f(0x112),_0x221067[_0x89e81f(0x13f)]),initWebDavShare();}),_0x59f6f6(_0x12129c);}else dbConfigTable[_0x30a274(0x125)](dbOther,{'title':_0x30a274(0x10e),'value':JSON[_0x30a274(0x12e)]({'state':_0x30a274(0x13c),'port':_0x12129c})});});}myWebDavServer?(app=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),httpsServer[_0x12a192(0x11c)](_0x50d373=>{const _0x5b549c=_0x12a192;console[_0x5b549c(0x166)](_0x5b549c(0x11b)),myWebDavServer[_0x5b549c(0x11c)](_0x15521a=>{myWebDavServer=null,_0x3ba490();});})):_0x3ba490();}process['on'](_0x13ae6d(0x122),_0x3cbb6b=>{const _0x45a6d5=_0x13ae6d;_0x3cbb6b[_0x45a6d5(0x147)]==_0x45a6d5(0x12b)&&_0x3cbb6b[_0x45a6d5(0x146)]==_0x45a6d5(0x143)&&initWebDavShare();}),initWebDavShare();