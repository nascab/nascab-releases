const _0x5afd6b=_0x57a1;(function(_0x3b0dde,_0x238356){const _0xab6d9d=_0x57a1,_0x527426=_0x3b0dde();while(!![]){try{const _0x168226=parseInt(_0xab6d9d(0x209))/0x1+-parseInt(_0xab6d9d(0x24b))/0x2+parseInt(_0xab6d9d(0x22a))/0x3+parseInt(_0xab6d9d(0x243))/0x4+-parseInt(_0xab6d9d(0x223))/0x5+parseInt(_0xab6d9d(0x222))/0x6+-parseInt(_0xab6d9d(0x1f5))/0x7*(parseInt(_0xab6d9d(0x23a))/0x8);if(_0x168226===_0x238356)break;else _0x527426['push'](_0x527426['shift']());}catch(_0x1ce352){_0x527426['push'](_0x527426['shift']());}}}(_0x2fc0,0xd0b94));let webdav=require(_0x5afd6b(0x205))['v2'],express=require('express');const config=require(_0x5afd6b(0x21f)),path=require(_0x5afd6b(0x235)),fs=require('fs'),Database=require(_0x5afd6b(0x239));let dbOther=new Database(config[_0x5afd6b(0x236)],{});process['title']=_0x5afd6b(0x208),dbOther['pragma'](_0x5afd6b(0x204));let dbConfigTable=require('../../db/dbConfigTable'),dbFileShare=require(_0x5afd6b(0x22b)),dbUserTable=require(_0x5afd6b(0x23d)),cryptoUtils=require(_0x5afd6b(0x21e)),app=null,myWebDavServer=null,userManager=new webdav[(_0x5afd6b(0x237))](),privilegeManager=new webdav[(_0x5afd6b(0x228))](),dbNoticeCenterTable=require(_0x5afd6b(0x244)),netUtils=require(_0x5afd6b(0x20b));const messageUtil=require('../../utils/messageUtil');let httpsServer;const https=require('https');let tls=require('tls');function testCertAndKeyMatch(_0x80e29a,_0x57690b){const _0x21bbdf=_0x5afd6b;try{return tls[_0x21bbdf(0x1fb)]({'cert':_0x80e29a,'key':_0x57690b}),!![];}catch(_0x36473b){return![];}}function saveMsg(_0x4a602b,_0xfe7f2d,_0x2a4ced){dbNoticeCenterTable['create'](dbOther,{'title':_0x4a602b,'level':_0xfe7f2d,'content':_0x2a4ced});}function _0x57a1(_0x5b2006,_0x533688){const _0x2fc0f4=_0x2fc0();return _0x57a1=function(_0x57a199,_0x4e549e){_0x57a199=_0x57a199-0x1f1;let _0x320405=_0x2fc0f4[_0x57a199];return _0x320405;},_0x57a1(_0x5b2006,_0x533688);}let getFreePort=function(_0x5cfa3b,_0xebb7f7){const _0x1da3f4=_0x5afd6b;netUtils[_0x1da3f4(0x20e)](_0x5cfa3b)[_0x1da3f4(0x240)](_0xd19d32=>{_0xd19d32?_0xebb7f7(_0x5cfa3b):(_0x5cfa3b=parseInt(_0x5cfa3b)+0x1,getFreePort(_0x5cfa3b,_0xebb7f7));})[_0x1da3f4(0x215)](_0x2ccecd=>{const _0x5e6b5e=_0x1da3f4;console[_0x5e6b5e(0x246)](_0x2ccecd),_0xebb7f7(_0x5cfa3b);});};async function startHttps(_0x44adc4){const _0x528ef9=_0x5afd6b;try{let _0x667e57=config[_0x528ef9(0x1f1)],_0x317c74=dbConfigTable[_0x528ef9(0x1f4)](dbOther,_0x528ef9(0x1f1));_0x317c74&&_0x317c74[_0x528ef9(0x229)]&&_0x317c74[_0x528ef9(0x229)]>0x0&&_0x317c74['value']<0xffff&&(_0x667e57=_0x317c74[_0x528ef9(0x229)]);let _0x25342f='',_0x2534da='';getFreePort(_0x667e57,async _0x16d46e=>{const _0x3048e3=_0x528ef9;try{console['log'](_0x3048e3(0x21a),_0x16d46e),_0x667e57=_0x16d46e;let _0x47f647=dbConfigTable[_0x3048e3(0x1f4)](dbOther,_0x3048e3(0x227));if(_0x47f647&&_0x47f647[_0x3048e3(0x229)]==0x1){console[_0x3048e3(0x246)](_0x3048e3(0x212));let _0x15cdbf=dbConfigTable[_0x3048e3(0x1f4)](dbOther,_0x3048e3(0x1fa));_0x15cdbf&&_0x15cdbf[_0x3048e3(0x229)]&&(_0x25342f=_0x15cdbf[_0x3048e3(0x229)]);let _0x46669c=dbConfigTable[_0x3048e3(0x1f4)](dbOther,'httpsKey');_0x46669c&&_0x46669c['value']&&(_0x2534da=_0x46669c[_0x3048e3(0x229)]);}else{console[_0x3048e3(0x246)](_0x3048e3(0x200));let _0x40ab77=dbConfigTable[_0x3048e3(0x1f4)](dbOther,_0x3048e3(0x201));_0x40ab77&&_0x40ab77[_0x3048e3(0x229)]&&(_0x25342f=_0x40ab77[_0x3048e3(0x229)]);let _0x40e3d2=dbConfigTable['findByTitle'](dbOther,_0x3048e3(0x1ff));_0x40e3d2&&_0x40e3d2[_0x3048e3(0x229)]&&(_0x2534da=_0x40e3d2[_0x3048e3(0x229)]);}if(!_0x25342f){console['log']('webdav使用默认证书');let _0x5e7a3c=path[_0x3048e3(0x21b)](config[_0x3048e3(0x219)],'certs','cert.pem');if(!fs['existsSync'](_0x5e7a3c))return messageUtil['saveMsg'](dbOther,_0x3048e3(0x1fe),'error','HTTPS\x20certs\x20not\x20exist');_0x25342f=fs[_0x3048e3(0x23e)](_0x5e7a3c)[_0x3048e3(0x202)]();}if(!_0x2534da){let _0x5c6e37=path[_0x3048e3(0x21b)](config['appRootPath'],_0x3048e3(0x1f3),_0x3048e3(0x218));if(!fs[_0x3048e3(0x22d)](_0x5c6e37))return messageUtil[_0x3048e3(0x238)](dbOther,_0x3048e3(0x1fe),'error',_0x3048e3(0x245));_0x2534da=fs[_0x3048e3(0x23e)](_0x5c6e37)[_0x3048e3(0x202)]();}if(!_0x25342f[_0x3048e3(0x1f8)]('-----'))try{_0x25342f=await cryptoUtils[_0x3048e3(0x207)](_0x3048e3(0x20c),_0x25342f),_0x2534da=await cryptoUtils[_0x3048e3(0x207)](_0x3048e3(0x20c),_0x2534da);}catch(_0x4dd669){console[_0x3048e3(0x246)](_0x4dd669);}const _0x2858f8=testCertAndKeyMatch(_0x25342f,_0x2534da);if(!_0x2858f8)return messageUtil['saveMsg'](dbOther,_0x3048e3(0x1fe),_0x3048e3(0x231),'HTTPS\x20certs\x20not\x20exist');const _0x573201={'cert':_0x25342f,'key':_0x2534da};httpsServer=https[_0x3048e3(0x241)](_0x573201,_0x44adc4),httpsServer[_0x3048e3(0x210)](_0x667e57,_0x35102a=>{const _0x41831d=_0x3048e3;console[_0x41831d(0x246)](_0x35102a),console[_0x41831d(0x246)]('WebDav\x20https\x20service\x20is\x20running,port:',_0x667e57),dbConfigTable[_0x41831d(0x1f6)](dbOther,{'title':_0x41831d(0x221),'value':JSON['stringify']({'state':_0x41831d(0x214),'port':_0x667e57})});}),httpsServer['on'](_0x3048e3(0x231),_0x10f5ed=>{const _0x5e4d97=_0x3048e3;return console[_0x5e4d97(0x246)](_0x5e4d97(0x248),_0x10f5ed),dbConfigTable[_0x5e4d97(0x1f6)](dbOther,{'title':_0x5e4d97(0x221),'value':JSON[_0x5e4d97(0x1f9)]({'state':_0x5e4d97(0x1fd),'port':_0x667e57})}),messageUtil[_0x5e4d97(0x238)](dbOther,'WebDav\x20https\x20error','error',_0x10f5ed[_0x5e4d97(0x21d)]||_0x10f5ed[_0x5e4d97(0x213)]);});}catch(_0x7900a2){return console[_0x3048e3(0x246)](_0x7900a2),messageUtil[_0x3048e3(0x238)](dbOther,_0x3048e3(0x1fe),_0x3048e3(0x231),_0x7900a2['stack']||_0x7900a2[_0x3048e3(0x213)]);}});}catch(_0x2f3311){return console['log'](_0x2f3311),messageUtil[_0x528ef9(0x238)](dbOther,_0x528ef9(0x1fe),_0x528ef9(0x231),_0x2f3311[_0x528ef9(0x21d)]||_0x2f3311[_0x528ef9(0x213)]);}}function initWebDavShare(){const _0x1d4401=_0x5afd6b;let _0x121508=dbFileShare[_0x1d4401(0x217)](dbOther,_0x1d4401(0x220),[]),_0x1430d5='webDavPort',_0x593061=config[_0x1d4401(0x234)],_0x2572f6=dbConfigTable[_0x1d4401(0x1f4)](dbOther,_0x1430d5);if(_0x2572f6){let _0x3ce267=parseInt(_0x2572f6['value']);if(_0x3ce267<=0x0||_0x3ce267>0xffff){}else _0x593061=_0x3ce267;}function _0x3cee18(){getFreePort(_0x593061,async _0x42867c=>{const _0x1375bf=_0x57a1;if(_0x121508&&_0x121508['length']>0x0){app=express();for(let _0x781a77=0x0;_0x781a77<_0x121508['length'];_0x781a77++){let _0x2a259d=_0x121508[_0x781a77],_0x12da06=dbFileShare[_0x1375bf(0x226)](dbOther,_0x2a259d['id']);if(_0x12da06&&_0x12da06[_0x1375bf(0x23c)]>0x0)for(let _0x9fe7eb=0x0;_0x9fe7eb<_0x12da06[_0x1375bf(0x23c)];_0x9fe7eb++){let _0xe118e3=dbUserTable[_0x1375bf(0x211)](dbOther,_0x12da06[_0x9fe7eb]['user_id']);if(_0xe118e3){let _0x39e16f=await cryptoUtils[_0x1375bf(0x207)](config[_0x1375bf(0x1f7)],_0xe118e3[_0x1375bf(0x242)]),_0xb85809=userManager[_0x1375bf(0x24a)](_0xe118e3[_0x1375bf(0x23f)],_0x39e16f,parseInt(_0xe118e3[_0x1375bf(0x225)])==0x1);privilegeManager[_0x1375bf(0x203)](_0xb85809,'/'+_0x121508[_0x781a77]['path_sign'],['all']);}}}let _0x57fcb2=dbUserTable[_0x1375bf(0x20f)](dbOther);if(!_0x57fcb2)return;let _0x329ca7=await cryptoUtils[_0x1375bf(0x207)](config[_0x1375bf(0x1f7)],_0x57fcb2['password']),_0x4b4436=userManager['addUser'](_0x57fcb2[_0x1375bf(0x23f)],_0x329ca7,!![]);privilegeManager['setRights'](_0x4b4436,'/',[_0x1375bf(0x232)]);const _0x8322d2=new webdav['WebDAVServer']({'httpAuthentication':new webdav[(_0x1375bf(0x206))](userManager,_0x1375bf(0x22f)),'privilegeManager':privilegeManager});for(let _0xdf420d=0x0;_0xdf420d<_0x121508[_0x1375bf(0x23c)];_0xdf420d++){_0x8322d2[_0x1375bf(0x233)]('/'+_0x121508[_0xdf420d]['path_sign'],new webdav[(_0x1375bf(0x1fc))](_0x121508[_0xdf420d][_0x1375bf(0x235)]));}app[_0x1375bf(0x20a)](webdav[_0x1375bf(0x247)][_0x1375bf(0x22c)]('/',_0x8322d2));function _0x3ba033(_0x237aa5){const _0x4e9c40=_0x1375bf;myWebDavServer=app[_0x4e9c40(0x210)](_0x237aa5,()=>{const _0x152758=_0x4e9c40;console[_0x152758(0x246)](_0x152758(0x21c)),startHttps(app),dbConfigTable[_0x152758(0x1f6)](dbOther,{'title':'webDavServer','value':JSON['stringify']({'state':_0x152758(0x214),'port':_0x237aa5})});});}process['on'](_0x1375bf(0x20d),function(_0x3bed5a){const _0x5e31cb=_0x1375bf;saveMsg(_0x5e31cb(0x216),_0x5e31cb(0x231),_0x3bed5a[_0x5e31cb(0x22e)]),initWebDavShare();}),_0x3ba033(_0x42867c);}else dbConfigTable['create'](dbOther,{'title':_0x1375bf(0x23b),'value':JSON[_0x1375bf(0x1f9)]({'state':_0x1375bf(0x1fd),'port':_0x42867c})});});}myWebDavServer?(app=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav[(_0x1d4401(0x228))](),httpsServer[_0x1d4401(0x224)](_0xbc36e8=>{const _0x453bc8=_0x1d4401;console[_0x453bc8(0x246)](_0x453bc8(0x249)),myWebDavServer['close'](_0x32e7d5=>{myWebDavServer=null,_0x3cee18();});})):_0x3cee18();}process['on'](_0x5afd6b(0x213),_0x44d1e8=>{const _0x244420=_0x5afd6b;_0x44d1e8[_0x244420(0x230)]==_0x244420(0x1f2)&&_0x44d1e8['shareType']=='WebDav'&&initWebDavShare();}),initWebDavShare();function _0x2fc0(){const _0x4d54a7=['value','4191639YKIVjp','../../db/dbFileShare','express','existsSync','code','Default\x20realm','type','error','all','setFileSystem','webDavPort','path','dbOther','SimpleUserManager','saveMsg','better-sqlite3','27472592iBSEfv','webDavServer','length','../../db/dbUserTable','readFileSync','username','then','createServer','password','1662372VapKqG','../../db/dbNoticeCenterTable','HTTPS\x20certs\x20not\x20exist','log','extensions','WebDav\x20https\x20error\x20','webdav\x20https\x20已关闭','addUser','346036lsLUVE','webDavPortHttps','fileShareRestart','certs','findByTitle','7zUCrgG','create','passwordKey','startsWith','stringify','httpsCert','createSecureContext','PhysicalFileSystem','stop','WebDav\x20https\x20error','webDavHttpsKey','webdav使用自己设置的证书','webDavHttpsCert','toString','setRights','journal_mode\x20=\x20WAL','webdav-server','HTTPDigestAuthentication','decryptString','NasCabWebDavWorker','1380724SMalSl','use','../../express-server/utils/netUtils','nasZs987bac','uncaughtException','isPortFree','getAdmin','listen','find','webdav使用和api相同的证书','message','run','catch','WebDav\x20Start\x20failed','getAllByWhere','key.pem','appRootPath','Starting\x20WebDav\x20http\x20on\x20port','join','WebDav\x20start\x20listen','stack','../../express-server/utils/cryptoUtils','../../myConfig/config','\x20server_type=\x27WebDav\x27','webDavHttpsServer','9448554PcfDMW','1531325isdZZT','close','is_admin','getSharesUserByShareId','webDavUseApiCert','SimplePathPrivilegeManager'];_0x2fc0=function(){return _0x4d54a7;};return _0x2fc0();}