const _0x33bacf=_0x1878;(function(_0x495ccd,_0x898726){const _0x3ebe24=_0x1878,_0x293161=_0x495ccd();while(!![]){try{const _0x14b899=-parseInt(_0x3ebe24(0x174))/0x1*(parseInt(_0x3ebe24(0x139))/0x2)+parseInt(_0x3ebe24(0x156))/0x3+parseInt(_0x3ebe24(0x14c))/0x4+-parseInt(_0x3ebe24(0x165))/0x5+parseInt(_0x3ebe24(0x12f))/0x6+parseInt(_0x3ebe24(0x167))/0x7*(-parseInt(_0x3ebe24(0x154))/0x8)+parseInt(_0x3ebe24(0x12b))/0x9;if(_0x14b899===_0x898726)break;else _0x293161['push'](_0x293161['shift']());}catch(_0x2082d4){_0x293161['push'](_0x293161['shift']());}}}(_0x205f,0xac22d));let webdav=require('webdav-server')['v2'],express=require(_0x33bacf(0x153));const config=require(_0x33bacf(0x12a)),path=require(_0x33bacf(0x166)),fs=require('fs'),Database=require(_0x33bacf(0x12e));let dbOther=new Database(config['dbOther'],{});process['title']='NasCabWebDavWorker',dbOther[_0x33bacf(0x135)](_0x33bacf(0x162));let dbConfigTable=require('../../db/dbConfigTable'),dbFileShare=require(_0x33bacf(0x15f)),dbUserTable=require('../../db/dbUserTable'),cryptoUtils=require(_0x33bacf(0x140)),app=null,myWebDavServer=null,userManager=new webdav[(_0x33bacf(0x179))](),privilegeManager=new webdav[(_0x33bacf(0x176))](),dbNoticeCenterTable=require('../../db/dbNoticeCenterTable'),netUtils=require('../../express-server/utils/netUtils');const messageUtil=require('../../utils/messageUtil');let httpsServer;const https=require(_0x33bacf(0x15e));function _0x205f(){const _0x197847=['webDavPortHttps','WebDav\x20https\x20error\x20','extensions','https','../../db/dbFileShare','Default\x20realm','log','journal_mode\x20=\x20WAL','use','WebDAVServer','5883445vGsjlE','path','119dslykG','key.pem','close','webdav使用和api相同的证书','WebDav\x20https\x20error','-----','toString','startsWith','create','webdav使用默认证书','webDavHttpsServer','getAllByWhere','HTTPS\x20certs\x20not\x20exist','634307guiIXE','length','SimplePathPrivilegeManager','path_sign','isPortFree','SimpleUserManager','all','cert.pem','stack','join','appRootPath','webDavUseApiCert','decryptString','addUser','../../myConfig/config','2129967ShDAuM','existsSync','find','better-sqlite3','2580636tYctAM','WebDav\x20start\x20listen','HTTPDigestAuthentication','error','webDavHttpsKey','webDavPort','pragma','getSharesUserByShareId','password','type','2DwESyX','uncaughtException','WebDav','WebDav\x20Start\x20failed','PhysicalFileSystem','nasZs987bac','createSecureContext','../../express-server/utils/cryptoUtils','webdav使用自己设置的证书','passwordKey','readFileSync','run','saveMsg','httpsKey','message','\x20server_type=\x27WebDav\x27','value','WebDav\x20https\x20service\x20is\x20running,port:','certs','5266152kzpApN','httpsCert','createServer','is_admin','findByTitle','tls','shareType','express','353824Zkxwxe','listen','3853902vLXLOE','getAdmin','catch','stringify','user_id'];_0x205f=function(){return _0x197847;};return _0x205f();}let tls=require(_0x33bacf(0x151));function testCertAndKeyMatch(_0x3eedba,_0x5f2fe9){const _0x5ded40=_0x33bacf;try{return tls[_0x5ded40(0x13f)]({'cert':_0x3eedba,'key':_0x5f2fe9}),!![];}catch(_0xa2e62c){return![];}}function saveMsg(_0x56ac73,_0x31bbc9,_0x1e1a34){const _0x197152=_0x33bacf;dbNoticeCenterTable[_0x197152(0x16f)](dbOther,{'title':_0x56ac73,'level':_0x31bbc9,'content':_0x1e1a34});}let getFreePort=function(_0x5093d4,_0x1716d9){const _0x4cf932=_0x33bacf;netUtils[_0x4cf932(0x178)](_0x5093d4)['then'](_0x257b54=>{_0x257b54?_0x1716d9(_0x5093d4):(_0x5093d4=parseInt(_0x5093d4)+0x1,getFreePort(_0x5093d4,_0x1716d9));})[_0x4cf932(0x158)](_0x362a73=>{const _0x14a38b=_0x4cf932;console[_0x14a38b(0x161)](_0x362a73),_0x1716d9(_0x5093d4);});};async function startHttps(_0x21b3bf){const _0x56180d=_0x33bacf;try{let _0x3ddab6=config[_0x56180d(0x15b)],_0x417dcf=dbConfigTable[_0x56180d(0x150)](dbOther,_0x56180d(0x15b));_0x417dcf&&_0x417dcf['value']&&_0x417dcf[_0x56180d(0x149)]>0x0&&_0x417dcf[_0x56180d(0x149)]<0xffff&&(_0x3ddab6=_0x417dcf[_0x56180d(0x149)]);let _0xa6b980='',_0x5b4ebb='';getFreePort(_0x3ddab6,async _0x16f851=>{const _0x15eec1=_0x56180d;try{console['log']('Starting\x20WebDav\x20http\x20on\x20port',_0x16f851),_0x3ddab6=_0x16f851;let _0x1a1416=dbConfigTable['findByTitle'](dbOther,_0x15eec1(0x127));if(_0x1a1416&&_0x1a1416[_0x15eec1(0x149)]==0x1){console['log'](_0x15eec1(0x16a));let _0x40594e=dbConfigTable[_0x15eec1(0x150)](dbOther,_0x15eec1(0x14d));_0x40594e&&_0x40594e[_0x15eec1(0x149)]&&(_0xa6b980=_0x40594e[_0x15eec1(0x149)]);let _0x22d959=dbConfigTable[_0x15eec1(0x150)](dbOther,_0x15eec1(0x146));_0x22d959&&_0x22d959[_0x15eec1(0x149)]&&(_0x5b4ebb=_0x22d959['value']);}else{console[_0x15eec1(0x161)](_0x15eec1(0x141));let _0xbe5839=dbConfigTable['findByTitle'](dbOther,'webDavHttpsCert');_0xbe5839&&_0xbe5839[_0x15eec1(0x149)]&&(_0xa6b980=_0xbe5839[_0x15eec1(0x149)]);let _0x1904a8=dbConfigTable[_0x15eec1(0x150)](dbOther,_0x15eec1(0x133));_0x1904a8&&_0x1904a8[_0x15eec1(0x149)]&&(_0x5b4ebb=_0x1904a8[_0x15eec1(0x149)]);}if(!_0xa6b980){console[_0x15eec1(0x161)](_0x15eec1(0x170));let _0xc708b4=path[_0x15eec1(0x125)](config['appRootPath'],_0x15eec1(0x14b),_0x15eec1(0x123));if(!fs[_0x15eec1(0x12c)](_0xc708b4))return messageUtil[_0x15eec1(0x145)](dbOther,'WebDav\x20https\x20error',_0x15eec1(0x132),_0x15eec1(0x173));_0xa6b980=fs[_0x15eec1(0x143)](_0xc708b4)[_0x15eec1(0x16d)]();}if(!_0x5b4ebb){let _0x294e7d=path[_0x15eec1(0x125)](config[_0x15eec1(0x126)],_0x15eec1(0x14b),_0x15eec1(0x168));if(!fs[_0x15eec1(0x12c)](_0x294e7d))return messageUtil[_0x15eec1(0x145)](dbOther,_0x15eec1(0x16b),_0x15eec1(0x132),_0x15eec1(0x173));_0x5b4ebb=fs['readFileSync'](_0x294e7d)['toString']();}if(!_0xa6b980[_0x15eec1(0x16e)](_0x15eec1(0x16c)))try{_0xa6b980=await cryptoUtils[_0x15eec1(0x128)](_0x15eec1(0x13e),_0xa6b980),_0x5b4ebb=await cryptoUtils[_0x15eec1(0x128)]('nasZs987bac',_0x5b4ebb);}catch(_0x1ad67b){console['log'](_0x1ad67b);}const _0xdd991b=testCertAndKeyMatch(_0xa6b980,_0x5b4ebb);if(!_0xdd991b)return messageUtil[_0x15eec1(0x145)](dbOther,_0x15eec1(0x16b),_0x15eec1(0x132),_0x15eec1(0x173));const _0x20887f={'cert':_0xa6b980,'key':_0x5b4ebb};httpsServer=https[_0x15eec1(0x14e)](_0x20887f,_0x21b3bf),httpsServer[_0x15eec1(0x155)](_0x3ddab6,_0x5da4a6=>{const _0x5d682c=_0x15eec1;console[_0x5d682c(0x161)](_0x5da4a6),console[_0x5d682c(0x161)](_0x5d682c(0x14a),_0x3ddab6),dbConfigTable[_0x5d682c(0x16f)](dbOther,{'title':_0x5d682c(0x171),'value':JSON[_0x5d682c(0x159)]({'state':_0x5d682c(0x144),'port':_0x3ddab6})});}),httpsServer['on'](_0x15eec1(0x132),_0x34949a=>{const _0x1de2f4=_0x15eec1;return console[_0x1de2f4(0x161)](_0x1de2f4(0x15c),_0x34949a),dbConfigTable[_0x1de2f4(0x16f)](dbOther,{'title':_0x1de2f4(0x171),'value':JSON[_0x1de2f4(0x159)]({'state':'stop','port':_0x3ddab6})}),messageUtil[_0x1de2f4(0x145)](dbOther,'WebDav\x20https\x20error',_0x1de2f4(0x132),_0x34949a[_0x1de2f4(0x124)]||_0x34949a[_0x1de2f4(0x147)]);});}catch(_0xb9e53e){return console['log'](_0xb9e53e),messageUtil[_0x15eec1(0x145)](dbOther,_0x15eec1(0x16b),'error',_0xb9e53e[_0x15eec1(0x124)]||_0xb9e53e[_0x15eec1(0x147)]);}});}catch(_0x511774){return console[_0x56180d(0x161)](_0x511774),messageUtil[_0x56180d(0x145)](dbOther,_0x56180d(0x16b),'error',_0x511774['stack']||_0x511774[_0x56180d(0x147)]);}}function initWebDavShare(){const _0x1ff390=_0x33bacf;let _0x318556=dbFileShare[_0x1ff390(0x172)](dbOther,_0x1ff390(0x148),[]),_0x2ef2ae=_0x1ff390(0x134),_0x4afe9d=config[_0x1ff390(0x134)],_0x4005e3=dbConfigTable[_0x1ff390(0x150)](dbOther,_0x2ef2ae);if(_0x4005e3){let _0x4e5600=parseInt(_0x4005e3[_0x1ff390(0x149)]);if(_0x4e5600<=0x0||_0x4e5600>0xffff){}else _0x4afe9d=_0x4e5600;}function _0x1dd2de(){getFreePort(_0x4afe9d,async _0x549940=>{const _0xc400b8=_0x1878;if(_0x318556&&_0x318556['length']>0x0){app=express();for(let _0x3ad8c6=0x0;_0x3ad8c6<_0x318556[_0xc400b8(0x175)];_0x3ad8c6++){let _0x509894=_0x318556[_0x3ad8c6],_0x1703c0=dbFileShare[_0xc400b8(0x136)](dbOther,_0x509894['id']);if(_0x1703c0&&_0x1703c0[_0xc400b8(0x175)]>0x0)for(let _0x18e5be=0x0;_0x18e5be<_0x1703c0[_0xc400b8(0x175)];_0x18e5be++){let _0x3a349e=dbUserTable[_0xc400b8(0x12d)](dbOther,_0x1703c0[_0x18e5be][_0xc400b8(0x15a)]);if(_0x3a349e){let _0x48460a=await cryptoUtils[_0xc400b8(0x128)](config[_0xc400b8(0x142)],_0x3a349e['password']),_0x20d7d4=userManager[_0xc400b8(0x129)](_0x3a349e['username'],_0x48460a,parseInt(_0x3a349e[_0xc400b8(0x14f)])==0x1);privilegeManager['setRights'](_0x20d7d4,'/'+_0x318556[_0x3ad8c6][_0xc400b8(0x177)],['all']);}}}let _0xb709b=dbUserTable[_0xc400b8(0x157)](dbOther);if(!_0xb709b)return;let _0x3c184d=await cryptoUtils[_0xc400b8(0x128)](config['passwordKey'],_0xb709b[_0xc400b8(0x137)]),_0x4ad3b4=userManager[_0xc400b8(0x129)](_0xb709b['username'],_0x3c184d,!![]);privilegeManager['setRights'](_0x4ad3b4,'/',[_0xc400b8(0x122)]);const _0x4ec5c9=new webdav[(_0xc400b8(0x164))]({'httpAuthentication':new webdav[(_0xc400b8(0x131))](userManager,_0xc400b8(0x160)),'privilegeManager':privilegeManager});for(let _0x21412b=0x0;_0x21412b<_0x318556[_0xc400b8(0x175)];_0x21412b++){_0x4ec5c9['setFileSystem']('/'+_0x318556[_0x21412b][_0xc400b8(0x177)],new webdav[(_0xc400b8(0x13d))](_0x318556[_0x21412b]['path']));}app[_0xc400b8(0x163)](webdav[_0xc400b8(0x15d)][_0xc400b8(0x153)]('/',_0x4ec5c9));function _0x172540(_0x177656){myWebDavServer=app['listen'](_0x177656,()=>{const _0x1af8b5=_0x1878;console[_0x1af8b5(0x161)](_0x1af8b5(0x130)),startHttps(app),dbConfigTable['create'](dbOther,{'title':'webDavServer','value':JSON['stringify']({'state':_0x1af8b5(0x144),'port':_0x177656})});});}process['on'](_0xc400b8(0x13a),function(_0x28be58){const _0xcc7cfb=_0xc400b8;saveMsg(_0xcc7cfb(0x13c),'error',_0x28be58['code']),initWebDavShare();}),_0x172540(_0x549940);}else dbConfigTable[_0xc400b8(0x16f)](dbOther,{'title':'webDavServer','value':JSON[_0xc400b8(0x159)]({'state':'stop','port':_0x549940})});});}myWebDavServer?(app=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav[(_0x1ff390(0x176))](),httpsServer[_0x1ff390(0x169)](_0x462092=>{const _0xc9831c=_0x1ff390;console[_0xc9831c(0x161)]('webdav\x20https\x20已关闭'),myWebDavServer[_0xc9831c(0x169)](_0x25aeeb=>{myWebDavServer=null,_0x1dd2de();});})):_0x1dd2de();}function _0x1878(_0x1b0e65,_0x1e91bd){const _0x205fa6=_0x205f();return _0x1878=function(_0x187839,_0x3f5f94){_0x187839=_0x187839-0x122;let _0x1efcee=_0x205fa6[_0x187839];return _0x1efcee;},_0x1878(_0x1b0e65,_0x1e91bd);}process['on'](_0x33bacf(0x147),_0x471ff6=>{const _0x49af74=_0x33bacf;_0x471ff6[_0x49af74(0x138)]=='fileShareRestart'&&_0x471ff6[_0x49af74(0x152)]==_0x49af74(0x13b)&&initWebDavShare();}),initWebDavShare();