const _0x1f7f4d=_0x46a9;(function(_0x4f7e86,_0x219758){const _0x2c46d4=_0x46a9,_0x4bc651=_0x4f7e86();while(!![]){try{const _0x54f9a2=parseInt(_0x2c46d4(0x1cf))/0x1+-parseInt(_0x2c46d4(0x1f8))/0x2+-parseInt(_0x2c46d4(0x1f7))/0x3*(-parseInt(_0x2c46d4(0x1d8))/0x4)+-parseInt(_0x2c46d4(0x1da))/0x5+parseInt(_0x2c46d4(0x1e4))/0x6*(-parseInt(_0x2c46d4(0x21e))/0x7)+-parseInt(_0x2c46d4(0x231))/0x8+-parseInt(_0x2c46d4(0x221))/0x9*(-parseInt(_0x2c46d4(0x1e3))/0xa);if(_0x54f9a2===_0x219758)break;else _0x4bc651['push'](_0x4bc651['shift']());}catch(_0x2d9961){_0x4bc651['push'](_0x4bc651['shift']());}}}(_0x4149,0x4c0a5));let webdav=require(_0x1f7f4d(0x200))['v2'],express=require(_0x1f7f4d(0x1ef));const config=require(_0x1f7f4d(0x217)),path=require(_0x1f7f4d(0x1f5)),fs=require('fs'),Database=require(_0x1f7f4d(0x1d6));let dbOther=new Database(config['dbOther'],{});process[_0x1f7f4d(0x230)]=_0x1f7f4d(0x20e),dbOther[_0x1f7f4d(0x1d0)]('journal_mode\x20=\x20WAL');let dbConfigTable=require(_0x1f7f4d(0x210)),dbFileShare=require(_0x1f7f4d(0x1fd)),dbUserTable=require(_0x1f7f4d(0x232)),cryptoUtils=require(_0x1f7f4d(0x222)),app=null,myWebDavServer=null,userManager=new webdav[(_0x1f7f4d(0x20d))](),privilegeManager=new webdav[(_0x1f7f4d(0x216))](),dbNoticeCenterTable=require(_0x1f7f4d(0x20f)),netUtils=require(_0x1f7f4d(0x20b));const messageUtil=require(_0x1f7f4d(0x21f));let httpsServer;const https=require(_0x1f7f4d(0x1dd));let tls=require(_0x1f7f4d(0x207));function testCertAndKeyMatch(_0x1492f8,_0x1704dd){const _0x3718fa=_0x1f7f4d;try{return tls[_0x3718fa(0x1ec)]({'cert':_0x1492f8,'key':_0x1704dd}),!![];}catch(_0x1dd6c9){return![];}}function saveMsg(_0x58b4ad,_0x48437d,_0x4b8036){const _0x43afa1=_0x1f7f4d;dbNoticeCenterTable[_0x43afa1(0x1f2)](dbOther,{'title':_0x58b4ad,'level':_0x48437d,'content':_0x4b8036});}let getFreePort=function(_0x30127c,_0x228e11){const _0x4bd8f1=_0x1f7f4d;netUtils['isPortFree'](_0x30127c)[_0x4bd8f1(0x219)](_0x2ceea3=>{_0x2ceea3?_0x228e11(_0x30127c):(_0x30127c=parseInt(_0x30127c)+0x1,getFreePort(_0x30127c,_0x228e11));})[_0x4bd8f1(0x213)](_0x5d1fda=>{console['log'](_0x5d1fda),_0x228e11(_0x30127c);});};async function startHttps(_0x3d056d){const _0x2b0f3e=_0x1f7f4d;try{let _0x15123b=config[_0x2b0f3e(0x1d5)],_0xe40efb=dbConfigTable[_0x2b0f3e(0x229)](dbOther,_0x2b0f3e(0x1d5));_0xe40efb&&_0xe40efb[_0x2b0f3e(0x22a)]&&_0xe40efb['value']>0x0&&_0xe40efb[_0x2b0f3e(0x22a)]<0xffff&&(_0x15123b=_0xe40efb[_0x2b0f3e(0x22a)]);let _0x2cadb9='',_0x10c832='';getFreePort(_0x15123b,async _0x313989=>{const _0x2eec9e=_0x2b0f3e;try{console[_0x2eec9e(0x1f3)](_0x2eec9e(0x203),_0x313989),_0x15123b=_0x313989;let _0x1e51de=dbConfigTable['findByTitle'](dbOther,_0x2eec9e(0x223));if(_0x1e51de&&_0x1e51de[_0x2eec9e(0x22a)]==0x1){console[_0x2eec9e(0x1f3)](_0x2eec9e(0x224));let _0x5c9a1c=dbConfigTable[_0x2eec9e(0x229)](dbOther,_0x2eec9e(0x22c));_0x5c9a1c&&_0x5c9a1c['value']&&(_0x2cadb9=_0x5c9a1c[_0x2eec9e(0x22a)]);let _0x51b104=dbConfigTable['findByTitle'](dbOther,_0x2eec9e(0x211));_0x51b104&&_0x51b104[_0x2eec9e(0x22a)]&&(_0x10c832=_0x51b104['value']);}else{console[_0x2eec9e(0x1f3)](_0x2eec9e(0x1f6));let _0x5ac482=dbConfigTable['findByTitle'](dbOther,_0x2eec9e(0x202));_0x5ac482&&_0x5ac482[_0x2eec9e(0x22a)]&&(_0x2cadb9=_0x5ac482[_0x2eec9e(0x22a)]);let _0x3c0564=dbConfigTable[_0x2eec9e(0x229)](dbOther,_0x2eec9e(0x227));_0x3c0564&&_0x3c0564['value']&&(_0x10c832=_0x3c0564[_0x2eec9e(0x22a)]);}if(!_0x2cadb9){console[_0x2eec9e(0x1f3)]('webdav使用默认证书');let _0x516d72=path[_0x2eec9e(0x215)](config[_0x2eec9e(0x205)],_0x2eec9e(0x22f),_0x2eec9e(0x22d));if(!fs[_0x2eec9e(0x1fa)](_0x516d72))return messageUtil[_0x2eec9e(0x21b)](dbOther,'WebDav\x20https\x20error',_0x2eec9e(0x1de),_0x2eec9e(0x1eb));_0x2cadb9=fs['readFileSync'](_0x516d72)[_0x2eec9e(0x1ee)]();}if(!_0x10c832){let _0x25fa23=path[_0x2eec9e(0x215)](config[_0x2eec9e(0x205)],_0x2eec9e(0x22f),_0x2eec9e(0x212));if(!fs['existsSync'](_0x25fa23))return messageUtil[_0x2eec9e(0x21b)](dbOther,_0x2eec9e(0x1d3),_0x2eec9e(0x1de),_0x2eec9e(0x1eb));_0x10c832=fs[_0x2eec9e(0x1db)](_0x25fa23)[_0x2eec9e(0x1ee)]();}if(!_0x2cadb9['startsWith']('-----'))try{_0x2cadb9=await cryptoUtils[_0x2eec9e(0x214)]('nasZs987bac',_0x2cadb9),_0x10c832=await cryptoUtils[_0x2eec9e(0x214)](_0x2eec9e(0x201),_0x10c832);}catch(_0xcfa340){console[_0x2eec9e(0x1f3)](_0xcfa340);}const _0x13b113=testCertAndKeyMatch(_0x2cadb9,_0x10c832);if(!_0x13b113)return messageUtil[_0x2eec9e(0x21b)](dbOther,_0x2eec9e(0x1d3),_0x2eec9e(0x1de),_0x2eec9e(0x1eb));const _0x16111e={'cert':_0x2cadb9,'key':_0x10c832};httpsServer=https['createServer'](_0x16111e,_0x3d056d),httpsServer[_0x2eec9e(0x20c)](_0x15123b,_0x59ce85=>{const _0x5092d4=_0x2eec9e;console[_0x5092d4(0x1f3)](_0x59ce85),console[_0x5092d4(0x1f3)](_0x5092d4(0x1fc),_0x15123b),dbConfigTable[_0x5092d4(0x1f2)](dbOther,{'title':_0x5092d4(0x206),'value':JSON[_0x5092d4(0x1d4)]({'state':_0x5092d4(0x21a),'port':_0x15123b})});}),httpsServer['on'](_0x2eec9e(0x1de),_0x620fa1=>{const _0x54691c=_0x2eec9e;return console[_0x54691c(0x1f3)](_0x54691c(0x1ed),_0x620fa1),dbConfigTable[_0x54691c(0x1f2)](dbOther,{'title':'webDavHttpsServer','value':JSON[_0x54691c(0x1d4)]({'state':_0x54691c(0x1fe),'port':_0x15123b})}),messageUtil[_0x54691c(0x21b)](dbOther,_0x54691c(0x1d3),_0x54691c(0x1de),_0x620fa1[_0x54691c(0x1e0)]||_0x620fa1['message']);});}catch(_0x17e5a3){return console[_0x2eec9e(0x1f3)](_0x17e5a3),messageUtil[_0x2eec9e(0x21b)](dbOther,_0x2eec9e(0x1d3),_0x2eec9e(0x1de),_0x17e5a3['stack']||_0x17e5a3[_0x2eec9e(0x22e)]);}});}catch(_0x66e839){return console[_0x2b0f3e(0x1f3)](_0x66e839),messageUtil['saveMsg'](dbOther,_0x2b0f3e(0x1d3),_0x2b0f3e(0x1de),_0x66e839[_0x2b0f3e(0x1e0)]||_0x66e839[_0x2b0f3e(0x22e)]);}}function initWebDavShare(){const _0x1a7394=_0x1f7f4d;let _0xc95261=dbFileShare[_0x1a7394(0x21c)](dbOther,_0x1a7394(0x1d1),[]),_0x43f7b5=_0x1a7394(0x1d2),_0x1d084d=config[_0x1a7394(0x1d2)],_0xca7e8e=dbConfigTable[_0x1a7394(0x229)](dbOther,_0x43f7b5);if(_0xca7e8e){let _0x45b0c7=parseInt(_0xca7e8e[_0x1a7394(0x22a)]);if(_0x45b0c7<=0x0||_0x45b0c7>0xffff){}else _0x1d084d=_0x45b0c7;}function _0x496d28(){getFreePort(_0x1d084d,async _0x463da9=>{const _0x3b91f6=_0x46a9;if(_0xc95261&&_0xc95261[_0x3b91f6(0x225)]>0x0){app=express();for(let _0x203c0a=0x0;_0x203c0a<_0xc95261['length'];_0x203c0a++){let _0x4ec093=_0xc95261[_0x203c0a],_0x3be36f=dbFileShare[_0x3b91f6(0x1f1)](dbOther,_0x4ec093['id']);if(_0x3be36f&&_0x3be36f[_0x3b91f6(0x225)]>0x0)for(let _0x4facdb=0x0;_0x4facdb<_0x3be36f['length'];_0x4facdb++){let _0x24f6ff=dbUserTable[_0x3b91f6(0x1e7)](dbOther,_0x3be36f[_0x4facdb][_0x3b91f6(0x1e5)]);if(_0x24f6ff){let _0x4bccee=await cryptoUtils['decryptString'](config[_0x3b91f6(0x226)],_0x24f6ff[_0x3b91f6(0x1e9)]),_0x2ef729=userManager[_0x3b91f6(0x1e8)](_0x24f6ff[_0x3b91f6(0x1d9)],_0x4bccee,parseInt(_0x24f6ff[_0x3b91f6(0x1df)])==0x1);privilegeManager[_0x3b91f6(0x1ea)](_0x2ef729,'/'+_0xc95261[_0x203c0a][_0x3b91f6(0x1d7)],[_0x3b91f6(0x1e2)]);}}}let _0xb90b62=dbUserTable[_0x3b91f6(0x220)](dbOther);if(!_0xb90b62)return;let _0x3df552=await cryptoUtils[_0x3b91f6(0x214)](config[_0x3b91f6(0x226)],_0xb90b62['password']),_0x2b6f3f=userManager[_0x3b91f6(0x1e8)](_0xb90b62[_0x3b91f6(0x1d9)],_0x3df552,!![]);privilegeManager[_0x3b91f6(0x1ea)](_0x2b6f3f,'/',[_0x3b91f6(0x1e2)]);const _0x472666=new webdav[(_0x3b91f6(0x1dc))]({'httpAuthentication':new webdav[(_0x3b91f6(0x1e6))](userManager,_0x3b91f6(0x1e1)),'privilegeManager':privilegeManager});for(let _0x1a134a=0x0;_0x1a134a<_0xc95261[_0x3b91f6(0x225)];_0x1a134a++){_0x472666[_0x3b91f6(0x208)]('/'+_0xc95261[_0x1a134a][_0x3b91f6(0x1d7)],new webdav[(_0x3b91f6(0x22b))](_0xc95261[_0x1a134a][_0x3b91f6(0x1f5)]));}app[_0x3b91f6(0x1f0)](webdav[_0x3b91f6(0x21d)][_0x3b91f6(0x1ef)]('/',_0x472666));function _0x4415a1(_0x1a93bd){const _0x249839=_0x3b91f6;myWebDavServer=app[_0x249839(0x20c)](_0x1a93bd,()=>{const _0x112bc6=_0x249839;console[_0x112bc6(0x1f3)](_0x112bc6(0x209)),startHttps(app),dbConfigTable['create'](dbOther,{'title':_0x112bc6(0x20a),'value':JSON[_0x112bc6(0x1d4)]({'state':_0x112bc6(0x21a),'port':_0x1a93bd})});});}process['on'](_0x3b91f6(0x1f9),function(_0x4b5f35){const _0x45efe=_0x3b91f6;saveMsg(_0x45efe(0x228),_0x45efe(0x1de),_0x4b5f35[_0x45efe(0x218)]),initWebDavShare();}),_0x4415a1(_0x463da9);}else dbConfigTable[_0x3b91f6(0x1f2)](dbOther,{'title':_0x3b91f6(0x20a),'value':JSON[_0x3b91f6(0x1d4)]({'state':_0x3b91f6(0x1fe),'port':_0x463da9})});});}myWebDavServer?(app=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav[(_0x1a7394(0x216))](),httpsServer['close'](_0x445a59=>{const _0x3395df=_0x1a7394;console[_0x3395df(0x1f3)](_0x3395df(0x1f4)),myWebDavServer['close'](_0x572362=>{myWebDavServer=null,_0x496d28();});})):_0x496d28();}process['on']('message',_0x28084b=>{const _0x52d374=_0x1f7f4d;_0x28084b[_0x52d374(0x1fb)]==_0x52d374(0x204)&&_0x28084b[_0x52d374(0x1ff)]=='WebDav'&&initWebDavShare();}),initWebDavShare();function _0x46a9(_0x58dc1b,_0x4c16b9){const _0x414977=_0x4149();return _0x46a9=function(_0x46a94f,_0x2f7379){_0x46a94f=_0x46a94f-0x1cf;let _0x58322d=_0x414977[_0x46a94f];return _0x58322d;},_0x46a9(_0x58dc1b,_0x4c16b9);}function _0x4149(){const _0x4e7fbe=['WebDav\x20https\x20error','stringify','webDavPortHttps','better-sqlite3','path_sign','2472CVfleE','username','2887580XAgWwh','readFileSync','WebDAVServer','https','error','is_admin','stack','Default\x20realm','all','12310NktYSq','10752tBhQoz','user_id','HTTPDigestAuthentication','find','addUser','password','setRights','HTTPS\x20certs\x20not\x20exist','createSecureContext','WebDav\x20https\x20error\x20','toString','express','use','getSharesUserByShareId','create','log','webdav\x20https\x20已关闭','path','webdav使用自己设置的证书','705XEDHNI','1026698TXNHXi','uncaughtException','existsSync','type','WebDav\x20https\x20service\x20is\x20running,port:','../../db/dbFileShare','stop','shareType','webdav-server','nasZs987bac','webDavHttpsCert','Starting\x20WebDav\x20http\x20on\x20port','fileShareRestart','appRootPath','webDavHttpsServer','tls','setFileSystem','WebDav\x20start\x20listen','webDavServer','../../express-server/utils/netUtils','listen','SimpleUserManager','NasCabWebDavWorker','../../db/dbNoticeCenterTable','../../db/dbConfigTable','httpsKey','key.pem','catch','decryptString','join','SimplePathPrivilegeManager','../../myConfig/config','code','then','run','saveMsg','getAllByWhere','extensions','1337uYnTXr','../../utils/messageUtil','getAdmin','8928fWhAyY','../../express-server/utils/cryptoUtils','webDavUseApiCert','webdav使用和api相同的证书','length','passwordKey','webDavHttpsKey','WebDav\x20Start\x20failed','findByTitle','value','PhysicalFileSystem','httpsCert','cert.pem','message','certs','title','685184yojDTf','../../db/dbUserTable','463864PnNLQB','pragma','\x20server_type=\x27WebDav\x27','webDavPort'];_0x4149=function(){return _0x4e7fbe;};return _0x4149();}