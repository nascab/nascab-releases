const _0x313428=_0x280a;(function(_0x5be4c7,_0x831008){const _0x2e61a9=_0x280a,_0x5e24c1=_0x5be4c7();while(!![]){try{const _0x599010=parseInt(_0x2e61a9(0x182))/0x1+parseInt(_0x2e61a9(0x1a1))/0x2+-parseInt(_0x2e61a9(0x1a9))/0x3*(-parseInt(_0x2e61a9(0x18c))/0x4)+parseInt(_0x2e61a9(0x189))/0x5*(-parseInt(_0x2e61a9(0x18e))/0x6)+-parseInt(_0x2e61a9(0x1c3))/0x7+parseInt(_0x2e61a9(0x1bc))/0x8*(parseInt(_0x2e61a9(0x1a8))/0x9)+-parseInt(_0x2e61a9(0x194))/0xa;if(_0x599010===_0x831008)break;else _0x5e24c1['push'](_0x5e24c1['shift']());}catch(_0x202106){_0x5e24c1['push'](_0x5e24c1['shift']());}}}(_0x4553,0x7a200));const tfjs=require(_0x313428(0x1c9)),wasm=require(_0x313428(0x19c)),fileSys=require(_0x313428(0x16f)),cocoSsd=require(_0x313428(0x1af)),Database=require(_0x313428(0x1cb)),config=require(_0x313428(0x192)),dbConfigTable=require(_0x313428(0x1c5)),sharpUtil=require(_0x313428(0x179)),urlConfig=require('../../myConfig/urlConfig');let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x313428(0x1b4)],{});process['title']=_0x313428(0x1bf),dbOther[_0x313428(0x19e)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x313428(0x19e)]('journal_mode\x20=\x20WAL');const exifUtils=require(_0x313428(0x16d));process['on']('exit',()=>{const _0xc7906e=_0x313428;dbOther[_0xc7906e(0x187)](),dbFileIndex[_0xc7906e(0x187)]();});const fs=require('fs');let path=require(_0x313428(0x1c8));const https=require(_0x313428(0x1c1));let cocoSsdModel=null,modelSavePath=path['join'](config[_0x313428(0x1c2)],'tfModel',_0x313428(0x19f));!fs[_0x313428(0x1b3)](modelSavePath)&&fs[_0x313428(0x18f)](modelSavePath,{'recursive':!![]});let modelBaseUrl=urlConfig[_0x313428(0x16e)](dbOther,_0x313428(0x1b7)),modelFileUrlList=[],modelFileList=['group1-shard9of17',_0x313428(0x198),_0x313428(0x16b),_0x313428(0x1ae),_0x313428(0x1a4),_0x313428(0x168),'group1-shard15of17',_0x313428(0x1b9),_0x313428(0x17b),_0x313428(0x1c0),'tensorflowjs_model.pb',_0x313428(0x17c),'group1-shard1of17','group1-shard2of17',_0x313428(0x1b0),_0x313428(0x19d),_0x313428(0x172),_0x313428(0x199),_0x313428(0x1a6),'group1-shard8of17'];for(let i=0x0;i<modelFileList['length'];i++){modelFileUrlList['push'](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x1232f2,_0x4ffad6,_0x4cc1cf){return new Promise((_0x24214a,_0x58d3f0)=>{const _0x416e07=_0x280a;https[_0x416e07(0x1a7)](_0x1232f2,_0xdc703f=>{const _0x5c38e8=_0x416e07,_0x560df1=fs[_0x5c38e8(0x176)](_0x4ffad6);_0xdc703f['pipe'](_0x560df1),_0x560df1['on'](_0x5c38e8(0x1b5),()=>{const _0x30cefc=_0x5c38e8;_0x560df1[_0x30cefc(0x187)](),fs[_0x30cefc(0x17a)](_0x4ffad6,_0x4cc1cf),_0x24214a();})['on']('error',_0x241b72=>{const _0x179c48=_0x5c38e8;console[_0x179c48(0x16c)](_0x241b72);});})['on'](_0x416e07(0x184),_0x400ffb=>{const _0x59ba06=_0x416e07;_0x58d3f0(_0x400ffb[_0x59ba06(0x188)]);});});}function downloadModelFile(){return new Promise(async(_0x314fae,_0x265411)=>{const _0x43b6dd=_0x280a;try{for(let _0x47f774=0x0;_0x47f774<modelFileList[_0x43b6dd(0x18b)];_0x47f774++){let _0x115a23=path[_0x43b6dd(0x169)](modelSavePath,modelFileList[_0x47f774]),_0x3753fc=path[_0x43b6dd(0x169)](modelSavePath,_0x43b6dd(0x1ac)+modelFileList[_0x47f774]);if(!fs['existsSync'](_0x115a23)){let _0x218423=modelFileUrlList[_0x47f774];await httpDownload(_0x218423,_0x3753fc,_0x115a23);}else{}}_0x314fae();}catch(_0x408be0){_0x265411(_0x408be0);}});}async function loadModel(){return new Promise(async(_0x1e26f7,_0x526997)=>{const _0x110e87=_0x280a;try{if(!cocoSsdModel){await tfjs[_0x110e87(0x1c4)](_0x110e87(0x177)),await tfjs[_0x110e87(0x1b2)](),await downloadModelFile();let _0x3c47ce=path[_0x110e87(0x169)](modelSavePath,'model.json'),_0x73eb18=new fileSys[(_0x110e87(0x17d))](_0x3c47ce);cocoSsdModel=await cocoSsd[_0x110e87(0x17e)]({'modelUrl':_0x73eb18});let _0x402df7=new Date()[_0x110e87(0x1b8)]();_0x1e26f7();}else _0x1e26f7();}catch(_0x5a9add){console[_0x110e87(0x16c)](_0x5a9add),_0x526997(_0x5a9add);}});}function exitProcess(){const _0x4b0c01=_0x313428;try{bgTaskId&&dbOther['prepare'](_0x4b0c01(0x16a)+bgTaskId)['run']();}catch(_0x3e688c){}return process[_0x4b0c01(0x1ad)]({'type':'close'}),process['exit']();}function _0x280a(_0x574b00,_0x54e4fc){const _0x45530b=_0x4553();return _0x280a=function(_0x280acb,_0x29f7c3){_0x280acb=_0x280acb-0x168;let _0x24e837=_0x45530b[_0x280acb];return _0x24e837;},_0x280a(_0x574b00,_0x54e4fc);}function runInfinitCoCoSsd(){return new Promise(async _0x5ef0e5=>{const _0x416d5=_0x280a;let _0x45518b=0x32*0x400;dbFileIndex[_0x416d5(0x1c7)](_0x416d5(0x195)+_0x45518b)[_0x416d5(0x174)]();let _0x391ae2=dbFileIndex[_0x416d5(0x1c7)](_0x416d5(0x1aa)+_0x45518b+_0x416d5(0x196))['get']();if(!_0x391ae2)return exitProcess();try{bgTaskId&&dbOther['prepare'](_0x416d5(0x1a0)+bgTaskId)['run']();}catch(_0x48ff2d){}await loadModel();function _0x54c442(){const _0x4af169=_0x416d5;dbFileIndex['prepare'](_0x4af169(0x1c6)+_0x391ae2['id'])['run'](),_0x5ef0e5();}let _0x3e945b=path[_0x416d5(0x169)](_0x391ae2['path'],_0x391ae2['filename']);parseInt(_0x391ae2[_0x416d5(0x178)])==0x2&&(_0x3e945b=path[_0x416d5(0x169)](_0x391ae2['tiny_path'])),fs[_0x416d5(0x191)](_0x3e945b,async(_0x261471,_0x4e96bb)=>{const _0x28d0c4=_0x416d5;if(_0x261471||_0x4e96bb['size']>0x400*0x400*0x3c)return console[_0x28d0c4(0x16c)](_0x28d0c4(0x1b6)),_0x54c442();sharpUtil['transSpcielFormat'](_0x3e945b,(_0x50c94b,_0x5efc1d,_0x402cb4)=>{const _0x2a2c24=_0x28d0c4;let _0x2f0405=sharpUtil[_0x2a2c24(0x1cc)](_0x50c94b),_0x218f80=exifUtils[_0x2a2c24(0x1a2)](_0x402cb4);_0x218f80?_0x2f0405=_0x2f0405['rotate'](_0x218f80):_0x2f0405=_0x2f0405['rotate'](),_0x2f0405[_0x2a2c24(0x1bb)]({'width':0x7d0,'withoutEnlargement':!![]})['jpeg']()[_0x2a2c24(0x1ca)]()[_0x2a2c24(0x18d)]((_0x2e9275,_0x433af4,_0x1de6d2)=>{const _0x5650c4=_0x2a2c24;_0x5efc1d&&sharpUtil[_0x5650c4(0x175)](_0x50c94b);if(_0x2e9275)return _0x54c442();tfjs[_0x5650c4(0x180)]()[_0x5650c4(0x186)](),temp=tfjs[_0x5650c4(0x170)](_0x433af4,[_0x1de6d2[_0x5650c4(0x1bd)],_0x1de6d2[_0x5650c4(0x171)],_0x1de6d2[_0x5650c4(0x173)]]),tensor=tfjs[_0x5650c4(0x1ab)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x5650c4(0x1ba)](temp),_0x433af4=null,cocoSsdModel[_0x5650c4(0x183)](tensor)[_0x5650c4(0x1be)](_0x38dd7f=>{const _0x23c1da=_0x5650c4;tfjs[_0x23c1da(0x1ba)](tensor),tfjs['engine']()[_0x23c1da(0x181)]();for(let _0x4cdb17=0x0;_0x4cdb17<_0x38dd7f[_0x23c1da(0x18b)];_0x4cdb17++){let _0x201320=_0x23c1da(0x1a5),_0x2d46c5=_0x38dd7f[_0x4cdb17],_0x2fcbed=_0x2d46c5[_0x23c1da(0x18a)];for(let _0x5bcb7 in _0x2fcbed){if(_0x2fcbed[_0x5bcb7]<0x0)_0x2fcbed[_0x5bcb7]=0x0;}if(_0x2fcbed[0x3]*_0x2fcbed[0x4]<0x4e20)continue;let _0x1278ab='',_0x11cf5f=dbFileIndex[_0x23c1da(0x1c7)]('SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?')[_0x23c1da(0x1a7)](_0x2d46c5[_0x23c1da(0x190)],_0x201320);if(_0x11cf5f)_0x1278ab=_0x11cf5f['id'];else{let _0x6c8acd=dbFileIndex[_0x23c1da(0x1c7)](_0x23c1da(0x197))[_0x23c1da(0x174)](_0x2d46c5['class'],_0x201320);_0x1278ab=_0x6c8acd[_0x23c1da(0x1a3)];}dbFileIndex[_0x23c1da(0x1c7)]('REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)')[_0x23c1da(0x174)](_0x391ae2['id'],_0x1278ab,_0x201320,JSON[_0x23c1da(0x17f)](_0x2d46c5[_0x23c1da(0x18a)]),_0x2d46c5['score']);}_0x54c442();})[_0x5650c4(0x1b1)](_0x7ee85c=>{const _0x2eea9f=_0x5650c4;_0x5efc1d&&sharpUtil[_0x2eea9f(0x175)](_0x50c94b),tfjs[_0x2eea9f(0x1ba)](tensor),tfjs[_0x2eea9f(0x180)]()[_0x2eea9f(0x181)](),_0x54c442();});});});});});}let bgTaskId;function _0x4553(){const _0x19dbdc=['大于30mb的图像不处理','modeUrl_ai_classify','getTime','group1-shard16of17','dispose','resize','962072GKupgW','height','then','NasCabAiClassify','model.json','https','userDataFolder','3772440CivQrm','setBackend','../../db/dbConfigTable','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','prepare','path','@tensorflow/tfjs','raw','better-sqlite3','getSharpInstanceFromInput','group1-shard14of17','join','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','group1-shard11of17','log','../../utils/exifUtils','getUrlByUrlKey','./utils/file_system','tensor','width','group1-shard5of17','channels','run','deleteRawTempFile','createWriteStream','wasm','type','../../express-server/utils/sharpUtils','renameSync','group1-shard17of17','weights_manifest.json','NodeFileSystem','load','stringify','engine','endScope','127057wKXCts','detect','error','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','startScope','close','message','3350qcRPFd','bbox','length','2449456HDappD','toBuffer','1332wRuAEw','mkdirSync','class','stat','../../myConfig/config','AI_CLASSES','8768760LFzNMO','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','group1-shard10of17','group1-shard6of17','findByTitle','value','@tensorflow/tfjs-backend-wasm','group1-shard4of17','pragma','ssd_mobilenet_v2_1_default_1','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','1929124qlYRyn','getRotateFromTags','lastInsertRowid','group1-shard13of17','coco_ssd','group1-shard7of17','get','27zPLBjl','3ckwTct','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','slice','tmp_','send','group1-shard12of17','@tensorflow-models/coco-ssd','group1-shard3of17','catch','ready','existsSync','dbOther','finish'];_0x4553=function(){return _0x19dbdc;};return _0x4553();}try{let info=dbOther[_0x313428(0x1c7)](_0x313428(0x185))['run'](_0x313428(0x193));bgTaskId=info[_0x313428(0x1a3)];}catch(_0xb8beca){}async function runCoCoSsd(){const _0xf63919=_0x313428;let _0xf94fff=dbConfigTable[_0xf63919(0x19a)](dbOther,'aiClassesEnable');_0xf94fff&&_0xf94fff[_0xf63919(0x19b)]=='1'?runInfinitCoCoSsd()[_0xf63919(0x1be)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();