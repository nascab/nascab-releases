const _0x37075b=_0x52b5;(function(_0x1bc4dd,_0x495e0d){const _0x5b1692=_0x52b5,_0x419ac3=_0x1bc4dd();while(!![]){try{const _0x3df10d=parseInt(_0x5b1692(0x173))/0x1*(parseInt(_0x5b1692(0x1af))/0x2)+parseInt(_0x5b1692(0x1a1))/0x3+parseInt(_0x5b1692(0x194))/0x4*(-parseInt(_0x5b1692(0x1c2))/0x5)+parseInt(_0x5b1692(0x1bf))/0x6*(parseInt(_0x5b1692(0x19b))/0x7)+parseInt(_0x5b1692(0x1b7))/0x8+parseInt(_0x5b1692(0x1b8))/0x9+parseInt(_0x5b1692(0x183))/0xa*(-parseInt(_0x5b1692(0x175))/0xb);if(_0x3df10d===_0x495e0d)break;else _0x419ac3['push'](_0x419ac3['shift']());}catch(_0x2da12e){_0x419ac3['push'](_0x419ac3['shift']());}}}(_0x30aa,0x4b293));const tfjs=require('@tensorflow/tfjs'),wasm=require(_0x37075b(0x198)),fileSys=require(_0x37075b(0x1bb)),cocoSsd=require(_0x37075b(0x18b)),Database=require(_0x37075b(0x1d4)),config=require(_0x37075b(0x1b9)),dbConfigTable=require('../../db/dbConfigTable'),sharpUtil=require(_0x37075b(0x1a8)),urlConfig=require('../../myConfig/urlConfig');let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x37075b(0x19a)],{});process[_0x37075b(0x1ab)]=_0x37075b(0x171),dbOther[_0x37075b(0x1c7)](_0x37075b(0x185)),dbFileIndex['pragma'](_0x37075b(0x185));const exifUtils=require(_0x37075b(0x17f));function _0x30aa(){const _0x4758bf=['../../express-server/utils/sharpUtils','log','createWriteStream','title','setBackend','group1-shard2of17','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','2GzvwCb','group1-shard7of17','send','join','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','get','AI_CLASSES','3277544pNyLoE','5066379KRzRnr','../../myConfig/config','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','./utils/file_system','transSpcielFormat','rotate','detect','2820ZqvPxh','ready','engine','2188895Tcahcx','group1-shard15of17','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','NodeFileSystem','getUrlByUrlKey','pragma','push','bbox','tiny_path','deleteRawTempFile','load','slice','group1-shard11of17','channels','group1-shard4of17','stat','group1-shard8of17','length','better-sqlite3','group1-shard1of17','run','userDataFolder','NasCabAiClassify','group1-shard14of17','401656exgIKw','value','11VNmKUt','score','group1-shard17of17','size','prepare','exit','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','endScope','jpeg','existsSync','../../utils/exifUtils','coco_ssd','dispose','catch','7837150KgeAWe','error','journal_mode\x20=\x20WAL','ssd_mobilenet_v2_1_default_1','getTime','tfModel','group1-shard5of17','toBuffer','@tensorflow-models/coco-ssd','weights_manifest.json','getSharpInstanceFromInput','tensor','pipe','raw','filename','renameSync','getRotateFromTags','4jRIJCD','tensorflowjs_model.pb','lastInsertRowid','mkdirSync','@tensorflow/tfjs-backend-wasm','type','dbOther','1981aIHWTA','finish','group1-shard9of17','tmp_','wasm','resize','66189yvSIOS','大于30mb的图像不处理','https','close','group1-shard3of17','model.json','height'];_0x30aa=function(){return _0x4758bf;};return _0x30aa();}process['on']('exit',()=>{const _0x13bd83=_0x37075b;dbOther['close'](),dbFileIndex[_0x13bd83(0x1a4)]();});const fs=require('fs');let path=require('path');const https=require(_0x37075b(0x1a3));let cocoSsdModel=null,modelSavePath=path[_0x37075b(0x1b2)](config[_0x37075b(0x170)],_0x37075b(0x188),_0x37075b(0x186));!fs[_0x37075b(0x17e)](modelSavePath)&&fs[_0x37075b(0x197)](modelSavePath,{'recursive':!![]});let modelBaseUrl=urlConfig[_0x37075b(0x1c6)](dbOther,'modeUrl_ai_classify'),modelFileUrlList=[],modelFileList=[_0x37075b(0x19d),'group1-shard10of17',_0x37075b(0x1ce),'group1-shard12of17','group1-shard13of17',_0x37075b(0x172),_0x37075b(0x1c3),'group1-shard16of17',_0x37075b(0x177),_0x37075b(0x1a6),_0x37075b(0x195),_0x37075b(0x18c),_0x37075b(0x1d5),_0x37075b(0x1ad),_0x37075b(0x1a5),_0x37075b(0x1d0),_0x37075b(0x189),'group1-shard6of17',_0x37075b(0x1b0),_0x37075b(0x1d2)];for(let i=0x0;i<modelFileList[_0x37075b(0x1d3)];i++){modelFileUrlList[_0x37075b(0x1c8)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0xb8a0e5,_0x2910bc,_0xb8a469){return new Promise((_0x10c6cb,_0x5d695a)=>{const _0x2eb936=_0x52b5;https[_0x2eb936(0x1b5)](_0xb8a0e5,_0x556304=>{const _0xa9f513=_0x2eb936,_0x5ee90d=fs[_0xa9f513(0x1aa)](_0x2910bc);_0x556304[_0xa9f513(0x18f)](_0x5ee90d),_0x5ee90d['on'](_0xa9f513(0x19c),()=>{const _0x1b6bdc=_0xa9f513;_0x5ee90d[_0x1b6bdc(0x1a4)](),fs[_0x1b6bdc(0x192)](_0x2910bc,_0xb8a469),_0x10c6cb();})['on'](_0xa9f513(0x184),_0x36e6df=>{const _0x4d5f6f=_0xa9f513;console[_0x4d5f6f(0x1a9)](_0x36e6df);});})['on']('error',_0x30b589=>{_0x5d695a(_0x30b589['message']);});});}function downloadModelFile(){return new Promise(async(_0x30b0d2,_0xd43723)=>{const _0x37e52a=_0x52b5;try{for(let _0x3291a7=0x0;_0x3291a7<modelFileList[_0x37e52a(0x1d3)];_0x3291a7++){let _0x1ad6ec=path[_0x37e52a(0x1b2)](modelSavePath,modelFileList[_0x3291a7]),_0x40492b=path[_0x37e52a(0x1b2)](modelSavePath,_0x37e52a(0x19e)+modelFileList[_0x3291a7]);if(!fs[_0x37e52a(0x17e)](_0x1ad6ec)){let _0x26326b=modelFileUrlList[_0x3291a7];await httpDownload(_0x26326b,_0x40492b,_0x1ad6ec);}else{}}_0x30b0d2();}catch(_0x6d87d3){_0xd43723(_0x6d87d3);}});}async function loadModel(){return new Promise(async(_0x26c8c0,_0x2efd02)=>{const _0x4752a3=_0x52b5;try{if(!cocoSsdModel){await tfjs[_0x4752a3(0x1ac)](_0x4752a3(0x19f)),await tfjs[_0x4752a3(0x1c0)](),await downloadModelFile();let _0x328ecd=path[_0x4752a3(0x1b2)](modelSavePath,_0x4752a3(0x1a6)),_0x351535=new fileSys[(_0x4752a3(0x1c5))](_0x328ecd);cocoSsdModel=await cocoSsd[_0x4752a3(0x1cc)]({'modelUrl':_0x351535});let _0x53f7d0=new Date()[_0x4752a3(0x187)]();_0x26c8c0();}else _0x26c8c0();}catch(_0x2aa3b7){console['log'](_0x2aa3b7),_0x2efd02(_0x2aa3b7);}});}function exitProcess(){const _0x787e76=_0x37075b;try{bgTaskId&&dbOther['prepare']('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)[_0x787e76(0x16f)]();}catch(_0x3bf62c){}return process[_0x787e76(0x1b1)]({'type':_0x787e76(0x1a4)}),process[_0x787e76(0x17a)]();}function runInfinitCoCoSsd(){return new Promise(async _0x10d5a8=>{const _0x18f464=_0x52b5;let _0x373307=0x32*0x400;dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<='+_0x373307)[_0x18f464(0x16f)]();let _0x11c0e5=dbFileIndex[_0x18f464(0x179)]('SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>'+_0x373307+_0x18f464(0x1ba))[_0x18f464(0x1b5)]();if(!_0x11c0e5)return exitProcess();try{bgTaskId&&dbOther[_0x18f464(0x179)](_0x18f464(0x1c4)+bgTaskId)[_0x18f464(0x16f)]();}catch(_0x3979ca){}await loadModel();function _0xf4413e(){const _0x4164e3=_0x18f464;dbFileIndex[_0x4164e3(0x179)](_0x4164e3(0x1b3)+_0x11c0e5['id'])[_0x4164e3(0x16f)](),_0x10d5a8();}let _0x18e69b=path['join'](_0x11c0e5['path'],_0x11c0e5[_0x18f464(0x191)]);parseInt(_0x11c0e5[_0x18f464(0x199)])==0x2&&(_0x18e69b=path['join'](_0x11c0e5[_0x18f464(0x1ca)])),fs[_0x18f464(0x1d1)](_0x18e69b,async(_0x53bf81,_0x3797d2)=>{const _0x3e75cd=_0x18f464;if(_0x53bf81||_0x3797d2[_0x3e75cd(0x178)]>0x400*0x400*0x3c)return console[_0x3e75cd(0x1a9)](_0x3e75cd(0x1a2)),_0xf4413e();sharpUtil[_0x3e75cd(0x1bc)](_0x18e69b,(_0x5d59ce,_0x6710f,_0x51c5fd)=>{const _0x27b94f=_0x3e75cd;let _0xa601a3=sharpUtil[_0x27b94f(0x18d)](_0x5d59ce),_0x3fd1a9=exifUtils[_0x27b94f(0x193)](_0x51c5fd);_0x3fd1a9?_0xa601a3=_0xa601a3['rotate'](_0x3fd1a9):_0xa601a3=_0xa601a3[_0x27b94f(0x1bd)](),_0xa601a3[_0x27b94f(0x1a0)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x27b94f(0x17d)]()[_0x27b94f(0x190)]()[_0x27b94f(0x18a)]((_0x3de24c,_0x28db92,_0x290e32)=>{const _0x113b32=_0x27b94f;_0x6710f&&sharpUtil[_0x113b32(0x1cb)](_0x5d59ce);if(_0x3de24c)return _0xf4413e();tfjs[_0x113b32(0x1c1)]()['startScope'](),temp=tfjs[_0x113b32(0x18e)](_0x28db92,[_0x290e32[_0x113b32(0x1a7)],_0x290e32['width'],_0x290e32[_0x113b32(0x1cf)]]),tensor=tfjs[_0x113b32(0x1cd)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x113b32(0x181)](temp),_0x28db92=null,cocoSsdModel[_0x113b32(0x1be)](tensor)['then'](_0x2a5942=>{const _0x50e1ce=_0x113b32;tfjs['dispose'](tensor),tfjs[_0x50e1ce(0x1c1)]()['endScope']();for(let _0x14dbc2=0x0;_0x14dbc2<_0x2a5942[_0x50e1ce(0x1d3)];_0x14dbc2++){let _0x50cb2f=_0x50e1ce(0x180),_0x2a860a=_0x2a5942[_0x14dbc2],_0x3f2d5f=_0x2a860a['bbox'];for(let _0x55a22b in _0x3f2d5f){if(_0x3f2d5f[_0x55a22b]<0x0)_0x3f2d5f[_0x55a22b]=0x0;}if(_0x3f2d5f[0x3]*_0x3f2d5f[0x4]<0x4e20)continue;let _0xb4ac3c='',_0x2c13b7=dbFileIndex[_0x50e1ce(0x179)](_0x50e1ce(0x1b4))[_0x50e1ce(0x1b5)](_0x2a860a['class'],_0x50cb2f);if(_0x2c13b7)_0xb4ac3c=_0x2c13b7['id'];else{let _0x565358=dbFileIndex[_0x50e1ce(0x179)](_0x50e1ce(0x17b))['run'](_0x2a860a['class'],_0x50cb2f);_0xb4ac3c=_0x565358[_0x50e1ce(0x196)];}dbFileIndex[_0x50e1ce(0x179)]('REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)')['run'](_0x11c0e5['id'],_0xb4ac3c,_0x50cb2f,JSON['stringify'](_0x2a860a[_0x50e1ce(0x1c9)]),_0x2a860a[_0x50e1ce(0x176)]);}_0xf4413e();})[_0x113b32(0x182)](_0x29bc04=>{const _0x28acaf=_0x113b32;_0x6710f&&sharpUtil[_0x28acaf(0x1cb)](_0x5d59ce),tfjs[_0x28acaf(0x181)](tensor),tfjs[_0x28acaf(0x1c1)]()[_0x28acaf(0x17c)](),_0xf4413e();});});});});});}let bgTaskId;try{let info=dbOther['prepare'](_0x37075b(0x1ae))[_0x37075b(0x16f)](_0x37075b(0x1b6));bgTaskId=info['lastInsertRowid'];}catch(_0x3914ec){}async function runCoCoSsd(){const _0x58fb60=_0x37075b;let _0x48ef48=dbConfigTable['findByTitle'](dbOther,'aiClassesEnable');_0x48ef48&&_0x48ef48[_0x58fb60(0x174)]=='1'?runInfinitCoCoSsd()['then'](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}function _0x52b5(_0x4e538f,_0x297ff2){const _0x30aab5=_0x30aa();return _0x52b5=function(_0x52b5ff,_0x1eb093){_0x52b5ff=_0x52b5ff-0x16f;let _0x1def6b=_0x30aab5[_0x52b5ff];return _0x1def6b;},_0x52b5(_0x4e538f,_0x297ff2);}runCoCoSsd();