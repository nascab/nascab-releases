const _0x4fa371=_0x151f;(function(_0x34e921,_0x2d426e){const _0x1aa92f=_0x151f,_0x131bfa=_0x34e921();while(!![]){try{const _0x3816fb=parseInt(_0x1aa92f(0x155))/0x1*(parseInt(_0x1aa92f(0x16c))/0x2)+-parseInt(_0x1aa92f(0x189))/0x3+parseInt(_0x1aa92f(0x152))/0x4*(parseInt(_0x1aa92f(0x18f))/0x5)+parseInt(_0x1aa92f(0x191))/0x6*(-parseInt(_0x1aa92f(0x171))/0x7)+parseInt(_0x1aa92f(0x172))/0x8*(-parseInt(_0x1aa92f(0x17b))/0x9)+-parseInt(_0x1aa92f(0x180))/0xa*(-parseInt(_0x1aa92f(0x184))/0xb)+parseInt(_0x1aa92f(0x18c))/0xc;if(_0x3816fb===_0x2d426e)break;else _0x131bfa['push'](_0x131bfa['shift']());}catch(_0x43c074){_0x131bfa['push'](_0x131bfa['shift']());}}}(_0x3f55,0x938c6));const tfjs=require(_0x4fa371(0x1a9)),wasm=require(_0x4fa371(0x192)),fileSys=require(_0x4fa371(0x1ab)),cocoSsd=require(_0x4fa371(0x1aa)),Database=require('better-sqlite3'),config=require(_0x4fa371(0x157)),dbConfigTable=require(_0x4fa371(0x17c)),sharpUtil=require(_0x4fa371(0x17a)),urlConfig=require(_0x4fa371(0x14d));let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x4fa371(0x167)],{});process[_0x4fa371(0x166)]=_0x4fa371(0x162),dbOther['pragma'](_0x4fa371(0x196)),dbFileIndex['pragma'](_0x4fa371(0x196));const exifUtils=require(_0x4fa371(0x18a));process['on'](_0x4fa371(0x193),()=>{const _0x44f0d2=_0x4fa371;dbOther[_0x44f0d2(0x1a1)](),dbFileIndex[_0x44f0d2(0x1a1)]();});const fs=require('fs');let path=require('path');const https=require(_0x4fa371(0x15d));let cocoSsdModel=null,modelSavePath=path['join'](config[_0x4fa371(0x1a8)],_0x4fa371(0x190),'ssd_mobilenet_v2_1_default_1');!fs[_0x4fa371(0x15f)](modelSavePath)&&fs[_0x4fa371(0x156)](modelSavePath,{'recursive':!![]});function _0x3f55(){const _0x18de13=['group1-shard3of17','3669985QHDumL','tfModel','330pTaFgd','@tensorflow/tfjs-backend-wasm','exit','group1-shard17of17','model.json','journal_mode\x20=\x20WAL','aiClassesEnable','group1-shard14of17','length','prepare','group1-shard4of17','endScope','getSharpInstanceFromInput','weights_manifest.json','tiny_path','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','close','group1-shard5of17','detect','jpeg','group1-shard16of17','getUrlByUrlKey','send','userDataFolder','@tensorflow/tfjs','@tensorflow-models/coco-ssd','./utils/file_system','then','pipe','filename','stringify','class','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','deleteRawTempFile','group1-shard13of17','dispose','catch','size','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','../../myConfig/urlConfig','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','rotate','lastInsertRowid','join','4VxjfUc','AI_CLASSES','group1-shard6of17','32653blgjyx','mkdirSync','../../myConfig/config','ready','NodeFileSystem','coco_ssd','tensorflowjs_model.pb','大于30mb的图像不处理','https','log','existsSync','type','group1-shard15of17','NasCabAiClassify','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','bbox','push','title','dbOther','height','get','error','engine','24GLjdDI','path','run','transSpcielFormat','getRotateFromTags','79884KPFNvp','8ALkUkt','wasm','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','group1-shard8of17','finish','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','group1-shard12of17','../../express-server/utils/sharpUtils','3621771OIggfg','../../db/dbConfigTable','resize','group1-shard7of17','renameSync','20gmrCyV','getTime','toBuffer','group1-shard10of17','1633093dKbans','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','findByTitle','group1-shard1of17','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','648606loSUdW','../../utils/exifUtils','value','5134560ERvgIZ','setBackend'];_0x3f55=function(){return _0x18de13;};return _0x3f55();}let modelBaseUrl=urlConfig[_0x4fa371(0x1a6)](dbOther,'modeUrl_ai_classify'),modelFileUrlList=[],modelFileList=['group1-shard9of17',_0x4fa371(0x183),'group1-shard11of17',_0x4fa371(0x179),_0x4fa371(0x148),_0x4fa371(0x198),_0x4fa371(0x161),_0x4fa371(0x1a5),_0x4fa371(0x194),_0x4fa371(0x195),_0x4fa371(0x15b),_0x4fa371(0x19e),_0x4fa371(0x187),'group1-shard2of17',_0x4fa371(0x18e),_0x4fa371(0x19b),_0x4fa371(0x1a2),_0x4fa371(0x154),_0x4fa371(0x17e),_0x4fa371(0x175)];for(let i=0x0;i<modelFileList[_0x4fa371(0x199)];i++){modelFileUrlList[_0x4fa371(0x165)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x562006,_0x36c8f4,_0x3c627a){return new Promise((_0x133522,_0x54c489)=>{const _0x5ecf31=_0x151f;https[_0x5ecf31(0x169)](_0x562006,_0x74f235=>{const _0x17a86b=_0x5ecf31,_0x10edc1=fs['createWriteStream'](_0x36c8f4);_0x74f235[_0x17a86b(0x1ad)](_0x10edc1),_0x10edc1['on'](_0x17a86b(0x176),()=>{const _0x18ea24=_0x17a86b;_0x10edc1['close'](),fs[_0x18ea24(0x17f)](_0x36c8f4,_0x3c627a),_0x133522();})['on'](_0x17a86b(0x16a),_0x464b9b=>{const _0x16e941=_0x17a86b;console[_0x16e941(0x15e)](_0x464b9b);});})['on'](_0x5ecf31(0x16a),_0x1aea3c=>{_0x54c489(_0x1aea3c['message']);});});}function downloadModelFile(){return new Promise(async(_0x206eb1,_0x195d1c)=>{const _0xe01499=_0x151f;try{for(let _0x173053=0x0;_0x173053<modelFileList[_0xe01499(0x199)];_0x173053++){let _0x3a9cfa=path[_0xe01499(0x151)](modelSavePath,modelFileList[_0x173053]),_0x5029ec=path[_0xe01499(0x151)](modelSavePath,'tmp_'+modelFileList[_0x173053]);if(!fs[_0xe01499(0x15f)](_0x3a9cfa)){let _0x5e853b=modelFileUrlList[_0x173053];await httpDownload(_0x5e853b,_0x5029ec,_0x3a9cfa);}else{}}_0x206eb1();}catch(_0x440ff2){_0x195d1c(_0x440ff2);}});}async function loadModel(){return new Promise(async(_0x173392,_0x468196)=>{const _0xcfd0ba=_0x151f;try{if(!cocoSsdModel){await tfjs[_0xcfd0ba(0x18d)](_0xcfd0ba(0x173)),await tfjs[_0xcfd0ba(0x158)](),await downloadModelFile();let _0x409417=path[_0xcfd0ba(0x151)](modelSavePath,'model.json'),_0x31a39c=new fileSys[(_0xcfd0ba(0x159))](_0x409417);cocoSsdModel=await cocoSsd['load']({'modelUrl':_0x31a39c});let _0x24ac5f=new Date()[_0xcfd0ba(0x181)]();_0x173392();}else _0x173392();}catch(_0x913394){console['log'](_0x913394),_0x468196(_0x913394);}});}function exitProcess(){const _0x268b28=_0x4fa371;try{bgTaskId&&dbOther[_0x268b28(0x19a)](_0x268b28(0x163)+bgTaskId)[_0x268b28(0x16e)]();}catch(_0x347f33){}return process[_0x268b28(0x1a7)]({'type':'close'}),process[_0x268b28(0x193)]();}function runInfinitCoCoSsd(){return new Promise(async _0x31ae57=>{const _0x4403cc=_0x151f;let _0x4a5965=0x32*0x400;dbFileIndex[_0x4403cc(0x19a)](_0x4403cc(0x1a0)+_0x4a5965)[_0x4403cc(0x16e)]();let _0x1f46d0=dbFileIndex['prepare'](_0x4403cc(0x146)+_0x4a5965+_0x4403cc(0x174))['get']();if(!_0x1f46d0)return exitProcess();try{bgTaskId&&dbOther[_0x4403cc(0x19a)](_0x4403cc(0x178)+bgTaskId)[_0x4403cc(0x16e)]();}catch(_0x3ccd58){}await loadModel();function _0x53e4b1(){const _0x2f5a03=_0x4403cc;dbFileIndex['prepare'](_0x2f5a03(0x188)+_0x1f46d0['id'])[_0x2f5a03(0x16e)](),_0x31ae57();}let _0x13fe1e=path['join'](_0x1f46d0[_0x4403cc(0x16d)],_0x1f46d0[_0x4403cc(0x1ae)]);parseInt(_0x1f46d0[_0x4403cc(0x160)])==0x2&&(_0x13fe1e=path['join'](_0x1f46d0[_0x4403cc(0x19f)])),fs['stat'](_0x13fe1e,async(_0x25bc60,_0x2c517c)=>{const _0x12d7bb=_0x4403cc;if(_0x25bc60||_0x2c517c[_0x12d7bb(0x14b)]>0x400*0x400*0x3c)return console['log'](_0x12d7bb(0x15c)),_0x53e4b1();sharpUtil[_0x12d7bb(0x16f)](_0x13fe1e,(_0x434f94,_0x2ffe91,_0x1d3758)=>{const _0x7472ae=_0x12d7bb;let _0x21de51=sharpUtil[_0x7472ae(0x19d)](_0x434f94),_0x28a138=exifUtils[_0x7472ae(0x170)](_0x1d3758);_0x28a138?_0x21de51=_0x21de51[_0x7472ae(0x14f)](_0x28a138):_0x21de51=_0x21de51[_0x7472ae(0x14f)](),_0x21de51[_0x7472ae(0x17d)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x7472ae(0x1a4)]()['raw']()[_0x7472ae(0x182)]((_0x94973b,_0x49e62c,_0x1bc4b7)=>{const _0x37cb8d=_0x7472ae;_0x2ffe91&&sharpUtil['deleteRawTempFile'](_0x434f94);if(_0x94973b)return _0x53e4b1();tfjs[_0x37cb8d(0x16b)]()['startScope'](),temp=tfjs['tensor'](_0x49e62c,[_0x1bc4b7[_0x37cb8d(0x168)],_0x1bc4b7['width'],_0x1bc4b7['channels']]),tensor=tfjs['slice'](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x37cb8d(0x149)](temp),_0x49e62c=null,cocoSsdModel[_0x37cb8d(0x1a3)](tensor)[_0x37cb8d(0x1ac)](_0x23a358=>{const _0x22b5e3=_0x37cb8d;tfjs[_0x22b5e3(0x149)](tensor),tfjs['engine']()[_0x22b5e3(0x19c)]();for(let _0x59ac89=0x0;_0x59ac89<_0x23a358[_0x22b5e3(0x199)];_0x59ac89++){let _0x45fc9f=_0x22b5e3(0x15a),_0x4d0b51=_0x23a358[_0x59ac89],_0x109c4e=_0x4d0b51[_0x22b5e3(0x164)];for(let _0x1247ee in _0x109c4e){if(_0x109c4e[_0x1247ee]<0x0)_0x109c4e[_0x1247ee]=0x0;}if(_0x109c4e[0x3]*_0x109c4e[0x4]<0x4e20)continue;let _0x8ab84f='',_0x23a6ae=dbFileIndex['prepare'](_0x22b5e3(0x14e))['get'](_0x4d0b51[_0x22b5e3(0x145)],_0x45fc9f);if(_0x23a6ae)_0x8ab84f=_0x23a6ae['id'];else{let _0x4b28c1=dbFileIndex[_0x22b5e3(0x19a)](_0x22b5e3(0x185))[_0x22b5e3(0x16e)](_0x4d0b51[_0x22b5e3(0x145)],_0x45fc9f);_0x8ab84f=_0x4b28c1[_0x22b5e3(0x150)];}dbFileIndex['prepare'](_0x22b5e3(0x14c))[_0x22b5e3(0x16e)](_0x1f46d0['id'],_0x8ab84f,_0x45fc9f,JSON[_0x22b5e3(0x1af)](_0x4d0b51[_0x22b5e3(0x164)]),_0x4d0b51['score']);}_0x53e4b1();})[_0x37cb8d(0x14a)](_0x16f597=>{const _0x1e4497=_0x37cb8d;_0x2ffe91&&sharpUtil[_0x1e4497(0x147)](_0x434f94),tfjs[_0x1e4497(0x149)](tensor),tfjs[_0x1e4497(0x16b)]()[_0x1e4497(0x19c)](),_0x53e4b1();});});});});});}let bgTaskId;try{let info=dbOther['prepare'](_0x4fa371(0x177))[_0x4fa371(0x16e)](_0x4fa371(0x153));bgTaskId=info['lastInsertRowid'];}catch(_0x4a4308){}function _0x151f(_0x437748,_0x267d29){const _0x3f55d1=_0x3f55();return _0x151f=function(_0x151f2a,_0x1fc264){_0x151f2a=_0x151f2a-0x145;let _0x17f715=_0x3f55d1[_0x151f2a];return _0x17f715;},_0x151f(_0x437748,_0x267d29);}async function runCoCoSsd(){const _0xed485f=_0x4fa371;let _0x510d10=dbConfigTable[_0xed485f(0x186)](dbOther,_0xed485f(0x197));_0x510d10&&_0x510d10[_0xed485f(0x18b)]=='1'?runInfinitCoCoSsd()['then'](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();