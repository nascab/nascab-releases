const _0x121c2d=_0x5075;function _0x5075(_0x578a11,_0xeb5cf8){const _0x34093c=_0x3409();return _0x5075=function(_0x5075d6,_0x1a00d){_0x5075d6=_0x5075d6-0xae;let _0x1fed9d=_0x34093c[_0x5075d6];return _0x1fed9d;},_0x5075(_0x578a11,_0xeb5cf8);}(function(_0x9a0932,_0x36f024){const _0x1a6090=_0x5075,_0xccf4dd=_0x9a0932();while(!![]){try{const _0x6d4cb4=parseInt(_0x1a6090(0xe5))/0x1+-parseInt(_0x1a6090(0x10c))/0x2*(-parseInt(_0x1a6090(0xc6))/0x3)+parseInt(_0x1a6090(0xea))/0x4*(-parseInt(_0x1a6090(0xca))/0x5)+parseInt(_0x1a6090(0xee))/0x6+parseInt(_0x1a6090(0xb9))/0x7+-parseInt(_0x1a6090(0xbf))/0x8+-parseInt(_0x1a6090(0x105))/0x9*(parseInt(_0x1a6090(0xd3))/0xa);if(_0x6d4cb4===_0x36f024)break;else _0xccf4dd['push'](_0xccf4dd['shift']());}catch(_0x1723ee){_0xccf4dd['push'](_0xccf4dd['shift']());}}}(_0x3409,0xb9b64));const tfjs=require(_0x121c2d(0xdf)),wasm=require(_0x121c2d(0x104)),fileSys=require(_0x121c2d(0xbe)),cocoSsd=require(_0x121c2d(0xc1)),Database=require(_0x121c2d(0xcc)),config=require('../../myConfig/config'),dbConfigTable=require('../../db/dbConfigTable'),sharpUtil=require(_0x121c2d(0xe8)),urlConfig=require(_0x121c2d(0xd5));let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x121c2d(0xe7)],{});process[_0x121c2d(0xef)]=_0x121c2d(0xf5),dbOther[_0x121c2d(0x114)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x121c2d(0x114)](_0x121c2d(0xf0));const exifUtils=require('../../utils/exifUtils');process['on']('exit',()=>{const _0x1c1aa4=_0x121c2d;dbOther[_0x1c1aa4(0xb1)](),dbFileIndex[_0x1c1aa4(0xb1)]();});function _0x3409(){const _0x2ae91d=['pipe','exit','path','group1-shard1of17','jpeg','tensor','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','ready','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','@tensorflow/tfjs','getSharpInstanceFromInput','length','大于30mb的图像不处理','ssd_mobilenet_v2_1_default_1','tfModel','1204427qWXGKl','finish','dbOther','../../express-server/utils/sharpUtils','lastInsertRowid','4azIayG','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','group1-shard7of17','createWriteStream','217170mlIMUd','title','journal_mode\x20=\x20WAL','prepare','group1-shard6of17','size','group1-shard5of17','NasCabAiClassify','rotate','transSpcielFormat','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','group1-shard16of17','deleteRawTempFile','bbox','startScope','userDataFolder','wasm','push','detect','group1-shard14of17','join','https','@tensorflow/tfjs-backend-wasm','234LXfVRL','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','getRotateFromTags','modeUrl_ai_classify','group1-shard2of17','group1-shard13of17','catch','4aAppov','existsSync','height','engine','weights_manifest.json','channels','resize','coco_ssd','pragma','group1-shard11of17','then','run','group1-shard4of17','findByTitle','tmp_','value','close','width','raw','filename','toBuffer','dispose','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','aiClassesEnable','5737942dPsPGx','group1-shard12of17','class','slice','getUrlByUrlKey','./utils/file_system','4307016gugwWc','tensorflowjs_model.pb','@tensorflow-models/coco-ssd','mkdirSync','group1-shard17of17','error','group1-shard3of17','1649370iEZzNh','get','score','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','5414285NQdAwb','renameSync','better-sqlite3','NodeFileSystem','message','tiny_path','load','log','AI_CLASSES','299230tzRzRK','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','../../myConfig/urlConfig'];_0x3409=function(){return _0x2ae91d;};return _0x3409();}const fs=require('fs');let path=require(_0x121c2d(0xd8));const https=require(_0x121c2d(0x103));let cocoSsdModel=null,modelSavePath=path[_0x121c2d(0x102)](config[_0x121c2d(0xfd)],_0x121c2d(0xe4),_0x121c2d(0xe3));!fs['existsSync'](modelSavePath)&&fs[_0x121c2d(0xc2)](modelSavePath,{'recursive':!![]});let modelBaseUrl=urlConfig[_0x121c2d(0xbd)](dbOther,_0x121c2d(0x108)),modelFileUrlList=[],modelFileList=['group1-shard9of17','group1-shard10of17',_0x121c2d(0x115),_0x121c2d(0xba),_0x121c2d(0x10a),_0x121c2d(0x101),'group1-shard15of17',_0x121c2d(0xf9),_0x121c2d(0xc3),'model.json',_0x121c2d(0xc0),_0x121c2d(0x110),_0x121c2d(0xd9),_0x121c2d(0x109),_0x121c2d(0xc5),_0x121c2d(0x118),_0x121c2d(0xf4),_0x121c2d(0xf2),_0x121c2d(0xec),'group1-shard8of17'];for(let i=0x0;i<modelFileList[_0x121c2d(0xe1)];i++){modelFileUrlList[_0x121c2d(0xff)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x183432,_0x4d473d,_0x3c233b){return new Promise((_0x4129e0,_0x2acda9)=>{const _0xd44ed6=_0x5075;https[_0xd44ed6(0xc7)](_0x183432,_0x263ac8=>{const _0x419eb1=_0xd44ed6,_0x5dfd69=fs[_0x419eb1(0xed)](_0x4d473d);_0x263ac8[_0x419eb1(0xd6)](_0x5dfd69),_0x5dfd69['on'](_0x419eb1(0xe6),()=>{const _0x5b1ba4=_0x419eb1;_0x5dfd69[_0x5b1ba4(0xb1)](),fs[_0x5b1ba4(0xcb)](_0x4d473d,_0x3c233b),_0x4129e0();})['on'](_0x419eb1(0xc4),_0x586d69=>{const _0x4553ae=_0x419eb1;console[_0x4553ae(0xd1)](_0x586d69);});})['on'](_0xd44ed6(0xc4),_0x21e6c4=>{const _0x16dde5=_0xd44ed6;_0x2acda9(_0x21e6c4[_0x16dde5(0xce)]);});});}function downloadModelFile(){return new Promise(async(_0x1c7837,_0x14b938)=>{const _0x1c24e8=_0x5075;try{for(let _0x4f1171=0x0;_0x4f1171<modelFileList['length'];_0x4f1171++){let _0x1a227a=path[_0x1c24e8(0x102)](modelSavePath,modelFileList[_0x4f1171]),_0x391a86=path['join'](modelSavePath,_0x1c24e8(0xaf)+modelFileList[_0x4f1171]);if(!fs[_0x1c24e8(0x10d)](_0x1a227a)){let _0x3f77c5=modelFileUrlList[_0x4f1171];await httpDownload(_0x3f77c5,_0x391a86,_0x1a227a);}else{}}_0x1c7837();}catch(_0xbfa15b){_0x14b938(_0xbfa15b);}});}async function loadModel(){return new Promise(async(_0x1da853,_0x3da57c)=>{const _0x52f383=_0x5075;try{if(!cocoSsdModel){await tfjs['setBackend'](_0x52f383(0xfe)),await tfjs[_0x52f383(0xdd)](),await downloadModelFile();let _0xe3ca1f=path['join'](modelSavePath,'model.json'),_0x51f351=new fileSys[(_0x52f383(0xcd))](_0xe3ca1f);cocoSsdModel=await cocoSsd[_0x52f383(0xd0)]({'modelUrl':_0x51f351});let _0x2c8427=new Date()['getTime']();_0x1da853();}else _0x1da853();}catch(_0x16ea71){console[_0x52f383(0xd1)](_0x16ea71),_0x3da57c(_0x16ea71);}});}function exitProcess(){const _0x1d608a=_0x121c2d;try{bgTaskId&&dbOther[_0x1d608a(0xf1)](_0x1d608a(0xd4)+bgTaskId)['run']();}catch(_0x471c9c){}return process['send']({'type':_0x1d608a(0xb1)}),process[_0x1d608a(0xd7)]();}function runInfinitCoCoSsd(){return new Promise(async _0x5e676d=>{const _0x210f10=_0x5075;let _0x596b2f=0x32*0x400;dbFileIndex[_0x210f10(0xf1)](_0x210f10(0xdc)+_0x596b2f)[_0x210f10(0x117)]();let _0x505219=dbFileIndex[_0x210f10(0xf1)]('SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>'+_0x596b2f+'\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201')[_0x210f10(0xc7)]();if(!_0x505219)return exitProcess();try{bgTaskId&&dbOther[_0x210f10(0xf1)](_0x210f10(0xde)+bgTaskId)['run']();}catch(_0x1c3db3){}await loadModel();function _0x17e59f(){const _0x2d15ae=_0x210f10;dbFileIndex[_0x2d15ae(0xf1)](_0x2d15ae(0xc9)+_0x505219['id'])[_0x2d15ae(0x117)](),_0x5e676d();}let _0x1abff5=path[_0x210f10(0x102)](_0x505219['path'],_0x505219[_0x210f10(0xb4)]);parseInt(_0x505219['type'])==0x2&&(_0x1abff5=path[_0x210f10(0x102)](_0x505219[_0x210f10(0xcf)])),fs['stat'](_0x1abff5,async(_0x44ae6d,_0x3a91f9)=>{const _0x4f7464=_0x210f10;if(_0x44ae6d||_0x3a91f9[_0x4f7464(0xf3)]>0x400*0x400*0x3c)return console[_0x4f7464(0xd1)](_0x4f7464(0xe2)),_0x17e59f();sharpUtil[_0x4f7464(0xf7)](_0x1abff5,(_0x55a6a3,_0x3a2ae7,_0x28ea14)=>{const _0x374f10=_0x4f7464;let _0x5e35f0=sharpUtil[_0x374f10(0xe0)](_0x55a6a3),_0x200ab8=exifUtils[_0x374f10(0x107)](_0x28ea14);_0x200ab8?_0x5e35f0=_0x5e35f0[_0x374f10(0xf6)](_0x200ab8):_0x5e35f0=_0x5e35f0[_0x374f10(0xf6)](),_0x5e35f0[_0x374f10(0x112)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x374f10(0xda)]()[_0x374f10(0xb3)]()[_0x374f10(0xb5)]((_0xc54185,_0x4f67db,_0x4e1a02)=>{const _0xd6f7c8=_0x374f10;_0x3a2ae7&&sharpUtil[_0xd6f7c8(0xfa)](_0x55a6a3);if(_0xc54185)return _0x17e59f();tfjs[_0xd6f7c8(0x10f)]()[_0xd6f7c8(0xfc)](),temp=tfjs[_0xd6f7c8(0xdb)](_0x4f67db,[_0x4e1a02[_0xd6f7c8(0x10e)],_0x4e1a02[_0xd6f7c8(0xb2)],_0x4e1a02[_0xd6f7c8(0x111)]]),tensor=tfjs[_0xd6f7c8(0xbc)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs['dispose'](temp),_0x4f67db=null,cocoSsdModel[_0xd6f7c8(0x100)](tensor)[_0xd6f7c8(0x116)](_0x231b48=>{const _0x5cc997=_0xd6f7c8;tfjs['dispose'](tensor),tfjs[_0x5cc997(0x10f)]()['endScope']();for(let _0x38678d=0x0;_0x38678d<_0x231b48[_0x5cc997(0xe1)];_0x38678d++){let _0x528aa4=_0x5cc997(0x113),_0x216615=_0x231b48[_0x38678d],_0x4b7676=_0x216615[_0x5cc997(0xfb)];for(let _0x5a59f in _0x4b7676){if(_0x4b7676[_0x5a59f]<0x0)_0x4b7676[_0x5a59f]=0x0;}if(_0x4b7676[0x3]*_0x4b7676[0x4]<0x4e20)continue;let _0x1b59c2='',_0x2919a4=dbFileIndex['prepare'](_0x5cc997(0xeb))['get'](_0x216615[_0x5cc997(0xbb)],_0x528aa4);if(_0x2919a4)_0x1b59c2=_0x2919a4['id'];else{let _0x2185ce=dbFileIndex[_0x5cc997(0xf1)](_0x5cc997(0x106))[_0x5cc997(0x117)](_0x216615[_0x5cc997(0xbb)],_0x528aa4);_0x1b59c2=_0x2185ce[_0x5cc997(0xe9)];}dbFileIndex[_0x5cc997(0xf1)](_0x5cc997(0xb7))[_0x5cc997(0x117)](_0x505219['id'],_0x1b59c2,_0x528aa4,JSON['stringify'](_0x216615[_0x5cc997(0xfb)]),_0x216615[_0x5cc997(0xc8)]);}_0x17e59f();})[_0xd6f7c8(0x10b)](_0x5ae707=>{const _0x5a34b2=_0xd6f7c8;_0x3a2ae7&&sharpUtil[_0x5a34b2(0xfa)](_0x55a6a3),tfjs[_0x5a34b2(0xb6)](tensor),tfjs[_0x5a34b2(0x10f)]()['endScope'](),_0x17e59f();});});});});});}let bgTaskId;try{let info=dbOther[_0x121c2d(0xf1)](_0x121c2d(0xf8))[_0x121c2d(0x117)](_0x121c2d(0xd2));bgTaskId=info[_0x121c2d(0xe9)];}catch(_0x120a4c){}async function runCoCoSsd(){const _0x559962=_0x121c2d;let _0x2d6f8a=dbConfigTable[_0x559962(0xae)](dbOther,_0x559962(0xb8));_0x2d6f8a&&_0x2d6f8a[_0x559962(0xb0)]=='1'?runInfinitCoCoSsd()[_0x559962(0x116)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();