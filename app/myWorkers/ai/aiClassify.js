const _0x9cd7ec=_0x1f36;function _0x5284(){const _0x92f1a3=['dbOther','@tensorflow/tfjs','group1-shard7of17','load','group1-shard17of17','resize','859936BCQLlD','1876707UrGPSs','tfModel','group1-shard12of17','mkdirSync','group1-shard14of17','tensor','9nKWbbn','detect','./utils/file_system','setBackend','bbox','30qblSsa','modeUrl_ai_classify','1248RvvRzE','../../express-server/utils/sharpUtils','group1-shard5of17','join','finish','log','../../myConfig/config','channels','NasCabAiClassify','group1-shard6of17','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','renameSync','557980dGgIAd','426smYysK','aiClassesEnable','length','close','better-sqlite3','https','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','rotate','group1-shard4of17','createWriteStream','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','126064oACaAJ','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','endScope','exit','transSpcielFormat','size','journal_mode\x20=\x20WAL','score','group1-shard11of17','pragma','group1-shard8of17','error','run','type','weights_manifest.json','value','ssd_mobilenet_v2_1_default_1','@tensorflow/tfjs-backend-wasm','@tensorflow-models/coco-ssd','stat','toBuffer','getRotateFromTags','dbFileIndex','group1-shard10of17','findByTitle','tiny_path','dispose','path','getUrlByUrlKey','prepare','group1-shard9of17','group1-shard2of17','tmp_','class','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','../../utils/exifUtils','model.json','2785974NLrdOr','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','223030AOpTNq','send','push','then','ready','wasm','pipe','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','raw','group1-shard16of17','catch','engine','message','get','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','existsSync','deleteRawTempFile','lastInsertRowid'];_0x5284=function(){return _0x92f1a3;};return _0x5284();}(function(_0x2e3c,_0x29cf12){const _0x302e77=_0x1f36,_0x19093f=_0x2e3c();while(!![]){try{const _0x1f0cb5=-parseInt(_0x302e77(0xed))/0x1+-parseInt(_0x302e77(0x113))/0x2*(-parseInt(_0x302e77(0x120))/0x3)+parseInt(_0x302e77(0xc6))/0x4*(parseInt(_0x302e77(0x111))/0x5)+parseInt(_0x302e77(0xeb))/0x6+-parseInt(_0x302e77(0x106))/0x7+parseInt(_0x302e77(0x105))/0x8+-parseInt(_0x302e77(0x10c))/0x9*(parseInt(_0x302e77(0x11f))/0xa);if(_0x1f0cb5===_0x29cf12)break;else _0x19093f['push'](_0x19093f['shift']());}catch(_0x3f9288){_0x19093f['push'](_0x19093f['shift']());}}}(_0x5284,0x49e04));const tfjs=require(_0x9cd7ec(0x100)),wasm=require(_0x9cd7ec(0xd7)),fileSys=require(_0x9cd7ec(0x10e)),cocoSsd=require(_0x9cd7ec(0xd8)),Database=require(_0x9cd7ec(0x124)),config=require(_0x9cd7ec(0x119)),dbConfigTable=require('../../db/dbConfigTable'),sharpUtil=require(_0x9cd7ec(0x114)),urlConfig=require('../../myConfig/urlConfig');let dbFileIndex=new Database(config[_0x9cd7ec(0xdc)],{}),dbOther=new Database(config[_0x9cd7ec(0xff)],{});process['title']=_0x9cd7ec(0x11b),dbOther['pragma'](_0x9cd7ec(0xcc)),dbFileIndex[_0x9cd7ec(0xcf)]('journal_mode\x20=\x20WAL');const exifUtils=require(_0x9cd7ec(0xe9));process['on']('exit',()=>{const _0x1f99f7=_0x9cd7ec;dbOther[_0x1f99f7(0x123)](),dbFileIndex[_0x1f99f7(0x123)]();});const fs=require('fs');let path=require(_0x9cd7ec(0xe1));const https=require(_0x9cd7ec(0xc0));let cocoSsdModel=null,modelSavePath=path['join'](config['userDataFolder'],_0x9cd7ec(0x107),_0x9cd7ec(0xd6));!fs[_0x9cd7ec(0xfc)](modelSavePath)&&fs[_0x9cd7ec(0x109)](modelSavePath,{'recursive':!![]});let modelBaseUrl=urlConfig[_0x9cd7ec(0xe2)](dbOther,_0x9cd7ec(0x112)),modelFileUrlList=[],modelFileList=[_0x9cd7ec(0xe4),_0x9cd7ec(0xdd),_0x9cd7ec(0xce),_0x9cd7ec(0x108),'group1-shard13of17',_0x9cd7ec(0x10a),'group1-shard15of17',_0x9cd7ec(0xf6),_0x9cd7ec(0x103),_0x9cd7ec(0xea),'tensorflowjs_model.pb',_0x9cd7ec(0xd4),'group1-shard1of17',_0x9cd7ec(0xe5),'group1-shard3of17',_0x9cd7ec(0xc3),_0x9cd7ec(0x115),_0x9cd7ec(0x11c),_0x9cd7ec(0x101),_0x9cd7ec(0xd0)];for(let i=0x0;i<modelFileList[_0x9cd7ec(0x122)];i++){modelFileUrlList[_0x9cd7ec(0xef)](modelBaseUrl+modelFileList[i]);}function _0x1f36(_0x3cec88,_0x1a6f82){const _0x5284df=_0x5284();return _0x1f36=function(_0x1f36d4,_0xdf7fa7){_0x1f36d4=_0x1f36d4-0xc0;let _0x209d75=_0x5284df[_0x1f36d4];return _0x209d75;},_0x1f36(_0x3cec88,_0x1a6f82);}function httpDownload(_0x4a668c,_0x23c951,_0x57f459){return new Promise((_0x43ae21,_0x50eaa5)=>{const _0x1b0766=_0x1f36;https[_0x1b0766(0xfa)](_0x4a668c,_0x50b8b5=>{const _0x1a2527=_0x1b0766,_0xa34624=fs[_0x1a2527(0xc4)](_0x23c951);_0x50b8b5[_0x1a2527(0xf3)](_0xa34624),_0xa34624['on'](_0x1a2527(0x117),()=>{const _0x5aa50f=_0x1a2527;_0xa34624[_0x5aa50f(0x123)](),fs[_0x5aa50f(0x11e)](_0x23c951,_0x57f459),_0x43ae21();})['on'](_0x1a2527(0xd1),_0xa44f61=>{const _0x1cd231=_0x1a2527;console[_0x1cd231(0x118)](_0xa44f61);});})['on'](_0x1b0766(0xd1),_0x5a797a=>{const _0x5c17a5=_0x1b0766;_0x50eaa5(_0x5a797a[_0x5c17a5(0xf9)]);});});}function downloadModelFile(){return new Promise(async(_0x58c379,_0x2d5127)=>{const _0x141f9a=_0x1f36;try{for(let _0x4873ee=0x0;_0x4873ee<modelFileList[_0x141f9a(0x122)];_0x4873ee++){let _0x2420cc=path[_0x141f9a(0x116)](modelSavePath,modelFileList[_0x4873ee]),_0x34b3d9=path['join'](modelSavePath,_0x141f9a(0xe6)+modelFileList[_0x4873ee]);if(!fs[_0x141f9a(0xfc)](_0x2420cc)){let _0x9d725=modelFileUrlList[_0x4873ee];await httpDownload(_0x9d725,_0x34b3d9,_0x2420cc);}else{}}_0x58c379();}catch(_0xc9670c){_0x2d5127(_0xc9670c);}});}async function loadModel(){return new Promise(async(_0xbd1f5,_0x1c5e11)=>{const _0x231f5b=_0x1f36;try{if(!cocoSsdModel){await tfjs[_0x231f5b(0x10f)](_0x231f5b(0xf2)),await tfjs[_0x231f5b(0xf1)](),await downloadModelFile();let _0x38c568=path['join'](modelSavePath,_0x231f5b(0xea)),_0x14e1c0=new fileSys['NodeFileSystem'](_0x38c568);cocoSsdModel=await cocoSsd[_0x231f5b(0x102)]({'modelUrl':_0x14e1c0});let _0x45a9b1=new Date()['getTime']();_0xbd1f5();}else _0xbd1f5();}catch(_0x56a45f){console[_0x231f5b(0x118)](_0x56a45f),_0x1c5e11(_0x56a45f);}});}function exitProcess(){const _0x3b67ca=_0x9cd7ec;try{bgTaskId&&dbOther[_0x3b67ca(0xe3)](_0x3b67ca(0xf4)+bgTaskId)[_0x3b67ca(0xd2)]();}catch(_0x1eacf1){}return process[_0x3b67ca(0xee)]({'type':_0x3b67ca(0x123)}),process[_0x3b67ca(0xc9)]();}function runInfinitCoCoSsd(){return new Promise(async _0x3dc123=>{const _0x437504=_0x1f36;let _0x12fd49=0x32*0x400;dbFileIndex[_0x437504(0xe3)](_0x437504(0x11d)+_0x12fd49)[_0x437504(0xd2)]();let _0x12e65d=dbFileIndex[_0x437504(0xe3)](_0x437504(0xe8)+_0x12fd49+_0x437504(0xec))[_0x437504(0xfa)]();if(!_0x12e65d)return exitProcess();try{bgTaskId&&dbOther[_0x437504(0xe3)](_0x437504(0xc1)+bgTaskId)[_0x437504(0xd2)]();}catch(_0x13feff){}await loadModel();function _0x7b50ea(){const _0x53aab8=_0x437504;dbFileIndex[_0x53aab8(0xe3)](_0x53aab8(0xc5)+_0x12e65d['id'])[_0x53aab8(0xd2)](),_0x3dc123();}let _0x4cd1d0=path[_0x437504(0x116)](_0x12e65d['path'],_0x12e65d['filename']);parseInt(_0x12e65d[_0x437504(0xd3)])==0x2&&(_0x4cd1d0=path[_0x437504(0x116)](_0x12e65d[_0x437504(0xdf)])),fs[_0x437504(0xd9)](_0x4cd1d0,async(_0x6e19d3,_0x40bde6)=>{const _0x31dc29=_0x437504;if(_0x6e19d3||_0x40bde6[_0x31dc29(0xcb)]>0x400*0x400*0x3c)return console[_0x31dc29(0x118)]('大于30mb的图像不处理'),_0x7b50ea();sharpUtil[_0x31dc29(0xca)](_0x4cd1d0,(_0x2780fa,_0x46c13f,_0x20e086)=>{const _0x3354d7=_0x31dc29;let _0x36e658=sharpUtil['getSharpInstanceFromInput'](_0x2780fa),_0x149488=exifUtils[_0x3354d7(0xdb)](_0x20e086);_0x149488?_0x36e658=_0x36e658[_0x3354d7(0xc2)](_0x149488):_0x36e658=_0x36e658[_0x3354d7(0xc2)](),_0x36e658[_0x3354d7(0x104)]({'width':0x7d0,'withoutEnlargement':!![]})['jpeg']()[_0x3354d7(0xf5)]()[_0x3354d7(0xda)]((_0x4dcd2b,_0x582b17,_0x2fa75b)=>{const _0x33c853=_0x3354d7;_0x46c13f&&sharpUtil[_0x33c853(0xfd)](_0x2780fa);if(_0x4dcd2b)return _0x7b50ea();tfjs['engine']()['startScope'](),temp=tfjs[_0x33c853(0x10b)](_0x582b17,[_0x2fa75b['height'],_0x2fa75b['width'],_0x2fa75b[_0x33c853(0x11a)]]),tensor=tfjs['slice'](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x33c853(0xe0)](temp),_0x582b17=null,cocoSsdModel[_0x33c853(0x10d)](tensor)[_0x33c853(0xf0)](_0x573efb=>{const _0x5b1fee=_0x33c853;tfjs['dispose'](tensor),tfjs['engine']()[_0x5b1fee(0xc8)]();for(let _0x446acd=0x0;_0x446acd<_0x573efb[_0x5b1fee(0x122)];_0x446acd++){let _0x48144b='coco_ssd',_0xe15f58=_0x573efb[_0x446acd],_0x1a0e98=_0xe15f58[_0x5b1fee(0x110)];for(let _0x1b168f in _0x1a0e98){if(_0x1a0e98[_0x1b168f]<0x0)_0x1a0e98[_0x1b168f]=0x0;}if(_0x1a0e98[0x3]*_0x1a0e98[0x4]<0x4e20)continue;let _0x2b1cb8='',_0x7a1715=dbFileIndex[_0x5b1fee(0xe3)](_0x5b1fee(0xc7))['get'](_0xe15f58[_0x5b1fee(0xe7)],_0x48144b);if(_0x7a1715)_0x2b1cb8=_0x7a1715['id'];else{let _0x5eb74b=dbFileIndex[_0x5b1fee(0xe3)]('REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)')[_0x5b1fee(0xd2)](_0xe15f58[_0x5b1fee(0xe7)],_0x48144b);_0x2b1cb8=_0x5eb74b[_0x5b1fee(0xfe)];}dbFileIndex[_0x5b1fee(0xe3)](_0x5b1fee(0xfb))[_0x5b1fee(0xd2)](_0x12e65d['id'],_0x2b1cb8,_0x48144b,JSON['stringify'](_0xe15f58[_0x5b1fee(0x110)]),_0xe15f58[_0x5b1fee(0xcd)]);}_0x7b50ea();})[_0x33c853(0xf7)](_0x379156=>{const _0x3d735f=_0x33c853;_0x46c13f&&sharpUtil[_0x3d735f(0xfd)](_0x2780fa),tfjs[_0x3d735f(0xe0)](tensor),tfjs[_0x3d735f(0xf8)]()[_0x3d735f(0xc8)](),_0x7b50ea();});});});});});}let bgTaskId;try{let info=dbOther[_0x9cd7ec(0xe3)]('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')['run']('AI_CLASSES');bgTaskId=info[_0x9cd7ec(0xfe)];}catch(_0x2efdf9){}async function runCoCoSsd(){const _0x401e6f=_0x9cd7ec;let _0x4c4f47=dbConfigTable[_0x401e6f(0xde)](dbOther,_0x401e6f(0x121));_0x4c4f47&&_0x4c4f47[_0x401e6f(0xd5)]=='1'?runInfinitCoCoSsd()[_0x401e6f(0xf0)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();