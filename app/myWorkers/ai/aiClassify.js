const _0x3c9e16=_0x31a1;(function(_0x4e7cad,_0xe7399e){const _0x44358=_0x31a1,_0x303a57=_0x4e7cad();while(!![]){try{const _0x3ee673=-parseInt(_0x44358(0xff))/0x1*(-parseInt(_0x44358(0x100))/0x2)+parseInt(_0x44358(0x126))/0x3*(-parseInt(_0x44358(0xf5))/0x4)+parseInt(_0x44358(0x103))/0x5*(-parseInt(_0x44358(0xf8))/0x6)+-parseInt(_0x44358(0x108))/0x7+-parseInt(_0x44358(0xe9))/0x8+-parseInt(_0x44358(0x125))/0x9+parseInt(_0x44358(0x10c))/0xa;if(_0x3ee673===_0xe7399e)break;else _0x303a57['push'](_0x303a57['shift']());}catch(_0x382636){_0x303a57['push'](_0x303a57['shift']());}}}(_0x1535,0xce931));function _0x1535(){const _0x289ee2=['pragma','type','get','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','ready','join','group1-shard16of17','./utils/file_system','channels','findByTitle','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','prepare','group1-shard5of17','../../myConfig/urlConfig','tmp_','push','weights_manifest.json','../../express-server/utils/sharpUtils','journal_mode\x20=\x20WAL','jpeg','filename','path','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','lastInsertRowid','close','9837136IUGxri','class','value','dispose','getSharpInstanceFromInput','length','slice','group1-shard8of17','group1-shard10of17','stringify','dbOther','getRotateFromTags','193676TxSkOn','group1-shard6of17','getTime','313848mXwoGE','model.json','@tensorflow/tfjs-backend-wasm','@tensorflow/tfjs','resize','exit','load','7xWIdZv','64778JkyNDO','mkdirSync','group1-shard17of17','45QQzzYI','catch','bbox','toBuffer','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','2284359KDfgtd','group1-shard15of17','group1-shard4of17','message','47650780YlvcJg','existsSync','score','log','endScope','coco_ssd','group1-shard1of17','width','NodeFileSystem','../../db/dbConfigTable','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','group1-shard12of17','startScope','error','dbFileIndex','rotate','aiClassesEnable','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','tfModel','createWriteStream','deleteRawTempFile','userDataFolder','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','tiny_path','renameSync','5561388CCbTGy','93tuSjXU','group1-shard7of17','run','then','engine','ssd_mobilenet_v2_1_default_1','group1-shard9of17','group1-shard2of17','group1-shard3of17','group1-shard13of17','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','title','tensorflowjs_model.pb','finish'];_0x1535=function(){return _0x289ee2;};return _0x1535();}function _0x31a1(_0x2806dd,_0x89b738){const _0x153541=_0x1535();return _0x31a1=function(_0x31a1e5,_0x4bc641){_0x31a1e5=_0x31a1e5-0xc7;let _0x35ae79=_0x153541[_0x31a1e5];return _0x35ae79;},_0x31a1(_0x2806dd,_0x89b738);}const tfjs=require(_0x3c9e16(0xfb)),wasm=require(_0x3c9e16(0xfa)),fileSys=require(_0x3c9e16(0xd7)),cocoSsd=require('@tensorflow-models/coco-ssd'),Database=require('better-sqlite3'),config=require('../../myConfig/config'),dbConfigTable=require(_0x3c9e16(0x115)),sharpUtil=require(_0x3c9e16(0xe1)),urlConfig=require(_0x3c9e16(0xdd));let dbFileIndex=new Database(config[_0x3c9e16(0x11a)],{}),dbOther=new Database(config[_0x3c9e16(0xf3)],{});process[_0x3c9e16(0xcd)]='NasCabAiClassify',dbOther[_0x3c9e16(0xd0)](_0x3c9e16(0xe2)),dbFileIndex[_0x3c9e16(0xd0)]('journal_mode\x20=\x20WAL');const exifUtils=require('../../utils/exifUtils');process['on'](_0x3c9e16(0xfd),()=>{const _0x2d8bb9=_0x3c9e16;dbOther[_0x2d8bb9(0xe8)](),dbFileIndex[_0x2d8bb9(0xe8)]();});const fs=require('fs');let path=require(_0x3c9e16(0xe5));const https=require('https');let cocoSsdModel=null,modelSavePath=path[_0x3c9e16(0xd5)](config[_0x3c9e16(0x121)],_0x3c9e16(0x11e),_0x3c9e16(0x12b));!fs[_0x3c9e16(0x10d)](modelSavePath)&&fs[_0x3c9e16(0x101)](modelSavePath,{'recursive':!![]});let modelBaseUrl=urlConfig['getUrlByUrlKey'](dbOther,'modeUrl_ai_classify'),modelFileUrlList=[],modelFileList=[_0x3c9e16(0xc7),_0x3c9e16(0xf1),'group1-shard11of17',_0x3c9e16(0x117),_0x3c9e16(0xca),'group1-shard14of17',_0x3c9e16(0x109),_0x3c9e16(0xd6),_0x3c9e16(0x102),_0x3c9e16(0xf9),_0x3c9e16(0xce),_0x3c9e16(0xe0),_0x3c9e16(0x112),_0x3c9e16(0xc8),_0x3c9e16(0xc9),_0x3c9e16(0x10a),_0x3c9e16(0xdc),_0x3c9e16(0xf6),_0x3c9e16(0x127),_0x3c9e16(0xf0)];for(let i=0x0;i<modelFileList['length'];i++){modelFileUrlList[_0x3c9e16(0xdf)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x1b53fe,_0x356642,_0x20b574){return new Promise((_0x3d7879,_0x36746f)=>{const _0x578c13=_0x31a1;https[_0x578c13(0xd2)](_0x1b53fe,_0x4c26a5=>{const _0x5864ef=_0x578c13,_0x28807f=fs[_0x5864ef(0x11f)](_0x356642);_0x4c26a5['pipe'](_0x28807f),_0x28807f['on'](_0x5864ef(0xcf),()=>{const _0x5ae61d=_0x5864ef;_0x28807f[_0x5ae61d(0xe8)](),fs[_0x5ae61d(0x124)](_0x356642,_0x20b574),_0x3d7879();})['on'](_0x5864ef(0x119),_0x409c56=>{const _0x4f570f=_0x5864ef;console[_0x4f570f(0x10f)](_0x409c56);});})['on'](_0x578c13(0x119),_0x3b0ca5=>{const _0xe0423a=_0x578c13;_0x36746f(_0x3b0ca5[_0xe0423a(0x10b)]);});});}function downloadModelFile(){return new Promise(async(_0x29ab46,_0x14713f)=>{const _0x145243=_0x31a1;try{for(let _0x50939a=0x0;_0x50939a<modelFileList['length'];_0x50939a++){let _0x399771=path['join'](modelSavePath,modelFileList[_0x50939a]),_0x2aad7e=path[_0x145243(0xd5)](modelSavePath,_0x145243(0xde)+modelFileList[_0x50939a]);if(!fs[_0x145243(0x10d)](_0x399771)){let _0x1d6fcb=modelFileUrlList[_0x50939a];await httpDownload(_0x1d6fcb,_0x2aad7e,_0x399771);}else{}}_0x29ab46();}catch(_0x2ffc4c){_0x14713f(_0x2ffc4c);}});}async function loadModel(){return new Promise(async(_0x2fe40d,_0x3fe924)=>{const _0x2288ac=_0x31a1;try{if(!cocoSsdModel){await tfjs['setBackend']('wasm'),await tfjs[_0x2288ac(0xd4)](),await downloadModelFile();let _0x43d94c=path[_0x2288ac(0xd5)](modelSavePath,_0x2288ac(0xf9)),_0x2c43c5=new fileSys[(_0x2288ac(0x114))](_0x43d94c);cocoSsdModel=await cocoSsd[_0x2288ac(0xfe)]({'modelUrl':_0x2c43c5});let _0x3c7be2=new Date()[_0x2288ac(0xf7)]();_0x2fe40d();}else _0x2fe40d();}catch(_0x5124a7){console[_0x2288ac(0x10f)](_0x5124a7),_0x3fe924(_0x5124a7);}});}function exitProcess(){const _0x500d97=_0x3c9e16;try{bgTaskId&&dbOther[_0x500d97(0xdb)](_0x500d97(0xd3)+bgTaskId)['run']();}catch(_0xaafac6){}return process['send']({'type':_0x500d97(0xe8)}),process[_0x500d97(0xfd)]();}function runInfinitCoCoSsd(){return new Promise(async _0x271eb5=>{const _0x1585b3=_0x31a1;let _0x23ca32=0x32*0x400;dbFileIndex[_0x1585b3(0xdb)](_0x1585b3(0x122)+_0x23ca32)[_0x1585b3(0x128)]();let _0x344538=dbFileIndex[_0x1585b3(0xdb)](_0x1585b3(0xda)+_0x23ca32+_0x1585b3(0x107))[_0x1585b3(0xd2)]();if(!_0x344538)return exitProcess();try{bgTaskId&&dbOther[_0x1585b3(0xdb)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)['run']();}catch(_0xc9a429){}await loadModel();function _0x41c05a(){const _0x3ddcc7=_0x1585b3;dbFileIndex[_0x3ddcc7(0xdb)](_0x3ddcc7(0xcb)+_0x344538['id'])[_0x3ddcc7(0x128)](),_0x271eb5();}let _0x160c3a=path[_0x1585b3(0xd5)](_0x344538['path'],_0x344538[_0x1585b3(0xe4)]);parseInt(_0x344538[_0x1585b3(0xd1)])==0x2&&(_0x160c3a=path[_0x1585b3(0xd5)](_0x344538[_0x1585b3(0x123)])),fs['stat'](_0x160c3a,async(_0x151534,_0x1cf84e)=>{if(_0x151534||_0x1cf84e['size']>0x400*0x400*0x3c)return console['log']('大于30mb的图像不处理'),_0x41c05a();sharpUtil['transSpcielFormat'](_0x160c3a,(_0x359b04,_0x4a5fad,_0x543749)=>{const _0x54fa6d=_0x31a1;let _0x576b12=sharpUtil[_0x54fa6d(0xed)](_0x359b04),_0xbe4409=exifUtils[_0x54fa6d(0xf4)](_0x543749);_0xbe4409?_0x576b12=_0x576b12[_0x54fa6d(0x11b)](_0xbe4409):_0x576b12=_0x576b12['rotate'](),_0x576b12[_0x54fa6d(0xfc)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x54fa6d(0xe3)]()['raw']()[_0x54fa6d(0x106)]((_0x4f6cfc,_0x121587,_0xfa45b5)=>{const _0x7fabbf=_0x54fa6d;_0x4a5fad&&sharpUtil[_0x7fabbf(0x120)](_0x359b04);if(_0x4f6cfc)return _0x41c05a();tfjs[_0x7fabbf(0x12a)]()[_0x7fabbf(0x118)](),temp=tfjs['tensor'](_0x121587,[_0xfa45b5['height'],_0xfa45b5[_0x7fabbf(0x113)],_0xfa45b5[_0x7fabbf(0xd8)]]),tensor=tfjs[_0x7fabbf(0xef)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x7fabbf(0xec)](temp),_0x121587=null,cocoSsdModel['detect'](tensor)[_0x7fabbf(0x129)](_0x62e7af=>{const _0x36d847=_0x7fabbf;tfjs['dispose'](tensor),tfjs[_0x36d847(0x12a)]()[_0x36d847(0x110)]();for(let _0x400a6f=0x0;_0x400a6f<_0x62e7af[_0x36d847(0xee)];_0x400a6f++){let _0x1b8fe0=_0x36d847(0x111),_0x258f22=_0x62e7af[_0x400a6f],_0x24a8bc=_0x258f22[_0x36d847(0x105)];for(let _0x55a6c0 in _0x24a8bc){if(_0x24a8bc[_0x55a6c0]<0x0)_0x24a8bc[_0x55a6c0]=0x0;}if(_0x24a8bc[0x3]*_0x24a8bc[0x4]<0x4e20)continue;let _0x2d2a02='',_0x52f41c=dbFileIndex[_0x36d847(0xdb)](_0x36d847(0x11d))[_0x36d847(0xd2)](_0x258f22['class'],_0x1b8fe0);if(_0x52f41c)_0x2d2a02=_0x52f41c['id'];else{let _0x2c09ea=dbFileIndex[_0x36d847(0xdb)](_0x36d847(0x116))[_0x36d847(0x128)](_0x258f22[_0x36d847(0xea)],_0x1b8fe0);_0x2d2a02=_0x2c09ea[_0x36d847(0xe7)];}dbFileIndex[_0x36d847(0xdb)](_0x36d847(0xe6))[_0x36d847(0x128)](_0x344538['id'],_0x2d2a02,_0x1b8fe0,JSON[_0x36d847(0xf2)](_0x258f22['bbox']),_0x258f22[_0x36d847(0x10e)]);}_0x41c05a();})[_0x7fabbf(0x104)](_0x164767=>{const _0x440e5d=_0x7fabbf;_0x4a5fad&&sharpUtil[_0x440e5d(0x120)](_0x359b04),tfjs[_0x440e5d(0xec)](tensor),tfjs[_0x440e5d(0x12a)]()[_0x440e5d(0x110)](),_0x41c05a();});});});});});}let bgTaskId;try{let info=dbOther[_0x3c9e16(0xdb)](_0x3c9e16(0xcc))[_0x3c9e16(0x128)]('AI_CLASSES');bgTaskId=info[_0x3c9e16(0xe7)];}catch(_0x4ef653){}async function runCoCoSsd(){const _0x3e8be4=_0x3c9e16;let _0x3329be=dbConfigTable[_0x3e8be4(0xd9)](dbOther,_0x3e8be4(0x11c));_0x3329be&&_0x3329be[_0x3e8be4(0xeb)]=='1'?runInfinitCoCoSsd()[_0x3e8be4(0x129)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();