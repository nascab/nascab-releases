const _0x26b4f3=_0x5ca1;(function(_0x1f1e50,_0x47008a){const _0x619221=_0x5ca1,_0x27faae=_0x1f1e50();while(!![]){try{const _0x125529=parseInt(_0x619221(0xbd))/0x1*(-parseInt(_0x619221(0xf7))/0x2)+-parseInt(_0x619221(0xc1))/0x3+-parseInt(_0x619221(0xc4))/0x4+parseInt(_0x619221(0xdc))/0x5*(parseInt(_0x619221(0xbf))/0x6)+parseInt(_0x619221(0xbb))/0x7*(-parseInt(_0x619221(0xca))/0x8)+parseInt(_0x619221(0xd2))/0x9*(parseInt(_0x619221(0xc3))/0xa)+-parseInt(_0x619221(0xb8))/0xb*(-parseInt(_0x619221(0xf2))/0xc);if(_0x125529===_0x47008a)break;else _0x27faae['push'](_0x27faae['shift']());}catch(_0x3c8030){_0x27faae['push'](_0x27faae['shift']());}}}(_0x4772,0x2685a));const path=require(_0x26b4f3(0xe8)),fs=require('fs'),config=require(_0x26b4f3(0xbc)),Database=require(_0x26b4f3(0xea)),dbConfigTable=require(_0x26b4f3(0xed)),phash=require('sharp-phash'),phashDist=require('sharp-phash/distance'),dbSourceFolderTable=require(_0x26b4f3(0xf8)),sharpUtil=require(_0x26b4f3(0xda)),exifUtils=require(_0x26b4f3(0xc9));process['title']=_0x26b4f3(0xd8);let dbFileIndex=new Database(config[_0x26b4f3(0xcd)],{}),dbOther=new Database(config['dbOther'],{});dbOther['pragma'](_0x26b4f3(0xcb)),dbFileIndex['pragma']('journal_mode\x20=\x20WAL'),process['on'](_0x26b4f3(0xd0),()=>{const _0x635fe6=_0x26b4f3;dbOther[_0x635fe6(0xe5)](),dbFileIndex[_0x635fe6(0xe5)]();});const DEAL_GAP=0x7530;function _0x4772(){const _0x2ab355=['8YkXqWm','journal_mode\x20=\x20WAL','R_OK','dbFileIndex','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','exit','aiSimilarPhotoEnable','315DIflRT','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','file_index_photo-indexing','rotate','prepare','run','NasCabDeduplicatePhotos','log','../../express-server/utils/sharpUtils','\x20LIMIT\x201','350uiteKm','join','AI_PHASH','all','\x20AND\x20','transSpcielFormat','count','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','catch','close','access','findByTitle','path','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','better-sqlite3','toBuffer','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','../../db/dbConfigTable','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','lastInsertRowid','length','send','4555908UwOtBV','phash','then','constants','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','66980TCFehR','../../db/dbSourceFolderTable','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','getRotateFromTags','22DtIlAB','deleteRawTempFile','phash_compare','514227bhzfUx','../../myConfig/config','8HyXEnR','Similar\x20photo\x20disabled','6552DkkLCo','value','808755IRcuHJ','get','6010fKcnMY','352164Gdqvxp','filename','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','excludePathPhoto','getSharpInstanceFromInput','../../utils/exifUtils'];_0x4772=function(){return _0x2ab355;};return _0x4772();}let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x5779d9=>{const _0x23e29b=_0x5ca1;let _0x53d366;function _0x123867(){const _0xe532b4=_0x5ca1;if(_0x53d366)dbFileIndex[_0xe532b4(0xd6)](_0xe532b4(0xe9)+_0x53d366['id'])[_0xe532b4(0xd7)]();return _0x5779d9();}try{let _0x44fc99=dbConfigTable[_0x23e29b(0xe7)](dbOther,_0x23e29b(0xd4));if(_0x44fc99&&_0x44fc99=='1')return setTimeout(_0x5779d9,DEAL_GAP);let _0x2e69b4=_0x23e29b(0xec);_0x2e69b4+=_0x23e29b(0xdb),_0x53d366=dbFileIndex[_0x23e29b(0xd6)](_0x2e69b4)[_0x23e29b(0xc2)]();if(!_0x53d366)return exitProcess();currentDetectIndex=_0x53d366;let _0x5d4671=path[_0x23e29b(0xdd)](_0x53d366[_0x23e29b(0xe8)],_0x53d366[_0x23e29b(0xc5)]);try{if(bgTaskId)dbOther[_0x23e29b(0xd6)](_0x23e29b(0xcf)+bgTaskId)[_0x23e29b(0xd7)]();}catch(_0xdae6a2){}fs[_0x23e29b(0xe6)](_0x5d4671,fs[_0x23e29b(0xf5)][_0x23e29b(0xcc)],async _0x3f6b01=>{const _0x6c4274=_0x23e29b;if(_0x3f6b01)return console[_0x6c4274(0xd9)](_0x3f6b01),_0x123867();try{sharpUtil[_0x6c4274(0xe1)](_0x5d4671,(_0x1f6b5d,_0xa55f71,_0x3f64e7)=>{const _0x49d0a6=_0x6c4274;let _0x3c258a=sharpUtil[_0x49d0a6(0xc8)](_0x1f6b5d),_0x544934=exifUtils[_0x49d0a6(0xb7)](_0x3f64e7);_0x544934?_0x3c258a=_0x3c258a['rotate'](_0x544934):_0x3c258a=_0x3c258a[_0x49d0a6(0xd5)](),_0x3c258a[_0x49d0a6(0xeb)]()[_0x49d0a6(0xf4)](_0x828605=>{const _0x4d8007=_0x49d0a6;phash(_0x828605)['then'](_0x3382e5=>{const _0x3d2b2a=_0x5ca1;_0xa55f71&&sharpUtil[_0x3d2b2a(0xb9)](_0x1f6b5d),dbFileIndex[_0x3d2b2a(0xd6)](_0x3d2b2a(0xee)+_0x53d366['id'])[_0x3d2b2a(0xd7)](_0x3382e5),_0x5779d9();})[_0x4d8007(0xe4)](_0x47ddc3=>{return _0xa55f71&&sharpUtil['deleteRawTempFile'](_0x1f6b5d),_0x123867();});})['catch'](_0x16eb2b=>{return _0x123867();});});}catch(_0x5aa9ac){return _0x123867();}});}catch(_0x29a0fb){return _0x123867();}});}function exitProcess(){const _0x56d468=_0x26b4f3;runComparePhash();try{if(bgTaskId)dbOther['prepare'](_0x56d468(0xf6)+bgTaskId)[_0x56d468(0xd7)]();}catch(_0x4badef){}return process[_0x56d468(0xf1)]({'type':_0x56d468(0xe5)}),process['exit']();}function _0x5ca1(_0x40eb2c,_0x15dd23){const _0x4772e3=_0x4772();return _0x5ca1=function(_0x5ca122,_0x45487c){_0x5ca122=_0x5ca122-0xb5;let _0x11ee51=_0x4772e3[_0x5ca122];return _0x11ee51;},_0x5ca1(_0x40eb2c,_0x15dd23);}async function runGenPhashTask(){const _0x124435=_0x26b4f3;let _0x1d35d8=dbConfigTable[_0x124435(0xe7)](dbOther,_0x124435(0xd1));_0x1d35d8&&_0x1d35d8[_0x124435(0xc0)]=='1'?runGenPhash()[_0x124435(0xf4)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x124435(0xd9)](_0x124435(0xbe)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x9bc9b4=_0x26b4f3;try{let _0x394ed7=_0x9bc9b4(0xb5),_0x2e543e=dbSourceFolderTable['getExcludePathWhereStr'](dbOther,_0x9bc9b4(0xe8),_0x9bc9b4(0xc7));_0x2e543e&&(_0x394ed7+=_0x9bc9b4(0xe0)+_0x2e543e);let _0x5d721c=dbFileIndex[_0x9bc9b4(0xd6)](_0x394ed7)[_0x9bc9b4(0xc2)]();if(_0x5d721c[_0x9bc9b4(0xe2)]<0x1)return;let _0x1489f3=_0x9bc9b4(0xe3);_0x2e543e&&(_0x1489f3+='\x20AND\x20'+_0x2e543e);let _0x53ca79=dbFileIndex[_0x9bc9b4(0xd6)](_0x1489f3)[_0x9bc9b4(0xdf)]();for(let _0x5266f7=0x0;_0x5266f7<_0x53ca79['length'];_0x5266f7++){let _0x30ea2f=_0x53ca79[_0x5266f7];if(_0x30ea2f['phash_compare']==0x1)continue;try{for(let _0x385d81=0x0;_0x385d81<_0x53ca79[_0x9bc9b4(0xf0)];_0x385d81++){if(_0x53ca79[_0x385d81][_0x9bc9b4(0xba)]==0x1)continue;if(_0x53ca79[_0x5266f7]['id']==_0x53ca79[_0x385d81]['id'])continue;try{let _0xad4203=phashDist(_0x53ca79[_0x5266f7][_0x9bc9b4(0xf3)],_0x53ca79[_0x385d81][_0x9bc9b4(0xf3)]);_0xad4203<0x9&&(_0x53ca79[_0x385d81][_0x9bc9b4(0xba)]=0x1,dbFileIndex['prepare'](_0x9bc9b4(0xc6)+_0x53ca79[_0x385d81]['id'])['run'](),dbFileIndex['prepare'](_0x9bc9b4(0xce))[_0x9bc9b4(0xd7)](_0x53ca79[_0x5266f7]['id']+'',_0x53ca79[_0x385d81]['id']+'',_0xad4203));}catch(_0x40b88c){console[_0x9bc9b4(0xd9)](_0x40b88c);continue;}}}catch(_0x2eeada){console[_0x9bc9b4(0xd9)](_0x2eeada),_0x53ca79[_0x5266f7][_0x9bc9b4(0xba)]=0x1,dbFileIndex[_0x9bc9b4(0xd6)](_0x9bc9b4(0xc6)+_0x30ea2f['id'])[_0x9bc9b4(0xd7)]();continue;}_0x53ca79[_0x5266f7][_0x9bc9b4(0xba)]=0x1,dbFileIndex[_0x9bc9b4(0xd6)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x30ea2f['id'])['run']();}}catch(_0x20f51c){console['log'](_0x20f51c);}}let bgTaskId;try{let info=dbOther[_0x26b4f3(0xd6)](_0x26b4f3(0xd3))[_0x26b4f3(0xd7)](_0x26b4f3(0xde));bgTaskId=info[_0x26b4f3(0xef)];}catch(_0x40d135){}process['on']('uncaughtException',(_0x234f21,_0x5f3b8a)=>{const _0x26e867=_0x26b4f3;currentDetectIndex&&dbFileIndex[_0x26e867(0xd6)](_0x26e867(0xb6)+currentDetectIndex['id'])[_0x26e867(0xd7)](),process['send']({'type':'close'}),process[_0x26e867(0xd0)]();});