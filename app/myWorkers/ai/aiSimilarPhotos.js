const _0x10fe01=_0x569b;(function(_0x2fde89,_0x1a8f52){const _0x2e1a7f=_0x569b,_0x284fe7=_0x2fde89();while(!![]){try{const _0x335dd1=parseInt(_0x2e1a7f(0x15e))/0x1*(-parseInt(_0x2e1a7f(0x168))/0x2)+-parseInt(_0x2e1a7f(0x169))/0x3+parseInt(_0x2e1a7f(0x145))/0x4+parseInt(_0x2e1a7f(0x162))/0x5+parseInt(_0x2e1a7f(0x16a))/0x6*(parseInt(_0x2e1a7f(0x156))/0x7)+-parseInt(_0x2e1a7f(0x157))/0x8+parseInt(_0x2e1a7f(0x150))/0x9;if(_0x335dd1===_0x1a8f52)break;else _0x284fe7['push'](_0x284fe7['shift']());}catch(_0x22e527){_0x284fe7['push'](_0x284fe7['shift']());}}}(_0x2d5d,0x1c2e6));const path=require(_0x10fe01(0x153)),fs=require('fs'),config=require(_0x10fe01(0x134)),Database=require(_0x10fe01(0x167)),dbConfigTable=require('../../db/dbConfigTable'),phash=require(_0x10fe01(0x15c)),phashDist=require(_0x10fe01(0x14c)),dbSourceFolderTable=require(_0x10fe01(0x160)),sharpUtil=require('../../express-server/utils/sharpUtils'),exifUtils=require(_0x10fe01(0x15f));process[_0x10fe01(0x152)]=_0x10fe01(0x144);let dbFileIndex=new Database(config[_0x10fe01(0x147)],{}),dbOther=new Database(config[_0x10fe01(0x148)],{});dbOther[_0x10fe01(0x158)](_0x10fe01(0x165)),dbFileIndex['pragma']('journal_mode\x20=\x20WAL'),process['on'](_0x10fe01(0x13e),()=>{const _0x37eac5=_0x10fe01;dbOther[_0x37eac5(0x13a)](),dbFileIndex['close']();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x642a97=>{const _0x5390c5=_0x569b;let _0x83913f;function _0x592dac(){const _0xd3f53d=_0x569b;if(_0x83913f)dbFileIndex[_0xd3f53d(0x13b)]('UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id='+_0x83913f['id'])[_0xd3f53d(0x163)]();return _0x642a97();}try{let _0x4c8084=dbConfigTable[_0x5390c5(0x16c)](dbOther,'file_index_photo-indexing');if(_0x4c8084&&_0x4c8084=='1')return setTimeout(_0x642a97,DEAL_GAP);let _0x189771=_0x5390c5(0x154);_0x189771+='\x20LIMIT\x201',_0x83913f=dbFileIndex[_0x5390c5(0x13b)](_0x189771)['get']();if(!_0x83913f)return exitProcess();currentDetectIndex=_0x83913f;let _0x220ca3=path['join'](_0x83913f[_0x5390c5(0x153)],_0x83913f[_0x5390c5(0x15d)]);try{if(bgTaskId)dbOther[_0x5390c5(0x13b)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x5390c5(0x163)]();}catch(_0x1e94ac){}fs['access'](_0x220ca3,fs[_0x5390c5(0x161)][_0x5390c5(0x15b)],async _0x2772b9=>{const _0x3d8d0a=_0x5390c5;if(_0x2772b9)return console['log'](_0x2772b9),_0x592dac();try{sharpUtil[_0x3d8d0a(0x146)](_0x220ca3,(_0x261d73,_0x4deadf,_0x138cb5)=>{const _0x1b5ed9=_0x3d8d0a;let _0x49a94e=sharpUtil[_0x1b5ed9(0x143)](_0x261d73),_0x102405=exifUtils[_0x1b5ed9(0x13f)](_0x138cb5);_0x102405?_0x49a94e=_0x49a94e['rotate'](_0x102405):_0x49a94e=_0x49a94e[_0x1b5ed9(0x142)](),_0x49a94e[_0x1b5ed9(0x16d)]()['then'](_0x82273e=>{const _0x127e82=_0x1b5ed9;phash(_0x82273e)[_0x127e82(0x164)](_0x481e53=>{const _0x43f722=_0x127e82;_0x4deadf&&sharpUtil[_0x43f722(0x13d)](_0x261d73),dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id='+_0x83913f['id'])['run'](_0x481e53),_0x642a97();})['catch'](_0x2c2256=>{return _0x4deadf&&sharpUtil['deleteRawTempFile'](_0x261d73),_0x592dac();});})[_0x1b5ed9(0x159)](_0x3ab7ce=>{return _0x592dac();});});}catch(_0x26a199){return _0x592dac();}});}catch(_0x2f88d0){return _0x592dac();}});}function exitProcess(){const _0x219132=_0x10fe01;runComparePhash();try{if(bgTaskId)dbOther[_0x219132(0x13b)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)[_0x219132(0x163)]();}catch(_0xd7eda2){}return process[_0x219132(0x135)]({'type':'close'}),process[_0x219132(0x13e)]();}async function runGenPhashTask(){const _0xcb66ed=_0x10fe01;let _0x268614=dbConfigTable[_0xcb66ed(0x16c)](dbOther,'aiSimilarPhotoEnable');_0x268614&&_0x268614[_0xcb66ed(0x139)]=='1'?runGenPhash()['then'](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0xcb66ed(0x149)](_0xcb66ed(0x151)),exitProcess());}function _0x569b(_0x13bff1,_0x3e1361){const _0x2d5d54=_0x2d5d();return _0x569b=function(_0x569b89,_0x5b580b){_0x569b89=_0x569b89-0x133;let _0xf201fe=_0x2d5d54[_0x569b89];return _0xf201fe;},_0x569b(_0x13bff1,_0x3e1361);}runGenPhashTask();function runComparePhash(){const _0x1bce46=_0x10fe01;try{let _0x5994b7=_0x1bce46(0x13c),_0x1c52bc=dbSourceFolderTable[_0x1bce46(0x136)](dbOther,_0x1bce46(0x153),'excludePathPhoto');_0x1c52bc&&(_0x5994b7+=_0x1bce46(0x155)+_0x1c52bc);let _0x261fe7=dbFileIndex[_0x1bce46(0x13b)](_0x5994b7)[_0x1bce46(0x14a)]();if(_0x261fe7[_0x1bce46(0x138)]<0x1)return;let _0x3e3508='SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20';_0x1c52bc&&(_0x3e3508+=_0x1bce46(0x155)+_0x1c52bc);let _0x3d4c0c=dbFileIndex[_0x1bce46(0x13b)](_0x3e3508)[_0x1bce46(0x14e)]();for(let _0x1bbf40=0x0;_0x1bbf40<_0x3d4c0c[_0x1bce46(0x141)];_0x1bbf40++){let _0xd0fa22=_0x3d4c0c[_0x1bbf40];if(_0xd0fa22[_0x1bce46(0x14f)]==0x1)continue;try{for(let _0x29c4b8=0x0;_0x29c4b8<_0x3d4c0c[_0x1bce46(0x141)];_0x29c4b8++){if(_0x3d4c0c[_0x29c4b8][_0x1bce46(0x14f)]==0x1)continue;if(_0x3d4c0c[_0x1bbf40]['id']==_0x3d4c0c[_0x29c4b8]['id'])continue;try{let _0xd7196d=phashDist(_0x3d4c0c[_0x1bbf40][_0x1bce46(0x14d)],_0x3d4c0c[_0x29c4b8][_0x1bce46(0x14d)]);_0xd7196d<0x9&&(_0x3d4c0c[_0x29c4b8]['phash_compare']=0x1,dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x3d4c0c[_0x29c4b8]['id'])[_0x1bce46(0x163)](),dbFileIndex['prepare'](_0x1bce46(0x16b))['run'](_0x3d4c0c[_0x1bbf40]['id']+'',_0x3d4c0c[_0x29c4b8]['id']+'',_0xd7196d));}catch(_0x7a18d){console[_0x1bce46(0x149)](_0x7a18d);continue;}}}catch(_0x3057d6){console[_0x1bce46(0x149)](_0x3057d6),_0x3d4c0c[_0x1bbf40][_0x1bce46(0x14f)]=0x1,dbFileIndex[_0x1bce46(0x13b)](_0x1bce46(0x133)+_0xd0fa22['id'])[_0x1bce46(0x163)]();continue;}_0x3d4c0c[_0x1bbf40]['phash_compare']=0x1,dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0xd0fa22['id'])[_0x1bce46(0x163)]();}}catch(_0x3d16a5){console[_0x1bce46(0x149)](_0x3d16a5);}}let bgTaskId;try{let info=dbOther['prepare'](_0x10fe01(0x15a))[_0x10fe01(0x163)](_0x10fe01(0x166));bgTaskId=info[_0x10fe01(0x137)];}catch(_0x42dfdf){}process['on'](_0x10fe01(0x14b),(_0x202482,_0x13512d)=>{const _0x21b64f=_0x10fe01;currentDetectIndex&&dbFileIndex[_0x21b64f(0x13b)](_0x21b64f(0x140)+currentDetectIndex['id'])[_0x21b64f(0x163)](),process[_0x21b64f(0x135)]({'type':_0x21b64f(0x13a)}),process[_0x21b64f(0x13e)]();});function _0x2d5d(){const _0x28bc88=['deleteRawTempFile','exit','getRotateFromTags','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','length','rotate','getSharpInstanceFromInput','NasCabDeduplicatePhotos','189804ofdXSB','transSpcielFormat','dbFileIndex','dbOther','log','get','uncaughtException','sharp-phash/distance','phash','all','phash_compare','1950696zZLQam','Similar\x20photo\x20disabled','title','path','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','\x20AND\x20','63XfguIR','1600352jrvNaB','pragma','catch','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','R_OK','sharp-phash','filename','193009qkvMFo','../../utils/exifUtils','../../db/dbSourceFolderTable','constants','692485XQDLUr','run','then','journal_mode\x20=\x20WAL','AI_PHASH','better-sqlite3','2iDSYYZ','280839tYlsRx','132936UciZJC','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','findByTitle','toBuffer','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','../../myConfig/config','send','getExcludePathWhereStr','lastInsertRowid','count','value','close','prepare','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0'];_0x2d5d=function(){return _0x28bc88;};return _0x2d5d();}