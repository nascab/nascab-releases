const _0x4675c5=_0x4162;(function(_0x59d258,_0x1fa4a0){const _0x166855=_0x4162,_0x2bf0db=_0x59d258();while(!![]){try{const _0x654cb5=-parseInt(_0x166855(0x1c6))/0x1*(parseInt(_0x166855(0x1d8))/0x2)+parseInt(_0x166855(0x1b3))/0x3*(-parseInt(_0x166855(0x1a9))/0x4)+parseInt(_0x166855(0x1da))/0x5+parseInt(_0x166855(0x1b9))/0x6*(-parseInt(_0x166855(0x1db))/0x7)+-parseInt(_0x166855(0x1d7))/0x8*(-parseInt(_0x166855(0x1ae))/0x9)+parseInt(_0x166855(0x1c2))/0xa*(parseInt(_0x166855(0x1bc))/0xb)+parseInt(_0x166855(0x1d1))/0xc*(parseInt(_0x166855(0x1d2))/0xd);if(_0x654cb5===_0x1fa4a0)break;else _0x2bf0db['push'](_0x2bf0db['shift']());}catch(_0x28c698){_0x2bf0db['push'](_0x2bf0db['shift']());}}}(_0x34bf,0x1f105));const path=require(_0x4675c5(0x1e6)),fs=require('fs'),config=require(_0x4675c5(0x1bf)),Database=require('better-sqlite3'),dbConfigTable=require(_0x4675c5(0x1e5)),phash=require('sharp-phash'),phashDist=require(_0x4675c5(0x1be)),dbSourceFolderTable=require(_0x4675c5(0x1ce)),sharpUtil=require(_0x4675c5(0x1aa)),exifUtils=require(_0x4675c5(0x1cd));function _0x4162(_0x4fea8e,_0x1c453c){const _0x34bf8b=_0x34bf();return _0x4162=function(_0x416228,_0x2099c0){_0x416228=_0x416228-0x1a9;let _0x5c1828=_0x34bf8b[_0x416228];return _0x5c1828;},_0x4162(_0x4fea8e,_0x1c453c);}process[_0x4675c5(0x1ac)]='NasCabDeduplicatePhotos';let dbFileIndex=new Database(config[_0x4675c5(0x1ca)],{}),dbOther=new Database(config[_0x4675c5(0x1c4)],{});dbOther[_0x4675c5(0x1dd)](_0x4675c5(0x1b0)),dbFileIndex[_0x4675c5(0x1dd)](_0x4675c5(0x1b0)),process['on'](_0x4675c5(0x1d4),()=>{const _0x360ea5=_0x4675c5;dbOther[_0x360ea5(0x1e0)](),dbFileIndex['close']();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x33d1ee=>{const _0x218d8e=_0x4162;let _0x5e6f20;function _0x3aa849(){const _0x9bc537=_0x4162;if(_0x5e6f20)dbFileIndex[_0x9bc537(0x1b5)](_0x9bc537(0x1c7)+_0x5e6f20['id'])['run']();return _0x33d1ee();}try{let _0x487b36=dbConfigTable[_0x218d8e(0x1c5)](dbOther,_0x218d8e(0x1de));if(_0x487b36&&_0x487b36=='1')return setTimeout(_0x33d1ee,DEAL_GAP);let _0x5902aa=_0x218d8e(0x1ba);_0x5902aa+=_0x218d8e(0x1d9),_0x5e6f20=dbFileIndex[_0x218d8e(0x1b5)](_0x5902aa)[_0x218d8e(0x1df)]();if(!_0x5e6f20)return exitProcess();currentDetectIndex=_0x5e6f20;let _0x417c08=path[_0x218d8e(0x1d5)](_0x5e6f20[_0x218d8e(0x1e6)],_0x5e6f20[_0x218d8e(0x1ab)]);try{if(bgTaskId)dbOther[_0x218d8e(0x1b5)](_0x218d8e(0x1e7)+bgTaskId)[_0x218d8e(0x1c8)]();}catch(_0x38c8a9){}fs[_0x218d8e(0x1c0)](_0x417c08,fs[_0x218d8e(0x1af)][_0x218d8e(0x1e2)],async _0x2b7733=>{const _0x573dad=_0x218d8e;if(_0x2b7733)return console[_0x573dad(0x1cf)](_0x2b7733),_0x3aa849();try{sharpUtil['transSpcielFormat'](_0x417c08,(_0x56e44b,_0x362de0,_0x3f4deb)=>{const _0xe97e7e=_0x573dad;let _0x12e5c7=sharpUtil[_0xe97e7e(0x1cc)](_0x56e44b),_0x95d7de=exifUtils[_0xe97e7e(0x1b7)](_0x3f4deb);_0x95d7de?_0x12e5c7=_0x12e5c7[_0xe97e7e(0x1e3)](_0x95d7de):_0x12e5c7=_0x12e5c7[_0xe97e7e(0x1e3)](),_0x12e5c7[_0xe97e7e(0x1d0)]()[_0xe97e7e(0x1bb)](_0x270aa9=>{const _0x519bb9=_0xe97e7e;phash(_0x270aa9)[_0x519bb9(0x1bb)](_0x419328=>{const _0x2d77e5=_0x519bb9;_0x362de0&&sharpUtil[_0x2d77e5(0x1c9)](_0x56e44b),dbFileIndex[_0x2d77e5(0x1b5)]('UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id='+_0x5e6f20['id'])[_0x2d77e5(0x1c8)](_0x419328),_0x33d1ee();})[_0x519bb9(0x1dc)](_0x50510f=>{return _0x362de0&&sharpUtil['deleteRawTempFile'](_0x56e44b),_0x3aa849();});})[_0xe97e7e(0x1dc)](_0x5ec089=>{return _0x3aa849();});});}catch(_0x1d1f92){return _0x3aa849();}});}catch(_0x37e44b){return _0x3aa849();}});}function exitProcess(){const _0x18a218=_0x4675c5;runComparePhash();try{if(bgTaskId)dbOther[_0x18a218(0x1b5)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)[_0x18a218(0x1c8)]();}catch(_0x50e09e){}return process[_0x18a218(0x1b1)]({'type':_0x18a218(0x1e0)}),process['exit']();}async function runGenPhashTask(){const _0x116920=_0x4675c5;let _0x1ef966=dbConfigTable[_0x116920(0x1c5)](dbOther,'aiSimilarPhotoEnable');_0x1ef966&&_0x1ef966['value']=='1'?runGenPhash()[_0x116920(0x1bb)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x116920(0x1cf)](_0x116920(0x1c1)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x2f36a9=_0x4675c5;try{let _0x5eac20=_0x2f36a9(0x1b6),_0x2edd3f=dbSourceFolderTable[_0x2f36a9(0x1ad)](dbOther,_0x2f36a9(0x1e6),'excludePathPhoto');_0x2edd3f&&(_0x5eac20+=_0x2f36a9(0x1e4)+_0x2edd3f);let _0x1c364e=dbFileIndex[_0x2f36a9(0x1b5)](_0x5eac20)[_0x2f36a9(0x1df)]();if(_0x1c364e['count']<0x1)return;let _0x2728ba='SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20';_0x2edd3f&&(_0x2728ba+=_0x2f36a9(0x1e4)+_0x2edd3f);let _0xdc14a7=dbFileIndex['prepare'](_0x2728ba)[_0x2f36a9(0x1b4)]();for(let _0x485249=0x0;_0x485249<_0xdc14a7[_0x2f36a9(0x1cb)];_0x485249++){let _0x20f439=_0xdc14a7[_0x485249];if(_0x20f439[_0x2f36a9(0x1bd)]==0x1)continue;try{for(let _0x4d7406=0x0;_0x4d7406<_0xdc14a7[_0x2f36a9(0x1cb)];_0x4d7406++){if(_0xdc14a7[_0x4d7406][_0x2f36a9(0x1bd)]==0x1)continue;if(_0xdc14a7[_0x485249]['id']==_0xdc14a7[_0x4d7406]['id'])continue;try{let _0x28b40e=phashDist(_0xdc14a7[_0x485249]['phash'],_0xdc14a7[_0x4d7406]['phash']);_0x28b40e<0x9&&(_0xdc14a7[_0x4d7406]['phash_compare']=0x1,dbFileIndex[_0x2f36a9(0x1b5)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0xdc14a7[_0x4d7406]['id'])[_0x2f36a9(0x1c8)](),dbFileIndex[_0x2f36a9(0x1b5)](_0x2f36a9(0x1d3))['run'](_0xdc14a7[_0x485249]['id']+'',_0xdc14a7[_0x4d7406]['id']+'',_0x28b40e));}catch(_0x122aa0){console['log'](_0x122aa0);continue;}}}catch(_0x529c24){console[_0x2f36a9(0x1cf)](_0x529c24),_0xdc14a7[_0x485249][_0x2f36a9(0x1bd)]=0x1,dbFileIndex[_0x2f36a9(0x1b5)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x20f439['id'])['run']();continue;}_0xdc14a7[_0x485249][_0x2f36a9(0x1bd)]=0x1,dbFileIndex[_0x2f36a9(0x1b5)](_0x2f36a9(0x1b8)+_0x20f439['id'])[_0x2f36a9(0x1c8)]();}}catch(_0x5f36d4){console[_0x2f36a9(0x1cf)](_0x5f36d4);}}function _0x34bf(){const _0x1f7b26=['3OvoDoe','all','prepare','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','getRotateFromTags','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','258zsgVuU','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','then','330rroFJo','phash_compare','sharp-phash/distance','../../myConfig/config','access','Similar\x20photo\x20disabled','7750mbdDmD','lastInsertRowid','dbOther','findByTitle','35351TrTuNg','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','run','deleteRawTempFile','dbFileIndex','length','getSharpInstanceFromInput','../../utils/exifUtils','../../db/dbSourceFolderTable','log','toBuffer','3180PctSpg','14339giWftk','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','exit','join','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','763424HpInkQ','2wcaVWK','\x20LIMIT\x201','396780yYIIoF','32067jtGlKX','catch','pragma','file_index_photo-indexing','get','close','uncaughtException','R_OK','rotate','\x20AND\x20','../../db/dbConfigTable','path','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','523032qFsOtO','../../express-server/utils/sharpUtils','filename','title','getExcludePathWhereStr','9GpZPHB','constants','journal_mode\x20=\x20WAL','send','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id='];_0x34bf=function(){return _0x1f7b26;};return _0x34bf();}let bgTaskId;try{let info=dbOther[_0x4675c5(0x1b5)](_0x4675c5(0x1d6))['run']('AI_PHASH');bgTaskId=info[_0x4675c5(0x1c3)];}catch(_0x412b95){}process['on'](_0x4675c5(0x1e1),(_0x543a37,_0x51f61c)=>{const _0x321d19=_0x4675c5;currentDetectIndex&&dbFileIndex[_0x321d19(0x1b5)](_0x321d19(0x1b2)+currentDetectIndex['id'])[_0x321d19(0x1c8)](),process['send']({'type':_0x321d19(0x1e0)}),process['exit']();});