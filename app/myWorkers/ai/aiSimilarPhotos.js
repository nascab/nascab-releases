const _0x5e75ca=_0x7fb8;(function(_0x53eab0,_0x2ccb34){const _0x416810=_0x7fb8,_0x24868e=_0x53eab0();while(!![]){try{const _0x276644=-parseInt(_0x416810(0x7f))/0x1+-parseInt(_0x416810(0x95))/0x2*(parseInt(_0x416810(0x7c))/0x3)+parseInt(_0x416810(0xae))/0x4+-parseInt(_0x416810(0x86))/0x5+parseInt(_0x416810(0x97))/0x6*(parseInt(_0x416810(0x9e))/0x7)+parseInt(_0x416810(0xb4))/0x8+parseInt(_0x416810(0xa6))/0x9;if(_0x276644===_0x2ccb34)break;else _0x24868e['push'](_0x24868e['shift']());}catch(_0x2af1f0){_0x24868e['push'](_0x24868e['shift']());}}}(_0x35ad,0xc2b9a));const path=require('path'),fs=require('fs'),config=require('../../myConfig/config'),Database=require(_0x5e75ca(0xa4)),dbConfigTable=require(_0x5e75ca(0x8d)),phash=require(_0x5e75ca(0x98)),phashDist=require('sharp-phash/distance'),dbSourceFolderTable=require(_0x5e75ca(0x99)),sharpUtil=require(_0x5e75ca(0xac)),exifUtils=require(_0x5e75ca(0x96));function _0x35ad(){const _0x12b64f=['all','prepare','\x20AND\x20','path','count','6114672NntWMY','NasCabDeduplicatePhotos','then','AI_PHASH','phash','3tRZhlz','journal_mode\x20=\x20WAL','log','1569791uZHLYT','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','title','pragma','excludePathPhoto','dbFileIndex','join','7767995vaihgB','getRotateFromTags','getExcludePathWhereStr','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','value','run','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','../../db/dbConfigTable','aiSimilarPhotoEnable','findByTitle','Similar\x20photo\x20disabled','constants','phash_compare','file_index_photo-indexing','transSpcielFormat','536824wvGgKf','../../utils/exifUtils','6obNtsc','sharp-phash','../../db/dbSourceFolderTable','rotate','access','deleteRawTempFile','get','10220371jXoQni','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','catch','exit','toBuffer','send','better-sqlite3','getSharpInstanceFromInput','12173517eJdQcS','close','filename','R_OK','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','../../express-server/utils/sharpUtils','uncaughtException','2449584zXhHkk'];_0x35ad=function(){return _0x12b64f;};return _0x35ad();}process[_0x5e75ca(0x81)]=_0x5e75ca(0xb5);let dbFileIndex=new Database(config[_0x5e75ca(0x84)],{}),dbOther=new Database(config['dbOther'],{});function _0x7fb8(_0x4d66e7,_0xba950e){const _0x35ad01=_0x35ad();return _0x7fb8=function(_0x7fb8c6,_0x2bd1c1){_0x7fb8c6=_0x7fb8c6-0x79;let _0xb8159d=_0x35ad01[_0x7fb8c6];return _0xb8159d;},_0x7fb8(_0x4d66e7,_0xba950e);}dbOther['pragma'](_0x5e75ca(0x7d)),dbFileIndex[_0x5e75ca(0x82)](_0x5e75ca(0x7d)),process['on'](_0x5e75ca(0xa1),()=>{const _0x33b5f9=_0x5e75ca;dbOther[_0x33b5f9(0xa7)](),dbFileIndex[_0x33b5f9(0xa7)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x15db8c=>{const _0x555d82=_0x7fb8;let _0x3abe62;function _0x25623c(){const _0x2ccd6f=_0x7fb8;if(_0x3abe62)dbFileIndex[_0x2ccd6f(0xb0)]('UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id='+_0x3abe62['id'])[_0x2ccd6f(0x8b)]();return _0x15db8c();}try{let _0x594fe8=dbConfigTable[_0x555d82(0x8f)](dbOther,_0x555d82(0x93));if(_0x594fe8&&_0x594fe8=='1')return setTimeout(_0x15db8c,DEAL_GAP);let _0x1247e7=_0x555d82(0x8c);_0x1247e7+='\x20LIMIT\x201',_0x3abe62=dbFileIndex[_0x555d82(0xb0)](_0x1247e7)['get']();if(!_0x3abe62)return exitProcess();currentDetectIndex=_0x3abe62;let _0x453630=path[_0x555d82(0x85)](_0x3abe62[_0x555d82(0xb2)],_0x3abe62[_0x555d82(0xa8)]);try{if(bgTaskId)dbOther[_0x555d82(0xb0)](_0x555d82(0x80)+bgTaskId)[_0x555d82(0x8b)]();}catch(_0x9590c8){}fs[_0x555d82(0x9b)](_0x453630,fs[_0x555d82(0x91)][_0x555d82(0xa9)],async _0x7ea5c0=>{const _0x2752a9=_0x555d82;if(_0x7ea5c0)return console['log'](_0x7ea5c0),_0x25623c();try{sharpUtil[_0x2752a9(0x94)](_0x453630,(_0x5be6ac,_0xa33ff2,_0x2abed1)=>{const _0x4fd213=_0x2752a9;let _0x3b84ed=sharpUtil[_0x4fd213(0xa5)](_0x5be6ac),_0x12e834=exifUtils[_0x4fd213(0x87)](_0x2abed1);_0x12e834?_0x3b84ed=_0x3b84ed[_0x4fd213(0x9a)](_0x12e834):_0x3b84ed=_0x3b84ed['rotate'](),_0x3b84ed[_0x4fd213(0xa2)]()[_0x4fd213(0x79)](_0x2cbe98=>{const _0x88dfe3=_0x4fd213;phash(_0x2cbe98)['then'](_0x14a07a=>{const _0x53d44d=_0x7fb8;_0xa33ff2&&sharpUtil[_0x53d44d(0x9c)](_0x5be6ac),dbFileIndex[_0x53d44d(0xb0)](_0x53d44d(0x89)+_0x3abe62['id'])[_0x53d44d(0x8b)](_0x14a07a),_0x15db8c();})[_0x88dfe3(0xa0)](_0x17bc9c=>{const _0xc1c3b=_0x88dfe3;return _0xa33ff2&&sharpUtil[_0xc1c3b(0x9c)](_0x5be6ac),_0x25623c();});})[_0x4fd213(0xa0)](_0x201be3=>{return _0x25623c();});});}catch(_0x582684){return _0x25623c();}});}catch(_0x3d6173){return _0x25623c();}});}function exitProcess(){const _0x4c1781=_0x5e75ca;runComparePhash();try{if(bgTaskId)dbOther[_0x4c1781(0xb0)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)['run']();}catch(_0x3d2c6){}return process[_0x4c1781(0xa3)]({'type':_0x4c1781(0xa7)}),process[_0x4c1781(0xa1)]();}async function runGenPhashTask(){const _0x52bc85=_0x5e75ca;let _0x454028=dbConfigTable['findByTitle'](dbOther,_0x52bc85(0x8e));_0x454028&&_0x454028[_0x52bc85(0x8a)]=='1'?runGenPhash()[_0x52bc85(0x79)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x52bc85(0x7e)](_0x52bc85(0x90)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x30ece8=_0x5e75ca;try{let _0x536901='SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0',_0x398d45=dbSourceFolderTable[_0x30ece8(0x88)](dbOther,_0x30ece8(0xb2),_0x30ece8(0x83));_0x398d45&&(_0x536901+=_0x30ece8(0xb1)+_0x398d45);let _0x1701f1=dbFileIndex['prepare'](_0x536901)[_0x30ece8(0x9d)]();if(_0x1701f1[_0x30ece8(0xb3)]<0x1)return;let _0x135aa1=_0x30ece8(0xab);_0x398d45&&(_0x135aa1+=_0x30ece8(0xb1)+_0x398d45);let _0x4e6013=dbFileIndex[_0x30ece8(0xb0)](_0x135aa1)[_0x30ece8(0xaf)]();for(let _0x141118=0x0;_0x141118<_0x4e6013['length'];_0x141118++){let _0x2a92fa=_0x4e6013[_0x141118];if(_0x2a92fa[_0x30ece8(0x92)]==0x1)continue;try{for(let _0x869a39=0x0;_0x869a39<_0x4e6013['length'];_0x869a39++){if(_0x4e6013[_0x869a39]['phash_compare']==0x1)continue;if(_0x4e6013[_0x141118]['id']==_0x4e6013[_0x869a39]['id'])continue;try{let _0x8d73e0=phashDist(_0x4e6013[_0x141118][_0x30ece8(0x7b)],_0x4e6013[_0x869a39][_0x30ece8(0x7b)]);_0x8d73e0<0x9&&(_0x4e6013[_0x869a39][_0x30ece8(0x92)]=0x1,dbFileIndex[_0x30ece8(0xb0)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x4e6013[_0x869a39]['id'])[_0x30ece8(0x8b)](),dbFileIndex[_0x30ece8(0xb0)]('REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)')[_0x30ece8(0x8b)](_0x4e6013[_0x141118]['id']+'',_0x4e6013[_0x869a39]['id']+'',_0x8d73e0));}catch(_0x5d348c){console[_0x30ece8(0x7e)](_0x5d348c);continue;}}}catch(_0x5f06f8){console[_0x30ece8(0x7e)](_0x5f06f8),_0x4e6013[_0x141118]['phash_compare']=0x1,dbFileIndex['prepare'](_0x30ece8(0xaa)+_0x2a92fa['id'])[_0x30ece8(0x8b)]();continue;}_0x4e6013[_0x141118][_0x30ece8(0x92)]=0x1,dbFileIndex[_0x30ece8(0xb0)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x2a92fa['id'])[_0x30ece8(0x8b)]();}}catch(_0x2bbe43){console[_0x30ece8(0x7e)](_0x2bbe43);}}let bgTaskId;try{let info=dbOther[_0x5e75ca(0xb0)](_0x5e75ca(0x9f))['run'](_0x5e75ca(0x7a));bgTaskId=info['lastInsertRowid'];}catch(_0x2d70d4){}process['on'](_0x5e75ca(0xad),(_0x33ca04,_0x1700a3)=>{const _0x50d360=_0x5e75ca;currentDetectIndex&&dbFileIndex[_0x50d360(0xb0)]('UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id='+currentDetectIndex['id'])[_0x50d360(0x8b)](),process[_0x50d360(0xa3)]({'type':_0x50d360(0xa7)}),process[_0x50d360(0xa1)]();});