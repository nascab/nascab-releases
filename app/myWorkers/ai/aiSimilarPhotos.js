const _0x1eecf9=_0x449d;(function(_0x2e29c6,_0x9d38c3){const _0x2e5edd=_0x449d,_0x3cbd78=_0x2e29c6();while(!![]){try{const _0x4e1452=-parseInt(_0x2e5edd(0x126))/0x1+-parseInt(_0x2e5edd(0x11f))/0x2+-parseInt(_0x2e5edd(0x119))/0x3*(parseInt(_0x2e5edd(0x121))/0x4)+parseInt(_0x2e5edd(0xfd))/0x5+parseInt(_0x2e5edd(0x110))/0x6+parseInt(_0x2e5edd(0x123))/0x7*(-parseInt(_0x2e5edd(0xf1))/0x8)+parseInt(_0x2e5edd(0xfc))/0x9;if(_0x4e1452===_0x9d38c3)break;else _0x3cbd78['push'](_0x3cbd78['shift']());}catch(_0x83d0c8){_0x3cbd78['push'](_0x3cbd78['shift']());}}}(_0x2489,0xd33d6));const path=require('path'),fs=require('fs'),config=require(_0x1eecf9(0x118)),Database=require(_0x1eecf9(0x12f)),dbConfigTable=require(_0x1eecf9(0x10a)),phash=require(_0x1eecf9(0x11c)),phashDist=require(_0x1eecf9(0x125)),dbSourceFolderTable=require(_0x1eecf9(0x104)),sharpUtil=require(_0x1eecf9(0x107)),exifUtils=require(_0x1eecf9(0x11d));process[_0x1eecf9(0xf0)]=_0x1eecf9(0x127);let dbFileIndex=new Database(config[_0x1eecf9(0xef)],{}),dbOther=new Database(config['dbOther'],{});dbOther['pragma'](_0x1eecf9(0x111)),dbFileIndex[_0x1eecf9(0x100)]('journal_mode\x20=\x20WAL'),process['on'](_0x1eecf9(0xf6),()=>{const _0x735844=_0x1eecf9;dbOther[_0x735844(0xf4)](),dbFileIndex[_0x735844(0xf4)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x5d4cfa=>{const _0x1990a4=_0x449d;let _0x326673;function _0x3bdc1a(){const _0x3d5807=_0x449d;if(_0x326673)dbFileIndex['prepare'](_0x3d5807(0x11e)+_0x326673['id'])[_0x3d5807(0x12a)]();return _0x5d4cfa();}try{let _0x1fe2dc=dbConfigTable[_0x1990a4(0x103)](dbOther,_0x1990a4(0x106));if(_0x1fe2dc&&_0x1fe2dc=='1')return setTimeout(_0x5d4cfa,DEAL_GAP);let _0x47ae3a=_0x1990a4(0x12e);_0x47ae3a+=_0x1990a4(0x113),_0x326673=dbFileIndex['prepare'](_0x47ae3a)[_0x1990a4(0xf8)]();if(!_0x326673)return exitProcess();currentDetectIndex=_0x326673;let _0x386fc3=path[_0x1990a4(0xf2)](_0x326673['path'],_0x326673[_0x1990a4(0xf7)]);try{if(bgTaskId)dbOther[_0x1990a4(0x10c)](_0x1990a4(0x10b)+bgTaskId)[_0x1990a4(0x12a)]();}catch(_0x17e2a0){}fs['access'](_0x386fc3,fs[_0x1990a4(0xfa)][_0x1990a4(0xfb)],async _0x326e1b=>{const _0x4cda29=_0x1990a4;if(_0x326e1b)return console[_0x4cda29(0x12c)](_0x326e1b),_0x3bdc1a();try{sharpUtil[_0x4cda29(0x10f)](_0x386fc3,(_0x25c356,_0x17cae3,_0x41142e)=>{const _0x34f393=_0x4cda29;let _0x121a7c=sharpUtil[_0x34f393(0x102)](_0x25c356),_0x17758b=exifUtils[_0x34f393(0x105)](_0x41142e);_0x17758b?_0x121a7c=_0x121a7c[_0x34f393(0x10e)](_0x17758b):_0x121a7c=_0x121a7c[_0x34f393(0x10e)](),_0x121a7c[_0x34f393(0xf3)]()[_0x34f393(0xfe)](_0x263a72=>{const _0x1592a9=_0x34f393;phash(_0x263a72)['then'](_0x2112e6=>{const _0x12e0ec=_0x449d;_0x17cae3&&sharpUtil[_0x12e0ec(0x12d)](_0x25c356),dbFileIndex[_0x12e0ec(0x10c)](_0x12e0ec(0xff)+_0x326673['id'])[_0x12e0ec(0x12a)](_0x2112e6),_0x5d4cfa();})[_0x1592a9(0xf9)](_0x1e1f16=>{const _0x424982=_0x1592a9;return _0x17cae3&&sharpUtil[_0x424982(0x12d)](_0x25c356),_0x3bdc1a();});})[_0x34f393(0xf9)](_0x31d7cf=>{return _0x3bdc1a();});});}catch(_0x2dbffe){return _0x3bdc1a();}});}catch(_0x127e91){return _0x3bdc1a();}});}function exitProcess(){const _0x41c94a=_0x1eecf9;runComparePhash();try{if(bgTaskId)dbOther[_0x41c94a(0x10c)](_0x41c94a(0x12b)+bgTaskId)[_0x41c94a(0x12a)]();}catch(_0x5d7b95){}return process['send']({'type':_0x41c94a(0xf4)}),process['exit']();}function _0x449d(_0x4cf0fc,_0x1adf91){const _0x248933=_0x2489();return _0x449d=function(_0x449dcd,_0x485933){_0x449dcd=_0x449dcd-0xef;let _0x2b8b21=_0x248933[_0x449dcd];return _0x2b8b21;},_0x449d(_0x4cf0fc,_0x1adf91);}async function runGenPhashTask(){const _0xfc1aba=_0x1eecf9;let _0x498041=dbConfigTable[_0xfc1aba(0x103)](dbOther,_0xfc1aba(0x11b));_0x498041&&_0x498041[_0xfc1aba(0x122)]=='1'?runGenPhash()[_0xfc1aba(0xfe)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0xfc1aba(0x12c)](_0xfc1aba(0x11a)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x3340d8=_0x1eecf9;try{let _0x352ab6=_0x3340d8(0x109),_0x261ab8=dbSourceFolderTable[_0x3340d8(0x116)](dbOther,_0x3340d8(0x101),_0x3340d8(0x114));_0x261ab8&&(_0x352ab6+='\x20AND\x20'+_0x261ab8);let _0x4904b5=dbFileIndex[_0x3340d8(0x10c)](_0x352ab6)[_0x3340d8(0xf8)]();if(_0x4904b5['count']<0x1)return;let _0x21b2c6='SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20';_0x261ab8&&(_0x21b2c6+=_0x3340d8(0xf5)+_0x261ab8);let _0x5b4ebe=dbFileIndex[_0x3340d8(0x10c)](_0x21b2c6)['all']();for(let _0x59cfd0=0x0;_0x59cfd0<_0x5b4ebe[_0x3340d8(0x120)];_0x59cfd0++){let _0x3b465c=_0x5b4ebe[_0x59cfd0];if(_0x3b465c[_0x3340d8(0x108)]==0x1)continue;try{for(let _0x1823c5=0x0;_0x1823c5<_0x5b4ebe[_0x3340d8(0x120)];_0x1823c5++){if(_0x5b4ebe[_0x1823c5][_0x3340d8(0x108)]==0x1)continue;if(_0x5b4ebe[_0x59cfd0]['id']==_0x5b4ebe[_0x1823c5]['id'])continue;try{let _0x551a1b=phashDist(_0x5b4ebe[_0x59cfd0][_0x3340d8(0x124)],_0x5b4ebe[_0x1823c5][_0x3340d8(0x124)]);_0x551a1b<0x9&&(_0x5b4ebe[_0x1823c5][_0x3340d8(0x108)]=0x1,dbFileIndex[_0x3340d8(0x10c)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x5b4ebe[_0x1823c5]['id'])[_0x3340d8(0x12a)](),dbFileIndex[_0x3340d8(0x10c)]('REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)')['run'](_0x5b4ebe[_0x59cfd0]['id']+'',_0x5b4ebe[_0x1823c5]['id']+'',_0x551a1b));}catch(_0x18331f){console[_0x3340d8(0x12c)](_0x18331f);continue;}}}catch(_0x31c876){console[_0x3340d8(0x12c)](_0x31c876),_0x5b4ebe[_0x59cfd0]['phash_compare']=0x1,dbFileIndex[_0x3340d8(0x10c)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x3b465c['id'])[_0x3340d8(0x12a)]();continue;}_0x5b4ebe[_0x59cfd0][_0x3340d8(0x108)]=0x1,dbFileIndex[_0x3340d8(0x10c)](_0x3340d8(0x112)+_0x3b465c['id'])[_0x3340d8(0x12a)]();}}catch(_0xb5a7b2){console[_0x3340d8(0x12c)](_0xb5a7b2);}}let bgTaskId;try{let info=dbOther['prepare'](_0x1eecf9(0x128))[_0x1eecf9(0x12a)](_0x1eecf9(0x117));bgTaskId=info[_0x1eecf9(0x115)];}catch(_0x324de1){}function _0x2489(){const _0x5d15a4=['exit','filename','get','catch','constants','R_OK','31976181NBfMso','4289845cWKIvU','then','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','pragma','path','getSharpInstanceFromInput','findByTitle','../../db/dbSourceFolderTable','getRotateFromTags','file_index_photo-indexing','../../express-server/utils/sharpUtils','phash_compare','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','../../db/dbConfigTable','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','prepare','send','rotate','transSpcielFormat','5656134onCUwv','journal_mode\x20=\x20WAL','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','\x20LIMIT\x201','excludePathPhoto','lastInsertRowid','getExcludePathWhereStr','AI_PHASH','../../myConfig/config','310527xvvshZ','Similar\x20photo\x20disabled','aiSimilarPhotoEnable','sharp-phash','../../utils/exifUtils','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','3212310oVVVIL','length','56CGTCTK','value','5003831zQfwbv','phash','sharp-phash/distance','718215oIQlZD','NasCabDeduplicatePhotos','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','run','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','log','deleteRawTempFile','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','better-sqlite3','dbFileIndex','title','8aWGMWA','join','toBuffer','close','\x20AND\x20'];_0x2489=function(){return _0x5d15a4;};return _0x2489();}process['on']('uncaughtException',(_0x126e73,_0x13d358)=>{const _0x4701be=_0x1eecf9;currentDetectIndex&&dbFileIndex[_0x4701be(0x10c)](_0x4701be(0x129)+currentDetectIndex['id'])[_0x4701be(0x12a)](),process[_0x4701be(0x10d)]({'type':_0x4701be(0xf4)}),process[_0x4701be(0xf6)]();});