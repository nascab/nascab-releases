const _0x3ce42f=_0x14ef;(function(_0xda4559,_0x194349){const _0x3047aa=_0x14ef,_0x5eba56=_0xda4559();while(!![]){try{const _0xa4e10e=-parseInt(_0x3047aa(0x21a))/0x1+parseInt(_0x3047aa(0x1fa))/0x2+-parseInt(_0x3047aa(0x1ec))/0x3*(parseInt(_0x3047aa(0x1ef))/0x4)+parseInt(_0x3047aa(0x1e9))/0x5+-parseInt(_0x3047aa(0x1ff))/0x6+-parseInt(_0x3047aa(0x221))/0x7+parseInt(_0x3047aa(0x1ee))/0x8;if(_0xa4e10e===_0x194349)break;else _0x5eba56['push'](_0x5eba56['shift']());}catch(_0x445939){_0x5eba56['push'](_0x5eba56['shift']());}}}(_0x2ac2,0xea20f));const path=require(_0x3ce42f(0x202)),fs=require('fs'),config=require(_0x3ce42f(0x1ea)),Database=require(_0x3ce42f(0x1f3)),dbConfigTable=require(_0x3ce42f(0x20e)),phash=require('sharp-phash'),phashDist=require(_0x3ce42f(0x223)),dbSourceFolderTable=require(_0x3ce42f(0x20c)),sharpUtil=require(_0x3ce42f(0x222)),exifUtils=require(_0x3ce42f(0x220));function _0x14ef(_0x2b0cdc,_0x4f38cd){const _0x2ac244=_0x2ac2();return _0x14ef=function(_0x14ef7e,_0xf03e98){_0x14ef7e=_0x14ef7e-0x1e8;let _0x53f1b6=_0x2ac244[_0x14ef7e];return _0x53f1b6;},_0x14ef(_0x2b0cdc,_0x4f38cd);}process[_0x3ce42f(0x1f7)]=_0x3ce42f(0x21b);let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x3ce42f(0x205)],{});dbOther[_0x3ce42f(0x224)](_0x3ce42f(0x215)),dbFileIndex[_0x3ce42f(0x224)]('journal_mode\x20=\x20WAL'),process['on'](_0x3ce42f(0x1fe),()=>{const _0x3c7637=_0x3ce42f;dbOther['close'](),dbFileIndex[_0x3c7637(0x217)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x17409c=>{const _0xa9ac4c=_0x14ef;let _0x59fc99;function _0x485109(){const _0x360a05=_0x14ef;if(_0x59fc99)dbFileIndex[_0x360a05(0x207)](_0x360a05(0x1f6)+_0x59fc99['id'])[_0x360a05(0x212)]();return _0x17409c();}try{let _0x3c75bf=dbConfigTable['findByTitle'](dbOther,_0xa9ac4c(0x1f8));if(_0x3c75bf&&_0x3c75bf=='1')return setTimeout(_0x17409c,DEAL_GAP);let _0x29929a=_0xa9ac4c(0x1f2);_0x29929a+=_0xa9ac4c(0x20b),_0x59fc99=dbFileIndex[_0xa9ac4c(0x207)](_0x29929a)['get']();if(!_0x59fc99)return exitProcess();currentDetectIndex=_0x59fc99;let _0x2b8eb8=path['join'](_0x59fc99[_0xa9ac4c(0x202)],_0x59fc99['filename']);try{if(bgTaskId)dbOther[_0xa9ac4c(0x207)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0xa9ac4c(0x212)]();}catch(_0x52cdc2){}fs[_0xa9ac4c(0x1ed)](_0x2b8eb8,fs[_0xa9ac4c(0x216)][_0xa9ac4c(0x206)],async _0x15b48d=>{const _0x2a34fd=_0xa9ac4c;if(_0x15b48d)return console['log'](_0x15b48d),_0x485109();try{sharpUtil[_0x2a34fd(0x1fb)](_0x2b8eb8,(_0x2ffa6f,_0xf15e15,_0xabe394)=>{const _0x2f7db9=_0x2a34fd;let _0x3f953c=sharpUtil[_0x2f7db9(0x20a)](_0x2ffa6f),_0x2301b2=exifUtils['getRotateFromTags'](_0xabe394);_0x2301b2?_0x3f953c=_0x3f953c[_0x2f7db9(0x1f9)](_0x2301b2):_0x3f953c=_0x3f953c['rotate'](),_0x3f953c[_0x2f7db9(0x1e8)]()[_0x2f7db9(0x1fd)](_0x1e1b24=>{const _0x11c45b=_0x2f7db9;phash(_0x1e1b24)[_0x11c45b(0x1fd)](_0x43c310=>{const _0x3e1819=_0x11c45b;_0xf15e15&&sharpUtil['deleteRawTempFile'](_0x2ffa6f),dbFileIndex['prepare'](_0x3e1819(0x218)+_0x59fc99['id'])[_0x3e1819(0x212)](_0x43c310),_0x17409c();})[_0x11c45b(0x1fc)](_0xfbcbe5=>{const _0x4f90a0=_0x11c45b;return _0xf15e15&&sharpUtil[_0x4f90a0(0x21e)](_0x2ffa6f),_0x485109();});})[_0x2f7db9(0x1fc)](_0xc03ed1=>{return _0x485109();});});}catch(_0x3ce548){return _0x485109();}});}catch(_0x3a95e1){return _0x485109();}});}function exitProcess(){const _0x342121=_0x3ce42f;runComparePhash();try{if(bgTaskId)dbOther[_0x342121(0x207)](_0x342121(0x1f5)+bgTaskId)[_0x342121(0x212)]();}catch(_0x44a094){}return process['send']({'type':_0x342121(0x217)}),process[_0x342121(0x1fe)]();}async function runGenPhashTask(){const _0x4a30af=_0x3ce42f;let _0x445704=dbConfigTable['findByTitle'](dbOther,'aiSimilarPhotoEnable');_0x445704&&_0x445704[_0x4a30af(0x204)]=='1'?runGenPhash()[_0x4a30af(0x1fd)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x4a30af(0x209)](_0x4a30af(0x203)),exitProcess());}runGenPhashTask();function _0x2ac2(){const _0xeeaa73=['UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','better-sqlite3','all','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','title','file_index_photo-indexing','rotate','485768BujByz','transSpcielFormat','catch','then','exit','7358622PtctVi','excludePathPhoto','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','path','Similar\x20photo\x20disabled','value','dbOther','R_OK','prepare','getExcludePathWhereStr','log','getSharpInstanceFromInput','\x20LIMIT\x201','../../db/dbSourceFolderTable','AI_PHASH','../../db/dbConfigTable','send','lastInsertRowid','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','run','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','phash_compare','journal_mode\x20=\x20WAL','constants','close','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','1366562rYvJPz','NasCabDeduplicatePhotos','get','\x20AND\x20','deleteRawTempFile','length','../../utils/exifUtils','8053416oNNAJd','../../express-server/utils/sharpUtils','sharp-phash/distance','pragma','toBuffer','4035295GRuSea','../../myConfig/config','uncaughtException','3YhuEtp','access','41186736YbbCnq','5983228vRkihl','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)'];_0x2ac2=function(){return _0xeeaa73;};return _0x2ac2();}function runComparePhash(){const _0x525b16=_0x3ce42f;try{let _0x361928=_0x525b16(0x201),_0x41f122=dbSourceFolderTable[_0x525b16(0x208)](dbOther,_0x525b16(0x202),_0x525b16(0x200));_0x41f122&&(_0x361928+=_0x525b16(0x21d)+_0x41f122);let _0x567bc6=dbFileIndex[_0x525b16(0x207)](_0x361928)[_0x525b16(0x21c)]();if(_0x567bc6['count']<0x1)return;let _0x2ac6e4=_0x525b16(0x211);_0x41f122&&(_0x2ac6e4+=_0x525b16(0x21d)+_0x41f122);let _0x3f48af=dbFileIndex[_0x525b16(0x207)](_0x2ac6e4)[_0x525b16(0x1f4)]();for(let _0x521233=0x0;_0x521233<_0x3f48af['length'];_0x521233++){let _0x566a0c=_0x3f48af[_0x521233];if(_0x566a0c['phash_compare']==0x1)continue;try{for(let _0xc5ff7=0x0;_0xc5ff7<_0x3f48af[_0x525b16(0x21f)];_0xc5ff7++){if(_0x3f48af[_0xc5ff7]['phash_compare']==0x1)continue;if(_0x3f48af[_0x521233]['id']==_0x3f48af[_0xc5ff7]['id'])continue;try{let _0x1649c4=phashDist(_0x3f48af[_0x521233]['phash'],_0x3f48af[_0xc5ff7]['phash']);_0x1649c4<0x9&&(_0x3f48af[_0xc5ff7][_0x525b16(0x214)]=0x1,dbFileIndex['prepare'](_0x525b16(0x219)+_0x3f48af[_0xc5ff7]['id'])[_0x525b16(0x212)](),dbFileIndex[_0x525b16(0x207)](_0x525b16(0x1f0))[_0x525b16(0x212)](_0x3f48af[_0x521233]['id']+'',_0x3f48af[_0xc5ff7]['id']+'',_0x1649c4));}catch(_0x27a7b9){console[_0x525b16(0x209)](_0x27a7b9);continue;}}}catch(_0x375aff){console[_0x525b16(0x209)](_0x375aff),_0x3f48af[_0x521233][_0x525b16(0x214)]=0x1,dbFileIndex[_0x525b16(0x207)](_0x525b16(0x219)+_0x566a0c['id'])[_0x525b16(0x212)]();continue;}_0x3f48af[_0x521233][_0x525b16(0x214)]=0x1,dbFileIndex[_0x525b16(0x207)](_0x525b16(0x219)+_0x566a0c['id'])[_0x525b16(0x212)]();}}catch(_0x586bed){console[_0x525b16(0x209)](_0x586bed);}}let bgTaskId;try{let info=dbOther['prepare'](_0x3ce42f(0x213))['run'](_0x3ce42f(0x20d));bgTaskId=info[_0x3ce42f(0x210)];}catch(_0x21ed06){}process['on'](_0x3ce42f(0x1eb),(_0x322e23,_0x19f117)=>{const _0x5a7344=_0x3ce42f;currentDetectIndex&&dbFileIndex['prepare'](_0x5a7344(0x1f1)+currentDetectIndex['id'])[_0x5a7344(0x212)](),process[_0x5a7344(0x20f)]({'type':_0x5a7344(0x217)}),process[_0x5a7344(0x1fe)]();});