const _0x7bd91e=_0x40b7;function _0x40b7(_0x5b0ca0,_0x1bd989){const _0x2e6bca=_0x2e6b();return _0x40b7=function(_0x40b788,_0x46fcea){_0x40b788=_0x40b788-0x160;let _0xf6b07f=_0x2e6bca[_0x40b788];return _0xf6b07f;},_0x40b7(_0x5b0ca0,_0x1bd989);}(function(_0xc2c60e,_0x4ff10d){const _0x250935=_0x40b7,_0x2d2f21=_0xc2c60e();while(!![]){try{const _0xc4dd5=parseInt(_0x250935(0x178))/0x1+-parseInt(_0x250935(0x174))/0x2+-parseInt(_0x250935(0x181))/0x3*(parseInt(_0x250935(0x166))/0x4)+parseInt(_0x250935(0x18c))/0x5*(parseInt(_0x250935(0x19a))/0x6)+-parseInt(_0x250935(0x173))/0x7*(-parseInt(_0x250935(0x196))/0x8)+parseInt(_0x250935(0x195))/0x9+parseInt(_0x250935(0x188))/0xa*(parseInt(_0x250935(0x185))/0xb);if(_0xc4dd5===_0x4ff10d)break;else _0x2d2f21['push'](_0x2d2f21['shift']());}catch(_0x2ae649){_0x2d2f21['push'](_0x2d2f21['shift']());}}}(_0x2e6b,0x4b63a));const expressApp=require(_0x7bd91e(0x182)),fs=require('fs'),path=require(_0x7bd91e(0x18a)),config=require('../myConfig/config'),Database=require(_0x7bd91e(0x186)),dbConfigTable=require(_0x7bd91e(0x171));let dbNoticeCenterTable=require(_0x7bd91e(0x162));const http=require(_0x7bd91e(0x1a3)),https=require(_0x7bd91e(0x179));let dbOther=new Database(config[_0x7bd91e(0x1a2)],{});dbOther[_0x7bd91e(0x163)](_0x7bd91e(0x160));let tls=require(_0x7bd91e(0x17b));const cryptoUtils=require(_0x7bd91e(0x189));var expressWs=require(_0x7bd91e(0x16e));const messageUtil=require('../utils/messageUtil');process['title']=_0x7bd91e(0x16d);function testCertAndKeyMatch(_0x1d03e6,_0x4ce22b){const _0x4f4067=_0x7bd91e;try{return tls[_0x4f4067(0x194)]({'cert':_0x1d03e6,'key':_0x4ce22b}),!![];}catch(_0x15a833){return![];}}function notifyMainLoadPage(_0x4eb20d){const _0x15f197=_0x7bd91e;currentPort=_0x4eb20d,process[_0x15f197(0x197)]({'type':_0x15f197(0x17c),'exressPort':_0x4eb20d});}function getFreePort(_0x3cbfbd,_0x5feb74){const _0x2f3f72=_0x7bd91e;_0x3cbfbd=parseInt(_0x3cbfbd),isPortFree(_0x3cbfbd)[_0x2f3f72(0x187)](_0x370868=>{_0x370868?_0x5feb74(_0x3cbfbd):(_0x3cbfbd=parseInt(_0x3cbfbd)+0x1,getFreePort(_0x3cbfbd,_0x5feb74));});}function isPortFree(_0x258a86){return new Promise(_0x4fd047=>{const _0x52122a=_0x40b7,_0x12fb85=http[_0x52122a(0x17e)]()[_0x52122a(0x19f)](_0x258a86,()=>{const _0x5d473e=_0x52122a;_0x12fb85[_0x5d473e(0x170)](),_0x4fd047(!![]);})['on'](_0x52122a(0x19b),()=>{_0x4fd047(![]);});});}function setHttpsError(_0x1f9546){const _0x4eef19=_0x7bd91e;console[_0x4eef19(0x18d)](_0x4eef19(0x177),_0x1f9546),dbConfigTable['create'](dbOther,{'title':_0x4eef19(0x17f),'value':JSON[_0x4eef19(0x17d)]({'state':_0x4eef19(0x19b),'port':0x0,'message':_0x1f9546?JSON[_0x4eef19(0x17d)](_0x1f9546):_0x4eef19(0x19b)})}),dbNoticeCenterTable[_0x4eef19(0x165)](dbOther,{'title':_0x4eef19(0x16a),'level':'error','content':_0x1f9546?JSON[_0x4eef19(0x17d)](_0x1f9546):'error'});}function _0x2e6b(){const _0x3bc6f3=['(Encrypted\x20https\x20cert)','join','usePort','https\x20service\x20is\x20not\x20running','-----','expressStartedHttps','NasCabApiWorker','express-ws','appRootPath','close','../db/dbConfigTable','Error\x20occurred\x20in\x20api\x20process','28omCzXa','178256ezPVxE','证书信息:系统默认证书(Default\x20https\x20key)','run','https\x20service\x20is\x20not\x20running\x20','220511jkPKSa','https','stack','tls','expressStarted','stringify','createServer','apiServerHttps','warn','2742ddyzVw','../express-server/app','value','existsSync','88BDVPwP','better-sqlite3','then','220790zKcvrs','../express-server/utils/cryptoUtils','path','证书信息:系统默认证书(Default\x20https\x20cert)','893695LTwGXt','log','startsWith','toString','httpsKey','warning','https\x20service\x20is\x20running','httpsCert','createSecureContext','1665126GuictZ','149664boTsnc','send','certs','(Custom\x20https\x20cert)','6SKapnT','error','readFileSync','(Custom\x20https\x20key)','saveMsg','listen','HTTPS\x20certs\x20error','key.pem','dbOther','http','nasZs987bac','journal_mode\x20=\x20WAL','HTTPS\x20certs\x20not\x20exist','../db/dbNoticeCenterTable','pragma','findByTitle','create','1916MOxXVm'];_0x2e6b=function(){return _0x3bc6f3;};return _0x2e6b();}function startListen(_0x18ec6a){const _0x1d0377=_0x7bd91e;expressApp[_0x1d0377(0x19f)](_0x18ec6a,()=>{const _0xbeeb7c=_0x1d0377;notifyMainLoadPage(_0x18ec6a);try{let _0xe52107=0x1bb,_0x56a008=dbConfigTable[_0xbeeb7c(0x164)](dbOther,'apiPortHttps');_0x56a008&&_0x56a008['value']&&_0x56a008[_0xbeeb7c(0x183)]>0x0&&_0x56a008[_0xbeeb7c(0x183)]<0xffff&&(_0xe52107=_0x56a008[_0xbeeb7c(0x183)]),getFreePort(_0xe52107,async _0x38ab4b=>{const _0x55ccec=_0xbeeb7c;_0xe52107=_0x38ab4b;let _0x159522='',_0xd067b7='',_0x1ce1e9=dbConfigTable[_0x55ccec(0x164)](dbOther,_0x55ccec(0x193));_0x1ce1e9&&_0x1ce1e9['value']&&(_0x159522=_0x1ce1e9['value'],console['log'](_0x55ccec(0x199)));let _0x78af22=dbConfigTable[_0x55ccec(0x164)](dbOther,_0x55ccec(0x190));_0x78af22&&_0x78af22[_0x55ccec(0x183)]&&(_0xd067b7=_0x78af22[_0x55ccec(0x183)],console['log'](_0x55ccec(0x19d)));if(!_0x159522){let _0x5f09d7=path['join'](config[_0x55ccec(0x16f)],'certs','cert.pem');if(!fs[_0x55ccec(0x184)](_0x5f09d7))return setHttpsError(_0x55ccec(0x161));_0x159522=fs['readFileSync'](_0x5f09d7)[_0x55ccec(0x18f)](),console[_0x55ccec(0x18d)](_0x55ccec(0x18b));}if(!_0xd067b7){let _0x58267f=path[_0x55ccec(0x168)](config[_0x55ccec(0x16f)],_0x55ccec(0x198),_0x55ccec(0x1a1));if(!fs[_0x55ccec(0x184)](_0x58267f))return setHttpsError(_0x55ccec(0x161));console[_0x55ccec(0x18d)](_0x55ccec(0x175)),_0xd067b7=fs[_0x55ccec(0x19c)](_0x58267f)[_0x55ccec(0x18f)]();}if(!_0x159522[_0x55ccec(0x18e)](_0x55ccec(0x16b)))try{_0x159522=await cryptoUtils['decryptString'](_0x55ccec(0x1a4),_0x159522),_0xd067b7=await cryptoUtils['decryptString'](_0x55ccec(0x1a4),_0xd067b7),console[_0x55ccec(0x18d)](_0x55ccec(0x167));}catch(_0x41c872){console[_0x55ccec(0x18d)](_0x41c872);}const _0x12918b=testCertAndKeyMatch(_0x159522,_0xd067b7);if(!_0x12918b){setHttpsError(_0x55ccec(0x1a0));return;}const _0x4864c8={'cert':_0x159522,'key':_0xd067b7};let _0x2eb794=https[_0x55ccec(0x17e)](_0x4864c8,expressApp);expressWs(expressApp,_0x2eb794),_0x2eb794[_0x55ccec(0x19f)](_0xe52107,_0x3bc74c=>{const _0x312681=_0x55ccec;process[_0x312681(0x197)]({'type':_0x312681(0x16c),'exressPort':_0xe52107}),dbConfigTable[_0x312681(0x165)](dbOther,{'title':_0x312681(0x17f),'value':JSON['stringify']({'state':_0x312681(0x176),'port':_0xe52107,'message':_0x312681(0x192)})});}),_0x2eb794['on']('error',_0x22139d=>{const _0x3f5956=_0x55ccec;console['log'](_0x22139d),dbConfigTable[_0x3f5956(0x165)](dbOther,{'title':_0x3f5956(0x17f),'value':JSON[_0x3f5956(0x17d)]({'state':_0x3f5956(0x19b),'port':_0xe52107,'message':_0x3f5956(0x16a)})});});});}catch(_0x1e9b16){console[_0xbeeb7c(0x18d)](_0x1e9b16),setHttpsError(_0x1e9b16);}});}process['on']('uncaughtException',(_0x5e7111,_0x3692ae)=>{const _0x463bb3=_0x7bd91e;console['log']('Error\x20occurred\x20in\x20api\x20process\x20',_0x5e7111),messageUtil[_0x463bb3(0x19e)](dbOther,_0x463bb3(0x172),_0x463bb3(0x19b),_0x5e7111[_0x463bb3(0x17a)]||_0x5e7111['message']);}),process['on'](_0x7bd91e(0x191),_0xd36f47=>console[_0x7bd91e(0x180)](_0xd36f47[_0x7bd91e(0x17a)])),startListen(process['env'][_0x7bd91e(0x169)]);