function _0x332a(){const _0x5e3cd3=['.webp','539970fHiRaE','transSpcielFormat','24CRbzQs','toString','stream','imgZip','existsSync','webp','multer','test','rename','SAMENAME','file','close','single','jpeg','base64originalName','删除压缩后的文件失败','../../db/dbFileOperationRecord','filename','path','decodePath','base64','inside','over','4792eZNRvy','8FZrBWs','stat','../utils/fileUtils','skip','ctime','exports','username','imageTooLarge','statusCode','9580KosJbu','includes','body','上传文件移动到最终位置','log','uploadStartTime','withMeta','jpg','sameNameFileAlreadExist','torrentPath','app','emit','saveFullPath','replace','originalname','getTime','2NtJuCt','png','withMetadata','unlink','mkdir','query','STATE_SUC','json','uploadTempFilePrefix','76793GxPiOA','删除压缩前的文件失败','../utils/sharpUtils','771GmErDv','dirname','overMode','addFileOperationRecord','getFileTime','uploadFile','outSize','2904748RifYXM','length','压缩失败了','utimesSync','then','1554900XTFLOG','3453237LGIJOs','saveByDate','basename','../../myConfig/config','toLowerCase','output','message','from','diskStorage','end','nascab_torrentSavePath','toFile','uploadSubtitle','mkdirSync','savePath','returnFileError','size','getMonth','join','Connection','21LkeZLv'];_0x332a=function(){return _0x5e3cd3;};return _0x332a();}const _0x5220b5=_0x344e;(function(_0x3b48e1,_0x4401f7){const _0x8a3709=_0x344e,_0x10faea=_0x3b48e1();while(!![]){try{const _0x57f226=-parseInt(_0x8a3709(0x1c9))/0x1*(-parseInt(_0x8a3709(0x1c0))/0x2)+parseInt(_0x8a3709(0x1cc))/0x3*(-parseInt(_0x8a3709(0x1a6))/0x4)+parseInt(_0x8a3709(0x1d8))/0x5+parseInt(_0x8a3709(0x1ef))/0x6*(parseInt(_0x8a3709(0x1ed))/0x7)+-parseInt(_0x8a3709(0x1a7))/0x8*(-parseInt(_0x8a3709(0x1d9))/0x9)+-parseInt(_0x8a3709(0x1b0))/0xa+parseInt(_0x8a3709(0x1d3))/0xb*(-parseInt(_0x8a3709(0x1f1))/0xc);if(_0x57f226===_0x4401f7)break;else _0x10faea['push'](_0x10faea['shift']());}catch(_0x5f011d){_0x10faea['push'](_0x10faea['shift']());}}}(_0x332a,0x31eb7));const fs=require('fs'),path=require('path'),uploadUtil={},multer=require(_0x5220b5(0x1f7)),fileUtil=require(_0x5220b5(0x1a9)),config=require(_0x5220b5(0x1dc)),mediaUtils=require('../../utils/mediaUtils');let dbFileOperationRecord=require(_0x5220b5(0x19f)),sharpUtil=require(_0x5220b5(0x1cb));function getOverMode(_0x24f283){const _0xb4c443=_0x5220b5;let _0x4a8c32=_0x24f283[_0xb4c443(0x1c5)][_0xb4c443(0x1ce)]||_0x24f283[_0xb4c443(0x1b2)]['overMode'];return!_0x4a8c32&&(_0x4a8c32=_0xb4c443(0x1aa)),_0x4a8c32;}const storage=multer[_0x5220b5(0x1e1)]({'destination':function(_0x2f7ee7,_0x43d0e5,_0x5e9dce){const _0x57dde4=_0x5220b5;let _0x446135=_0x2f7ee7['query'][_0x57dde4(0x1e7)];if(_0x2f7ee7[_0x57dde4(0x1c5)][_0x57dde4(0x1a0)]){let _0x1495ef=_0x2f7ee7[_0x57dde4(0x1c5)][_0x57dde4(0x1a0)];try{_0x1495ef=decodeURIComponent(_0x1495ef);}catch(_0x5c3266){}_0x43d0e5['originalname']=_0x1495ef;}let _0x34ea4f=path[_0x57dde4(0x1eb)](_0x446135,_0x43d0e5[_0x57dde4(0x1be)]),_0x470551=getOverMode(_0x2f7ee7);fs['stat'](_0x34ea4f,(_0x56d9ea,_0x1cf391)=>{const _0x564f14=_0x57dde4;if(!_0x56d9ea){if(_0x2f7ee7[_0x564f14(0x1c5)][_0x564f14(0x1da)]!=0x1){if(_0x470551==_0x564f14(0x1aa))return _0x5e9dce(new Error(_0x564f14(0x198)));else{if(_0x470551==_0x564f14(0x197))_0x43d0e5[_0x564f14(0x1be)]=new Date()[_0x564f14(0x1bf)]()+_0x43d0e5['originalname'];else{if(_0x470551==_0x564f14(0x1a5)){}}}}}_0x2f7ee7[_0x564f14(0x1c5)][_0x564f14(0x1be)]=_0x43d0e5['originalname'][_0x564f14(0x1bd)](/[<>\\\/:\*\?\"\|]/g,'_'),_0x43d0e5['originalname']=(config[_0x564f14(0x1c8)]+_0x43d0e5['originalname'])[_0x564f14(0x1bd)](/[<>\\\/:\*\?\"\|]/g,'_'),_0x34ea4f=path[_0x564f14(0x1eb)](_0x446135,_0x43d0e5[_0x564f14(0x1be)]),_0x2f7ee7[_0x564f14(0x1c5)]['saveFullPath']=_0x34ea4f,_0x2f7ee7['on']('close',()=>{const _0xf64e76=_0x564f14;!_0x2f7ee7['complete']&&(_0x43d0e5[_0xf64e76(0x1f3)]['on'](_0xf64e76(0x1e2),()=>{const _0x217fb3=_0xf64e76;fs[_0x217fb3(0x1c3)](_0x34ea4f,_0x14e155=>{const _0x3650f9=_0x217fb3;console[_0x3650f9(0x1b4)]('清除临时文件',_0x34ea4f);});}),_0x43d0e5[_0xf64e76(0x1f3)][_0xf64e76(0x1bb)](_0xf64e76(0x1e2)));}),_0x5e9dce(null,_0x446135);});},'filename':function(_0x394b69,_0x110665,_0x1479a9){const _0x1a29e7=_0x5220b5;_0x394b69[_0x1a29e7(0x1c5)][_0x1a29e7(0x19d)]?_0x1479a9(null,Buffer[_0x1a29e7(0x1e0)](_0x110665['originalname'])[_0x1a29e7(0x1f2)](_0x1a29e7(0x1a3))):_0x1479a9(null,_0x110665['originalname']);}});function dealImageCompress(_0x506fae,_0x21e86d,_0x21c4b7){const _0x89b346=_0x5220b5;let _0x26bf6c=_0x506fae[_0x89b346(0x199)][_0x89b346(0x1e9)];if(_0x26bf6c<=0x400*0x400*0x50){let _0x44b400=path[_0x89b346(0x1eb)](path[_0x89b346(0x1cd)](_0x21c4b7),_0x89b346(0x1de),path[_0x89b346(0x1db)](_0x21c4b7)),_0x5904dc=path['extname'](path[_0x89b346(0x1db)](_0x21c4b7))[_0x89b346(0x1dd)]();sharpUtil[_0x89b346(0x1f0)](_0x21c4b7,_0xb80ddd=>{const _0x3a4b88=_0x89b346;let _0x311806=sharpUtil['getSharpInstanceFromInput'](_0xb80ddd),_0x5d8f6c=_0x506fae[_0x3a4b88(0x1c5)]['zipQuality']||0x50,_0x2c1b6e=_0x506fae[_0x3a4b88(0x1c5)]['zipFormat'],_0x11427a=_0x506fae['query'][_0x3a4b88(0x1d2)];if(_0x2c1b6e)_0x2c1b6e=_0x2c1b6e[_0x3a4b88(0x1dd)]();try{_0x11427a&&(_0x11427a=parseInt(_0x11427a)),_0x5d8f6c=parseInt(_0x5d8f6c);}catch(_0x3413b1){}let _0x3f8bdb=_0x506fae[_0x3a4b88(0x1c5)][_0x3a4b88(0x1b6)]==0x1,_0x19a4eb=_0x3a4b88(0x19c);if(_0x2c1b6e&&[_0x3a4b88(0x1c1),_0x3a4b88(0x1f6),_0x3a4b88(0x19c)][_0x3a4b88(0x1b1)](_0x2c1b6e))_0x19a4eb=_0x2c1b6e;else{if(_0x5904dc=='.png')_0x19a4eb=_0x3a4b88(0x1c1);else _0x5904dc==_0x3a4b88(0x1ee)&&(_0x19a4eb=_0x3a4b88(0x1f6));}_0x44b400=_0x44b400[_0x3a4b88(0x1bd)](_0x5904dc,'.'+_0x19a4eb);if(_0x19a4eb==_0x3a4b88(0x1c1))_0x311806['png']({'quality':_0x5d8f6c,'palette':!![],'compressionLevel':0x9});else _0x19a4eb==_0x3a4b88(0x1f6)?_0x311806[_0x3a4b88(0x1f6)]({'quality':_0x5d8f6c}):_0x311806['jpeg']({'quality':_0x5d8f6c,'mozjpeg':!![]});_0x3f8bdb&&_0x311806[_0x3a4b88(0x1c2)]();_0x11427a&&_0x11427a>0x0&&_0x11427a<0x1869f&&_0x311806['resize']({'width':_0x11427a,'height':_0x11427a,'fit':_0x3a4b88(0x1a4),'withoutEnlargement':!![]});let _0x34fd9a=path[_0x3a4b88(0x1cd)](_0x44b400);fs[_0x3a4b88(0x1c4)](_0x34fd9a,{'recursive':!![]},_0x1e184e=>{const _0x404e29=_0x3a4b88;_0x311806[_0x404e29(0x1e4)](_0x44b400,(_0x2cdb92,_0x4e304a)=>{const _0x3a60ca=_0x404e29;if(_0x2cdb92)return console[_0x3a60ca(0x1b4)](_0x3a60ca(0x1d5),_0x2cdb92),_0x21e86d['json']({'code':0x1,'message':_0x21e86d['__']('imageZipFail')});else fs[_0x3a60ca(0x1a8)](_0x44b400,(_0x2cd9c2,_0x3cadf1)=>{const _0x422a98=_0x3a60ca;let _0x4298f1=0x0;_0x3cadf1&&(_0x4298f1=_0x3cadf1['size']);let _0x31fe35=_0x5904dc['replace']('.','');if(_0x31fe35==_0x422a98(0x1b7))_0x31fe35=_0x422a98(0x19c);_0x4298f1>_0x26bf6c&&_0x31fe35==_0x19a4eb&&!_0x4298f1?fs[_0x422a98(0x1c3)](_0x44b400,_0x31adda=>{const _0x4eaf04=_0x422a98;return _0x31adda&&console[_0x4eaf04(0x1b4)](_0x4eaf04(0x19e),_0x31adda),_0x21e86d[_0x4eaf04(0x1c7)]({'code':0x0,'inputSize':_0x26bf6c,'outputFullPath':_0x21c4b7,'outputSize':_0x26bf6c,'outputFormat':_0x5904dc[_0x4eaf04(0x1bd)]('.',''),'uploadStartTime':_0x506fae['query'][_0x4eaf04(0x1b5)]});}):fs[_0x422a98(0x1c3)](_0x21c4b7,_0x393278=>{const _0x1954d1=_0x422a98;return _0x393278&&console[_0x1954d1(0x1b4)](_0x1954d1(0x1ca),_0x393278),_0x21e86d[_0x1954d1(0x1c7)]({'code':0x0,'inputSize':_0x26bf6c,'outputFullPath':_0x44b400,'outputSize':_0x4298f1,'outputFormat':_0x19a4eb,'uploadStartTime':_0x506fae[_0x1954d1(0x1c5)][_0x1954d1(0x1b5)]});});});});});});}else return _0x21e86d[_0x89b346(0x1c7)]({'code':0x1,'message':_0x21e86d['__'](_0x89b346(0x1ae))});}const multerUpload=multer({'storage':storage})[_0x5220b5(0x19b)](_0x5220b5(0x199));function _0x344e(_0x2296a6,_0x1b5c1d){const _0x332a21=_0x332a();return _0x344e=function(_0x344e24,_0x1fd4e8){_0x344e24=_0x344e24-0x197;let _0x543949=_0x332a21[_0x344e24];return _0x543949;},_0x344e(_0x2296a6,_0x1b5c1d);}uploadUtil[_0x5220b5(0x1d1)]=function(_0x2d724d,_0x24fe28,_0xaaa408,_0x53905b,_0xff5b19,_0x36c994,_0x39eed1){const _0x564891=_0x5220b5;let _0x4279e2=_0x2d724d[_0x564891(0x1c5)]['savePath']||_0x2d724d['body'][_0x564891(0x1e7)];if(_0x2d724d[_0x564891(0x1c5)][_0x564891(0x1e5)]==0x1){let _0x5b6777=path[_0x564891(0x1eb)](config['subtitlePath'],'upload');_0x4279e2=_0x5b6777;}else _0xff5b19&&(_0x2d724d[_0x564891(0x1c5)][_0x564891(0x19d)]=!![]),_0xaaa408&&(_0x4279e2=fileUtil[_0x564891(0x1a2)](_0x4279e2));if(_0x4279e2==_0x564891(0x1e3)){let _0x1514b8=path[_0x564891(0x1eb)](config[_0x564891(0x1b9)]);_0x4279e2=_0x1514b8;}_0x2d724d[_0x564891(0x1c5)][_0x564891(0x1e7)]=_0x4279e2,multerUpload(_0x2d724d,_0x24fe28,function(_0x77999c){const _0x7d5a41=_0x564891;if(_0x77999c)return _0x77999c[_0x7d5a41(0x1df)]==_0x7d5a41(0x198)?(_0x24fe28[_0x7d5a41(0x1af)]=0xc8,_0x24fe28['set'](_0x7d5a41(0x1ec),_0x7d5a41(0x19a)),_0x24fe28['json']({'code':0x1,'remark':_0x7d5a41(0x198),'message':_0x24fe28['__']('sameNameFileAlreadExist')})):(_0x39eed1&&_0x39eed1(_0x77999c),fileUtil[_0x7d5a41(0x1e8)](_0x24fe28,_0x77999c));if(!_0x2d724d[_0x7d5a41(0x1c5)][_0x7d5a41(0x1be)]){_0x39eed1&&_0x39eed1(_0x77999c);return;}fs['stat'](_0x2d724d[_0x7d5a41(0x1c5)][_0x7d5a41(0x1bc)],(_0x5bc96f,_0x5ce06a)=>{if(_0x5bc96f){_0x39eed1&&_0x39eed1(_0x5bc96f);return;}_0x5ce06a['isFile']()&&_0x162c23();});});function _0x162c23(){const _0x2cf939=_0x564891;if(_0x2d724d[_0x2cf939(0x1c5)][_0x2cf939(0x1da)]==0x1)mediaUtils[_0x2cf939(0x1d0)](_0x2d724d['query'][_0x2cf939(0x1bc)])[_0x2cf939(0x1d7)](_0x345fc1=>{const _0x18aebd=_0x2cf939;if(parseInt(_0x345fc1)>Date['now']()-0x2710)try{_0x2d724d['query'][_0x18aebd(0x1ab)]&&/^[0-9]{10}$/[_0x18aebd(0x1f8)](_0x2d724d['query'][_0x18aebd(0x1ab)])&&(_0x345fc1=parseInt(_0x2d724d['query']['ctime'])*0x3e8);}catch(_0x21ea3b){}let _0x1b1b2c=new Date(_0x345fc1),_0x5f032b=_0x1b1b2c['getFullYear'](),_0x29bcaa=_0x1b1b2c[_0x18aebd(0x1ea)]()+0x1,_0x4a0897=_0x1b1b2c['getDate'](),_0xec54c5=path[_0x18aebd(0x1eb)](_0x2d724d['query'][_0x18aebd(0x1e7)],_0x5f032b+'',_0x29bcaa+'',_0x4a0897+'');!fs['existsSync'](_0xec54c5)&&fs[_0x18aebd(0x1e6)](_0xec54c5,{'recursive':!![]});let _0x24221c=_0x2d724d[_0x18aebd(0x1c5)][_0x18aebd(0x1be)],_0x327fc7=fs[_0x18aebd(0x1f5)](path[_0x18aebd(0x1eb)](_0xec54c5,_0x24221c));if(_0x327fc7){let _0x4cb87e=getOverMode(_0x2d724d);if(_0x4cb87e=='skip')return _0x2d724d['query'][_0x18aebd(0x1bc)]['includes'](config[_0x18aebd(0x1c8)])&&fs['unlink'](_0x2d724d[_0x18aebd(0x1c5)][_0x18aebd(0x1bc)],_0x2c6e38=>{const _0x20471f=_0x18aebd;_0x2c6e38&&console[_0x20471f(0x1b4)]('删除已上传的文件失败',_0x2c6e38),console[_0x20471f(0x1b4)]('临时文件已删除');}),_0x24fe28['statusCode']=0xc8,_0x24fe28['set'](_0x18aebd(0x1ec),_0x18aebd(0x19a)),_0x24fe28['json']({'code':0x1,'remark':_0x18aebd(0x198),'message':_0x24fe28['__'](_0x18aebd(0x1b8))});else _0x4cb87e=='rename'&&(_0x24221c=new Date()[_0x18aebd(0x1bf)]()+_0x24221c);}let _0x4cf82b=path[_0x18aebd(0x1eb)](_0xec54c5,_0x24221c);_0x5da1d5(_0x4cf82b);});else{let _0x2acad0=path[_0x2cf939(0x1eb)](_0x2d724d[_0x2cf939(0x1c5)][_0x2cf939(0x1e7)],_0x2d724d[_0x2cf939(0x1c5)]['originalname']);_0x5da1d5(_0x2acad0);}function _0x5da1d5(_0x56b94c){const _0x3e2e93=_0x2cf939;console['log'](_0x3e2e93(0x1b3),_0x56b94c),fs['rename'](_0x2d724d[_0x3e2e93(0x1c5)][_0x3e2e93(0x1bc)],_0x56b94c,_0x2428f0=>{const _0x36419e=_0x3e2e93;if(_0x2428f0)return _0x39eed1&&_0x39eed1(_0x2428f0),fileUtil[_0x36419e(0x1e8)](_0x24fe28,_0x2428f0);else{if(_0x2d724d[_0x36419e(0x1c5)][_0x36419e(0x1f4)]==0x1)return dealImageCompress(_0x2d724d,_0x24fe28,_0x56b94c);dbFileOperationRecord[_0x36419e(0x1cf)](_0x2d724d[_0x36419e(0x1ba)]['dbOther'],{'username':_0x2d724d['currentUser'][_0x36419e(0x1ad)],'targetPath':_0x56b94c,'level':dbFileOperationRecord['LEVEL_MAIN_OPERATION'],'type':dbFileOperationRecord['TYPE_UPLOAD'],'state':dbFileOperationRecord[_0x36419e(0x1c6)]}),_0x2d724d['file'][_0x36419e(0x1a1)]=_0x56b94c,_0x2d724d[_0x36419e(0x199)][_0x36419e(0x1a0)]=_0x2d724d[_0x36419e(0x1c5)][_0x36419e(0x1be)];let _0x5a59f5=_0x2d724d[_0x36419e(0x1b2)][_0x36419e(0x1ab)]||_0x2d724d['query']['ctime'];try{if(_0x5a59f5){_0x5a59f5=_0x5a59f5+'';if(_0x5a59f5[_0x36419e(0x1d4)]==0xa)fs[_0x36419e(0x1d6)](_0x56b94c,_0x5a59f5,_0x5a59f5);else{}}}catch(_0x58bed3){}_0x36c994&&_0x36c994(_0x2d724d[_0x36419e(0x199)]);if(!_0x53905b)return _0x24fe28['json']({'code':0x0,'file':_0x2d724d[_0x36419e(0x199)]});}});}}},module[_0x5220b5(0x1ac)]=uploadUtil;