const _0x155524=_0x55db;(function(_0x422b5e,_0x19b982){const _0x1a2af4=_0x55db,_0x4c0eaa=_0x422b5e();while(!![]){try{const _0x5c72e6=parseInt(_0x1a2af4(0x1c9))/0x1+parseInt(_0x1a2af4(0x18e))/0x2*(-parseInt(_0x1a2af4(0x1de))/0x3)+-parseInt(_0x1a2af4(0x1cc))/0x4*(-parseInt(_0x1a2af4(0x1d5))/0x5)+parseInt(_0x1a2af4(0x1a5))/0x6+parseInt(_0x1a2af4(0x1c2))/0x7+parseInt(_0x1a2af4(0x1a2))/0x8+-parseInt(_0x1a2af4(0x1c6))/0x9;if(_0x5c72e6===_0x19b982)break;else _0x4c0eaa['push'](_0x4c0eaa['shift']());}catch(_0xb136f6){_0x4c0eaa['push'](_0x4c0eaa['shift']());}}}(_0x4063,0xc5dde));const fs=require('fs'),path=require(_0x155524(0x1a6)),uploadUtil={},multer=require(_0x155524(0x1b0)),fileUtil=require('../utils/fileUtils'),config=require('../../myConfig/config'),mediaUtils=require('../../utils/mediaUtils');let dbFileOperationRecord=require(_0x155524(0x1dd)),sharpUtil=require(_0x155524(0x1af));function getOverMode(_0xac0664){const _0x4493e6=_0x155524;let _0x5b183e=_0xac0664[_0x4493e6(0x18f)][_0x4493e6(0x1da)]||_0xac0664[_0x4493e6(0x1c5)][_0x4493e6(0x1da)];return!_0x5b183e&&(_0x5b183e=_0x4493e6(0x1ca)),_0x5b183e;}const storage=multer['diskStorage']({'destination':function(_0x1599f5,_0x3b5f6f,_0x2c399b){const _0x3dff94=_0x155524;let _0x498e67=_0x1599f5['query'][_0x3dff94(0x1e2)];if(_0x1599f5[_0x3dff94(0x18f)][_0x3dff94(0x1d3)]){let _0x3e3737=_0x1599f5[_0x3dff94(0x18f)][_0x3dff94(0x1d3)];try{_0x3e3737=decodeURIComponent(_0x3e3737);}catch(_0x292251){}_0x3b5f6f['originalname']=_0x3e3737;}let _0x26a0c9=path[_0x3dff94(0x1be)](_0x498e67,_0x3b5f6f['originalname']),_0x5e1768=getOverMode(_0x1599f5);fs[_0x3dff94(0x195)](_0x26a0c9,(_0x57909e,_0x5b259d)=>{const _0x21bf0a=_0x3dff94;if(!_0x57909e){if(_0x1599f5[_0x21bf0a(0x18f)][_0x21bf0a(0x1d1)]!=0x1){if(_0x5e1768==_0x21bf0a(0x1ca))return _0x2c399b(new Error(_0x21bf0a(0x191)));else{if(_0x5e1768=='rename')_0x3b5f6f['originalname']=new Date()[_0x21bf0a(0x1e0)]()+_0x3b5f6f[_0x21bf0a(0x1bf)];else{if(_0x5e1768==_0x21bf0a(0x1e4)){}}}}}_0x1599f5[_0x21bf0a(0x18f)][_0x21bf0a(0x1bf)]=_0x3b5f6f[_0x21bf0a(0x1bf)][_0x21bf0a(0x1b9)](/[<>\\\/:\*\?\"\|]/g,'_'),_0x3b5f6f[_0x21bf0a(0x1bf)]=(config[_0x21bf0a(0x1ad)]+_0x3b5f6f[_0x21bf0a(0x1bf)])[_0x21bf0a(0x1b9)](/[<>\\\/:\*\?\"\|]/g,'_'),_0x26a0c9=path[_0x21bf0a(0x1be)](_0x498e67,_0x3b5f6f[_0x21bf0a(0x1bf)]),_0x1599f5['query'][_0x21bf0a(0x1ba)]=_0x26a0c9,_0x1599f5['on'](_0x21bf0a(0x19b),()=>{const _0x36c6ee=_0x21bf0a;!_0x1599f5['complete']&&(_0x3b5f6f[_0x36c6ee(0x1e1)]['on'](_0x36c6ee(0x1c4),()=>{const _0x5404f9=_0x36c6ee;fs[_0x5404f9(0x1db)](_0x26a0c9,_0x2682cf=>{const _0x48f4e2=_0x5404f9;console['log'](_0x48f4e2(0x1b1),_0x26a0c9);});}),_0x3b5f6f[_0x36c6ee(0x1e1)][_0x36c6ee(0x1a3)]('end'));}),_0x2c399b(null,_0x498e67);});},'filename':function(_0x47ffbe,_0x4249b6,_0x5787eb){const _0x142b2d=_0x155524;_0x47ffbe[_0x142b2d(0x18f)]['base64originalName']?_0x5787eb(null,Buffer['from'](_0x4249b6['originalname'])['toString']('base64')):_0x5787eb(null,_0x4249b6['originalname']);}});function _0x55db(_0x7eef4a,_0x20aeab){const _0x4063c5=_0x4063();return _0x55db=function(_0x55db96,_0x57e7a0){_0x55db96=_0x55db96-0x18b;let _0x2f2597=_0x4063c5[_0x55db96];return _0x2f2597;},_0x55db(_0x7eef4a,_0x20aeab);}function dealImageCompress(_0x1beaab,_0x498d42,_0x202a64){const _0x4f0320=_0x155524;let _0x264c0e=_0x1beaab[_0x4f0320(0x197)][_0x4f0320(0x1c7)];if(_0x264c0e<=0x400*0x400*0x50){let _0x26bfd6=path[_0x4f0320(0x1be)](path[_0x4f0320(0x1a0)](_0x202a64),_0x4f0320(0x1aa),path['basename'](_0x202a64)),_0x52d60b=path['extname'](path['basename'](_0x202a64))['toLowerCase']();sharpUtil['transSpcielFormat'](_0x202a64,_0x4e7c52=>{const _0x2544e1=_0x4f0320;let _0x12ba15=sharpUtil[_0x2544e1(0x1df)](_0x4e7c52),_0x59aa4=_0x1beaab[_0x2544e1(0x18f)][_0x2544e1(0x1c1)]||0x50,_0x4aeb6c=_0x1beaab[_0x2544e1(0x18f)][_0x2544e1(0x190)],_0x330798=_0x1beaab[_0x2544e1(0x18f)][_0x2544e1(0x1a7)];if(_0x4aeb6c)_0x4aeb6c=_0x4aeb6c[_0x2544e1(0x1b3)]();try{_0x330798&&(_0x330798=parseInt(_0x330798)),_0x59aa4=parseInt(_0x59aa4);}catch(_0x28bd93){}let _0x46709=_0x1beaab['query'][_0x2544e1(0x19e)]==0x1,_0x28e4b5=_0x2544e1(0x19f);if(_0x4aeb6c&&[_0x2544e1(0x1b8),'webp',_0x2544e1(0x19f)][_0x2544e1(0x1e3)](_0x4aeb6c))_0x28e4b5=_0x4aeb6c;else{if(_0x52d60b==_0x2544e1(0x1c3))_0x28e4b5=_0x2544e1(0x1b8);else _0x52d60b==_0x2544e1(0x1d8)&&(_0x28e4b5=_0x2544e1(0x1b4));}_0x26bfd6=_0x26bfd6[_0x2544e1(0x1b9)](_0x52d60b,'.'+_0x28e4b5);if(_0x28e4b5==_0x2544e1(0x1b8))_0x12ba15['png']({'quality':_0x59aa4,'palette':!![],'compressionLevel':0x9});else _0x28e4b5==_0x2544e1(0x1b4)?_0x12ba15[_0x2544e1(0x1b4)]({'quality':_0x59aa4}):_0x12ba15[_0x2544e1(0x19f)]({'quality':_0x59aa4,'mozjpeg':!![]});_0x46709&&_0x12ba15[_0x2544e1(0x1ae)]();_0x330798&&_0x330798>0x0&&_0x330798<0x1869f&&_0x12ba15[_0x2544e1(0x1e8)]({'width':_0x330798,'height':_0x330798,'fit':'inside','withoutEnlargement':!![]});let _0x37c8a1=path[_0x2544e1(0x1a0)](_0x26bfd6);fs[_0x2544e1(0x1b7)](_0x37c8a1,{'recursive':!![]},_0x318320=>{_0x12ba15['toFile'](_0x26bfd6,(_0x3e414e,_0x411c8f)=>{const _0x38a77e=_0x55db;if(_0x3e414e)return console[_0x38a77e(0x192)](_0x38a77e(0x1d2),_0x3e414e),_0x498d42[_0x38a77e(0x1a1)]({'code':0x1,'message':_0x498d42['__'](_0x38a77e(0x1ab))});else fs[_0x38a77e(0x195)](_0x26bfd6,(_0x2e3cee,_0x2f86a)=>{const _0x29c475=_0x38a77e;let _0x4ce79f=0x0;_0x2f86a&&(_0x4ce79f=_0x2f86a[_0x29c475(0x1c7)]);let _0x479ed3=_0x52d60b['replace']('.','');if(_0x479ed3==_0x29c475(0x1dc))_0x479ed3='jpeg';_0x4ce79f>_0x264c0e&&_0x479ed3==_0x28e4b5&&!_0x4ce79f?fs[_0x29c475(0x1db)](_0x26bfd6,_0x3f4ddf=>{const _0x2e47ed=_0x29c475;return _0x3f4ddf&&console['log']('删除压缩后的文件失败',_0x3f4ddf),_0x498d42[_0x2e47ed(0x1a1)]({'code':0x0,'inputSize':_0x264c0e,'outputFullPath':_0x202a64,'outputSize':_0x264c0e,'outputFormat':_0x52d60b[_0x2e47ed(0x1b9)]('.',''),'uploadStartTime':_0x1beaab[_0x2e47ed(0x18f)][_0x2e47ed(0x196)]});}):fs['unlink'](_0x202a64,_0x2fe020=>{const _0x55eaa2=_0x29c475;return _0x2fe020&&console[_0x55eaa2(0x192)]('删除压缩前的文件失败',_0x2fe020),_0x498d42[_0x55eaa2(0x1a1)]({'code':0x0,'inputSize':_0x264c0e,'outputFullPath':_0x26bfd6,'outputSize':_0x4ce79f,'outputFormat':_0x28e4b5,'uploadStartTime':_0x1beaab[_0x55eaa2(0x18f)]['uploadStartTime']});});});});});});}else return _0x498d42[_0x4f0320(0x1a1)]({'code':0x1,'message':_0x498d42['__']('imageTooLarge')});}function _0x4063(){const _0x569ed8=['base64originalName','zipQuality','9869657NNMEMV','.png','end','body','28358748QJEwKm','size','length','430784aZqJgP','skip','Connection','2036548HENZwn','TYPE_UPLOAD','uploadSubtitle','upload','getFullYear','saveByDate','压缩失败了','filename','decodePath','10FRRlMs','statusCode','nascab_torrentSavePath','.webp','删除已上传的文件失败','overMode','unlink','jpg','../../db/dbFileOperationRecord','3fSlkwO','getSharpInstanceFromInput','getTime','stream','savePath','includes','over','currentUser','now','utimesSync','resize','returnFileError','app','LEVEL_MAIN_OPERATION','1677946vksQUk','query','zipFormat','SAMENAME','log','getMonth','getDate','stat','uploadStartTime','file','addFileOperationRecord','torrentPath','subtitlePath','close','existsSync','ctime','withMeta','jpeg','dirname','json','3967016vFAZSx','emit','single','8673126eBvslT','path','outSize','dbOther','then','output','imageZipFail','isFile','uploadTempFilePrefix','withMetadata','../utils/sharpUtils','multer','清除临时文件','username','toLowerCase','webp','test','imgZip','mkdir','png','replace','saveFullPath','临时文件已删除','set','STATE_SUC','join','originalname'];_0x4063=function(){return _0x569ed8;};return _0x4063();}const multerUpload=multer({'storage':storage})[_0x155524(0x1a4)](_0x155524(0x197));uploadUtil['uploadFile']=function(_0x45a50e,_0x113335,_0x24b473,_0x5c4150,_0x496b8e,_0x3a40cd,_0x5989f7){const _0x3c3f89=_0x155524;let _0xc6eb06=_0x45a50e[_0x3c3f89(0x18f)][_0x3c3f89(0x1e2)]||_0x45a50e[_0x3c3f89(0x1c5)][_0x3c3f89(0x1e2)];if(_0x45a50e[_0x3c3f89(0x18f)][_0x3c3f89(0x1ce)]==0x1){let _0x4a32da=path[_0x3c3f89(0x1be)](config[_0x3c3f89(0x19a)],_0x3c3f89(0x1cf));_0xc6eb06=_0x4a32da;}else _0x496b8e&&(_0x45a50e[_0x3c3f89(0x18f)][_0x3c3f89(0x1c0)]=!![]),_0x24b473&&(_0xc6eb06=fileUtil[_0x3c3f89(0x1d4)](_0xc6eb06));if(_0xc6eb06==_0x3c3f89(0x1d7)){let _0x70dcb2=path['join'](config[_0x3c3f89(0x199)]);_0xc6eb06=_0x70dcb2;}_0x45a50e[_0x3c3f89(0x18f)][_0x3c3f89(0x1e2)]=_0xc6eb06,multerUpload(_0x45a50e,_0x113335,function(_0x52ce0c){const _0xfa8670=_0x3c3f89;if(_0x52ce0c)return _0x52ce0c['message']==_0xfa8670(0x191)?(_0x113335[_0xfa8670(0x1d6)]=0xc8,_0x113335['set'](_0xfa8670(0x1cb),_0xfa8670(0x19b)),_0x113335[_0xfa8670(0x1a1)]({'code':0x1,'remark':_0xfa8670(0x191),'message':_0x113335['__']('sameNameFileAlreadExist')})):(_0x5989f7&&_0x5989f7(_0x52ce0c),fileUtil['returnFileError'](_0x113335,_0x52ce0c));if(!_0x45a50e[_0xfa8670(0x18f)][_0xfa8670(0x1bf)]){_0x5989f7&&_0x5989f7(_0x52ce0c);return;}fs[_0xfa8670(0x195)](_0x45a50e[_0xfa8670(0x18f)][_0xfa8670(0x1ba)],(_0x8043fa,_0x4603f7)=>{const _0x106089=_0xfa8670;if(_0x8043fa){_0x5989f7&&_0x5989f7(_0x8043fa);return;}_0x4603f7[_0x106089(0x1ac)]()&&_0x4e2d7e();});});function _0x4e2d7e(){const _0x3208a5=_0x3c3f89;if(_0x45a50e[_0x3208a5(0x18f)][_0x3208a5(0x1d1)]==0x1)mediaUtils['getFileTime'](_0x45a50e[_0x3208a5(0x18f)][_0x3208a5(0x1ba)])[_0x3208a5(0x1a9)](_0x273cd4=>{const _0x4c504c=_0x3208a5;if(parseInt(_0x273cd4)>Date[_0x4c504c(0x1e6)]()-0x2710)try{_0x45a50e['query'][_0x4c504c(0x19d)]&&/^[0-9]{10}$/[_0x4c504c(0x1b5)](_0x45a50e[_0x4c504c(0x18f)]['ctime'])&&(_0x273cd4=parseInt(_0x45a50e['query'][_0x4c504c(0x19d)])*0x3e8);}catch(_0x9f5a9b){}let _0x47ae79=new Date(_0x273cd4),_0x504afe=_0x47ae79[_0x4c504c(0x1d0)](),_0x1ea579=_0x47ae79[_0x4c504c(0x193)]()+0x1,_0x39d819=_0x47ae79[_0x4c504c(0x194)](),_0x1bdd1e=path['join'](_0x45a50e[_0x4c504c(0x18f)][_0x4c504c(0x1e2)],_0x504afe+'',_0x1ea579+'',_0x39d819+'');!fs[_0x4c504c(0x19c)](_0x1bdd1e)&&fs['mkdirSync'](_0x1bdd1e,{'recursive':!![]});let _0x4993fd=_0x45a50e[_0x4c504c(0x18f)][_0x4c504c(0x1bf)],_0x3219e0=fs[_0x4c504c(0x19c)](path['join'](_0x1bdd1e,_0x4993fd));if(_0x3219e0){let _0x130f34=getOverMode(_0x45a50e);if(_0x130f34==_0x4c504c(0x1ca))return _0x45a50e[_0x4c504c(0x18f)][_0x4c504c(0x1ba)][_0x4c504c(0x1e3)](config[_0x4c504c(0x1ad)])&&fs[_0x4c504c(0x1db)](_0x45a50e[_0x4c504c(0x18f)][_0x4c504c(0x1ba)],_0xe1cc9a=>{const _0x54f506=_0x4c504c;_0xe1cc9a&&console[_0x54f506(0x192)](_0x54f506(0x1d9),_0xe1cc9a),console['log'](_0x54f506(0x1bb));}),_0x113335[_0x4c504c(0x1d6)]=0xc8,_0x113335[_0x4c504c(0x1bc)](_0x4c504c(0x1cb),_0x4c504c(0x19b)),_0x113335['json']({'code':0x1,'remark':_0x4c504c(0x191),'message':_0x113335['__']('sameNameFileAlreadExist')});else _0x130f34=='rename'&&(_0x4993fd=new Date()['getTime']()+_0x4993fd);}let _0x37cd6c=path[_0x4c504c(0x1be)](_0x1bdd1e,_0x4993fd);_0x29c1db(_0x37cd6c);});else{let _0xd69904=path['join'](_0x45a50e[_0x3208a5(0x18f)][_0x3208a5(0x1e2)],_0x45a50e[_0x3208a5(0x18f)][_0x3208a5(0x1bf)]);_0x29c1db(_0xd69904);}function _0x29c1db(_0x14b056){const _0x12e02b=_0x3208a5;console['log']('上传文件移动到最终位置',_0x14b056),fs['rename'](_0x45a50e[_0x12e02b(0x18f)]['saveFullPath'],_0x14b056,_0x3c6742=>{const _0x316b09=_0x12e02b;if(_0x3c6742)return _0x5989f7&&_0x5989f7(_0x3c6742),fileUtil[_0x316b09(0x18b)](_0x113335,_0x3c6742);else{if(_0x45a50e[_0x316b09(0x18f)][_0x316b09(0x1b6)]==0x1)return dealImageCompress(_0x45a50e,_0x113335,_0x14b056);dbFileOperationRecord[_0x316b09(0x198)](_0x45a50e[_0x316b09(0x18c)][_0x316b09(0x1a8)],{'username':_0x45a50e[_0x316b09(0x1e5)][_0x316b09(0x1b2)],'targetPath':_0x14b056,'level':dbFileOperationRecord[_0x316b09(0x18d)],'type':dbFileOperationRecord[_0x316b09(0x1cd)],'state':dbFileOperationRecord[_0x316b09(0x1bd)]}),_0x45a50e[_0x316b09(0x197)][_0x316b09(0x1a6)]=_0x14b056,_0x45a50e['file'][_0x316b09(0x1d3)]=_0x45a50e[_0x316b09(0x18f)][_0x316b09(0x1bf)];let _0x409aab=_0x45a50e[_0x316b09(0x1c5)][_0x316b09(0x19d)]||_0x45a50e['query'][_0x316b09(0x19d)];try{if(_0x409aab){_0x409aab=_0x409aab+'';if(_0x409aab[_0x316b09(0x1c8)]==0xa)fs[_0x316b09(0x1e7)](_0x14b056,_0x409aab,_0x409aab);else{}}}catch(_0x4c24bd){}_0x3a40cd&&_0x3a40cd(_0x45a50e[_0x316b09(0x197)]);if(!_0x5c4150)return _0x113335[_0x316b09(0x1a1)]({'code':0x0,'file':_0x45a50e[_0x316b09(0x197)]});}});}}},module['exports']=uploadUtil;