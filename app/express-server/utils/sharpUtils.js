const _0x2f8478=_0x1e96;(function(_0x58b1f7,_0x18d51b){const _0x140a8=_0x1e96,_0xbd49cc=_0x58b1f7();while(!![]){try{const _0x2e3c50=-parseInt(_0x140a8(0x1dc))/0x1*(parseInt(_0x140a8(0x1ef))/0x2)+parseInt(_0x140a8(0x21d))/0x3*(-parseInt(_0x140a8(0x1ea))/0x4)+-parseInt(_0x140a8(0x1e4))/0x5+parseInt(_0x140a8(0x210))/0x6*(parseInt(_0x140a8(0x22c))/0x7)+-parseInt(_0x140a8(0x1ec))/0x8+-parseInt(_0x140a8(0x235))/0x9+parseInt(_0x140a8(0x1fd))/0xa;if(_0x2e3c50===_0x18d51b)break;else _0xbd49cc['push'](_0xbd49cc['shift']());}catch(_0x59f56d){_0xbd49cc['push'](_0xbd49cc['shift']());}}}(_0x1082,0x63581));let path=require('path'),fs=require('fs'),FFmpeg=require(_0x2f8478(0x1ee))['FFmpeg'],sharpUtil={};const sharp=require(_0x2f8478(0x21e)),libheif=require(_0x2f8478(0x202)),config=require(_0x2f8478(0x21f)),transCodeUtil=require(_0x2f8478(0x237)),sharpBmp=require(_0x2f8478(0x224));let sha256=require(_0x2f8478(0x232));const {Worker}=require(_0x2f8478(0x1e6));let dcraw;function getDcraw(){const _0x484f3b=_0x2f8478;if(!dcraw)try{return dcraw=require('dcraw'),dcraw;}catch(_0xa83238){return console[_0x484f3b(0x229)](_0x484f3b(0x1fb)),null;}else return dcraw;}let PSD;function getPsd(){const _0x1fc243=_0x2f8478;if(!PSD)try{return PSD=require(_0x1fc243(0x1ff)),PSD;}catch(_0x2c0b2a){return console[_0x1fc243(0x229)]('psd导入失败'),null;}else return PSD;}function extractThumbnailFromRaw(_0x28ca55,_0xa726a9){return new Promise((_0x58b3e8,_0x125966)=>{const _0x2c8b47=_0x1e96;if(_0xa726a9&&_0xa726a9[_0x2c8b47(0x200)]()=='.psd'){let _0x1eee55=getPsd();if(!_0x1eee55)return _0x125966(null);try{if(typeof _0x28ca55==_0x2c8b47(0x208)){let _0x485072=path[_0x2c8b47(0x21a)](config[_0x2c8b47(0x1f2)],sha256(_0x28ca55)+_0x2c8b47(0x1eb));fs[_0x2c8b47(0x1e7)](_0x485072,(_0x4657e2,_0x2bc438)=>{const _0x5312e4=_0x2c8b47;try{if(_0x4657e2){let _0x405605=_0x1eee55['fromFile'](_0x28ca55);_0x405605[_0x5312e4(0x222)](),_0x405605['image'][_0x5312e4(0x226)](_0x485072)[_0x5312e4(0x214)](()=>{const _0x1bafbb=_0x5312e4;sharp(_0x485072)['jpeg']({'quality':0x4d})['toBuffer']()['then'](_0x2f4b04=>{fs['writeFile'](_0x485072,_0x2f4b04,_0x3aaf9a=>{if(_0x3aaf9a)return _0x125966(null);_0x58b3e8(_0x485072);});})[_0x1bafbb(0x1de)](_0x1cb16d=>{const _0x2a9920=_0x1bafbb;return console['log'](_0x2a9920(0x1e9),_0x1cb16d),_0x125966(null);});})[_0x5312e4(0x1de)](_0x12bc7a=>{const _0x29e882=_0x5312e4;return console[_0x29e882(0x229)]('psd\x20error\x201',_0x12bc7a),_0x125966(null);});}else return _0x58b3e8(_0x485072);}catch(_0x3496fe){return console[_0x5312e4(0x229)](_0x5312e4(0x216),_0x3496fe),_0x125966(null);}});}else return _0x125966(null);}catch(_0x10e771){return _0x125966(null);}}else{let _0x1feb4a=getDcraw();if(!_0x1feb4a)return _0x125966(null);function _0x262ffe(_0x4a14b9){try{const _0x3c0980=_0x1feb4a(_0x4a14b9,{'extractThumbnail':!![],'identify':!![]});return _0x3c0980?_0x58b3e8(_0x3c0980):_0x125966(null);}catch(_0x3c25c1){return _0x125966(null);}}if(typeof _0x28ca55==_0x2c8b47(0x208))fs[_0x2c8b47(0x20c)](_0x28ca55,(_0x3cb7d1,_0x305f27)=>{const _0x1e22fc=_0x2c8b47;if(_0x3cb7d1)return console[_0x1e22fc(0x229)](_0x1e22fc(0x1ed),_0x28ca55),_0x125966(_0x3cb7d1);_0x262ffe(_0x305f27);});else{if(Buffer[_0x2c8b47(0x1e3)](_0x28ca55))_0x262ffe(_0x28ca55);else return _0x125966(null);}}});}function _0x1082(){const _0xf89588=['join','heicExt','startsWith','129ZWMAMA','sharp','../../myConfig/config','Worker\x20stopped\x20with\x20exit\x20code:','../../utils/exifUtils','parse','exit','sharp-bmp','Content-Disposition','saveAsPng','end','已超时\x20结束处理worker','log','../../myWorkers/transHeicWorker.js','file','14fXVscj','transSpcielFormatFromBuffer','height','code','ifExtIsSpecialFormat','.heif','sha256','toUpperCase','sharpDealImg','2818053IsXnYl','basename','../../utils/transCodeUtil','width','attachment;\x20filename*=UTF-8\x27\x27','withMetadata','dealFFmpegPath','10%','raw','128wXQBjj','extname','catch','getRotateFromTags','runTransHeicWorker','returnDealedFile','webp','isBuffer','2255600mCPdVj','type','worker_threads','stat','toFile','sharp\x20deal\x20psd\x20png\x20error\x201','55844hnirMg','_psd.png','4456368NLNHIS','读取失败','../../libs/nasTrans','5098hNJrJb','sharp\x20err1:','screenshots','cachePath','.hif','includes','sendFile','getSharpInstanceFromInput','buffer','处理完成,删除临时文件','.tiff','from','dcraw导入失败','.bmp','25052530jioWXE','genTinyFile','psd','toLowerCase','ifImageIsSpecialFormat','libheif-js/wasm-bundle','jpeg','data','error','replace','tempFilePath','string','message','returnDealedImage','.heic','readFile','raw\x20err1','deleteRawTempFile','resolve','448614tIUvuB','rotate','status','decode','then','transSpcielFormat','psd\x20error\x202','terminate','image','output'];_0x1082=function(){return _0xf89588;};return _0x1082();}const exifUtils=require(_0x2f8478(0x221));function _0x1e96(_0x2f1e97,_0xf00fe7){const _0x108293=_0x1082();return _0x1e96=function(_0x1e963a,_0x41982a){_0x1e963a=_0x1e963a-0x1da;let _0x4b97e0=_0x108293[_0x1e963a];return _0x4b97e0;},_0x1e96(_0x2f1e97,_0xf00fe7);}sharpUtil[_0x2f8478(0x1f6)]=function(_0x247dd1){const _0x442d6c=_0x2f8478;_0x247dd1[_0x442d6c(0x1e5)]=='Buffer'&&(_0x247dd1=Buffer[_0x442d6c(0x1fa)](_0x247dd1));let _0x505108={'failOnError':![]};return _0x247dd1[_0x442d6c(0x238)]&&_0x247dd1[_0x442d6c(0x22e)]&&_0x247dd1[_0x442d6c(0x204)]&&(_0x505108[_0x442d6c(0x1db)]={'width':_0x247dd1[_0x442d6c(0x238)],'height':_0x247dd1[_0x442d6c(0x22e)],'channels':0x4},_0x247dd1=_0x247dd1[_0x442d6c(0x204)]),sharp(_0x247dd1,_0x505108);},sharpUtil[_0x2f8478(0x20e)]=function(_0x44f48a){const _0x2e31e5=_0x2f8478;typeof _0x44f48a==_0x2e31e5(0x208)&&_0x44f48a[_0x2e31e5(0x21c)](config[_0x2e31e5(0x207)])&&fs['rm'](_0x44f48a,_0x5971eb=>{});},sharpUtil[_0x2f8478(0x234)]=function(_0x5191a8,_0x222ad5,_0x2ddc0f,_0x194f52,_0x21bfa5,_0x66e933,_0x3a21a5,_0x5ec74f,_0x19c234,_0x29d919,_0x2b2bdc){const _0x15b469=_0x2f8478;if(!_0x5191a8)return _0x3a21a5(null);let _0x281d44=sharpUtil[_0x15b469(0x1f6)](_0x5191a8);_0x222ad5==_0x15b469(0x203)?_0x2b2bdc?_0x281d44=_0x281d44['jpeg'](_0x2b2bdc):_0x281d44=_0x281d44[_0x15b469(0x203)]():_0x281d44=_0x281d44[_0x15b469(0x1e2)]({});_0x2ddc0f&&(_0x281d44=_0x281d44[_0x15b469(0x23a)]());let _0x143e6a=exifUtils[_0x15b469(0x1df)](_0x29d919);_0x143e6a?_0x281d44=_0x281d44[_0x15b469(0x211)](_0x143e6a):_0x281d44=_0x281d44[_0x15b469(0x211)]();_0x194f52&&(_0x281d44=_0x281d44['resize'](_0x194f52));if(_0x21bfa5==_0x15b469(0x22b))_0x281d44[_0x15b469(0x1e8)](_0x66e933,(_0x3e7feb,_0x3feddc)=>{const _0xb1f1f6=_0x15b469;_0x19c234&&(console['log'](_0xb1f1f6(0x1f8),_0x5191a8),sharpUtil[_0xb1f1f6(0x20e)](_0x5191a8)),_0x3e7feb?(console[_0xb1f1f6(0x229)](_0xb1f1f6(0x1f0),_0x5191a8,_0x3e7feb),_0x5ec74f()):_0x3a21a5(_0x66e933);});else _0x21bfa5==_0x15b469(0x1f7)&&_0x281d44['toBuffer']((_0x2ae82d,_0x20122f,_0x3fc63e)=>{const _0x2b4117=_0x15b469;_0x19c234&&sharpUtil[_0x2b4117(0x20e)](_0x5191a8),_0x2ae82d?(console[_0x2b4117(0x229)]('sharp\x20err2:',_0x2ae82d),_0x5ec74f()):_0x3a21a5(_0x20122f);});};function sharpImg(_0x494190,_0x22d141,_0x1d8517,_0x47ce41,_0x5cd804){const _0x389b0a=_0x2f8478;sharpUtil[_0x389b0a(0x215)](_0x494190,(_0x5ec179,_0x25fd5f,_0x546402)=>{const _0x30fbe8=_0x389b0a;!_0x22d141['width']&&!_0x22d141[_0x30fbe8(0x22e)]&&(_0x22d141={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil['sharpDealImg'](_0x5ec179,null,![],_0x22d141,_0x30fbe8(0x22b),_0x1d8517,_0x47ce41,_0x5cd804,_0x25fd5f,_0x546402);});}sharpUtil[_0x2f8478(0x1fe)]=function(_0x2da69b,_0x4bb3e1,_0x18b2da,_0x361f9f,_0x3f4b0a,_0x5c3578,_0x4ac4e5,_0x491db2){const _0x220766=_0x2f8478;_0x491db2&&(_0x491db2=parseInt(_0x491db2));let _0x582673=path[_0x220766(0x21a)](_0x4bb3e1,_0x18b2da);if(_0x361f9f==_0x220766(0x218)){let _0x357c71={};_0x3f4b0a&&_0x3f4b0a['width']&&_0x3f4b0a['height']?_0x3f4b0a['width']>_0x3f4b0a[_0x220766(0x22e)]?_0x357c71[_0x220766(0x238)]=_0x491db2?_0x491db2:0x258:_0x357c71[_0x220766(0x22e)]=_0x491db2?_0x491db2:0x258:(_0x357c71[_0x220766(0x238)]=_0x491db2,_0x357c71[_0x220766(0x22e)]=_0x491db2),sharpImg(_0x2da69b,_0x357c71,_0x582673,_0x5c3578,_0x4ac4e5);}else{if(_0x361f9f=='video'){let _0xfff514=FFmpeg(transCodeUtil[_0x220766(0x23b)](_0x2da69b),{'timeout':0x3c});_0xfff514['on'](_0x220766(0x227),()=>{const _0x5288e1=_0x220766;_0xfff514['kill'](),_0x5c3578(path[_0x5288e1(0x21a)](_0x4bb3e1,_0x18b2da));}),_0xfff514['on'](_0x220766(0x205),function(_0x1be419,_0xfbc209,_0x1ded4f){_0xfff514['kill'](),_0x4ac4e5&&_0x4ac4e5();}),_0xfff514[_0x220766(0x1f1)]({'timestamps':[_0x220766(0x1da)],'filename':_0x18b2da,'folder':_0x4bb3e1,'size':'600x?'});}}},sharpUtil[_0x2f8478(0x1e0)]=function(_0x1fa128){return new Promise((_0x244988,_0x2bb49a)=>{const _0x49f01d=_0x1e96;let _0x1e4f21=new Worker(path[_0x49f01d(0x20f)](__dirname,_0x49f01d(0x22a)),{'workerData':{'inputBuffer':_0x1fa128}}),_0x4876bf=setTimeout(()=>{const _0x438305=_0x49f01d;_0x1e4f21&&(console['log'](_0x438305(0x228)),_0x1e4f21[_0x438305(0x217)](),_0x1e4f21=null,_0x2bb49a());},0x3a98);_0x1e4f21['on'](_0x49f01d(0x209),_0x275fd1=>{const _0x41d00f=_0x49f01d;_0x275fd1[_0x41d00f(0x22f)]==0x0&&(_0x4876bf&&clearTimeout(_0x4876bf),_0x244988(_0x275fd1[_0x41d00f(0x219)]));}),_0x1e4f21['on'](_0x49f01d(0x205),_0x1cd74d=>{const _0x13254e=_0x49f01d;console[_0x13254e(0x205)]('Worker\x20error:',_0x1cd74d),_0x1e4f21&&(_0x1e4f21[_0x13254e(0x217)](),_0x1e4f21=null),_0x2bb49a();}),_0x1e4f21['on'](_0x49f01d(0x223),_0x24b5a1=>{const _0x47098d=_0x49f01d;if(_0x24b5a1!==0x0)console[_0x47098d(0x205)](_0x47098d(0x220),_0x24b5a1);else{}});});},sharpUtil[_0x2f8478(0x22d)]=function(_0x292d37,_0x302edd,_0x4cc5d2){const _0x3d90eb=_0x2f8478;if(_0x292d37)_0x292d37=_0x292d37[_0x3d90eb(0x200)]();if(_0x292d37&&(_0x292d37==_0x3d90eb(0x20b)||_0x292d37==_0x3d90eb(0x231)||_0x292d37==_0x3d90eb(0x1f3)))sharpUtil[_0x3d90eb(0x1e0)](_0x302edd)[_0x3d90eb(0x214)](_0x15f071=>{_0x15f071?_0x4cc5d2(_0x15f071):_0x4cc5d2(_0x302edd);})[_0x3d90eb(0x1de)](()=>{_0x4cc5d2(_0x302edd);});else{if(_0x292d37&&_0x292d37==_0x3d90eb(0x1fc))try{const _0x3b54b2=sharpBmp[_0x3d90eb(0x213)](_0x302edd);_0x4cc5d2(_0x3b54b2);}catch(_0x31553e){_0x4cc5d2(_0x302edd);}else _0x292d37&&config['rawImgTypeList'][_0x3d90eb(0x1f4)](_0x292d37[_0x3d90eb(0x200)]())?extractThumbnailFromRaw(_0x302edd,_0x292d37)['then'](_0x3c66e1=>{_0x4cc5d2(_0x3c66e1);})['catch'](_0x51fd43=>{const _0x1b68ce=_0x3d90eb;console[_0x1b68ce(0x229)](_0x1b68ce(0x20d),_0x51fd43),_0x4cc5d2(_0x302edd);}):_0x4cc5d2(_0x302edd);}},sharpUtil[_0x2f8478(0x215)]=function(_0x4f490b,_0x819008){const _0x3b1db8=_0x2f8478;let _0x17ee89=path[_0x3b1db8(0x1dd)](_0x4f490b);if(_0x17ee89)_0x17ee89=_0x17ee89[_0x3b1db8(0x200)]();if(_0x17ee89&&(_0x17ee89==_0x3b1db8(0x20b)||_0x17ee89==_0x3b1db8(0x231)||_0x17ee89==_0x3b1db8(0x1f3)))fs[_0x3b1db8(0x20c)](_0x4f490b,(_0xd47b53,_0x13ce10)=>{const _0x4947e4=_0x3b1db8;if(_0xd47b53)return _0x819008(_0x4f490b);sharpUtil[_0x4947e4(0x1e0)](_0x13ce10)[_0x4947e4(0x214)](_0x9a7225=>{_0x9a7225?_0x819008(_0x9a7225):_0x819008(_0x13ce10);})['catch'](()=>{_0x819008(_0x13ce10);});});else{if(_0x17ee89&&_0x17ee89==_0x3b1db8(0x1fc))console['log']('正在处理bmp',_0x4f490b),fs[_0x3b1db8(0x20c)](_0x4f490b,(_0x53a9cc,_0x5469ee)=>{const _0x2309a5=_0x3b1db8;if(_0x53a9cc)console['log'](_0x53a9cc),_0x819008(_0x4f490b);else try{const _0x5f289c=sharpBmp[_0x2309a5(0x213)](_0x5469ee);_0x819008(_0x5f289c);}catch(_0x1ae5ba){_0x819008(_0x4f490b);}});else{if(_0x17ee89&&config['rawImgTypeList'][_0x3b1db8(0x1f4)](_0x17ee89[_0x3b1db8(0x200)]()))try{extractThumbnailFromRaw(_0x4f490b,_0x17ee89)[_0x3b1db8(0x214)](_0x9b0a3e=>{_0x819008(_0x9b0a3e);})['catch'](_0x5d3573=>{const _0x4f06e7=_0x3b1db8;console[_0x4f06e7(0x229)](_0x5d3573),_0x819008(_0x4f490b);});}catch(_0x8444a2){console['log'](_0x8444a2),_0x819008(_0x4f490b);}else _0x819008(_0x4f490b);}}},sharpUtil[_0x2f8478(0x20a)]=function(_0x5df85d,_0x36b382,_0x46b090,_0x4b2534){const _0x5dd11b=_0x2f8478;sharpUtil[_0x5dd11b(0x215)](_0x36b382,(_0x5215cc,_0x3983e3,_0x5342e6)=>{const _0xad99a9=_0x5dd11b;sharpUtil[_0xad99a9(0x234)](_0x5215cc,_0xad99a9(0x203),!![],_0x46b090,_0xad99a9(0x1f7),null,_0x2c860f=>{const _0x403eb4=_0xad99a9;_0x5df85d['send'](Buffer[_0x403eb4(0x1fa)](_0x2c860f));},()=>{const _0x3323b7=_0xad99a9;_0x5df85d[_0x3323b7(0x212)](0x194)[_0x3323b7(0x227)]();},_0x3983e3,_0x5342e6,_0x4b2534);});},sharpUtil[_0x2f8478(0x230)]=function(_0x2da908){const _0x26e487=_0x2f8478;return config[_0x26e487(0x21b)]['includes'](_0x2da908)||config['rawImgTypeList'][_0x26e487(0x1f4)](_0x2da908['toLowerCase']())||_0x2da908==_0x26e487(0x1fc)||_0x2da908==_0x26e487(0x1f9)?!![]:![];},sharpUtil[_0x2f8478(0x201)]=function(_0x4d4697){const _0x5867a0=_0x2f8478;let _0x3a8646=path[_0x5867a0(0x1dd)](_0x4d4697)?path['extname'](_0x4d4697)[_0x5867a0(0x200)]():null;if(!_0x3a8646)return![];return sharpUtil['ifExtIsSpecialFormat'](_0x3a8646);},sharpUtil[_0x2f8478(0x1e1)]=function(_0x127977,_0x22cc31,_0x25274c,_0x41516e,_0x35ccb3){const _0x4ea1cb=_0x2f8478;if(sharpUtil[_0x4ea1cb(0x201)](_0x22cc31)||_0x41516e||_0x35ccb3){let _0x3b3d2b=null,_0x55bdf4=null;return _0x41516e&&_0x41516e>=0x64&&_0x41516e<=0x186a0&&(_0x3b3d2b={'fit':'inside','width':parseInt(_0x41516e),'height':parseInt(_0x41516e),'withoutEnlargement':!![]}),_0x35ccb3&&_0x35ccb3>=0x1e&&_0x35ccb3<=0x64&&(_0x55bdf4={'quality':parseInt(_0x35ccb3)}),sharpUtil[_0x4ea1cb(0x20a)](_0x127977,_0x22cc31,_0x3b3d2b,_0x55bdf4);}else{if(_0x25274c){const _0x5a7127=encodeURIComponent(path[_0x4ea1cb(0x236)](_0x22cc31))[_0x4ea1cb(0x206)](/%([0-9A-F]{2})/g,(_0x41ce8f,_0x16606a)=>'%'+_0x16606a[_0x4ea1cb(0x233)]());_0x127977['setHeader'](_0x4ea1cb(0x225),_0x4ea1cb(0x239)+_0x5a7127);}_0x127977[_0x4ea1cb(0x1f5)](_0x22cc31);}},module['exports']=sharpUtil;