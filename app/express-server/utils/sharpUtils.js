const _0x18670e=_0xd7ac;(function(_0x5053d3,_0x16fa70){const _0x5ba976=_0xd7ac,_0x1b9142=_0x5053d3();while(!![]){try{const _0x4a0b96=parseInt(_0x5ba976(0x12c))/0x1*(-parseInt(_0x5ba976(0xe2))/0x2)+parseInt(_0x5ba976(0x13c))/0x3*(-parseInt(_0x5ba976(0xe7))/0x4)+parseInt(_0x5ba976(0x130))/0x5+-parseInt(_0x5ba976(0x10d))/0x6+-parseInt(_0x5ba976(0xfd))/0x7*(parseInt(_0x5ba976(0x135))/0x8)+-parseInt(_0x5ba976(0x133))/0x9*(parseInt(_0x5ba976(0x116))/0xa)+parseInt(_0x5ba976(0x127))/0xb*(parseInt(_0x5ba976(0x11d))/0xc);if(_0x4a0b96===_0x16fa70)break;else _0x1b9142['push'](_0x1b9142['shift']());}catch(_0x358f2f){_0x1b9142['push'](_0x1b9142['shift']());}}}(_0xd8a7,0xe31f0));let path=require(_0x18670e(0x11b)),fs=require('fs'),FFmpeg=require('../../libs/nasTrans')[_0x18670e(0xf8)],sharpUtil={};function _0xd8a7(){const _0x48eca1=['inside','file','screenshots','width','124KEBXKb','rawImgTypeList','stat','exit','Buffer','getRotateFromTags','transSpcielFormat','../../utils/transCodeUtil','parse','../../myConfig/config','.psd','raw','toFile','.heif','cachePath','height','isBuffer','FFmpeg','terminate','读取失败','heicExt','genTinyFile','14xwgVsc','data','ifImageIsSpecialFormat','kill','10%','dcraw导入失败','join','then','psd\x20error\x201','resize','toUpperCase','getSharpInstanceFromInput','.bmp','output','tempFilePath','sendFile','9898956pyegXX','../../utils/exifUtils','psd导入失败','.hif','runTransHeicWorker','正在处理bmp','extname','jpeg','setHeader','320RjpBEW','fromFile','error','string','../../myWorkers/transHeicWorker.js','path','writeFile','21141684VnEssA','replace','returnDealedImage','startsWith','sharpDealImg','toBuffer','catch','600x?','toLowerCase','attachment;\x20filename*=UTF-8\x27\x27','55ZEfVXB','video','Content-Disposition','exports','webp','275UuTHIZ','已超时\x20结束处理worker','readFile','end','129965Wmtezj','from','log','361431NZrtuY','ifExtIsSpecialFormat','7342752pNZFfa','decode','dcraw','buffer','basename','includes','sharp-bmp','133194aTrzUt','worker_threads','rotate','.tiff','处理完成,删除临时文件','psd\x20error\x202','deleteRawTempFile','transSpcielFormatFromBuffer','.heic','message','sharp\x20err2:','12784DBDWLL'];_0xd8a7=function(){return _0x48eca1;};return _0xd8a7();}const sharp=require('sharp'),libheif=require('libheif-js/wasm-bundle'),config=require(_0x18670e(0xf0)),transCodeUtil=require(_0x18670e(0xee)),sharpBmp=require(_0x18670e(0x13b));let sha256=require('sha256');const {Worker}=require(_0x18670e(0x13d));let dcraw;function getDcraw(){const _0x560f08=_0x18670e;if(!dcraw)try{return dcraw=require(_0x560f08(0x137)),dcraw;}catch(_0x19cfde){return console[_0x560f08(0x132)](_0x560f08(0x102)),null;}else return dcraw;}let PSD;function getPsd(){const _0x184e91=_0x18670e;if(!PSD)try{return PSD=require('psd'),PSD;}catch(_0x5d48d6){return console[_0x184e91(0x132)](_0x184e91(0x10f)),null;}else return PSD;}function extractThumbnailFromRaw(_0x2c6cdd,_0x51b2e1){return new Promise((_0x21139f,_0x41afd1)=>{const _0x7190a2=_0xd7ac;if(_0x51b2e1&&_0x51b2e1['toLowerCase']()==_0x7190a2(0xf1)){let _0x547515=getPsd();if(!_0x547515)return _0x41afd1(null);try{if(typeof _0x2c6cdd==_0x7190a2(0x119)){let _0x17cc71=path[_0x7190a2(0x103)](config[_0x7190a2(0xf5)],sha256(_0x2c6cdd)+'_psd.png');fs[_0x7190a2(0xe9)](_0x17cc71,(_0x141720,_0x5101c4)=>{const _0x47ee6c=_0x7190a2;try{if(_0x141720){let _0x27e6bf=_0x547515[_0x47ee6c(0x117)](_0x2c6cdd);_0x27e6bf[_0x47ee6c(0xef)](),_0x27e6bf['image']['saveAsPng'](_0x17cc71)[_0x47ee6c(0x104)](()=>{const _0x459086=_0x47ee6c;sharp(_0x17cc71)[_0x459086(0x114)]({'quality':0x4d})[_0x459086(0x122)]()[_0x459086(0x104)](_0x1780b7=>{const _0x3f2c13=_0x459086;fs[_0x3f2c13(0x11c)](_0x17cc71,_0x1780b7,_0x5ea45e=>{if(_0x5ea45e)return _0x41afd1(null);_0x21139f(_0x17cc71);});})[_0x459086(0x123)](_0x1ba6bc=>{const _0x433984=_0x459086;return console[_0x433984(0x132)]('sharp\x20deal\x20psd\x20png\x20error\x201',_0x1ba6bc),_0x41afd1(null);});})[_0x47ee6c(0x123)](_0x1a3514=>{const _0x173fc3=_0x47ee6c;return console[_0x173fc3(0x132)](_0x173fc3(0x105),_0x1a3514),_0x41afd1(null);});}else return _0x21139f(_0x17cc71);}catch(_0x429f6e){return console[_0x47ee6c(0x132)](_0x47ee6c(0x141),_0x429f6e),_0x41afd1(null);}});}else return _0x41afd1(null);}catch(_0x3f4cce){return _0x41afd1(null);}}else{let _0x4d1a87=getDcraw();if(!_0x4d1a87)return _0x41afd1(null);function _0x20420e(_0x325cc6){try{const _0x5f30c1=_0x4d1a87(_0x325cc6,{'extractThumbnail':!![],'identify':!![]});return _0x5f30c1?_0x21139f(_0x5f30c1):_0x41afd1(null);}catch(_0x5322ec){return _0x41afd1(null);}}if(typeof _0x2c6cdd=='string')fs['readFile'](_0x2c6cdd,(_0x5bb295,_0x52885c)=>{const _0x24a275=_0x7190a2;if(_0x5bb295)return console['log'](_0x24a275(0xfa),_0x2c6cdd),_0x41afd1(_0x5bb295);_0x20420e(_0x52885c);});else{if(Buffer[_0x7190a2(0xf7)](_0x2c6cdd))_0x20420e(_0x2c6cdd);else return _0x41afd1(null);}}});}const exifUtils=require(_0x18670e(0x10e));sharpUtil[_0x18670e(0x108)]=function(_0x2ed745){const _0x2a1c4a=_0x18670e;_0x2ed745['type']==_0x2a1c4a(0xeb)&&(_0x2ed745=Buffer['from'](_0x2ed745));let _0x44ed04={'failOnError':![]};return _0x2ed745[_0x2a1c4a(0xe6)]&&_0x2ed745[_0x2a1c4a(0xf6)]&&_0x2ed745[_0x2a1c4a(0xfe)]&&(_0x44ed04[_0x2a1c4a(0xf2)]={'width':_0x2ed745[_0x2a1c4a(0xe6)],'height':_0x2ed745['height'],'channels':0x4},_0x2ed745=_0x2ed745['data']),sharp(_0x2ed745,_0x44ed04);},sharpUtil[_0x18670e(0x142)]=function(_0x357c4d){const _0x28e987=_0x18670e;typeof _0x357c4d==_0x28e987(0x119)&&_0x357c4d[_0x28e987(0x120)](config[_0x28e987(0x10b)])&&fs['rm'](_0x357c4d,_0x4abe2f=>{});},sharpUtil[_0x18670e(0x121)]=function(_0x4b5028,_0x4da557,_0x241f7b,_0x1a97c3,_0x3e9412,_0x483a03,_0x86c4c,_0x22b49c,_0x446439,_0x1c6290,_0xdbe681){const _0x21b6fa=_0x18670e;if(!_0x4b5028)return _0x86c4c(null);let _0x22b248=sharpUtil[_0x21b6fa(0x108)](_0x4b5028);_0x4da557==_0x21b6fa(0x114)?_0xdbe681?_0x22b248=_0x22b248[_0x21b6fa(0x114)](_0xdbe681):_0x22b248=_0x22b248['jpeg']():_0x22b248=_0x22b248[_0x21b6fa(0x12b)]({});_0x241f7b&&(_0x22b248=_0x22b248['withMetadata']());let _0x1e7eb6=exifUtils[_0x21b6fa(0xec)](_0x1c6290);_0x1e7eb6?_0x22b248=_0x22b248['rotate'](_0x1e7eb6):_0x22b248=_0x22b248[_0x21b6fa(0x13e)]();_0x1a97c3&&(_0x22b248=_0x22b248[_0x21b6fa(0x106)](_0x1a97c3));if(_0x3e9412=='file')_0x22b248[_0x21b6fa(0xf3)](_0x483a03,(_0x2bf839,_0x52a1f4)=>{const _0x2ebcd2=_0x21b6fa;_0x446439&&(console[_0x2ebcd2(0x132)](_0x2ebcd2(0x140),_0x4b5028),sharpUtil[_0x2ebcd2(0x142)](_0x4b5028)),_0x2bf839?(console[_0x2ebcd2(0x132)]('sharp\x20err1:',_0x4b5028,_0x2bf839),_0x22b49c()):_0x86c4c(_0x483a03);});else _0x3e9412=='buffer'&&_0x22b248['toBuffer']((_0xd0e600,_0x5bdca8,_0x344109)=>{const _0x30cf2c=_0x21b6fa;_0x446439&&sharpUtil['deleteRawTempFile'](_0x4b5028),_0xd0e600?(console[_0x30cf2c(0x132)](_0x30cf2c(0xe1),_0xd0e600),_0x22b49c()):_0x86c4c(_0x5bdca8);});};function sharpImg(_0x48a8f6,_0x5ed843,_0x445f6b,_0x26cb96,_0x438a37){const _0x53a3af=_0x18670e;sharpUtil[_0x53a3af(0xed)](_0x48a8f6,(_0x4b7cd6,_0xf6ffc9,_0x3bc5be)=>{const _0x167c89=_0x53a3af;!_0x5ed843[_0x167c89(0xe6)]&&!_0x5ed843[_0x167c89(0xf6)]&&(_0x5ed843={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x167c89(0x121)](_0x4b7cd6,null,![],_0x5ed843,_0x167c89(0xe4),_0x445f6b,_0x26cb96,_0x438a37,_0xf6ffc9,_0x3bc5be);});}function _0xd7ac(_0x2fdccf,_0x46d8ab){const _0xd8a707=_0xd8a7();return _0xd7ac=function(_0xd7ac3d,_0x27d3cc){_0xd7ac3d=_0xd7ac3d-0xde;let _0x593b60=_0xd8a707[_0xd7ac3d];return _0x593b60;},_0xd7ac(_0x2fdccf,_0x46d8ab);}sharpUtil[_0x18670e(0xfc)]=function(_0x5039f0,_0x399b0e,_0x1b4ed6,_0x45c8f0,_0x56010a,_0x37663c,_0x14d4b,_0x4c8012){const _0x525e94=_0x18670e;_0x4c8012&&(_0x4c8012=parseInt(_0x4c8012));let _0x54f78f=path['join'](_0x399b0e,_0x1b4ed6);if(_0x45c8f0=='image'){let _0x3f86ac={};_0x56010a&&_0x56010a[_0x525e94(0xe6)]&&_0x56010a[_0x525e94(0xf6)]?_0x56010a[_0x525e94(0xe6)]>_0x56010a['height']?_0x3f86ac[_0x525e94(0xe6)]=_0x4c8012?_0x4c8012:0x258:_0x3f86ac['height']=_0x4c8012?_0x4c8012:0x258:(_0x3f86ac[_0x525e94(0xe6)]=_0x4c8012,_0x3f86ac['height']=_0x4c8012),sharpImg(_0x5039f0,_0x3f86ac,_0x54f78f,_0x37663c,_0x14d4b);}else{if(_0x45c8f0==_0x525e94(0x128)){let _0x5a58e0=FFmpeg(transCodeUtil['dealFFmpegPath'](_0x5039f0),{'timeout':0x3c});_0x5a58e0['on'](_0x525e94(0x12f),()=>{const _0x53ed41=_0x525e94;_0x5a58e0[_0x53ed41(0x100)](),_0x37663c(path[_0x53ed41(0x103)](_0x399b0e,_0x1b4ed6));}),_0x5a58e0['on'](_0x525e94(0x118),function(_0x4a7e86,_0x5711f0,_0x415190){const _0x38f612=_0x525e94;_0x5a58e0[_0x38f612(0x100)](),_0x14d4b&&_0x14d4b();}),_0x5a58e0[_0x525e94(0xe5)]({'timestamps':[_0x525e94(0x101)],'filename':_0x1b4ed6,'folder':_0x399b0e,'size':_0x525e94(0x124)});}}},sharpUtil[_0x18670e(0x111)]=function(_0x27efff){return new Promise((_0x9bacae,_0x1769eb)=>{const _0x24d958=_0xd7ac;let _0x1e36f1=new Worker(path['resolve'](__dirname,_0x24d958(0x11a)),{'workerData':{'inputBuffer':_0x27efff}}),_0x20f25c=setTimeout(()=>{const _0x19354d=_0x24d958;_0x1e36f1&&(console[_0x19354d(0x132)](_0x19354d(0x12d)),_0x1e36f1[_0x19354d(0xf9)](),_0x1e36f1=null,_0x1769eb());},0x3a98);_0x1e36f1['on'](_0x24d958(0xe0),_0x33e22d=>{const _0xb57119=_0x24d958;_0x33e22d['code']==0x0&&(_0x20f25c&&clearTimeout(_0x20f25c),_0x9bacae(_0x33e22d[_0xb57119(0x10a)]));}),_0x1e36f1['on'](_0x24d958(0x118),_0x5a5fee=>{const _0x59043c=_0x24d958;console[_0x59043c(0x118)]('Worker\x20error:',_0x5a5fee),_0x1e36f1&&(_0x1e36f1['terminate'](),_0x1e36f1=null),_0x1769eb();}),_0x1e36f1['on'](_0x24d958(0xea),_0xaf8d60=>{const _0x153f3f=_0x24d958;if(_0xaf8d60!==0x0)console[_0x153f3f(0x118)]('Worker\x20stopped\x20with\x20exit\x20code:',_0xaf8d60);else{}});});},sharpUtil[_0x18670e(0xde)]=function(_0x4378a6,_0x5b703d,_0x4dc30f){const _0xdaea00=_0x18670e;if(_0x4378a6)_0x4378a6=_0x4378a6[_0xdaea00(0x125)]();if(_0x4378a6&&(_0x4378a6==_0xdaea00(0xdf)||_0x4378a6==_0xdaea00(0xf4)||_0x4378a6==_0xdaea00(0x110)))sharpUtil[_0xdaea00(0x111)](_0x5b703d)['then'](_0x17fa3b=>{_0x17fa3b?_0x4dc30f(_0x17fa3b):_0x4dc30f(_0x5b703d);})[_0xdaea00(0x123)](()=>{_0x4dc30f(_0x5b703d);});else{if(_0x4378a6&&_0x4378a6=='.bmp')try{const _0x22839d=sharpBmp[_0xdaea00(0x136)](_0x5b703d);_0x4dc30f(_0x22839d);}catch(_0x142416){_0x4dc30f(_0x5b703d);}else _0x4378a6&&config[_0xdaea00(0xe8)]['includes'](_0x4378a6[_0xdaea00(0x125)]())?extractThumbnailFromRaw(_0x5b703d,_0x4378a6)['then'](_0x4334de=>{_0x4dc30f(_0x4334de);})[_0xdaea00(0x123)](_0x25f135=>{const _0x277a53=_0xdaea00;console[_0x277a53(0x132)]('raw\x20err1',_0x25f135),_0x4dc30f(_0x5b703d);}):_0x4dc30f(_0x5b703d);}},sharpUtil[_0x18670e(0xed)]=function(_0x5d61d8,_0x4a79c4){const _0x3feae0=_0x18670e;let _0x40aa02=path[_0x3feae0(0x113)](_0x5d61d8);if(_0x40aa02)_0x40aa02=_0x40aa02[_0x3feae0(0x125)]();if(_0x40aa02&&(_0x40aa02=='.heic'||_0x40aa02=='.heif'||_0x40aa02==_0x3feae0(0x110)))fs[_0x3feae0(0x12e)](_0x5d61d8,(_0x2ccd9a,_0x17f8f7)=>{const _0x5728a7=_0x3feae0;if(_0x2ccd9a)return _0x4a79c4(_0x5d61d8);sharpUtil[_0x5728a7(0x111)](_0x17f8f7)['then'](_0x23cf8c=>{_0x23cf8c?_0x4a79c4(_0x23cf8c):_0x4a79c4(_0x17f8f7);})[_0x5728a7(0x123)](()=>{_0x4a79c4(_0x17f8f7);});});else{if(_0x40aa02&&_0x40aa02==_0x3feae0(0x109))console['log'](_0x3feae0(0x112),_0x5d61d8),fs[_0x3feae0(0x12e)](_0x5d61d8,(_0x4ce20a,_0x4d3974)=>{const _0xff10f8=_0x3feae0;if(_0x4ce20a)console[_0xff10f8(0x132)](_0x4ce20a),_0x4a79c4(_0x5d61d8);else try{const _0x1351d1=sharpBmp[_0xff10f8(0x136)](_0x4d3974);_0x4a79c4(_0x1351d1);}catch(_0x5b438f){_0x4a79c4(_0x5d61d8);}});else{if(_0x40aa02&&config[_0x3feae0(0xe8)][_0x3feae0(0x13a)](_0x40aa02[_0x3feae0(0x125)]()))try{extractThumbnailFromRaw(_0x5d61d8,_0x40aa02)[_0x3feae0(0x104)](_0x3e6212=>{_0x4a79c4(_0x3e6212);})[_0x3feae0(0x123)](_0x3f3047=>{const _0x31a6b8=_0x3feae0;console[_0x31a6b8(0x132)](_0x3f3047),_0x4a79c4(_0x5d61d8);});}catch(_0x4ca293){console[_0x3feae0(0x132)](_0x4ca293),_0x4a79c4(_0x5d61d8);}else _0x4a79c4(_0x5d61d8);}}},sharpUtil[_0x18670e(0x11f)]=function(_0xfe5323,_0x168beb,_0x5c2bba,_0x59e7bf){const _0x2ab882=_0x18670e;sharpUtil[_0x2ab882(0xed)](_0x168beb,(_0x46a264,_0x2abfec,_0x3baf14)=>{const _0x270264=_0x2ab882;sharpUtil[_0x270264(0x121)](_0x46a264,'jpeg',!![],_0x5c2bba,_0x270264(0x138),null,_0x1a4d4a=>{const _0x5e05c1=_0x270264;_0xfe5323['send'](Buffer[_0x5e05c1(0x131)](_0x1a4d4a));},()=>{const _0x36b52a=_0x270264;_0xfe5323['status'](0x194)[_0x36b52a(0x12f)]();},_0x2abfec,_0x3baf14,_0x59e7bf);});},sharpUtil['ifExtIsSpecialFormat']=function(_0x2f7ef4){const _0x5cd9bb=_0x18670e;return config[_0x5cd9bb(0xfb)]['includes'](_0x2f7ef4)||config[_0x5cd9bb(0xe8)][_0x5cd9bb(0x13a)](_0x2f7ef4[_0x5cd9bb(0x125)]())||_0x2f7ef4==_0x5cd9bb(0x109)||_0x2f7ef4==_0x5cd9bb(0x13f)?!![]:![];},sharpUtil[_0x18670e(0xff)]=function(_0x33df5e){const _0x58efd3=_0x18670e;let _0xc09dd5=path[_0x58efd3(0x113)](_0x33df5e)?path[_0x58efd3(0x113)](_0x33df5e)[_0x58efd3(0x125)]():null;if(!_0xc09dd5)return![];return sharpUtil[_0x58efd3(0x134)](_0xc09dd5);},sharpUtil['returnDealedFile']=function(_0x4152b1,_0x33d7d4,_0x23f795,_0x10d530,_0x45acb1){const _0x2648aa=_0x18670e;if(sharpUtil['ifImageIsSpecialFormat'](_0x33d7d4)||_0x10d530||_0x45acb1){let _0x17f407=null,_0x7a1ee3=null;return _0x10d530&&_0x10d530>=0x64&&_0x10d530<=0x186a0&&(_0x17f407={'fit':_0x2648aa(0xe3),'width':parseInt(_0x10d530),'height':parseInt(_0x10d530),'withoutEnlargement':!![]}),_0x45acb1&&_0x45acb1>=0x1e&&_0x45acb1<=0x64&&(_0x7a1ee3={'quality':parseInt(_0x45acb1)}),sharpUtil[_0x2648aa(0x11f)](_0x4152b1,_0x33d7d4,_0x17f407,_0x7a1ee3);}else{if(_0x23f795){const _0x51b6b0=encodeURIComponent(path[_0x2648aa(0x139)](_0x33d7d4))[_0x2648aa(0x11e)](/%([0-9A-F]{2})/g,(_0x5a504b,_0x4b4c92)=>'%'+_0x4b4c92[_0x2648aa(0x107)]());_0x4152b1[_0x2648aa(0x115)](_0x2648aa(0x129),_0x2648aa(0x126)+_0x51b6b0);}_0x4152b1[_0x2648aa(0x10c)](_0x33d7d4);}},module[_0x18670e(0x12a)]=sharpUtil;