const _0x1696a3=_0x4b47;(function(_0x2712a4,_0x3cd54b){const _0x2d9ca6=_0x4b47,_0x1d7461=_0x2712a4();while(!![]){try{const _0x37de59=parseInt(_0x2d9ca6(0x120))/0x1+parseInt(_0x2d9ca6(0x176))/0x2*(-parseInt(_0x2d9ca6(0x132))/0x3)+-parseInt(_0x2d9ca6(0x164))/0x4+-parseInt(_0x2d9ca6(0x160))/0x5+parseInt(_0x2d9ca6(0x11c))/0x6*(parseInt(_0x2d9ca6(0x173))/0x7)+-parseInt(_0x2d9ca6(0x16e))/0x8+parseInt(_0x2d9ca6(0x14c))/0x9;if(_0x37de59===_0x3cd54b)break;else _0x1d7461['push'](_0x1d7461['shift']());}catch(_0x1538f1){_0x1d7461['push'](_0x1d7461['shift']());}}}(_0x2be1,0xda856));let path=require(_0x1696a3(0x119)),fs=require('fs'),FFmpeg=require(_0x1696a3(0x13e))['FFmpeg'],sharpUtil={};function _0x4b47(_0x86391a,_0x29bc8a){const _0x2be17b=_0x2be1();return _0x4b47=function(_0x4b47a7,_0x5d2d6c){_0x4b47a7=_0x4b47a7-0x119;let _0x570785=_0x2be17b[_0x4b47a7];return _0x570785;},_0x4b47(_0x86391a,_0x29bc8a);}function _0x2be1(){const _0x30398e=['join','saveAsPng','sharp','libheif-js/wasm-bundle','writeFile','getSharpInstanceFromInput','decode','3503610ERdlZo','heicExt','includes','transSpcielFormat','3833592YTvpQe','file','sharp\x20err1:','sharp\x20err2:','ifImageIsSpecialFormat','message','_psd.png','sharpDealImg','buffer','../../myConfig/config','14071208gDAMpv','Worker\x20error:','exit','getRotateFromTags','runTransHeicWorker','42hVYqYp','../../utils/transCodeUtil','deleteRawTempFile','2JknhOg','screenshots','parse','output','path','catch','exports','632334BXcfKh','.hif','code','attachment;\x20filename*=UTF-8\x27\x27','1684647lxeWEa','image','readFile','psd\x20error\x202','returnDealedFile','ifExtIsSpecialFormat','处理完成,删除临时文件','fromFile','Worker\x20stopped\x20with\x20exit\x20code:','rotate','Buffer','600x?','width','sendFile','withMetadata','startsWith','jpeg','isBuffer','3891939DHhbRE','.tiff','toLowerCase','from','then','setHeader','Content-Disposition','psd\x20error\x201','transSpcielFormatFromBuffer','send','status','webp','../../libs/nasTrans','已超时\x20结束处理worker','.psd','kill','height','cachePath','.bmp','rawImgTypeList','stat','toFile','end','../../myWorkers/transHeicWorker.js','../../utils/exifUtils','data','29640735JBPZFI','dcraw','sharp-bmp','error','log','inside','returnDealedImage','toBuffer','genTinyFile','sha256','string','dcraw导入失败','extname'];_0x2be1=function(){return _0x30398e;};return _0x2be1();}const sharp=require(_0x1696a3(0x15b)),libheif=require(_0x1696a3(0x15c)),config=require(_0x1696a3(0x16d)),transCodeUtil=require(_0x1696a3(0x174)),sharpBmp=require(_0x1696a3(0x14e));let sha256=require(_0x1696a3(0x155));const {Worker}=require('worker_threads');let dcraw;function getDcraw(){const _0x262b21=_0x1696a3;if(!dcraw)try{return dcraw=require(_0x262b21(0x14d)),dcraw;}catch(_0xd4660c){return console['log'](_0x262b21(0x157)),null;}else return dcraw;}let PSD;function getPsd(){const _0x36aec7=_0x1696a3;if(!PSD)try{return PSD=require('psd'),PSD;}catch(_0x3c2193){return console[_0x36aec7(0x150)]('psd导入失败'),null;}else return PSD;}function extractThumbnailFromRaw(_0x2aa800,_0x49a99d){return new Promise((_0x1182b3,_0x8dadec)=>{const _0x7f447c=_0x4b47;if(_0x49a99d&&_0x49a99d[_0x7f447c(0x134)]()==_0x7f447c(0x140)){let _0x5d93b3=getPsd();if(!_0x5d93b3)return _0x8dadec(null);try{if(typeof _0x2aa800==_0x7f447c(0x156)){let _0xebf55b=path[_0x7f447c(0x159)](config[_0x7f447c(0x143)],sha256(_0x2aa800)+_0x7f447c(0x16a));fs[_0x7f447c(0x146)](_0xebf55b,(_0x5679f8,_0x1056e9)=>{const _0x2e84d9=_0x7f447c;try{if(_0x5679f8){let _0x77b5a5=_0x5d93b3[_0x2e84d9(0x127)](_0x2aa800);_0x77b5a5[_0x2e84d9(0x178)](),_0x77b5a5[_0x2e84d9(0x121)][_0x2e84d9(0x15a)](_0xebf55b)[_0x2e84d9(0x136)](()=>{const _0x401372=_0x2e84d9;sharp(_0xebf55b)[_0x401372(0x130)]({'quality':0x4d})[_0x401372(0x153)]()[_0x401372(0x136)](_0x470aea=>{const _0x4311e4=_0x401372;fs[_0x4311e4(0x15d)](_0xebf55b,_0x470aea,_0x4b7e0d=>{if(_0x4b7e0d)return _0x8dadec(null);_0x1182b3(_0xebf55b);});})[_0x401372(0x11a)](_0x3447ba=>{const _0x256ab4=_0x401372;return console[_0x256ab4(0x150)]('sharp\x20deal\x20psd\x20png\x20error\x201',_0x3447ba),_0x8dadec(null);});})[_0x2e84d9(0x11a)](_0x513e69=>{const _0x418aac=_0x2e84d9;return console[_0x418aac(0x150)](_0x418aac(0x139),_0x513e69),_0x8dadec(null);});}else return _0x1182b3(_0xebf55b);}catch(_0x4b3c82){return console['log'](_0x2e84d9(0x123),_0x4b3c82),_0x8dadec(null);}});}else return _0x8dadec(null);}catch(_0x37b96f){return _0x8dadec(null);}}else{let _0x119b60=getDcraw();if(!_0x119b60)return _0x8dadec(null);function _0x10ee03(_0x65ee37){try{const _0x38f739=_0x119b60(_0x65ee37,{'extractThumbnail':!![],'identify':!![]});return _0x38f739?_0x1182b3(_0x38f739):_0x8dadec(null);}catch(_0x11d20f){return _0x8dadec(null);}}if(typeof _0x2aa800==_0x7f447c(0x156))fs[_0x7f447c(0x122)](_0x2aa800,(_0x51469a,_0x512e29)=>{if(_0x51469a)return console['log']('读取失败',_0x2aa800),_0x8dadec(_0x51469a);_0x10ee03(_0x512e29);});else{if(Buffer[_0x7f447c(0x131)](_0x2aa800))_0x10ee03(_0x2aa800);else return _0x8dadec(null);}}});}const exifUtils=require(_0x1696a3(0x14a));sharpUtil[_0x1696a3(0x15e)]=function(_0x465517){const _0x37bf49=_0x1696a3;_0x465517['type']==_0x37bf49(0x12a)&&(_0x465517=Buffer[_0x37bf49(0x135)](_0x465517));let _0x4ce8da={'failOnError':![]};return _0x465517[_0x37bf49(0x12c)]&&_0x465517['height']&&_0x465517[_0x37bf49(0x14b)]&&(_0x4ce8da['raw']={'width':_0x465517[_0x37bf49(0x12c)],'height':_0x465517[_0x37bf49(0x142)],'channels':0x4},_0x465517=_0x465517[_0x37bf49(0x14b)]),sharp(_0x465517,_0x4ce8da);},sharpUtil[_0x1696a3(0x175)]=function(_0xddc153){const _0x227ca4=_0x1696a3;typeof _0xddc153=='string'&&_0xddc153[_0x227ca4(0x12f)](config['tempFilePath'])&&fs['rm'](_0xddc153,_0x37f988=>{});},sharpUtil[_0x1696a3(0x16b)]=function(_0x34fd40,_0x16ebce,_0x278ddc,_0x4e8278,_0xb9f2fe,_0x5dc7c8,_0x6a7d2e,_0x4d8139,_0x52b2c0,_0x563b28,_0x3ed8cf){const _0x46e4b2=_0x1696a3;if(!_0x34fd40)return _0x6a7d2e(null);let _0x304dc2=sharpUtil['getSharpInstanceFromInput'](_0x34fd40);_0x16ebce==_0x46e4b2(0x130)?_0x3ed8cf?_0x304dc2=_0x304dc2[_0x46e4b2(0x130)](_0x3ed8cf):_0x304dc2=_0x304dc2[_0x46e4b2(0x130)]():_0x304dc2=_0x304dc2[_0x46e4b2(0x13d)]({});_0x278ddc&&(_0x304dc2=_0x304dc2[_0x46e4b2(0x12e)]());let _0x5af085=exifUtils[_0x46e4b2(0x171)](_0x563b28);_0x5af085?_0x304dc2=_0x304dc2[_0x46e4b2(0x129)](_0x5af085):_0x304dc2=_0x304dc2[_0x46e4b2(0x129)]();_0x4e8278&&(_0x304dc2=_0x304dc2['resize'](_0x4e8278));if(_0xb9f2fe==_0x46e4b2(0x165))_0x304dc2[_0x46e4b2(0x147)](_0x5dc7c8,(_0x1f634c,_0x38b209)=>{const _0xfe8803=_0x46e4b2;_0x52b2c0&&(console[_0xfe8803(0x150)](_0xfe8803(0x126),_0x34fd40),sharpUtil[_0xfe8803(0x175)](_0x34fd40)),_0x1f634c?(console[_0xfe8803(0x150)](_0xfe8803(0x166),_0x34fd40,_0x1f634c),_0x4d8139()):_0x6a7d2e(_0x5dc7c8);});else _0xb9f2fe=='buffer'&&_0x304dc2[_0x46e4b2(0x153)]((_0x409ed9,_0x279960,_0x501e28)=>{const _0x183e04=_0x46e4b2;_0x52b2c0&&sharpUtil[_0x183e04(0x175)](_0x34fd40),_0x409ed9?(console[_0x183e04(0x150)](_0x183e04(0x167),_0x409ed9),_0x4d8139()):_0x6a7d2e(_0x279960);});};function sharpImg(_0x267b19,_0x36493b,_0x47df64,_0x34ae3d,_0x2786a8){const _0x3991dd=_0x1696a3;sharpUtil[_0x3991dd(0x163)](_0x267b19,(_0x16ba10,_0x569f40,_0x3ad2a1)=>{const _0x45cdc0=_0x3991dd;!_0x36493b[_0x45cdc0(0x12c)]&&!_0x36493b[_0x45cdc0(0x142)]&&(_0x36493b={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x45cdc0(0x16b)](_0x16ba10,null,![],_0x36493b,'file',_0x47df64,_0x34ae3d,_0x2786a8,_0x569f40,_0x3ad2a1);});}sharpUtil[_0x1696a3(0x154)]=function(_0x4c3b79,_0x554343,_0x3cff0e,_0x1e7476,_0x3ba263,_0x552bff,_0x347ed1,_0x15844b){const _0x5a6b57=_0x1696a3;_0x15844b&&(_0x15844b=parseInt(_0x15844b));let _0x35be0f=path[_0x5a6b57(0x159)](_0x554343,_0x3cff0e);if(_0x1e7476==_0x5a6b57(0x121)){let _0x2a670c={};_0x3ba263&&_0x3ba263[_0x5a6b57(0x12c)]&&_0x3ba263[_0x5a6b57(0x142)]?_0x3ba263['width']>_0x3ba263[_0x5a6b57(0x142)]?_0x2a670c['width']=_0x15844b?_0x15844b:0x258:_0x2a670c['height']=_0x15844b?_0x15844b:0x258:(_0x2a670c[_0x5a6b57(0x12c)]=_0x15844b,_0x2a670c['height']=_0x15844b),sharpImg(_0x4c3b79,_0x2a670c,_0x35be0f,_0x552bff,_0x347ed1);}else{if(_0x1e7476=='video'){let _0x3471bc=FFmpeg(transCodeUtil['dealFFmpegPath'](_0x4c3b79),{'timeout':0x3c});_0x3471bc['on'](_0x5a6b57(0x148),()=>{const _0x3d70d7=_0x5a6b57;_0x3471bc[_0x3d70d7(0x141)](),_0x552bff(path[_0x3d70d7(0x159)](_0x554343,_0x3cff0e));}),_0x3471bc['on'](_0x5a6b57(0x14f),function(_0x51e301,_0x4a21c8,_0x106165){_0x3471bc['kill'](),_0x347ed1&&_0x347ed1();}),_0x3471bc[_0x5a6b57(0x177)]({'timestamps':['10%'],'filename':_0x3cff0e,'folder':_0x554343,'size':_0x5a6b57(0x12b)});}}},sharpUtil[_0x1696a3(0x172)]=function(_0x305265){return new Promise((_0x2a4798,_0x182d1b)=>{const _0x4c22a6=_0x4b47;let _0xe5540b=new Worker(path['resolve'](__dirname,_0x4c22a6(0x149)),{'workerData':{'inputBuffer':_0x305265}}),_0x57cff6=setTimeout(()=>{const _0x5f280e=_0x4c22a6;_0xe5540b&&(console[_0x5f280e(0x150)](_0x5f280e(0x13f)),_0xe5540b['terminate'](),_0xe5540b=null,_0x182d1b());},0x3a98);_0xe5540b['on'](_0x4c22a6(0x169),_0x20d369=>{const _0x79f485=_0x4c22a6;_0x20d369[_0x79f485(0x11e)]==0x0&&(_0x57cff6&&clearTimeout(_0x57cff6),_0x2a4798(_0x20d369[_0x79f485(0x179)]));}),_0xe5540b['on']('error',_0x3447af=>{const _0x4c7327=_0x4c22a6;console[_0x4c7327(0x14f)](_0x4c7327(0x16f),_0x3447af),_0xe5540b&&(_0xe5540b['terminate'](),_0xe5540b=null),_0x182d1b();}),_0xe5540b['on'](_0x4c22a6(0x170),_0x16cd0e=>{const _0x4a5428=_0x4c22a6;if(_0x16cd0e!==0x0)console[_0x4a5428(0x14f)](_0x4a5428(0x128),_0x16cd0e);else{}});});},sharpUtil[_0x1696a3(0x13a)]=function(_0x259a33,_0x360d73,_0x232bdf){const _0x3d6033=_0x1696a3;if(_0x259a33)_0x259a33=_0x259a33[_0x3d6033(0x134)]();if(_0x259a33&&(_0x259a33=='.heic'||_0x259a33=='.heif'||_0x259a33==_0x3d6033(0x11d)))sharpUtil[_0x3d6033(0x172)](_0x360d73)[_0x3d6033(0x136)](_0x276aa6=>{_0x276aa6?_0x232bdf(_0x276aa6):_0x232bdf(_0x360d73);})[_0x3d6033(0x11a)](()=>{_0x232bdf(_0x360d73);});else{if(_0x259a33&&_0x259a33==_0x3d6033(0x144))try{const _0x3feba5=sharpBmp[_0x3d6033(0x15f)](_0x360d73);_0x232bdf(_0x3feba5);}catch(_0x5b0464){_0x232bdf(_0x360d73);}else _0x259a33&&config['rawImgTypeList']['includes'](_0x259a33[_0x3d6033(0x134)]())?extractThumbnailFromRaw(_0x360d73,_0x259a33)['then'](_0x42f88b=>{_0x232bdf(_0x42f88b);})['catch'](_0x15a27e=>{console['log']('raw\x20err1',_0x15a27e),_0x232bdf(_0x360d73);}):_0x232bdf(_0x360d73);}},sharpUtil[_0x1696a3(0x163)]=function(_0x2b9a2e,_0x6e6a26){const _0x2e48db=_0x1696a3;let _0x36432a=path['extname'](_0x2b9a2e);if(_0x36432a)_0x36432a=_0x36432a[_0x2e48db(0x134)]();if(_0x36432a&&(_0x36432a=='.heic'||_0x36432a=='.heif'||_0x36432a==_0x2e48db(0x11d)))fs[_0x2e48db(0x122)](_0x2b9a2e,(_0xb0434e,_0x349ac1)=>{const _0xa35518=_0x2e48db;if(_0xb0434e)return _0x6e6a26(_0x2b9a2e);sharpUtil[_0xa35518(0x172)](_0x349ac1)['then'](_0x1b15f6=>{_0x1b15f6?_0x6e6a26(_0x1b15f6):_0x6e6a26(_0x349ac1);})[_0xa35518(0x11a)](()=>{_0x6e6a26(_0x349ac1);});});else{if(_0x36432a&&_0x36432a=='.bmp')console['log']('正在处理bmp',_0x2b9a2e),fs[_0x2e48db(0x122)](_0x2b9a2e,(_0x10fc04,_0x42f60c)=>{const _0x405b8f=_0x2e48db;if(_0x10fc04)console[_0x405b8f(0x150)](_0x10fc04),_0x6e6a26(_0x2b9a2e);else try{const _0x766fcd=sharpBmp['decode'](_0x42f60c);_0x6e6a26(_0x766fcd);}catch(_0x2d0344){_0x6e6a26(_0x2b9a2e);}});else{if(_0x36432a&&config[_0x2e48db(0x145)][_0x2e48db(0x162)](_0x36432a[_0x2e48db(0x134)]()))try{extractThumbnailFromRaw(_0x2b9a2e,_0x36432a)['then'](_0x499f99=>{_0x6e6a26(_0x499f99);})['catch'](_0x62c2fa=>{console['log'](_0x62c2fa),_0x6e6a26(_0x2b9a2e);});}catch(_0x19ad7c){console[_0x2e48db(0x150)](_0x19ad7c),_0x6e6a26(_0x2b9a2e);}else _0x6e6a26(_0x2b9a2e);}}},sharpUtil['returnDealedImage']=function(_0x963104,_0x249e26,_0x5eedfb,_0x44e5e2){const _0x327882=_0x1696a3;sharpUtil[_0x327882(0x163)](_0x249e26,(_0xc344ca,_0xb2425a,_0x301317)=>{const _0x5d9e09=_0x327882;sharpUtil['sharpDealImg'](_0xc344ca,_0x5d9e09(0x130),!![],_0x5eedfb,_0x5d9e09(0x16c),null,_0x571a4f=>{const _0x3a6380=_0x5d9e09;_0x963104[_0x3a6380(0x13b)](Buffer[_0x3a6380(0x135)](_0x571a4f));},()=>{const _0x40ff58=_0x5d9e09;_0x963104[_0x40ff58(0x13c)](0x194)[_0x40ff58(0x148)]();},_0xb2425a,_0x301317,_0x44e5e2);});},sharpUtil[_0x1696a3(0x125)]=function(_0x20ae3b){const _0xce5a3a=_0x1696a3;return config[_0xce5a3a(0x161)][_0xce5a3a(0x162)](_0x20ae3b)||config[_0xce5a3a(0x145)][_0xce5a3a(0x162)](_0x20ae3b[_0xce5a3a(0x134)]())||_0x20ae3b==_0xce5a3a(0x144)||_0x20ae3b==_0xce5a3a(0x133)?!![]:![];},sharpUtil['ifImageIsSpecialFormat']=function(_0x46dcf3){const _0x127cd5=_0x1696a3;let _0x1e69dd=path[_0x127cd5(0x158)](_0x46dcf3)?path[_0x127cd5(0x158)](_0x46dcf3)[_0x127cd5(0x134)]():null;if(!_0x1e69dd)return![];return sharpUtil[_0x127cd5(0x125)](_0x1e69dd);},sharpUtil[_0x1696a3(0x124)]=function(_0x2483f0,_0x1b84b1,_0x4f042a,_0x587ee6,_0x3ebc7c){const _0x3f5c6a=_0x1696a3;if(sharpUtil[_0x3f5c6a(0x168)](_0x1b84b1)||_0x587ee6||_0x3ebc7c){let _0x4708d8=null,_0x528842=null;return _0x587ee6&&_0x587ee6>=0x64&&_0x587ee6<=0x186a0&&(_0x4708d8={'fit':_0x3f5c6a(0x151),'width':parseInt(_0x587ee6),'height':parseInt(_0x587ee6),'withoutEnlargement':!![]}),_0x3ebc7c&&_0x3ebc7c>=0x1e&&_0x3ebc7c<=0x64&&(_0x528842={'quality':parseInt(_0x3ebc7c)}),sharpUtil[_0x3f5c6a(0x152)](_0x2483f0,_0x1b84b1,_0x4708d8,_0x528842);}else{if(_0x4f042a){const _0x281c98=encodeURIComponent(path['basename'](_0x1b84b1))['replace'](/%([0-9A-F]{2})/g,(_0x3313d3,_0x15d740)=>'%'+_0x15d740['toUpperCase']());_0x2483f0[_0x3f5c6a(0x137)](_0x3f5c6a(0x138),_0x3f5c6a(0x11f)+_0x281c98);}_0x2483f0[_0x3f5c6a(0x12d)](_0x1b84b1);}},module[_0x1696a3(0x11b)]=sharpUtil;