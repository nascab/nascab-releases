const _0x9baf0e=_0x24e1;(function(_0x51aad1,_0x204c5d){const _0x527691=_0x24e1,_0x150258=_0x51aad1();while(!![]){try{const _0x320f07=parseInt(_0x527691(0x129))/0x1+parseInt(_0x527691(0x132))/0x2*(-parseInt(_0x527691(0x122))/0x3)+-parseInt(_0x527691(0x17e))/0x4+parseInt(_0x527691(0x120))/0x5*(-parseInt(_0x527691(0x143))/0x6)+-parseInt(_0x527691(0x128))/0x7+-parseInt(_0x527691(0x158))/0x8*(-parseInt(_0x527691(0x150))/0x9)+parseInt(_0x527691(0x14d))/0xa*(parseInt(_0x527691(0x11f))/0xb);if(_0x320f07===_0x204c5d)break;else _0x150258['push'](_0x150258['shift']());}catch(_0x23fe21){_0x150258['push'](_0x150258['shift']());}}}(_0x1430,0x7da6e));let path=require(_0x9baf0e(0x15d)),fs=require('fs'),FFmpeg=require(_0x9baf0e(0x155))[_0x9baf0e(0x11d)],sharpUtil={};const sharp=require('sharp'),libheif=require(_0x9baf0e(0x12d)),config=require('../../myConfig/config'),transCodeUtil=require(_0x9baf0e(0x131)),sharpBmp=require(_0x9baf0e(0x169));let sha256=require('sha256');const {Worker}=require(_0x9baf0e(0x173));let dcraw;function getDcraw(){const _0x32c617=_0x9baf0e;if(!dcraw)try{return dcraw=require(_0x32c617(0x137)),dcraw;}catch(_0x436f66){return console[_0x32c617(0x17f)](_0x32c617(0x167)),null;}else return dcraw;}let PSD;function getPsd(){const _0x5a5cf2=_0x9baf0e;if(!PSD)try{return PSD=require(_0x5a5cf2(0x175)),PSD;}catch(_0x427e06){return console[_0x5a5cf2(0x17f)](_0x5a5cf2(0x123)),null;}else return PSD;}function _0x1430(){const _0x5506f3=['data','join','2367008CrMEmP','1017015gNokNt','buffer','getSharpInstanceFromInput','setHeader','libheif-js/wasm-bundle','end','height','rawImgTypeList','../../utils/transCodeUtil','2wlBaGg','transSpcielFormatFromBuffer','exit','returnDealedFile','extname','dcraw','output','returnDealedImage','.heif','string','catch','image','heicExt','正在处理bmp','.heic','then','rotate','457110SYVkOF','runTransHeicWorker','transSpcielFormat','raw\x20err1','toUpperCase','Buffer','.hif','inside','file','width','2136130csUFcq','Worker\x20stopped\x20with\x20exit\x20code:','screenshots','1459971NDrxuX','tempFilePath','10%','deleteRawTempFile','.tiff','../../libs/nasTrans','读取失败','fromFile','24BbxEfi','600x?','error','.bmp','code','path','处理完成,删除临时文件','readFile','ifExtIsSpecialFormat','kill','psd\x20error\x202','dealFFmpegPath','psd\x20error\x201','terminate','raw','dcraw导入失败','video','sharp-bmp','toFile','exports','resolve','sharpDealImg','type','已超时\x20结束处理worker','sharp\x20err1:','ifImageIsSpecialFormat','jpeg','worker_threads','replace','psd','isBuffer','attachment;\x20filename*=UTF-8\x27\x27','../../utils/exifUtils','basename','status','webp','Worker\x20error:','startsWith','2327872QkgLxL','log','decode','writeFile','../../myWorkers/transHeicWorker.js','toLowerCase','FFmpeg','.psd','66ExzqOr','65LrPfHd','toBuffer','1080489jeAUWb','psd导入失败','_psd.png','includes'];_0x1430=function(){return _0x5506f3;};return _0x1430();}function extractThumbnailFromRaw(_0x2014b9,_0x2aead0){return new Promise((_0x250312,_0x23516c)=>{const _0x10eed7=_0x24e1;if(_0x2aead0&&_0x2aead0[_0x10eed7(0x11c)]()==_0x10eed7(0x11e)){let _0x6ff120=getPsd();if(!_0x6ff120)return _0x23516c(null);try{if(typeof _0x2014b9==_0x10eed7(0x13b)){let _0x15c0ac=path[_0x10eed7(0x127)](config['cachePath'],sha256(_0x2014b9)+_0x10eed7(0x124));fs['stat'](_0x15c0ac,(_0x484fde,_0x2e2196)=>{const _0x123f5d=_0x10eed7;try{if(_0x484fde){let _0x50355d=_0x6ff120[_0x123f5d(0x157)](_0x2014b9);_0x50355d['parse'](),_0x50355d['image']['saveAsPng'](_0x15c0ac)['then'](()=>{const _0x262f79=_0x123f5d;sharp(_0x15c0ac)[_0x262f79(0x172)]({'quality':0x4d})[_0x262f79(0x121)]()[_0x262f79(0x141)](_0x460979=>{const _0x348514=_0x262f79;fs[_0x348514(0x181)](_0x15c0ac,_0x460979,_0x52f872=>{if(_0x52f872)return _0x23516c(null);_0x250312(_0x15c0ac);});})['catch'](_0x167cf8=>{return console['log']('sharp\x20deal\x20psd\x20png\x20error\x201',_0x167cf8),_0x23516c(null);});})['catch'](_0x4e8ee3=>{const _0x591fa6=_0x123f5d;return console[_0x591fa6(0x17f)](_0x591fa6(0x164),_0x4e8ee3),_0x23516c(null);});}else return _0x250312(_0x15c0ac);}catch(_0x193989){return console['log'](_0x123f5d(0x162),_0x193989),_0x23516c(null);}});}else return _0x23516c(null);}catch(_0x55cace){return _0x23516c(null);}}else{let _0x4391af=getDcraw();if(!_0x4391af)return _0x23516c(null);function _0x5c6868(_0x3a4581){try{const _0x3ecc0a=_0x4391af(_0x3a4581,{'extractThumbnail':!![],'identify':!![]});return _0x3ecc0a?_0x250312(_0x3ecc0a):_0x23516c(null);}catch(_0x3f49f0){return _0x23516c(null);}}if(typeof _0x2014b9==_0x10eed7(0x13b))fs[_0x10eed7(0x15f)](_0x2014b9,(_0x12fb3c,_0x2c6cbe)=>{const _0x51a304=_0x10eed7;if(_0x12fb3c)return console[_0x51a304(0x17f)](_0x51a304(0x156),_0x2014b9),_0x23516c(_0x12fb3c);_0x5c6868(_0x2c6cbe);});else{if(Buffer[_0x10eed7(0x176)](_0x2014b9))_0x5c6868(_0x2014b9);else return _0x23516c(null);}}});}const exifUtils=require(_0x9baf0e(0x178));function _0x24e1(_0xda945c,_0x5b16f9){const _0x1430c2=_0x1430();return _0x24e1=function(_0x24e106,_0x12a24a){_0x24e106=_0x24e106-0x11c;let _0x110166=_0x1430c2[_0x24e106];return _0x110166;},_0x24e1(_0xda945c,_0x5b16f9);}sharpUtil[_0x9baf0e(0x12b)]=function(_0x4d709d){const _0x423afa=_0x9baf0e;_0x4d709d[_0x423afa(0x16e)]==_0x423afa(0x148)&&(_0x4d709d=Buffer['from'](_0x4d709d));let _0x12fed1={'failOnError':![]};return _0x4d709d[_0x423afa(0x14c)]&&_0x4d709d['height']&&_0x4d709d['data']&&(_0x12fed1[_0x423afa(0x166)]={'width':_0x4d709d['width'],'height':_0x4d709d[_0x423afa(0x12f)],'channels':0x4},_0x4d709d=_0x4d709d[_0x423afa(0x126)]),sharp(_0x4d709d,_0x12fed1);},sharpUtil['deleteRawTempFile']=function(_0x46d3f2){const _0x7e259b=_0x9baf0e;typeof _0x46d3f2=='string'&&_0x46d3f2[_0x7e259b(0x17d)](config[_0x7e259b(0x151)])&&fs['rm'](_0x46d3f2,_0x4b57a4=>{});},sharpUtil['sharpDealImg']=function(_0x151b8f,_0x466eb2,_0x58d5f7,_0x5d2467,_0x46b9e,_0x177743,_0x12781f,_0x83813b,_0x2f2be1,_0xa98f10,_0x584aae){const _0x152c35=_0x9baf0e;if(!_0x151b8f)return _0x12781f(null);let _0x2af3c9=sharpUtil[_0x152c35(0x12b)](_0x151b8f);_0x466eb2=='jpeg'?_0x584aae?_0x2af3c9=_0x2af3c9[_0x152c35(0x172)](_0x584aae):_0x2af3c9=_0x2af3c9[_0x152c35(0x172)]():_0x2af3c9=_0x2af3c9[_0x152c35(0x17b)]({});_0x58d5f7&&(_0x2af3c9=_0x2af3c9['withMetadata']());let _0x38e2aa=exifUtils['getRotateFromTags'](_0xa98f10);_0x38e2aa?_0x2af3c9=_0x2af3c9[_0x152c35(0x142)](_0x38e2aa):_0x2af3c9=_0x2af3c9[_0x152c35(0x142)]();_0x5d2467&&(_0x2af3c9=_0x2af3c9['resize'](_0x5d2467));if(_0x46b9e==_0x152c35(0x14b))_0x2af3c9[_0x152c35(0x16a)](_0x177743,(_0x220932,_0x40ff43)=>{const _0x2ef705=_0x152c35;_0x2f2be1&&(console['log'](_0x2ef705(0x15e),_0x151b8f),sharpUtil[_0x2ef705(0x153)](_0x151b8f)),_0x220932?(console[_0x2ef705(0x17f)](_0x2ef705(0x170),_0x151b8f,_0x220932),_0x83813b()):_0x12781f(_0x177743);});else _0x46b9e==_0x152c35(0x12a)&&_0x2af3c9[_0x152c35(0x121)]((_0xdb934,_0x5eaa76,_0x36c95c)=>{const _0x4cd22d=_0x152c35;_0x2f2be1&&sharpUtil['deleteRawTempFile'](_0x151b8f),_0xdb934?(console[_0x4cd22d(0x17f)]('sharp\x20err2:',_0xdb934),_0x83813b()):_0x12781f(_0x5eaa76);});};function sharpImg(_0x107180,_0xb90677,_0x1620ea,_0x4b7dc0,_0x438f1a){sharpUtil['transSpcielFormat'](_0x107180,(_0x57c1c6,_0x3b31d7,_0x1b9390)=>{const _0x5d86c1=_0x24e1;!_0xb90677[_0x5d86c1(0x14c)]&&!_0xb90677['height']&&(_0xb90677={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x5d86c1(0x16d)](_0x57c1c6,null,![],_0xb90677,_0x5d86c1(0x14b),_0x1620ea,_0x4b7dc0,_0x438f1a,_0x3b31d7,_0x1b9390);});}sharpUtil['genTinyFile']=function(_0x4967f3,_0x101080,_0x597b4f,_0x2e0deb,_0x3bdad4,_0x1ea715,_0x2ff186,_0x13bef8){const _0x1048f6=_0x9baf0e;_0x13bef8&&(_0x13bef8=parseInt(_0x13bef8));let _0x55ae45=path[_0x1048f6(0x127)](_0x101080,_0x597b4f);if(_0x2e0deb==_0x1048f6(0x13d)){let _0x9bb88e={};_0x3bdad4&&_0x3bdad4[_0x1048f6(0x14c)]&&_0x3bdad4[_0x1048f6(0x12f)]?_0x3bdad4[_0x1048f6(0x14c)]>_0x3bdad4[_0x1048f6(0x12f)]?_0x9bb88e['width']=_0x13bef8?_0x13bef8:0x258:_0x9bb88e[_0x1048f6(0x12f)]=_0x13bef8?_0x13bef8:0x258:(_0x9bb88e[_0x1048f6(0x14c)]=_0x13bef8,_0x9bb88e['height']=_0x13bef8),sharpImg(_0x4967f3,_0x9bb88e,_0x55ae45,_0x1ea715,_0x2ff186);}else{if(_0x2e0deb==_0x1048f6(0x168)){let _0x3b6b0e=FFmpeg(transCodeUtil[_0x1048f6(0x163)](_0x4967f3),{'timeout':0x3c});_0x3b6b0e['on']('end',()=>{const _0x51a535=_0x1048f6;_0x3b6b0e[_0x51a535(0x161)](),_0x1ea715(path[_0x51a535(0x127)](_0x101080,_0x597b4f));}),_0x3b6b0e['on'](_0x1048f6(0x15a),function(_0x4d7b21,_0x327de3,_0x1a4780){_0x3b6b0e['kill'](),_0x2ff186&&_0x2ff186();}),_0x3b6b0e[_0x1048f6(0x14f)]({'timestamps':[_0x1048f6(0x152)],'filename':_0x597b4f,'folder':_0x101080,'size':_0x1048f6(0x159)});}}},sharpUtil[_0x9baf0e(0x144)]=function(_0x35f25b){return new Promise((_0x4c7939,_0x5e1f7c)=>{const _0x4fcd4d=_0x24e1;let _0x44cbf0=new Worker(path[_0x4fcd4d(0x16c)](__dirname,_0x4fcd4d(0x182)),{'workerData':{'inputBuffer':_0x35f25b}}),_0x45a1f7=setTimeout(()=>{const _0x35bbec=_0x4fcd4d;_0x44cbf0&&(console[_0x35bbec(0x17f)](_0x35bbec(0x16f)),_0x44cbf0['terminate'](),_0x44cbf0=null,_0x5e1f7c());},0x3a98);_0x44cbf0['on']('message',_0x31ace3=>{const _0x4a70b6=_0x4fcd4d;_0x31ace3[_0x4a70b6(0x15c)]==0x0&&(_0x45a1f7&&clearTimeout(_0x45a1f7),_0x4c7939(_0x31ace3[_0x4a70b6(0x138)]));}),_0x44cbf0['on']('error',_0x3b9da4=>{const _0x249677=_0x4fcd4d;console['error'](_0x249677(0x17c),_0x3b9da4),_0x44cbf0&&(_0x44cbf0[_0x249677(0x165)](),_0x44cbf0=null),_0x5e1f7c();}),_0x44cbf0['on'](_0x4fcd4d(0x134),_0x76b3e0=>{const _0x3988fd=_0x4fcd4d;if(_0x76b3e0!==0x0)console[_0x3988fd(0x15a)](_0x3988fd(0x14e),_0x76b3e0);else{}});});},sharpUtil[_0x9baf0e(0x133)]=function(_0x36b2b1,_0x40b78b,_0x542bc5){const _0x154379=_0x9baf0e;if(_0x36b2b1)_0x36b2b1=_0x36b2b1[_0x154379(0x11c)]();if(_0x36b2b1&&(_0x36b2b1=='.heic'||_0x36b2b1=='.heif'||_0x36b2b1=='.hif'))sharpUtil['runTransHeicWorker'](_0x40b78b)['then'](_0x408120=>{_0x408120?_0x542bc5(_0x408120):_0x542bc5(_0x40b78b);})[_0x154379(0x13c)](()=>{_0x542bc5(_0x40b78b);});else{if(_0x36b2b1&&_0x36b2b1==_0x154379(0x15b))try{const _0x3096bf=sharpBmp[_0x154379(0x180)](_0x40b78b);_0x542bc5(_0x3096bf);}catch(_0x185061){_0x542bc5(_0x40b78b);}else _0x36b2b1&&config[_0x154379(0x130)][_0x154379(0x125)](_0x36b2b1[_0x154379(0x11c)]())?extractThumbnailFromRaw(_0x40b78b,_0x36b2b1)[_0x154379(0x141)](_0x306ac9=>{_0x542bc5(_0x306ac9);})[_0x154379(0x13c)](_0x1d75a2=>{const _0x2c4a8c=_0x154379;console[_0x2c4a8c(0x17f)](_0x2c4a8c(0x146),_0x1d75a2),_0x542bc5(_0x40b78b);}):_0x542bc5(_0x40b78b);}},sharpUtil[_0x9baf0e(0x145)]=function(_0x3bf21f,_0x470ffc){const _0x1cbc05=_0x9baf0e;let _0xcc2772=path[_0x1cbc05(0x136)](_0x3bf21f);if(_0xcc2772)_0xcc2772=_0xcc2772[_0x1cbc05(0x11c)]();if(_0xcc2772&&(_0xcc2772==_0x1cbc05(0x140)||_0xcc2772==_0x1cbc05(0x13a)||_0xcc2772==_0x1cbc05(0x149)))fs[_0x1cbc05(0x15f)](_0x3bf21f,(_0x52f56a,_0x4f8781)=>{const _0x3c9128=_0x1cbc05;if(_0x52f56a)return _0x470ffc(_0x3bf21f);sharpUtil[_0x3c9128(0x144)](_0x4f8781)[_0x3c9128(0x141)](_0x396a96=>{_0x396a96?_0x470ffc(_0x396a96):_0x470ffc(_0x4f8781);})[_0x3c9128(0x13c)](()=>{_0x470ffc(_0x4f8781);});});else{if(_0xcc2772&&_0xcc2772==_0x1cbc05(0x15b))console[_0x1cbc05(0x17f)](_0x1cbc05(0x13f),_0x3bf21f),fs[_0x1cbc05(0x15f)](_0x3bf21f,(_0x5d32cb,_0x1890ce)=>{const _0x274bc3=_0x1cbc05;if(_0x5d32cb)console['log'](_0x5d32cb),_0x470ffc(_0x3bf21f);else try{const _0x38461d=sharpBmp[_0x274bc3(0x180)](_0x1890ce);_0x470ffc(_0x38461d);}catch(_0x1eb5a1){_0x470ffc(_0x3bf21f);}});else{if(_0xcc2772&&config[_0x1cbc05(0x130)][_0x1cbc05(0x125)](_0xcc2772['toLowerCase']()))try{extractThumbnailFromRaw(_0x3bf21f,_0xcc2772)[_0x1cbc05(0x141)](_0x412b27=>{_0x470ffc(_0x412b27);})['catch'](_0x4aecfb=>{const _0xfefabe=_0x1cbc05;console[_0xfefabe(0x17f)](_0x4aecfb),_0x470ffc(_0x3bf21f);});}catch(_0x15f22d){console[_0x1cbc05(0x17f)](_0x15f22d),_0x470ffc(_0x3bf21f);}else _0x470ffc(_0x3bf21f);}}},sharpUtil[_0x9baf0e(0x139)]=function(_0x24e212,_0x190053,_0x4257ce,_0x4339dd){const _0x30ab28=_0x9baf0e;sharpUtil[_0x30ab28(0x145)](_0x190053,(_0x2529c4,_0x1ce19e,_0x8ffc17)=>{const _0x1a08dd=_0x30ab28;sharpUtil[_0x1a08dd(0x16d)](_0x2529c4,_0x1a08dd(0x172),!![],_0x4257ce,'buffer',null,_0x3703e8=>{_0x24e212['send'](Buffer['from'](_0x3703e8));},()=>{const _0x36a1fb=_0x1a08dd;_0x24e212[_0x36a1fb(0x17a)](0x194)[_0x36a1fb(0x12e)]();},_0x1ce19e,_0x8ffc17,_0x4339dd);});},sharpUtil[_0x9baf0e(0x160)]=function(_0x379def){const _0x15f4f7=_0x9baf0e;return config[_0x15f4f7(0x13e)][_0x15f4f7(0x125)](_0x379def)||config[_0x15f4f7(0x130)]['includes'](_0x379def[_0x15f4f7(0x11c)]())||_0x379def==_0x15f4f7(0x15b)||_0x379def==_0x15f4f7(0x154)?!![]:![];},sharpUtil['ifImageIsSpecialFormat']=function(_0x124bbe){const _0x36c275=_0x9baf0e;let _0x31c98d=path[_0x36c275(0x136)](_0x124bbe)?path['extname'](_0x124bbe)[_0x36c275(0x11c)]():null;if(!_0x31c98d)return![];return sharpUtil['ifExtIsSpecialFormat'](_0x31c98d);},sharpUtil[_0x9baf0e(0x135)]=function(_0x23aa40,_0x333838,_0x449d14,_0x47f2d8,_0x435121){const _0xf2d75f=_0x9baf0e;if(sharpUtil[_0xf2d75f(0x171)](_0x333838)||_0x47f2d8||_0x435121){let _0x2d42a2=null,_0x4fa8c1=null;return _0x47f2d8&&_0x47f2d8>=0x64&&_0x47f2d8<=0x186a0&&(_0x2d42a2={'fit':_0xf2d75f(0x14a),'width':parseInt(_0x47f2d8),'height':parseInt(_0x47f2d8),'withoutEnlargement':!![]}),_0x435121&&_0x435121>=0x1e&&_0x435121<=0x64&&(_0x4fa8c1={'quality':parseInt(_0x435121)}),sharpUtil[_0xf2d75f(0x139)](_0x23aa40,_0x333838,_0x2d42a2,_0x4fa8c1);}else{if(_0x449d14){const _0x1b6299=encodeURIComponent(path[_0xf2d75f(0x179)](_0x333838))[_0xf2d75f(0x174)](/%([0-9A-F]{2})/g,(_0x3afc1c,_0x242be9)=>'%'+_0x242be9[_0xf2d75f(0x147)]());_0x23aa40[_0xf2d75f(0x12c)]('Content-Disposition',_0xf2d75f(0x177)+_0x1b6299);}_0x23aa40['sendFile'](_0x333838);}},module[_0x9baf0e(0x16b)]=sharpUtil;