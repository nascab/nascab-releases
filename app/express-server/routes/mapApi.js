function _0x36c6(){const _0x410e5d=['body','/tile','json','../../myConfig/config','/addTileServer','query','forEach','currentUser','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20','returnErrMsg','\x20geohash\x20like\x20?','post','isCustom','finish','3mBqxQE','getById','Content-Type','zoom','operationFail','splice','catch','createWriteStream','create','log','4006072DqvcjQ','undefined','3249724sdyvOu','stream','41336hbxSpe','mkdir','express','replace','is_admin','NasCab','mapTileServer','downloadMapUrl','tileServerJson','lat','status','length','5wLRuFQ','join','prepare','182252edWCGu','md5','20170TTYFSb','substring','dbOther','app','mapTileServerList','end','parse','GET','522kRNoSp','server','148944mrxhdu','push','{z}','neighbors','{x}','4567002mBkrpW','indexId','findByTitle','current','get','mapTileServerListCustom','value','maxLevel','/getZoom','axios','\x20or\x20','path','name','sendFile','geohash','stringify','error','set','2310iqptWE','{y}','tile.png','exports'];_0x36c6=function(){return _0x410e5d;};return _0x36c6();}const _0x51bf0b=_0x4f82;function _0x4f82(_0x1d96ec,_0x4759be){const _0x36c6c4=_0x36c6();return _0x4f82=function(_0x4f8220,_0x41f3db){_0x4f8220=_0x4f8220-0xb8;let _0x14629b=_0x36c6c4[_0x4f8220];return _0x14629b;},_0x4f82(_0x1d96ec,_0x4759be);}(function(_0x375bf0,_0x53d89f){const _0x31486d=_0x4f82,_0x5417e6=_0x375bf0();while(!![]){try{const _0x2cc2c7=parseInt(_0x31486d(0xe9))/0x1+parseInt(_0x31486d(0xdd))/0x2+parseInt(_0x31486d(0xc0))/0x3*(-parseInt(_0x31486d(0xcc))/0x4)+parseInt(_0x31486d(0xda))/0x5*(parseInt(_0x31486d(0xee))/0x6)+parseInt(_0x31486d(0xca))/0x7+parseInt(_0x31486d(0xce))/0x8*(-parseInt(_0x31486d(0xe7))/0x9)+parseInt(_0x31486d(0xdf))/0xa*(parseInt(_0x31486d(0x100))/0xb);if(_0x2cc2c7===_0x53d89f)break;else _0x5417e6['push'](_0x5417e6['shift']());}catch(_0x2dbe8f){_0x5417e6['push'](_0x5417e6['shift']());}}}(_0x36c6,0xd80fa));var express=require(_0x51bf0b(0xd0)),router=express['Router']();let path=require(_0x51bf0b(0xf9)),fs=require('fs');const dbFileIndexTable=require('../../db/dbFileIndexTable'),ngeohash=require('ngeohash');let config=require(_0x51bf0b(0x107)),axios=require(_0x51bf0b(0xf7));const urlConfig=require('../../myConfig/urlConfig'),md5=require(_0x51bf0b(0xde)),dbConfigTable=require('../../db/dbConfigTable'),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x19151c,_0x539d4d){const _0x3cb54d=_0x51bf0b;let _0x5b074b=_0x19151c[_0x3cb54d(0xdc)]('SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?')['get']([_0x539d4d+'%']);return _0x5b074b;}function getByGeohashNeighbor(_0xfe43b1,_0x311304){const _0x13a044=_0x51bf0b;let _0x3c58f9=ngeohash[_0x13a044(0xec)](_0x311304),_0x2b5550='',_0x4a9b22=[];for(let _0x35cddd=0x0;_0x35cddd<_0x3c58f9[_0x13a044(0xd9)];_0x35cddd++){_0x2b5550+=_0x13a044(0xbc),_0x4a9b22[_0x13a044(0xea)](_0x3c58f9[_0x35cddd]+'%'),_0x35cddd!=_0x3c58f9[_0x13a044(0xd9)]-0x1&&(_0x2b5550+=_0x13a044(0xf8));}let _0x2d3620=_0x13a044(0xba)+_0x2b5550;return _0xfe43b1['prepare'](_0x2d3620)[_0x13a044(0xf2)](_0x4a9b22);}router[_0x51bf0b(0xf2)](_0x51bf0b(0x105),(_0x1fbff1,_0x430652,_0x4be301)=>{const _0x3bf154=_0x51bf0b;let _0x5e7472=_0x1fbff1[_0x3bf154(0x109)][_0x3bf154(0xc3)],_0x2580ce=_0x1fbff1[_0x3bf154(0x109)]['x'],_0x106d57=_0x1fbff1['query']['y'];if(!_0x5e7472||!_0x2580ce||!_0x106d57)return _0x430652[_0x3bf154(0xd8)](0x194)[_0x3bf154(0xe4)]();let _0x54942d=getCurrentMapTileServer(_0x1fbff1[_0x3bf154(0xe2)]['dbOther']),_0x3ecaa9=_0x54942d['server'],_0x2252c9=md5(_0x3ecaa9);_0x3ecaa9=_0x3ecaa9['replace'](_0x3bf154(0xeb),_0x5e7472)[_0x3bf154(0xd1)](_0x3bf154(0xed),_0x2580ce)[_0x3bf154(0xd1)](_0x3bf154(0x101),_0x106d57);let _0x386704=path[_0x3bf154(0xdb)](config['userDataFolder'],'mapTiles',_0x2252c9,_0x5e7472,_0x2580ce,_0x106d57,_0x3bf154(0x102));fs['stat'](_0x386704,(_0x308cac,_0x1901f0)=>{const _0x447d8f=_0x3bf154;if(_0x308cac)axios({'url':_0x3ecaa9,'method':_0x447d8f(0xe6),'responseType':_0x447d8f(0xcd),'timeout':0x2710})['then'](_0x5c6dfa=>{const _0x26a8bc=_0x447d8f;fs[_0x26a8bc(0xcf)](path['dirname'](_0x386704),{'recursive':!![]},_0x39290f=>{const _0x52b120=_0x26a8bc;let _0x1f4712=fs[_0x52b120(0xc7)](_0x386704);_0x5c6dfa['data']['pipe'](_0x1f4712),_0x1f4712['on'](_0x52b120(0xbf),()=>{const _0x485a19=_0x52b120;return _0x430652[_0x485a19(0xfb)](_0x386704);}),_0x1f4712['on'](_0x52b120(0xfe),()=>{const _0x344e6b=_0x52b120;return _0x430652[_0x344e6b(0xd8)](0x194)[_0x344e6b(0xe4)]();});});})[_0x447d8f(0xc6)](_0x2b616a=>{const _0x5f1e41=_0x447d8f;return _0x430652[_0x5f1e41(0xd8)](0x194)['end']();});else return _0x430652[_0x447d8f(0xff)](_0x447d8f(0xc2),'image/png'),_0x430652['sendFile'](_0x386704);});});function getCurrentMapTileServer(_0x5dba02){const _0x16b599=_0x51bf0b;let _0x3b2757=dbConfigTable[_0x16b599(0xf0)](_0x5dba02,'mapTileServer');function _0x564d13(){const _0x43d660=_0x16b599;let _0x515809={'name':_0x43d660(0xd3),'isDefault':!![],'server':urlConfig['getUrlByUrlKey'](_0x5dba02,_0x43d660(0xd5)),'maxLevel':defaultMaxMapLevelNasCab};return _0x515809;}try{return _0x3b2757?(_0x3b2757=JSON['parse'](_0x3b2757[_0x16b599(0xf4)]),_0x3b2757[_0x16b599(0xe8)]?(!_0x3b2757[_0x16b599(0xf5)]&&(_0x3b2757[_0x16b599(0xf5)]=defaultMaxMapLevel),_0x3b2757):_0x564d13()):_0x564d13();}catch(_0x5908a0){return console[_0x16b599(0xc9)](_0x5908a0),_0x564d13();}}router[_0x51bf0b(0xf2)]('/getZoom',(_0x1bd71a,_0x567eda,_0x380a39)=>{const _0x91aabe=_0x51bf0b;let _0x541655=getCurrentMapTileServer(_0x1bd71a['app'][_0x91aabe(0xe1)]);return _0x567eda[_0x91aabe(0x106)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x541655['maxLevel']},'tileServer':_0x541655});}),router[_0x51bf0b(0xbd)](_0x51bf0b(0xf6),(_0x1d545d,_0x71705,_0x984172)=>{const _0x57e2fa=_0x51bf0b;let _0x33e69e=getCurrentMapTileServer(_0x1d545d[_0x57e2fa(0xe2)][_0x57e2fa(0xe1)]);return _0x71705[_0x57e2fa(0x106)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x33e69e[_0x57e2fa(0xf5)]},'tileServer':_0x33e69e});}),router[_0x51bf0b(0xbd)]('/getTileServerList',(_0x18c5e2,_0x8db5da,_0x5bb74f)=>{const _0x332d8a=_0x51bf0b;let _0x2f1d1b=dbConfigTable[_0x332d8a(0xf0)](_0x18c5e2[_0x332d8a(0xe2)][_0x332d8a(0xe1)],_0x332d8a(0xe3));_0x2f1d1b?_0x2f1d1b=JSON[_0x332d8a(0xe5)](_0x2f1d1b[_0x332d8a(0xf4)]):_0x2f1d1b=[];_0x2f1d1b[_0x332d8a(0xd9)]==0x0&&_0x2f1d1b[_0x332d8a(0xea)](getCurrentMapTileServer(_0x18c5e2[_0x332d8a(0xe2)][_0x332d8a(0xe1)]));let _0x3dfd2a=dbConfigTable['findByTitle'](_0x18c5e2['app'][_0x332d8a(0xe1)],_0x332d8a(0xf3));_0x3dfd2a&&(_0x3dfd2a=JSON[_0x332d8a(0xe5)](_0x3dfd2a['value']),_0x3dfd2a[_0x332d8a(0xb8)](_0x35a77b=>{const _0x528f43=_0x332d8a;_0x35a77b[_0x528f43(0xbe)]=!![],_0x2f1d1b[_0x528f43(0xea)](_0x35a77b);}));const _0x1f81d2=getCurrentMapTileServer(_0x18c5e2[_0x332d8a(0xe2)][_0x332d8a(0xe1)]);return _0x2f1d1b['forEach'](_0x23da1a=>{const _0x475a35=_0x332d8a;_0x23da1a[_0x475a35(0xf1)]=_0x23da1a[_0x475a35(0xe8)]===_0x1f81d2[_0x475a35(0xe8)]?0x1:0x0;}),_0x8db5da['json']({'code':0x0,'tileServerList':_0x2f1d1b});}),router[_0x51bf0b(0xbd)]('/setTileServer',(_0x50829c,_0x2201f9,_0x375904)=>{const _0x2d240c=_0x51bf0b;if(_0x50829c[_0x2d240c(0xb9)][_0x2d240c(0xd2)]!=0x1)return _0x2201f9[_0x2d240c(0x106)]({'code':0x0});let _0x227b12=_0x50829c[_0x2d240c(0x104)][_0x2d240c(0xd6)];try{let _0x42201e=JSON[_0x2d240c(0xe5)](_0x227b12);!_0x42201e['maxLevel']&&(_0x42201e[_0x2d240c(0xf5)]=defaultMaxMapLevel),_0x42201e[_0x2d240c(0xe8)]&&_0x42201e['name']&&dbConfigTable[_0x2d240c(0xc8)](_0x50829c[_0x2d240c(0xe2)][_0x2d240c(0xe1)],{'title':_0x2d240c(0xd4),'value':JSON[_0x2d240c(0xfd)](_0x42201e)});}catch(_0x358d1c){console['log'](_0x358d1c);}return _0x2201f9[_0x2d240c(0x106)]({'code':0x0});}),router[_0x51bf0b(0xbd)](_0x51bf0b(0x108),(_0x48bd37,_0xfe43bb,_0x5d98e9)=>{const _0x2b77b4=_0x51bf0b;if(_0x48bd37[_0x2b77b4(0xb9)]['is_admin']!=0x1)return _0xfe43bb[_0x2b77b4(0x106)]({'code':0x0});let _0x4f99ee=_0x48bd37['body'][_0x2b77b4(0xd6)];try{let _0x3506b3=JSON['parse'](_0x4f99ee);!_0x3506b3['maxLevel']&&(_0x3506b3['maxLevel']=defaultMaxMapLevel);if(_0x3506b3[_0x2b77b4(0xe8)]&&_0x3506b3[_0x2b77b4(0xfa)]){let _0x43180d=dbConfigTable[_0x2b77b4(0xf0)](_0x48bd37[_0x2b77b4(0xe2)]['dbOther'],_0x2b77b4(0xf3));_0x43180d?_0x43180d=JSON['parse'](_0x43180d[_0x2b77b4(0xf4)]):_0x43180d=[],_0x43180d[_0x2b77b4(0xea)](_0x3506b3),dbConfigTable[_0x2b77b4(0xc8)](_0x48bd37['app']['dbOther'],{'title':'mapTileServerListCustom','value':JSON[_0x2b77b4(0xfd)](_0x43180d)});}return _0xfe43bb[_0x2b77b4(0x106)]({'code':0x0});}catch(_0xce3d10){return console[_0x2b77b4(0xc9)](_0xce3d10),_0x48bd37[_0x2b77b4(0xe2)][_0x2b77b4(0xbb)](_0xfe43bb,_0xfe43bb['__'](_0x2b77b4(0xc4)));}}),router['post']('/deleteTileServer',(_0xc12f75,_0x4cd17f,_0x31762c)=>{const _0x1e9bd7=_0x51bf0b;if(_0xc12f75[_0x1e9bd7(0xb9)]['is_admin']!=0x1)return _0x4cd17f[_0x1e9bd7(0x106)]({'code':0x0});let _0x28757b=_0xc12f75[_0x1e9bd7(0x104)][_0x1e9bd7(0xd6)];try{let _0x4740e8=JSON['parse'](_0x28757b);if(_0x4740e8[_0x1e9bd7(0xe8)]&&_0x4740e8[_0x1e9bd7(0xfa)]){let _0x58f22b=dbConfigTable[_0x1e9bd7(0xf0)](_0xc12f75[_0x1e9bd7(0xe2)][_0x1e9bd7(0xe1)],_0x1e9bd7(0xf3));_0x58f22b?_0x58f22b=JSON[_0x1e9bd7(0xe5)](_0x58f22b['value']):_0x58f22b=[];for(let _0x3bc038=0x0;_0x3bc038<_0x58f22b[_0x1e9bd7(0xd9)];_0x3bc038++){if(_0x58f22b[_0x3bc038][_0x1e9bd7(0xe8)]==_0x4740e8[_0x1e9bd7(0xe8)]){_0x58f22b[_0x1e9bd7(0xc5)](_0x3bc038,0x1);break;}}dbConfigTable['create'](_0xc12f75['app'][_0x1e9bd7(0xe1)],{'title':_0x1e9bd7(0xf3),'value':JSON['stringify'](_0x58f22b)});}}catch(_0x5859f7){console['log'](_0x5859f7);}return _0x4cd17f[_0x1e9bd7(0x106)]({'code':0x0});}),router[_0x51bf0b(0xbd)]('/getLocationStr',(_0x28edf,_0x550d53,_0x3a349f)=>{const _0x1ff3af=_0x51bf0b;let _0x4f02c6=_0x28edf['body'][_0x1ff3af(0xd7)],_0x4f1e4b=_0x28edf[_0x1ff3af(0x104)]['lng'],_0x49563c=_0x28edf[_0x1ff3af(0x104)][_0x1ff3af(0xef)],_0x12df10=dbFileIndexTable[_0x1ff3af(0xc1)](_0x28edf[_0x1ff3af(0xe2)]['dbFileIndex'],_0x49563c);function _0x556fc3(){const _0x57f802=_0x1ff3af;return _0x550d53[_0x57f802(0x106)]({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x12df10&&!_0x4f02c6&&!_0x4f1e4b)return _0x556fc3();let _0x13a998=_0x28edf[_0x1ff3af(0xe2)]['dbCity'],_0x1b9d64='';if(_0x12df10)_0x1b9d64=_0x12df10[_0x1ff3af(0xfc)];else _0x4f02c6&&_0x4f1e4b&&(_0x1b9d64=ngeohash['encode'](_0x4f02c6,_0x4f1e4b));if(!_0x1b9d64||_0x1b9d64==_0x1ff3af(0xcb))return _0x556fc3();let _0x40da3c=undefined;for(let _0x349a07=0x5;_0x349a07>0x0;_0x349a07--){_0x1b9d64=_0x1b9d64[_0x1ff3af(0xe0)](0x0,_0x349a07),_0x40da3c=getByGeohash(_0x13a998,_0x1b9d64);!_0x40da3c&&(_0x40da3c=getByGeohashNeighbor(_0x13a998,_0x1b9d64));if(_0x40da3c)break;}return _0x550d53[_0x1ff3af(0x106)]({'code':0x0,'geo':_0x40da3c});}),module[_0x51bf0b(0x103)]=router;