const _0x4c7871=_0x2e8c;(function(_0x105dab,_0x3305cb){const _0x3dc330=_0x2e8c,_0x466537=_0x105dab();while(!![]){try{const _0x387a45=parseInt(_0x3dc330(0x1e4))/0x1+-parseInt(_0x3dc330(0x1ad))/0x2*(parseInt(_0x3dc330(0x1d6))/0x3)+-parseInt(_0x3dc330(0x1a1))/0x4+-parseInt(_0x3dc330(0x1cf))/0x5+parseInt(_0x3dc330(0x1e2))/0x6*(parseInt(_0x3dc330(0x1d0))/0x7)+parseInt(_0x3dc330(0x1df))/0x8*(-parseInt(_0x3dc330(0x1c1))/0x9)+parseInt(_0x3dc330(0x1be))/0xa;if(_0x387a45===_0x3305cb)break;else _0x466537['push'](_0x466537['shift']());}catch(_0x595595){_0x466537['push'](_0x466537['shift']());}}}(_0xa56a,0xe07fe));var express=require('express'),router=express[_0x4c7871(0x1cc)]();function _0xa56a(){const _0x4da828=['7msgNvQ','current','findByTitle','Content-Type','/getZoom','mapTiles','4979769ZgjWiq','tileServerJson','operationFail','body','sendFile','tile.png','ngeohash','mapTileServerList','prepare','8fnQjtz','value','stringify','8916714viEUxh','log','276162bstYhT','returnErrMsg','dbOther','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20','\x20geohash\x20like\x20?','catch','create','../../myConfig/urlConfig','undefined','substring','data','post','status','\x20or\x20','2040616yGwkhh','currentUser','splice','path','encode','../../db/dbFileIndexTable','parse','neighbors','name','stat','get','end','2rxrLaH','{z}','maxLevel','image/png','forEach','createWriteStream','mapTileServerListCustom','replace','lng','/deleteTileServer','mapTileServer','app','server','push','../../myConfig/config','GET','/addTileServer','35724840woItvU','json','query','14024241riLlMT','set','{y}','length','then','is_admin','getUrlByUrlKey','zoom','dbCity','{x}','mkdir','Router','error','../../db/dbConfigTable','3434445LsRBiU'];_0xa56a=function(){return _0x4da828;};return _0xa56a();}function _0x2e8c(_0x4a6de4,_0x485446){const _0xa56a5c=_0xa56a();return _0x2e8c=function(_0x2e8c13,_0x40af98){_0x2e8c13=_0x2e8c13-0x19b;let _0xa949d6=_0xa56a5c[_0x2e8c13];return _0xa949d6;},_0x2e8c(_0x4a6de4,_0x485446);}let path=require(_0x4c7871(0x1a4)),fs=require('fs');const dbFileIndexTable=require(_0x4c7871(0x1a6)),ngeohash=require(_0x4c7871(0x1dc));let config=require(_0x4c7871(0x1bb)),axios=require('axios');const urlConfig=require(_0x4c7871(0x1eb)),md5=require('md5'),dbConfigTable=require(_0x4c7871(0x1ce)),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x207aa8,_0x477703){const _0x6af7e1=_0x4c7871;let _0x143d35=_0x207aa8[_0x6af7e1(0x1de)]('SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?')[_0x6af7e1(0x1ab)]([_0x477703+'%']);return _0x143d35;}function getByGeohashNeighbor(_0x5b157f,_0x1b0048){const _0x172712=_0x4c7871;let _0x494bd3=ngeohash[_0x172712(0x1a8)](_0x1b0048),_0x1caa34='',_0x150df9=[];for(let _0x5083bf=0x0;_0x5083bf<_0x494bd3[_0x172712(0x1c4)];_0x5083bf++){_0x1caa34+=_0x172712(0x1e8),_0x150df9[_0x172712(0x1ba)](_0x494bd3[_0x5083bf]+'%'),_0x5083bf!=_0x494bd3[_0x172712(0x1c4)]-0x1&&(_0x1caa34+=_0x172712(0x1a0));}let _0x42b0fd=_0x172712(0x1e7)+_0x1caa34;return _0x5b157f[_0x172712(0x1de)](_0x42b0fd)[_0x172712(0x1ab)](_0x150df9);}router[_0x4c7871(0x1ab)]('/tile',(_0x443bd4,_0x159d98,_0x397350)=>{const _0x35b6d2=_0x4c7871;let _0x251c5a=_0x443bd4[_0x35b6d2(0x1c0)][_0x35b6d2(0x1c8)],_0x2e9229=_0x443bd4['query']['x'],_0x39da95=_0x443bd4[_0x35b6d2(0x1c0)]['y'];if(!_0x251c5a||!_0x2e9229||!_0x39da95)return _0x159d98[_0x35b6d2(0x19f)](0x194)['end']();let _0x5e2f10=getCurrentMapTileServer(_0x443bd4['app'][_0x35b6d2(0x1e6)]),_0x42f52e=_0x5e2f10['server'],_0x3c6039=md5(_0x42f52e);_0x42f52e=_0x42f52e[_0x35b6d2(0x1b4)](_0x35b6d2(0x1ae),_0x251c5a)[_0x35b6d2(0x1b4)](_0x35b6d2(0x1ca),_0x2e9229)['replace'](_0x35b6d2(0x1c3),_0x39da95);let _0x3ff198=path['join'](config['userDataFolder'],_0x35b6d2(0x1d5),_0x3c6039,_0x251c5a,_0x2e9229,_0x39da95,_0x35b6d2(0x1db));fs[_0x35b6d2(0x1aa)](_0x3ff198,(_0x4654b6,_0x34e3ca)=>{const _0x4df785=_0x35b6d2;if(_0x4654b6)axios({'url':_0x42f52e,'method':_0x4df785(0x1bc),'responseType':'stream','timeout':0x2710})[_0x4df785(0x1c5)](_0x35a90d=>{const _0x7efee=_0x4df785;fs[_0x7efee(0x1cb)](path['dirname'](_0x3ff198),{'recursive':!![]},_0xaf1ebd=>{const _0x1dc41b=_0x7efee;let _0x26a1a8=fs[_0x1dc41b(0x1b2)](_0x3ff198);_0x35a90d[_0x1dc41b(0x19d)]['pipe'](_0x26a1a8),_0x26a1a8['on']('finish',()=>{const _0x13e534=_0x1dc41b;return _0x159d98[_0x13e534(0x1da)](_0x3ff198);}),_0x26a1a8['on'](_0x1dc41b(0x1cd),()=>{const _0x28f536=_0x1dc41b;return _0x159d98[_0x28f536(0x19f)](0x194)[_0x28f536(0x1ac)]();});});})[_0x4df785(0x1e9)](_0x4d2589=>{const _0x33abe9=_0x4df785;return _0x159d98[_0x33abe9(0x19f)](0x194)['end']();});else return _0x159d98[_0x4df785(0x1c2)](_0x4df785(0x1d3),_0x4df785(0x1b0)),_0x159d98[_0x4df785(0x1da)](_0x3ff198);});});function getCurrentMapTileServer(_0x271e78){const _0x1586ce=_0x4c7871;let _0xe9b394=dbConfigTable['findByTitle'](_0x271e78,_0x1586ce(0x1b7));function _0x159706(){const _0x329a1a=_0x1586ce;let _0x384895={'name':'NasCab','isDefault':!![],'server':urlConfig[_0x329a1a(0x1c7)](_0x271e78,'downloadMapUrl'),'maxLevel':defaultMaxMapLevelNasCab};return _0x384895;}try{return _0xe9b394?(_0xe9b394=JSON[_0x1586ce(0x1a7)](_0xe9b394[_0x1586ce(0x1e0)]),_0xe9b394[_0x1586ce(0x1b9)]?(!_0xe9b394[_0x1586ce(0x1af)]&&(_0xe9b394[_0x1586ce(0x1af)]=defaultMaxMapLevel),_0xe9b394):_0x159706()):_0x159706();}catch(_0x83b0a9){return console['log'](_0x83b0a9),_0x159706();}}router[_0x4c7871(0x1ab)](_0x4c7871(0x1d4),(_0x44b1a2,_0x16b7fa,_0x444a4a)=>{const _0x459138=_0x4c7871;let _0x41d65c=getCurrentMapTileServer(_0x44b1a2[_0x459138(0x1b8)][_0x459138(0x1e6)]);return _0x16b7fa[_0x459138(0x1bf)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x41d65c['maxLevel']},'tileServer':_0x41d65c});}),router[_0x4c7871(0x19e)]('/getZoom',(_0x56c50b,_0xc5f632,_0x399cd6)=>{const _0xaf8626=_0x4c7871;let _0x4bc2ee=getCurrentMapTileServer(_0x56c50b[_0xaf8626(0x1b8)]['dbOther']);return _0xc5f632[_0xaf8626(0x1bf)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x4bc2ee[_0xaf8626(0x1af)]},'tileServer':_0x4bc2ee});}),router['post']('/getTileServerList',(_0x45a821,_0x3f1966,_0x29ff99)=>{const _0xd1625=_0x4c7871;let _0x4bde53=dbConfigTable[_0xd1625(0x1d2)](_0x45a821['app']['dbOther'],_0xd1625(0x1dd));_0x4bde53?_0x4bde53=JSON[_0xd1625(0x1a7)](_0x4bde53['value']):_0x4bde53=[];_0x4bde53[_0xd1625(0x1c4)]==0x0&&_0x4bde53[_0xd1625(0x1ba)](getCurrentMapTileServer(_0x45a821[_0xd1625(0x1b8)][_0xd1625(0x1e6)]));let _0x11acff=dbConfigTable[_0xd1625(0x1d2)](_0x45a821[_0xd1625(0x1b8)][_0xd1625(0x1e6)],'mapTileServerListCustom');_0x11acff&&(_0x11acff=JSON[_0xd1625(0x1a7)](_0x11acff[_0xd1625(0x1e0)]),_0x11acff[_0xd1625(0x1b1)](_0x8fc3bb=>{const _0xfb708e=_0xd1625;_0x8fc3bb['isCustom']=!![],_0x4bde53[_0xfb708e(0x1ba)](_0x8fc3bb);}));const _0x45d62e=getCurrentMapTileServer(_0x45a821[_0xd1625(0x1b8)][_0xd1625(0x1e6)]);return _0x4bde53['forEach'](_0x40b8ae=>{const _0xf2bac4=_0xd1625;_0x40b8ae[_0xf2bac4(0x1d1)]=_0x40b8ae[_0xf2bac4(0x1b9)]===_0x45d62e[_0xf2bac4(0x1b9)]?0x1:0x0;}),_0x3f1966['json']({'code':0x0,'tileServerList':_0x4bde53});}),router[_0x4c7871(0x19e)]('/setTileServer',(_0x266745,_0x37d247,_0x8cecec)=>{const _0x280f9d=_0x4c7871;if(_0x266745[_0x280f9d(0x1a2)][_0x280f9d(0x1c6)]!=0x1)return _0x37d247['json']({'code':0x0});let _0x132650=_0x266745[_0x280f9d(0x1d9)][_0x280f9d(0x1d7)];try{let _0x501227=JSON[_0x280f9d(0x1a7)](_0x132650);!_0x501227[_0x280f9d(0x1af)]&&(_0x501227[_0x280f9d(0x1af)]=defaultMaxMapLevel),_0x501227[_0x280f9d(0x1b9)]&&_0x501227['name']&&dbConfigTable[_0x280f9d(0x1ea)](_0x266745[_0x280f9d(0x1b8)]['dbOther'],{'title':_0x280f9d(0x1b7),'value':JSON['stringify'](_0x501227)});}catch(_0x49c2bf){console['log'](_0x49c2bf);}return _0x37d247[_0x280f9d(0x1bf)]({'code':0x0});}),router[_0x4c7871(0x19e)](_0x4c7871(0x1bd),(_0x1d8794,_0x513e07,_0x49951a)=>{const _0x2ff986=_0x4c7871;if(_0x1d8794[_0x2ff986(0x1a2)][_0x2ff986(0x1c6)]!=0x1)return _0x513e07[_0x2ff986(0x1bf)]({'code':0x0});let _0x50a35a=_0x1d8794[_0x2ff986(0x1d9)][_0x2ff986(0x1d7)];try{let _0x50ca1d=JSON[_0x2ff986(0x1a7)](_0x50a35a);!_0x50ca1d['maxLevel']&&(_0x50ca1d[_0x2ff986(0x1af)]=defaultMaxMapLevel);if(_0x50ca1d[_0x2ff986(0x1b9)]&&_0x50ca1d[_0x2ff986(0x1a9)]){let _0x478ed8=dbConfigTable[_0x2ff986(0x1d2)](_0x1d8794[_0x2ff986(0x1b8)][_0x2ff986(0x1e6)],_0x2ff986(0x1b3));_0x478ed8?_0x478ed8=JSON[_0x2ff986(0x1a7)](_0x478ed8[_0x2ff986(0x1e0)]):_0x478ed8=[],_0x478ed8[_0x2ff986(0x1ba)](_0x50ca1d),dbConfigTable[_0x2ff986(0x1ea)](_0x1d8794[_0x2ff986(0x1b8)]['dbOther'],{'title':_0x2ff986(0x1b3),'value':JSON[_0x2ff986(0x1e1)](_0x478ed8)});}return _0x513e07[_0x2ff986(0x1bf)]({'code':0x0});}catch(_0x548a11){return console['log'](_0x548a11),_0x1d8794[_0x2ff986(0x1b8)][_0x2ff986(0x1e5)](_0x513e07,_0x513e07['__'](_0x2ff986(0x1d8)));}}),router[_0x4c7871(0x19e)](_0x4c7871(0x1b6),(_0xf698c4,_0x3e0cae,_0x2277df)=>{const _0x2416e0=_0x4c7871;if(_0xf698c4[_0x2416e0(0x1a2)]['is_admin']!=0x1)return _0x3e0cae[_0x2416e0(0x1bf)]({'code':0x0});let _0x2b6599=_0xf698c4[_0x2416e0(0x1d9)]['tileServerJson'];try{let _0x1a97b1=JSON[_0x2416e0(0x1a7)](_0x2b6599);if(_0x1a97b1[_0x2416e0(0x1b9)]&&_0x1a97b1['name']){let _0x8b5f51=dbConfigTable[_0x2416e0(0x1d2)](_0xf698c4[_0x2416e0(0x1b8)][_0x2416e0(0x1e6)],'mapTileServerListCustom');_0x8b5f51?_0x8b5f51=JSON[_0x2416e0(0x1a7)](_0x8b5f51[_0x2416e0(0x1e0)]):_0x8b5f51=[];for(let _0x13a3bc=0x0;_0x13a3bc<_0x8b5f51['length'];_0x13a3bc++){if(_0x8b5f51[_0x13a3bc][_0x2416e0(0x1b9)]==_0x1a97b1[_0x2416e0(0x1b9)]){_0x8b5f51[_0x2416e0(0x1a3)](_0x13a3bc,0x1);break;}}dbConfigTable[_0x2416e0(0x1ea)](_0xf698c4[_0x2416e0(0x1b8)][_0x2416e0(0x1e6)],{'title':'mapTileServerListCustom','value':JSON[_0x2416e0(0x1e1)](_0x8b5f51)});}}catch(_0x58082c){console[_0x2416e0(0x1e3)](_0x58082c);}return _0x3e0cae[_0x2416e0(0x1bf)]({'code':0x0});}),router[_0x4c7871(0x19e)]('/getLocationStr',(_0x2af326,_0x39bdba,_0x197e18)=>{const _0x27f96c=_0x4c7871;let _0x458517=_0x2af326[_0x27f96c(0x1d9)]['lat'],_0x3d472d=_0x2af326['body'][_0x27f96c(0x1b5)],_0x36f31d=_0x2af326[_0x27f96c(0x1d9)]['indexId'],_0x422896=dbFileIndexTable['getById'](_0x2af326['app']['dbFileIndex'],_0x36f31d);function _0x1e667b(){const _0x4c8b6d=_0x27f96c;return _0x39bdba[_0x4c8b6d(0x1bf)]({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x422896&&!_0x458517&&!_0x3d472d)return _0x1e667b();let _0x371995=_0x2af326['app'][_0x27f96c(0x1c9)],_0x3612d6='';if(_0x422896)_0x3612d6=_0x422896['geohash'];else _0x458517&&_0x3d472d&&(_0x3612d6=ngeohash[_0x27f96c(0x1a5)](_0x458517,_0x3d472d));if(!_0x3612d6||_0x3612d6==_0x27f96c(0x19b))return _0x1e667b();let _0x40df3d=undefined;for(let _0x198e4e=0x5;_0x198e4e>0x0;_0x198e4e--){_0x3612d6=_0x3612d6[_0x27f96c(0x19c)](0x0,_0x198e4e),_0x40df3d=getByGeohash(_0x371995,_0x3612d6);!_0x40df3d&&(_0x40df3d=getByGeohashNeighbor(_0x371995,_0x3612d6));if(_0x40df3d)break;}return _0x39bdba[_0x27f96c(0x1bf)]({'code':0x0,'geo':_0x40df3d});}),module['exports']=router;