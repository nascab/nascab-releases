const _0x2f109b=_0x36de;(function(_0x5637be,_0x371d23){const _0x3e412f=_0x36de,_0x1507b5=_0x5637be();while(!![]){try{const _0x419cd4=parseInt(_0x3e412f(0x1e3))/0x1*(parseInt(_0x3e412f(0x1cc))/0x2)+-parseInt(_0x3e412f(0x1ba))/0x3*(parseInt(_0x3e412f(0x1ce))/0x4)+parseInt(_0x3e412f(0x1dc))/0x5*(-parseInt(_0x3e412f(0x1b1))/0x6)+-parseInt(_0x3e412f(0x1ed))/0x7+parseInt(_0x3e412f(0x1f6))/0x8+-parseInt(_0x3e412f(0x1f5))/0x9+-parseInt(_0x3e412f(0x1fa))/0xa*(-parseInt(_0x3e412f(0x1fe))/0xb);if(_0x419cd4===_0x371d23)break;else _0x1507b5['push'](_0x1507b5['shift']());}catch(_0x313328){_0x1507b5['push'](_0x1507b5['shift']());}}}(_0x37d5,0x684ce));var express=require('express'),router=express[_0x2f109b(0x1d4)]();let path=require(_0x2f109b(0x1b3)),fs=require('fs');function _0x36de(_0x2a99c2,_0x30076c){const _0x37d505=_0x37d5();return _0x36de=function(_0x36de6b,_0xe474d1){_0x36de6b=_0x36de6b-0x1af;let _0x5ebbd8=_0x37d505[_0x36de6b];return _0x5ebbd8;},_0x36de(_0x2a99c2,_0x30076c);}function _0x37d5(){const _0x4dca94=['stat','dbCity','Router','returnErrMsg','splice','dbOther','indexId','createWriteStream','../../myConfig/config','../../myConfig/urlConfig','10WrTtbs','GET','exports','userDataFolder','create','mapTileServer','/getTileServerList','2JLFGJo','findByTitle','/getLocationStr','status','stream','geohash','log','/deleteTileServer','mapTiles','current','5028548xvGqiX','\x20geohash\x20like\x20?','lng','/setTileServer','join','data','mapTileServerList','get','1710252bUaLgd','1672968NLAjvS','tileServerJson','post','/addTileServer','2610jOynOu','is_admin','finish','mapTileServerListCustom','83567lFSRbo','downloadMapUrl','prepare','app','../../db/dbConfigTable','body','1085862nxnCRr','neighbors','path','../../db/dbFileIndexTable','query','stringify','maxLevel','currentUser','name','3771kedVkZ','mkdir','substring','json','getUrlByUrlKey','{y}','forEach','tile.png','image/png','server','axios','lat','end','catch','push','parse','undefined','error','254794ttpRVw','value','2384BjWhIt','isCustom','length','Content-Type'];_0x37d5=function(){return _0x4dca94;};return _0x37d5();}const dbFileIndexTable=require(_0x2f109b(0x1b4)),ngeohash=require('ngeohash');let config=require(_0x2f109b(0x1da)),axios=require(_0x2f109b(0x1c4));const urlConfig=require(_0x2f109b(0x1db)),md5=require('md5'),dbConfigTable=require(_0x2f109b(0x1af)),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x32315d,_0x593ca4){const _0x5029c3=_0x2f109b;let _0x105393=_0x32315d[_0x5029c3(0x200)]('SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?')[_0x5029c3(0x1f4)]([_0x593ca4+'%']);return _0x105393;}function getByGeohashNeighbor(_0x166b57,_0x36c77a){const _0x172ca3=_0x2f109b;let _0x2d6be7=ngeohash[_0x172ca3(0x1b2)](_0x36c77a),_0x2a2a64='',_0x4751b0=[];for(let _0x68e78b=0x0;_0x68e78b<_0x2d6be7[_0x172ca3(0x1d0)];_0x68e78b++){_0x2a2a64+=_0x172ca3(0x1ee),_0x4751b0[_0x172ca3(0x1c8)](_0x2d6be7[_0x68e78b]+'%'),_0x68e78b!=_0x2d6be7[_0x172ca3(0x1d0)]-0x1&&(_0x2a2a64+='\x20or\x20');}let _0x22357e='SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20'+_0x2a2a64;return _0x166b57['prepare'](_0x22357e)['get'](_0x4751b0);}router['get']('/tile',(_0x25b7df,_0x560f2f,_0x358802)=>{const _0x14893a=_0x2f109b;let _0x36dd36=_0x25b7df[_0x14893a(0x1b5)]['zoom'],_0x2dfc79=_0x25b7df[_0x14893a(0x1b5)]['x'],_0x304bfc=_0x25b7df['query']['y'];if(!_0x36dd36||!_0x2dfc79||!_0x304bfc)return _0x560f2f['status'](0x194)[_0x14893a(0x1c6)]();let _0x142b1c=getCurrentMapTileServer(_0x25b7df['app'][_0x14893a(0x1d7)]),_0x3e29ba=_0x142b1c[_0x14893a(0x1c3)],_0xf487e4=md5(_0x3e29ba);_0x3e29ba=_0x3e29ba['replace']('{z}',_0x36dd36)['replace']('{x}',_0x2dfc79)['replace'](_0x14893a(0x1bf),_0x304bfc);let _0xb23a55=path[_0x14893a(0x1f1)](config[_0x14893a(0x1df)],_0x14893a(0x1eb),_0xf487e4,_0x36dd36,_0x2dfc79,_0x304bfc,_0x14893a(0x1c1));fs[_0x14893a(0x1d2)](_0xb23a55,(_0xf997ea,_0x4ac86d)=>{const _0x329471=_0x14893a;if(_0xf997ea)axios({'url':_0x3e29ba,'method':_0x329471(0x1dd),'responseType':_0x329471(0x1e7),'timeout':0x2710})['then'](_0x580667=>{const _0x461780=_0x329471;fs[_0x461780(0x1bb)](path['dirname'](_0xb23a55),{'recursive':!![]},_0x4118c9=>{const _0x39160e=_0x461780;let _0x2dcd41=fs[_0x39160e(0x1d9)](_0xb23a55);_0x580667[_0x39160e(0x1f2)]['pipe'](_0x2dcd41),_0x2dcd41['on'](_0x39160e(0x1fc),()=>{return _0x560f2f['sendFile'](_0xb23a55);}),_0x2dcd41['on'](_0x39160e(0x1cb),()=>{const _0x4d7354=_0x39160e;return _0x560f2f[_0x4d7354(0x1e6)](0x194)[_0x4d7354(0x1c6)]();});});})[_0x329471(0x1c7)](_0x5894e5=>{const _0x4f2142=_0x329471;return _0x560f2f[_0x4f2142(0x1e6)](0x194)[_0x4f2142(0x1c6)]();});else return _0x560f2f['set'](_0x329471(0x1d1),_0x329471(0x1c2)),_0x560f2f['sendFile'](_0xb23a55);});});function getCurrentMapTileServer(_0x394d14){const _0x3cd0e3=_0x2f109b;let _0x238ab5=dbConfigTable[_0x3cd0e3(0x1e4)](_0x394d14,'mapTileServer');function _0x2b69fd(){const _0x255bd5=_0x3cd0e3;let _0x2067e2={'name':'NasCab','isDefault':!![],'server':urlConfig[_0x255bd5(0x1be)](_0x394d14,_0x255bd5(0x1ff)),'maxLevel':defaultMaxMapLevelNasCab};return _0x2067e2;}try{return _0x238ab5?(_0x238ab5=JSON[_0x3cd0e3(0x1c9)](_0x238ab5[_0x3cd0e3(0x1cd)]),_0x238ab5['server']?(!_0x238ab5['maxLevel']&&(_0x238ab5[_0x3cd0e3(0x1b7)]=defaultMaxMapLevel),_0x238ab5):_0x2b69fd()):_0x2b69fd();}catch(_0x499b67){return console['log'](_0x499b67),_0x2b69fd();}}router[_0x2f109b(0x1f4)]('/getZoom',(_0x454db6,_0x4161b8,_0x4f49b2)=>{const _0x18af35=_0x2f109b;let _0x1bfbb9=getCurrentMapTileServer(_0x454db6[_0x18af35(0x201)][_0x18af35(0x1d7)]);return _0x4161b8[_0x18af35(0x1bd)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x1bfbb9[_0x18af35(0x1b7)]},'tileServer':_0x1bfbb9});}),router[_0x2f109b(0x1f8)]('/getZoom',(_0x1316e3,_0x45ecd5,_0xe3b990)=>{const _0x5c45e6=_0x2f109b;let _0x46b5bc=getCurrentMapTileServer(_0x1316e3[_0x5c45e6(0x201)][_0x5c45e6(0x1d7)]);return _0x45ecd5[_0x5c45e6(0x1bd)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x46b5bc[_0x5c45e6(0x1b7)]},'tileServer':_0x46b5bc});}),router['post'](_0x2f109b(0x1e2),(_0x410f18,_0x5b3db9,_0x17d940)=>{const _0x57a02d=_0x2f109b;let _0x179658=dbConfigTable[_0x57a02d(0x1e4)](_0x410f18[_0x57a02d(0x201)]['dbOther'],_0x57a02d(0x1f3));_0x179658?_0x179658=JSON[_0x57a02d(0x1c9)](_0x179658['value']):_0x179658=[];_0x179658[_0x57a02d(0x1d0)]==0x0&&_0x179658['push'](getCurrentMapTileServer(_0x410f18[_0x57a02d(0x201)]['dbOther']));let _0x108964=dbConfigTable[_0x57a02d(0x1e4)](_0x410f18[_0x57a02d(0x201)][_0x57a02d(0x1d7)],_0x57a02d(0x1fd));_0x108964&&(_0x108964=JSON[_0x57a02d(0x1c9)](_0x108964['value']),_0x108964[_0x57a02d(0x1c0)](_0x12f7a8=>{const _0x4d2077=_0x57a02d;_0x12f7a8[_0x4d2077(0x1cf)]=!![],_0x179658['push'](_0x12f7a8);}));const _0x8206fc=getCurrentMapTileServer(_0x410f18[_0x57a02d(0x201)]['dbOther']);return _0x179658[_0x57a02d(0x1c0)](_0x2cd518=>{const _0x3e62ba=_0x57a02d;_0x2cd518[_0x3e62ba(0x1ec)]=_0x2cd518[_0x3e62ba(0x1c3)]===_0x8206fc[_0x3e62ba(0x1c3)]?0x1:0x0;}),_0x5b3db9[_0x57a02d(0x1bd)]({'code':0x0,'tileServerList':_0x179658});}),router[_0x2f109b(0x1f8)](_0x2f109b(0x1f0),(_0x29ce24,_0x10aa3b,_0x6cd91a)=>{const _0xbfe8a6=_0x2f109b;if(_0x29ce24[_0xbfe8a6(0x1b8)]['is_admin']!=0x1)return _0x10aa3b[_0xbfe8a6(0x1bd)]({'code':0x0});let _0x3dde32=_0x29ce24[_0xbfe8a6(0x1b0)][_0xbfe8a6(0x1f7)];try{let _0x1098d4=JSON[_0xbfe8a6(0x1c9)](_0x3dde32);!_0x1098d4[_0xbfe8a6(0x1b7)]&&(_0x1098d4[_0xbfe8a6(0x1b7)]=defaultMaxMapLevel),_0x1098d4[_0xbfe8a6(0x1c3)]&&_0x1098d4[_0xbfe8a6(0x1b9)]&&dbConfigTable['create'](_0x29ce24[_0xbfe8a6(0x201)]['dbOther'],{'title':_0xbfe8a6(0x1e1),'value':JSON[_0xbfe8a6(0x1b6)](_0x1098d4)});}catch(_0x45bcec){console[_0xbfe8a6(0x1e9)](_0x45bcec);}return _0x10aa3b[_0xbfe8a6(0x1bd)]({'code':0x0});}),router[_0x2f109b(0x1f8)](_0x2f109b(0x1f9),(_0x42dbf5,_0x4b15c7,_0x30082d)=>{const _0x301cb4=_0x2f109b;if(_0x42dbf5[_0x301cb4(0x1b8)][_0x301cb4(0x1fb)]!=0x1)return _0x4b15c7[_0x301cb4(0x1bd)]({'code':0x0});let _0x584025=_0x42dbf5[_0x301cb4(0x1b0)][_0x301cb4(0x1f7)];try{let _0x570b63=JSON['parse'](_0x584025);!_0x570b63['maxLevel']&&(_0x570b63[_0x301cb4(0x1b7)]=defaultMaxMapLevel);if(_0x570b63[_0x301cb4(0x1c3)]&&_0x570b63[_0x301cb4(0x1b9)]){let _0x53be24=dbConfigTable['findByTitle'](_0x42dbf5['app']['dbOther'],_0x301cb4(0x1fd));_0x53be24?_0x53be24=JSON[_0x301cb4(0x1c9)](_0x53be24[_0x301cb4(0x1cd)]):_0x53be24=[],_0x53be24[_0x301cb4(0x1c8)](_0x570b63),dbConfigTable[_0x301cb4(0x1e0)](_0x42dbf5[_0x301cb4(0x201)]['dbOther'],{'title':_0x301cb4(0x1fd),'value':JSON[_0x301cb4(0x1b6)](_0x53be24)});}return _0x4b15c7[_0x301cb4(0x1bd)]({'code':0x0});}catch(_0x12860a){return console['log'](_0x12860a),_0x42dbf5[_0x301cb4(0x201)][_0x301cb4(0x1d5)](_0x4b15c7,_0x4b15c7['__']('operationFail'));}}),router[_0x2f109b(0x1f8)](_0x2f109b(0x1ea),(_0x5db0e7,_0xedf44b,_0x3d263b)=>{const _0x222802=_0x2f109b;if(_0x5db0e7[_0x222802(0x1b8)][_0x222802(0x1fb)]!=0x1)return _0xedf44b[_0x222802(0x1bd)]({'code':0x0});let _0xa16400=_0x5db0e7[_0x222802(0x1b0)]['tileServerJson'];try{let _0x3aa456=JSON[_0x222802(0x1c9)](_0xa16400);if(_0x3aa456[_0x222802(0x1c3)]&&_0x3aa456[_0x222802(0x1b9)]){let _0x5030cf=dbConfigTable[_0x222802(0x1e4)](_0x5db0e7[_0x222802(0x201)][_0x222802(0x1d7)],_0x222802(0x1fd));_0x5030cf?_0x5030cf=JSON['parse'](_0x5030cf[_0x222802(0x1cd)]):_0x5030cf=[];for(let _0x139911=0x0;_0x139911<_0x5030cf['length'];_0x139911++){if(_0x5030cf[_0x139911][_0x222802(0x1c3)]==_0x3aa456[_0x222802(0x1c3)]){_0x5030cf[_0x222802(0x1d6)](_0x139911,0x1);break;}}dbConfigTable[_0x222802(0x1e0)](_0x5db0e7[_0x222802(0x201)][_0x222802(0x1d7)],{'title':'mapTileServerListCustom','value':JSON[_0x222802(0x1b6)](_0x5030cf)});}}catch(_0x4f57cc){console[_0x222802(0x1e9)](_0x4f57cc);}return _0xedf44b[_0x222802(0x1bd)]({'code':0x0});}),router[_0x2f109b(0x1f8)](_0x2f109b(0x1e5),(_0x28c82f,_0x4a598a,_0x5620ff)=>{const _0x7796ba=_0x2f109b;let _0x4cef37=_0x28c82f['body'][_0x7796ba(0x1c5)],_0x3ccad4=_0x28c82f[_0x7796ba(0x1b0)][_0x7796ba(0x1ef)],_0x24dc3c=_0x28c82f[_0x7796ba(0x1b0)][_0x7796ba(0x1d8)],_0x2a6016=dbFileIndexTable['getById'](_0x28c82f[_0x7796ba(0x201)]['dbFileIndex'],_0x24dc3c);function _0x2cdd3c(){const _0x5b4416=_0x7796ba;return _0x4a598a[_0x5b4416(0x1bd)]({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x2a6016&&!_0x4cef37&&!_0x3ccad4)return _0x2cdd3c();let _0x5741f8=_0x28c82f[_0x7796ba(0x201)][_0x7796ba(0x1d3)],_0x432375='';if(_0x2a6016)_0x432375=_0x2a6016[_0x7796ba(0x1e8)];else _0x4cef37&&_0x3ccad4&&(_0x432375=ngeohash['encode'](_0x4cef37,_0x3ccad4));if(!_0x432375||_0x432375==_0x7796ba(0x1ca))return _0x2cdd3c();let _0x571995=undefined;for(let _0x66666e=0x5;_0x66666e>0x0;_0x66666e--){_0x432375=_0x432375[_0x7796ba(0x1bc)](0x0,_0x66666e),_0x571995=getByGeohash(_0x5741f8,_0x432375);!_0x571995&&(_0x571995=getByGeohashNeighbor(_0x5741f8,_0x432375));if(_0x571995)break;}return _0x4a598a['json']({'code':0x0,'geo':_0x571995});}),module[_0x2f109b(0x1de)]=router;