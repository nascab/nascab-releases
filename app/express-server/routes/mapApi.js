const _0x3b5fb8=_0x55ef;(function(_0x322b68,_0x55c5a5){const _0x44cc37=_0x55ef,_0xc093e8=_0x322b68();while(!![]){try{const _0x402401=parseInt(_0x44cc37(0x10c))/0x1*(-parseInt(_0x44cc37(0xff))/0x2)+-parseInt(_0x44cc37(0x12b))/0x3+parseInt(_0x44cc37(0x12c))/0x4+parseInt(_0x44cc37(0x116))/0x5*(parseInt(_0x44cc37(0xf5))/0x6)+-parseInt(_0x44cc37(0x12d))/0x7*(parseInt(_0x44cc37(0xf9))/0x8)+-parseInt(_0x44cc37(0xf2))/0x9*(-parseInt(_0x44cc37(0xe5))/0xa)+parseInt(_0x44cc37(0x129))/0xb*(parseInt(_0x44cc37(0xde))/0xc);if(_0x402401===_0x55c5a5)break;else _0xc093e8['push'](_0xc093e8['shift']());}catch(_0x1b6453){_0xc093e8['push'](_0xc093e8['shift']());}}}(_0x4d6b,0x8cc29));var express=require(_0x3b5fb8(0x105)),router=express[_0x3b5fb8(0xec)]();let path=require(_0x3b5fb8(0x124)),fs=require('fs');const dbFileIndexTable=require(_0x3b5fb8(0x128)),ngeohash=require('ngeohash');let config=require('../../myConfig/config'),axios=require(_0x3b5fb8(0xed));function _0x55ef(_0x1140ba,_0x5b0116){const _0x4d6b02=_0x4d6b();return _0x55ef=function(_0x55ef64,_0x4586fa){_0x55ef64=_0x55ef64-0xdb;let _0x36c077=_0x4d6b02[_0x55ef64];return _0x36c077;},_0x55ef(_0x1140ba,_0x5b0116);}const urlConfig=require(_0x3b5fb8(0x10d)),md5=require(_0x3b5fb8(0xe2)),dbConfigTable=require('../../db/dbConfigTable'),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x7d09cd,_0x3a283e){const _0x4fe682=_0x3b5fb8;let _0x2808c4=_0x7d09cd[_0x4fe682(0x11e)](_0x4fe682(0xe6))['get']([_0x3a283e+'%']);return _0x2808c4;}function getByGeohashNeighbor(_0x1fd491,_0x2148b3){const _0x2dd525=_0x3b5fb8;let _0x10b3fb=ngeohash['neighbors'](_0x2148b3),_0x528ed5='',_0x40e19b=[];for(let _0x43b91c=0x0;_0x43b91c<_0x10b3fb[_0x2dd525(0x127)];_0x43b91c++){_0x528ed5+=_0x2dd525(0xee),_0x40e19b['push'](_0x10b3fb[_0x43b91c]+'%'),_0x43b91c!=_0x10b3fb[_0x2dd525(0x127)]-0x1&&(_0x528ed5+=_0x2dd525(0x11d));}let _0x54f487=_0x2dd525(0x114)+_0x528ed5;return _0x1fd491[_0x2dd525(0x11e)](_0x54f487)['get'](_0x40e19b);}router['get'](_0x3b5fb8(0xe7),(_0x33b202,_0x5da3ba,_0x36943c)=>{const _0x20f86c=_0x3b5fb8;let _0x5ef314=_0x33b202[_0x20f86c(0xf1)]['zoom'],_0x489898=_0x33b202[_0x20f86c(0xf1)]['x'],_0x24185e=_0x33b202[_0x20f86c(0xf1)]['y'];if(!_0x5ef314||!_0x489898||!_0x24185e)return _0x5da3ba['status'](0x194)[_0x20f86c(0x106)]();let _0x2a3ecb=getCurrentMapTileServer(_0x33b202[_0x20f86c(0x12a)]['dbOther']),_0x57f4ac=_0x2a3ecb[_0x20f86c(0x111)],_0xe33e44=md5(_0x57f4ac);_0x57f4ac=_0x57f4ac['replace'](_0x20f86c(0xf3),_0x5ef314)[_0x20f86c(0x11c)](_0x20f86c(0x117),_0x489898)[_0x20f86c(0x11c)](_0x20f86c(0x103),_0x24185e);let _0x1c13e0=path[_0x20f86c(0xfa)](config[_0x20f86c(0x107)],_0x20f86c(0x121),_0xe33e44,_0x5ef314,_0x489898,_0x24185e,_0x20f86c(0xf6));fs[_0x20f86c(0x122)](_0x1c13e0,(_0x1c84e0,_0x13feb5)=>{const _0x11190a=_0x20f86c;if(_0x1c84e0)axios({'url':_0x57f4ac,'method':_0x11190a(0x12e),'responseType':_0x11190a(0x11a),'timeout':0x2710})[_0x11190a(0xe9)](_0x525bd2=>{const _0x1f710f=_0x11190a;fs[_0x1f710f(0xe4)](path[_0x1f710f(0x123)](_0x1c13e0),{'recursive':!![]},_0x1ddd83=>{const _0x275d29=_0x1f710f;let _0x2d6400=fs['createWriteStream'](_0x1c13e0);_0x525bd2['data'][_0x275d29(0xdd)](_0x2d6400),_0x2d6400['on'](_0x275d29(0x12f),()=>{return _0x5da3ba['sendFile'](_0x1c13e0);}),_0x2d6400['on'](_0x275d29(0xe0),()=>{const _0x6c5ecf=_0x275d29;return _0x5da3ba['status'](0x194)[_0x6c5ecf(0x106)]();});});})[_0x11190a(0x112)](_0x5e551c=>{const _0x31c2a6=_0x11190a;return _0x5da3ba[_0x31c2a6(0xef)](0x194)[_0x31c2a6(0x106)]();});else return _0x5da3ba['set'](_0x11190a(0x104),_0x11190a(0x101)),_0x5da3ba[_0x11190a(0x11f)](_0x1c13e0);});});function getCurrentMapTileServer(_0x2f1f4e){const _0x180b15=_0x3b5fb8;let _0x51b743=dbConfigTable[_0x180b15(0xdf)](_0x2f1f4e,_0x180b15(0xf8));function _0x4f478a(){const _0x4c768b=_0x180b15;let _0x34d8d9={'name':'NasCab','isDefault':!![],'server':urlConfig[_0x4c768b(0x118)](_0x2f1f4e,'downloadMapUrl'),'maxLevel':defaultMaxMapLevelNasCab};return _0x34d8d9;}try{return _0x51b743?(_0x51b743=JSON[_0x180b15(0x11b)](_0x51b743[_0x180b15(0x100)]),_0x51b743[_0x180b15(0x111)]?(!_0x51b743[_0x180b15(0xfb)]&&(_0x51b743[_0x180b15(0xfb)]=defaultMaxMapLevel),_0x51b743):_0x4f478a()):_0x4f478a();}catch(_0x4b2828){return console[_0x180b15(0x115)](_0x4b2828),_0x4f478a();}}function _0x4d6b(){const _0x15ef05=['splice','mapTileServer','16BMaKGc','join','maxLevel','indexId','geohash','mapTileServerList','9386MEdIxt','value','image/png','forEach','{y}','Content-Type','express','end','userDataFolder','tileServerJson','dbOther','json','post','155wtKxyq','../../myConfig/urlConfig','current','operationFail','getById','server','catch','lng','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20','log','5125355vLfhLs','{x}','getUrlByUrlKey','push','stream','parse','replace','\x20or\x20','prepare','sendFile','body','mapTiles','stat','dirname','path','/getTileServerList','is_admin','length','../../db/dbFileIndexTable','22iWxeBH','app','643518twLepy','448540vDAMXP','163681TvuMQj','GET','finish','mapTileServerListCustom','currentUser','pipe','2054364qugKxf','findByTitle','error','stringify','md5','/setTileServer','mkdir','428200pEVglO','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?','/tile','/deleteTileServer','then','undefined','name','Router','axios','\x20geohash\x20like\x20?','status','get','query','18dXyorH','{z}','create','6yWeYCH','tile.png'];_0x4d6b=function(){return _0x15ef05;};return _0x4d6b();}router[_0x3b5fb8(0xf0)]('/getZoom',(_0x20af9c,_0x2cb9ba,_0x12d3bc)=>{const _0x481395=_0x3b5fb8;let _0x3d85bf=getCurrentMapTileServer(_0x20af9c[_0x481395(0x12a)][_0x481395(0x109)]);return _0x2cb9ba[_0x481395(0x10a)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x3d85bf[_0x481395(0xfb)]},'tileServer':_0x3d85bf});}),router[_0x3b5fb8(0x10b)]('/getZoom',(_0x53b43f,_0x2eb062,_0x4e777c)=>{const _0x44baf8=_0x3b5fb8;let _0x5ded2a=getCurrentMapTileServer(_0x53b43f[_0x44baf8(0x12a)][_0x44baf8(0x109)]);return _0x2eb062[_0x44baf8(0x10a)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x5ded2a[_0x44baf8(0xfb)]},'tileServer':_0x5ded2a});}),router[_0x3b5fb8(0x10b)](_0x3b5fb8(0x125),(_0x228ab0,_0x29aaac,_0x1d0c3c)=>{const _0x55e65b=_0x3b5fb8;let _0x508528=dbConfigTable['findByTitle'](_0x228ab0[_0x55e65b(0x12a)]['dbOther'],_0x55e65b(0xfe));_0x508528?_0x508528=JSON[_0x55e65b(0x11b)](_0x508528[_0x55e65b(0x100)]):_0x508528=[];_0x508528[_0x55e65b(0x127)]==0x0&&_0x508528[_0x55e65b(0x119)](getCurrentMapTileServer(_0x228ab0['app'][_0x55e65b(0x109)]));let _0x3a801c=dbConfigTable[_0x55e65b(0xdf)](_0x228ab0[_0x55e65b(0x12a)]['dbOther'],_0x55e65b(0xdb));_0x3a801c&&(_0x3a801c=JSON[_0x55e65b(0x11b)](_0x3a801c['value']),_0x3a801c[_0x55e65b(0x102)](_0x440e9a=>{const _0x4ab47c=_0x55e65b;_0x440e9a['isCustom']=!![],_0x508528[_0x4ab47c(0x119)](_0x440e9a);}));const _0xbcaaf8=getCurrentMapTileServer(_0x228ab0[_0x55e65b(0x12a)][_0x55e65b(0x109)]);return _0x508528['forEach'](_0x36c9de=>{const _0x5dc1ae=_0x55e65b;_0x36c9de[_0x5dc1ae(0x10e)]=_0x36c9de[_0x5dc1ae(0x111)]===_0xbcaaf8[_0x5dc1ae(0x111)]?0x1:0x0;}),_0x29aaac[_0x55e65b(0x10a)]({'code':0x0,'tileServerList':_0x508528});}),router[_0x3b5fb8(0x10b)](_0x3b5fb8(0xe3),(_0x3d05f7,_0xc0b96e,_0x470a3a)=>{const _0x3dea7c=_0x3b5fb8;if(_0x3d05f7[_0x3dea7c(0xdc)][_0x3dea7c(0x126)]!=0x1)return _0xc0b96e[_0x3dea7c(0x10a)]({'code':0x0});let _0x45fd0b=_0x3d05f7[_0x3dea7c(0x120)][_0x3dea7c(0x108)];try{let _0x4c7f4b=JSON[_0x3dea7c(0x11b)](_0x45fd0b);!_0x4c7f4b['maxLevel']&&(_0x4c7f4b['maxLevel']=defaultMaxMapLevel),_0x4c7f4b['server']&&_0x4c7f4b[_0x3dea7c(0xeb)]&&dbConfigTable['create'](_0x3d05f7[_0x3dea7c(0x12a)][_0x3dea7c(0x109)],{'title':_0x3dea7c(0xf8),'value':JSON[_0x3dea7c(0xe1)](_0x4c7f4b)});}catch(_0x410c0d){console[_0x3dea7c(0x115)](_0x410c0d);}return _0xc0b96e['json']({'code':0x0});}),router[_0x3b5fb8(0x10b)]('/addTileServer',(_0xf5d740,_0x48fc93,_0x51f7a8)=>{const _0x1bd0f7=_0x3b5fb8;if(_0xf5d740['currentUser'][_0x1bd0f7(0x126)]!=0x1)return _0x48fc93['json']({'code':0x0});let _0x4ccba3=_0xf5d740['body'][_0x1bd0f7(0x108)];try{let _0x4dc9a0=JSON[_0x1bd0f7(0x11b)](_0x4ccba3);!_0x4dc9a0[_0x1bd0f7(0xfb)]&&(_0x4dc9a0[_0x1bd0f7(0xfb)]=defaultMaxMapLevel);if(_0x4dc9a0['server']&&_0x4dc9a0[_0x1bd0f7(0xeb)]){let _0xa38f20=dbConfigTable['findByTitle'](_0xf5d740[_0x1bd0f7(0x12a)][_0x1bd0f7(0x109)],_0x1bd0f7(0xdb));_0xa38f20?_0xa38f20=JSON['parse'](_0xa38f20[_0x1bd0f7(0x100)]):_0xa38f20=[],_0xa38f20[_0x1bd0f7(0x119)](_0x4dc9a0),dbConfigTable[_0x1bd0f7(0xf4)](_0xf5d740[_0x1bd0f7(0x12a)][_0x1bd0f7(0x109)],{'title':'mapTileServerListCustom','value':JSON[_0x1bd0f7(0xe1)](_0xa38f20)});}return _0x48fc93[_0x1bd0f7(0x10a)]({'code':0x0});}catch(_0xafe03d){return console[_0x1bd0f7(0x115)](_0xafe03d),_0xf5d740[_0x1bd0f7(0x12a)]['returnErrMsg'](_0x48fc93,_0x48fc93['__'](_0x1bd0f7(0x10f)));}}),router[_0x3b5fb8(0x10b)](_0x3b5fb8(0xe8),(_0x6d6494,_0x32b377,_0x385b36)=>{const _0x378cc9=_0x3b5fb8;if(_0x6d6494['currentUser'][_0x378cc9(0x126)]!=0x1)return _0x32b377[_0x378cc9(0x10a)]({'code':0x0});let _0x7c8ca3=_0x6d6494[_0x378cc9(0x120)]['tileServerJson'];try{let _0x15a44f=JSON[_0x378cc9(0x11b)](_0x7c8ca3);if(_0x15a44f['server']&&_0x15a44f[_0x378cc9(0xeb)]){let _0x337bf5=dbConfigTable[_0x378cc9(0xdf)](_0x6d6494[_0x378cc9(0x12a)]['dbOther'],_0x378cc9(0xdb));_0x337bf5?_0x337bf5=JSON[_0x378cc9(0x11b)](_0x337bf5[_0x378cc9(0x100)]):_0x337bf5=[];for(let _0x2240df=0x0;_0x2240df<_0x337bf5[_0x378cc9(0x127)];_0x2240df++){if(_0x337bf5[_0x2240df]['server']==_0x15a44f[_0x378cc9(0x111)]){_0x337bf5[_0x378cc9(0xf7)](_0x2240df,0x1);break;}}dbConfigTable[_0x378cc9(0xf4)](_0x6d6494[_0x378cc9(0x12a)][_0x378cc9(0x109)],{'title':_0x378cc9(0xdb),'value':JSON[_0x378cc9(0xe1)](_0x337bf5)});}}catch(_0x101e5d){console[_0x378cc9(0x115)](_0x101e5d);}return _0x32b377[_0x378cc9(0x10a)]({'code':0x0});}),router['post']('/getLocationStr',(_0x1733c0,_0x1e8eb0,_0x29c5c4)=>{const _0x4f03a9=_0x3b5fb8;let _0x2ac4d5=_0x1733c0[_0x4f03a9(0x120)]['lat'],_0x486fa0=_0x1733c0[_0x4f03a9(0x120)][_0x4f03a9(0x113)],_0x4c7d03=_0x1733c0[_0x4f03a9(0x120)][_0x4f03a9(0xfc)],_0x2d92d2=dbFileIndexTable[_0x4f03a9(0x110)](_0x1733c0[_0x4f03a9(0x12a)]['dbFileIndex'],_0x4c7d03);function _0x71b166(){return _0x1e8eb0['json']({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x2d92d2&&!_0x2ac4d5&&!_0x486fa0)return _0x71b166();let _0x5b421d=_0x1733c0['app']['dbCity'],_0x3ef4df='';if(_0x2d92d2)_0x3ef4df=_0x2d92d2[_0x4f03a9(0xfd)];else _0x2ac4d5&&_0x486fa0&&(_0x3ef4df=ngeohash['encode'](_0x2ac4d5,_0x486fa0));if(!_0x3ef4df||_0x3ef4df==_0x4f03a9(0xea))return _0x71b166();let _0x5f0824=undefined;for(let _0x3f9b42=0x5;_0x3f9b42>0x0;_0x3f9b42--){_0x3ef4df=_0x3ef4df['substring'](0x0,_0x3f9b42),_0x5f0824=getByGeohash(_0x5b421d,_0x3ef4df);!_0x5f0824&&(_0x5f0824=getByGeohashNeighbor(_0x5b421d,_0x3ef4df));if(_0x5f0824)break;}return _0x1e8eb0[_0x4f03a9(0x10a)]({'code':0x0,'geo':_0x5f0824});}),module['exports']=router;