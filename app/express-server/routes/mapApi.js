function _0x4bf0(){const _0x424cbb=['json','24gZXfiS','currentUser','mapTiles','62156pVOIDz','maxLevel','status','parse','dbFileIndex','../../db/dbConfigTable','\x20geohash\x20like\x20?','mapTileServerListCustom','encode','8170950mxhsTa','log','createWriteStream','neighbors','stringify','pipe','262266NaRvCv','stream','ngeohash','app','321IoWrGL','/tile','/deleteTileServer','name','22395076OOuErY','undefined','is_admin','../../db/dbFileIndexTable','forEach','/getZoom','8BLTaiq','body','value','isCustom','tile.png','returnErrMsg','lng','prepare','downloadMapUrl','findByTitle','splice','replace','1535283jQqOdw','push','7430787WxWtla','data','post','current','express','GET','/getLocationStr','{z}','path','query','/addTileServer','md5','mapTileServer','mapTileServerList','end','catch','tileServerJson','indexId','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?','10NNDIKN','zoom','sendFile','axios','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20','length','geohash','image/png','stat','{y}','lat','get','Router','create','2117125nUpfnG','server','exports','/getTileServerList','dbOther','userDataFolder','getById','{x}','/setTileServer'];_0x4bf0=function(){return _0x424cbb;};return _0x4bf0();}const _0x5a6415=_0x19e3;(function(_0x1695eb,_0x9ac275){const _0x541cab=_0x19e3,_0x41ab6d=_0x1695eb();while(!![]){try{const _0x2c9917=-parseInt(_0x541cab(0x1c2))/0x1*(-parseInt(_0x541cab(0x1d0))/0x2)+-parseInt(_0x541cab(0x1c6))/0x3*(-parseInt(_0x541cab(0x1b3))/0x4)+parseInt(_0x541cab(0x1a6))/0x5+parseInt(_0x541cab(0x1bc))/0x6+-parseInt(_0x541cab(0x1de))/0x7+-parseInt(_0x541cab(0x1b0))/0x8*(parseInt(_0x541cab(0x1dc))/0x9)+parseInt(_0x541cab(0x198))/0xa*(-parseInt(_0x541cab(0x1ca))/0xb);if(_0x2c9917===_0x9ac275)break;else _0x41ab6d['push'](_0x41ab6d['shift']());}catch(_0x16f24b){_0x41ab6d['push'](_0x41ab6d['shift']());}}}(_0x4bf0,0xd8bd9));var express=require(_0x5a6415(0x1e2)),router=express[_0x5a6415(0x1a4)]();function _0x19e3(_0x35858d,_0x274e25){const _0x4bf024=_0x4bf0();return _0x19e3=function(_0x19e30b,_0x3d9b12){_0x19e30b=_0x19e30b-0x18a;let _0x27b8ec=_0x4bf024[_0x19e30b];return _0x27b8ec;},_0x19e3(_0x35858d,_0x274e25);}let path=require(_0x5a6415(0x18d)),fs=require('fs');const dbFileIndexTable=require(_0x5a6415(0x1cd)),ngeohash=require(_0x5a6415(0x1c4));let config=require('../../myConfig/config'),axios=require(_0x5a6415(0x19b));const urlConfig=require('../../myConfig/urlConfig'),md5=require(_0x5a6415(0x190)),dbConfigTable=require(_0x5a6415(0x1b8)),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x250e15,_0x49f4e8){const _0x1cdeb7=_0x5a6415;let _0x4882f0=_0x250e15['prepare'](_0x1cdeb7(0x197))['get']([_0x49f4e8+'%']);return _0x4882f0;}function getByGeohashNeighbor(_0x313626,_0x51755e){const _0x83ae96=_0x5a6415;let _0x1e618d=ngeohash[_0x83ae96(0x1bf)](_0x51755e),_0x5d0c4b='',_0x5d88ed=[];for(let _0x2241fd=0x0;_0x2241fd<_0x1e618d['length'];_0x2241fd++){_0x5d0c4b+=_0x83ae96(0x1b9),_0x5d88ed[_0x83ae96(0x1dd)](_0x1e618d[_0x2241fd]+'%'),_0x2241fd!=_0x1e618d[_0x83ae96(0x19d)]-0x1&&(_0x5d0c4b+='\x20or\x20');}let _0x30fa4a=_0x83ae96(0x19c)+_0x5d0c4b;return _0x313626[_0x83ae96(0x1d7)](_0x30fa4a)['get'](_0x5d88ed);}router['get'](_0x5a6415(0x1c7),(_0x2c8e14,_0x3e7ebb,_0x3c831c)=>{const _0x4f73ac=_0x5a6415;let _0x34ed45=_0x2c8e14[_0x4f73ac(0x18e)][_0x4f73ac(0x199)],_0x2a1eb7=_0x2c8e14['query']['x'],_0x5a6777=_0x2c8e14[_0x4f73ac(0x18e)]['y'];if(!_0x34ed45||!_0x2a1eb7||!_0x5a6777)return _0x3e7ebb[_0x4f73ac(0x1b5)](0x194)['end']();let _0x3c5a7d=getCurrentMapTileServer(_0x2c8e14[_0x4f73ac(0x1c5)][_0x4f73ac(0x1aa)]),_0x1f732b=_0x3c5a7d[_0x4f73ac(0x1a7)],_0x5c3e92=md5(_0x1f732b);_0x1f732b=_0x1f732b[_0x4f73ac(0x1db)](_0x4f73ac(0x18c),_0x34ed45)[_0x4f73ac(0x1db)](_0x4f73ac(0x1ad),_0x2a1eb7)['replace'](_0x4f73ac(0x1a1),_0x5a6777);let _0x45e602=path['join'](config[_0x4f73ac(0x1ab)],_0x4f73ac(0x1b2),_0x5c3e92,_0x34ed45,_0x2a1eb7,_0x5a6777,_0x4f73ac(0x1d4));fs[_0x4f73ac(0x1a0)](_0x45e602,(_0x372554,_0x43a55a)=>{const _0x91ac41=_0x4f73ac;if(_0x372554)axios({'url':_0x1f732b,'method':_0x91ac41(0x18a),'responseType':_0x91ac41(0x1c3),'timeout':0x2710})['then'](_0x42ca1a=>{fs['mkdir'](path['dirname'](_0x45e602),{'recursive':!![]},_0x4c24a5=>{const _0x474e31=_0x19e3;let _0x21a303=fs[_0x474e31(0x1be)](_0x45e602);_0x42ca1a[_0x474e31(0x1df)][_0x474e31(0x1c1)](_0x21a303),_0x21a303['on']('finish',()=>{const _0x5150ce=_0x474e31;return _0x3e7ebb[_0x5150ce(0x19a)](_0x45e602);}),_0x21a303['on']('error',()=>{const _0xed0a4e=_0x474e31;return _0x3e7ebb['status'](0x194)[_0xed0a4e(0x193)]();});});})[_0x91ac41(0x194)](_0x47c0ca=>{const _0xfa24f6=_0x91ac41;return _0x3e7ebb[_0xfa24f6(0x1b5)](0x194)[_0xfa24f6(0x193)]();});else return _0x3e7ebb['set']('Content-Type',_0x91ac41(0x19f)),_0x3e7ebb[_0x91ac41(0x19a)](_0x45e602);});});function getCurrentMapTileServer(_0x22b597){const _0x472131=_0x5a6415;let _0x3a2ee7=dbConfigTable['findByTitle'](_0x22b597,_0x472131(0x191));function _0x3244ff(){const _0x4dcee5=_0x472131;let _0x49b7d6={'name':'NasCab','isDefault':!![],'server':urlConfig['getUrlByUrlKey'](_0x22b597,_0x4dcee5(0x1d8)),'maxLevel':defaultMaxMapLevelNasCab};return _0x49b7d6;}try{return _0x3a2ee7?(_0x3a2ee7=JSON['parse'](_0x3a2ee7[_0x472131(0x1d2)]),_0x3a2ee7[_0x472131(0x1a7)]?(!_0x3a2ee7['maxLevel']&&(_0x3a2ee7[_0x472131(0x1b4)]=defaultMaxMapLevel),_0x3a2ee7):_0x3244ff()):_0x3244ff();}catch(_0x2547b5){return console['log'](_0x2547b5),_0x3244ff();}}router[_0x5a6415(0x1a3)](_0x5a6415(0x1cf),(_0x153d3b,_0x41c0fa,_0x187f5f)=>{const _0x2b0f29=_0x5a6415;let _0xa1f0da=getCurrentMapTileServer(_0x153d3b['app'][_0x2b0f29(0x1aa)]);return _0x41c0fa[_0x2b0f29(0x1af)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0xa1f0da[_0x2b0f29(0x1b4)]},'tileServer':_0xa1f0da});}),router[_0x5a6415(0x1e0)](_0x5a6415(0x1cf),(_0x18154d,_0x341263,_0x9debf)=>{const _0x193820=_0x5a6415;let _0x7eeeca=getCurrentMapTileServer(_0x18154d[_0x193820(0x1c5)][_0x193820(0x1aa)]);return _0x341263[_0x193820(0x1af)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x7eeeca[_0x193820(0x1b4)]},'tileServer':_0x7eeeca});}),router[_0x5a6415(0x1e0)](_0x5a6415(0x1a9),(_0x5662eb,_0x568e1d,_0x150dba)=>{const _0x93dacf=_0x5a6415;let _0x25f7e4=dbConfigTable['findByTitle'](_0x5662eb[_0x93dacf(0x1c5)][_0x93dacf(0x1aa)],_0x93dacf(0x192));_0x25f7e4?_0x25f7e4=JSON[_0x93dacf(0x1b6)](_0x25f7e4['value']):_0x25f7e4=[];_0x25f7e4['length']==0x0&&_0x25f7e4[_0x93dacf(0x1dd)](getCurrentMapTileServer(_0x5662eb['app']['dbOther']));let _0x669e0e=dbConfigTable[_0x93dacf(0x1d9)](_0x5662eb[_0x93dacf(0x1c5)][_0x93dacf(0x1aa)],'mapTileServerListCustom');_0x669e0e&&(_0x669e0e=JSON[_0x93dacf(0x1b6)](_0x669e0e['value']),_0x669e0e['forEach'](_0x34cb74=>{const _0x488a7f=_0x93dacf;_0x34cb74[_0x488a7f(0x1d3)]=!![],_0x25f7e4[_0x488a7f(0x1dd)](_0x34cb74);}));const _0x249f55=getCurrentMapTileServer(_0x5662eb['app']['dbOther']);return _0x25f7e4[_0x93dacf(0x1ce)](_0x3f9494=>{const _0x1aa8ae=_0x93dacf;_0x3f9494[_0x1aa8ae(0x1e1)]=_0x3f9494['server']===_0x249f55['server']?0x1:0x0;}),_0x568e1d[_0x93dacf(0x1af)]({'code':0x0,'tileServerList':_0x25f7e4});}),router[_0x5a6415(0x1e0)](_0x5a6415(0x1ae),(_0x1f57f6,_0x574778,_0x23fcad)=>{const _0x31ab73=_0x5a6415;if(_0x1f57f6[_0x31ab73(0x1b1)][_0x31ab73(0x1cc)]!=0x1)return _0x574778['json']({'code':0x0});let _0x3b7368=_0x1f57f6['body'][_0x31ab73(0x195)];try{let _0x204964=JSON[_0x31ab73(0x1b6)](_0x3b7368);!_0x204964[_0x31ab73(0x1b4)]&&(_0x204964[_0x31ab73(0x1b4)]=defaultMaxMapLevel),_0x204964['server']&&_0x204964[_0x31ab73(0x1c9)]&&dbConfigTable['create'](_0x1f57f6['app'][_0x31ab73(0x1aa)],{'title':_0x31ab73(0x191),'value':JSON[_0x31ab73(0x1c0)](_0x204964)});}catch(_0x54cc56){console['log'](_0x54cc56);}return _0x574778['json']({'code':0x0});}),router[_0x5a6415(0x1e0)](_0x5a6415(0x18f),(_0x9b3454,_0x18377b,_0x14d8aa)=>{const _0x527388=_0x5a6415;if(_0x9b3454[_0x527388(0x1b1)][_0x527388(0x1cc)]!=0x1)return _0x18377b[_0x527388(0x1af)]({'code':0x0});let _0x4d150a=_0x9b3454['body']['tileServerJson'];try{let _0x38d3f4=JSON[_0x527388(0x1b6)](_0x4d150a);!_0x38d3f4[_0x527388(0x1b4)]&&(_0x38d3f4[_0x527388(0x1b4)]=defaultMaxMapLevel);if(_0x38d3f4[_0x527388(0x1a7)]&&_0x38d3f4['name']){let _0x174031=dbConfigTable[_0x527388(0x1d9)](_0x9b3454[_0x527388(0x1c5)]['dbOther'],'mapTileServerListCustom');_0x174031?_0x174031=JSON['parse'](_0x174031[_0x527388(0x1d2)]):_0x174031=[],_0x174031[_0x527388(0x1dd)](_0x38d3f4),dbConfigTable['create'](_0x9b3454[_0x527388(0x1c5)][_0x527388(0x1aa)],{'title':'mapTileServerListCustom','value':JSON['stringify'](_0x174031)});}return _0x18377b[_0x527388(0x1af)]({'code':0x0});}catch(_0x105b21){return console['log'](_0x105b21),_0x9b3454[_0x527388(0x1c5)][_0x527388(0x1d5)](_0x18377b,_0x18377b['__']('operationFail'));}}),router['post'](_0x5a6415(0x1c8),(_0x4ee310,_0x170b00,_0x90a4bd)=>{const _0x2f6fac=_0x5a6415;if(_0x4ee310['currentUser'][_0x2f6fac(0x1cc)]!=0x1)return _0x170b00['json']({'code':0x0});let _0x3d9840=_0x4ee310['body']['tileServerJson'];try{let _0x502e37=JSON[_0x2f6fac(0x1b6)](_0x3d9840);if(_0x502e37[_0x2f6fac(0x1a7)]&&_0x502e37['name']){let _0x1bc19f=dbConfigTable[_0x2f6fac(0x1d9)](_0x4ee310[_0x2f6fac(0x1c5)][_0x2f6fac(0x1aa)],_0x2f6fac(0x1ba));_0x1bc19f?_0x1bc19f=JSON[_0x2f6fac(0x1b6)](_0x1bc19f['value']):_0x1bc19f=[];for(let _0x49f10d=0x0;_0x49f10d<_0x1bc19f['length'];_0x49f10d++){if(_0x1bc19f[_0x49f10d][_0x2f6fac(0x1a7)]==_0x502e37['server']){_0x1bc19f[_0x2f6fac(0x1da)](_0x49f10d,0x1);break;}}dbConfigTable[_0x2f6fac(0x1a5)](_0x4ee310['app'][_0x2f6fac(0x1aa)],{'title':_0x2f6fac(0x1ba),'value':JSON['stringify'](_0x1bc19f)});}}catch(_0x17840a){console[_0x2f6fac(0x1bd)](_0x17840a);}return _0x170b00[_0x2f6fac(0x1af)]({'code':0x0});}),router['post'](_0x5a6415(0x18b),(_0x915d85,_0x1fef59,_0x4c6f73)=>{const _0x2472e6=_0x5a6415;let _0x2f2ed4=_0x915d85[_0x2472e6(0x1d1)][_0x2472e6(0x1a2)],_0x32840e=_0x915d85[_0x2472e6(0x1d1)][_0x2472e6(0x1d6)],_0x390e54=_0x915d85[_0x2472e6(0x1d1)][_0x2472e6(0x196)],_0x2328e6=dbFileIndexTable[_0x2472e6(0x1ac)](_0x915d85[_0x2472e6(0x1c5)][_0x2472e6(0x1b7)],_0x390e54);function _0x15e9d9(){const _0x146f5e=_0x2472e6;return _0x1fef59[_0x146f5e(0x1af)]({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x2328e6&&!_0x2f2ed4&&!_0x32840e)return _0x15e9d9();let _0x1c1b13=_0x915d85[_0x2472e6(0x1c5)]['dbCity'],_0x1eb159='';if(_0x2328e6)_0x1eb159=_0x2328e6[_0x2472e6(0x19e)];else _0x2f2ed4&&_0x32840e&&(_0x1eb159=ngeohash[_0x2472e6(0x1bb)](_0x2f2ed4,_0x32840e));if(!_0x1eb159||_0x1eb159==_0x2472e6(0x1cb))return _0x15e9d9();let _0x3d513b=undefined;for(let _0x275d1a=0x5;_0x275d1a>0x0;_0x275d1a--){_0x1eb159=_0x1eb159['substring'](0x0,_0x275d1a),_0x3d513b=getByGeohash(_0x1c1b13,_0x1eb159);!_0x3d513b&&(_0x3d513b=getByGeohashNeighbor(_0x1c1b13,_0x1eb159));if(_0x3d513b)break;}return _0x1fef59[_0x2472e6(0x1af)]({'code':0x0,'geo':_0x3d513b});}),module[_0x5a6415(0x1a8)]=router;