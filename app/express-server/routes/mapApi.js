const _0x74716b=_0x45ab;(function(_0x58afcf,_0x159058){const _0x18513c=_0x45ab,_0x159fcc=_0x58afcf();while(!![]){try{const _0x4dab45=-parseInt(_0x18513c(0x13d))/0x1+parseInt(_0x18513c(0x137))/0x2*(parseInt(_0x18513c(0x108))/0x3)+-parseInt(_0x18513c(0x111))/0x4*(-parseInt(_0x18513c(0x130))/0x5)+parseInt(_0x18513c(0xf4))/0x6*(parseInt(_0x18513c(0xf5))/0x7)+parseInt(_0x18513c(0x127))/0x8*(-parseInt(_0x18513c(0x12e))/0x9)+parseInt(_0x18513c(0x135))/0xa*(-parseInt(_0x18513c(0x121))/0xb)+-parseInt(_0x18513c(0x105))/0xc*(-parseInt(_0x18513c(0x118))/0xd);if(_0x4dab45===_0x159058)break;else _0x159fcc['push'](_0x159fcc['shift']());}catch(_0x2d9982){_0x159fcc['push'](_0x159fcc['shift']());}}}(_0x333b,0x2b948));function _0x45ab(_0x5e127a,_0x55effe){const _0x333b87=_0x333b();return _0x45ab=function(_0x45ab90,_0xb085a4){_0x45ab90=_0x45ab90-0xea;let _0x204b2c=_0x333b87[_0x45ab90];return _0x204b2c;},_0x45ab(_0x5e127a,_0x55effe);}var express=require('express'),router=express[_0x74716b(0xf6)]();let path=require(_0x74716b(0x13c)),fs=require('fs');function _0x333b(){const _0x5b1a1c=['tileServerJson','mapTileServerListCustom','name','{z}','1354490wyCBJD','NasCab','58258pmtCnZ','is_admin','userDataFolder','maxLevel','set','path','341484kzvwIk','post','dirname','axios','../../db/dbFileIndexTable','forEach','length','\x20geohash\x20like\x20?','lng','tile.png','{x}','sendFile','end','finish','value','6nNUXCs','1950018OWWyEX','Router','push','/getLocationStr','splice','encode','/setTileServer','neighbors','indexId','undefined','dbCity','log','findByTitle','exports','error','createWriteStream','2023392VjYqWV','../../myConfig/config','replace','27HnkfzG','{y}','geohash','mapTileServerList','/getZoom','dbFileIndex','returnErrMsg','substring','currentUser','540880TCoLEO','mapTiles','query','getById','app','dbOther','getUrlByUrlKey','26LcWaNF','SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20geohash\x20like\x20?','body','stream','/tile','get','json','stringify','../../myConfig/urlConfig','22dFfCbp','status','image/png','parse','pipe','data','57368ZkWUvR','stat','Content-Type','prepare','server','../../db/dbConfigTable','create','279iHagFY','mapTileServer','5hENILP'];_0x333b=function(){return _0x5b1a1c;};return _0x333b();}const dbFileIndexTable=require(_0x74716b(0x141)),ngeohash=require('ngeohash');let config=require(_0x74716b(0x106)),axios=require(_0x74716b(0x140));const urlConfig=require(_0x74716b(0x120)),md5=require('md5'),dbConfigTable=require(_0x74716b(0x12c)),defaultMaxMapLevel=0x12,defaultMaxMapLevelNasCab=0xc;function getByGeohash(_0x48f4ad,_0x31bde5){const _0x10b9cd=_0x74716b;let _0x598964=_0x48f4ad[_0x10b9cd(0x12a)](_0x10b9cd(0x119))['get']([_0x31bde5+'%']);return _0x598964;}function getByGeohashNeighbor(_0x446db2,_0x58f368){const _0x434833=_0x74716b;let _0xdcdea6=ngeohash[_0x434833(0xfc)](_0x58f368),_0x5ac747='',_0x19a133=[];for(let _0x4bb987=0x0;_0x4bb987<_0xdcdea6[_0x434833(0xeb)];_0x4bb987++){_0x5ac747+=_0x434833(0xec),_0x19a133[_0x434833(0xf7)](_0xdcdea6[_0x4bb987]+'%'),_0x4bb987!=_0xdcdea6[_0x434833(0xeb)]-0x1&&(_0x5ac747+='\x20or\x20');}let _0x4fd3da='SELECT\x20name,cn_name,geohash\x20FROM\x20cities\x20WHERE\x20'+_0x5ac747;return _0x446db2['prepare'](_0x4fd3da)[_0x434833(0x11d)](_0x19a133);}router[_0x74716b(0x11d)](_0x74716b(0x11c),(_0x414cfc,_0x26ed51,_0x1de9e8)=>{const _0x229a18=_0x74716b;let _0xce3abc=_0x414cfc[_0x229a18(0x113)]['zoom'],_0x1fa2cd=_0x414cfc[_0x229a18(0x113)]['x'],_0x5ad648=_0x414cfc[_0x229a18(0x113)]['y'];if(!_0xce3abc||!_0x1fa2cd||!_0x5ad648)return _0x26ed51[_0x229a18(0x122)](0x194)[_0x229a18(0xf1)]();let _0x2b607b=getCurrentMapTileServer(_0x414cfc['app'][_0x229a18(0x116)]),_0x1f1322=_0x2b607b[_0x229a18(0x12b)],_0x3dd010=md5(_0x1f1322);_0x1f1322=_0x1f1322[_0x229a18(0x107)](_0x229a18(0x134),_0xce3abc)[_0x229a18(0x107)](_0x229a18(0xef),_0x1fa2cd)[_0x229a18(0x107)](_0x229a18(0x109),_0x5ad648);let _0x3e8f37=path['join'](config[_0x229a18(0x139)],_0x229a18(0x112),_0x3dd010,_0xce3abc,_0x1fa2cd,_0x5ad648,_0x229a18(0xee));fs[_0x229a18(0x128)](_0x3e8f37,(_0x51764a,_0x6136ca)=>{const _0xb99419=_0x229a18;if(_0x51764a)axios({'url':_0x1f1322,'method':'GET','responseType':_0xb99419(0x11b),'timeout':0x2710})['then'](_0x23182b=>{const _0xfcf652=_0xb99419;fs['mkdir'](path[_0xfcf652(0x13f)](_0x3e8f37),{'recursive':!![]},_0x51a2de=>{const _0x342ea4=_0xfcf652;let _0x5d34c4=fs[_0x342ea4(0x104)](_0x3e8f37);_0x23182b[_0x342ea4(0x126)][_0x342ea4(0x125)](_0x5d34c4),_0x5d34c4['on'](_0x342ea4(0xf2),()=>{return _0x26ed51['sendFile'](_0x3e8f37);}),_0x5d34c4['on'](_0x342ea4(0x103),()=>{const _0x5cb1ce=_0x342ea4;return _0x26ed51['status'](0x194)[_0x5cb1ce(0xf1)]();});});})['catch'](_0x1b5a35=>{const _0x52247c=_0xb99419;return _0x26ed51[_0x52247c(0x122)](0x194)[_0x52247c(0xf1)]();});else return _0x26ed51[_0xb99419(0x13b)](_0xb99419(0x129),_0xb99419(0x123)),_0x26ed51[_0xb99419(0xf0)](_0x3e8f37);});});function getCurrentMapTileServer(_0x35f410){const _0x1099ea=_0x74716b;let _0x5625f3=dbConfigTable[_0x1099ea(0x101)](_0x35f410,_0x1099ea(0x12f));function _0x346eb0(){const _0x1b268a=_0x1099ea;let _0x529953={'name':_0x1b268a(0x136),'isDefault':!![],'server':urlConfig[_0x1b268a(0x117)](_0x35f410,'downloadMapUrl'),'maxLevel':defaultMaxMapLevelNasCab};return _0x529953;}try{return _0x5625f3?(_0x5625f3=JSON[_0x1099ea(0x124)](_0x5625f3['value']),_0x5625f3[_0x1099ea(0x12b)]?(!_0x5625f3['maxLevel']&&(_0x5625f3[_0x1099ea(0x13a)]=defaultMaxMapLevel),_0x5625f3):_0x346eb0()):_0x346eb0();}catch(_0x559884){return console['log'](_0x559884),_0x346eb0();}}router[_0x74716b(0x11d)](_0x74716b(0x10c),(_0x528cd5,_0x5cf462,_0x30153e)=>{const _0x3896bd=_0x74716b;let _0xceea9e=getCurrentMapTileServer(_0x528cd5[_0x3896bd(0x115)][_0x3896bd(0x116)]);return _0x5cf462[_0x3896bd(0x11e)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0xceea9e[_0x3896bd(0x13a)]},'tileServer':_0xceea9e});}),router[_0x74716b(0x13e)](_0x74716b(0x10c),(_0x5f58d5,_0x52f7a3,_0x32f2a3)=>{const _0x349e05=_0x74716b;let _0x3e23db=getCurrentMapTileServer(_0x5f58d5[_0x349e05(0x115)][_0x349e05(0x116)]);return _0x52f7a3[_0x349e05(0x11e)]({'code':0x0,'zoomInfo':{'minZoom':0x2,'maxZoom':_0x3e23db[_0x349e05(0x13a)]},'tileServer':_0x3e23db});}),router['post']('/getTileServerList',(_0x13a86e,_0x227161,_0x5a89e5)=>{const _0xbbcbf7=_0x74716b;let _0x3f7dff=dbConfigTable[_0xbbcbf7(0x101)](_0x13a86e['app'][_0xbbcbf7(0x116)],_0xbbcbf7(0x10b));_0x3f7dff?_0x3f7dff=JSON[_0xbbcbf7(0x124)](_0x3f7dff[_0xbbcbf7(0xf3)]):_0x3f7dff=[];_0x3f7dff[_0xbbcbf7(0xeb)]==0x0&&_0x3f7dff[_0xbbcbf7(0xf7)](getCurrentMapTileServer(_0x13a86e['app'][_0xbbcbf7(0x116)]));let _0x10ebf9=dbConfigTable[_0xbbcbf7(0x101)](_0x13a86e[_0xbbcbf7(0x115)][_0xbbcbf7(0x116)],_0xbbcbf7(0x132));_0x10ebf9&&(_0x10ebf9=JSON[_0xbbcbf7(0x124)](_0x10ebf9[_0xbbcbf7(0xf3)]),_0x10ebf9[_0xbbcbf7(0xea)](_0x151631=>{const _0x2e8aa0=_0xbbcbf7;_0x151631['isCustom']=!![],_0x3f7dff[_0x2e8aa0(0xf7)](_0x151631);}));const _0x565bb9=getCurrentMapTileServer(_0x13a86e[_0xbbcbf7(0x115)]['dbOther']);return _0x3f7dff['forEach'](_0x5a184e=>{const _0x44a8b0=_0xbbcbf7;_0x5a184e['current']=_0x5a184e[_0x44a8b0(0x12b)]===_0x565bb9['server']?0x1:0x0;}),_0x227161[_0xbbcbf7(0x11e)]({'code':0x0,'tileServerList':_0x3f7dff});}),router[_0x74716b(0x13e)](_0x74716b(0xfb),(_0xbceaf8,_0x15f590,_0x4244fd)=>{const _0x1d4bd3=_0x74716b;if(_0xbceaf8[_0x1d4bd3(0x110)][_0x1d4bd3(0x138)]!=0x1)return _0x15f590['json']({'code':0x0});let _0x55215b=_0xbceaf8['body']['tileServerJson'];try{let _0x5612d9=JSON['parse'](_0x55215b);!_0x5612d9[_0x1d4bd3(0x13a)]&&(_0x5612d9[_0x1d4bd3(0x13a)]=defaultMaxMapLevel),_0x5612d9[_0x1d4bd3(0x12b)]&&_0x5612d9[_0x1d4bd3(0x133)]&&dbConfigTable[_0x1d4bd3(0x12d)](_0xbceaf8['app']['dbOther'],{'title':'mapTileServer','value':JSON['stringify'](_0x5612d9)});}catch(_0x1ef96){console[_0x1d4bd3(0x100)](_0x1ef96);}return _0x15f590[_0x1d4bd3(0x11e)]({'code':0x0});}),router[_0x74716b(0x13e)]('/addTileServer',(_0x4e25cb,_0x35d9b7,_0x2b7d03)=>{const _0x41892b=_0x74716b;if(_0x4e25cb['currentUser'][_0x41892b(0x138)]!=0x1)return _0x35d9b7[_0x41892b(0x11e)]({'code':0x0});let _0x1be240=_0x4e25cb['body'][_0x41892b(0x131)];try{let _0x41a950=JSON['parse'](_0x1be240);!_0x41a950[_0x41892b(0x13a)]&&(_0x41a950[_0x41892b(0x13a)]=defaultMaxMapLevel);if(_0x41a950[_0x41892b(0x12b)]&&_0x41a950['name']){let _0x2ef087=dbConfigTable[_0x41892b(0x101)](_0x4e25cb['app'][_0x41892b(0x116)],_0x41892b(0x132));_0x2ef087?_0x2ef087=JSON['parse'](_0x2ef087['value']):_0x2ef087=[],_0x2ef087[_0x41892b(0xf7)](_0x41a950),dbConfigTable['create'](_0x4e25cb[_0x41892b(0x115)][_0x41892b(0x116)],{'title':_0x41892b(0x132),'value':JSON['stringify'](_0x2ef087)});}return _0x35d9b7[_0x41892b(0x11e)]({'code':0x0});}catch(_0x47cc97){return console['log'](_0x47cc97),_0x4e25cb[_0x41892b(0x115)][_0x41892b(0x10e)](_0x35d9b7,_0x35d9b7['__']('operationFail'));}}),router[_0x74716b(0x13e)]('/deleteTileServer',(_0x4aa143,_0x2c73e9,_0x49444d)=>{const _0x2e5e9a=_0x74716b;if(_0x4aa143[_0x2e5e9a(0x110)][_0x2e5e9a(0x138)]!=0x1)return _0x2c73e9[_0x2e5e9a(0x11e)]({'code':0x0});let _0x9f3ec6=_0x4aa143['body']['tileServerJson'];try{let _0x52f27a=JSON[_0x2e5e9a(0x124)](_0x9f3ec6);if(_0x52f27a[_0x2e5e9a(0x12b)]&&_0x52f27a[_0x2e5e9a(0x133)]){let _0x25ee03=dbConfigTable[_0x2e5e9a(0x101)](_0x4aa143['app'][_0x2e5e9a(0x116)],'mapTileServerListCustom');_0x25ee03?_0x25ee03=JSON[_0x2e5e9a(0x124)](_0x25ee03['value']):_0x25ee03=[];for(let _0x547e2b=0x0;_0x547e2b<_0x25ee03['length'];_0x547e2b++){if(_0x25ee03[_0x547e2b][_0x2e5e9a(0x12b)]==_0x52f27a[_0x2e5e9a(0x12b)]){_0x25ee03[_0x2e5e9a(0xf9)](_0x547e2b,0x1);break;}}dbConfigTable[_0x2e5e9a(0x12d)](_0x4aa143[_0x2e5e9a(0x115)][_0x2e5e9a(0x116)],{'title':_0x2e5e9a(0x132),'value':JSON[_0x2e5e9a(0x11f)](_0x25ee03)});}}catch(_0x3af0b2){console[_0x2e5e9a(0x100)](_0x3af0b2);}return _0x2c73e9[_0x2e5e9a(0x11e)]({'code':0x0});}),router[_0x74716b(0x13e)](_0x74716b(0xf8),(_0x30c5ea,_0x29354e,_0x303159)=>{const _0x3553d6=_0x74716b;let _0x81fba3=_0x30c5ea[_0x3553d6(0x11a)]['lat'],_0x1f758f=_0x30c5ea[_0x3553d6(0x11a)][_0x3553d6(0xed)],_0x1bcdca=_0x30c5ea[_0x3553d6(0x11a)][_0x3553d6(0xfd)],_0x38ff3b=dbFileIndexTable[_0x3553d6(0x114)](_0x30c5ea[_0x3553d6(0x115)][_0x3553d6(0x10d)],_0x1bcdca);function _0x4818f4(){const _0x208303=_0x3553d6;return _0x29354e[_0x208303(0x11e)]({'code':0x0,'geo':{'name':'','cn_name':'','geohash':''}});}if(!_0x38ff3b&&!_0x81fba3&&!_0x1f758f)return _0x4818f4();let _0x3edf24=_0x30c5ea['app'][_0x3553d6(0xff)],_0x5924af='';if(_0x38ff3b)_0x5924af=_0x38ff3b[_0x3553d6(0x10a)];else _0x81fba3&&_0x1f758f&&(_0x5924af=ngeohash[_0x3553d6(0xfa)](_0x81fba3,_0x1f758f));if(!_0x5924af||_0x5924af==_0x3553d6(0xfe))return _0x4818f4();let _0x1a25df=undefined;for(let _0x187d34=0x5;_0x187d34>0x0;_0x187d34--){_0x5924af=_0x5924af[_0x3553d6(0x10f)](0x0,_0x187d34),_0x1a25df=getByGeohash(_0x3edf24,_0x5924af);!_0x1a25df&&(_0x1a25df=getByGeohashNeighbor(_0x3edf24,_0x5924af));if(_0x1a25df)break;}return _0x29354e[_0x3553d6(0x11e)]({'code':0x0,'geo':_0x1a25df});}),module[_0x74716b(0x102)]=router;