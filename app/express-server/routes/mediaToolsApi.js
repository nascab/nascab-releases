const _0x3191e4=_0x3bde;(function(_0x347f76,_0x306833){const _0x256493=_0x3bde,_0x58c2ba=_0x347f76();while(!![]){try{const _0xa14784=-parseInt(_0x256493(0xaf))/0x1*(parseInt(_0x256493(0xd5))/0x2)+-parseInt(_0x256493(0xd6))/0x3+-parseInt(_0x256493(0xc9))/0x4+parseInt(_0x256493(0xc1))/0x5+-parseInt(_0x256493(0xc7))/0x6+-parseInt(_0x256493(0x9b))/0x7*(parseInt(_0x256493(0xe6))/0x8)+parseInt(_0x256493(0xc8))/0x9*(parseInt(_0x256493(0x8e))/0xa);if(_0xa14784===_0x306833)break;else _0x58c2ba['push'](_0x58c2ba['shift']());}catch(_0x122f0b){_0x58c2ba['push'](_0x58c2ba['shift']());}}}(_0x20ab,0xc9b7e));var express=require('express'),router=express['Router']();function _0x20ab(){const _0x23430d=['../../myConfig/config','app','all-image.zip','sep','zip','basename','substring','finalize','private.exportNeedEmptyFolder','attachment;\x20filename*=UTF-8\x27\x27','16gSAgdn','headersSent','delete','log','test','returnErrMsg','end','14774370kZmKRU','taskData','PARAMS\x20ERROR','toUpperCase','catch','An\x20error\x20occurred\x20while\x20compressing\x20the\x20files.','decodePath','getById','getAll','proxy.isntVip','dbOther','close','MEDIA_ARRANGE','3047786JAChjt','stack','create','username','setHeader','minTimeStamp','../../db/dbMediaTools','body','zip\x20error','status','json','/deleteTask','parse','existsSync','getVipInfo','destroy','stat','TASK\x20TYPE\x20ERROR','targetPath','length','26683WswGom','imgZipTmpUpload','source_path','currentUser','An\x20error\x20occurred\x20while\x20reading\x20the\x20directory.','get','zip\x20finish','archiver','unpipe','sourcePath','replace','cannotUseRootPathAsBackupTarget','taskType','path','send','noGetFolderStat','push','query','4014250qxmoVt','startsWith','error','noWritePermission','Content-Disposition','exports','4127340dQNgRo','18jNvAeM','887844KnLuZf','then','join','includes','is_admin','append','dialog','deleteByType','readdir','constants','../utils/fileUtils','R_OK','62UzUQfa','970998EzjGgC','所有文件已处理完成','/createTask','post','message','isDirectory'];_0x20ab=function(){return _0x23430d;};return _0x20ab();}let path=require(_0x3191e4(0xbc)),fs=require('fs');const dbMediaTools=require(_0x3191e4(0xa1)),config=require(_0x3191e4(0xdc)),archiver=require(_0x3191e4(0xb6)),fileUtil=require(_0x3191e4(0xd3));let nasAccountUtil=require('../utils/nasAccountUtils'),allowTaskType=[_0x3191e4(0x9a),'VIDEO_TRANS'];router[_0x3191e4(0xd9)]('/getTaskList',(_0x1efb1f,_0x2380bc,_0x334a80)=>{const _0x1d1a31=_0x3191e4;if(_0x1efb1f[_0x1d1a31(0xb2)][_0x1d1a31(0xcd)]!=0x1)return _0x2380bc[_0x1d1a31(0xa5)]({'code':0x66});let _0x57f97f=_0x1efb1f[_0x1d1a31(0xa2)][_0x1d1a31(0xbb)];if(!_0x57f97f||!allowTaskType[_0x1d1a31(0xcc)](_0x57f97f))return _0x1efb1f[_0x1d1a31(0xdd)][_0x1d1a31(0x8c)](_0x2380bc,_0x1d1a31(0xac),_0x1d1a31(0xcf));let _0x262b5e=dbMediaTools['getTaskByType'](_0x1efb1f[_0x1d1a31(0xdd)][_0x1d1a31(0x98)],_0x57f97f,_0x1efb1f[_0x1d1a31(0xb2)]['id']);_0x2380bc[_0x1d1a31(0xa5)]({'code':0x0,'data':_0x262b5e});}),router['post'](_0x3191e4(0xd8),(_0x4fd470,_0x42ad1e,_0x11ab2b)=>{const _0x522676=_0x3191e4;if(_0x4fd470[_0x522676(0xb2)][_0x522676(0xcd)]!=0x1)return _0x42ad1e[_0x522676(0xa5)]({'code':0x66});let _0x1acda8=[];_0x4fd470[_0x522676(0xa2)][_0x522676(0xb8)]instanceof Array?_0x1acda8=_0x4fd470[_0x522676(0xa2)][_0x522676(0xb8)]:_0x1acda8[_0x522676(0xbf)](path[_0x522676(0xcb)](_0x4fd470[_0x522676(0xa2)][_0x522676(0xb8)]));let _0x3ec4d2=_0x4fd470[_0x522676(0xa2)][_0x522676(0xad)]?path[_0x522676(0xcb)](_0x4fd470[_0x522676(0xa2)][_0x522676(0xad)]):null,_0x1707af;try{_0x1707af=_0x4fd470[_0x522676(0xa2)][_0x522676(0x8f)]?JSON[_0x522676(0xa7)](_0x4fd470[_0x522676(0xa2)][_0x522676(0x8f)]):null;}catch(_0x2dc8a7){console[_0x522676(0xe9)](_0x2dc8a7),_0x1707af=null;}let _0x748b8b=_0x4fd470[_0x522676(0xa2)][_0x522676(0xbb)];if(/^\w\:\\$/[_0x522676(0x8b)](_0x3ec4d2))return _0x4fd470[_0x522676(0xdd)][_0x522676(0x8c)](_0x42ad1e,_0x42ad1e['__'](_0x522676(0xba)),_0x522676(0xcf));if(!_0x1acda8||!_0x3ec4d2||!_0x748b8b||!allowTaskType[_0x522676(0xcc)](_0x748b8b))return _0x4fd470[_0x522676(0xdd)][_0x522676(0x8c)](_0x42ad1e,'PARAMS\x20ERROR','dialog');if(_0x748b8b==_0x522676(0x9a)){if(_0x1acda8[_0x522676(0xae)]<0x1)return _0x4fd470[_0x522676(0xdd)]['returnErrMsg'](_0x42ad1e,_0x522676(0x90),'dialog');if(_0x1acda8[0x0]==_0x3ec4d2)return _0x4fd470[_0x522676(0xdd)][_0x522676(0x8c)](_0x42ad1e,_0x522676(0x90),_0x522676(0xcf));}nasAccountUtil[_0x522676(0xa9)](_0x4fd470[_0x522676(0xdd)][_0x522676(0x98)])[_0x522676(0xca)](_0x5709c6=>{const _0x34a026=_0x522676;if(!_0x5709c6)return _0x4fd470[_0x34a026(0xdd)][_0x34a026(0x8c)](_0x42ad1e,_0x42ad1e['__'](_0x34a026(0x97)),_0x34a026(0xcf));else _0x4232e4();})[_0x522676(0x92)](_0x2eb069=>{_0x4232e4();});function _0x4232e4(){const _0x2fa9ae=_0x522676;fs['access'](_0x3ec4d2,fs['constants']['W_OK']|fs[_0x2fa9ae(0xd2)][_0x2fa9ae(0xd4)],_0x27e846=>{const _0x225377=_0x2fa9ae;if(_0x27e846)return console['log'](_0x27e846),_0x4fd470[_0x225377(0xdd)][_0x225377(0x8c)](_0x42ad1e,_0x42ad1e['__'](_0x225377(0xc4))+':'+_0x3ec4d2);fs[_0x225377(0xab)](_0x3ec4d2,(_0x208878,_0x4bd573)=>{const _0x102168=_0x225377;if(_0x208878||!_0x4bd573[_0x102168(0xdb)]())return _0x4fd470['app'][_0x102168(0x8c)](_0x42ad1e,_0x42ad1e['__'](_0x102168(0xbe)));fs[_0x102168(0xd1)](_0x3ec4d2,(_0x967c6e,_0x490f09)=>{const _0x5439c1=_0x102168;if(_0x967c6e)return console['log'](_0x967c6e),_0x4fd470[_0x5439c1(0xdd)]['returnErrMsg'](_0x42ad1e,_0x42ad1e['__'](_0x5439c1(0xbe)));if(!fileUtil['folderIsEmpty'](_0x490f09))return _0x4fd470[_0x5439c1(0xdd)]['returnErrMsg'](_0x42ad1e,_0x42ad1e['__'](_0x5439c1(0xe4)));let _0xf5d8ed={'source_path':_0x1acda8,'target_path':_0x3ec4d2,'task_type':_0x748b8b};_0x748b8b==_0x5439c1(0x9a)&&(_0xf5d8ed[_0x5439c1(0xb1)]=_0x1acda8[0x0]);_0x1707af&&(_0xf5d8ed[_0x5439c1(0x8f)]=_0x1707af);let _0x560f1e=dbMediaTools[_0x5439c1(0x9d)](_0x4fd470[_0x5439c1(0xdd)][_0x5439c1(0x98)],_0x748b8b,_0xf5d8ed,_0x4fd470['currentUser']['id']),_0x1ac7cf=dbMediaTools[_0x5439c1(0x95)](_0x4fd470[_0x5439c1(0xdd)][_0x5439c1(0x98)],_0x560f1e['lastInsertRowid'],_0x4fd470[_0x5439c1(0xb2)]['id']);return process[_0x5439c1(0xbd)]({'type':_0x748b8b,'taskObj':_0x1ac7cf}),_0x42ad1e[_0x5439c1(0xa5)]({'code':0x0});});});});}}),router[_0x3191e4(0xd9)](_0x3191e4(0xa6),(_0x5f59b3,_0x4b4d08,_0x5d8ca6)=>{const _0x48ea4e=_0x3191e4;let _0x2e07d6=_0x5f59b3[_0x48ea4e(0xa2)]['id'],_0x33edf3=_0x5f59b3[_0x48ea4e(0xa2)]['taskType'];if(_0x2e07d6)dbMediaTools[_0x48ea4e(0xe8)](_0x5f59b3['app']['dbOther'],_0x2e07d6,_0x5f59b3[_0x48ea4e(0xb2)]['id']);else _0x33edf3&&dbMediaTools[_0x48ea4e(0xd0)](_0x5f59b3[_0x48ea4e(0xdd)][_0x48ea4e(0x98)],_0x33edf3,_0x5f59b3[_0x48ea4e(0xb2)]['id']);_0x4b4d08[_0x48ea4e(0xa5)]({'code':0x0});}),router[_0x3191e4(0xb4)]('/getToolsFile/*',(_0x30b3ee,_0x2f47cc,_0x16e2ec)=>{const _0x415e0c=_0x3191e4;let _0x5a5d5a=_0x30b3ee[_0x415e0c(0xc0)][_0x415e0c(0xa0)],_0x5f3031=_0x30b3ee[_0x415e0c(0xc0)][_0x415e0c(0x96)]=='1',_0x1cac3f=config['tempMediaToolsUpload'],_0x4b3d47=path['join'](_0x1cac3f,_0x30b3ee[_0x415e0c(0xb2)][_0x415e0c(0x9e)],path[_0x415e0c(0xdf)]);if(_0x5f3031)getImageCompressionZip(_0x2f47cc,_0x4b3d47,_0x5a5d5a);else{let _0x578abd=fileUtil[_0x415e0c(0x94)](_0x30b3ee[_0x415e0c(0xc0)][_0x415e0c(0xbc)]);if(_0x578abd&&_0x578abd[_0x415e0c(0xc2)](_0x4b3d47))try{if(!fs[_0x415e0c(0xa8)](_0x578abd))return _0x2f47cc[_0x415e0c(0xa4)](0x194)[_0x415e0c(0x8d)]();const _0x148adb=encodeURIComponent(path[_0x415e0c(0xe1)](_0x578abd))['replace'](/%([0-9A-F]{2})/g,(_0x5e94fd,_0x26eb68)=>'%'+_0x26eb68['toUpperCase']());return _0x2f47cc[_0x415e0c(0x9f)](_0x415e0c(0xc5),_0x415e0c(0xe5)+_0x148adb),_0x2f47cc['sendFile'](_0x578abd);}catch(_0x5b97bb){return console[_0x415e0c(0xe9)](_0x5b97bb),_0x2f47cc[_0x415e0c(0xa4)](0x194)[_0x415e0c(0x8d)]();}else{if(!fs['existsSync'](_0x578abd))return _0x2f47cc[_0x415e0c(0xa4)](0x194)['end']();}}});function getImageCompressionZip(_0x3828e5,_0x3dfca3,_0x40d2e9){const _0x337a05=_0x3191e4;let _0x19572c=_0x337a05(0xb0),_0x5ef9fc=path[_0x337a05(0xcb)](_0x3dfca3,_0x19572c),_0x2b6193=_0x337a05(0xde);try{const _0x10b47e=encodeURIComponent(_0x2b6193)[_0x337a05(0xb9)](/%([0-9A-F]{2})/g,(_0x23f803,_0x10dc30)=>'%'+_0x10dc30[_0x337a05(0x91)]());_0x3828e5['setHeader'](_0x337a05(0xc5),_0x337a05(0xe5)+_0x10b47e);}catch(_0x51aa06){console[_0x337a05(0xe9)](_0x51aa06);}const _0x34715d=archiver(_0x337a05(0xe0),{'zlib':{'level':0x0}});_0x34715d['on'](_0x337a05(0xc3),function(_0x47889c){const _0x313c2d=_0x337a05;console[_0x313c2d(0xe9)](_0x313c2d(0xa3),_0x47889c[_0x313c2d(0xda)]||_0x47889c[_0x313c2d(0x9c)]),_0x34715d[_0x313c2d(0xb7)](),!_0x3828e5[_0x313c2d(0xe7)]?(_0x3828e5['removeHeader'](_0x313c2d(0xc5)),_0x3828e5['status'](0x1f4)[_0x313c2d(0xbd)](_0x313c2d(0x93))):_0x3828e5[_0x313c2d(0xaa)]();}),_0x34715d['on'](_0x337a05(0x8d),function(){const _0x5f17cc=_0x337a05;console['log'](_0x5f17cc(0xb5)),_0x34715d['destroy']();});try{let _0xaa9c09=[];if(_0x40d2e9)_0x40d2e9=parseInt(_0x40d2e9);function _0x5de9de(_0x3238ea,_0x1e9afe){const _0x3c9b5b=_0x337a05;let _0x3f5405=0x0;function _0x4f3d8b(_0x4d87d0){_0x3f5405++,fs['stat'](_0x4d87d0,(_0x54699b,_0x196bfe)=>{const _0x454bb6=_0x3bde;if(_0x54699b)return _0xee856f();if(_0x196bfe[_0x454bb6(0xdb)]()){let _0x1a6b7d=path['basename'](_0x4d87d0);if(_0x1a6b7d[_0x454bb6(0xae)]==0xd){let _0x1adc7d=parseInt(_0x1a6b7d);if(_0x1adc7d<_0x40d2e9)return _0x4d87d0['startsWith'](config['tempMediaToolsUpload'])&&fs['rm'](_0x4d87d0,{'recursive':!![]},()=>{const _0x57a96a=_0x454bb6;console[_0x57a96a(0xe9)]('deleted\x20temp\x20file\x20:',_0x4d87d0);}),_0xee856f();}_0x5de9de(_0x4d87d0,()=>_0xee856f());}else{let _0x348cf2=path[_0x454bb6(0xe1)](_0x4d87d0);function _0x5d0f78(){const _0x56ac0a=_0x454bb6;let _0x58288a=_0x348cf2['lastIndexOf']('.'),_0x5107e3=_0x348cf2[_0x56ac0a(0xe2)](_0x58288a),_0x106392=_0x348cf2['substring'](0x0,_0x58288a),_0x47969e=_0x106392+_0x5107e3,_0x544fc0=0x1;while(_0xaa9c09[_0x56ac0a(0xcc)](_0x47969e)){_0x47969e=_0x106392+'('+_0x544fc0+')'+_0x5107e3,_0x544fc0++;}return _0x47969e;}_0x348cf2=_0x5d0f78(),_0x34715d[_0x454bb6(0xce)](fs['createReadStream'](_0x4d87d0),{'name':_0x348cf2}),_0xaa9c09[_0x454bb6(0xbf)](_0x348cf2),_0xee856f();}});}function _0xee856f(){_0x3f5405--;if(_0x3f5405===0x0)_0x1e9afe?.();}fs[_0x3c9b5b(0xd1)](_0x3238ea,(_0x1c4bd0,_0x3baaea)=>{const _0x4527ff=_0x3c9b5b;if(_0x1c4bd0)return _0xee856f();if(_0x3baaea[_0x4527ff(0xae)]===0x0)return _0x1e9afe?.();_0x3f5405++;for(let _0x3f76aa of _0x3baaea){try{_0x4f3d8b(path[_0x4527ff(0xcb)](_0x3238ea,_0x3f76aa));}catch(_0x4dcfba){continue;}}_0xee856f();});}_0x5de9de(_0x5ef9fc,()=>{const _0x54c422=_0x337a05;console[_0x54c422(0xe9)](_0x54c422(0xd7),_0xaa9c09),_0xaa9c09[_0x54c422(0xae)]>0x0?(_0x34715d[_0x54c422(0xe3)](),_0x34715d['pipe'](_0x3828e5)):_0x3828e5[_0x54c422(0xa4)](0x194)[_0x54c422(0x8d)]();});}catch(_0x472082){!_0x3828e5['headersSent']&&_0x3828e5[_0x337a05(0xa4)](0x1f4)[_0x337a05(0xbd)]({'error':_0x337a05(0xb3)}),console[_0x337a05(0xc3)](_0x472082);}_0x3828e5['on'](_0x337a05(0x99),()=>{const _0x27462f=_0x337a05;console[_0x27462f(0xe9)]('res\x20closed,destroy\x20zip\x20stream'),_0x34715d[_0x27462f(0xaa)]();});}function _0x3bde(_0x38b462,_0x119898){const _0x20ab15=_0x20ab();return _0x3bde=function(_0x3bde0e,_0x571834){_0x3bde0e=_0x3bde0e-0x8b;let _0x4b3b6c=_0x20ab15[_0x3bde0e];return _0x4b3b6c;},_0x3bde(_0x38b462,_0x119898);}module[_0x3191e4(0xc6)]=router;