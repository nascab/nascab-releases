const _0xe6d405=_0x4ff6;(function(_0x3d36c5,_0x356ba2){const _0x2119b8=_0x4ff6,_0x444251=_0x3d36c5();while(!![]){try{const _0x1377ca=-parseInt(_0x2119b8(0xab))/0x1+parseInt(_0x2119b8(0xa2))/0x2*(-parseInt(_0x2119b8(0xc8))/0x3)+-parseInt(_0x2119b8(0xf8))/0x4+-parseInt(_0x2119b8(0xcf))/0x5+parseInt(_0x2119b8(0xf3))/0x6+parseInt(_0x2119b8(0xb3))/0x7*(-parseInt(_0x2119b8(0xb5))/0x8)+parseInt(_0x2119b8(0xce))/0x9*(parseInt(_0x2119b8(0xdc))/0xa);if(_0x1377ca===_0x356ba2)break;else _0x444251['push'](_0x444251['shift']());}catch(_0x457fe4){_0x444251['push'](_0x444251['shift']());}}}(_0x1861,0x51e55));function _0x4ff6(_0x39eaec,_0x2c772e){const _0x186132=_0x1861();return _0x4ff6=function(_0x4ff6ad,_0x38674a){_0x4ff6ad=_0x4ff6ad-0x9b;let _0x119741=_0x186132[_0x4ff6ad];return _0x119741;},_0x4ff6(_0x39eaec,_0x2c772e);}function _0x1861(){const _0x293fbe=['所有文件已处理完成','status','An\x20error\x20occurred\x20while\x20compressing\x20the\x20files.','stat','basename','app','MEDIA_ARRANGE','518757YbRTEY','constants','includes','noGetFolderStat','R_OK','/createTask','1596879cAcWZf','1349365XlzWhk','end','lastIndexOf','currentUser','getTaskByType','substring','setHeader','readdir','headersSent','dialog','returnErrMsg','pipe','noWritePermission','120xFfrCq','/getTaskList','/getToolsFile/*','zip\x20finish','destroy','taskData','Content-Disposition','all-image.zip','join','getAll','lastInsertRowid','../utils/nasAccountUtils','../../myConfig/config','message','replace','taskType','createReadStream','length','log','error','get','exports','W_OK','2605260FhtECf','proxy.isntVip','removeHeader','existsSync','deleteByType','2655272yiPpWu','../utils/fileUtils','private.exportNeedEmptyFolder','archiver','res\x20closed,destroy\x20zip\x20stream','post','body','VIDEO_TRANS','dbOther','2KOOfTq','then','startsWith','tempMediaToolsUpload','sep','test','folderIsEmpty','sourcePath','zip\x20error','529124jfglgm','PARAMS\x20ERROR','send','query','username','is_admin','toUpperCase','imgZipTmpUpload','2149IEzBwp','path','15432aQvcGj','close','/deleteTask','zip','sendFile','isDirectory','Router','targetPath','cannotUseRootPathAsBackupTarget','getVipInfo','json','attachment;\x20filename*=UTF-8\x27\x27'];_0x1861=function(){return _0x293fbe;};return _0x1861();}var express=require('express'),router=express[_0xe6d405(0xbb)]();let path=require(_0xe6d405(0xb4)),fs=require('fs');const dbMediaTools=require('../../db/dbMediaTools'),config=require(_0xe6d405(0xe8)),archiver=require(_0xe6d405(0x9c)),fileUtil=require(_0xe6d405(0xf9));let nasAccountUtil=require(_0xe6d405(0xe7)),allowTaskType=[_0xe6d405(0xc7),_0xe6d405(0xa0)];router['post'](_0xe6d405(0xdd),(_0x126005,_0x13e0e5,_0x1946d3)=>{const _0x550fee=_0xe6d405;if(_0x126005[_0x550fee(0xd2)][_0x550fee(0xb0)]!=0x1)return _0x13e0e5[_0x550fee(0xbf)]({'code':0x66});let _0x38f83c=_0x126005[_0x550fee(0x9f)][_0x550fee(0xeb)];if(!_0x38f83c||!allowTaskType['includes'](_0x38f83c))return _0x126005['app'][_0x550fee(0xd9)](_0x13e0e5,'TASK\x20TYPE\x20ERROR','dialog');let _0x576188=dbMediaTools[_0x550fee(0xd3)](_0x126005[_0x550fee(0xc6)][_0x550fee(0xa1)],_0x38f83c,_0x126005[_0x550fee(0xd2)]['id']);_0x13e0e5[_0x550fee(0xbf)]({'code':0x0,'data':_0x576188});}),router[_0xe6d405(0x9e)](_0xe6d405(0xcd),(_0x1512f2,_0x2adc1d,_0x1eccfe)=>{const _0x2b0548=_0xe6d405;if(_0x1512f2['currentUser'][_0x2b0548(0xb0)]!=0x1)return _0x2adc1d[_0x2b0548(0xbf)]({'code':0x66});let _0x181ed3=[];_0x1512f2[_0x2b0548(0x9f)][_0x2b0548(0xa9)]instanceof Array?_0x181ed3=_0x1512f2[_0x2b0548(0x9f)]['sourcePath']:_0x181ed3['push'](path[_0x2b0548(0xe4)](_0x1512f2[_0x2b0548(0x9f)][_0x2b0548(0xa9)]));let _0x3a8251=_0x1512f2['body'][_0x2b0548(0xbc)]?path[_0x2b0548(0xe4)](_0x1512f2[_0x2b0548(0x9f)]['targetPath']):null,_0x80671;try{_0x80671=_0x1512f2[_0x2b0548(0x9f)]['taskData']?JSON['parse'](_0x1512f2[_0x2b0548(0x9f)][_0x2b0548(0xe1)]):null;}catch(_0x3f389d){console['log'](_0x3f389d),_0x80671=null;}let _0x50f869=_0x1512f2[_0x2b0548(0x9f)][_0x2b0548(0xeb)];if(/^\w\:\\$/[_0x2b0548(0xa7)](_0x3a8251))return _0x1512f2[_0x2b0548(0xc6)]['returnErrMsg'](_0x2adc1d,_0x2adc1d['__'](_0x2b0548(0xbd)),_0x2b0548(0xd8));if(!_0x181ed3||!_0x3a8251||!_0x50f869||!allowTaskType['includes'](_0x50f869))return _0x1512f2[_0x2b0548(0xc6)][_0x2b0548(0xd9)](_0x2adc1d,_0x2b0548(0xac),'dialog');if(_0x50f869=='MEDIA_ARRANGE'){if(_0x181ed3['length']<0x1)return _0x1512f2[_0x2b0548(0xc6)][_0x2b0548(0xd9)](_0x2adc1d,'PARAMS\x20ERROR',_0x2b0548(0xd8));if(_0x181ed3[0x0]==_0x3a8251)return _0x1512f2[_0x2b0548(0xc6)][_0x2b0548(0xd9)](_0x2adc1d,_0x2b0548(0xac),_0x2b0548(0xd8));}nasAccountUtil[_0x2b0548(0xbe)](_0x1512f2[_0x2b0548(0xc6)][_0x2b0548(0xa1)])[_0x2b0548(0xa3)](_0x2ab5f2=>{const _0x99ac5b=_0x2b0548;if(!_0x2ab5f2)return _0x1512f2[_0x99ac5b(0xc6)]['returnErrMsg'](_0x2adc1d,_0x2adc1d['__'](_0x99ac5b(0xf4)),_0x99ac5b(0xd8));else _0x5d4fdd();})['catch'](_0x280647=>{_0x5d4fdd();});function _0x5d4fdd(){const _0x17bfa5=_0x2b0548;fs['access'](_0x3a8251,fs[_0x17bfa5(0xc9)][_0x17bfa5(0xf2)]|fs['constants'][_0x17bfa5(0xcc)],_0x3a0a7e=>{const _0x16fec7=_0x17bfa5;if(_0x3a0a7e)return console[_0x16fec7(0xee)](_0x3a0a7e),_0x1512f2[_0x16fec7(0xc6)][_0x16fec7(0xd9)](_0x2adc1d,_0x2adc1d['__'](_0x16fec7(0xdb))+':'+_0x3a8251);fs['stat'](_0x3a8251,(_0x3bb668,_0x58f450)=>{const _0x26d9d7=_0x16fec7;if(_0x3bb668||!_0x58f450[_0x26d9d7(0xba)]())return _0x1512f2['app'][_0x26d9d7(0xd9)](_0x2adc1d,_0x2adc1d['__'](_0x26d9d7(0xcb)));fs[_0x26d9d7(0xd6)](_0x3a8251,(_0x3fe131,_0x2af575)=>{const _0x356cf7=_0x26d9d7;if(_0x3fe131)return console[_0x356cf7(0xee)](_0x3fe131),_0x1512f2[_0x356cf7(0xc6)]['returnErrMsg'](_0x2adc1d,_0x2adc1d['__'](_0x356cf7(0xcb)));if(!fileUtil[_0x356cf7(0xa8)](_0x2af575))return _0x1512f2[_0x356cf7(0xc6)][_0x356cf7(0xd9)](_0x2adc1d,_0x2adc1d['__'](_0x356cf7(0x9b)));let _0x4754e9={'source_path':_0x181ed3,'target_path':_0x3a8251,'task_type':_0x50f869};_0x50f869==_0x356cf7(0xc7)&&(_0x4754e9['source_path']=_0x181ed3[0x0]);_0x80671&&(_0x4754e9[_0x356cf7(0xe1)]=_0x80671);let _0x5259a4=dbMediaTools['create'](_0x1512f2[_0x356cf7(0xc6)][_0x356cf7(0xa1)],_0x50f869,_0x4754e9,_0x1512f2['currentUser']['id']),_0x39e3c3=dbMediaTools['getById'](_0x1512f2[_0x356cf7(0xc6)][_0x356cf7(0xa1)],_0x5259a4[_0x356cf7(0xe6)],_0x1512f2[_0x356cf7(0xd2)]['id']);return process['send']({'type':_0x50f869,'taskObj':_0x39e3c3}),_0x2adc1d[_0x356cf7(0xbf)]({'code':0x0});});});});}}),router[_0xe6d405(0x9e)](_0xe6d405(0xb7),(_0x416cb5,_0x1cbbb1,_0x4ef3bf)=>{const _0x3342c7=_0xe6d405;let _0x380f31=_0x416cb5[_0x3342c7(0x9f)]['id'],_0x2d6f07=_0x416cb5[_0x3342c7(0x9f)][_0x3342c7(0xeb)];if(_0x380f31)dbMediaTools['delete'](_0x416cb5[_0x3342c7(0xc6)][_0x3342c7(0xa1)],_0x380f31,_0x416cb5[_0x3342c7(0xd2)]['id']);else _0x2d6f07&&dbMediaTools[_0x3342c7(0xf7)](_0x416cb5[_0x3342c7(0xc6)][_0x3342c7(0xa1)],_0x2d6f07,_0x416cb5[_0x3342c7(0xd2)]['id']);_0x1cbbb1['json']({'code':0x0});}),router[_0xe6d405(0xf0)](_0xe6d405(0xde),(_0x593d40,_0x1a9ff0,_0x4e5e21)=>{const _0x4926ea=_0xe6d405;let _0x505415=_0x593d40[_0x4926ea(0xae)]['minTimeStamp'],_0xd815a2=_0x593d40[_0x4926ea(0xae)][_0x4926ea(0xe5)]=='1',_0x3cdd71=config[_0x4926ea(0xa5)],_0x214dfe=path['join'](_0x3cdd71,_0x593d40[_0x4926ea(0xd2)][_0x4926ea(0xaf)],path[_0x4926ea(0xa6)]);if(_0xd815a2)getImageCompressionZip(_0x1a9ff0,_0x214dfe,_0x505415);else{let _0x492dd6=fileUtil['decodePath'](_0x593d40['query'][_0x4926ea(0xb4)]);if(_0x492dd6&&_0x492dd6['startsWith'](_0x214dfe))try{if(!fs[_0x4926ea(0xf6)](_0x492dd6))return _0x1a9ff0[_0x4926ea(0xc2)](0x194)[_0x4926ea(0xd0)]();const _0xd081b8=encodeURIComponent(path[_0x4926ea(0xc5)](_0x492dd6))[_0x4926ea(0xea)](/%([0-9A-F]{2})/g,(_0x389291,_0x1e0746)=>'%'+_0x1e0746[_0x4926ea(0xb1)]());return _0x1a9ff0['setHeader'](_0x4926ea(0xe2),_0x4926ea(0xc0)+_0xd081b8),_0x1a9ff0[_0x4926ea(0xb9)](_0x492dd6);}catch(_0x38dff4){return console[_0x4926ea(0xee)](_0x38dff4),_0x1a9ff0[_0x4926ea(0xc2)](0x194)[_0x4926ea(0xd0)]();}else{if(!fs[_0x4926ea(0xf6)](_0x492dd6))return _0x1a9ff0[_0x4926ea(0xc2)](0x194)[_0x4926ea(0xd0)]();}}});function getImageCompressionZip(_0x304784,_0x3ac8fb,_0xf64cd7){const _0x4fa3da=_0xe6d405;let _0x453006=_0x4fa3da(0xb2),_0x2a46a2=path[_0x4fa3da(0xe4)](_0x3ac8fb,_0x453006),_0x43c5bf=_0x4fa3da(0xe3);try{const _0x23565c=encodeURIComponent(_0x43c5bf)['replace'](/%([0-9A-F]{2})/g,(_0xad2903,_0x577beb)=>'%'+_0x577beb[_0x4fa3da(0xb1)]());_0x304784[_0x4fa3da(0xd5)]('Content-Disposition',_0x4fa3da(0xc0)+_0x23565c);}catch(_0x5dcab7){console[_0x4fa3da(0xee)](_0x5dcab7);}const _0x1af09c=archiver(_0x4fa3da(0xb8),{'zlib':{'level':0x0}});_0x1af09c['on'](_0x4fa3da(0xef),function(_0xc1d5bc){const _0x29c7ec=_0x4fa3da;console['log'](_0x29c7ec(0xaa),_0xc1d5bc[_0x29c7ec(0xe9)]||_0xc1d5bc['stack']),_0x1af09c['unpipe'](),!_0x304784[_0x29c7ec(0xd7)]?(_0x304784[_0x29c7ec(0xf5)](_0x29c7ec(0xe2)),_0x304784[_0x29c7ec(0xc2)](0x1f4)[_0x29c7ec(0xad)](_0x29c7ec(0xc3))):_0x304784[_0x29c7ec(0xe0)]();}),_0x1af09c['on']('end',function(){const _0x1f0d92=_0x4fa3da;console[_0x1f0d92(0xee)](_0x1f0d92(0xdf)),_0x1af09c[_0x1f0d92(0xe0)]();});try{let _0x1b3b48=[];if(_0xf64cd7)_0xf64cd7=parseInt(_0xf64cd7);function _0x439d59(_0x46268a,_0x11e71f){let _0x3ec296=0x0;function _0x391985(_0x24bee4){const _0x55ab0b=_0x4ff6;_0x3ec296++,fs[_0x55ab0b(0xc4)](_0x24bee4,(_0x477534,_0x68104d)=>{const _0x4fcdf4=_0x55ab0b;if(_0x477534)return _0x5deccc();if(_0x68104d[_0x4fcdf4(0xba)]()){let _0x525f55=path[_0x4fcdf4(0xc5)](_0x24bee4);if(_0x525f55[_0x4fcdf4(0xed)]==0xd){let _0x2a6614=parseInt(_0x525f55);if(_0x2a6614<_0xf64cd7)return _0x24bee4[_0x4fcdf4(0xa4)](config['tempMediaToolsUpload'])&&fs['rm'](_0x24bee4,{'recursive':!![]},()=>{const _0x2807ed=_0x4fcdf4;console[_0x2807ed(0xee)]('deleted\x20temp\x20file\x20:',_0x24bee4);}),_0x5deccc();}_0x439d59(_0x24bee4,()=>_0x5deccc());}else{let _0x5a228d=path['basename'](_0x24bee4);function _0x14e8fe(){const _0x32f7ad=_0x4fcdf4;let _0x30e8e8=_0x5a228d[_0x32f7ad(0xd1)]('.'),_0x375f03=_0x5a228d['substring'](_0x30e8e8),_0x71fa1=_0x5a228d[_0x32f7ad(0xd4)](0x0,_0x30e8e8),_0x185742=_0x71fa1+_0x375f03,_0x582ca0=0x1;while(_0x1b3b48[_0x32f7ad(0xca)](_0x185742)){_0x185742=_0x71fa1+'('+_0x582ca0+')'+_0x375f03,_0x582ca0++;}return _0x185742;}_0x5a228d=_0x14e8fe(),_0x1af09c['append'](fs[_0x4fcdf4(0xec)](_0x24bee4),{'name':_0x5a228d}),_0x1b3b48['push'](_0x5a228d),_0x5deccc();}});}function _0x5deccc(){_0x3ec296--;if(_0x3ec296===0x0)_0x11e71f?.();}fs['readdir'](_0x46268a,(_0x3589e3,_0x1521a4)=>{const _0x2c5ab7=_0x4ff6;if(_0x3589e3)return _0x5deccc();if(_0x1521a4[_0x2c5ab7(0xed)]===0x0)return _0x11e71f?.();_0x3ec296++;for(let _0x11de2a of _0x1521a4){try{_0x391985(path[_0x2c5ab7(0xe4)](_0x46268a,_0x11de2a));}catch(_0xeb145d){continue;}}_0x5deccc();});}_0x439d59(_0x2a46a2,()=>{const _0x52628e=_0x4fa3da;console[_0x52628e(0xee)](_0x52628e(0xc1),_0x1b3b48),_0x1b3b48[_0x52628e(0xed)]>0x0?(_0x1af09c['finalize'](),_0x1af09c[_0x52628e(0xda)](_0x304784)):_0x304784[_0x52628e(0xc2)](0x194)[_0x52628e(0xd0)]();});}catch(_0x34e0ac){!_0x304784[_0x4fa3da(0xd7)]&&_0x304784[_0x4fa3da(0xc2)](0x1f4)[_0x4fa3da(0xad)]({'error':'An\x20error\x20occurred\x20while\x20reading\x20the\x20directory.'}),console[_0x4fa3da(0xef)](_0x34e0ac);}_0x304784['on'](_0x4fa3da(0xb6),()=>{const _0x4263c9=_0x4fa3da;console['log'](_0x4263c9(0x9d)),_0x1af09c[_0x4263c9(0xe0)]();});}module[_0xe6d405(0xf1)]=router;