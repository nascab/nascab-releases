const _0x25d6f6=_0x2bb1;(function(_0x33ee90,_0x54e42a){const _0x55a5fc=_0x2bb1,_0x212ff9=_0x33ee90();while(!![]){try{const _0x5cf34c=parseInt(_0x55a5fc(0xdd))/0x1*(parseInt(_0x55a5fc(0x134))/0x2)+parseInt(_0x55a5fc(0xeb))/0x3*(-parseInt(_0x55a5fc(0x116))/0x4)+-parseInt(_0x55a5fc(0xe1))/0x5*(-parseInt(_0x55a5fc(0x11c))/0x6)+-parseInt(_0x55a5fc(0x126))/0x7*(parseInt(_0x55a5fc(0x10c))/0x8)+parseInt(_0x55a5fc(0xf0))/0x9+parseInt(_0x55a5fc(0xab))/0xa*(-parseInt(_0x55a5fc(0xe8))/0xb)+-parseInt(_0x55a5fc(0x98))/0xc;if(_0x5cf34c===_0x54e42a)break;else _0x212ff9['push'](_0x212ff9['shift']());}catch(_0x114e57){_0x212ff9['push'](_0x212ff9['shift']());}}}(_0x4594,0xb0a6b));let express=require(_0x25d6f6(0xe0)),router=express[_0x25d6f6(0xe5)](),path=require(_0x25d6f6(0xaa)),fs=require('fs'),transCodeUtil=require('../../utils/transCodeUtil'),fileUtil=require('../utils/fileUtils');const config=require(_0x25d6f6(0xb3));function _0x4594(){const _0x3e318d=['indexId','size','waiting','seek','/subtitle*','&burn=','send','join','../utils/cryptoUtils','index\x20does\x20not\x20exist','filename','438hUdVtV','字幕文件存在缓存','spaceToken','attachment;\x20filename=','setHeader','noVideo','lastIndexOf','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','run','addOption','webvtt','kill','6579960RCTZFH','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','log','input','&filePath=','floor','m3u8TmpPath','application/octet-stream','stream','json','constants','space_id','&spaceId=','&seq=','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','decodePath','audioIndex','format','path','110rTUZvE','error','message','mp4','burn','decoderCommand','seq','M3u8Transcode','../../myConfig/config','../../utils/videoStreamUtil','spaceIndexId','cannotReadFile','start','../../db/dbConfigTable','indexOf','events','.ts?playId=','replace','-sub_charenc\x20','killed','readFile','then','subtitleIndex','returnErrMsg','value','\x0a#EXT-X-ENDLIST\x0a','stat','body','streams','access','serverType','sendStatus','-movflags\x20frag_keyframe+empty_moov','endsWith','decryptFileGetStream','dbFileIndex','status','../../db/dbPrivateSpaceTable','get','defaultMaxListeners','&audioIndex=','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','stringify','R_OK','&serverType=','confidence','filePath','&videobit=','close','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','1483tcKkQz','all','Content-type','express','321695YyVbfI','aac','detect','noAudio','Router','.0,\x0astream','&size=','250833hnwAfO','stop','sendFile','102057GIbduo','encoding','../../libs/nasTrans','EventEmitter','need\x20play\x20id','12341790cDizub','getIndexTableNameByType','getById','app','outputFormat','startsWith','&indexId=','sep','&subtitleIndex=','parseVideoFullPath','prepare','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?','gen',',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET=','../../db/dbUserTable','&spaceToken=','output','moviePreferLanguage','&token=','end','-map\x200:a:','catch','faidLoadSubtitle','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','extname','duration','pipe','dbOther','568iTFtyK','/play*','seekInput','doUserCanGet','power_get','playId','spaceId','substring','encoderName','noContent','28HIvSfP','index\x20no\x20permission','-map\x200:v:0?','/getVideoInfoByPath','.ts','ts_name','42IZNWSR','m3u8segmentDuration','query','videobit','dealFFmpegPath','chi','.m3u8','outputOptions','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','subtitleFile','38017tvvBWO','getDurationFromStream','UTF-'];_0x4594=function(){return _0x3e318d;};return _0x4594();}let videoStreamUtil=require(_0x25d6f6(0xb4)),FFmpeg=require(_0x25d6f6(0xed))['FFmpeg'],cryptoUtils=require(_0x25d6f6(0x131)),sha256=require('sha256');function _0x2bb1(_0x3f8977,_0x4b335f){const _0x459410=_0x4594();return _0x2bb1=function(_0x2bb1e0,_0x2034f6){_0x2bb1e0=_0x2bb1e0-0x95;let _0x159b3e=_0x459410[_0x2bb1e0];return _0x159b3e;},_0x2bb1(_0x3f8977,_0x4b335f);}require(_0x25d6f6(0xba))[_0x25d6f6(0xee)][_0x25d6f6(0xd2)]=0x0;const dbUserTable=require(_0x25d6f6(0xfe)),dbFileIndexTable=require('../../db/dbFileIndexTable'),dbConfigTable=require(_0x25d6f6(0xb8)),dbPrivateSpaceTable=require(_0x25d6f6(0xd0));var jschardet=require('jschardet');function MP4FfmpegTrans(_0x19706b,_0x337f28,_0x191d5f,_0x1a92ed,_0x4ea9cd,_0x267275){const _0x4f5721=_0x25d6f6;let _0x20561f=_0x19706b[_0x4f5721(0x11e)],_0xb8a4d1=FFmpeg(),_0x206a6c;if(_0x4ea9cd)_0x206a6c=cryptoUtils[_0x4f5721(0xcd)](_0x267275,_0x191d5f);let _0x42603c=_0x4ea9cd?_0x206a6c:_0x191d5f,{videoStream:_0x4c41df,videoWidth:_0x315dc9,videoHeight:_0x6d94d3}=transCodeUtil['parseStreamList'](_0x1a92ed);_0xb8a4d1['input'](transCodeUtil['dealFFmpegPath'](_0x42603c));try{_0xb8a4d1['on']('start',function(_0x48a086){const _0x5ecb7e=_0x4f5721;console[_0x5ecb7e(0x9a)](_0x48a086);}),_0xb8a4d1['on'](_0x4f5721(0xac),function(_0x4f6508){const _0x2136a4=_0x4f5721;if(_0x4f6508['message']&&_0x4f6508[_0x2136a4(0xad)][_0x2136a4(0xb9)](_0x2136a4(0xbe))==-0x1)_0xb8a4d1['kill'](),_0xb8a4d1=null,_0x337f28[_0x2136a4(0xcf)](0x1f4)[_0x2136a4(0x103)]();else{}}),_0xb8a4d1['on']('end',function(_0xd6bfad){const _0x12a2ff=_0x4f5721;_0xb8a4d1&&(_0xb8a4d1[_0x12a2ff(0x97)](),_0xb8a4d1=null);if(_0x337f28)_0x337f28[_0x12a2ff(0xcf)](0xc8)[_0x12a2ff(0x103)]();}),_0x337f28['on'](_0x4f5721(0xdb),function(){});let _0x5aa5cb=transCodeUtil['getCoderConfig'](_0x19706b['app']['dbOther'],_0x4c41df);_0x5aa5cb[_0x4f5721(0xb0)]&&_0xb8a4d1['addInputOption'](_0x5aa5cb[_0x4f5721(0xb0)]);let _0x33f857=_0x20561f[_0x4f5721(0xb1)]*config[_0x4f5721(0x11d)];_0x33f857&&!_0x4ea9cd&&_0xb8a4d1[_0x4f5721(0x10e)](''+parseInt(_0x33f857));_0x5aa5cb[_0x4f5721(0x114)]&&_0xb8a4d1['videoCodec'](_0x5aa5cb[_0x4f5721(0x114)]);let _0x35fae5=transCodeUtil['getVideoBitrate'](_0x4c41df,_0x20561f[_0x4f5721(0x11f)]);!_0x35fae5&&(_0x35fae5=0x1800),_0xb8a4d1['videoBitrate'](''+_0x35fae5),_0xb8a4d1[_0x4f5721(0x95)](_0x4f5721(0x118)),_0xb8a4d1[_0x4f5721(0x95)](_0x4f5721(0x104)+(_0x20561f[_0x4f5721(0xa8)]?_0x20561f[_0x4f5721(0xa8)]:0x0)+'?'),_0xb8a4d1[_0x4f5721(0xf4)]('mp4'),_0xb8a4d1['audioCodec'](_0x4f5721(0xe2)),_0xb8a4d1[_0x4f5721(0x123)]([_0x4f5721(0xcb)]),_0xb8a4d1['outputFormat']('mp4'),_0xb8a4d1[_0x4f5721(0x10a)](_0x337f28,{'end':!![]});}catch(_0x285edd){console[_0x4f5721(0x9a)](_0x285edd),_0xb8a4d1[_0x4f5721(0x97)](),_0x337f28[_0x4f5721(0xca)](0x1f4);}}router[_0x25d6f6(0xde)]('/stopPlay',(_0x78332e,_0xe4667,_0x455ce0)=>{const _0x53d4a0=_0x25d6f6;let _0x2065bb=_0x78332e[_0x53d4a0(0x11e)][_0x53d4a0(0x111)]||_0x78332e[_0x53d4a0(0xc6)][_0x53d4a0(0x111)];process[_0x53d4a0(0x12f)]({'type':_0x53d4a0(0xb2),'playId':_0x2065bb,'action':_0x53d4a0(0xe9)});let _0x5abb92=path['join'](config['m3u8TmpPath'],_0x2065bb);return fs['rm'](_0x5abb92,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x30b47b=>{const _0x4af793=_0x53d4a0;if(_0x30b47b)console[_0x4af793(0x9a)](_0x30b47b);}),_0x78332e[_0x53d4a0(0xf3)][_0x53d4a0(0x10b)][_0x53d4a0(0xfa)](_0x53d4a0(0x124))['run'](_0x78332e[_0x53d4a0(0x11e)][_0x53d4a0(0x111)]),_0xe4667['json']({'code':0x0});}),router[_0x25d6f6(0xd1)](_0x25d6f6(0x12d),(_0x704dca,_0x5af720,_0x4e7242)=>{const _0x2e423b=_0x25d6f6;let _0x372348=_0x704dca['query'],_0x5b09fe=_0x372348['subtitleIndex'],_0x5936ec=_0x372348[_0x2e423b(0x125)];if(_0x5936ec&&_0x5936ec['length']>0x2){let _0x5b65d1=fileUtil[_0x2e423b(0xa7)](_0x5936ec);fs[_0x2e423b(0xc8)](_0x5b65d1,fs[_0x2e423b(0xa2)][_0x2e423b(0xd6)],_0x3c9522=>{const _0x1fabf6=_0x2e423b;if(_0x3c9522)return _0x704dca[_0x1fabf6(0xf3)]['returnErrMsg'](_0x5af720,_0x5af720['__'](_0x1fabf6(0xb6)));path[_0x1fabf6(0x108)](_0x5b65d1)=='.vtt'&&_0x5af720[_0x1fabf6(0xea)](_0x5b65d1),fs[_0x1fabf6(0xbf)](_0x5b65d1,(_0x4ff720,_0x26111c)=>{const _0x50dd58=_0x1fabf6;if(_0x4ff720)return _0x704dca[_0x50dd58(0xf3)][_0x50dd58(0xc2)](_0x5af720,_0x5af720['__']('cannotReadFile'));try{let _0x3ee9b9=jschardet[_0x50dd58(0xe3)](_0x26111c);!_0x3ee9b9[_0x50dd58(0xec)][_0x50dd58(0xf5)](_0x50dd58(0x128))&&_0x3ee9b9[_0x50dd58(0xd8)]>0.95?_0x257091(_0x3ee9b9[_0x50dd58(0xec)]):_0x257091();}catch(_0x582718){console[_0x50dd58(0x9a)](_0x582718),_0x257091();}function _0x257091(_0x569026){const _0x2b6734=_0x50dd58;let _0x58fc93=FFmpeg();_0x58fc93[_0x2b6734(0x9b)](transCodeUtil[_0x2b6734(0x120)](_0x5b65d1))[_0x2b6734(0xe4)]()[_0x2b6734(0x139)]()[_0x2b6734(0xa9)](_0x2b6734(0x96)),_0x569026&&_0x58fc93['inputOption'](_0x2b6734(0xbd)+_0x569026),_0x58fc93['on'](_0x2b6734(0xb7),function(_0x41ead1){const _0x4ec51d=_0x2b6734;console[_0x4ec51d(0x9a)](_0x41ead1);})['on']('error',function(_0x2b9bef){_0x58fc93['kill']();})['on'](_0x2b6734(0x103),function(){const _0x9293ee=_0x2b6734;_0x58fc93[_0x9293ee(0x97)]();})[_0x2b6734(0x10a)](_0x5af720);}});});}else{let _0x3ef641=_0x372348['stype'];transCodeUtil[_0x2e423b(0xf9)](_0x704dca[_0x2e423b(0xf3)][_0x2e423b(0xce)],_0x704dca[_0x2e423b(0xf3)][_0x2e423b(0x10b)],_0x372348)[_0x2e423b(0xc0)](_0x276dcc=>{const _0x12349f=_0x2e423b;let {fullpath:_0x6253cf,needDecrypt:_0x17bc6e,pwd:_0x5dd4b2,streamList:_0x526076}=_0x276dcc;fs[_0x12349f(0xc8)](_0x6253cf,fs[_0x12349f(0xa2)][_0x12349f(0xd6)],_0x40ccf4=>{const _0x378cd2=_0x12349f;if(_0x40ccf4)return _0x704dca[_0x378cd2(0xf3)][_0x378cd2(0xc2)](_0x5af720,_0x5af720['__'](_0x378cd2(0xb6)));if(!_0x3ef641)_0x3ef641='vtt';let _0x15c65b=path[_0x378cd2(0x130)](config['subtitlePath'],sha256(_0x6253cf+_0x5b09fe)+'.'+_0x3ef641);fs[_0x378cd2(0xc5)](_0x15c65b,(_0x30461d,_0x4cb6cf)=>{const _0x460c0e=_0x378cd2;if(_0x30461d||_0x4cb6cf[_0x460c0e(0x12a)]<0x3e8){console[_0x460c0e(0x9a)]('生成字幕文件',_0x15c65b);let _0x5c8380=_0x17bc6e?cryptoUtils['decryptFileGetStream'](_0x5dd4b2,_0x6253cf):_0x6253cf,_0x52b258=FFmpeg({'timeout':0x258});_0x52b258[_0x460c0e(0x9b)](transCodeUtil[_0x460c0e(0x120)](_0x5c8380))[_0x460c0e(0xe4)]()[_0x460c0e(0x139)]()[_0x460c0e(0x123)](['-map\x200:s:'+_0x5b09fe])[_0x460c0e(0x100)](_0x15c65b)['on'](_0x460c0e(0xb7),function(_0x4cf25c){console['log'](_0x4cf25c);})['on'](_0x460c0e(0xac),function(_0x3afed7){const _0x3084e1=_0x460c0e;console[_0x3084e1(0x9a)](_0x3afed7),_0x52b258[_0x3084e1(0x97)](),fs['rm'](_0x15c65b,_0x5a731e=>{}),_0x704dca[_0x3084e1(0xf3)][_0x3084e1(0xc2)](_0x5af720,_0x5af720['__'](_0x3084e1(0x106)));})['on'](_0x460c0e(0x103),function(){const _0xd608c=_0x460c0e;return _0x52b258['kill'](),_0x372348[_0xd608c(0x115)]?_0x5af720[_0xd608c(0xa1)]({'code':0x0}):_0x5af720[_0xd608c(0xea)](_0x15c65b);}),_0x52b258[_0x460c0e(0x13c)](),_0x5af720['on'](_0x460c0e(0xdb),function(){_0x52b258['kill']();});}else{console[_0x460c0e(0x9a)](_0x460c0e(0x135),_0x15c65b);if(_0x372348[_0x460c0e(0x115)])return _0x5af720[_0x460c0e(0xa1)]({'code':0x0});return _0x5af720[_0x460c0e(0xea)](_0x15c65b);}});});})[_0x2e423b(0x105)](_0x1f7d26=>{const _0x430086=_0x2e423b;console[_0x430086(0x9a)](_0x1f7d26),_0x704dca[_0x430086(0xf3)]['returnErrMsg'](_0x5af720,_0x1f7d26);});}});function sendTsFile(_0x10b47f,_0x7053f0,_0x1ca5a2,_0x38eb17,_0x3366c4,_0x77d0f4=0x1){const _0x35509e=_0x25d6f6;if(_0x77d0f4>0x28)return;let _0x1e452b=_0x1ca5a2[_0x35509e(0x111)];if(!_0x1e452b)return;let _0x58b109=_0x10b47f[_0x35509e(0xf3)][_0x35509e(0x10b)][_0x35509e(0xfa)]('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC')['get'](_0x1e452b,_0x3366c4,'gen');if(_0x58b109)fs[_0x35509e(0xc5)](_0x38eb17,(_0x19b14d,_0x5f1b98)=>{const _0x597f91=_0x35509e;_0x19b14d?(_0x10b47f[_0x597f91(0xf3)][_0x597f91(0x10b)][_0x597f91(0xfa)]('DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?')[_0x597f91(0x13c)](_0x1e452b,_0x3366c4),sendTsFile(_0x10b47f,_0x7053f0,_0x1ca5a2,_0x38eb17,_0x3366c4,_0x77d0f4+0x1)):(_0x10b47f[_0x597f91(0xf3)][_0x597f91(0x10b)][_0x597f91(0xfa)](_0x597f91(0x13b))['run'](_0x1e452b),_0x7053f0['sendFile'](_0x38eb17));});else{function _0x44f124(){const _0x2d85a5=_0x35509e;let _0x39a486=setTimeout(()=>{clearTimeout(_0x39a486),sendTsFile(_0x10b47f,_0x7053f0,_0x1ca5a2,_0x38eb17,_0x3366c4,_0x77d0f4+0x1);},0x1f4);_0x7053f0['on'](_0x2d85a5(0xdb),()=>clearTimeout(_0x39a486));}let _0x4ba3e5=_0x10b47f['app'][_0x35509e(0x10b)][_0x35509e(0xfa)](_0x35509e(0x99))[_0x35509e(0xd1)](_0x1e452b,_0x35509e(0xfc));if(!_0x4ba3e5)return _0x44f124();else{let _0x1e18b7=_0x10b47f[_0x35509e(0xf3)]['dbOther'][_0x35509e(0xfa)](_0x35509e(0xfb))[_0x35509e(0xd1)](_0x1e452b,_0x3366c4,_0x35509e(0x12b));if(_0x1e18b7)return _0x44f124();else{let _0x5cdc50=parseInt(_0x4ba3e5[_0x35509e(0x11b)]['replace'](_0x35509e(0xa0),'')[_0x35509e(0xbc)](_0x35509e(0x11a),''));return _0x1ca5a2['seq']>_0x5cdc50+0xf||_0x1ca5a2['seq']<_0x5cdc50?(process[_0x35509e(0x12f)]({'type':_0x35509e(0xb2),'playId':_0x1e452b,'action':'stop'}),process[_0x35509e(0x12f)]({'type':_0x35509e(0xb2),'playId':_0x1e452b,'args':_0x1ca5a2,'action':_0x35509e(0xb7)}),_0x10b47f[_0x35509e(0xf3)][_0x35509e(0x10b)][_0x35509e(0xfa)](_0x35509e(0xdc))[_0x35509e(0x13c)](_0x1e452b,_0x3366c4,_0x35509e(0x12b)),_0x44f124()):_0x44f124();}}}}function hasPermission(_0x5e0d3f,_0x1e2642,_0x5d90d1){const _0x1cf70d=_0x25d6f6;if(_0x5d90d1[_0x1cf70d(0x129)]&&!_0x5d90d1[_0x1cf70d(0x112)]){let _0x17839e=dbFileIndexTable[_0x1cf70d(0xf1)](_0x5d90d1[_0x1cf70d(0xc9)]),_0x12d412=dbFileIndexTable[_0x1cf70d(0xf2)](_0x5e0d3f[_0x1cf70d(0xf3)]['dbFileIndex'],_0x5d90d1['indexId'],_0x17839e);if(!_0x12d412)return reject(_0x1cf70d(0x132));let _0x104214=_0x12d412[_0x1cf70d(0xaa)]+path[_0x1cf70d(0xf7)]+_0x12d412[_0x1cf70d(0x133)];if(dbUserTable[_0x1cf70d(0x10f)](_0x5e0d3f,_0x1e2642,_0x5d90d1[_0x1cf70d(0xc9)],_0x1cf70d(0x110),_0x104214,!![])!==!![])return console[_0x1cf70d(0x9a)](_0x1cf70d(0x117)),![];return!![];}else{if(_0x5d90d1[_0x1cf70d(0xd9)]&&!_0x5d90d1[_0x1cf70d(0x112)]){let _0x5ac94c=fileUtil[_0x1cf70d(0xa7)](_0x5d90d1[_0x1cf70d(0xd9)]);if(dbUserTable['doUserCanGet'](_0x5e0d3f,_0x1e2642,'','power_get',_0x5ac94c,!![])!==!![])return console['log'](_0x1cf70d(0x117)),![];return!![];}else{if(_0x5d90d1['spaceId']&&_0x5d90d1[_0x1cf70d(0x136)]){let _0x59152e=dbPrivateSpaceTable['getTokenObjByToken'](_0x5e0d3f[_0x1cf70d(0xf3)][_0x1cf70d(0x10b)],_0x5d90d1['spaceToken']);if(!_0x59152e||_0x59152e[_0x1cf70d(0xa3)]!=_0x5d90d1[_0x1cf70d(0x112)])return![];return!![];}else return console[_0x1cf70d(0x9a)]('args',_0x5d90d1),![];}}}router[_0x25d6f6(0xd1)](_0x25d6f6(0x10d),(_0x3176c5,_0x468a54,_0x42ee1b)=>{const _0x15b824=_0x25d6f6;let _0x197812=_0x3176c5[_0x15b824(0x11e)];if(_0x3176c5[_0x15b824(0xaa)][_0x15b824(0xcc)]('ts')){let _0x8f79aa=_0x3176c5['path'][_0x15b824(0x113)](_0x3176c5[_0x15b824(0xaa)][_0x15b824(0x13a)]('/')+0x1),_0x44a2bd=_0x197812['playId'],_0x1a628c=path['join'](config[_0x15b824(0x9e)],_0x44a2bd,_0x8f79aa),_0x52816d=_0x3176c5[_0x15b824(0xf3)][_0x15b824(0x10b)][_0x15b824(0xfa)](_0x15b824(0x107))[_0x15b824(0xd1)](_0x44a2bd);!_0x52816d&&(_0x197812[_0x15b824(0x12c)]=_0x197812[_0x15b824(0xb1)]*config[_0x15b824(0x11d)],_0x3176c5[_0x15b824(0xf3)][_0x15b824(0x10b)]['prepare'](_0x15b824(0xa6))[_0x15b824(0x13c)](_0x44a2bd,JSON[_0x15b824(0xd5)](_0x197812),_0x3176c5['currentUser']['id']));if(!hasPermission(_0x3176c5,_0x468a54,_0x197812))return _0x468a54[_0x15b824(0xa1)]({'code':0x66});return process['send']({'type':_0x15b824(0xb2),'playId':_0x44a2bd,'args':_0x197812,'action':'start'}),sendTsFile(_0x3176c5,_0x468a54,_0x197812,_0x1a628c,_0x8f79aa);}else{if(_0x3176c5[_0x15b824(0xaa)]['endsWith']('m3u8')){let _0x468b9a=_0x197812[_0x15b824(0x111)];if(!_0x468b9a)return _0x3176c5[_0x15b824(0xf3)][_0x15b824(0xc2)](_0x468a54,_0x15b824(0xef));if(!hasPermission(_0x3176c5,_0x468a54,_0x197812))return _0x468a54[_0x15b824(0xa1)]({'code':0x66});transCodeUtil[_0x15b824(0xf9)](_0x3176c5[_0x15b824(0xf3)]['dbFileIndex'],_0x3176c5[_0x15b824(0xf3)]['dbOther'],_0x197812)[_0x15b824(0xc0)](_0x2bd0a9=>{const _0x231684=_0x15b824;let {fullpath:_0x543f90,duration:_0x4e605c}=_0x2bd0a9;fs[_0x231684(0xc8)](_0x543f90,fs[_0x231684(0xa2)]['R_OK'],_0x44cdff=>{const _0x48eac0=_0x231684;if(_0x44cdff)return _0x3176c5[_0x48eac0(0xf3)][_0x48eac0(0xc2)](_0x468a54,_0x468a54['__'](_0x48eac0(0xb6)));_0x3176c5['app'][_0x48eac0(0x10b)]['prepare'](_0x48eac0(0xa6))[_0x48eac0(0x13c)](_0x468b9a,JSON['stringify'](_0x197812),_0x3176c5['currentUser']['id']),process[_0x48eac0(0x12f)]({'type':_0x48eac0(0xb2),'playId':_0x468b9a,'args':_0x197812,'action':_0x48eac0(0xb7)}),getM3U8(_0x197812,_0x4e605c,_0x468a54);});})['catch'](_0x498e22=>{const _0x30a47c=_0x15b824;console[_0x30a47c(0x9a)](_0x30a47c(0xac),_0x498e22),_0x3176c5[_0x30a47c(0xf3)][_0x30a47c(0xc2)](_0x468a54,_0x498e22);});}else{if(_0x3176c5[_0x15b824(0xaa)][_0x15b824(0xcc)](_0x15b824(0xae))){if(!hasPermission(_0x3176c5,_0x468a54,_0x197812))return _0x468a54[_0x15b824(0xa1)]({'code':0x66});transCodeUtil[_0x15b824(0xf9)](_0x3176c5['app']['dbFileIndex'],_0x3176c5[_0x15b824(0xf3)][_0x15b824(0x10b)],_0x197812)['then'](_0x5dfe7b=>{const _0x334ada=_0x15b824;let {fullpath:_0x8a7b81,streamList:_0x2c409a,needDecrypt:_0x56521a,pwd:_0x41bc2f}=_0x5dfe7b;fs[_0x334ada(0xc8)](_0x8a7b81,fs['constants']['R_OK'],_0x501062=>{const _0x31c472=_0x334ada;if(_0x501062)return _0x3176c5[_0x31c472(0xf3)][_0x31c472(0xc2)](_0x468a54,_0x468a54['__']('cannotReadFile'));MP4FfmpegTrans(_0x3176c5,_0x468a54,_0x8a7b81,_0x2c409a,_0x56521a,_0x41bc2f);});})[_0x15b824(0x105)](_0x366855=>{const _0x5f0486=_0x15b824;console[_0x5f0486(0x9a)](_0x5f0486(0xac),_0x366855),_0x3176c5['app']['returnErrMsg'](_0x468a54,_0x366855);});}}}}),router['post'](_0x25d6f6(0x119),(_0x2bdacf,_0x3d7c2e,_0x34721)=>{const _0x1caf0b=_0x25d6f6;if(!_0x2bdacf[_0x1caf0b(0xc6)][_0x1caf0b(0xd9)])return _0x3d7c2e[_0x1caf0b(0xca)](0x1f4);let _0x13b74d=fileUtil['decodePath'](_0x2bdacf[_0x1caf0b(0xc6)]['filePath']),_0x57c678={'code':0x0,'streams':[],'duration':0x0},_0x271de1=dbConfigTable['findByTitle'](_0x2bdacf['app'][_0x1caf0b(0x10b)],_0x1caf0b(0x101));_0x57c678[_0x1caf0b(0x101)]=_0x271de1?_0x271de1[_0x1caf0b(0xc3)]:_0x1caf0b(0x121),_0x13b74d=transCodeUtil[_0x1caf0b(0x120)](_0x13b74d),videoStreamUtil['getVideoMeta'](_0x13b74d)[_0x1caf0b(0xc0)](_0x2e7f59=>{const _0x870aee=_0x1caf0b;_0x57c678[_0x870aee(0xc7)]=_0x2e7f59[_0x870aee(0xc7)],_0x57c678[_0x870aee(0x109)]=videoStreamUtil[_0x870aee(0x127)](_0x2e7f59),_0x3d7c2e[_0x870aee(0xa1)](_0x57c678);})['catch'](_0x2f6034=>{const _0x1d1904=_0x1caf0b;return console[_0x1d1904(0x9a)](_0x2f6034),_0x2bdacf['app'][_0x1d1904(0xc2)](_0x3d7c2e,_0x2f6034);});});function getM3U8(_0x5ec99c,_0x1fbfcc,_0x303cb9){const _0x5125d0=_0x25d6f6;let _0x4662fa=Math[_0x5125d0(0x9d)](_0x1fbfcc/config[_0x5125d0(0x11d)]),_0x2c9ab6=_0x1fbfcc-_0x4662fa*_0x1fbfcc;if(_0x2c9ab6>0x0){try{_0x2c9ab6=parseInt(_0x2c9ab6);}catch(_0x53c396){console[_0x5125d0(0x9a)](_0x53c396);}_0x4662fa+=0x1;}let _0x3c786b=_0x5125d0(0xd4)+config['m3u8segmentDuration']+_0x5125d0(0xfd)+_0x5ec99c[_0x5125d0(0x12c)]+'\x0a';_0x5ec99c[_0x5125d0(0x12c)]&&(segmentStartNum=parseInt(_0x5ec99c[_0x5125d0(0x12c)]/config['m3u8segmentDuration']));for(let _0x1c53aa=0x0;_0x1c53aa<_0x4662fa;_0x1c53aa++){let _0x2ed657='\x0a#EXTINF:'+(_0x1c53aa==_0x4662fa-0x1&&_0x2c9ab6>0x0?_0x2c9ab6:config[_0x5125d0(0x11d)])+_0x5125d0(0xe6)+_0x1c53aa+_0x5125d0(0xbb)+_0x5ec99c[_0x5125d0(0x111)]+_0x5125d0(0x102)+_0x5ec99c['token']+_0x5125d0(0xa5)+_0x1c53aa;_0x5ec99c[_0x5125d0(0x12a)]&&(_0x2ed657+=_0x5125d0(0xe7)+_0x5ec99c[_0x5125d0(0x12a)]),_0x5ec99c[_0x5125d0(0x11f)]&&(_0x2ed657+=_0x5125d0(0xda)+_0x5ec99c[_0x5125d0(0x11f)]),_0x5ec99c[_0x5125d0(0xc1)]&&(_0x2ed657+=_0x5125d0(0xf8)+_0x5ec99c[_0x5125d0(0xc1)]),_0x5ec99c[_0x5125d0(0xc9)]&&(_0x2ed657+=_0x5125d0(0xd7)+_0x5ec99c[_0x5125d0(0xc9)]),_0x5ec99c[_0x5125d0(0xa8)]&&(_0x2ed657+=_0x5125d0(0xd3)+_0x5ec99c[_0x5125d0(0xa8)]),_0x5ec99c[_0x5125d0(0x129)]&&(_0x2ed657+=_0x5125d0(0xf6)+_0x5ec99c[_0x5125d0(0x129)]),_0x5ec99c['ac']&&(_0x2ed657+='&ac='+_0x5ec99c['ac']),_0x5ec99c['filePath']&&(_0x2ed657+=_0x5125d0(0x9c)+_0x5ec99c[_0x5125d0(0xd9)]),_0x5ec99c['spaceId']&&(_0x2ed657+=_0x5125d0(0xa4)+_0x5ec99c[_0x5125d0(0x112)]),_0x5ec99c[_0x5125d0(0x136)]&&(_0x2ed657+=_0x5125d0(0xff)+_0x5ec99c[_0x5125d0(0x136)]),_0x5ec99c[_0x5125d0(0xb5)]&&(_0x2ed657+='&spaceIndexId='+_0x5ec99c[_0x5125d0(0xb5)]),_0x5ec99c[_0x5125d0(0xaf)]&&(_0x2ed657+=_0x5125d0(0x12e)+_0x5ec99c[_0x5125d0(0xaf)]),_0x3c786b+=_0x2ed657;}_0x3c786b+=_0x5125d0(0xc4),_0x303cb9[_0x5125d0(0x138)](_0x5125d0(0xdf),_0x5125d0(0x9f));let _0x97c21b=new Date()['getTime']()+_0x5125d0(0x122);_0x303cb9[_0x5125d0(0x138)]('Content-disposition',_0x5125d0(0x137)+_0x97c21b),_0x303cb9['send'](_0x3c786b);}module['exports']=router;