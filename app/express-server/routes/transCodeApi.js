const _0x4b7bf6=_0x3ba2;(function(_0x217c8d,_0xbf0fed){const _0x464697=_0x3ba2,_0x707357=_0x217c8d();while(!![]){try{const _0xa7d7c4=-parseInt(_0x464697(0x1ba))/0x1+-parseInt(_0x464697(0x22a))/0x2+-parseInt(_0x464697(0x1e2))/0x3*(parseInt(_0x464697(0x1fd))/0x4)+parseInt(_0x464697(0x21d))/0x5+-parseInt(_0x464697(0x232))/0x6*(-parseInt(_0x464697(0x258))/0x7)+-parseInt(_0x464697(0x206))/0x8+-parseInt(_0x464697(0x1b4))/0x9*(-parseInt(_0x464697(0x1fe))/0xa);if(_0xa7d7c4===_0xbf0fed)break;else _0x707357['push'](_0x707357['shift']());}catch(_0x16b384){_0x707357['push'](_0x707357['shift']());}}}(_0x1a68,0x189c9));let express=require(_0x4b7bf6(0x22b)),router=express[_0x4b7bf6(0x20e)](),path=require(_0x4b7bf6(0x1f2)),fs=require('fs'),transCodeUtil=require(_0x4b7bf6(0x1d4)),fileUtil=require(_0x4b7bf6(0x1cc));const config=require(_0x4b7bf6(0x239));let videoStreamUtil=require('../../utils/videoStreamUtil'),FFmpeg=require(_0x4b7bf6(0x1c5))[_0x4b7bf6(0x23a)],cryptoUtils=require(_0x4b7bf6(0x1fc)),sha256=require(_0x4b7bf6(0x233));require(_0x4b7bf6(0x1f8))[_0x4b7bf6(0x251)][_0x4b7bf6(0x1d6)]=0x0;const dbUserTable=require(_0x4b7bf6(0x21e)),dbFileIndexTable=require(_0x4b7bf6(0x1c9)),dbConfigTable=require(_0x4b7bf6(0x1d3));var jschardet=require(_0x4b7bf6(0x1dc));function _0x1a68(){const _0x43b055=['prepare','aac','spaceToken','setHeader','events','decryptFileGetStream','dbFileIndex','-movflags\x20frag_keyframe+empty_moov','../utils/cryptoUtils','13772WVdThk','1607690mxcaQb','/getVideoInfoByPath','query','stype','floor','&subtitleIndex=','close','serverType','543104jjbLCC','error','body','attachment;\x20filename=','pipe','all','application/octet-stream','getVideoBitrate','Router','lastIndexOf','filename','playId','streams','encoderName','-sub_charenc\x20','\x0a#EXTINF:','findByTitle','decoderCommand','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','send','seek','outputOptions','&audioIndex=','118105TBbatr','../../db/dbUserTable','getDurationFromStream','addOption','message','-map\x200:s:','status','join','exports','audioCodec','.vtt','end','&spaceIndexId=','97718XROIfY','express','returnErrMsg','size','gen','getVideoMeta','-map\x200:v:0?','M3u8Transcode','14196XlZzVB','sha256','&size=','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','videoCodec','dealFFmpegPath','mp4','../../myConfig/config','FFmpeg','start','dbOther','get','cannotReadFile','&filePath=','currentUser','parseStreamList','catch','endsWith','subtitleIndex','kill','&token=','startsWith','outputFormat','token','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','&seq=','生成字幕文件','getById','noAudio','extname','.ts?playId=','EventEmitter','filePath','doUserCanGet','-map\x200:a:','spaceId','length','ts_name','203rbDKso','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','output','.ts','seekInput','m3u8','decodePath','moviePreferLanguage','subtitlePath','18QEjCMp','vtt','m3u8segmentDuration','access','m3u8TmpPath','index\x20does\x20not\x20exist','61940oxGjgD','burn','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?','format','字幕文件存在缓存','post','confidence','encoding','stat','webvtt','need\x20play\x20id','../../libs/nasTrans','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','&ac=','Content-type','../../db/dbFileIndexTable','substring','stop','../utils/fileUtils','seq','audioIndex','stringify','index\x20no\x20permission','run','waiting','../../db/dbConfigTable','../../utils/transCodeUtil','json','defaultMaxListeners','power_get','parseVideoFullPath','&serverType=','\x0a#EXT-X-ENDLIST\x0a','sendFile','jschardet','spaceIndexId','&spaceId=','stream','subtitleFile','noContent','117QWIKgc','.m3u8','log','app','&burn=','replace','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','addInputOption','/stopPlay','videobit','input','sendStatus','constants','duration','then','indexId','path','R_OK'];_0x1a68=function(){return _0x43b055;};return _0x1a68();}function MP4FfmpegTrans(_0x4ff810,_0x2c8eda,_0x4d92c2,_0x29326f,_0x41b922,_0x111c5e){const _0x28bfdb=_0x4b7bf6;let _0x1919e4=_0x4ff810['query'],_0x594e25=FFmpeg(),_0x47ebe8;if(_0x41b922)_0x47ebe8=cryptoUtils[_0x28bfdb(0x1f9)](_0x111c5e,_0x4d92c2);let _0x371016=_0x41b922?_0x47ebe8:_0x4d92c2,{videoStream:_0xe76d18,videoWidth:_0x2d0de7,videoHeight:_0x436eef}=transCodeUtil[_0x28bfdb(0x241)](_0x29326f);_0x594e25[_0x28bfdb(0x1ec)](transCodeUtil[_0x28bfdb(0x237)](_0x371016));try{_0x594e25['on'](_0x28bfdb(0x23b),function(_0x2e6e97){console['log'](_0x2e6e97);}),_0x594e25['on']('error',function(_0x20cd11){const _0x3b0850=_0x28bfdb;if(_0x20cd11[_0x3b0850(0x221)]&&_0x20cd11['message']['indexOf']('killed')==-0x1)_0x594e25[_0x3b0850(0x245)](),_0x594e25=null,_0x2c8eda[_0x3b0850(0x223)](0x1f4)[_0x3b0850(0x228)]();else{}}),_0x594e25['on']('end',function(_0x1b3d6d){const _0x439c58=_0x28bfdb;_0x594e25&&(_0x594e25[_0x439c58(0x245)](),_0x594e25=null);if(_0x2c8eda)_0x2c8eda['status'](0xc8)[_0x439c58(0x228)]();}),_0x2c8eda['on']('close',function(){});let _0x475e87=transCodeUtil['getCoderConfig'](_0x4ff810[_0x28bfdb(0x1e5)]['dbOther'],_0xe76d18);_0x475e87[_0x28bfdb(0x217)]&&_0x594e25[_0x28bfdb(0x1e9)](_0x475e87[_0x28bfdb(0x217)]);let _0xc0459=_0x1919e4['seq']*config[_0x28bfdb(0x1b6)];_0xc0459&&!_0x41b922&&_0x594e25[_0x28bfdb(0x25c)](''+parseInt(_0xc0459));_0x475e87[_0x28bfdb(0x213)]&&_0x594e25[_0x28bfdb(0x236)](_0x475e87[_0x28bfdb(0x213)]);let _0x17352f=transCodeUtil[_0x28bfdb(0x20d)](_0xe76d18,_0x1919e4[_0x28bfdb(0x1eb)]);!_0x17352f&&(_0x17352f=0x1800),_0x594e25['videoBitrate'](''+_0x17352f),_0x594e25[_0x28bfdb(0x220)](_0x28bfdb(0x230)),_0x594e25[_0x28bfdb(0x220)](_0x28bfdb(0x254)+(_0x1919e4[_0x28bfdb(0x1ce)]?_0x1919e4['audioIndex']:0x0)+'?'),_0x594e25[_0x28bfdb(0x248)](_0x28bfdb(0x238)),_0x594e25[_0x28bfdb(0x226)](_0x28bfdb(0x1f5)),_0x594e25['outputOptions']([_0x28bfdb(0x1fb)]),_0x594e25[_0x28bfdb(0x248)](_0x28bfdb(0x238)),_0x594e25[_0x28bfdb(0x20a)](_0x2c8eda,{'end':!![]});}catch(_0x4d969f){console[_0x28bfdb(0x1e4)](_0x4d969f),_0x594e25[_0x28bfdb(0x245)](),_0x2c8eda[_0x28bfdb(0x1ed)](0x1f4);}}function _0x3ba2(_0xc736a1,_0x3cd37f){const _0x1a688f=_0x1a68();return _0x3ba2=function(_0x3ba2cc,_0x1d2333){_0x3ba2cc=_0x3ba2cc-0x1b0;let _0x230db8=_0x1a688f[_0x3ba2cc];return _0x230db8;},_0x3ba2(_0xc736a1,_0x3cd37f);}router[_0x4b7bf6(0x20b)](_0x4b7bf6(0x1ea),(_0x2137e1,_0x2387d1,_0x14a2ad)=>{const _0xf7f152=_0x4b7bf6;let _0x1ef700=_0x2137e1[_0xf7f152(0x200)][_0xf7f152(0x211)]||_0x2137e1[_0xf7f152(0x208)][_0xf7f152(0x211)];process[_0xf7f152(0x219)]({'type':_0xf7f152(0x231),'playId':_0x1ef700,'action':_0xf7f152(0x1cb)});let _0x4366c5=path[_0xf7f152(0x224)](config[_0xf7f152(0x1b8)],_0x1ef700);return fs['rm'](_0x4366c5,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x42ba70=>{if(_0x42ba70)console['log'](_0x42ba70);}),_0x2137e1[_0xf7f152(0x1e5)][_0xf7f152(0x23c)][_0xf7f152(0x1f4)](_0xf7f152(0x235))[_0xf7f152(0x1d1)](_0x2137e1[_0xf7f152(0x200)][_0xf7f152(0x211)]),_0x2387d1[_0xf7f152(0x1d5)]({'code':0x0});}),router['get']('/subtitle*',(_0x4108cd,_0x2c96d2,_0x515548)=>{const _0xbc30c0=_0x4b7bf6;let _0x4c681=_0x4108cd[_0xbc30c0(0x200)],_0x45e8d7=_0x4c681[_0xbc30c0(0x244)],_0x2a1c41=_0x4c681[_0xbc30c0(0x1e0)];if(_0x2a1c41&&_0x2a1c41[_0xbc30c0(0x256)]>0x2){let _0x52e2b6=fileUtil['decodePath'](_0x2a1c41);fs[_0xbc30c0(0x1b7)](_0x52e2b6,fs[_0xbc30c0(0x1ee)]['R_OK'],_0x17695d=>{const _0x358532=_0xbc30c0;if(_0x17695d)return _0x4108cd['app'][_0x358532(0x22c)](_0x2c96d2,_0x2c96d2['__'](_0x358532(0x23e)));path[_0x358532(0x24f)](_0x52e2b6)==_0x358532(0x227)&&_0x2c96d2[_0x358532(0x1db)](_0x52e2b6),fs['readFile'](_0x52e2b6,(_0x187494,_0x1d0be0)=>{const _0x206d5b=_0x358532;if(_0x187494)return _0x4108cd['app'][_0x206d5b(0x22c)](_0x2c96d2,_0x2c96d2['__'](_0x206d5b(0x23e)));try{let _0x2d1e80=jschardet['detect'](_0x1d0be0);!_0x2d1e80['encoding'][_0x206d5b(0x247)]('UTF-')&&_0x2d1e80[_0x206d5b(0x1c0)]>0.95?_0x57a083(_0x2d1e80[_0x206d5b(0x1c1)]):_0x57a083();}catch(_0x4a92cc){console[_0x206d5b(0x1e4)](_0x4a92cc),_0x57a083();}function _0x57a083(_0x3a0305){const _0x1b8e3c=_0x206d5b;let _0x973866=FFmpeg();_0x973866[_0x1b8e3c(0x1ec)](transCodeUtil[_0x1b8e3c(0x237)](_0x52e2b6))[_0x1b8e3c(0x24e)]()['noVideo']()[_0x1b8e3c(0x1bd)](_0x1b8e3c(0x1c3)),_0x3a0305&&_0x973866['inputOption'](_0x1b8e3c(0x214)+_0x3a0305),_0x973866['on'](_0x1b8e3c(0x23b),function(_0x1134ea){const _0x3b773a=_0x1b8e3c;console[_0x3b773a(0x1e4)](_0x1134ea);})['on']('error',function(_0x204f05){const _0x466366=_0x1b8e3c;_0x973866[_0x466366(0x245)]();})['on']('end',function(){const _0x33ddd1=_0x1b8e3c;_0x973866[_0x33ddd1(0x245)]();})[_0x1b8e3c(0x20a)](_0x2c96d2);}});});}else{let _0x3a2c64=_0x4c681[_0xbc30c0(0x201)];transCodeUtil[_0xbc30c0(0x1d8)](_0x4108cd[_0xbc30c0(0x1e5)][_0xbc30c0(0x1fa)],_0x4108cd['app']['dbOther'],_0x4c681)['then'](_0x220e63=>{const _0x32cdaf=_0xbc30c0;let {fullpath:_0x413056,needDecrypt:_0x454614,pwd:_0x34badd,streamList:_0xfd5b0e}=_0x220e63;fs['access'](_0x413056,fs[_0x32cdaf(0x1ee)][_0x32cdaf(0x1f3)],_0x215051=>{const _0x5053c6=_0x32cdaf;if(_0x215051)return _0x4108cd['app'][_0x5053c6(0x22c)](_0x2c96d2,_0x2c96d2['__']('cannotReadFile'));if(!_0x3a2c64)_0x3a2c64=_0x5053c6(0x1b5);let _0x4b610e=path['join'](config[_0x5053c6(0x1b3)],sha256(_0x413056+_0x45e8d7)+'.'+_0x3a2c64);fs[_0x5053c6(0x1c2)](_0x4b610e,(_0x29524f,_0x2f64f3)=>{const _0x4eb51f=_0x5053c6;if(_0x29524f||_0x2f64f3['size']<0x3e8){console[_0x4eb51f(0x1e4)](_0x4eb51f(0x24c),_0x4b610e);let _0x299f95=_0x454614?cryptoUtils[_0x4eb51f(0x1f9)](_0x34badd,_0x413056):_0x413056,_0x3e7319=FFmpeg({'timeout':0x258});_0x3e7319['input'](transCodeUtil[_0x4eb51f(0x237)](_0x299f95))[_0x4eb51f(0x24e)]()['noVideo']()[_0x4eb51f(0x21b)]([_0x4eb51f(0x222)+_0x45e8d7])[_0x4eb51f(0x25a)](_0x4b610e)['on']('start',function(_0x5a9cd5){const _0x22c86c=_0x4eb51f;console[_0x22c86c(0x1e4)](_0x5a9cd5);})['on']('error',function(_0x2b995c){const _0x25a1bc=_0x4eb51f;console['log'](_0x2b995c),_0x3e7319[_0x25a1bc(0x245)](),fs['rm'](_0x4b610e,_0x4e75ce=>{}),_0x4108cd['app'][_0x25a1bc(0x22c)](_0x2c96d2,_0x2c96d2['__']('faidLoadSubtitle'));})['on']('end',function(){const _0xac82b5=_0x4eb51f;return _0x3e7319[_0xac82b5(0x245)](),_0x4c681[_0xac82b5(0x1e1)]?_0x2c96d2[_0xac82b5(0x1d5)]({'code':0x0}):_0x2c96d2[_0xac82b5(0x1db)](_0x4b610e);}),_0x3e7319['run'](),_0x2c96d2['on'](_0x4eb51f(0x204),function(){const _0x3a19f0=_0x4eb51f;_0x3e7319[_0x3a19f0(0x245)]();});}else{console[_0x4eb51f(0x1e4)](_0x4eb51f(0x1be),_0x4b610e);if(_0x4c681[_0x4eb51f(0x1e1)])return _0x2c96d2[_0x4eb51f(0x1d5)]({'code':0x0});return _0x2c96d2[_0x4eb51f(0x1db)](_0x4b610e);}});});})[_0xbc30c0(0x242)](_0x46785a=>{const _0x5a1708=_0xbc30c0;console['log'](_0x46785a),_0x4108cd[_0x5a1708(0x1e5)][_0x5a1708(0x22c)](_0x2c96d2,_0x46785a);});}});function sendTsFile(_0x1212da,_0x1478d5,_0xba28b7,_0x450424,_0x5896c0,_0x25fa4a=0x1){const _0x309192=_0x4b7bf6;if(_0x25fa4a>0x28)return;let _0x1180d1=_0xba28b7[_0x309192(0x211)];if(!_0x1180d1)return;let _0x5417a4=_0x1212da[_0x309192(0x1e5)]['dbOther']['prepare'](_0x309192(0x259))[_0x309192(0x23d)](_0x1180d1,_0x5896c0,_0x309192(0x22e));if(_0x5417a4)fs[_0x309192(0x1c2)](_0x450424,(_0x3796b2,_0x157161)=>{const _0x4398ca=_0x309192;_0x3796b2?(_0x1212da[_0x4398ca(0x1e5)][_0x4398ca(0x23c)][_0x4398ca(0x1f4)](_0x4398ca(0x1bc))[_0x4398ca(0x1d1)](_0x1180d1,_0x5896c0),sendTsFile(_0x1212da,_0x1478d5,_0xba28b7,_0x450424,_0x5896c0,_0x25fa4a+0x1)):(_0x1212da['app'][_0x4398ca(0x23c)][_0x4398ca(0x1f4)](_0x4398ca(0x218))[_0x4398ca(0x1d1)](_0x1180d1),_0x1478d5[_0x4398ca(0x1db)](_0x450424));});else{function _0x343420(){const _0x267464=_0x309192;let _0xc33315=setTimeout(()=>{clearTimeout(_0xc33315),sendTsFile(_0x1212da,_0x1478d5,_0xba28b7,_0x450424,_0x5896c0,_0x25fa4a+0x1);},0x1f4);_0x1478d5['on'](_0x267464(0x204),()=>clearTimeout(_0xc33315));}let _0x57acc7=_0x1212da[_0x309192(0x1e5)][_0x309192(0x23c)][_0x309192(0x1f4)]('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC')[_0x309192(0x23d)](_0x1180d1,'gen');if(!_0x57acc7)return _0x343420();else{let _0x59769a=_0x1212da['app'][_0x309192(0x23c)][_0x309192(0x1f4)]('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?')['get'](_0x1180d1,_0x5896c0,_0x309192(0x1d2));if(_0x59769a)return _0x343420();else{let _0x5f5500=parseInt(_0x57acc7[_0x309192(0x257)][_0x309192(0x1e7)](_0x309192(0x1df),'')['replace'](_0x309192(0x25b),''));return _0xba28b7[_0x309192(0x1cd)]>_0x5f5500+0xf||_0xba28b7[_0x309192(0x1cd)]<_0x5f5500?(process[_0x309192(0x219)]({'type':_0x309192(0x231),'playId':_0x1180d1,'action':_0x309192(0x1cb)}),process['send']({'type':_0x309192(0x231),'playId':_0x1180d1,'args':_0xba28b7,'action':'start'}),_0x1212da[_0x309192(0x1e5)][_0x309192(0x23c)][_0x309192(0x1f4)](_0x309192(0x1c6))[_0x309192(0x1d1)](_0x1180d1,_0x5896c0,_0x309192(0x1d2)),_0x343420()):_0x343420();}}}}function hasPermission(_0xf80ee,_0x3d57ee,_0x1f5ad4){const _0x595319=_0x4b7bf6;if(_0x1f5ad4[_0x595319(0x1f1)]&&!_0x1f5ad4[_0x595319(0x255)]){let _0x4c88ad=dbFileIndexTable['getIndexTableNameByType'](_0x1f5ad4['serverType']),_0x56cb01=dbFileIndexTable[_0x595319(0x24d)](_0xf80ee[_0x595319(0x1e5)][_0x595319(0x1fa)],_0x1f5ad4[_0x595319(0x1f1)],_0x4c88ad);if(!_0x56cb01)return reject(_0x595319(0x1b9));let _0x2d2f19=_0x56cb01[_0x595319(0x1f2)]+path['sep']+_0x56cb01[_0x595319(0x210)];if(dbUserTable[_0x595319(0x253)](_0xf80ee,_0x3d57ee,_0x1f5ad4[_0x595319(0x205)],_0x595319(0x1d7),_0x2d2f19,!![])!==!![])return console[_0x595319(0x1e4)](_0x595319(0x1d0)),![];return!![];}else{if(_0x1f5ad4['filePath']&&!_0x1f5ad4[_0x595319(0x255)]){let _0x525860=fileUtil['decodePath'](_0x1f5ad4[_0x595319(0x252)]);if(dbUserTable[_0x595319(0x253)](_0xf80ee,_0x3d57ee,'','power_get',_0x525860,!![])!==!![])return console['log'](_0x595319(0x1d0)),![];return!![];}else return![];}}router['get']('/play*',(_0x604c8d,_0x202328,_0x49cf29)=>{const _0xa25917=_0x4b7bf6;let _0x49c1d6=_0x604c8d[_0xa25917(0x200)];if(_0x604c8d['path']['endsWith']('ts')){let _0x5dd2a9=_0x604c8d['path'][_0xa25917(0x1ca)](_0x604c8d[_0xa25917(0x1f2)][_0xa25917(0x20f)]('/')+0x1),_0x211f71=_0x49c1d6[_0xa25917(0x211)],_0x36a1c7=path[_0xa25917(0x224)](config[_0xa25917(0x1b8)],_0x211f71,_0x5dd2a9),_0xf79dc0=_0x604c8d['app'][_0xa25917(0x23c)][_0xa25917(0x1f4)]('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')[_0xa25917(0x23d)](_0x211f71);!_0xf79dc0&&(_0x49c1d6[_0xa25917(0x21a)]=_0x49c1d6[_0xa25917(0x1cd)]*config[_0xa25917(0x1b6)],_0x604c8d[_0xa25917(0x1e5)]['dbOther'][_0xa25917(0x1f4)](_0xa25917(0x24a))['run'](_0x211f71,JSON[_0xa25917(0x1cf)](_0x49c1d6),_0x604c8d['currentUser']['id']));if(!hasPermission(_0x604c8d,_0x202328,_0x49c1d6))return _0x202328[_0xa25917(0x1d5)]({'code':0x66});return process[_0xa25917(0x219)]({'type':'M3u8Transcode','playId':_0x211f71,'args':_0x49c1d6,'action':'start'}),sendTsFile(_0x604c8d,_0x202328,_0x49c1d6,_0x36a1c7,_0x5dd2a9);}else{if(_0x604c8d[_0xa25917(0x1f2)][_0xa25917(0x243)](_0xa25917(0x1b0))){let _0x594d42=_0x49c1d6[_0xa25917(0x211)];if(!_0x594d42)return _0x604c8d['app'][_0xa25917(0x22c)](_0x202328,_0xa25917(0x1c4));if(!hasPermission(_0x604c8d,_0x202328,_0x49c1d6))return _0x202328[_0xa25917(0x1d5)]({'code':0x66});transCodeUtil[_0xa25917(0x1d8)](_0x604c8d[_0xa25917(0x1e5)][_0xa25917(0x1fa)],_0x604c8d[_0xa25917(0x1e5)][_0xa25917(0x23c)],_0x49c1d6)[_0xa25917(0x1f0)](_0x4f2312=>{const _0x247bf9=_0xa25917;let {fullpath:_0x2e7248,duration:_0x24bcba}=_0x4f2312;fs['access'](_0x2e7248,fs[_0x247bf9(0x1ee)]['R_OK'],_0x1e68f6=>{const _0x5b14e9=_0x247bf9;if(_0x1e68f6)return _0x604c8d['app']['returnErrMsg'](_0x202328,_0x202328['__']('cannotReadFile'));_0x604c8d['app'][_0x5b14e9(0x23c)][_0x5b14e9(0x1f4)]('REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)')['run'](_0x594d42,JSON[_0x5b14e9(0x1cf)](_0x49c1d6),_0x604c8d[_0x5b14e9(0x240)]['id']),process[_0x5b14e9(0x219)]({'type':_0x5b14e9(0x231),'playId':_0x594d42,'args':_0x49c1d6,'action':_0x5b14e9(0x23b)}),getM3U8(_0x49c1d6,_0x24bcba,_0x202328);});})[_0xa25917(0x242)](_0x238a3c=>{const _0x23568b=_0xa25917;console[_0x23568b(0x1e4)](_0x23568b(0x207),_0x238a3c),_0x604c8d[_0x23568b(0x1e5)]['returnErrMsg'](_0x202328,_0x238a3c);});}else{if(_0x604c8d[_0xa25917(0x1f2)][_0xa25917(0x243)](_0xa25917(0x238))){if(!hasPermission(_0x604c8d,_0x202328,_0x49c1d6))return _0x202328[_0xa25917(0x1d5)]({'code':0x66});transCodeUtil[_0xa25917(0x1d8)](_0x604c8d[_0xa25917(0x1e5)][_0xa25917(0x1fa)],_0x604c8d[_0xa25917(0x1e5)]['dbOther'],_0x49c1d6)[_0xa25917(0x1f0)](_0x32f669=>{const _0x2a435f=_0xa25917;let {fullpath:_0x5a5994,streamList:_0x5dfe1b,needDecrypt:_0x25fb20,pwd:_0x57aafc}=_0x32f669;fs[_0x2a435f(0x1b7)](_0x5a5994,fs[_0x2a435f(0x1ee)]['R_OK'],_0x542a68=>{const _0x11bc67=_0x2a435f;if(_0x542a68)return _0x604c8d[_0x11bc67(0x1e5)][_0x11bc67(0x22c)](_0x202328,_0x202328['__'](_0x11bc67(0x23e)));MP4FfmpegTrans(_0x604c8d,_0x202328,_0x5a5994,_0x5dfe1b,_0x25fb20,_0x57aafc);});})[_0xa25917(0x242)](_0x187833=>{const _0x436acd=_0xa25917;console[_0x436acd(0x1e4)]('error',_0x187833),_0x604c8d['app'][_0x436acd(0x22c)](_0x202328,_0x187833);});}}}}),router[_0x4b7bf6(0x1bf)](_0x4b7bf6(0x1ff),(_0x7cce0b,_0x384922,_0x3272db)=>{const _0x461704=_0x4b7bf6;if(!_0x7cce0b[_0x461704(0x208)][_0x461704(0x252)])return _0x384922[_0x461704(0x1ed)](0x1f4);let _0x1d3754=fileUtil[_0x461704(0x1b1)](_0x7cce0b[_0x461704(0x208)][_0x461704(0x252)]),_0x101aae={'code':0x0,'streams':[],'duration':0x0},_0x34f622=dbConfigTable[_0x461704(0x216)](_0x7cce0b[_0x461704(0x1e5)]['dbOther'],_0x461704(0x1b2));_0x101aae[_0x461704(0x1b2)]=_0x34f622?_0x34f622['value']:'chi',_0x1d3754=transCodeUtil[_0x461704(0x237)](_0x1d3754),videoStreamUtil[_0x461704(0x22f)](_0x1d3754)[_0x461704(0x1f0)](_0x184cab=>{const _0x57752a=_0x461704;_0x101aae[_0x57752a(0x212)]=_0x184cab[_0x57752a(0x212)],_0x101aae[_0x57752a(0x1ef)]=videoStreamUtil[_0x57752a(0x21f)](_0x184cab),_0x384922[_0x57752a(0x1d5)](_0x101aae);})[_0x461704(0x242)](_0x341198=>{const _0x260290=_0x461704;return console[_0x260290(0x1e4)](_0x341198),_0x7cce0b[_0x260290(0x1e5)][_0x260290(0x22c)](_0x384922,_0x341198);});});function getM3U8(_0x2a2f92,_0x58224a,_0xdeafe4){const _0x4080b0=_0x4b7bf6;let _0x2e3e70=Math[_0x4080b0(0x202)](_0x58224a/config[_0x4080b0(0x1b6)]),_0x314b8d=_0x58224a-_0x2e3e70*_0x58224a;if(_0x314b8d>0x0){try{_0x314b8d=parseInt(_0x314b8d);}catch(_0x2b8bb9){console[_0x4080b0(0x1e4)](_0x2b8bb9);}_0x2e3e70+=0x1;}let _0x4fb14d=_0x4080b0(0x1e8)+config['m3u8segmentDuration']+',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET='+_0x2a2f92[_0x4080b0(0x21a)]+'\x0a';_0x2a2f92[_0x4080b0(0x21a)]&&(segmentStartNum=parseInt(_0x2a2f92[_0x4080b0(0x21a)]/config[_0x4080b0(0x1b6)]));for(let _0x196aec=0x0;_0x196aec<_0x2e3e70;_0x196aec++){let _0xeebca1=_0x4080b0(0x215)+(_0x196aec==_0x2e3e70-0x1&&_0x314b8d>0x0?_0x314b8d:config[_0x4080b0(0x1b6)])+'.0,\x0astream'+_0x196aec+_0x4080b0(0x250)+_0x2a2f92[_0x4080b0(0x211)]+_0x4080b0(0x246)+_0x2a2f92[_0x4080b0(0x249)]+_0x4080b0(0x24b)+_0x196aec;_0x2a2f92[_0x4080b0(0x22d)]&&(_0xeebca1+=_0x4080b0(0x234)+_0x2a2f92[_0x4080b0(0x22d)]),_0x2a2f92[_0x4080b0(0x1eb)]&&(_0xeebca1+='&videobit='+_0x2a2f92[_0x4080b0(0x1eb)]),_0x2a2f92[_0x4080b0(0x244)]&&(_0xeebca1+=_0x4080b0(0x203)+_0x2a2f92[_0x4080b0(0x244)]),_0x2a2f92[_0x4080b0(0x205)]&&(_0xeebca1+=_0x4080b0(0x1d9)+_0x2a2f92[_0x4080b0(0x205)]),_0x2a2f92[_0x4080b0(0x1ce)]&&(_0xeebca1+=_0x4080b0(0x21c)+_0x2a2f92['audioIndex']),_0x2a2f92[_0x4080b0(0x1f1)]&&(_0xeebca1+='&indexId='+_0x2a2f92[_0x4080b0(0x1f1)]),_0x2a2f92['ac']&&(_0xeebca1+=_0x4080b0(0x1c7)+_0x2a2f92['ac']),_0x2a2f92[_0x4080b0(0x252)]&&(_0xeebca1+=_0x4080b0(0x23f)+_0x2a2f92['filePath']),_0x2a2f92['spaceId']&&(_0xeebca1+=_0x4080b0(0x1de)+_0x2a2f92['spaceId']),_0x2a2f92[_0x4080b0(0x1f6)]&&(_0xeebca1+='&spaceToken='+_0x2a2f92[_0x4080b0(0x1f6)]),_0x2a2f92[_0x4080b0(0x1dd)]&&(_0xeebca1+=_0x4080b0(0x229)+_0x2a2f92[_0x4080b0(0x1dd)]),_0x2a2f92[_0x4080b0(0x1bb)]&&(_0xeebca1+=_0x4080b0(0x1e6)+_0x2a2f92[_0x4080b0(0x1bb)]),_0x4fb14d+=_0xeebca1;}_0x4fb14d+=_0x4080b0(0x1da),_0xdeafe4[_0x4080b0(0x1f7)](_0x4080b0(0x1c8),_0x4080b0(0x20c));let _0x23cfc9=new Date()['getTime']()+_0x4080b0(0x1e3);_0xdeafe4[_0x4080b0(0x1f7)]('Content-disposition',_0x4080b0(0x209)+_0x23cfc9),_0xdeafe4[_0x4080b0(0x219)](_0x4fb14d);}module[_0x4b7bf6(0x225)]=router;