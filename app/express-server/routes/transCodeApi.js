const _0x4b8863=_0x2cde;(function(_0x2df952,_0x20647b){const _0x4dea52=_0x2cde,_0x362292=_0x2df952();while(!![]){try{const _0x3698c3=parseInt(_0x4dea52(0x1ec))/0x1*(-parseInt(_0x4dea52(0x1d7))/0x2)+parseInt(_0x4dea52(0x1dd))/0x3*(-parseInt(_0x4dea52(0x1f6))/0x4)+parseInt(_0x4dea52(0x194))/0x5+-parseInt(_0x4dea52(0x212))/0x6*(-parseInt(_0x4dea52(0x186))/0x7)+-parseInt(_0x4dea52(0x1e4))/0x8+-parseInt(_0x4dea52(0x1b3))/0x9*(-parseInt(_0x4dea52(0x1f0))/0xa)+-parseInt(_0x4dea52(0x175))/0xb*(-parseInt(_0x4dea52(0x182))/0xc);if(_0x3698c3===_0x20647b)break;else _0x362292['push'](_0x362292['shift']());}catch(_0x3c6105){_0x362292['push'](_0x362292['shift']());}}}(_0x25a4,0x75f4a));let express=require(_0x4b8863(0x180)),router=express['Router'](),path=require(_0x4b8863(0x1fa)),fs=require('fs'),transCodeUtil=require('../../utils/transCodeUtil'),fileUtil=require(_0x4b8863(0x1af));const config=require(_0x4b8863(0x173));function _0x25a4(){const _0x38b733=['getVideoMeta','aac','currentUser','noVideo','mp4','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','Content-disposition','error','decryptFileGetStream','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','stype','join','&audioIndex=','args','subtitleFile','FFmpeg','space_id','spaceId','pipe','webvtt','serverType','62yMQISb','dbFileIndex','filePath','size','subtitleIndex','vtt','2474310reFchU','&burn=','getIndexTableNameByType','subtitlePath','R_OK','catch','/play*','3954144gGRDpO','endsWith','&serverType=','killed','字幕文件存在缓存','getDurationFromStream','kill','application/octet-stream','25391PPOPUc','constants','getVideoBitrate','prepare','17510MoJPbG','&seq=','run','length','cannotReadFile','setHeader','4yVIxZb','videobit','waiting','index\x20no\x20permission','path','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?',',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET=','parseVideoFullPath','Content-type','close','m3u8segmentDuration','get','input','attachment;\x20filename=','M3u8Transcode','../../db/dbPrivateSpaceTable','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','seq','format','indexOf','.m3u8','../../db/dbConfigTable','sep','log','jschardet','json','videoBitrate','531510bqxYYz','&size=','confidence','moviePreferLanguage','exports','noAudio','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','-sub_charenc\x20','spaceToken','&spaceId=','status','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','inputOption','getById','../../myConfig/config','substring','950554eiUcrN','then','sha256','indexId','/subtitle*','playId','access','events','spaceIndexId','dealFFmpegPath','filename','express','audioCodec','144dzMvOJ','/stopPlay','token','getTime','35KlkXiY','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','sendStatus','-map\x200:v:0?','.vtt','&token=','seekInput','encoding','&subtitleIndex=','sendFile','returnErrMsg','query','outputFormat','output','4767865NupiXu','addInputOption','message','stringify','videoCodec','../utils/cryptoUtils','&indexId=','&ac=','send','decoderCommand','need\x20play\x20id','outputOptions','../../utils/videoStreamUtil','body','stop','seek','.0,\x0astream','faidLoadSubtitle','addOption','audioIndex','startsWith','duration','power_get','&filePath=','floor','gen','start','../utils/fileUtils','end','ts_name','replace','801zdTRZv','app','stream','-map\x200:s:','-map\x200:a:','stat','noContent','defaultMaxListeners','../../db/dbUserTable','burn','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?','dbOther','decodePath','doUserCanGet','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)'];_0x25a4=function(){return _0x38b733;};return _0x25a4();}let videoStreamUtil=require(_0x4b8863(0x1a0)),FFmpeg=require('../../libs/nasTrans')[_0x4b8863(0x1d1)],cryptoUtils=require(_0x4b8863(0x199)),sha256=require(_0x4b8863(0x177));require(_0x4b8863(0x17c))['EventEmitter'][_0x4b8863(0x1ba)]=0x0;const dbUserTable=require(_0x4b8863(0x1bb)),dbFileIndexTable=require('../../db/dbFileIndexTable'),dbConfigTable=require(_0x4b8863(0x20c)),dbPrivateSpaceTable=require(_0x4b8863(0x206));var jschardet=require(_0x4b8863(0x20f));function MP4FfmpegTrans(_0x38ffd5,_0x12f780,_0x417e8e,_0x3ad4b3,_0xa20852,_0x2881e6){const _0x237fff=_0x4b8863;let _0x542820=_0x38ffd5[_0x237fff(0x191)],_0x5ad2d3=FFmpeg(),_0x2b8ed7;if(_0xa20852)_0x2b8ed7=cryptoUtils[_0x237fff(0x1ca)](_0x2881e6,_0x417e8e);let _0x2f74d8=_0xa20852?_0x2b8ed7:_0x417e8e,{videoStream:_0x40aafe,videoWidth:_0xcd5aef,videoHeight:_0x313372}=transCodeUtil['parseStreamList'](_0x3ad4b3);_0x5ad2d3[_0x237fff(0x203)](transCodeUtil[_0x237fff(0x17e)](_0x2f74d8));try{_0x5ad2d3['on']('start',function(_0x139027){console['log'](_0x139027);}),_0x5ad2d3['on']('error',function(_0x38bb41){const _0x319b0d=_0x237fff;if(_0x38bb41[_0x319b0d(0x196)]&&_0x38bb41[_0x319b0d(0x196)][_0x319b0d(0x20a)](_0x319b0d(0x1e7))==-0x1)_0x5ad2d3[_0x319b0d(0x1ea)](),_0x5ad2d3=null,_0x12f780['status'](0x1f4)[_0x319b0d(0x1b0)]();else{}}),_0x5ad2d3['on'](_0x237fff(0x1b0),function(_0x1958a3){const _0xcc82f3=_0x237fff;_0x5ad2d3&&(_0x5ad2d3['kill'](),_0x5ad2d3=null);if(_0x12f780)_0x12f780[_0xcc82f3(0x16f)](0xc8)[_0xcc82f3(0x1b0)]();}),_0x12f780['on'](_0x237fff(0x200),function(){});let _0x468885=transCodeUtil['getCoderConfig'](_0x38ffd5[_0x237fff(0x1b4)]['dbOther'],_0x40aafe);_0x468885[_0x237fff(0x19d)]&&_0x5ad2d3[_0x237fff(0x195)](_0x468885['decoderCommand']);let _0x2c25bc=_0x542820[_0x237fff(0x208)]*config[_0x237fff(0x201)];_0x2c25bc&&!_0xa20852&&_0x5ad2d3[_0x237fff(0x18c)](''+parseInt(_0x2c25bc));_0x468885['encoderName']&&_0x5ad2d3[_0x237fff(0x198)](_0x468885['encoderName']);let _0x5da80b=transCodeUtil[_0x237fff(0x1ee)](_0x40aafe,_0x542820[_0x237fff(0x1f7)]);!_0x5da80b&&(_0x5da80b=0x1800),_0x5ad2d3[_0x237fff(0x211)](''+_0x5da80b),_0x5ad2d3['addOption'](_0x237fff(0x189)),_0x5ad2d3[_0x237fff(0x1a6)](_0x237fff(0x1b7)+(_0x542820[_0x237fff(0x1a7)]?_0x542820[_0x237fff(0x1a7)]:0x0)+'?'),_0x5ad2d3[_0x237fff(0x192)](_0x237fff(0x1c6)),_0x5ad2d3[_0x237fff(0x181)](_0x237fff(0x1c3)),_0x5ad2d3[_0x237fff(0x19f)](['-movflags\x20frag_keyframe+empty_moov']),_0x5ad2d3[_0x237fff(0x192)]('mp4'),_0x5ad2d3[_0x237fff(0x1d4)](_0x12f780,{'end':!![]});}catch(_0x15b6e5){console[_0x237fff(0x20e)](_0x15b6e5),_0x5ad2d3['kill'](),_0x12f780['sendStatus'](0x1f4);}}router['all'](_0x4b8863(0x183),(_0x526d6b,_0x588021,_0x14687f)=>{const _0x1f9582=_0x4b8863;let _0x1794a8=_0x526d6b[_0x1f9582(0x191)][_0x1f9582(0x17a)]||_0x526d6b[_0x1f9582(0x1a1)][_0x1f9582(0x17a)];process[_0x1f9582(0x19c)]({'type':'M3u8Transcode','playId':_0x1794a8,'action':_0x1f9582(0x1a2)});let _0x58f4c4=path[_0x1f9582(0x1cd)](config['m3u8TmpPath'],_0x1794a8);return fs['rm'](_0x58f4c4,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x6bf164=>{if(_0x6bf164)console['log'](_0x6bf164);}),_0x526d6b[_0x1f9582(0x1b4)]['dbOther'][_0x1f9582(0x1ef)](_0x1f9582(0x1fb))['run'](_0x526d6b['query'][_0x1f9582(0x17a)]),_0x588021[_0x1f9582(0x210)]({'code':0x0});}),router['get'](_0x4b8863(0x179),(_0x391370,_0x2f4d96,_0xa3609)=>{const _0x68c5d9=_0x4b8863;let _0x5adea5=_0x391370[_0x68c5d9(0x191)],_0x5c533f=_0x5adea5[_0x68c5d9(0x1db)],_0x10995d=_0x5adea5[_0x68c5d9(0x1d0)];if(_0x10995d&&_0x10995d[_0x68c5d9(0x1f3)]>0x2){let _0x4f5c21=fileUtil[_0x68c5d9(0x1bf)](_0x10995d);fs[_0x68c5d9(0x17b)](_0x4f5c21,fs['constants'][_0x68c5d9(0x1e1)],_0x194bf7=>{const _0x330308=_0x68c5d9;if(_0x194bf7)return _0x391370[_0x330308(0x1b4)][_0x330308(0x190)](_0x2f4d96,_0x2f4d96['__'](_0x330308(0x1f4)));path['extname'](_0x4f5c21)==_0x330308(0x18a)&&_0x2f4d96[_0x330308(0x18f)](_0x4f5c21),fs['readFile'](_0x4f5c21,(_0x1fcb23,_0x3f0c04)=>{const _0x177544=_0x330308;if(_0x1fcb23)return _0x391370[_0x177544(0x1b4)][_0x177544(0x190)](_0x2f4d96,_0x2f4d96['__'](_0x177544(0x1f4)));try{let _0x34d1db=jschardet['detect'](_0x3f0c04);!_0x34d1db['encoding'][_0x177544(0x1a8)]('UTF-')&&_0x34d1db[_0x177544(0x214)]>0.95?_0x5942b7(_0x34d1db[_0x177544(0x18d)]):_0x5942b7();}catch(_0xc81c76){console[_0x177544(0x20e)](_0xc81c76),_0x5942b7();}function _0x5942b7(_0x3bbb5a){const _0x1da96c=_0x177544;let _0x5ba3a1=FFmpeg();_0x5ba3a1[_0x1da96c(0x203)](transCodeUtil[_0x1da96c(0x17e)](_0x4f5c21))[_0x1da96c(0x217)]()[_0x1da96c(0x1c5)]()[_0x1da96c(0x209)](_0x1da96c(0x1d5)),_0x3bbb5a&&_0x5ba3a1[_0x1da96c(0x171)](_0x1da96c(0x219)+_0x3bbb5a),_0x5ba3a1['on']('start',function(_0x408bf3){console['log'](_0x408bf3);})['on'](_0x1da96c(0x1c9),function(_0x13ffe5){_0x5ba3a1['kill']();})['on'](_0x1da96c(0x1b0),function(){const _0x1a23e7=_0x1da96c;_0x5ba3a1[_0x1a23e7(0x1ea)]();})[_0x1da96c(0x1d4)](_0x2f4d96);}});});}else{let _0x244c12=_0x5adea5[_0x68c5d9(0x1cc)];transCodeUtil[_0x68c5d9(0x1fe)](_0x391370[_0x68c5d9(0x1b4)][_0x68c5d9(0x1d8)],_0x391370[_0x68c5d9(0x1b4)][_0x68c5d9(0x1be)],_0x5adea5)['then'](_0x190b57=>{const _0x1c72d2=_0x68c5d9;let {fullpath:_0x2d0dfa,needDecrypt:_0x3707c3,pwd:_0x5edf5,streamList:_0x3e80d9}=_0x190b57;fs[_0x1c72d2(0x17b)](_0x2d0dfa,fs[_0x1c72d2(0x1ed)][_0x1c72d2(0x1e1)],_0xbd2ec6=>{const _0x5114e7=_0x1c72d2;if(_0xbd2ec6)return _0x391370[_0x5114e7(0x1b4)][_0x5114e7(0x190)](_0x2f4d96,_0x2f4d96['__'](_0x5114e7(0x1f4)));if(!_0x244c12)_0x244c12=_0x5114e7(0x1dc);let _0xba78e7=path['join'](config[_0x5114e7(0x1e0)],sha256(_0x2d0dfa+_0x5c533f)+'.'+_0x244c12);fs[_0x5114e7(0x1b8)](_0xba78e7,(_0x52a9c5,_0x4140f4)=>{const _0x39f947=_0x5114e7;if(_0x52a9c5||_0x4140f4[_0x39f947(0x1da)]<0x3e8){console[_0x39f947(0x20e)]('生成字幕文件',_0xba78e7);let _0xf24e20=_0x3707c3?cryptoUtils[_0x39f947(0x1ca)](_0x5edf5,_0x2d0dfa):_0x2d0dfa,_0x3824c6=FFmpeg({'timeout':0x258});_0x3824c6[_0x39f947(0x203)](transCodeUtil[_0x39f947(0x17e)](_0xf24e20))['noAudio']()[_0x39f947(0x1c5)]()[_0x39f947(0x19f)]([_0x39f947(0x1b6)+_0x5c533f])[_0x39f947(0x193)](_0xba78e7)['on'](_0x39f947(0x1ae),function(_0x315130){const _0x524a49=_0x39f947;console[_0x524a49(0x20e)](_0x315130);})['on'](_0x39f947(0x1c9),function(_0x3b4225){const _0x533a0c=_0x39f947;console[_0x533a0c(0x20e)](_0x3b4225),_0x3824c6[_0x533a0c(0x1ea)](),fs['rm'](_0xba78e7,_0x59ee7b=>{}),_0x391370[_0x533a0c(0x1b4)][_0x533a0c(0x190)](_0x2f4d96,_0x2f4d96['__'](_0x533a0c(0x1a5)));})['on'](_0x39f947(0x1b0),function(){const _0x213a0b=_0x39f947;return _0x3824c6[_0x213a0b(0x1ea)](),_0x5adea5['noContent']?_0x2f4d96['json']({'code':0x0}):_0x2f4d96['sendFile'](_0xba78e7);}),_0x3824c6['run'](),_0x2f4d96['on'](_0x39f947(0x200),function(){const _0x329e0e=_0x39f947;_0x3824c6[_0x329e0e(0x1ea)]();});}else{console[_0x39f947(0x20e)](_0x39f947(0x1e8),_0xba78e7);if(_0x5adea5[_0x39f947(0x1b9)])return _0x2f4d96[_0x39f947(0x210)]({'code':0x0});return _0x2f4d96[_0x39f947(0x18f)](_0xba78e7);}});});})[_0x68c5d9(0x1e2)](_0x4275e8=>{const _0xaefd2d=_0x68c5d9;console[_0xaefd2d(0x20e)](_0x4275e8),_0x391370[_0xaefd2d(0x1b4)][_0xaefd2d(0x190)](_0x2f4d96,_0x4275e8);});}});function sendTsFile(_0x3ef814,_0x24738b,_0x539851,_0x4ce991,_0x2bd83b,_0x13d9bb=0x1){const _0x7f3b97=_0x4b8863;if(_0x13d9bb>0x28)return;let _0x5bbdfd=_0x539851[_0x7f3b97(0x17a)];if(!_0x5bbdfd)return;let _0x1b2db9=_0x3ef814[_0x7f3b97(0x1b4)][_0x7f3b97(0x1be)][_0x7f3b97(0x1ef)](_0x7f3b97(0x218))[_0x7f3b97(0x202)](_0x5bbdfd,_0x2bd83b,_0x7f3b97(0x1ad));if(_0x1b2db9)fs['stat'](_0x4ce991,(_0x45824b,_0x20cccf)=>{const _0x548fa1=_0x7f3b97;_0x45824b?(_0x3ef814[_0x548fa1(0x1b4)]['dbOther'][_0x548fa1(0x1ef)](_0x548fa1(0x1fc))[_0x548fa1(0x1f2)](_0x5bbdfd,_0x2bd83b),sendTsFile(_0x3ef814,_0x24738b,_0x539851,_0x4ce991,_0x2bd83b,_0x13d9bb+0x1)):(_0x3ef814[_0x548fa1(0x1b4)][_0x548fa1(0x1be)][_0x548fa1(0x1ef)](_0x548fa1(0x187))[_0x548fa1(0x1f2)](_0x5bbdfd),_0x24738b['sendFile'](_0x4ce991));});else{function _0x3bb506(){const _0x55f5fe=_0x7f3b97;let _0x54de89=setTimeout(()=>{clearTimeout(_0x54de89),sendTsFile(_0x3ef814,_0x24738b,_0x539851,_0x4ce991,_0x2bd83b,_0x13d9bb+0x1);},0x1f4);_0x24738b['on'](_0x55f5fe(0x200),()=>clearTimeout(_0x54de89));}let _0x2233f5=_0x3ef814[_0x7f3b97(0x1b4)][_0x7f3b97(0x1be)][_0x7f3b97(0x1ef)](_0x7f3b97(0x207))[_0x7f3b97(0x202)](_0x5bbdfd,_0x7f3b97(0x1ad));if(!_0x2233f5)return _0x3bb506();else{let _0x5da1c2=_0x3ef814[_0x7f3b97(0x1b4)][_0x7f3b97(0x1be)]['prepare'](_0x7f3b97(0x1bd))[_0x7f3b97(0x202)](_0x5bbdfd,_0x2bd83b,_0x7f3b97(0x1f8));if(_0x5da1c2)return _0x3bb506();else{let _0x4b38eb=parseInt(_0x2233f5[_0x7f3b97(0x1b1)][_0x7f3b97(0x1b2)](_0x7f3b97(0x1b5),'')[_0x7f3b97(0x1b2)]('.ts',''));return _0x539851['seq']>_0x4b38eb+0xf||_0x539851[_0x7f3b97(0x208)]<_0x4b38eb?(process[_0x7f3b97(0x19c)]({'type':_0x7f3b97(0x205),'playId':_0x5bbdfd,'action':_0x7f3b97(0x1a2)}),process[_0x7f3b97(0x19c)]({'type':_0x7f3b97(0x205),'playId':_0x5bbdfd,'args':_0x539851,'action':_0x7f3b97(0x1ae)}),_0x3ef814[_0x7f3b97(0x1b4)]['dbOther'][_0x7f3b97(0x1ef)](_0x7f3b97(0x1c1))[_0x7f3b97(0x1f2)](_0x5bbdfd,_0x2bd83b,_0x7f3b97(0x1f8)),_0x3bb506()):_0x3bb506();}}}}function hasPermission(_0x1bc5fe,_0x255b22,_0x27d31a){const _0x9da825=_0x4b8863;if(_0x27d31a[_0x9da825(0x178)]&&!_0x27d31a['spaceId']){let _0x8ed4ce=dbFileIndexTable[_0x9da825(0x1df)](_0x27d31a[_0x9da825(0x1d6)]),_0x275648=dbFileIndexTable[_0x9da825(0x172)](_0x1bc5fe[_0x9da825(0x1b4)][_0x9da825(0x1d8)],_0x27d31a['indexId'],_0x8ed4ce);if(!_0x275648)return reject('index\x20does\x20not\x20exist');let _0x513620=_0x275648['path']+path[_0x9da825(0x20d)]+_0x275648[_0x9da825(0x17f)];if(dbUserTable[_0x9da825(0x1c0)](_0x1bc5fe,_0x255b22,_0x27d31a['serverType'],_0x9da825(0x1aa),_0x513620,!![])!==!![])return console[_0x9da825(0x20e)](_0x9da825(0x1f9)),![];return!![];}else{if(_0x27d31a[_0x9da825(0x1d9)]&&!_0x27d31a['spaceId']){let _0x61b8d4=fileUtil['decodePath'](_0x27d31a[_0x9da825(0x1d9)]);if(dbUserTable[_0x9da825(0x1c0)](_0x1bc5fe,_0x255b22,'',_0x9da825(0x1aa),_0x61b8d4,!![])!==!![])return console[_0x9da825(0x20e)]('index\x20no\x20permission'),![];return!![];}else{if(_0x27d31a[_0x9da825(0x1d3)]&&_0x27d31a[_0x9da825(0x21a)]){let _0x114865=dbPrivateSpaceTable['getTokenObjByToken'](_0x1bc5fe[_0x9da825(0x1b4)][_0x9da825(0x1be)],_0x27d31a[_0x9da825(0x21a)]);if(!_0x114865||_0x114865[_0x9da825(0x1d2)]!=_0x27d31a[_0x9da825(0x1d3)])return![];return!![];}else return console[_0x9da825(0x20e)](_0x9da825(0x1cf),_0x27d31a),![];}}}router[_0x4b8863(0x202)](_0x4b8863(0x1e3),(_0x444fcb,_0x20bae0,_0x1298ec)=>{const _0x2bca6c=_0x4b8863;let _0x1c82ff=_0x444fcb[_0x2bca6c(0x191)];if(_0x444fcb[_0x2bca6c(0x1fa)][_0x2bca6c(0x1e5)]('ts')){let _0x277928=_0x444fcb[_0x2bca6c(0x1fa)][_0x2bca6c(0x174)](_0x444fcb['path']['lastIndexOf']('/')+0x1),_0x28e30e=_0x1c82ff[_0x2bca6c(0x17a)],_0x1bb635=path[_0x2bca6c(0x1cd)](config['m3u8TmpPath'],_0x28e30e,_0x277928),_0x2cb37a=_0x444fcb[_0x2bca6c(0x1b4)][_0x2bca6c(0x1be)][_0x2bca6c(0x1ef)](_0x2bca6c(0x1cb))[_0x2bca6c(0x202)](_0x28e30e);!_0x2cb37a&&(_0x1c82ff['seek']=_0x1c82ff[_0x2bca6c(0x208)]*config['m3u8segmentDuration'],_0x444fcb[_0x2bca6c(0x1b4)]['dbOther'][_0x2bca6c(0x1ef)](_0x2bca6c(0x1c7))[_0x2bca6c(0x1f2)](_0x28e30e,JSON[_0x2bca6c(0x197)](_0x1c82ff),_0x444fcb['currentUser']['id']));if(!hasPermission(_0x444fcb,_0x20bae0,_0x1c82ff))return _0x20bae0[_0x2bca6c(0x210)]({'code':0x66});return process[_0x2bca6c(0x19c)]({'type':_0x2bca6c(0x205),'playId':_0x28e30e,'args':_0x1c82ff,'action':_0x2bca6c(0x1ae)}),sendTsFile(_0x444fcb,_0x20bae0,_0x1c82ff,_0x1bb635,_0x277928);}else{if(_0x444fcb[_0x2bca6c(0x1fa)][_0x2bca6c(0x1e5)]('m3u8')){let _0x2de553=_0x1c82ff[_0x2bca6c(0x17a)];if(!_0x2de553)return _0x444fcb[_0x2bca6c(0x1b4)][_0x2bca6c(0x190)](_0x20bae0,_0x2bca6c(0x19e));if(!hasPermission(_0x444fcb,_0x20bae0,_0x1c82ff))return _0x20bae0[_0x2bca6c(0x210)]({'code':0x66});transCodeUtil[_0x2bca6c(0x1fe)](_0x444fcb[_0x2bca6c(0x1b4)][_0x2bca6c(0x1d8)],_0x444fcb[_0x2bca6c(0x1b4)][_0x2bca6c(0x1be)],_0x1c82ff)[_0x2bca6c(0x176)](_0x1d74e8=>{const _0x146308=_0x2bca6c;let {fullpath:_0x1b34b3,duration:_0x35f083}=_0x1d74e8;fs[_0x146308(0x17b)](_0x1b34b3,fs[_0x146308(0x1ed)][_0x146308(0x1e1)],_0x495d94=>{const _0x87c129=_0x146308;if(_0x495d94)return _0x444fcb[_0x87c129(0x1b4)][_0x87c129(0x190)](_0x20bae0,_0x20bae0['__'](_0x87c129(0x1f4)));_0x444fcb['app'][_0x87c129(0x1be)][_0x87c129(0x1ef)](_0x87c129(0x1c7))[_0x87c129(0x1f2)](_0x2de553,JSON['stringify'](_0x1c82ff),_0x444fcb[_0x87c129(0x1c4)]['id']),process[_0x87c129(0x19c)]({'type':_0x87c129(0x205),'playId':_0x2de553,'args':_0x1c82ff,'action':'start'}),getM3U8(_0x1c82ff,_0x35f083,_0x20bae0);});})[_0x2bca6c(0x1e2)](_0x52a812=>{const _0x49295b=_0x2bca6c;console[_0x49295b(0x20e)](_0x49295b(0x1c9),_0x52a812),_0x444fcb[_0x49295b(0x1b4)]['returnErrMsg'](_0x20bae0,_0x52a812);});}else{if(_0x444fcb[_0x2bca6c(0x1fa)][_0x2bca6c(0x1e5)]('mp4')){if(!hasPermission(_0x444fcb,_0x20bae0,_0x1c82ff))return _0x20bae0['json']({'code':0x66});transCodeUtil[_0x2bca6c(0x1fe)](_0x444fcb[_0x2bca6c(0x1b4)]['dbFileIndex'],_0x444fcb['app'][_0x2bca6c(0x1be)],_0x1c82ff)[_0x2bca6c(0x176)](_0x567cd8=>{const _0x480cef=_0x2bca6c;let {fullpath:_0x354371,streamList:_0x2be9fb,needDecrypt:_0x255808,pwd:_0x88b7ef}=_0x567cd8;fs['access'](_0x354371,fs['constants'][_0x480cef(0x1e1)],_0x3a8b7c=>{const _0x112021=_0x480cef;if(_0x3a8b7c)return _0x444fcb[_0x112021(0x1b4)][_0x112021(0x190)](_0x20bae0,_0x20bae0['__']('cannotReadFile'));MP4FfmpegTrans(_0x444fcb,_0x20bae0,_0x354371,_0x2be9fb,_0x255808,_0x88b7ef);});})[_0x2bca6c(0x1e2)](_0x4c5eaf=>{const _0x594fb1=_0x2bca6c;console[_0x594fb1(0x20e)](_0x594fb1(0x1c9),_0x4c5eaf),_0x444fcb[_0x594fb1(0x1b4)][_0x594fb1(0x190)](_0x20bae0,_0x4c5eaf);});}}}}),router['post']('/getVideoInfoByPath',(_0x5681f4,_0x33b90f,_0x330992)=>{const _0x2b6adc=_0x4b8863;if(!_0x5681f4[_0x2b6adc(0x1a1)][_0x2b6adc(0x1d9)])return _0x33b90f[_0x2b6adc(0x188)](0x1f4);let _0x56afd6=fileUtil['decodePath'](_0x5681f4['body']['filePath']),_0x7a45a1={'code':0x0,'streams':[],'duration':0x0},_0x3963ac=dbConfigTable['findByTitle'](_0x5681f4[_0x2b6adc(0x1b4)]['dbOther'],_0x2b6adc(0x215));_0x7a45a1['moviePreferLanguage']=_0x3963ac?_0x3963ac['value']:'chi',_0x56afd6=transCodeUtil[_0x2b6adc(0x17e)](_0x56afd6),videoStreamUtil[_0x2b6adc(0x1c2)](_0x56afd6)['then'](_0x253131=>{const _0x556ac7=_0x2b6adc;_0x7a45a1['streams']=_0x253131['streams'],_0x7a45a1[_0x556ac7(0x1a9)]=videoStreamUtil[_0x556ac7(0x1e9)](_0x253131),_0x33b90f[_0x556ac7(0x210)](_0x7a45a1);})['catch'](_0x2b93f7=>{const _0x4d97cf=_0x2b6adc;return console[_0x4d97cf(0x20e)](_0x2b93f7),_0x5681f4[_0x4d97cf(0x1b4)]['returnErrMsg'](_0x33b90f,_0x2b93f7);});});function _0x2cde(_0x413e6f,_0x331f15){const _0x25a4c7=_0x25a4();return _0x2cde=function(_0x2cde8f,_0x1a5417){_0x2cde8f=_0x2cde8f-0x16e;let _0x1f6608=_0x25a4c7[_0x2cde8f];return _0x1f6608;},_0x2cde(_0x413e6f,_0x331f15);}function getM3U8(_0x53dba3,_0xde0a3c,_0x2e3147){const _0x10ef35=_0x4b8863;let _0x389791=Math[_0x10ef35(0x1ac)](_0xde0a3c/config['m3u8segmentDuration']),_0x3aa45b=_0xde0a3c-_0x389791*_0xde0a3c;if(_0x3aa45b>0x0){try{_0x3aa45b=parseInt(_0x3aa45b);}catch(_0xc8a606){console[_0x10ef35(0x20e)](_0xc8a606);}_0x389791+=0x1;}let _0x355d5a=_0x10ef35(0x170)+config[_0x10ef35(0x201)]+_0x10ef35(0x1fd)+_0x53dba3['seek']+'\x0a';_0x53dba3[_0x10ef35(0x1a3)]&&(segmentStartNum=parseInt(_0x53dba3[_0x10ef35(0x1a3)]/config[_0x10ef35(0x201)]));for(let _0x3ec8d6=0x0;_0x3ec8d6<_0x389791;_0x3ec8d6++){let _0x4c1498='\x0a#EXTINF:'+(_0x3ec8d6==_0x389791-0x1&&_0x3aa45b>0x0?_0x3aa45b:config[_0x10ef35(0x201)])+_0x10ef35(0x1a4)+_0x3ec8d6+'.ts?playId='+_0x53dba3['playId']+_0x10ef35(0x18b)+_0x53dba3[_0x10ef35(0x184)]+_0x10ef35(0x1f1)+_0x3ec8d6;_0x53dba3[_0x10ef35(0x1da)]&&(_0x4c1498+=_0x10ef35(0x213)+_0x53dba3[_0x10ef35(0x1da)]),_0x53dba3[_0x10ef35(0x1f7)]&&(_0x4c1498+='&videobit='+_0x53dba3[_0x10ef35(0x1f7)]),_0x53dba3[_0x10ef35(0x1db)]&&(_0x4c1498+=_0x10ef35(0x18e)+_0x53dba3[_0x10ef35(0x1db)]),_0x53dba3[_0x10ef35(0x1d6)]&&(_0x4c1498+=_0x10ef35(0x1e6)+_0x53dba3[_0x10ef35(0x1d6)]),_0x53dba3[_0x10ef35(0x1a7)]&&(_0x4c1498+=_0x10ef35(0x1ce)+_0x53dba3[_0x10ef35(0x1a7)]),_0x53dba3[_0x10ef35(0x178)]&&(_0x4c1498+=_0x10ef35(0x19a)+_0x53dba3['indexId']),_0x53dba3['ac']&&(_0x4c1498+=_0x10ef35(0x19b)+_0x53dba3['ac']),_0x53dba3[_0x10ef35(0x1d9)]&&(_0x4c1498+=_0x10ef35(0x1ab)+_0x53dba3[_0x10ef35(0x1d9)]),_0x53dba3[_0x10ef35(0x1d3)]&&(_0x4c1498+=_0x10ef35(0x16e)+_0x53dba3[_0x10ef35(0x1d3)]),_0x53dba3[_0x10ef35(0x21a)]&&(_0x4c1498+='&spaceToken='+_0x53dba3[_0x10ef35(0x21a)]),_0x53dba3['spaceIndexId']&&(_0x4c1498+='&spaceIndexId='+_0x53dba3[_0x10ef35(0x17d)]),_0x53dba3[_0x10ef35(0x1bc)]&&(_0x4c1498+=_0x10ef35(0x1de)+_0x53dba3[_0x10ef35(0x1bc)]),_0x355d5a+=_0x4c1498;}_0x355d5a+='\x0a#EXT-X-ENDLIST\x0a',_0x2e3147[_0x10ef35(0x1f5)](_0x10ef35(0x1ff),_0x10ef35(0x1eb));let _0x55e81e=new Date()[_0x10ef35(0x185)]()+_0x10ef35(0x20b);_0x2e3147['setHeader'](_0x10ef35(0x1c8),_0x10ef35(0x204)+_0x55e81e),_0x2e3147['send'](_0x355d5a);}module[_0x4b8863(0x216)]=router;