const _0x248b32=_0x1215;(function(_0x4fc21d,_0x40087d){const _0x465654=_0x1215,_0x16e3fe=_0x4fc21d();while(!![]){try{const _0x39ba43=parseInt(_0x465654(0xb5))/0x1+-parseInt(_0x465654(0x98))/0x2+parseInt(_0x465654(0x9d))/0x3+-parseInt(_0x465654(0xb2))/0x4+parseInt(_0x465654(0x90))/0x5*(-parseInt(_0x465654(0xa6))/0x6)+-parseInt(_0x465654(0x96))/0x7+parseInt(_0x465654(0xc0))/0x8;if(_0x39ba43===_0x40087d)break;else _0x16e3fe['push'](_0x16e3fe['shift']());}catch(_0x3b674f){_0x16e3fe['push'](_0x16e3fe['shift']());}}}(_0x1550,0xd21b7));let express=require(_0x248b32(0xa0)),router=express[_0x248b32(0xab)](),path=require(_0x248b32(0xb6));const dbUserTable=require(_0x248b32(0xa1)),dbFileIndexTable=require('../../db/dbFileIndexTable');let fs=require('fs'),piexif=require(_0x248b32(0xbf)),geohash=require(_0x248b32(0x94));function _0x1215(_0x3198e5,_0x3bfbdf){const _0x1550d7=_0x1550();return _0x1215=function(_0x12150c,_0x12dab9){_0x12150c=_0x12150c-0x8d;let _0x1772d5=_0x1550d7[_0x12150c];return _0x1772d5;},_0x1215(_0x3198e5,_0x3bfbdf);}function _0x1550(){const _0x3dc278=['path','indexIdList','is_admin','length','\x20size=?,ctime=?\x20','substring','GPSLongitude','writeFile','GPS','piexifjs','27960536Sqfmnz','currentUser','from','\x20order\x20by\x20abs(original_time-?)\x20asc\x20limit\x2050','insert','data','GPSIFD','mtime','toString','filename','getAllByWhere','latitude','dump','log','prepare','SKIP','doUserCanGet','abs','push','\x20\x20latitude\x20is\x20not\x20null\x20and\x20latitude!=\x27undefined\x27\x20and\x20geohash5\x20!=\x27undefined\x27\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20and\x20(width>=?\x20or\x20height>=?)\x20\x20','updateBySql','UPDATE\x20file_index_photo\x20set\x20add_gps_status=1\x20WHERE\x20id\x20IN\x20','stat','undefined','dbFileIndex','isFile','original_time','app','247155pCWldh','post','/getWaitAddGpsIndex','encode','ngeohash','load','8357587YISdYg','run','995872MmhpMz','GPSLatitudeRef','photo','CONFIRM','fullPath','1723041CmbZiB','add_gps_status','whereStr','express','../../db/dbUserTable','round','INDEX_TABLE_NAME_PHOTO','power_change','body','54QSDjhg','getById','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20(width>=?\x20and\x20height>=?)\x20','json','power_get','Router','floor','join','updateById','ctimeMs','utimes','mode','5286848YxSRqo','getUserPathWhere','binary','249653wyXAuo'];_0x1550=function(){return _0x3dc278;};return _0x1550();}function getWaitAddGpsIndex(_0x492d02,_0x11eb03,_0x33d7ad){const _0x1a1043=_0x248b32;let _0xb870ad=0x7d0,_0x379e9c=_0x1a1043(0xa8)+_0x11eb03,_0xd82600=[parseInt(_0xb870ad),parseInt(_0xb870ad),..._0x33d7ad],_0x1a6f4e=dbFileIndexTable['getByWhere'](_0x492d02,_0x379e9c,'*',dbFileIndexTable[_0x1a1043(0xa3)],_0xd82600);if(_0x1a6f4e){let _0x253c56=_0x1a6f4e['original_time']-0xe10*0x3e8*0xc,_0x41c757=_0x1a6f4e[_0x1a1043(0x8e)]+0xe10*0x3e8*0xc,_0x5f576f=_0x1a1043(0xd3)+_0x11eb03+_0x1a1043(0xc3),_0x40b6d3=[parseInt(_0x253c56),parseInt(_0x41c757),parseInt(_0xb870ad),parseInt(_0xb870ad),..._0x33d7ad,parseInt(_0x1a6f4e[_0x1a1043(0x8e)])],_0x1756c7=dbFileIndexTable[_0x1a1043(0xca)](_0x492d02,_0x5f576f,'*',dbFileIndexTable[_0x1a1043(0xa3)],_0x40b6d3);if(_0x1756c7&&_0x1756c7[_0x1a1043(0xb9)]>0x0){let _0x1f540c=[];if(_0x1a6f4e[_0x1a1043(0xb1)]&&_0x1a6f4e['mode']!=_0x1a1043(0xd7)){let _0x27734e=0x32,_0xf268dc=_0x1a6f4e[_0x1a1043(0x8e)]-0xe10*0x3e8*0x3,_0x22eb51=_0x1a6f4e['original_time']+0xe10*0x3e8*0x3;if(_0x1a6f4e[_0x1a1043(0xb1)]&&_0x1a6f4e[_0x1a1043(0xb1)]!='undefined'){let _0x56911e='\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20mode=?\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20'+_0x11eb03+'\x20order\x20by\x20original_time\x20limit\x20?',_0x34f507=[_0x1a6f4e[_0x1a1043(0xb1)],parseInt(_0xf268dc),parseInt(_0x22eb51),..._0x33d7ad,parseInt(_0x27734e)];_0x1f540c=dbFileIndexTable[_0x1a1043(0xca)](_0x492d02,_0x56911e,'*',dbFileIndexTable[_0x1a1043(0xa3)],_0x34f507);}}else _0x1f540c[_0x1a1043(0xd2)](_0x1a6f4e);for(let _0x518a40 in _0x1f540c){_0x1f540c[_0x518a40][_0x1a1043(0x9c)]=path['join'](_0x1f540c[_0x518a40][_0x1a1043(0xb6)],_0x1f540c[_0x518a40][_0x1a1043(0xc9)]);}if(_0x1f540c['length']==0x1)return dbFileIndexTable[_0x1a1043(0xae)](_0x492d02,_0x1f540c[0x0]['id'],_0x1a1043(0x9e),0x1,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']),getWaitAddGpsIndex(_0x492d02,_0x11eb03,_0x33d7ad);return{'dealList':_0x1f540c,'nearIndex':_0x1756c7};}else return dbFileIndexTable[_0x1a1043(0xae)](_0x492d02,_0x1a6f4e['id'],_0x1a1043(0x9e),0x1,dbFileIndexTable[_0x1a1043(0xa3)]),getWaitAddGpsIndex(_0x492d02,_0x11eb03,_0x33d7ad);}else return![];}router[_0x248b32(0x91)](_0x248b32(0x92),(_0x17a02e,_0x123c72,_0x38c3c5)=>{const _0x4325f8=_0x248b32;let _0x320fc5={'code':0x0,'data':''};if(dbUserTable['doUserCanGet'](_0x17a02e,_0x123c72,'photo',_0x4325f8(0xaa))==!![]){let _0x257951='',_0x20a8b1=[];if(_0x17a02e[_0x4325f8(0xc1)][_0x4325f8(0xb8)]!=0x1){let _0x43a3a7=dbUserTable[_0x4325f8(0xb3)](_0x17a02e,_0x4325f8(0x9a),_0x4325f8(0xaa),!![]);_0x257951=_0x43a3a7[_0x4325f8(0x9f)],_0x20a8b1=_0x43a3a7['paramsList'];}let _0x3aaebc=getWaitAddGpsIndex(_0x17a02e[_0x4325f8(0x8f)]['dbFileIndex'],_0x257951,_0x20a8b1);return _0x3aaebc&&(_0x320fc5[_0x4325f8(0xc5)]=_0x3aaebc),_0x123c72['json'](_0x320fc5);}}),router[_0x248b32(0x91)]('/confirmAddGps',(_0x44ebe9,_0x13e313,_0x354181)=>{const _0x50607e=_0x248b32;let _0x44cb14=_0x44ebe9[_0x50607e(0xa5)]['type'],_0x37241a=_0x44ebe9[_0x50607e(0xa5)][_0x50607e(0xb7)];if(_0x37241a[_0x50607e(0xb9)]<0x1)return _0x13e313[_0x50607e(0xa9)]({'code':0x0});_0x356d91();function _0x356d91(){const _0xfb837e=_0x50607e;if(dbUserTable[_0xfb837e(0xd0)](_0x44ebe9,_0x13e313,'photo',_0xfb837e(0xa4))==!![]){let _0x5dd278='(';for(let _0xb5387f in _0x37241a){_0x5dd278+=_0x37241a[_0xb5387f],_0xb5387f!=_0x37241a['length']-0x1&&(_0x5dd278+=',');}_0x5dd278+=')';if(_0x44cb14==_0xfb837e(0xcf))return _0x44ebe9[_0xfb837e(0x8f)]['dbFileIndex']['prepare']('UPDATE\x20file_index_photo\x20set\x20add_gps_status=2\x20WHERE\x20id\x20IN\x20'+_0x5dd278+'\x20')[_0xfb837e(0x97)](),_0x13e313['json']({'code':0x0});else{if(_0x44cb14==_0xfb837e(0x9b)){let _0x3e6faa=_0x44ebe9[_0xfb837e(0xa5)][_0xfb837e(0xcb)],_0x161ace=_0x44ebe9[_0xfb837e(0xa5)]['longitude'];if(!_0x3e6faa||!_0x161ace)return _0x13e313[_0xfb837e(0xa9)]({'code':0x0});_0x44ebe9['app'][_0xfb837e(0xd8)][_0xfb837e(0xce)](_0xfb837e(0xd5)+_0x5dd278+'\x20')['run']();let _0x5b0c58=0x0,_0x1a324c=0x0;for(let _0x5b5de7 in _0x37241a){let _0x1ec714=dbFileIndexTable[_0xfb837e(0xa7)](_0x44ebe9['app'][_0xfb837e(0xd8)],_0x37241a[_0x5b5de7]);if(!_0x1ec714)continue;let _0xe5d3c7=path[_0xfb837e(0xad)](_0x1ec714[_0xfb837e(0xb6)],path['sep'],_0x1ec714[_0xfb837e(0xc9)]),_0x2b6dde=fs['statSync'](_0xe5d3c7);if(!_0x2b6dde[_0xfb837e(0x8d)]()){_0x1a324c+=0x1,_0x575468();continue;}fs['readFile'](_0xe5d3c7,(_0x46090a,_0x200ace)=>{const _0x218648=_0xfb837e;if(_0x46090a)return _0x1a324c+=0x1,_0x575468();let _0x4e74b0=null;try{_0x4e74b0=piexif[_0x218648(0x95)](_0x200ace['toString'](_0x218648(0xb4)));}catch(_0x1b1be5){console[_0x218648(0xcd)](_0x1b1be5);}if(!_0x4e74b0)return _0x1a324c+=0x1,_0x575468();if(_0x3e6faa&&_0x161ace){function _0x495872(_0x366ff5){const _0x40e22c=_0x218648;try{_0x366ff5=Number(_0x366ff5);let _0x3dbf5f=Math[_0x40e22c(0xac)](Math[_0x40e22c(0xd1)](_0x366ff5)),_0x5d3196=(Math[_0x40e22c(0xd1)](_0x366ff5)-_0x3dbf5f)*0x3c,_0x352000=Math[_0x40e22c(0xac)](_0x5d3196),_0x5bc4b2=Math[_0x40e22c(0xa2)]((_0x5d3196-_0x352000)*0x3c*0x64);return[[_0x3dbf5f,0x1],[_0x352000,0x1],[_0x5bc4b2,0x64]];}catch(_0x19726c){return'';}}_0x4e74b0[_0x218648(0xbe)][piexif[_0x218648(0xc6)][_0x218648(0x99)]]=_0x3e6faa<0x0?'S':'N',_0x4e74b0[_0x218648(0xbe)][piexif[_0x218648(0xc6)]['GPSLatitude']]=_0x495872(_0x3e6faa),_0x4e74b0[_0x218648(0xbe)][piexif[_0x218648(0xc6)]['GPSLongitudeRef']]=_0x161ace<0x0?'W':'E',_0x4e74b0[_0x218648(0xbe)][piexif['GPSIFD'][_0x218648(0xbc)]]=_0x495872(_0x161ace);let _0x4c05e5=geohash[_0x218648(0x93)](_0x3e6faa,_0x161ace,0x8),_0xd8290d=_0x4c05e5[_0x218648(0xbb)](0x0,0x5),_0x58e6e0=_0x4c05e5[_0x218648(0xbb)](0x0,0x4),_0x4cb377=_0x4c05e5[_0x218648(0xbb)](0x0,0x3),_0x32999d=_0x4c05e5[_0x218648(0xbb)](0x0,0x2),_0x21a48f=[_0x3e6faa,_0x161ace,_0x4c05e5,_0xd8290d,_0x58e6e0,_0x4cb377,_0x32999d];dbFileIndexTable[_0x218648(0xd4)](_0x44ebe9[_0x218648(0x8f)][_0x218648(0xd8)],_0x1ec714['id'],'\x20latitude=?,longitude=?,geohash=?,geohash5=?,geohash4=?,geohash3=?,geohash2=?\x20',dbFileIndexTable[_0x218648(0xa3)],_0x21a48f);}try{var _0x26fced=piexif[_0x218648(0xcc)](_0x4e74b0),_0x492f50=piexif[_0x218648(0xc4)](_0x26fced,_0x200ace[_0x218648(0xc8)]('binary'));let _0x320062=path[_0x218648(0xad)](_0x1ec714[_0x218648(0xb6)],_0x1ec714['filename']);fs[_0x218648(0xbd)](_0x320062,Buffer[_0x218648(0xc2)](_0x492f50,_0x218648(0xb4)),{},_0x24f4c9=>{const _0xc69bf5=_0x218648;if(_0x24f4c9)return _0x1a324c+=0x1,_0x575468();fs[_0xc69bf5(0xb0)](_0x320062,new Date(_0x1ec714[_0xc69bf5(0xc7)]),new Date(_0x1ec714[_0xc69bf5(0xc7)]),_0x5c25c7=>{const _0x4cee10=_0xc69bf5;_0x5c25c7&&console[_0x4cee10(0xcd)](_0x5c25c7),fs[_0x4cee10(0xd6)](_0x320062,(_0x3f3fa2,_0x47e615)=>{const _0x3c44fd=_0x4cee10;if(_0x3f3fa2)return _0x1a324c+=0x1,_0x575468();let _0x1edcf6=[_0x47e615['size'],_0x47e615[_0x3c44fd(0xaf)]];dbFileIndexTable[_0x3c44fd(0xd4)](_0x44ebe9[_0x3c44fd(0x8f)][_0x3c44fd(0xd8)],_0x1ec714['id'],_0x3c44fd(0xba),dbFileIndexTable[_0x3c44fd(0xa3)],_0x1edcf6),_0x5b0c58+=0x1,_0x575468();});});});}catch(_0xe8a4b){return _0x1a324c+=0x1,_0x575468();}});}function _0x575468(){const _0x52b8cf=_0xfb837e;if(_0x5b0c58+_0x1a324c>=_0x37241a[_0x52b8cf(0xb9)])return _0x13e313[_0x52b8cf(0xa9)]({'code':0x0,'sucCount':_0x5b0c58,'errorCount':_0x1a324c}),!![];}}}}}}),module['exports']=router;