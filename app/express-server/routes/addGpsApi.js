const _0x2b8000=_0x477a;(function(_0x223076,_0xcdaa85){const _0x3a5283=_0x477a,_0x586b8a=_0x223076();while(!![]){try{const _0x2dbb0c=parseInt(_0x3a5283(0x137))/0x1+parseInt(_0x3a5283(0x115))/0x2+-parseInt(_0x3a5283(0x11a))/0x3+parseInt(_0x3a5283(0x105))/0x4+-parseInt(_0x3a5283(0x10b))/0x5*(parseInt(_0x3a5283(0x116))/0x6)+-parseInt(_0x3a5283(0x145))/0x7+parseInt(_0x3a5283(0x140))/0x8;if(_0x2dbb0c===_0xcdaa85)break;else _0x586b8a['push'](_0x586b8a['shift']());}catch(_0x24a5fb){_0x586b8a['push'](_0x586b8a['shift']());}}}(_0x42e0,0x82d36));let express=require('express'),router=express[_0x2b8000(0x139)](),path=require('path');const dbUserTable=require(_0x2b8000(0x10a)),dbFileIndexTable=require(_0x2b8000(0x103));let fs=require('fs'),piexif=require('piexifjs'),geohash=require(_0x2b8000(0x138));function _0x477a(_0x44ad22,_0x421d39){const _0x42e02e=_0x42e0();return _0x477a=function(_0x477a2c,_0x42deb4){_0x477a2c=_0x477a2c-0xfd;let _0x44730f=_0x42e02e[_0x477a2c];return _0x44730f;},_0x477a(_0x44ad22,_0x421d39);}function getWaitAddGpsIndex(_0x4b437e,_0x1f31f8,_0x464923){const _0x197bd2=_0x2b8000;let _0x579c67=0x7d0,_0x588560=_0x197bd2(0x12a)+_0x1f31f8,_0x5e1b06=[parseInt(_0x579c67),parseInt(_0x579c67),..._0x464923],_0x4d0810=dbFileIndexTable[_0x197bd2(0x143)](_0x4b437e,_0x588560,'*',dbFileIndexTable[_0x197bd2(0x125)],_0x5e1b06);if(_0x4d0810){let _0x1297db=_0x4d0810[_0x197bd2(0x102)]-0xe10*0x3e8*0xc,_0x4c3c61=_0x4d0810['original_time']+0xe10*0x3e8*0xc,_0x3dd2da=_0x197bd2(0x12d)+_0x1f31f8+_0x197bd2(0x136),_0x2d9818=[parseInt(_0x1297db),parseInt(_0x4c3c61),parseInt(_0x579c67),parseInt(_0x579c67),..._0x464923,parseInt(_0x4d0810[_0x197bd2(0x102)])],_0x29e9f6=dbFileIndexTable[_0x197bd2(0x134)](_0x4b437e,_0x3dd2da,'*',dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],_0x2d9818);if(_0x29e9f6&&_0x29e9f6['length']>0x0){let _0x454fb7=[];if(_0x4d0810[_0x197bd2(0x12c)]&&_0x4d0810[_0x197bd2(0x12c)]!='undefined'){let _0x3700b2=0x32,_0x5b16e8=_0x4d0810['original_time']-0xe10*0x3e8*0x3,_0x2d4a15=_0x4d0810['original_time']+0xe10*0x3e8*0x3;if(_0x4d0810['mode']&&_0x4d0810['mode']!=_0x197bd2(0x135)){let _0x4039dd=_0x197bd2(0x107)+_0x1f31f8+_0x197bd2(0x146),_0x4d1d01=[_0x4d0810[_0x197bd2(0x12c)],parseInt(_0x5b16e8),parseInt(_0x2d4a15),..._0x464923,parseInt(_0x3700b2)];_0x454fb7=dbFileIndexTable[_0x197bd2(0x134)](_0x4b437e,_0x4039dd,'*',dbFileIndexTable[_0x197bd2(0x125)],_0x4d1d01);}}else _0x454fb7[_0x197bd2(0x133)](_0x4d0810);for(let _0x22a21f in _0x454fb7){_0x454fb7[_0x22a21f][_0x197bd2(0x101)]=path['join'](_0x454fb7[_0x22a21f][_0x197bd2(0x120)],_0x454fb7[_0x22a21f][_0x197bd2(0x118)]);}if(_0x454fb7[_0x197bd2(0x124)]==0x1)return dbFileIndexTable[_0x197bd2(0x127)](_0x4b437e,_0x454fb7[0x0]['id'],_0x197bd2(0x123),0x1,dbFileIndexTable[_0x197bd2(0x125)]),getWaitAddGpsIndex(_0x4b437e,_0x1f31f8,_0x464923);return{'dealList':_0x454fb7,'nearIndex':_0x29e9f6};}else return dbFileIndexTable['updateById'](_0x4b437e,_0x4d0810['id'],'add_gps_status',0x1,dbFileIndexTable[_0x197bd2(0x125)]),getWaitAddGpsIndex(_0x4b437e,_0x1f31f8,_0x464923);}else return![];}router[_0x2b8000(0x119)](_0x2b8000(0x128),(_0x14fe21,_0x4d6f3b,_0x2cc80b)=>{const _0xf574b6=_0x2b8000;let _0xdcb0e3={'code':0x0,'data':''};if(dbUserTable[_0xf574b6(0x148)](_0x14fe21,_0x4d6f3b,'photo','power_get')==!![]){let _0x200e27='',_0x5f8618=[];if(_0x14fe21[_0xf574b6(0x100)]['is_admin']!=0x1){let _0x49f6a1=dbUserTable['getUserPathWhere'](_0x14fe21,_0xf574b6(0x11f),_0xf574b6(0x122),!![]);_0x200e27=_0x49f6a1[_0xf574b6(0x12f)],_0x5f8618=_0x49f6a1[_0xf574b6(0x141)];}let _0x1a4a06=getWaitAddGpsIndex(_0x14fe21[_0xf574b6(0x14a)][_0xf574b6(0x13e)],_0x200e27,_0x5f8618);return _0x1a4a06&&(_0xdcb0e3['data']=_0x1a4a06),_0x4d6f3b['json'](_0xdcb0e3);}}),router[_0x2b8000(0x119)](_0x2b8000(0x112),(_0x47244b,_0x42a98a,_0x4e76db)=>{const _0x114399=_0x2b8000;let _0x104e07=_0x47244b[_0x114399(0x131)][_0x114399(0x11e)],_0x22536f=_0x47244b[_0x114399(0x131)][_0x114399(0x110)];if(_0x22536f[_0x114399(0x124)]<0x1)return _0x42a98a[_0x114399(0x13f)]({'code':0x0});_0x3f60a4();function _0x3f60a4(){const _0x261226=_0x114399;if(dbUserTable[_0x261226(0x148)](_0x47244b,_0x42a98a,_0x261226(0x11f),_0x261226(0x126))==!![]){let _0x4014df='(';for(let _0xdc782b in _0x22536f){_0x4014df+=_0x22536f[_0xdc782b],_0xdc782b!=_0x22536f['length']-0x1&&(_0x4014df+=',');}_0x4014df+=')';if(_0x104e07=='SKIP')return _0x47244b[_0x261226(0x14a)]['dbFileIndex'][_0x261226(0x129)]('UPDATE\x20file_index_photo\x20set\x20add_gps_status=2\x20WHERE\x20id\x20IN\x20'+_0x4014df+'\x20')[_0x261226(0x149)](),_0x42a98a[_0x261226(0x13f)]({'code':0x0});else{if(_0x104e07==_0x261226(0x13d)){let _0x11f40d=_0x47244b[_0x261226(0x131)][_0x261226(0xfd)],_0x2bbf43=_0x47244b['body']['longitude'];if(!_0x11f40d||!_0x2bbf43)return _0x42a98a[_0x261226(0x13f)]({'code':0x0});_0x47244b[_0x261226(0x14a)][_0x261226(0x13e)][_0x261226(0x129)]('UPDATE\x20file_index_photo\x20set\x20add_gps_status=1\x20WHERE\x20id\x20IN\x20'+_0x4014df+'\x20')[_0x261226(0x149)]();let _0xc2538a=0x0,_0x59b403=0x0;for(let _0x5ed8cd in _0x22536f){let _0x616ce7=dbFileIndexTable[_0x261226(0x104)](_0x47244b[_0x261226(0x14a)][_0x261226(0x13e)],_0x22536f[_0x5ed8cd]);if(!_0x616ce7)continue;let _0x1b1002=path[_0x261226(0x117)](_0x616ce7[_0x261226(0x120)],path[_0x261226(0x144)],_0x616ce7[_0x261226(0x118)]),_0x2e5c6c=fs[_0x261226(0x13a)](_0x1b1002);if(!_0x2e5c6c[_0x261226(0x11d)]()){_0x59b403+=0x1,_0x4e0c4e();continue;}fs[_0x261226(0x12e)](_0x1b1002,(_0x24d454,_0x1c4a93)=>{const _0x2afaea=_0x261226;if(_0x24d454)return _0x59b403+=0x1,_0x4e0c4e();let _0x28c5f3=null;try{_0x28c5f3=piexif['load'](_0x1c4a93[_0x2afaea(0x10f)](_0x2afaea(0x147)));}catch(_0x3e3f1a){console[_0x2afaea(0x12b)](_0x3e3f1a);}if(!_0x28c5f3)return _0x59b403+=0x1,_0x4e0c4e();if(_0x11f40d&&_0x2bbf43){function _0x1e6014(_0x3cbf21){const _0x243ac2=_0x2afaea;try{_0x3cbf21=Number(_0x3cbf21);let _0x3bb0c8=Math[_0x243ac2(0x111)](Math['abs'](_0x3cbf21)),_0x193ac2=(Math[_0x243ac2(0x121)](_0x3cbf21)-_0x3bb0c8)*0x3c,_0x187945=Math[_0x243ac2(0x111)](_0x193ac2),_0x4c42f8=Math[_0x243ac2(0x130)]((_0x193ac2-_0x187945)*0x3c*0x64);return[[_0x3bb0c8,0x1],[_0x187945,0x1],[_0x4c42f8,0x64]];}catch(_0x36dee7){return'';}}_0x28c5f3[_0x2afaea(0x13b)][piexif[_0x2afaea(0xfe)]['GPSLatitudeRef']]=_0x11f40d<0x0?'S':'N',_0x28c5f3[_0x2afaea(0x13b)][piexif[_0x2afaea(0xfe)][_0x2afaea(0x10c)]]=_0x1e6014(_0x11f40d),_0x28c5f3[_0x2afaea(0x13b)][piexif[_0x2afaea(0xfe)]['GPSLongitudeRef']]=_0x2bbf43<0x0?'W':'E',_0x28c5f3[_0x2afaea(0x13b)][piexif[_0x2afaea(0xfe)][_0x2afaea(0x10d)]]=_0x1e6014(_0x2bbf43);let _0xaa9e25=geohash[_0x2afaea(0x114)](_0x11f40d,_0x2bbf43,0x8),_0x2615e0=_0xaa9e25[_0x2afaea(0x10e)](0x0,0x5),_0x5adba2=_0xaa9e25['substring'](0x0,0x4),_0x8d0074=_0xaa9e25['substring'](0x0,0x3),_0x4ea8ae=_0xaa9e25['substring'](0x0,0x2),_0x3ef3fd=[_0x11f40d,_0x2bbf43,_0xaa9e25,_0x2615e0,_0x5adba2,_0x8d0074,_0x4ea8ae];dbFileIndexTable['updateBySql'](_0x47244b[_0x2afaea(0x14a)][_0x2afaea(0x13e)],_0x616ce7['id'],_0x2afaea(0x108),dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],_0x3ef3fd);}try{var _0x58ab36=piexif[_0x2afaea(0x106)](_0x28c5f3),_0x52e0fe=piexif['insert'](_0x58ab36,_0x1c4a93[_0x2afaea(0x10f)](_0x2afaea(0x147)));let _0x3a07d5=path[_0x2afaea(0x117)](_0x616ce7[_0x2afaea(0x120)],_0x616ce7[_0x2afaea(0x118)]);fs[_0x2afaea(0x11b)](_0x3a07d5,Buffer[_0x2afaea(0x11c)](_0x52e0fe,'binary'),{},_0x27d7b6=>{const _0x3b586a=_0x2afaea;if(_0x27d7b6)return _0x59b403+=0x1,_0x4e0c4e();fs[_0x3b586a(0x109)](_0x3a07d5,new Date(_0x616ce7[_0x3b586a(0xff)]),new Date(_0x616ce7[_0x3b586a(0xff)]),_0x463878=>{const _0xccc5e1=_0x3b586a;_0x463878&&console[_0xccc5e1(0x12b)](_0x463878),fs['stat'](_0x3a07d5,(_0x34c876,_0x2fe79b)=>{const _0x547091=_0xccc5e1;if(_0x34c876)return _0x59b403+=0x1,_0x4e0c4e();let _0x8ea18c=[_0x2fe79b['size'],_0x2fe79b[_0x547091(0x132)]];dbFileIndexTable[_0x547091(0x113)](_0x47244b[_0x547091(0x14a)][_0x547091(0x13e)],_0x616ce7['id'],_0x547091(0x13c),dbFileIndexTable[_0x547091(0x125)],_0x8ea18c),_0xc2538a+=0x1,_0x4e0c4e();});});});}catch(_0x25bfc6){return _0x59b403+=0x1,_0x4e0c4e();}});}function _0x4e0c4e(){const _0x29e86e=_0x261226;if(_0xc2538a+_0x59b403>=_0x22536f['length'])return _0x42a98a[_0x29e86e(0x13f)]({'code':0x0,'sucCount':_0xc2538a,'errorCount':_0x59b403}),!![];}}}}}}),module[_0x2b8000(0x142)]=router;function _0x42e0(){const _0x2038d4=['indexIdList','floor','/confirmAddGps','updateBySql','encode','322258ELHnqN','90642UBoJdM','join','filename','post','1990752yHdKzx','writeFile','from','isFile','type','photo','path','abs','power_get','add_gps_status','length','INDEX_TABLE_NAME_PHOTO','power_change','updateById','/getWaitAddGpsIndex','prepare','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20(width>=?\x20and\x20height>=?)\x20','log','mode','\x20\x20latitude\x20is\x20not\x20null\x20and\x20latitude!=\x27undefined\x27\x20and\x20geohash5\x20!=\x27undefined\x27\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20and\x20(width>=?\x20or\x20height>=?)\x20\x20','readFile','whereStr','round','body','ctimeMs','push','getAllByWhere','undefined','\x20order\x20by\x20abs(original_time-?)\x20asc\x20limit\x2050','663940DNwHit','ngeohash','Router','statSync','GPS','\x20size=?,ctime=?\x20','CONFIRM','dbFileIndex','json','4423360Oraecb','paramsList','exports','getByWhere','sep','2192645VMvyOB','\x20order\x20by\x20original_time\x20limit\x20?','binary','doUserCanGet','run','app','latitude','GPSIFD','mtime','currentUser','fullPath','original_time','../../db/dbFileIndexTable','getById','1747328MNmaNE','dump','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20mode=?\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20','\x20latitude=?,longitude=?,geohash=?,geohash5=?,geohash4=?,geohash3=?,geohash2=?\x20','utimes','../../db/dbUserTable','100ilgGkg','GPSLatitude','GPSLongitude','substring','toString'];_0x42e0=function(){return _0x2038d4;};return _0x42e0();}