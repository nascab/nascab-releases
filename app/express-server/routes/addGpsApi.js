const _0x474211=_0x1144;function _0x1144(_0x32baaf,_0x5c2a2a){const _0x482756=_0x4827();return _0x1144=function(_0x1144da,_0x32e13d){_0x1144da=_0x1144da-0x122;let _0x1b89b2=_0x482756[_0x1144da];return _0x1b89b2;},_0x1144(_0x32baaf,_0x5c2a2a);}(function(_0x3859d4,_0x1e4a1c){const _0x182dd0=_0x1144,_0x29b7fb=_0x3859d4();while(!![]){try{const _0x343ec4=parseInt(_0x182dd0(0x172))/0x1+parseInt(_0x182dd0(0x142))/0x2*(-parseInt(_0x182dd0(0x162))/0x3)+-parseInt(_0x182dd0(0x13b))/0x4*(-parseInt(_0x182dd0(0x14a))/0x5)+parseInt(_0x182dd0(0x145))/0x6*(parseInt(_0x182dd0(0x149))/0x7)+parseInt(_0x182dd0(0x169))/0x8+parseInt(_0x182dd0(0x13e))/0x9*(parseInt(_0x182dd0(0x157))/0xa)+-parseInt(_0x182dd0(0x127))/0xb;if(_0x343ec4===_0x1e4a1c)break;else _0x29b7fb['push'](_0x29b7fb['shift']());}catch(_0x20bfc2){_0x29b7fb['push'](_0x29b7fb['shift']());}}}(_0x4827,0x9af87));let express=require(_0x474211(0x151)),router=express[_0x474211(0x165)](),path=require(_0x474211(0x14e));const dbUserTable=require(_0x474211(0x171)),dbFileIndexTable=require('../../db/dbFileIndexTable');let fs=require('fs'),piexif=require(_0x474211(0x152)),geohash=require(_0x474211(0x128));function getWaitAddGpsIndex(_0x33a65e,_0x18f836,_0x33472a){const _0x53746f=_0x474211;let _0x39ca2b=0x7d0,_0x592537=_0x53746f(0x166)+_0x18f836,_0x187468=[parseInt(_0x39ca2b),parseInt(_0x39ca2b),..._0x33472a],_0x115487=dbFileIndexTable[_0x53746f(0x164)](_0x33a65e,_0x592537,'*',dbFileIndexTable[_0x53746f(0x15b)],_0x187468);if(_0x115487){let _0x462d7d=_0x115487[_0x53746f(0x15e)]-0xe10*0x3e8*0xc,_0x2b6e33=_0x115487[_0x53746f(0x15e)]+0xe10*0x3e8*0xc,_0xfdfdbf='\x20\x20latitude\x20is\x20not\x20null\x20and\x20latitude!=\x27undefined\x27\x20and\x20geohash5\x20!=\x27undefined\x27\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20and\x20(width>=?\x20or\x20height>=?)\x20\x20'+_0x18f836+_0x53746f(0x13f),_0xe2672c=[parseInt(_0x462d7d),parseInt(_0x2b6e33),parseInt(_0x39ca2b),parseInt(_0x39ca2b),..._0x33472a,parseInt(_0x115487[_0x53746f(0x15e)])],_0x3ce31f=dbFileIndexTable[_0x53746f(0x148)](_0x33a65e,_0xfdfdbf,'*',dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],_0xe2672c);if(_0x3ce31f&&_0x3ce31f['length']>0x0){let _0x2577f4=[];if(_0x115487[_0x53746f(0x14f)]&&_0x115487['mode']!='undefined'){let _0x1c3209=0x32,_0x4a60ad=_0x115487[_0x53746f(0x15e)]-0xe10*0x3e8*0x3,_0x2b7c7e=_0x115487[_0x53746f(0x15e)]+0xe10*0x3e8*0x3;if(_0x115487[_0x53746f(0x14f)]&&_0x115487[_0x53746f(0x14f)]!=_0x53746f(0x12d)){let _0x3b1db5=_0x53746f(0x158)+_0x18f836+_0x53746f(0x167),_0x421e18=[_0x115487['mode'],parseInt(_0x4a60ad),parseInt(_0x2b7c7e),..._0x33472a,parseInt(_0x1c3209)];_0x2577f4=dbFileIndexTable['getAllByWhere'](_0x33a65e,_0x3b1db5,'*',dbFileIndexTable[_0x53746f(0x15b)],_0x421e18);}}else _0x2577f4[_0x53746f(0x156)](_0x115487);for(let _0x4baced in _0x2577f4){_0x2577f4[_0x4baced][_0x53746f(0x153)]=path[_0x53746f(0x174)](_0x2577f4[_0x4baced][_0x53746f(0x14e)],_0x2577f4[_0x4baced][_0x53746f(0x16e)]);}if(_0x2577f4[_0x53746f(0x12c)]==0x1)return dbFileIndexTable[_0x53746f(0x124)](_0x33a65e,_0x2577f4[0x0]['id'],_0x53746f(0x14c),0x1,dbFileIndexTable[_0x53746f(0x15b)]),getWaitAddGpsIndex(_0x33a65e,_0x18f836,_0x33472a);return{'dealList':_0x2577f4,'nearIndex':_0x3ce31f};}else return dbFileIndexTable['updateById'](_0x33a65e,_0x115487['id'],_0x53746f(0x14c),0x1,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']),getWaitAddGpsIndex(_0x33a65e,_0x18f836,_0x33472a);}else return![];}router[_0x474211(0x15d)](_0x474211(0x12b),(_0x4eaf70,_0x2d1d25,_0xd5b06)=>{const _0x7467e3=_0x474211;let _0x57aea7={'code':0x0,'data':''};if(dbUserTable[_0x7467e3(0x13c)](_0x4eaf70,_0x2d1d25,_0x7467e3(0x154),_0x7467e3(0x12e))==!![]){let _0x15e814='',_0x998e20=[];if(_0x4eaf70[_0x7467e3(0x163)]['is_admin']!=0x1){let _0x3f071d=dbUserTable['getUserPathWhere'](_0x4eaf70,_0x7467e3(0x154),_0x7467e3(0x12e),!![]);_0x15e814=_0x3f071d[_0x7467e3(0x160)],_0x998e20=_0x3f071d[_0x7467e3(0x15a)];}let _0x54a7c3=getWaitAddGpsIndex(_0x4eaf70[_0x7467e3(0x137)]['dbFileIndex'],_0x15e814,_0x998e20);return _0x54a7c3&&(_0x57aea7['data']=_0x54a7c3),_0x2d1d25[_0x7467e3(0x138)](_0x57aea7);}}),router[_0x474211(0x15d)](_0x474211(0x13d),(_0x140eec,_0x3041e7,_0x492b9e)=>{const _0x2f028c=_0x474211;let _0x309f22=_0x140eec[_0x2f028c(0x14b)][_0x2f028c(0x15c)],_0x382752=_0x140eec[_0x2f028c(0x14b)][_0x2f028c(0x15f)];if(_0x382752[_0x2f028c(0x12c)]<0x1)return _0x3041e7[_0x2f028c(0x138)]({'code':0x0});_0x3015fd();function _0x3015fd(){const _0x5a4e8c=_0x2f028c;if(dbUserTable['doUserCanGet'](_0x140eec,_0x3041e7,_0x5a4e8c(0x154),_0x5a4e8c(0x140))==!![]){let _0x5da606='(';for(let _0x56c791 in _0x382752){_0x5da606+=_0x382752[_0x56c791],_0x56c791!=_0x382752[_0x5a4e8c(0x12c)]-0x1&&(_0x5da606+=',');}_0x5da606+=')';if(_0x309f22==_0x5a4e8c(0x143))return _0x140eec['app'][_0x5a4e8c(0x16b)][_0x5a4e8c(0x173)](_0x5a4e8c(0x13a)+_0x5da606+'\x20')[_0x5a4e8c(0x133)](),_0x3041e7['json']({'code':0x0});else{if(_0x309f22==_0x5a4e8c(0x16a)){let _0x17c2e8=_0x140eec[_0x5a4e8c(0x14b)][_0x5a4e8c(0x150)],_0x14de79=_0x140eec['body'][_0x5a4e8c(0x136)];if(!_0x17c2e8||!_0x14de79)return _0x3041e7[_0x5a4e8c(0x138)]({'code':0x0});_0x140eec['app'][_0x5a4e8c(0x16b)][_0x5a4e8c(0x173)]('UPDATE\x20file_index_photo\x20set\x20add_gps_status=1\x20WHERE\x20id\x20IN\x20'+_0x5da606+'\x20')[_0x5a4e8c(0x133)]();let _0x452166=0x0,_0x2eb50b=0x0;for(let _0x461831 in _0x382752){let _0x49a846=dbFileIndexTable[_0x5a4e8c(0x131)](_0x140eec['app'][_0x5a4e8c(0x16b)],_0x382752[_0x461831]);if(!_0x49a846)continue;let _0x2401ec=path[_0x5a4e8c(0x174)](_0x49a846['path'],path[_0x5a4e8c(0x14d)],_0x49a846[_0x5a4e8c(0x16e)]),_0x245a77=fs[_0x5a4e8c(0x141)](_0x2401ec);if(!_0x245a77[_0x5a4e8c(0x161)]()){_0x2eb50b+=0x1,_0x4b59bc();continue;}fs['readFile'](_0x2401ec,(_0x464670,_0x553e43)=>{const _0xcdfe4c=_0x5a4e8c;if(_0x464670)return _0x2eb50b+=0x1,_0x4b59bc();let _0x4bb2f9=null;try{_0x4bb2f9=piexif['load'](_0x553e43['toString'](_0xcdfe4c(0x147)));}catch(_0x392612){console[_0xcdfe4c(0x155)](_0x392612);}if(!_0x4bb2f9)return _0x2eb50b+=0x1,_0x4b59bc();if(_0x17c2e8&&_0x14de79){function _0x46feba(_0x451eb8){const _0x8d3cb3=_0xcdfe4c;try{_0x451eb8=Number(_0x451eb8);let _0x1b252a=Math[_0x8d3cb3(0x134)](Math['abs'](_0x451eb8)),_0x14c8cd=(Math['abs'](_0x451eb8)-_0x1b252a)*0x3c,_0x1e372f=Math['floor'](_0x14c8cd),_0x7e5ba2=Math[_0x8d3cb3(0x12f)]((_0x14c8cd-_0x1e372f)*0x3c*0x64);return[[_0x1b252a,0x1],[_0x1e372f,0x1],[_0x7e5ba2,0x64]];}catch(_0x5619db){return'';}}_0x4bb2f9[_0xcdfe4c(0x132)][piexif[_0xcdfe4c(0x139)][_0xcdfe4c(0x16f)]]=_0x17c2e8<0x0?'S':'N',_0x4bb2f9['GPS'][piexif[_0xcdfe4c(0x139)][_0xcdfe4c(0x168)]]=_0x46feba(_0x17c2e8),_0x4bb2f9[_0xcdfe4c(0x132)][piexif['GPSIFD'][_0xcdfe4c(0x144)]]=_0x14de79<0x0?'W':'E',_0x4bb2f9[_0xcdfe4c(0x132)][piexif[_0xcdfe4c(0x139)][_0xcdfe4c(0x12a)]]=_0x46feba(_0x14de79);let _0x3dd31c=geohash[_0xcdfe4c(0x16d)](_0x17c2e8,_0x14de79,0x8),_0xd77fb2=_0x3dd31c[_0xcdfe4c(0x123)](0x0,0x5),_0x4bc7b6=_0x3dd31c[_0xcdfe4c(0x123)](0x0,0x4),_0x4f5560=_0x3dd31c[_0xcdfe4c(0x123)](0x0,0x3),_0x44048a=_0x3dd31c[_0xcdfe4c(0x123)](0x0,0x2),_0x320f2e=[_0x17c2e8,_0x14de79,_0x3dd31c,_0xd77fb2,_0x4bc7b6,_0x4f5560,_0x44048a];dbFileIndexTable[_0xcdfe4c(0x129)](_0x140eec[_0xcdfe4c(0x137)][_0xcdfe4c(0x16b)],_0x49a846['id'],_0xcdfe4c(0x126),dbFileIndexTable[_0xcdfe4c(0x15b)],_0x320f2e);}try{var _0x2b56e5=piexif[_0xcdfe4c(0x159)](_0x4bb2f9),_0x256dc9=piexif[_0xcdfe4c(0x130)](_0x2b56e5,_0x553e43[_0xcdfe4c(0x170)](_0xcdfe4c(0x147)));let _0x4446ef=path[_0xcdfe4c(0x174)](_0x49a846[_0xcdfe4c(0x14e)],_0x49a846['filename']);fs['writeFile'](_0x4446ef,Buffer[_0xcdfe4c(0x16c)](_0x256dc9,_0xcdfe4c(0x147)),{},_0x3c5ff4=>{const _0x3ce98f=_0xcdfe4c;if(_0x3c5ff4)return _0x2eb50b+=0x1,_0x4b59bc();fs[_0x3ce98f(0x125)](_0x4446ef,new Date(_0x49a846[_0x3ce98f(0x122)]),new Date(_0x49a846['mtime']),_0x10da9e=>{_0x10da9e&&console['log'](_0x10da9e),fs['stat'](_0x4446ef,(_0x5f26d1,_0x48d98a)=>{const _0x1fc11e=_0x1144;if(_0x5f26d1)return _0x2eb50b+=0x1,_0x4b59bc();let _0x272ee0=[_0x48d98a[_0x1fc11e(0x135)],_0x48d98a['ctimeMs']];dbFileIndexTable[_0x1fc11e(0x129)](_0x140eec['app'][_0x1fc11e(0x16b)],_0x49a846['id'],_0x1fc11e(0x146),dbFileIndexTable[_0x1fc11e(0x15b)],_0x272ee0),_0x452166+=0x1,_0x4b59bc();});});});}catch(_0x338b7e){return _0x2eb50b+=0x1,_0x4b59bc();}});}function _0x4b59bc(){const _0x40d596=_0x5a4e8c;if(_0x452166+_0x2eb50b>=_0x382752[_0x40d596(0x12c)])return _0x3041e7[_0x40d596(0x138)]({'code':0x0,'sucCount':_0x452166,'errorCount':_0x2eb50b}),!![];}}}}}}),module['exports']=router;function _0x4827(){const _0x3890a7=['mtime','substring','updateById','utimes','\x20latitude=?,longitude=?,geohash=?,geohash5=?,geohash4=?,geohash3=?,geohash2=?\x20','13267903ttNzqL','ngeohash','updateBySql','GPSLongitude','/getWaitAddGpsIndex','length','undefined','power_get','round','insert','getById','GPS','run','floor','size','longitude','app','json','GPSIFD','UPDATE\x20file_index_photo\x20set\x20add_gps_status=2\x20WHERE\x20id\x20IN\x20','1489192ryDwqc','doUserCanGet','/confirmAddGps','3105LaLpon','\x20order\x20by\x20abs(original_time-?)\x20asc\x20limit\x2050','power_change','statSync','86214kfbMQf','SKIP','GPSLongitudeRef','522VvowRh','\x20size=?,ctime=?\x20','binary','getAllByWhere','49462lQsfsy','5XfOwOZ','body','add_gps_status','sep','path','mode','latitude','express','piexifjs','fullPath','photo','log','push','36790FVEelr','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20mode=?\x20and\x20original_time\x20between\x20?\x20and\x20?\x20\x20','dump','paramsList','INDEX_TABLE_NAME_PHOTO','type','post','original_time','indexIdList','whereStr','isFile','75clmNrc','currentUser','getByWhere','Router','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20(width>=?\x20and\x20height>=?)\x20','\x20order\x20by\x20original_time\x20limit\x20?','GPSLatitude','4363192TNMDgg','CONFIRM','dbFileIndex','from','encode','filename','GPSLatitudeRef','toString','../../db/dbUserTable','116913RkfCAk','prepare','join'];_0x4827=function(){return _0x3890a7;};return _0x4827();}