const _0x26501d=_0x3fb5;(function(_0x3e7eb1,_0x2fa766){const _0x1aab02=_0x3fb5,_0x5ae74=_0x3e7eb1();while(!![]){try{const _0x4b642b=parseInt(_0x1aab02(0x156))/0x1+parseInt(_0x1aab02(0x15a))/0x2*(-parseInt(_0x1aab02(0x188))/0x3)+-parseInt(_0x1aab02(0x16f))/0x4+-parseInt(_0x1aab02(0x157))/0x5+-parseInt(_0x1aab02(0x159))/0x6*(-parseInt(_0x1aab02(0x151))/0x7)+-parseInt(_0x1aab02(0x163))/0x8*(-parseInt(_0x1aab02(0x172))/0x9)+-parseInt(_0x1aab02(0x184))/0xa*(-parseInt(_0x1aab02(0x146))/0xb);if(_0x4b642b===_0x2fa766)break;else _0x5ae74['push'](_0x5ae74['shift']());}catch(_0x3f42b1){_0x5ae74['push'](_0x5ae74['shift']());}}}(_0x176c,0xc046c));function _0x176c(){const _0x427661=['noGetFolderStat','app','dialog','16kHITKA','post','body','constants','/deleteTask','getAllRecordByWhere','getRecordByWhere','updateRecord','stringify','/getTaskRecordMsg','taskAlreadQueued','getAll','3192640HqdwUW','taskAlreadyRunning','getById','3639483jUQNFw','createRecord','/getAllTask','getAllRecordMsgByWhere','lastRecord','format','stop','send','YYYY-MM-DD\x20HH:mm:ss','/getTaskById','\x20task_record_id=?\x20order\x20by\x20id\x20desc\x20limit\x20100','type','stat','\x20status=\x27waiting\x27','noRunningTasks','delete','create','\x20status=\x27stop\x27','2584750LzZMqQ','running','waiting','\x20task_id=?\x20and\x20status=\x27done\x27\x20order\x20by\x20id\x20desc\x20limit\x20100','346623oVljVB','currentUser','test','R_OK','is_admin','taskTime','log','isDirectory','task\x20id\x20is\x20error','initBackupWorker','join','length','22WvocfI','\x20task_id=?\x20and\x20(status=\x27stop\x27\x20or\x20status=\x27waiting\x27\x20or\x20status=\x27running\x27)','taskDay','/getTaskRecords','Router','targetPath','taskType','\x20task_id=?\x20and\x20status=\x27running\x27','dbOther','/operationTask','status','261191vSuETP','update','/getRunningTaskList','\x20status=\x27running\x27\x20or\x20status=\x27waiting\x27','json','922442SeVVGN','2698485PxNHQq','../../db/dbBackupTask','36wkmEQn','6ZluFQb','returnErrMsg','noReadPermission','access','recordId','cannotUseRootPathAsBackupTarget'];_0x176c=function(){return _0x427661;};return _0x176c();}var express=require('express'),router=express[_0x26501d(0x14a)]();function _0x3fb5(_0x49e1dd,_0x1bfbe9){const _0x176c24=_0x176c();return _0x3fb5=function(_0x3fb5f6,_0x21bc5f){_0x3fb5f6=_0x3fb5f6-0x142;let _0x3dfb14=_0x176c24[_0x3fb5f6];return _0x3dfb14;},_0x3fb5(_0x49e1dd,_0x1bfbe9);}let path=require('path'),fs=require('fs');const dbBackupTask=require(_0x26501d(0x158));let moment=require('moment');router[_0x26501d(0x164)]('/createTask',(_0x3bb615,_0x4a3d3b,_0xaa426c)=>{const _0x54cf75=_0x26501d;if(_0x3bb615[_0x54cf75(0x189)]['is_admin']!=0x1)return _0x4a3d3b[_0x54cf75(0x155)]({'code':0x66});let _0x22e599=_0x3bb615[_0x54cf75(0x165)]['type'],_0x121489=_0x3bb615[_0x54cf75(0x165)]['taskName'],_0x5c391f=_0x3bb615[_0x54cf75(0x165)]['sourceList'],_0x3bcc1a=_0x3bb615[_0x54cf75(0x165)]['excludeList'],_0x51369d=path['join'](_0x3bb615[_0x54cf75(0x165)][_0x54cf75(0x14b)]),_0x2cf3ec=_0x3bb615[_0x54cf75(0x165)][_0x54cf75(0x14c)],_0x18e739=_0x3bb615[_0x54cf75(0x165)][_0x54cf75(0x148)],_0x36f6c9=_0x3bb615[_0x54cf75(0x165)][_0x54cf75(0x18d)];if(/^\w\:\\$/[_0x54cf75(0x18a)](_0x51369d))return _0x3bb615[_0x54cf75(0x161)]['returnErrMsg'](_0x4a3d3b,_0x4a3d3b['__'](_0x54cf75(0x15f)),_0x54cf75(0x162));let _0x27fc23=0x0;for(let _0x4e25f4 in _0x5c391f){_0x5c391f[_0x4e25f4]=path[_0x54cf75(0x144)](_0x5c391f[_0x4e25f4]);if(/^\w\:\\$/[_0x54cf75(0x18a)](_0x5c391f[_0x4e25f4]))return _0x3bb615['app'][_0x54cf75(0x15b)](_0x4a3d3b,_0x4a3d3b['__']('cannotUseRootPathAsBackupTarget'),_0x54cf75(0x162));fs[_0x54cf75(0x15d)](_0x5c391f[_0x4e25f4],fs[_0x54cf75(0x166)][_0x54cf75(0x18b)],_0x2557e0=>{const _0x27e8a9=_0x54cf75;if(_0x2557e0)return _0x3bb615[_0x27e8a9(0x161)][_0x27e8a9(0x15b)](_0x4a3d3b,_0x4a3d3b['__'](_0x27e8a9(0x15c))+':'+_0x5c391f[_0x4e25f4]);_0x27fc23+=0x1,_0x27fc23==_0x5c391f[_0x27e8a9(0x145)]&&_0x1f0d7f();});}function _0x1f0d7f(){const _0x5ad31d=_0x54cf75;fs['access'](_0x51369d,fs[_0x5ad31d(0x166)]['W_OK']|fs[_0x5ad31d(0x166)][_0x5ad31d(0x18b)],_0x495e6b=>{const _0x9ec27a=_0x5ad31d;if(_0x495e6b)return console[_0x9ec27a(0x18e)](_0x495e6b),_0x3bb615[_0x9ec27a(0x161)][_0x9ec27a(0x15b)](_0x4a3d3b,_0x4a3d3b['__']('noWritePermission')+':'+_0x51369d);fs[_0x9ec27a(0x17e)](_0x51369d,(_0x57d955,_0xd41fe)=>{const _0x2586f9=_0x9ec27a;if(_0x57d955||!_0xd41fe[_0x2586f9(0x18f)]())return _0x3bb615[_0x2586f9(0x161)]['returnErrMsg'](_0x4a3d3b,_0x4a3d3b['__'](_0x2586f9(0x160)));let _0xafe62f={'task_name':_0x121489,'source_list':JSON[_0x2586f9(0x16b)](_0x5c391f),'exclude_list':JSON['stringify'](_0x3bcc1a),'target_path':_0x51369d,'task_type':_0x2cf3ec,'task_day':_0x18e739,'task_time':_0x36f6c9};if(_0x22e599=='create')dbBackupTask[_0x2586f9(0x182)](_0x3bb615[_0x2586f9(0x161)][_0x2586f9(0x14e)],_0xafe62f);else{if(_0x22e599==_0x2586f9(0x152)){let _0x2653d6=_0x3bb615[_0x2586f9(0x165)]['id'];dbBackupTask[_0x2586f9(0x152)](_0x3bb615[_0x2586f9(0x161)][_0x2586f9(0x14e)],_0xafe62f,_0x2653d6);}}return process['send']({'type':_0x2586f9(0x143)}),_0x4a3d3b[_0x2586f9(0x155)]({'code':0x0});});});}}),router[_0x26501d(0x164)](_0x26501d(0x167),(_0x5d7c8b,_0x2c504a,_0x5cac97)=>{const _0x5d97ec=_0x26501d;if(_0x5d7c8b[_0x5d97ec(0x189)][_0x5d97ec(0x18c)]!=0x1)return _0x2c504a['json']({'code':0x66});let _0xdf46c6=_0x5d7c8b[_0x5d97ec(0x165)]['id'];dbBackupTask[_0x5d97ec(0x181)](_0x5d7c8b[_0x5d97ec(0x161)][_0x5d97ec(0x14e)],_0xdf46c6),process[_0x5d97ec(0x179)]({'type':_0x5d97ec(0x143)}),_0x2c504a[_0x5d97ec(0x155)]({'code':0x0});}),router[_0x26501d(0x164)](_0x26501d(0x14f),(_0x297c6c,_0x52db4b,_0x1c2dfe)=>{const _0x1f1e1e=_0x26501d;if(_0x297c6c['currentUser'][_0x1f1e1e(0x18c)]!=0x1)return _0x52db4b[_0x1f1e1e(0x155)]({'code':0x66});let _0x45097f=_0x297c6c[_0x1f1e1e(0x165)][_0x1f1e1e(0x17d)],_0xe77b3a=_0x297c6c['body']['taskId'],_0x979391=dbBackupTask[_0x1f1e1e(0x171)](_0x297c6c[_0x1f1e1e(0x161)][_0x1f1e1e(0x14e)],_0xe77b3a);if(!_0x979391)return _0x52db4b['json']({'code':0x1,'message':_0x1f1e1e(0x142)});if(_0x45097f=='start'){let _0x394e80=dbBackupTask[_0x1f1e1e(0x169)](_0x297c6c['app']['dbOther'],_0x1f1e1e(0x147),[_0xe77b3a]);if(_0x394e80){if(_0x394e80[_0x1f1e1e(0x150)]==_0x1f1e1e(0x186))return _0x52db4b[_0x1f1e1e(0x155)]({'code':0x1,'message':_0x52db4b['__'](_0x1f1e1e(0x16d)),'task_record':_0x394e80});else{if(_0x394e80[_0x1f1e1e(0x150)]==_0x1f1e1e(0x185))return _0x52db4b[_0x1f1e1e(0x155)]({'code':0x1,'message':_0x52db4b['__'](_0x1f1e1e(0x170)),'task_record':_0x394e80});else _0x394e80[_0x1f1e1e(0x150)]==_0x1f1e1e(0x178)&&dbBackupTask[_0x1f1e1e(0x16a)](_0x297c6c[_0x1f1e1e(0x161)][_0x1f1e1e(0x14e)],_0x394e80['id'],_0x1f1e1e(0x17f));}}else{let _0x44819e=moment()[_0x1f1e1e(0x177)](_0x1f1e1e(0x17a));dbBackupTask[_0x1f1e1e(0x173)](_0x297c6c[_0x1f1e1e(0x161)][_0x1f1e1e(0x14e)],_0xe77b3a,_0x1f1e1e(0x186),_0x44819e);}}else{if(_0x45097f=='stop'){let _0x3a34e9=dbBackupTask[_0x1f1e1e(0x169)](_0x297c6c[_0x1f1e1e(0x161)]['dbOther'],_0x1f1e1e(0x14d),[_0xe77b3a]);if(!_0x3a34e9)return _0x52db4b[_0x1f1e1e(0x155)]({'code':0x1,'message':_0x52db4b['__'](_0x1f1e1e(0x180)),'task_record':_0x3a34e9});else dbBackupTask[_0x1f1e1e(0x16a)](_0x297c6c['app'][_0x1f1e1e(0x14e)],_0x3a34e9['id'],_0x1f1e1e(0x183));}}process[_0x1f1e1e(0x179)]({'type':'initBackupWorker'}),_0x52db4b[_0x1f1e1e(0x155)]({'code':0x0});}),router['post'](_0x26501d(0x174),(_0x2d414e,_0x120fdd,_0x140966)=>{const _0x85e407=_0x26501d;if(_0x2d414e[_0x85e407(0x189)][_0x85e407(0x18c)]!=0x1)return _0x120fdd[_0x85e407(0x155)]({'code':0x66});let _0x4173ba=_0x2d414e[_0x85e407(0x165)][_0x85e407(0x14c)],_0x26db0d=[];_0x4173ba=parseInt(_0x4173ba);_0x4173ba?_0x26db0d=dbBackupTask['getAllByTaskType'](_0x2d414e[_0x85e407(0x161)][_0x85e407(0x14e)],_0x4173ba):_0x26db0d=dbBackupTask[_0x85e407(0x16e)](_0x2d414e[_0x85e407(0x161)]['dbOther']);for(let _0x525ece in _0x26db0d){let _0x12f5f5=dbBackupTask[_0x85e407(0x169)](_0x2d414e[_0x85e407(0x161)][_0x85e407(0x14e)],'\x20task_id=?\x20order\x20by\x20id\x20desc\x20limit\x201',[_0x26db0d[_0x525ece]['id']]);_0x26db0d[_0x525ece][_0x85e407(0x176)]=_0x12f5f5;}_0x120fdd[_0x85e407(0x155)]({'code':0x0,'data':_0x26db0d});}),router[_0x26501d(0x164)](_0x26501d(0x17b),(_0x59e980,_0xab61aa,_0x42d719)=>{const _0x12a8d4=_0x26501d;if(_0x59e980[_0x12a8d4(0x189)][_0x12a8d4(0x18c)]!=0x1)return _0xab61aa['json']({'code':0x66});let _0x2e0823=_0x59e980['body']['id'],_0x54763f=dbBackupTask[_0x12a8d4(0x171)](_0x59e980['app'][_0x12a8d4(0x14e)],_0x2e0823);_0xab61aa[_0x12a8d4(0x155)]({'code':0x0,'data':_0x54763f});}),router[_0x26501d(0x164)](_0x26501d(0x149),(_0x5bd984,_0x5142fa,_0x35b5a0)=>{const _0x4e67b1=_0x26501d;if(_0x5bd984[_0x4e67b1(0x189)][_0x4e67b1(0x18c)]!=0x1)return _0x5142fa[_0x4e67b1(0x155)]({'code':0x66});let _0x53cbcf=_0x5bd984[_0x4e67b1(0x165)]['id'],_0x374b3d=dbBackupTask['getAllRecordByWhere'](_0x5bd984['app'][_0x4e67b1(0x14e)],_0x4e67b1(0x187),[_0x53cbcf]);_0x5142fa[_0x4e67b1(0x155)]({'code':0x0,'data':_0x374b3d});}),router['post'](_0x26501d(0x16c),(_0x931d5f,_0x18398b,_0x2b5572)=>{const _0x1415f=_0x26501d;if(_0x931d5f['currentUser']['is_admin']!=0x1)return _0x18398b[_0x1415f(0x155)]({'code':0x66});let _0x4068af=_0x931d5f['body']['recordId'],_0xa2b950=dbBackupTask[_0x1415f(0x175)](_0x931d5f['app'][_0x1415f(0x14e)],_0x1415f(0x17c),[_0x4068af]);_0x18398b[_0x1415f(0x155)]({'code':0x0,'data':_0xa2b950});}),router[_0x26501d(0x164)](_0x26501d(0x153),(_0x57c943,_0x19549a,_0x3d5fd5)=>{const _0x431328=_0x26501d;if(_0x57c943[_0x431328(0x189)][_0x431328(0x18c)]!=0x1)return _0x19549a[_0x431328(0x155)]({'code':0x66});let _0x3386ed=_0x57c943[_0x431328(0x165)][_0x431328(0x15e)],_0x444912=dbBackupTask[_0x431328(0x168)](_0x57c943[_0x431328(0x161)][_0x431328(0x14e)],_0x431328(0x154),[]);_0x19549a[_0x431328(0x155)]({'code':0x0,'data':_0x444912});}),module['exports']=router;