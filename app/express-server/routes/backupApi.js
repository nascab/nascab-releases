const _0x43800b=_0x217f;function _0x217f(_0x2b6665,_0x3bf5b6){const _0x1f3c1c=_0x1f3c();return _0x217f=function(_0x217f05,_0x4b1d54){_0x217f05=_0x217f05-0x1e7;let _0x4f3050=_0x1f3c1c[_0x217f05];return _0x4f3050;},_0x217f(_0x2b6665,_0x3bf5b6);}(function(_0x3b6b9b,_0xbfa767){const _0x1c5356=_0x217f,_0x3b4032=_0x3b6b9b();while(!![]){try{const _0x4780a4=parseInt(_0x1c5356(0x1f5))/0x1+-parseInt(_0x1c5356(0x201))/0x2+-parseInt(_0x1c5356(0x21b))/0x3*(parseInt(_0x1c5356(0x1f3))/0x4)+-parseInt(_0x1c5356(0x1f1))/0x5*(-parseInt(_0x1c5356(0x204))/0x6)+-parseInt(_0x1c5356(0x226))/0x7*(parseInt(_0x1c5356(0x209))/0x8)+-parseInt(_0x1c5356(0x1e7))/0x9+parseInt(_0x1c5356(0x1fb))/0xa;if(_0x4780a4===_0xbfa767)break;else _0x3b4032['push'](_0x3b4032['shift']());}catch(_0xeca758){_0x3b4032['push'](_0x3b4032['shift']());}}}(_0x1f3c,0x7ae81));var express=require('express'),router=express[_0x43800b(0x1ee)]();let path=require(_0x43800b(0x213)),fs=require('fs');const dbBackupTask=require('../../db/dbBackupTask');let moment=require(_0x43800b(0x1ec));function _0x1f3c(){const _0x1f4798=['/getTaskById','352133jqbkGE','post','/getRunningTaskList','dialog','taskAlreadQueued','sourceList','3706310CqDqWP','\x20task_record_id=?\x20order\x20by\x20id\x20desc\x20limit\x20100','\x20task_id=?\x20and\x20(status=\x27stop\x27\x20or\x20status=\x27waiting\x27\x20or\x20status=\x27running\x27)','status','stringify','noRunningTasks','544950xgTQvZ','create','lastRecord','66vJVABx','taskType','json','/getAllTask','type','4504olOdVo','targetPath','getAllRecordMsgByWhere','excludeList','updateRecord','send','constants','\x20task_id=?\x20and\x20status=\x27done\x27\x20order\x20by\x20id\x20desc\x20limit\x20100','task\x20id\x20is\x20error','dbOther','path','noWritePermission','test','start','\x20task_id=?\x20order\x20by\x20id\x20desc\x20limit\x201','taskId','running','is_admin','444063IvbnGe','/createTask','taskName','isDirectory','noGetFolderStat','getById','access','returnErrMsg','body','/getTaskRecords','/getTaskRecordMsg','658BXaHHy','waiting','update','noReadPermission','recordId','getAllRecordByWhere','R_OK','/deleteTask','initBackupWorker','\x20status=\x27running\x27\x20or\x20status=\x27waiting\x27','W_OK','cannotUseRootPathAsBackupTarget','getAll','currentUser','5308227gsfsel','getAllByTaskType','exports','app','\x20status=\x27waiting\x27','moment','taskTime','Router','stop','stat','450865zHjqKx','getRecordByWhere','8LdMJoq'];_0x1f3c=function(){return _0x1f4798;};return _0x1f3c();}router[_0x43800b(0x1f6)](_0x43800b(0x21c),(_0x446830,_0x5bab34,_0x1b4130)=>{const _0x5e787e=_0x43800b;if(_0x446830[_0x5e787e(0x233)][_0x5e787e(0x21a)]!=0x1)return _0x5bab34[_0x5e787e(0x206)]({'code':0x66});let _0x42e378=_0x446830['body'][_0x5e787e(0x208)],_0x4ed684=_0x446830[_0x5e787e(0x223)][_0x5e787e(0x21d)],_0x2ba6d1=_0x446830[_0x5e787e(0x223)][_0x5e787e(0x1fa)],_0x15b875=_0x446830[_0x5e787e(0x223)][_0x5e787e(0x20c)],_0x14db3d=path['join'](_0x446830[_0x5e787e(0x223)][_0x5e787e(0x20a)]),_0x1e2d29=_0x446830[_0x5e787e(0x223)]['taskType'],_0x36ec75=_0x446830[_0x5e787e(0x223)]['taskDay'],_0x1bde4a=_0x446830[_0x5e787e(0x223)][_0x5e787e(0x1ed)];if(/^\w\:\\$/['test'](_0x14db3d))return _0x446830[_0x5e787e(0x1ea)][_0x5e787e(0x222)](_0x5bab34,_0x5bab34['__']('cannotUseRootPathAsBackupTarget'),_0x5e787e(0x1f8));let _0x50ce58=0x0;for(let _0x3d33db in _0x2ba6d1){_0x2ba6d1[_0x3d33db]=path['join'](_0x2ba6d1[_0x3d33db]);if(/^\w\:\\$/[_0x5e787e(0x215)](_0x2ba6d1[_0x3d33db]))return _0x446830[_0x5e787e(0x1ea)]['returnErrMsg'](_0x5bab34,_0x5bab34['__'](_0x5e787e(0x231)),_0x5e787e(0x1f8));fs[_0x5e787e(0x221)](_0x2ba6d1[_0x3d33db],fs[_0x5e787e(0x20f)][_0x5e787e(0x22c)],_0x288d9e=>{const _0x497a15=_0x5e787e;if(_0x288d9e)return _0x446830[_0x497a15(0x1ea)][_0x497a15(0x222)](_0x5bab34,_0x5bab34['__'](_0x497a15(0x229))+':'+_0x2ba6d1[_0x3d33db]);_0x50ce58+=0x1,_0x50ce58==_0x2ba6d1['length']&&_0x3c9a2e();});}function _0x3c9a2e(){const _0x120fc5=_0x5e787e;fs[_0x120fc5(0x221)](_0x14db3d,fs[_0x120fc5(0x20f)][_0x120fc5(0x230)]|fs[_0x120fc5(0x20f)][_0x120fc5(0x22c)],_0x4512dc=>{const _0x530f61=_0x120fc5;if(_0x4512dc)return console['log'](_0x4512dc),_0x446830['app'][_0x530f61(0x222)](_0x5bab34,_0x5bab34['__'](_0x530f61(0x214))+':'+_0x14db3d);fs[_0x530f61(0x1f0)](_0x14db3d,(_0x205e7b,_0x33d7b2)=>{const _0x3a555f=_0x530f61;if(_0x205e7b||!_0x33d7b2[_0x3a555f(0x21e)]())return _0x446830[_0x3a555f(0x1ea)][_0x3a555f(0x222)](_0x5bab34,_0x5bab34['__'](_0x3a555f(0x21f)));let _0x1d26e9={'task_name':_0x4ed684,'source_list':JSON['stringify'](_0x2ba6d1),'exclude_list':JSON[_0x3a555f(0x1ff)](_0x15b875),'target_path':_0x14db3d,'task_type':_0x1e2d29,'task_day':_0x36ec75,'task_time':_0x1bde4a};if(_0x42e378==_0x3a555f(0x202))dbBackupTask['create'](_0x446830[_0x3a555f(0x1ea)][_0x3a555f(0x212)],_0x1d26e9);else{if(_0x42e378==_0x3a555f(0x228)){let _0x375c27=_0x446830[_0x3a555f(0x223)]['id'];dbBackupTask[_0x3a555f(0x228)](_0x446830['app'][_0x3a555f(0x212)],_0x1d26e9,_0x375c27);}}return process['send']({'type':_0x3a555f(0x22e)}),_0x5bab34[_0x3a555f(0x206)]({'code':0x0});});});}}),router[_0x43800b(0x1f6)](_0x43800b(0x22d),(_0x8fff3,_0x45811f,_0x51fc0e)=>{const _0x35eef7=_0x43800b;if(_0x8fff3[_0x35eef7(0x233)]['is_admin']!=0x1)return _0x45811f[_0x35eef7(0x206)]({'code':0x66});let _0x2b997f=_0x8fff3[_0x35eef7(0x223)]['id'];dbBackupTask['delete'](_0x8fff3[_0x35eef7(0x1ea)][_0x35eef7(0x212)],_0x2b997f),process['send']({'type':'initBackupWorker'}),_0x45811f[_0x35eef7(0x206)]({'code':0x0});}),router['post']('/operationTask',(_0x18f5e7,_0x196882,_0x3ef0ab)=>{const _0x4ccc85=_0x43800b;if(_0x18f5e7[_0x4ccc85(0x233)][_0x4ccc85(0x21a)]!=0x1)return _0x196882[_0x4ccc85(0x206)]({'code':0x66});let _0xe5d1c8=_0x18f5e7['body']['type'],_0x3bdd9f=_0x18f5e7[_0x4ccc85(0x223)][_0x4ccc85(0x218)],_0x494e4a=dbBackupTask[_0x4ccc85(0x220)](_0x18f5e7[_0x4ccc85(0x1ea)][_0x4ccc85(0x212)],_0x3bdd9f);if(!_0x494e4a)return _0x196882[_0x4ccc85(0x206)]({'code':0x1,'message':_0x4ccc85(0x211)});if(_0xe5d1c8==_0x4ccc85(0x216)){let _0x444449=dbBackupTask['getRecordByWhere'](_0x18f5e7[_0x4ccc85(0x1ea)]['dbOther'],_0x4ccc85(0x1fd),[_0x3bdd9f]);if(_0x444449){if(_0x444449[_0x4ccc85(0x1fe)]==_0x4ccc85(0x227))return _0x196882[_0x4ccc85(0x206)]({'code':0x1,'message':_0x196882['__'](_0x4ccc85(0x1f9)),'task_record':_0x444449});else{if(_0x444449['status']==_0x4ccc85(0x219))return _0x196882['json']({'code':0x1,'message':_0x196882['__']('taskAlreadyRunning'),'task_record':_0x444449});else _0x444449[_0x4ccc85(0x1fe)]==_0x4ccc85(0x1ef)&&dbBackupTask['updateRecord'](_0x18f5e7['app']['dbOther'],_0x444449['id'],_0x4ccc85(0x1eb));}}else{let _0x31d3a6=moment()['format']('YYYY-MM-DD\x20HH:mm:ss');dbBackupTask['createRecord'](_0x18f5e7['app'][_0x4ccc85(0x212)],_0x3bdd9f,'waiting',_0x31d3a6);}}else{if(_0xe5d1c8==_0x4ccc85(0x1ef)){let _0x8dc9b5=dbBackupTask[_0x4ccc85(0x1f2)](_0x18f5e7['app'][_0x4ccc85(0x212)],'\x20task_id=?\x20and\x20status=\x27running\x27',[_0x3bdd9f]);if(!_0x8dc9b5)return _0x196882[_0x4ccc85(0x206)]({'code':0x1,'message':_0x196882['__'](_0x4ccc85(0x200)),'task_record':_0x8dc9b5});else dbBackupTask[_0x4ccc85(0x20d)](_0x18f5e7[_0x4ccc85(0x1ea)]['dbOther'],_0x8dc9b5['id'],'\x20status=\x27stop\x27');}}process[_0x4ccc85(0x20e)]({'type':_0x4ccc85(0x22e)}),_0x196882[_0x4ccc85(0x206)]({'code':0x0});}),router['post'](_0x43800b(0x207),(_0x5dddec,_0x3da8cf,_0x2ba195)=>{const _0x28d404=_0x43800b;if(_0x5dddec[_0x28d404(0x233)][_0x28d404(0x21a)]!=0x1)return _0x3da8cf['json']({'code':0x66});let _0x17c049=_0x5dddec[_0x28d404(0x223)][_0x28d404(0x205)],_0x254c16=[];_0x17c049=parseInt(_0x17c049);_0x17c049?_0x254c16=dbBackupTask[_0x28d404(0x1e8)](_0x5dddec[_0x28d404(0x1ea)][_0x28d404(0x212)],_0x17c049):_0x254c16=dbBackupTask[_0x28d404(0x232)](_0x5dddec[_0x28d404(0x1ea)][_0x28d404(0x212)]);for(let _0x627f3a in _0x254c16){let _0x44be56=dbBackupTask['getRecordByWhere'](_0x5dddec['app'][_0x28d404(0x212)],_0x28d404(0x217),[_0x254c16[_0x627f3a]['id']]);_0x254c16[_0x627f3a][_0x28d404(0x203)]=_0x44be56;}_0x3da8cf[_0x28d404(0x206)]({'code':0x0,'data':_0x254c16});}),router[_0x43800b(0x1f6)](_0x43800b(0x1f4),(_0x1a08f7,_0x5b99d3,_0x1cc70)=>{const _0x3684c0=_0x43800b;if(_0x1a08f7[_0x3684c0(0x233)][_0x3684c0(0x21a)]!=0x1)return _0x5b99d3[_0x3684c0(0x206)]({'code':0x66});let _0x4af431=_0x1a08f7[_0x3684c0(0x223)]['id'],_0x22a797=dbBackupTask[_0x3684c0(0x220)](_0x1a08f7[_0x3684c0(0x1ea)][_0x3684c0(0x212)],_0x4af431);_0x5b99d3[_0x3684c0(0x206)]({'code':0x0,'data':_0x22a797});}),router[_0x43800b(0x1f6)](_0x43800b(0x224),(_0x24785d,_0x55d43e,_0x430b2e)=>{const _0x45b5b0=_0x43800b;if(_0x24785d[_0x45b5b0(0x233)]['is_admin']!=0x1)return _0x55d43e['json']({'code':0x66});let _0x3e4467=_0x24785d['body']['id'],_0x23e160=dbBackupTask[_0x45b5b0(0x22b)](_0x24785d[_0x45b5b0(0x1ea)][_0x45b5b0(0x212)],_0x45b5b0(0x210),[_0x3e4467]);_0x55d43e[_0x45b5b0(0x206)]({'code':0x0,'data':_0x23e160});}),router['post'](_0x43800b(0x225),(_0xb89b8,_0x258213,_0x3f8774)=>{const _0xbd6267=_0x43800b;if(_0xb89b8[_0xbd6267(0x233)]['is_admin']!=0x1)return _0x258213[_0xbd6267(0x206)]({'code':0x66});let _0x3c4b9d=_0xb89b8[_0xbd6267(0x223)][_0xbd6267(0x22a)],_0x2e1a77=dbBackupTask[_0xbd6267(0x20b)](_0xb89b8[_0xbd6267(0x1ea)][_0xbd6267(0x212)],_0xbd6267(0x1fc),[_0x3c4b9d]);_0x258213[_0xbd6267(0x206)]({'code':0x0,'data':_0x2e1a77});}),router['post'](_0x43800b(0x1f7),(_0x230b52,_0x5a3bb1,_0x1406e9)=>{const _0x23c417=_0x43800b;if(_0x230b52[_0x23c417(0x233)][_0x23c417(0x21a)]!=0x1)return _0x5a3bb1[_0x23c417(0x206)]({'code':0x66});let _0x2edd73=_0x230b52[_0x23c417(0x223)][_0x23c417(0x22a)],_0x362e4d=dbBackupTask[_0x23c417(0x22b)](_0x230b52[_0x23c417(0x1ea)][_0x23c417(0x212)],_0x23c417(0x22f),[]);_0x5a3bb1[_0x23c417(0x206)]({'code':0x0,'data':_0x362e4d});}),module[_0x43800b(0x1e9)]=router;