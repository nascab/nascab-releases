const _0x401349=_0x111f;function _0x111f(_0x13de9c,_0x4d0992){const _0x1f455a=_0x1f45();return _0x111f=function(_0x111f7e,_0x2b23de){_0x111f7e=_0x111f7e-0xbf;let _0x585a13=_0x1f455a[_0x111f7e];return _0x585a13;},_0x111f(_0x13de9c,_0x4d0992);}(function(_0x17d011,_0x4cf334){const _0x2eaed3=_0x111f,_0x160c79=_0x17d011();while(!![]){try{const _0x1ee736=parseInt(_0x2eaed3(0x126))/0x1+parseInt(_0x2eaed3(0xe5))/0x2+parseInt(_0x2eaed3(0xfd))/0x3+parseInt(_0x2eaed3(0xd8))/0x4*(parseInt(_0x2eaed3(0xdd))/0x5)+parseInt(_0x2eaed3(0xc9))/0x6+-parseInt(_0x2eaed3(0xca))/0x7*(-parseInt(_0x2eaed3(0x115))/0x8)+-parseInt(_0x2eaed3(0xed))/0x9;if(_0x1ee736===_0x4cf334)break;else _0x160c79['push'](_0x160c79['shift']());}catch(_0x1363e3){_0x160c79['push'](_0x160c79['shift']());}}}(_0x1f45,0x36dcb));var express=require('express'),router=express['Router']();let path=require(_0x401349(0xf6));const dbSourceFolderTable=require(_0x401349(0x10f)),dbFileIndexTable=require(_0x401349(0xc3)),dbUserTable=require(_0x401349(0x113));var fs=require('fs');const videoStreamUtil=require(_0x401349(0xc7)),dbConfigTable=require(_0x401349(0xdb)),dbScanTaskTable=require(_0x401349(0x123));router['post'](_0x401349(0xfc),(_0x2a591c,_0x3bc679,_0x1b9fb3)=>{const _0x3c4832=_0x401349;let _0x3377a1=_0x2a591c[_0x3c4832(0xe8)][_0x3c4832(0x11b)];if(dbUserTable[_0x3c4832(0x125)](_0x2a591c,null)===!![]){let _0x1fc41c=dbSourceFolderTable[_0x3c4832(0xdf)](_0x2a591c['app'][_0x3c4832(0xde)],_0x3377a1),_0x576bfc=0x0;if(_0x1fc41c[_0x3c4832(0x11f)]<0x1)return _0x3bc679[_0x3c4832(0x110)]({'code':0x0,'data':_0x1fc41c});let _0x7847c5='',_0x3be50c=setTimeout(()=>{const _0x10b566=_0x3c4832;!_0x3bc679[_0x10b566(0xcd)]&&(console['log'](_0x10b566(0x10d),_0x7847c5),_0x3bc679[_0x10b566(0x110)]({'code':0x0,'data':_0x1fc41c}));},0x1f40),_0x29a1cf=dbConfigTable[_0x3c4832(0xf9)](_0x2a591c[_0x3c4832(0xd9)]['dbOther'],'cacheParentPath');try{_0x29a1cf&&(_0x29a1cf=path[_0x3c4832(0xe1)](_0x29a1cf[_0x3c4832(0xfa)]));}catch(_0x3020b0){console[_0x3c4832(0x102)](_0x3020b0);}for(let _0x24a8e5=0x0;_0x24a8e5<_0x1fc41c[_0x3c4832(0x11f)];_0x24a8e5++){let _0x5a1735=_0x1fc41c[_0x24a8e5][_0x3c4832(0xf6)];_0x7847c5=_0x5a1735,_0x1fc41c[_0x24a8e5]['exist']=0x0,fs[_0x3c4832(0x11e)](_0x5a1735,(_0xd2607c,_0xac8e3c)=>{const _0x2d94bc=_0x3c4832;_0x576bfc+=0x1,_0xd2607c?_0x1fc41c[_0x24a8e5][_0x2d94bc(0xbf)]=0x0:_0x1fc41c[_0x24a8e5][_0x2d94bc(0xbf)]=0x1,_0x576bfc>=_0x1fc41c[_0x2d94bc(0x11f)]&&(clearTimeout(_0x3be50c),!_0x3bc679[_0x2d94bc(0xcd)]&&_0x3bc679[_0x2d94bc(0x110)]({'code':0x0,'data':_0x1fc41c,'cacheParentPath':_0x29a1cf?_0x29a1cf:''}));});}}else{let _0x235f12=dbUserTable[_0x3c4832(0x10b)](_0x2a591c[_0x3c4832(0xd9)][_0x3c4832(0xde)],_0x2a591c[_0x3c4832(0xe4)]['id']),_0x4d47a5=dbUserTable['getUserPower'](_0x2a591c['app']['dbOther'],_0x235f12[_0x3c4832(0x111)],_0x3377a1,'power_get');_0x3bc679[_0x3c4832(0x110)]({'code':0x0,'data':_0x4d47a5});}}),router['post'](_0x401349(0xec),(_0x34fc5a,_0x290d62,_0x1c0df7)=>{const _0x50b2ca=_0x401349;let _0x32c27f=dbSourceFolderTable['getAll'](_0x34fc5a[_0x50b2ca(0xd9)][_0x50b2ca(0xde)]);_0x290d62[_0x50b2ca(0x110)]({'code':0x0,'hasAdmin':_0x32c27f?'1':'0'});}),router[_0x401349(0x103)](_0x401349(0x108),(_0x251a62,_0x50cb42,_0x53b975)=>{const _0x27c883=_0x401349;let _0x659593=_0x251a62[_0x27c883(0xe8)][_0x27c883(0xd1)]==0x1?0x1:0x0,_0x4125fe=_0x251a62['body'][_0x27c883(0x101)]==0x1?0x1:0x0,_0xdd0a8f=_0x251a62['body']['scan_interval']==0x1?0x1:0x0,_0x4d8c05=_0x251a62[_0x27c883(0xe8)]['scan_interval_ms']||0x0,_0x433bbc=_0x251a62[_0x27c883(0xe8)][_0x27c883(0x107)],_0x3ebdd2=dbSourceFolderTable[_0x27c883(0xd6)](_0x251a62[_0x27c883(0xd9)][_0x27c883(0xde)],_0x433bbc);if(!_0x3ebdd2)return _0x251a62[_0x27c883(0xd9)][_0x27c883(0xf8)](_0x50cb42,_0x27c883(0x124));if(dbUserTable[_0x27c883(0x125)](_0x251a62,null)===!![]){let _0x1c18d6=dbSourceFolderTable[_0x27c883(0xd6)](_0x251a62[_0x27c883(0xd9)][_0x27c883(0xde)],_0x433bbc);dbSourceFolderTable[_0x27c883(0xc0)](_0x251a62[_0x27c883(0xd9)][_0x27c883(0xde)],_0x27c883(0xd1),_0x659593,_0x433bbc),dbSourceFolderTable['updateByWhere'](_0x251a62['app'][_0x27c883(0xde)],_0x27c883(0x101),_0x4125fe,_0x433bbc),dbSourceFolderTable[_0x27c883(0xc0)](_0x251a62[_0x27c883(0xd9)][_0x27c883(0xde)],_0x27c883(0xf1),_0xdd0a8f,_0x433bbc),dbSourceFolderTable[_0x27c883(0xc0)](_0x251a62[_0x27c883(0xd9)]['dbOther'],_0x27c883(0xcf),_0x4d8c05,_0x433bbc),_0x3ebdd2=dbSourceFolderTable[_0x27c883(0xd6)](_0x251a62[_0x27c883(0xd9)]['dbOther'],_0x433bbc),_0x1c18d6[_0x27c883(0x101)]!=_0x4125fe&&process['send']({'type':_0x27c883(0xd2),'restartWatcher':!![]}),_0x50cb42[_0x27c883(0x110)]({'code':0x0,'data':_0x3ebdd2});}}),router['post'](_0x401349(0xff),(_0x3157a0,_0x3dcbfa,_0xa8c736)=>{const _0x29bada=_0x401349;let _0x172e0f=_0x3157a0['body']['scanPath'],_0x2b8ab6=_0x3157a0['body'][_0x29bada(0xc6)];if(dbUserTable[_0x29bada(0xe0)](_0x3157a0,_0x3dcbfa,'','power_change',_0x172e0f)==!![]){if(_0x172e0f==_0x29bada(0xf0)){let _0x5e0f17=dbSourceFolderTable[_0x29bada(0xdf)](_0x3157a0[_0x29bada(0xd9)][_0x29bada(0xde)],_0x2b8ab6);for(let _0x2c51d7 of _0x5e0f17){dbScanTaskTable[_0x29bada(0x11a)](_0x3157a0[_0x29bada(0xd9)][_0x29bada(0xde)],_0x2c51d7[_0x29bada(0x11b)],_0x2c51d7['path']);}}else dbScanTaskTable[_0x29bada(0x11a)](_0x3157a0[_0x29bada(0xd9)][_0x29bada(0xde)],_0x2b8ab6,_0x172e0f);return process['send']({'type':_0x29bada(0xd2),'source_type':_0x2b8ab6,'restartWatcher':![]}),_0x3dcbfa[_0x29bada(0x110)]({'code':0x0});}}),router[_0x401349(0x103)](_0x401349(0xd4),(_0xee4a11,_0x457641,_0x36e076)=>{const _0x19aefa=_0x401349;if(dbUserTable[_0x19aefa(0x125)](_0xee4a11,_0x457641)===!![]){let _0x387466=_0xee4a11[_0x19aefa(0xe8)][_0x19aefa(0x10e)],_0x3a1a81=path['join'](_0xee4a11[_0x19aefa(0xe8)]['path'][_0x19aefa(0xfe)]()),_0x1a2df1=_0xee4a11['body']['type'][_0x19aefa(0xfe)](),_0x4cab29=dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'];if(_0x1a2df1==_0x19aefa(0x109))_0x4cab29=dbFileIndexTable[_0x19aefa(0x106)];else{if(_0x1a2df1==_0x19aefa(0xd5))_0x4cab29=dbFileIndexTable[_0x19aefa(0xf3)];else _0x1a2df1==_0x19aefa(0xef)&&(_0x4cab29=dbFileIndexTable[_0x19aefa(0x121)]);}if(_0x3a1a81[_0x19aefa(0xce)]('\x27')>0x0||_0x3a1a81[_0x19aefa(0xce)]('\x22')>0x0)return _0xee4a11[_0x19aefa(0xd9)][_0x19aefa(0xf8)](_0x457641,_0x457641['__'](_0x19aefa(0xdc))+'(\x20\x27\x20”\x20)',_0x19aefa(0xcb));if(/^\w\:\\$/['test'](_0x3a1a81))return _0xee4a11[_0x19aefa(0xd9)][_0x19aefa(0xf8)](_0x457641,_0x457641['__'](_0x19aefa(0x116)),_0x19aefa(0xcb));let _0x15e6ec=dbSourceFolderTable[_0x19aefa(0x120)](_0xee4a11['app'][_0x19aefa(0xde)],_0x1a2df1,'\x20id!='+_0x387466);for(let _0x4e90ea=0x0;_0x4e90ea<_0x15e6ec[_0x19aefa(0x11f)];_0x4e90ea++){let _0x65dd61=path[_0x19aefa(0xe1)](_0x15e6ec[_0x4e90ea][_0x19aefa(0xf6)][_0x19aefa(0xfe)]());if(_0x3a1a81==_0x65dd61)return _0xee4a11[_0x19aefa(0xd9)][_0x19aefa(0xf8)](_0x457641,_0x457641['__']('PathAlreadyExists'),_0x19aefa(0xcb));else{if(_0x3a1a81[_0x19aefa(0xce)](path[_0x19aefa(0xe1)](_0x15e6ec[_0x4e90ea][_0x19aefa(0xf6)],path['sep']))!=-0x1)return _0xee4a11[_0x19aefa(0xd9)]['returnErrMsg'](_0x457641,_0x457641['__']('AlreadyHasParentPath'),_0x19aefa(0xcb));else{if(_0x15e6ec[_0x4e90ea][_0x19aefa(0xf6)][_0x19aefa(0xce)](path['join'](_0x3a1a81,path[_0x19aefa(0x112)]))!=-0x1)return _0xee4a11['app'][_0x19aefa(0xf8)](_0x457641,_0x457641['__'](_0x19aefa(0xf4)),_0x19aefa(0xcb));}}}let _0x463333=dbSourceFolderTable['getById'](_0xee4a11[_0x19aefa(0xd9)][_0x19aefa(0xde)],_0x387466);if(!_0x463333)return _0xee4a11[_0x19aefa(0xd9)][_0x19aefa(0xf8)](_0x457641,_0x19aefa(0xc1),_0x19aefa(0xcb));fs[_0x19aefa(0x11e)](_0x3a1a81,(_0x33dd03,_0x3fa601)=>{const _0x497de5=_0x19aefa;if(_0x33dd03||!_0x3fa601[_0x497de5(0xd0)]())return _0xee4a11[_0x497de5(0xd9)]['returnErrMsg'](_0x457641,_0x457641['__'](_0x497de5(0xfb)),_0x497de5(0x10c));const _0x4311a0=_0xee4a11[_0x497de5(0xd9)][_0x497de5(0xe6)]['transaction'](()=>{const _0x499837=_0x497de5;let _0x2afa13='UPDATE\x20'+_0x4cab29+'\x20SET\x20path\x20=\x20replace(\x20path,\x20\x27'+_0x463333[_0x499837(0xf6)]+_0x499837(0x117)+_0x3a1a81+_0x499837(0x128)+_0x463333['path']+_0x499837(0xe7),_0x5c9b9f='UPDATE\x20'+_0x4cab29+'\x20SET\x20path\x20=\x20\x27'+_0x3a1a81+_0x499837(0xc2)+_0x463333[_0x499837(0xf6)]+'\x27',_0x1ef809='UPDATE\x20'+_0x4cab29+'\x20SET\x20path\x20=\x20replace(\x20path,\x20\x27'+_0x463333['path']+_0x499837(0x117)+_0x3a1a81+_0x499837(0x128)+_0x463333[_0x499837(0xf6)]+_0x499837(0xe9);_0xee4a11[_0x499837(0xd9)][_0x499837(0xe6)][_0x499837(0xf5)](_0x2afa13)[_0x499837(0x11d)](),_0xee4a11[_0x499837(0xd9)][_0x499837(0xe6)][_0x499837(0xf5)](_0x5c9b9f)[_0x499837(0x11d)](),_0xee4a11[_0x499837(0xd9)][_0x499837(0xe6)][_0x499837(0xf5)](_0x1ef809)[_0x499837(0x11d)]();});return _0x4311a0(),dbSourceFolderTable[_0x497de5(0xc0)](_0xee4a11[_0x497de5(0xd9)][_0x497de5(0xde)],'path',_0x3a1a81,_0x387466),dbScanTaskTable[_0x497de5(0x11a)](_0xee4a11['app'][_0x497de5(0xde)],_0x1a2df1,_0x3a1a81),process[_0x497de5(0x118)]({'type':_0x497de5(0xd2),'path':_0x3a1a81,'operate':'add','source_type':_0x1a2df1,'restartWatcher':!![]}),_0x457641[_0x497de5(0x110)]({'code':0x0});});}});let allowSourceTypeList=[_0x401349(0x129),_0x401349(0x109),_0x401349(0xd5),'book'];function _0x1f45(){const _0x1dcd7c=['DirectoryNoExist','/getPathByType','1024077qHvnhh','trim','/scanPath','clearTable','scan_when_change','log','post','media_type','operationFail','INDEX_TABLE_NAME_MOVIE','sourceId','/updateSource','movie','/addPath','find','message','读取超时','rawPathId','../../db/dbSourceFolderTable','json','username','sep','../../db/dbUserTable','create','8dddeeC','cannotUseRootPathAsSource','\x27,\x20\x27','send','getIndexTableNameByType','addScanTask','type','add','run','stat','length','getPathByTypeAndWhere','INDEX_TABLE_NAME_BOOK','stopIndexWorker','../../db/dbScanTaskTable','source\x20id\x20error','isAdmin','417155lIQMDa','deleteSourceAndChilden','\x27\x20)\x20WHERE\x20path\x20LIKE\x20\x27','photo','exist','updateByWhere','PATH\x20DO\x20NOT\x20EXIST','\x27\x20WHERE\x20path\x20=\x20\x27','../../db/dbFileIndexTable','test','getCount','sourceType','../../utils/videoStreamUtil','PathAlreadyExists','72384dpGtCi','1987202YjmZtD','dialog','includes','headersSent','indexOf','scan_interval_ms','isDirectory','scan_when_start','startScanPath','saveLastMatchTime','/relocatePath','music','getById','clearAiToIndex','71716zymvPA','app','exports','../../db/dbConfigTable','pathCannotHasSign','85hkTTWf','dbOther','getPathByType','doUserCanGet','join','deletePathAll','delete','currentUser','855786oTIfzZ','dbFileIndex','/%\x27','body','\x5c%\x27','Need\x20type','sourcePathNotExist','/getAll','14061915dxcYTi','(\x20\x27\x20”\x20)','book','ALL','scan_interval','/deletePath','INDEX_TABLE_NAME_MUSIC','AlreadyHasParentPath','prepare','path','deletePowerPath','returnErrMsg','findByTitle','value'];_0x1f45=function(){return _0x1dcd7c;};return _0x1f45();}router['post'](_0x401349(0x10a),(_0x320697,_0x3a1766,_0x46eb2b)=>{const _0x241d4b=_0x401349;if(dbUserTable[_0x241d4b(0x125)](_0x320697,_0x3a1766)===!![]){let _0xcbd402=path[_0x241d4b(0xe1)](_0x320697[_0x241d4b(0xe8)][_0x241d4b(0xf6)]['trim']()),_0x1d77d7=_0x320697[_0x241d4b(0xe8)][_0x241d4b(0x11b)][_0x241d4b(0xfe)](),_0x5bb03f=_0x320697[_0x241d4b(0xe8)][_0x241d4b(0x104)];if(!allowSourceTypeList[_0x241d4b(0xcc)](_0x1d77d7))return _0x320697[_0x241d4b(0xd9)]['returnErrMsg'](_0x3a1766,_0x241d4b(0xea),'dialog');if(_0xcbd402[_0x241d4b(0xce)]('\x27')>0x0||_0xcbd402[_0x241d4b(0xce)]('\x22')>0x0)return _0x320697[_0x241d4b(0xd9)][_0x241d4b(0xf8)](_0x3a1766,_0x3a1766['__']('pathCannotHasSign')+_0x241d4b(0xee),_0x241d4b(0xcb));if(/^\w\:\\$/[_0x241d4b(0xc4)](_0xcbd402)||_0xcbd402==path[_0x241d4b(0x112)])return _0x320697['app'][_0x241d4b(0xf8)](_0x3a1766,_0x3a1766['__']('cannotUseRootPathAsSource'),_0x241d4b(0xcb));let _0x43dcda=dbSourceFolderTable[_0x241d4b(0xdf)](_0x320697[_0x241d4b(0xd9)]['dbOther'],_0x1d77d7);for(let _0xe5b9e7=0x0;_0xe5b9e7<_0x43dcda[_0x241d4b(0x11f)];_0xe5b9e7++){let _0x57cbf3=path['join'](_0x43dcda[_0xe5b9e7][_0x241d4b(0xf6)][_0x241d4b(0xfe)]());if(_0xcbd402==_0x57cbf3)return _0x320697[_0x241d4b(0xd9)][_0x241d4b(0xf8)](_0x3a1766,_0x3a1766['__'](_0x241d4b(0xc8)),_0x241d4b(0xcb));else{if(_0xcbd402['indexOf'](path['join'](_0x43dcda[_0xe5b9e7][_0x241d4b(0xf6)],path['sep']))!=-0x1)return _0x320697['app']['returnErrMsg'](_0x3a1766,_0x3a1766['__']('AlreadyHasParentPath'),'dialog');else{if(_0x43dcda[_0xe5b9e7][_0x241d4b(0xf6)]['indexOf'](path[_0x241d4b(0xe1)](_0xcbd402,path[_0x241d4b(0x112)]))!=-0x1)return _0x320697[_0x241d4b(0xd9)][_0x241d4b(0xf8)](_0x3a1766,_0x3a1766['__']('AlreadyHasParentPath'),'dialog');}}}fs[_0x241d4b(0x11e)](_0xcbd402,(_0x4731c2,_0x301c2f)=>{const _0x38f375=_0x241d4b;if(_0x4731c2||!_0x301c2f['isDirectory']())return _0x320697['app'][_0x38f375(0xf8)](_0x3a1766,_0x3a1766['__'](_0x38f375(0xfb)),_0x38f375(0x10c));dbSourceFolderTable[_0x38f375(0x114)](_0x320697[_0x38f375(0xd9)][_0x38f375(0xde)],{'media_type':_0x5bb03f,'path':_0xcbd402,'type':_0x1d77d7,'ctime':0x0,'ignore_match_info':0x1}),dbScanTaskTable['addScanTask'](_0x320697[_0x38f375(0xd9)]['dbOther'],_0x1d77d7,_0xcbd402),process[_0x38f375(0x118)]({'type':_0x38f375(0xd2),'path':_0xcbd402,'operate':_0x38f375(0x11c),'source_type':_0x1d77d7,'restartWatcher':!![]}),_0x3a1766['json']({'code':0x0}),videoStreamUtil[_0x38f375(0xd3)](_0x320697['app']['dbOther']);});}}),router['post'](_0x401349(0xf2),(_0x20aad0,_0x38aea8,_0x569124)=>{const _0x314ff7=_0x401349;if(dbUserTable[_0x314ff7(0x125)](_0x20aad0,_0x38aea8)===!![]){let _0x530f7a=_0x20aad0[_0x314ff7(0xe8)]['id'],_0x21f057=dbSourceFolderTable[_0x314ff7(0xd6)](_0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xde)],_0x530f7a);if(!_0x21f057)return _0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xf8)](_0x38aea8,_0x38aea8['__'](_0x314ff7(0xeb)),_0x314ff7(0xcb));_0x38aea8[_0x314ff7(0x110)]({'code':0x0});let _0x3e6a11=dbFileIndexTable[_0x314ff7(0x119)](_0x21f057['type']);try{process[_0x314ff7(0x118)]({'type':_0x314ff7(0x122),'path':_0x21f057['path'],'source_type':_0x21f057['type']});let _0x1b8a11=dbSourceFolderTable[_0x314ff7(0xc5)](_0x20aad0['app'][_0x314ff7(0xde)],_0x21f057['type']);_0x1b8a11<=0x1?(_0x21f057[_0x314ff7(0x11b)]=='photo'&&(dbFileIndexTable[_0x314ff7(0x100)](_0x20aad0['app'][_0x314ff7(0xe6)],'photo_faces'),dbFileIndexTable[_0x314ff7(0xd7)](_0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xe6)])),dbFileIndexTable[_0x314ff7(0x100)](_0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xe6)],_0x3e6a11)):(dbFileIndexTable[_0x314ff7(0xe2)](_0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xe6)],_0x21f057[_0x314ff7(0xf6)],_0x3e6a11),videoStreamUtil['saveLastMatchTime'](_0x20aad0['app']['dbOther'])),dbSourceFolderTable[_0x314ff7(0x127)](_0x20aad0[_0x314ff7(0xd9)]['dbOther'],_0x21f057['path'],_0x21f057['type']),dbUserTable[_0x314ff7(0xf7)](_0x20aad0[_0x314ff7(0xd9)][_0x314ff7(0xde)],_0x21f057[_0x314ff7(0xf6)],_0x21f057[_0x314ff7(0x11b)]),setTimeout(()=>{const _0x13f38e=_0x314ff7;process[_0x13f38e(0x118)]({'type':'startScanPath','path':_0x21f057[_0x13f38e(0xf6)],'operate':'delete','source_type':_0x21f057[_0x13f38e(0x11b)],'restartWatcher':!![]});},0xbb8);}catch(_0xeee599){return console[_0x314ff7(0x102)](_0xeee599),setTimeout(()=>{const _0x356686=_0x314ff7;process[_0x356686(0x118)]({'type':_0x356686(0xd2),'path':_0x21f057['path'],'operate':_0x356686(0xe3),'source_type':_0x21f057['type'],'restartWatcher':!![]});},0xbb8),_0x20aad0['app'][_0x314ff7(0xf8)](_0x38aea8,_0x38aea8['__'](_0x314ff7(0x105)),_0x314ff7(0xcb));}}}),module[_0x401349(0xda)]=router;